<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="description" content="SGP - Sistema de Gestão Pedagógica">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SGP">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SGP - Gestão Final (v16 — Frequência Avançada + Calendário + Padrões + PDF)</title>

    <!-- PWA: Inline Manifest (ativado automaticamente quando servido via HTTP/HTTPS) -->
    <script>
    (function(){
      if(location.protocol === 'file:') return; // Skip PWA on local files
      const manifest = {
        name: "SGP - Sistema de Gestão Pedagógica",
        short_name: "SGP",
        description: "Gestão completa de turmas, notas, frequência e planejamento",
        start_url: "./",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#0ea5e9",
        orientation: "any",
        icons: [
          { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='18' fill='%230ea5e9'/><text x='50' y='68' font-size='52' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>SGP</text></svg>", sizes: "any", type: "image/svg+xml", purpose: "any" },
          { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='18' fill='%230ea5e9'/><text x='50' y='68' font-size='52' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>SGP</text></svg>", sizes: "any", type: "image/svg+xml", purpose: "maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = URL.createObjectURL(blob);
      document.head.appendChild(link);

      // Apple touch icon (SVG data URI)
      const appleIcon = document.createElement('link');
      appleIcon.rel = 'apple-touch-icon';
      appleIcon.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='18' fill='%230ea5e9'/><text x='50' y='68' font-size='52' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>SGP</text></svg>";
      document.head.appendChild(appleIcon);

      // Register Service Worker (requires sw.js file alongside index.html)
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./sw.js', {scope: './'}).then(reg => {
          console.log('[SGP] Service Worker registrado! Escopo:', reg.scope);
        }).catch(err => {
          console.log('[SGP] Service Worker indisponível (normal em file://):', err.message);
        });
      }
    })();
    </script>
    <link id="sgp-fa-css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="window.__SGP_LIB_ERR&&window.__SGP_LIB_ERR('font-awesome')">

    <script>
      // Registro simples de falhas de carregamento de bibliotecas externas (CDN) para modo offline
      window.__SGP_LIB_ERRORS = window.__SGP_LIB_ERRORS || [];
      window.__SGP_LIB_ERR = function(name){
        try{ window.__SGP_LIB_ERRORS.push({name:String(name||'unknown'), ts:Date.now()}); }catch(e){}
      };
    </script>
    <style id="sgp-emoji-icons">
/* SGP: ícones inline SVG (offline) — elegantes, neutros e consistentes */
i.fa, i.fas, i.far, i.fab, i.fa-solid, i.fa-regular, i.fa-brands{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:1.35em;
  height:1.35em;
  line-height:1;
  font-style:normal;
  vertical-align:-0.125em;
  user-select:none;
}
i.fa svg, i.fas svg, i.far svg, i.fab svg, i.fa-solid svg, i.fa-regular svg, i.fa-brands svg{
  width:1.15em;
  height:1.15em;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  pointer-events:none;
}
i.fa .sgp-ico-fill, i.fas .sgp-ico-fill, i.far .sgp-ico-fill, i.fab .sgp-ico-fill, i.fa-solid .sgp-ico-fill, i.fa-regular .sgp-ico-fill, i.fa-brands .sgp-ico-fill{
  fill: currentColor;
  stroke: none;
}

/* Plano Semanal — Tela cheia (fullscreen) */
#modalPlanoSemanal .modal-box.is-fullscreen{
  width:100vw !important;
  height:100vh !important;
  max-width:100vw !important;
  max-height:100vh !important;
  border-radius:0 !important;
  margin:0 !important;
}
#modalPlanoSemanal .modal-box.is-fullscreen #planoSemanalScroll{
  padding-right: 10px;
}

.plano-pr-tab{
  padding:6px 12px; border:1px solid var(--border-color); border-radius:8px;
  background:transparent; color:var(--text-muted); font-size:.75rem; font-weight:600;
  cursor:pointer; transition:all .15s; white-space:nowrap;
}
.plano-pr-tab:hover{ background:rgba(124,58,237,.08); color:#7c3aed; border-color:#7c3aed; }
.plano-pr-tab-active{ background:#7c3aed !important; color:#fff !important; border-color:#7c3aed !important; }
.plano-pr-tab-done{ border-color:#059669; color:#059669; }
.plano-pr-tab-done::after{ content:" ✓"; font-size:.65rem; }
body.dark-mode .plano-pr-tab{ border-color:#475569; color:#94a3b8; }
body.dark-mode .plano-pr-tab:hover{ background:rgba(124,58,237,.15); color:#a78bfa; border-color:#a78bfa; }
body.dark-mode .plano-pr-tab-active{ background:#7c3aed !important; color:#fff !important; }
body.dark-mode .plano-pr-tab-done{ border-color:#34d399; color:#34d399; }


</style>

<script id="sgp-emoji-pack">
/* SGP: pack de ícones inline (sem FontAwesome / sem emojis) */
(function(){
  var SVG_NS = "http://www.w3.org/2000/svg";
  var __sgpIconMO = null;

  var CLASS_TO_ICON = {
    "fa-plus":"plus",
    "fa-search":"search",
    "fa-print":"print",
    "fa-download":"download",
    "fa-upload":"upload",
    "fa-file-arrow-down":"download",
    "fa-file-arrow-up":"upload",
    "fa-file-excel":"file",
    "fa-file-pdf":"file",
    "fa-file":"file",
    "fa-file-signature":"file",
    "fa-floppy-disk":"save",
    "fa-save":"save",
    "fa-cog":"settings",
    "fa-users-cog":"settings",
    "fa-users":"users",
    "fa-user-plus":"userPlus",
    "fa-id-card":"idCard",
    "fa-graduation-cap":"grad",
    "fa-chalkboard":"board",
    "fa-chalkboard-teacher":"board",
    "fa-book":"book",
    "fa-book-open":"book",
    "fa-clipboard-list":"clipboard",
    "fa-clipboard-check":"checklist",
    "fa-cloud-arrow-up":"upload",
    "fa-list":"list",
    "fa-list-check":"checklist",
    "fa-list-ol":"list",
    "fa-pen-nib":"pen",
    "fa-sort":"sort",
    "fa-paste":"clipboard",
    "fa-wand-magic-sparkles":"wand",
    "fa-arrows-rotate":"rotate",
    "fa-square-minus":"minus",
    "fa-dice":"shuffle",
    "fa-copy":"clipboard",
    "fa-bars":"list",
    "fa-calendar":"calendar",
    "fa-calendar-alt":"calendar",
    "fa-calendar-day":"calendar",
    "fa-calendar-week":"calendar",
    "fa-calendar-check":"calendar",
    "fa-clock":"clock",
    "fa-stopwatch":"stopwatch",
    "fa-play":"play",
    "fa-pause":"pause",
    "fa-stop":"stop",
    "fa-forward":"forward",
    "fa-backward":"backward",
    "fa-undo":"undo",
    "fa-redo":"redo",
    "fa-rotate":"rotate",
    "fa-repeat":"rotate",
    "fa-rotate-left":"undo",
    "fa-shuffle":"shuffle",
    "fa-dice":"dice",
    "fa-gamepad":"gamepad",
    "fa-desktop":"expand",
    "fa-map":"map",
    "fa-tv":"tv",
    "fa-expand":"expand",
    "fa-compress":"compress",
    "fa-eye":"eye",
    "fa-eye-slash":"eyeOff",
    "fa-lock":"lock",
    "fa-unlock":"unlock",
    "fa-bolt":"bolt",
    "fa-wand-magic-sparkles":"wand",
    "fa-lightbulb":"bulb",
    "fa-bullseye":"target",
    "fa-chart-line":"chartLine",
    "fa-chart-pie":"chartPie",
    "fa-table":"table",
    "fa-border-all":"grid",
    "fa-th-large":"grid",
    "fa-layer-group":"layers",
    "fa-folder-open":"folder",
    "fa-box-archive":"archive",
    "fa-inbox":"inbox",
    "fa-database":"database",
    "fa-copy":"copy",
    "fa-clone":"copy",
    "fa-edit":"pencil",
    "fa-pen":"pencil",
    "fa-pen-to-square":"pencil",
    "fa-eraser":"eraser",
    "fa-trash":"trash",
    "fa-times":"x",
    "fa-xmark":"x",
    "fa-check":"check",
    "fa-check-circle":"checkCircle",
    "fa-check-double":"check",
    "fa-exclamation-circle":"alertCircle",
    "fa-exclamation-triangle":"warning",
    "fa-triangle-exclamation":"warning",
    "fa-circle-info":"info",
    "fa-flag":"flag",
    "fa-tag":"tag",
    "fa-arrow-right":"arrowRight",
    "fa-chevron-left":"chevronLeft",
    "fa-chevron-right":"chevronRight",
    "fa-sun":"sun",
    "fa-moon":"moon",
    "fa-shield-heart":"shieldHeart",
    "fa-stethoscope":"medical",
    "fa-skull":"skull",
    "fa-universal-access":"access",
    "fa-shapes":"shapes",
    "fa-calculator":"calculator",
    "fa-broom":"broom",
    "fa-bug":"bug",
    "fa-whatsapp":"message",
    "fa-1":"num1",
    "fa-2":"num2",
    "fa-3":"num3",
    "fa-4":"num4",
    "fa-circle":"circle"
  };

  // Definições simples (traço) — neutras e leves (inspiradas em line icons)
  var ICONS = {
    circle: { vb:"0 0 24 24", els:[ ["circle",{cx:"12",cy:"12",r:"9"}] ] },

    plus: { vb:"0 0 24 24", els:[ ["line",{x1:"12",y1:"5",x2:"12",y2:"19"}], ["line",{x1:"5",y1:"12",x2:"19",y2:"12"}] ] },
    search: { vb:"0 0 24 24", els:[ ["circle",{cx:"11",cy:"11",r:"7"}], ["line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"}] ] },

    print: { vb:"0 0 24 24", els:[
      ["path",{d:"M7 8V4h10v4"}],
      ["rect",{x:"6",y:"12",width:"12",height:"8",rx:"2"}],
      ["path",{d:"M6 12h-1a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-1"}],
      ["line",{x1:"9",y1:"16",x2:"15",y2:"16"}]
    ]},

    download: { vb:"0 0 24 24", els:[
      ["path",{d:"M12 3v10"}],
      ["polyline",{points:"8 10 12 14 16 10"}],
      ["path",{d:"M4 17v3h16v-3"}]
    ]},
    upload: { vb:"0 0 24 24", els:[
      ["path",{d:"M12 21V11"}],
      ["polyline",{points:"8 14 12 10 16 14"}],
      ["path",{d:"M4 7V4h16v3"}]
    ]},

    file: { vb:"0 0 24 24", els:[
      ["path",{d:"M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7z"}],
      ["path",{d:"M14 2v5h5"}]
    ]},

    save: { vb:"0 0 24 24", els:[
      ["path",{d:"M5 3h12l2 2v16a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"}],
      ["path",{d:"M7 3v6h10V3"}],
      ["rect",{x:"7",y:"14",width:"10",height:"7",rx:"1"}]
    ]},

    settings: { vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"3.2"}],
      ["path",{d:"M12 2v2.2"}],["path",{d:"M12 19.8V22"}],
      ["path",{d:"M2 12h2.2"}],["path",{d:"M19.8 12H22"}],
      ["path",{d:"M4.6 4.6l1.6 1.6"}],["path",{d:"M17.8 17.8l1.6 1.6"}],
      ["path",{d:"M19.4 4.6l-1.6 1.6"}],["path",{d:"M6.2 17.8l-1.6 1.6"}]
    ]},

    users: { vb:"0 0 24 24", els:[
      ["circle",{cx:"9",cy:"8.5",r:"3"}],
      ["path",{d:"M3.5 20a6 6 0 0 1 11 0"}],
      ["circle",{cx:"17",cy:"9.5",r:"2.5"}],
      ["path",{d:"M14.5 20a4.8 4.8 0 0 1 7 0"}]
    ]},
    userPlus: { vb:"0 0 24 24", els:[
      ["circle",{cx:"9",cy:"8.5",r:"3"}],
      ["path",{d:"M3.5 20a6 6 0 0 1 11 0"}],
      ["line",{x1:"18",y1:"9",x2:"18",y2:"15"}],
      ["line",{x1:"15",y1:"12",x2:"21",y2:"12"}]
    ]},

    idCard: { vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"6",width:"18",height:"14",rx:"2"}],
      ["circle",{cx:"8.5",cy:"12",r:"2"}],
      ["path",{d:"M6.5 17a3.5 3.5 0 0 1 4 0"}],
      ["line",{x1:"13",y1:"11",x2:"18",y2:"11"}],
      ["line",{x1:"13",y1:"15",x2:"18",y2:"15"}]
    ]},

    grad: { vb:"0 0 24 24", els:[
      ["path",{d:"M2 8l10-4 10 4-10 4-10-4z"}],
      ["path",{d:"M6 10.5V15c0 2 3 4 6 4s6-2 6-4v-4.5"}],
      ["path",{d:"M22 8v6"}]
    ]},

    board: { vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"4",width:"18",height:"12",rx:"2"}],
      ["line",{x1:"8",y1:"20",x2:"16",y2:"20"}],
      ["line",{x1:"12",y1:"16",x2:"12",y2:"20"}]
    ]},

    book: { vb:"0 0 24 24", els:[
      ["path",{d:"M4 19a2 2 0 0 0 2 2h14"}],
      ["path",{d:"M4 5a2 2 0 0 1 2-2h14v18H6a2 2 0 0 0-2 2z"}],
      ["path",{d:"M12 3v18"}]
    ]},

    clipboard: { vb:"0 0 24 24", els:[
      ["rect",{x:"7",y:"4",width:"10",height:"4",rx:"2"}],
      ["path",{d:"M9 4V3h6v1"}],
      ["rect",{x:"6",y:"6",width:"12",height:"16",rx:"2"}],
      ["line",{x1:"9",y1:"11",x2:"15",y2:"11"}],
      ["line",{x1:"9",y1:"15",x2:"15",y2:"15"}]
    ]},

    list: { vb:"0 0 24 24", els:[
      ["line",{x1:"8",y1:"7",x2:"20",y2:"7"}],
      ["line",{x1:"8",y1:"12",x2:"20",y2:"12"}],
      ["line",{x1:"8",y1:"17",x2:"20",y2:"17"}],
      ["circle",{cx:"4.5",cy:"7",r:"0.8"}],
      ["circle",{cx:"4.5",cy:"12",r:"0.8"}],
      ["circle",{cx:"4.5",cy:"17",r:"0.8"}]
    ]},

    check: { vb:"0 0 24 24", els:[ ["polyline",{points:"20 6 9 17 4 12"}] ] },

    checklist: { vb:"0 0 24 24", els:[
      ["polyline",{points:"4 7 5.5 8.5 8 6"}],
      ["line",{x1:"11",y1:"7",x2:"20",y2:"7"}],
      ["polyline",{points:"4 12 5.5 13.5 8 11"}],
      ["line",{x1:"11",y1:"12",x2:"20",y2:"12"}],
      ["polyline",{points:"4 17 5.5 18.5 8 16"}],
      ["line",{x1:"11",y1:"17",x2:"20",y2:"17"}]
    ]},

    calendar: { vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"4",width:"18",height:"18",rx:"2"}],
      ["line",{x1:"16",y1:"2.5",x2:"16",y2:"6.5"}],
      ["line",{x1:"8",y1:"2.5",x2:"8",y2:"6.5"}],
      ["line",{x1:"3",y1:"9",x2:"21",y2:"9"}]
    ]},

    clock: { vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["path",{d:"M12 7v6l4 2"}]
    ]},

    stopwatch: { vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"13",r:"8"}],
      ["path",{d:"M9 2h6"}],
      ["path",{d:"M12 5v1"}],
      ["path",{d:"M12 13l3 2"}],
      ["path",{d:"M19 7l1.2-1.2"}]
    ]},

    play: { vb:"0 0 24 24", els:[ ["polygon",{points:"9 7 19 12 9 17 9 7"}] ] },
    pause:{ vb:"0 0 24 24", els:[ ["rect",{x:"7",y:"6",width:"3",height:"12",rx:"1"}], ["rect",{x:"14",y:"6",width:"3",height:"12",rx:"1"}] ] },
    stop:{ vb:"0 0 24 24", els:[ ["rect",{x:"7",y:"7",width:"10",height:"10",rx:"2"}] ] },
    forward:{ vb:"0 0 24 24", els:[ ["polygon",{points:"5 7 13 12 5 17 5 7"}], ["polygon",{points:"11 7 19 12 11 17 11 7"}] ] },
    backward:{ vb:"0 0 24 24", els:[ ["polygon",{points:"19 7 11 12 19 17 19 7"}], ["polygon",{points:"13 7 5 12 13 17 13 7"}] ] },

    undo:{ vb:"0 0 24 24", els:[
      ["path",{d:"M9 14H5V10"}],
      ["path",{d:"M5 14c1.5-4.5 6-7 10.5-5.7 2.8.8 4.9 3.2 5.5 6.1"}]
    ]},
    redo:{ vb:"0 0 24 24", els:[
      ["path",{d:"M15 14h4V10"}],
      ["path",{d:"M19 14c-1.5-4.5-6-7-10.5-5.7-2.8.8-4.9 3.2-5.5 6.1"}]
    ]},
    rotate:{ vb:"0 0 24 24", els:[
      ["path",{d:"M20 12a8 8 0 0 0-14.5-4.5"}],
      ["path",{d:"M5 5v5h5"}],
      ["path",{d:"M4 12a8 8 0 0 0 14.5 4.5"}],
      ["path",{d:"M19 19v-5h-5"}]
    ]},
    shuffle:{ vb:"0 0 24 24", els:[
      ["path",{d:"M16 3h5v5"}],
      ["path",{d:"M4 4h6l6 8h5"}],
      ["path",{d:"M16 21h5v-5"}],
      ["path",{d:"M4 20h6l3-4"}],
      ["path",{d:"M14 10l3-4"}]
    ]},

    dice:{ vb:"0 0 24 24", els:[
      ["rect",{x:"5",y:"5",width:"14",height:"14",rx:"3"}],
      ["circle",{cx:"9",cy:"9",r:"1"}],
      ["circle",{cx:"15",cy:"15",r:"1"}],
      ["circle",{cx:"15",cy:"9",r:"1"}],
      ["circle",{cx:"9",cy:"15",r:"1"}]
    ]},

    gamepad:{ vb:"0 0 24 24", els:[
      ["path",{d:"M7 10h10a4 4 0 0 1 3.8 5.2l-1.1 3.4a2.5 2.5 0 0 1-4.2 1l-2-2.1H10.5l-2 2.1a2.5 2.5 0 0 1-4.2-1L3.2 15.2A4 4 0 0 1 7 10z"}],
      ["line",{x1:"8.5",y1:"13.5",x2:"11",y2:"13.5"}],
      ["line",{x1:"9.75",y1:"12.25",x2:"9.75",y2:"14.75"}],
      ["circle",{cx:"15.8",cy:"13.2",r:"0.8"}],
      ["circle",{cx:"17.6",cy:"14.8",r:"0.8"}]
    ]},

    map:{ vb:"0 0 24 24", els:[
      ["path",{d:"M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"}],
      ["line",{x1:"9",y1:"3",x2:"9",y2:"18"}],
      ["line",{x1:"15",y1:"6",x2:"15",y2:"21"}]
    ]},

    tv:{ vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"6",width:"18",height:"12",rx:"2"}],
      ["line",{x1:"8",y1:"20",x2:"16",y2:"20"}],
      ["line",{x1:"12",y1:"18",x2:"12",y2:"20"}]
    ]},

    expand:{ vb:"0 0 24 24", els:[
      ["polyline",{points:"9 3 3 3 3 9"}],
      ["polyline",{points:"15 3 21 3 21 9"}],
      ["polyline",{points:"3 15 3 21 9 21"}],
      ["polyline",{points:"21 15 21 21 15 21"}]
    ]},
    compress:{ vb:"0 0 24 24", els:[
      ["polyline",{points:"9 9 3 9 3 3"}],
      ["polyline",{points:"15 9 21 9 21 3"}],
      ["polyline",{points:"9 15 3 15 3 21"}],
      ["polyline",{points:"15 15 21 15 21 21"}]
    ]},

    eye:{ vb:"0 0 24 24", els:[
      ["path",{d:"M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"}],
      ["circle",{cx:"12",cy:"12",r:"2.5"}]
    ]},
    eyeOff:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 3l18 18"}],
      ["path",{d:"M2 12s4-7 10-7c2.2 0 4.1.9 5.7 2.1"}],
      ["path",{d:"M22 12s-4 7-10 7c-2.2 0-4.1-.9-5.7-2.1"}],
      ["path",{d:"M10 10a3 3 0 0 0 4 4"}]
    ]},

    lock:{ vb:"0 0 24 24", els:[
      ["rect",{x:"5",y:"11",width:"14",height:"10",rx:"2"}],
      ["path",{d:"M8 11V8a4 4 0 0 1 8 0v3"}]
    ]},
    unlock:{ vb:"0 0 24 24", els:[
      ["rect",{x:"5",y:"11",width:"14",height:"10",rx:"2"}],
      ["path",{d:"M8 11V8a4 4 0 0 1 7.5-1.8"}]
    ]},

    bolt:{ vb:"0 0 24 24", els:[ ["path",{d:"M13 2L3 14h8l-1 8 10-12h-8l1-8z"}] ] },

    wand:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 21l10-10"}],
      ["path",{d:"M7 7l3 3"}],
      ["path",{d:"M14 4l1 2"}],["path",{d:"M18 6l-2 1"}],["path",{d:"M16 10l2 1"}],["path",{d:"M12 8l1-2"}]
    ]},

    bulb:{ vb:"0 0 24 24", els:[
      ["path",{d:"M9 18h6"}],
      ["path",{d:"M10 22h4"}],
      ["path",{d:"M8 14a6 6 0 1 1 8 0c-.8.7-1.2 1.6-1.4 2.6H9.4C9.2 15.6 8.8 14.7 8 14z"}]
    ]},

    target:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"8"}],
      ["circle",{cx:"12",cy:"12",r:"4"}],
      ["circle",{cx:"12",cy:"12",r:"1"}]
    ]},

    chartLine:{ vb:"0 0 24 24", els:[
      ["path",{d:"M4 19V5"}],
      ["path",{d:"M4 19h16"}],
      ["polyline",{points:"6 15 10 11 13 13 18 8"}]
    ]},
    chartPie:{ vb:"0 0 24 24", els:[
      ["path",{d:"M11 2a10 10 0 1 0 11 11H11z"}],
      ["path",{d:"M12 2v11h11"}]
    ]},

    table:{ vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"5",width:"18",height:"14",rx:"2"}],
      ["line",{x1:"3",y1:"10",x2:"21",y2:"10"}],
      ["line",{x1:"3",y1:"14",x2:"21",y2:"14"}],
      ["line",{x1:"9",y1:"5",x2:"9",y2:"19"}],
      ["line",{x1:"15",y1:"5",x2:"15",y2:"19"}]
    ]},
    grid: { vb:"0 0 24 24", els:[
      ["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}],
      ["line",{x1:"12",y1:"4",x2:"12",y2:"20"}],
      ["line",{x1:"4",y1:"12",x2:"20",y2:"12"}]
    ]},

    layers:{ vb:"0 0 24 24", els:[
      ["path",{d:"M12 3l9 5-9 5-9-5 9-5z"}],
      ["path",{d:"M3 12l9 5 9-5"}],
      ["path",{d:"M3 16l9 5 9-5"}]
    ]},

    folder:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 6a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}],
      ["path",{d:"M3 9h18"}]
    ]},
    archive:{ vb:"0 0 24 24", els:[
      ["rect",{x:"3",y:"4",width:"18",height:"5",rx:"2"}],
      ["rect",{x:"5",y:"9",width:"14",height:"11",rx:"2"}],
      ["line",{x1:"10",y1:"13",x2:"14",y2:"13"}]
    ]},
    inbox:{ vb:"0 0 24 24", els:[
      ["path",{d:"M4 4h16l2 8v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8z"}],
      ["path",{d:"M2 12h6l2 3h4l2-3h6"}]
    ]},

    database:{ vb:"0 0 24 24", els:[
      ["ellipse",{cx:"12",cy:"5",rx:"7",ry:"3"}],
      ["path",{d:"M5 5v6c0 1.7 3.1 3 7 3s7-1.3 7-3V5"}],
      ["path",{d:"M5 11v6c0 1.7 3.1 3 7 3s7-1.3 7-3v-6"}]
    ]},

    copy:{ vb:"0 0 24 24", els:[
      ["rect",{x:"9",y:"9",width:"11",height:"11",rx:"2"}],
      ["rect",{x:"4",y:"4",width:"11",height:"11",rx:"2"}]
    ]},

    pencil:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 21l3.5-.7L20 6.8a2 2 0 0 0 0-2.8L20 4a2 2 0 0 0-2.8 0L3.7 17.5z"}],
      ["path",{d:"M14 5l5 5"}]
    ]},

    eraser:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 16l7-9a2 2 0 0 1 3 0l8 9a2 2 0 0 1-1.5 3H8.5A2 2 0 0 1 7 18.3L3 16z"}],
      ["path",{d:"M7 19h14"}]
    ]},

    trash:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 6h18"}],
      ["path",{d:"M8 6V4h8v2"}],
      ["rect",{x:"6",y:"6",width:"12",height:"16",rx:"2"}],
      ["line",{x1:"10",y1:"11",x2:"10",y2:"18"}],
      ["line",{x1:"14",y1:"11",x2:"14",y2:"18"}]
    ]},

    x:{ vb:"0 0 24 24", els:[ ["line",{x1:"6",y1:"6",x2:"18",y2:"18"}], ["line",{x1:"18",y1:"6",x2:"6",y2:"18"}] ] },

    warning:{ vb:"0 0 24 24", els:[
      ["path",{d:"M12 3l10 18H2L12 3z"}],
      ["line",{x1:"12",y1:"9",x2:"12",y2:"14"}],
      ["circle",{cx:"12",cy:"17",r:"0.9"}]
    ]},

    alertCircle:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["line",{x1:"12",y1:"8",x2:"12",y2:"13"}],
      ["circle",{cx:"12",cy:"16",r:"0.9"}]
    ]},

    checkCircle:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["polyline",{points:"16 9 11 14 8 11"}]
    ]},

    info:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["line",{x1:"12",y1:"11",x2:"12",y2:"16"}],
      ["circle",{cx:"12",cy:"8",r:"0.9"}]
    ]},

    flag:{ vb:"0 0 24 24", els:[
      ["path",{d:"M4 22V3"}],
      ["path",{d:"M4 4h12l-1.5 4L16 12H4"}]
    ]},

    tag:{ vb:"0 0 24 24", els:[
      ["path",{d:"M20 12l-8 8-10-10V4h6z"}],
      ["circle",{cx:"7.5",cy:"7.5",r:"1.2"}]
    ]},

    arrowRight:{ vb:"0 0 24 24", els:[
      ["line",{x1:"4",y1:"12",x2:"18",y2:"12"}],
      ["polyline",{points:"13 7 18 12 13 17"}]
    ]},
    chevronLeft:{ vb:"0 0 24 24", els:[ ["polyline",{points:"15 18 9 12 15 6"}] ] },
    chevronRight:{ vb:"0 0 24 24", els:[ ["polyline",{points:"9 18 15 12 9 6"}] ] },

    sun:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"4"}],
      ["path",{d:"M12 2v2"}],["path",{d:"M12 20v2"}],
      ["path",{d:"M4.2 4.2l1.4 1.4"}],["path",{d:"M18.4 18.4l1.4 1.4"}],
      ["path",{d:"M2 12h2"}],["path",{d:"M20 12h2"}],
      ["path",{d:"M4.2 19.8l1.4-1.4"}],["path",{d:"M18.4 5.6l1.4-1.4"}]
    ]},

    moon:{ vb:"0 0 24 24", els:[ ["path",{d:"M21 14.5A8.5 8.5 0 0 1 9.5 3 7.5 7.5 0 1 0 21 14.5z"}] ] },

    shieldHeart:{ vb:"0 0 24 24", els:[
      ["path",{d:"M12 2l8 4v6c0 5-3.4 9.4-8 10-4.6-.6-8-5-8-10V6l8-4z"}],
      ["path",{d:"M12 17s-3.5-2-4.6-3.9c-.7-1.2-.3-2.7 1-3.4 1-.6 2.2-.3 3 .6.8-.9 2-.2 3-.6 1.3.7 1.7 2.2 1 3.4C15.5 15 12 17 12 17z"}]
    ]},

    medical:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["line",{x1:"12",y1:"7.5",x2:"12",y2:"16.5"}],
      ["line",{x1:"7.5",y1:"12",x2:"16.5",y2:"12"}]
    ]},

    skull:{ vb:"0 0 24 24", els:[
      ["path",{d:"M12 3a7 7 0 0 0-7 7v3a4 4 0 0 0 3 3.9V20h8v-3.1A4 4 0 0 0 19 13v-3a7 7 0 0 0-7-7z"}],
      ["circle",{cx:"9",cy:"11",r:"1"}],
      ["circle",{cx:"15",cy:"11",r:"1"}],
      ["path",{d:"M10 15h4"}]
    ]},

    access:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"12",cy:"12",r:"9"}],
      ["circle",{cx:"12",cy:"8",r:"1.7"}],
      ["path",{d:"M6.5 19a5.5 5.5 0 0 1 11 0"}],
      ["path",{d:"M7 13h10"}]
    ]},

    shapes:{ vb:"0 0 24 24", els:[
      ["circle",{cx:"7",cy:"8",r:"3"}],
      ["rect",{x:"13",y:"5",width:"6",height:"6",rx:"1"}],
      ["polygon",{points:"12 20 5 20 8.5 14"}]
    ]},

    calculator:{ vb:"0 0 24 24", els:[
      ["rect",{x:"6",y:"3",width:"12",height:"18",rx:"2"}],
      ["line",{x1:"8",y1:"7",x2:"16",y2:"7"}],
      ["circle",{cx:"9",cy:"11",r:"0.8"}],["circle",{cx:"12",cy:"11",r:"0.8"}],["circle",{cx:"15",cy:"11",r:"0.8"}],
      ["circle",{cx:"9",cy:"14",r:"0.8"}],["circle",{cx:"12",cy:"14",r:"0.8"}],["circle",{cx:"15",cy:"14",r:"0.8"}],
      ["circle",{cx:"9",cy:"17",r:"0.8"}],["circle",{cx:"12",cy:"17",r:"0.8"}],["circle",{cx:"15",cy:"17",r:"0.8"}]
    ]},

    broom:{ vb:"0 0 24 24", els:[
      ["path",{d:"M3 21h6"}],
      ["path",{d:"M6 20l10-16"}],
      ["path",{d:"M14 6l7 4-3 5-7-4z"}]
    ]},

    bug:{ vb:"0 0 24 24", els:[
      ["path",{d:"M9 9h6"}],
      ["path",{d:"M8 12h8"}],
      ["path",{d:"M9 15h6"}],
      ["path",{d:"M10 5l-1-2"}],
      ["path",{d:"M14 5l1-2"}],
      ["rect",{x:"8",y:"7",width:"8",height:"12",rx:"4"}],
      ["path",{d:"M6 13H4"}],
      ["path",{d:"M20 13h-2"}]
    ]},

    message:{ vb:"0 0 24 24", els:[
      ["path",{d:"M21 14a4 4 0 0 1-4 4H8l-5 3V6a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}],
      ["circle",{cx:"9",cy:"10",r:"0.8"}],
      ["circle",{cx:"12",cy:"10",r:"0.8"}],
      ["circle",{cx:"15",cy:"10",r:"0.8"}]
    ]},

    num1:{ vb:"0 0 24 24", els:[ ["circle",{cx:"12",cy:"12",r:"9"}], ["text",{x:"12",y:"16","text-anchor":"middle","class":"sgp-ico-fill","font-size":"10","font-family":"system-ui,Segoe UI,Arial","font-weight":"700","text":"1"}] ] },
    num2:{ vb:"0 0 24 24", els:[ ["circle",{cx:"12",cy:"12",r:"9"}], ["text",{x:"12",y:"16","text-anchor":"middle","class":"sgp-ico-fill","font-size":"10","font-family":"system-ui,Segoe UI,Arial","font-weight":"700","text":"2"}] ] },
    num3:{ vb:"0 0 24 24", els:[ ["circle",{cx:"12",cy:"12",r:"9"}], ["text",{x:"12",y:"16","text-anchor":"middle","class":"sgp-ico-fill","font-size":"10","font-family":"system-ui,Segoe UI,Arial","font-weight":"700","text":"3"}] ] },
    num4:{ vb:"0 0 24 24", els:[ ["circle",{cx:"12",cy:"12",r:"9"}], ["text",{x:"12",y:"16","text-anchor":"middle","class":"sgp-ico-fill","font-size":"10","font-family":"system-ui,Segoe UI,Arial","font-weight":"700","text":"4"}] ] }
  };

  function __getIconClass(el){
    try{
      var cl = el.classList;
      if(!cl) return '';
      for(var i=0;i<cl.length;i++){
        var c=cl[i];
        if(c && c.indexOf('fa-')===0 && c!=='fa-solid' && c!=='fa-regular' && c!=='fa-brands') return c;
      }
    }catch(e){}
    return '';
  }

  function __makeSvg(key){
    var def = ICONS[key] || ICONS.circle;
    var svg = document.createElementNS(SVG_NS,'svg');
    svg.setAttribute('viewBox', def.vb || "0 0 24 24");
    svg.setAttribute('aria-hidden','true');
    svg.setAttribute('focusable','false');
    var els = def.els || [];
    for(var i=0;i<els.length;i++){
      var item = els[i];
      var tag = item[0], attrs = item[1] || {};
      var node = document.createElementNS(SVG_NS, tag);
      for(var k in attrs){
        if(!Object.prototype.hasOwnProperty.call(attrs,k)) continue;
        if(k==='text'){ node.textContent = String(attrs[k]); }
        else node.setAttribute(k, String(attrs[k]));
      }
      svg.appendChild(node);
    }
    return svg;
  }

  function __apply(el){
    try{
      if(!el || el.__sgpIconApplied) return;
      var c=__getIconClass(el);
      if(!c) return;
      var key = CLASS_TO_ICON[c] || 'circle';
      while(el.firstChild) el.removeChild(el.firstChild);
      el.textContent = '';
      el.appendChild(__makeSvg(key));
      el.__sgpIconApplied = true;
    }catch(e){}
  }

  function __scan(root){
    try{
      (root||document).querySelectorAll('i.fa,i.fas,i.far,i.fab,i.fa-solid,i.fa-regular,i.fa-brands').forEach(__apply);
    }catch(e){}
  }

  function __observe(){
    try{
      __sgpIconMO=new MutationObserver(function(muts){
        for(var i=0;i<muts.length;i++){
          var m=muts[i];
          if(m.addedNodes){
            for(var j=0;j<m.addedNodes.length;j++){
              var n=m.addedNodes[j];
              if(n && n.nodeType===1){
                if(n.matches && n.matches('i.fa,i.fas,i.far,i.fab,i.fa-solid,i.fa-regular,i.fa-brands')) __apply(n);
                __scan(n);
              }
            }
          }
        }
      });
      __sgpIconMO.observe(document.documentElement,{childList:true,subtree:true});
    }catch(e){}
  }

  function __hasFontAwesome(){
    try{
      var hasHref=false;
      for(var i=0;i<document.styleSheets.length;i++){
        var ss=document.styleSheets[i];
        var href=ss && ss.href ? String(ss.href).toLowerCase() : "";
        if(href && (href.indexOf("font-awesome")!==-1 || href.indexOf("@fortawesome")!==-1)){
          hasHref=true; break;
        }
      }
      var t=document.createElement('i');
      t.className='fa-solid fa-check';
      t.style.cssText='position:absolute;left:-9999px;top:-9999px;visibility:hidden;';
      (document.body||document.documentElement).appendChild(t);
      var c = window.getComputedStyle(t,'::before').getPropertyValue('content');
      t.parentNode && t.parentNode.removeChild(t);
      if(c && c!=='none' && c!=='""' && c!=="''") return true;
      return hasHref;
    }catch(e){ return false; }
  }

  function __startInline(){ __scan(document); __observe(); }

  function __stopInline(){
    try{
      if(__sgpIconMO){ __sgpIconMO.disconnect(); __sgpIconMO=null; }
    }catch(e){}
    try{
      document.querySelectorAll('i.fa,i.fas,i.far,i.fab,i.fa-solid,i.fa-regular,i.fa-brands').forEach(function(el){
        try{
          if(el && el.__sgpIconApplied){
            while(el.firstChild) el.removeChild(el.firstChild);
            el.textContent='';
            delete el.__sgpIconApplied;
          }
        }catch(e){}
      });
    }catch(e){}
  }

  function __init(){
    try{
      if(__hasFontAwesome()) return; // usa FontAwesome do Projeto 1 quando disponível
    }catch(e){}
    __startInline();
    try{
      var link=document.getElementById('sgp-fa-css');
      if(link){
        link.addEventListener('load', function(){
          try{
            if(__hasFontAwesome()){
              __stopInline();
            }
          }catch(e){}
        });
      }
    }catch(e){}
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', __init);
  }else{
    __init();
  }
})();
</script>

<script id="sgp-internal-libs">
/* SGP: libs internas (modo totalmente offline) - html2pdf fallback + mini Chart */
(function(){
  // html2pdf fallback (impressão do navegador)
  if(typeof window.html2pdf !== 'function'){
    function __SGP_H2P(){
      this._opt = {};
      this._el = null;
    }
    __SGP_H2P.prototype.set = function(opt){ this._opt = opt || {}; return this; };
    __SGP_H2P.prototype.from = function(el){ this._el = el || null; return this; };
    __SGP_H2P.prototype.save = function(filename){
      try{
        var el = this._el;
        if(!el){ throw new Error('Elemento não definido para exportação.'); }
        var title = String(filename || (this._opt && this._opt.filename) || 'export.pdf');
        var w = window.open('', '_blank');
        if(!w){ throw new Error('Pop-up bloqueado. Permita abrir janela para imprimir.'); }
        var styles = '';
        try{
          var nodes = document.querySelectorAll('style, link[rel="stylesheet"]');
          nodes.forEach(function(n){
            if(n.tagName === 'STYLE'){ styles += '<style>' + n.textContent + '</style>'; }
            else if(n.tagName === 'LINK'){ styles += '<link rel="stylesheet" href="' + n.href + '">'; }
          });
        }catch(_){}
        w.document.open();
        w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>'+title+'</title>'+styles+'</head><body style="margin:0;padding:16px;">'+el.outerHTML+'</body></html>');
        w.document.close();
        w.focus();
        setTimeout(function(){ try{ w.print(); }catch(e){} }, 350);
      }catch(e){
        try{ if(typeof __diagCapture==='function') __diagCapture(e,'html2pdf.fallback',{}); }catch(_){}
        try{ if(typeof showToast==='function') showToast('Exportação PDF: use Imprimir (Ctrl+P).', 'error'); }catch(_){}
      }
      return this;
    };
    window.html2pdf = function(){ return new __SGP_H2P(); };
  }

  // Mini Chart (suporta apenas type:'line' usado no projeto)
  if(typeof window.Chart !== 'function'){
    function __SGP_Chart(ctx, cfg){
      this.ctx = ctx;
      this.canvas = ctx && ctx.canvas ? ctx.canvas : null;
      this.cfg = cfg || {};
      this._draw();
    }
    __SGP_Chart.prototype.destroy = function(){
      try{
        if(this.ctx && this.canvas){
          this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        }
      }catch(_){}
    };
    __SGP_Chart.prototype._draw = function(){
      try{
        if(!this.ctx || !this.canvas) return;
        var ctx = this.ctx;
        // garante tamanho
        var w = this.canvas.clientWidth || this.canvas.width || 600;
        var h = this.canvas.clientHeight || this.canvas.height || 300;
        if(this.canvas.width !== w) this.canvas.width = w;
        if(this.canvas.height !== h) this.canvas.height = h;

        ctx.clearRect(0,0,w,h);
        var cfg = this.cfg || {};
        if((cfg.type||'') !== 'line') return;

        var labels = (cfg.data && cfg.data.labels) ? cfg.data.labels : [];
        var datasets = (cfg.data && cfg.data.datasets) ? cfg.data.datasets : [];
        var padL = 40, padR = 16, padT = 24, padB = 28;
        var plotW = Math.max(1, w - padL - padR);
        var plotH = Math.max(1, h - padT - padB);

        // coletar min/max
        var vals = [];
        datasets.forEach(function(ds){
          (ds.data||[]).forEach(function(v){ var n = Number(v); if(!isNaN(n)) vals.push(n); });
        });
        var minV = vals.length ? Math.min.apply(null, vals) : 0;
        var maxV = vals.length ? Math.max.apply(null, vals) : 1;
        if(minV === maxV){ maxV = minV + 1; }

        // eixo
        ctx.save();
        ctx.globalAlpha = 0.35;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, padT+plotH);
        ctx.lineTo(padL+plotW, padT+plotH);
        ctx.strokeStyle = '#94a3b8';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.restore();

        // grid leve
        ctx.save();
        ctx.globalAlpha = 0.12;
        ctx.strokeStyle = '#94a3b8';
        for(var g=1; g<=3; g++){
          var y = padT + (plotH*g/4);
          ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
        }
        ctx.restore();

        function xAt(i){
          if(labels.length<=1) return padL + plotW/2;
          return padL + (plotW * (i/(labels.length-1)));
        }
        function yAt(v){
          var t = (Number(v)-minV)/(maxV-minV);
          return padT + plotH - (plotH*t);
        }

        // desenhar linhas
        datasets.forEach(function(ds, di){
          var data = ds.data || [];
          if(!data.length) return;
          ctx.save();
          ctx.strokeStyle = ds.borderColor || '#2563eb';
          ctx.fillStyle = ds.backgroundColor || ctx.strokeStyle;
          ctx.lineWidth = 2;
          ctx.beginPath();
          data.forEach(function(v,i){
            var x = xAt(i);
            var y = yAt(v);
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          });
          ctx.stroke();
          // pontos
          ctx.globalAlpha = 0.9;
          data.forEach(function(v,i){
            var x = xAt(i);
            var y = yAt(v);
            ctx.beginPath();
            ctx.arc(x,y,3,0,Math.PI*2);
            ctx.fill();
          });
          ctx.restore();
        });

        // labels X (poucos)
        ctx.save();
        ctx.fillStyle = '#64748b';
        ctx.font = '12px sans-serif';
        var step = Math.max(1, Math.ceil(labels.length/6));
        for(var i=0;i<labels.length;i+=step){
          var x = xAt(i);
          var s = String(labels[i] ?? '');
          ctx.fillText(s, Math.max(padL, Math.min(w-40, x-10)), padT+plotH+18);
        }
        ctx.restore();

        // legenda simples
        ctx.save();
        ctx.font = '12px sans-serif';
        var lx = padL, ly = 14;
        datasets.forEach(function(ds){
          var lbl = String(ds.label || '');
          ctx.fillStyle = ds.borderColor || '#2563eb';
          ctx.fillRect(lx, ly-8, 10, 3);
          ctx.fillStyle = '#334155';
          ctx.fillText(lbl, lx+14, ly-2);
          lx += 14 + ctx.measureText(lbl).width + 18;
        });
        ctx.restore();

      }catch(e){
        try{ if(typeof __diagCapture==='function') __diagCapture(e,'miniChart.draw',{}); }catch(_){}
      }
    };
    window.__SGP_Chart = __SGP_Chart;
    window.Chart = __SGP_Chart;
  }
})();
</script>
<style>
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; --bg-body: #f8fafc; --bg-sidebar: #0f172a;    
            --card-bg: #ffffff; --text-main: #334155; --border-color: #e2e8f0; --input-bg: #ffffff;
            --farol-verde: #16a34a; --farol-amarelo: #f59e0b; --farol-vermelho: #dc2626;
            --inclusao: #9333ea;
            --danger: #ef4444; --warning: #f59e0b; --text-muted: #64748b; --text-sub: #475569;
            --primary-accent: #8b5cf6;
        }

        /* CARD UTILITY CLASSES */
        .card-info-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
        .card-actions-row { display:flex; gap:8px; align-items:center; }
        .card-header-left { flex:1; min-width:0; }
        .aluno-nome-wrap { display:flex; align-items:center; gap:8px; min-width:0; }
        .aluno-nome-wrap .aluno-nome { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block; max-width:100%; }
        .blitz-box { background:var(--bg-body); padding:6px; border-radius:8px; border:1px solid var(--border-color); display:inline-flex; align-items:center; gap:4px; }
        .blitz-icon { color:var(--warning); font-size:0.8rem; }
        .btn-delete-card { border:none; background:transparent; color:var(--danger); cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s; }
        .btn-delete-card:hover { background:rgba(239,68,68,0.1); }
        .btn-boletim-card { background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd; font-size:0.75rem; padding:4px 8px; border-radius:6px; cursor:pointer; transition:background 0.2s; display:inline-flex; align-items:center; gap:4px; }
        .btn-boletim-card:hover { background:#bae6fd; }
        body.dark-mode .btn-boletim-card { background:#0c4a6e; color:#bae6fd; border-color:#075985; }
        body.dark-mode .btn-boletim-card:hover { background:#075985; }
        body.dark-mode .blitz-box { background:var(--bg-body); border-color:var(--border-color); }
        body.dark-mode .btn-delete-card { color:#f87171; }
        body.dark-mode .btn-delete-card:hover { background:rgba(248,113,113,0.15); }

        /* MODO NOTURNO */
        body.dark-mode {
            --bg-body: #0f172a; --bg-sidebar: #020617; --card-bg: #1e293b; --text-main: #e2e8f0;
            --border-color: #334155; --input-bg: #334155;
            --text-muted: #94a3b8; --text-sub: #cbd5e1; --danger: #f87171; --warning: #fbbf24;
        }
        body.dark-mode .card-stats, body.dark-mode .tabela-dados th, body.dark-mode .modal-header-xl, 
        body.dark-mode .modal-footer-xl, body.dark-mode .cal-day, body.dark-mode .mapa-livres-header {
            background: #1e293b; color: #cbd5e1; border-color: #334155;
        }
        body.dark-mode .aluno-nome, body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: #f1f5f9 !important; }
        body.dark-mode .tabela-dados td { border-color: #334155; color: #cbd5e1; }
        body.dark-mode .inp, body.dark-mode textarea, body.dark-mode select { background: #334155; color: white; border-color: #475569; }
        body.dark-mode .modal-box { background: #1e293b; color: white; }
        body.dark-mode .cal-day:hover { background: #334155; }
        body.dark-mode .copy-area { background: #334155; color: white; }
        body.dark-mode .tag-chip { background: #334155; color: #e2e8f0; border-color: #475569; }
        body.dark-mode .badge-bncc { background: #1e3a8a; color: #bfdbfe; border-color: #1e40af; }
        body.dark-mode .group-card { background: #1e293b; border-color: #475569; color: #e2e8f0; }
        body.dark-mode .search-bar { background: #1e293b; border-color: #475569; color: white; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; transition: background 0.3s; }

        /* PRIVACIDADE */
        body.privacy-active .card-stats, body.privacy-active .badge-nota, 
        body.privacy-active #tbodyFechamento td:nth-child(4), body.privacy-active #tbodyFechamento td:nth-child(5), 
        body.privacy-active #tbodyAnual td:nth-child(3), body.privacy-active #tbodyAnual td:nth-child(4), 
        body.privacy-active #tbodyAnual td:nth-child(5), body.privacy-active #tbodyAnual td:nth-child(6),
        body.privacy-active #tbodyAnual td:nth-child(7), body.privacy-active .nota-input-massa,
        body.privacy-active #dashTotal, body.privacy-active .bar-bg, body.privacy-active .grafico-barra {
            filter: blur(6px); pointer-events: none; user-select: none;
        }

        /* MODO FOCO (ZEN) */
        body.zen-mode aside { display: none; }
        body.zen-mode .top-bar { display: none; }
        body.zen-mode main { padding: 0; height: 100vh; overflow: hidden; }
        body.zen-mode .mapa-container, body.zen-mode .calendar-container { height: 100vh; border-radius: 0; border: none; }
        body.zen-mode .btn-zen-exit { display: flex; }

        .btn-zen-exit { 
            display: none; position: fixed; top: 20px; right: 20px; z-index: 9999; 
            background: #ef4444; color: white; border: none; padding: 10px 20px; 
            border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            align-items: center; gap: 8px;
        }
        .btn-zen-exit:hover { transform: scale(1.05); }

        /* SIDEBAR */
        aside { width: 260px; background: var(--bg-sidebar); color: #cbd5e1; display: flex; flex-direction: column; padding: 1.5rem; flex-shrink: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10;}
        .brand { font-size: 1.3rem; font-weight: 700; color: white; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        .sidebar-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; color: #64748b; font-weight: 700; }
        #listaTurmas { list-style: none; overflow-y: auto; flex: 1; margin-bottom: 20px;}
        .turma-item { padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .turma-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .turma-item.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .btn-trash-turma { background: none; border: none; color: #f87171; cursor: pointer; opacity: 0; transition: 0.2s; }
        .turma-item:hover .btn-trash-turma { opacity: 1; }
        .btn-add-turma { width: 100%; padding: 12px; margin-top: 10px; background: transparent; border: 1px dashed #475569; border-radius: 8px; color: #94a3b8; cursor: pointer; transition: 0.2s; }
        .btn-add-turma:hover { border-color: var(--primary); color: var(--primary); background: rgba(37, 99, 235, 0.1); }

        .file-actions { border-top: 1px solid #1e293b; padding-top: 20px; }
        .btn-file { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-weight: 600; }
        .btn-save { background: #0ea5e9; color: white; } .btn-save:hover { background: #0284c7; }
        .btn-load { background: #334155; color: #e2e8f0; } .btn-load:hover { background: #475569; }
        .btn-excel { background: #16a34a; color: white; } .btn-excel:hover { background: #15803d; }
        .btn-copy { background: #8b5cf6; color: white; } .btn-copy:hover { background: #7c3aed; }
        .btn-dark { background: #64748b; color: white; margin-top: 10px; } .btn-dark:hover { background: #475569; }
        .btn-config { background: #f59e0b; color: white; margin-top: 5px; } .btn-config:hover { background: #d97706; }

        /* ALERTA DE BACKUP */
        .backup-warning { display: none; background: #7f1d1d; color: #fecaca; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.8rem; font-weight: bold; border: 1px solid #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* BUSCA GLOBAL */
        .search-container {
            width: 100%;
            margin-bottom: 20px;
            position: relative;
        }
        .search-bar {
            width: 100%;
            padding: 16px 50px 16px 50px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-main);
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-bar:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .search-bar::placeholder {
            color: #94a3b8;
        }
        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
            font-size: 1.1rem;
        }
        .search-clear {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .search-clear:hover {
            background: #dc2626;
            transform: translateY(-50%) scale(1.1);
        }
        .search-clear.visible {
            display: flex;
        }

        /* MAIN */
        main { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; position: relative;}
        .top-bar { 
            display: flex; 
            flex-direction: column;
            gap: 20px;
            margin-bottom: 2rem; 
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-body) 100%);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            border: 1px solid var(--border-color);
        }
        
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .title-area { flex: 1; }
        .title-area h1 { 
            font-size: 2rem; 
            color: var(--text-main); 
            margin-bottom: 8px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .title-subtitle {
            font-size: 0.9rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bimestre-selector { 
            display: flex; 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 6px; 
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        body.dark-mode .bimestre-selector { background: #1e293b; border-color: #334155; }
        .btn-bim { 
            padding: 10px 20px; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 8px; 
            font-weight: 700; 
            color: #64748b; 
            transition: all 0.2s; 
            font-size: 0.95rem;
            position: relative;
        }
        .btn-bim:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .btn-bim.active { 
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white; 
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
            transform: translateY(-2px);
        }
        
        .controls-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-body);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .control-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 4px;
        }
        
        .view-toggle { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            background: var(--card-bg); 
            border-radius: 10px; 
            padding: 6px;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Ajuste: grupo Análise com 5 botões em uma linha */
        .view-toggle.cols-5 {
            grid-template-columns: repeat(5, 1fr);
        }
        body.dark-mode .view-toggle { background: #1e293b; }
        .btn-view { 
            padding: 10px 14px; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 7px; 
            font-weight: 600; 
            color: #64748b; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 6px; 
            font-size: 0.85rem;
            position: relative;
        }
        .btn-view:hover { 
            background: rgba(37, 99, 235, 0.1); 
            color: var(--primary);
            transform: translateY(-1px);
        }
        .btn-view.active { 
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white; 
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        body.dark-mode .btn-view.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        
        .tools-group {
            display: flex;
            gap: 6px;
            align-items: center;
            background: var(--card-bg);
            padding: 6px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .btn-tool { 
            padding: 10px 12px; 
            border: none;
            background: transparent; 
            border-radius: 7px; 
            cursor: pointer; 
            color: #475569; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
        }
        body.dark-mode .btn-tool { background: transparent; color: #cbd5e1; }
        .btn-tool:hover { 
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            transform: translateY(-1px);
        }
        .btn-tool.active { 
            background: var(--primary);
            color: white;
        }
        
        .filters-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .btn-inclusao { 
            padding: 10px 16px; 
            border: 2px solid var(--inclusao);
            background: transparent; 
            cursor: pointer; 
            border-radius: 10px; 
            font-weight: 700; 
            color: var(--inclusao); 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .btn-inclusao:hover { 
            background: rgba(147, 51, 234, 0.1);
            transform: translateY(-1px);
        }
        .btn-inclusao.active { 
            background: linear-gradient(135deg, var(--inclusao) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(147, 51, 234, 0.3);
        }
        
        .btn-risco { 
            padding: 10px 16px; 
            border: 2px solid var(--farol-vermelho);
            background: transparent; 
            cursor: pointer; 
            border-radius: 10px; 
            font-weight: 700; 
            color: var(--farol-vermelho); 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .btn-risco:hover { 
            background: rgba(220, 38, 38, 0.1);
            transform: translateY(-1px);
        }
        .btn-risco.active { 
            background: linear-gradient(135deg, var(--farol-vermelho) 0%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.2s; 
            font-size: 0.95rem;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4);
        }
        .banner-risco { 
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fecaca; 
            color: #991b1b; 
            padding: 18px 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.1);
        }
        .banner-risco span {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
        }
        .btn-copy-risco { 
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3);
        }
        .btn-copy-risco:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(22, 163, 74, 0.4);
        }

        /* GRIDS & CARDS */
        .grid-alunos { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(340px, 100%), 1fr)); gap: 1.5rem; }
        .card-aluno { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            border: 2px solid var(--border-color);
            position: relative; 
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        .card-aluno::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-accent, #8b5cf6) 100%);
        }
        .card-aluno:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-color: var(--primary);
        }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .aluno-nome { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--text-main); 
            text-decoration: none; 
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s ease;
        }
        .aluno-nome:hover { 
            color: var(--primary);
        }
        .aluno-numero {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.85rem;
            color: var(--text-sub, #475569);
        }
        body.dark-mode .aluno-numero { background: linear-gradient(135deg, #334155 0%, #1e293b 100%); color: #cbd5e1; }
        .aluno-turma { 
            font-size: 0.8rem; 
            color: #64748b; 
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 4px 10px; 
            border-radius: 6px;
            font-weight: 600;
            border: 1px solid #cbd5e1;
        }
        body.dark-mode .aluno-turma { background: #334155; color: #cbd5e1; border-color: #475569; }
        .badge-inclusao { 
            font-size: 0.75rem; 
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            color: var(--inclusao); 
            padding: 4px 10px; 
            border-radius: 6px; 
            margin-left: 6px; 
            border: 1px solid #d8b4fe;
            font-weight: 700;
        }
        .card-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 12px; 
            margin-top: 15px; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 12px; 
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .stat-item > span {
            font-size: 0.75rem;
            color: var(--text-muted, #64748b);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .farol-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-weight: 800; 
            font-size: 1.3rem;
            padding: 6px 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }
        .farol-badge i {
            font-size: 0.9rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .farol-badge i.fc-verde { color: var(--farol-verde); }
        .farol-badge i.fc-amarelo { color: var(--farol-amarelo); }
        .farol-badge i.fc-vermelho { color: var(--farol-vermelho); }
        .tabela-dados { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: none; }
        .tabela-dados th { background: #f8fafc; text-align: left; padding: 15px; font-weight: 600; color: #475569; border-bottom: 2px solid var(--border-color); }
        .tabela-dados td { padding: 15px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; }
        .badge-nota { padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; }
        .check-entrega { transform: scale(1.5); cursor: pointer; accent-color: var(--primary); }

        /* EDIÇÃO EM MASSA */
        .nota-input-massa {
            width: 70px;
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            background: var(--input-bg);
            color: var(--text-main);
            transition: all 0.2s;
        }
        .nota-input-massa:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .row-aluno-massa {
            transition: background-color 0.2s;
        }
        .row-aluno-massa:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }
        .btn-salvar-massa {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--farol-verde);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            gap: 10px;
            align-items: center;
        }
        .btn-salvar-massa:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        
        /* ===== MASSA: Disciplinas + Fullscreen ===== */
        .massa-toolbar{
            display:flex;
            gap:10px;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            margin:10px 0 12px;
        }
        .massa-disc-nav{
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            align-items:center;
        }
        .massa-disc-btn{
            border:1px solid var(--border-color);
            background:var(--card-bg);
            color:var(--text-main);
            padding:8px 10px;
            border-radius:12px;
            cursor:pointer;
            font-weight:800;
            font-size:12px;
            display:flex;
            gap:8px;
            align-items:center;
            transition: transform .12s ease, box-shadow .2s ease, background .2s ease;
            user-select:none;
        }
        .massa-disc-btn:hover{ transform: translateY(-1px); box-shadow:0 10px 16px rgba(15,23,42,.08); }
        .massa-disc-btn.active{ background: var(--primary); color:#fff; border-color: transparent; }
        .massa-subtitle{ color:#64748b; margin:0 0 8px 0; font-size:0.9rem; }
        .massa-table-wrap{ overflow:auto; border-radius:14px; }
        #viewMassa:fullscreen{ background:var(--bg-body); padding:16px; }
        #viewMassa:fullscreen .massa-table-wrap{ max-height: calc(100vh - 190px); }
        #viewMassa:fullscreen table.tabela-dados{ min-width: 980px; }
        .btn-massa-fs{
            background:#0f172a;
            color:#fff;
            border:none;
            padding:8px 10px;
            border-radius:12px;
            cursor:pointer;
            display:flex;
            gap:8px;
            align-items:center;
            font-weight:800;
            font-size:12px;
            user-select:none;
        }
        .btn-massa-fs:hover{ opacity:.92; }
        .btn-salvar-massa-inline{
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color:white;
            border:none;
            padding:9px 12px;
            border-radius:12px;
            cursor:pointer;
            display:none;
            align-items:center;
            gap:8px;
            font-weight:900;
            font-size:12px;
            user-select:none;
        }
        .btn-salvar-massa-inline:hover{ opacity:.92; }

        /* ===== MASSA V18: Enhanced Mass Editor ===== */
        .massa-unsaved-bar{display:none;align-items:center;gap:8px;padding:8px 14px;background:#fef3c7;border:1px solid #fde68a;border-radius:10px;font-size:.78rem;font-weight:600;color:#92400e;margin-bottom:8px;animation:massaPulse 2s infinite;}
        .massa-unsaved-bar.visible{display:flex;}
        @keyframes massaPulse{0%,100%{opacity:1;}50%{opacity:.8;}}
        .massa-unsaved-bar i{font-size:.9rem;}
        .massa-unsaved-bar .massa-auto-save-hint{margin-left:auto;font-size:.68rem;color:#b45309;font-weight:400;}

        .massa-search-wrap{position:relative;margin-bottom:8px;max-width:350px;}
        .massa-search-wrap input{width:100%;padding:7px 12px 7px 32px;border:1px solid var(--border-color);border-radius:8px;font-size:.82rem;background:var(--card-bg);color:var(--text-color);}
        .massa-search-wrap i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:.78rem;}

        .massa-progress{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:.78rem;color:#64748b;}
        .massa-progress-bar{flex:0 0 120px;height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden;}
        .massa-progress-bar>div{height:100%;border-radius:3px;transition:width .3s;}

        .massa-stats-row{display:flex;gap:2px;}
        .massa-stats-row th{position:relative;}
        .massa-col-stat{font-size:.58rem;color:#94a3b8;font-weight:400;display:block;line-height:1.1;margin-top:2px;}
        .massa-col-actions{display:flex;gap:2px;justify-content:center;margin-top:3px;}
        .massa-col-btn{border:none;background:rgba(37,99,235,.08);color:var(--primary);border-radius:4px;padding:1px 5px;font-size:.58rem;cursor:pointer;font-weight:600;}
        .massa-col-btn:hover{background:rgba(37,99,235,.16);}

        .nota-input-massa.massa-empty{background:rgba(250,204,21,.08);border-color:#fde68a;}
        .nota-input-massa.massa-modified{box-shadow:0 0 0 2px rgba(37,99,235,.25);}
        .nota-input-massa.massa-just-saved{animation:massaSavedFlash .5s ease-out;}
        @keyframes massaSavedFlash{0%{box-shadow:0 0 0 3px rgba(22,163,74,.4);}100%{box-shadow:none;}}

        .massa-sort-icon{cursor:pointer;margin-left:3px;font-size:.6rem;color:#94a3b8;vertical-align:middle;}
        .massa-sort-icon:hover{color:var(--primary);}

        

        /* Ajuste do layout de nomes na Edição em Massa */
        #viewMassa table.tabela-dados th:nth-child(2),
        #viewMassa table.tabela-dados td:nth-child(2){
          min-width: 260px;
          max-width: 360px;
        }
        #viewMassa table.tabela-dados td:nth-child(2){
          white-space: normal;
          word-break: normal;
          overflow-wrap: break-word;
          line-height: 1.25;
        }
        #viewMassa .massa-nome{
          font-weight: 400;
          font-size: .88rem;
        }
.massa-fill-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100000;display:flex;align-items:center;justify-content:center;}
        .massa-fill-box{background:var(--card-bg);border-radius:14px;padding:20px 24px;max-width:360px;width:90%;box-shadow:0 16px 48px rgba(0,0,0,.2);}
        .massa-fill-box h3{margin:0 0 12px;}
        .massa-fill-box input{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;text-align:center;font-weight:700;margin-bottom:12px;}
        .massa-fill-box .btn-row{display:flex;gap:8px;justify-content:flex-end;}

        .massa-import-zone{border:2px dashed var(--border-color);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:10px;font-size:.82rem;color:#64748b;}
        .massa-import-zone:hover{border-color:var(--primary);background:rgba(37,99,235,.03);}
        .massa-import-zone.dragover{border-color:var(--primary);background:rgba(37,99,235,.08);}

        .massa-toolbar-extra{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
        .massa-tool-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border:1px solid var(--border-color);border-radius:8px;background:var(--card-bg);color:var(--text-color);font-size:.75rem;font-weight:600;cursor:pointer;transition:.15s;}
        .massa-tool-btn:hover{border-color:var(--primary);color:var(--primary);}
        .massa-tool-btn i{font-size:.72rem;}

        /* ===== ENTREGAS: Status Badges ===== */
        .entrega-select{
          padding:5px 10px; border-radius:20px; border:2px solid transparent;
          font-size:.78rem; font-weight:700; cursor:pointer; outline:none;
          transition:all .2s; -webkit-appearance:none; appearance:none;
          background-repeat:no-repeat; background-position:right 8px center; background-size:10px;
          background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2364748b' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
          padding-right:24px;
        }
        .entrega-select.st-entregue{ background-color:#dcfce7; color:#166534; border-color:#bbf7d0; }
        .entrega-select.st-rascunho{ background-color:#e0f2fe; color:#0369a1; border-color:#bae6fd; }
        .entrega-select.st-revisao{ background-color:#ffedd5; color:#c2410c; border-color:#fed7aa; }
        .entrega-select.st-pendente{ background-color:#f1f5f9; color:#64748b; border-color:#e2e8f0; }
        .entrega-badge{
          display:inline-flex; align-items:center; gap:4px;
          padding:3px 10px; border-radius:20px; font-size:.74rem; font-weight:700;
        }
        .entrega-badge.st-entregue{ background:#dcfce7; color:#166534; }
        .entrega-badge.st-rascunho{ background:#e0f2fe; color:#0369a1; }
        .entrega-badge.st-revisao{ background:#ffedd5; color:#c2410c; }
        .entrega-badge.st-pendente{ background:#f1f5f9; color:#64748b; }
        .entrega-badge .fa-circle{ font-size:.5rem; }
        .entrega-auto-tag{
          display:inline-flex; align-items:center; gap:3px;
          font-size:.62rem; color:#16a34a; font-weight:600; margin-left:4px; opacity:.8;
        }
/* BLITZ BUTTONS */
        .blitz-controls { display: flex; gap: 5px; align-items: center; }
        .btn-blitz { width: 25px; height: 25px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; transition: 0.2s; }
        .btn-blitz.plus { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } .btn-blitz.plus:hover { background: #86efac; }
        .btn-blitz.minus { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } .btn-blitz.minus:hover { background: #fca5a5; }

        /* DASHBOARD, MAPA, AULAS, CALENDARIO */
        .dash-container { display: none; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .dash-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }

        .dash-card.wide { grid-column: 1 / -1; }
        .dash-chart-box { height: 260px; }
        .dash-chart-box canvas { width: 100% !important; height: 100% !important; }
        /* CORREÇÃO (PROVAS/ATIVIDADES) */
        .correcao-container{ display:none; flex-direction:column; gap:16px; }
        .correcao-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap; }
        .correcao-head .sub{ color: var(--text-muted); font-size: .9rem; }
        .correcao-head-controls{ display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap; }
        .cor-prova-row{ display:flex; align-items:center; gap:6px; }
        .cor-prova-row select.inp{ flex:1; min-width:220px; }
        @media (max-width: 520px){ .cor-prova-row select.inp{ min-width:160px; } }
        .mini-label{ display:flex; flex-direction:column; gap:4px; font-size:0.75rem; color: var(--text-muted); }
        .correcao-grid{ display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; }
        .correcao-grid .card{ background: var(--card-bg); border:1px solid var(--border-color); border-radius:12px; padding:16px; box-shadow: 0 2px 5px rgba(0,0,0,0.04); }
        .correcao-grid .card.wide{ grid-column: 1 / -1; }
        .card-top h3{ margin:0; color: var(--text-main); }
        .card-top .hint{ margin-top:6px; color: var(--text-muted); font-size:.85rem; }

        .cor-table-wrap{ overflow:auto; max-height: 55vh; padding-right: 6px; }
        .cor-table td{ vertical-align: middle; }
        .cor-qnum{ font-weight: 900; }
        .cor-sel{ width:110px; }

        .cor-aluno-controls{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-top:10px; }
        .cor-acertos{ padding:10px 12px; border:1px solid var(--border-color); border-radius:12px; background: rgba(14,165,233,.08); color: var(--text-main); display:flex; gap:8px; align-items:center; }
        body.dark-mode .cor-acertos{ background: rgba(14,165,233,.14); }
        .cor-nota-final{ padding:10px 14px; border-radius:12px; display:flex; gap:8px; align-items:center; font-weight:700; border:2px solid var(--border-color); transition: all .25s; }
        .cor-nota-final .cor-nota-val{ font-size:1.35rem; font-weight:900; }
        .cor-nota-final.farol-v{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.55); }
        .cor-nota-final.farol-v .cor-nota-val{ color: var(--farol-verde); }
        .cor-nota-final.farol-a{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.55); }
        .cor-nota-final.farol-a .cor-nota-val{ color: var(--farol-amarelo); }
        .cor-nota-final.farol-r{ background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.50); }
        .cor-nota-final.farol-r .cor-nota-val{ color: var(--farol-vermelho); }
        body.dark-mode .cor-nota-final.farol-v{ background: rgba(22,163,74,.18); }
        body.dark-mode .cor-nota-final.farol-a{ background: rgba(245,158,11,.18); }
        body.dark-mode .cor-nota-final.farol-r{ background: rgba(220,38,38,.16); }
        .cor-disc-badge{ display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:999px; font-size:.72rem; font-weight:600; background: rgba(147,51,234,.10); border:1px solid rgba(147,51,234,.30); color:#7c3aed; white-space:nowrap; }
        body.dark-mode .cor-disc-badge{ background: rgba(147,51,234,.18); color:#c4b5fd; border-color: rgba(147,51,234,.40); }
        .cor-disc-badge i{ font-size:.68rem; }
        .cor-sync-info{ font-size:.72rem; color: var(--text-muted); display:flex; align-items:center; gap:5px; padding:2px 0; }
        .cor-sync-info i{ color:#7c3aed; }
        .cor-head-actions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
        @media print {
          body *{ visibility: hidden; }
          #corPrintArea, #corPrintArea *{ visibility: visible; }
          #corPrintArea{ position:absolute; left:0; top:0; width:100%; padding:10px; }
          #corPrintArea table{ width:100%; border-collapse:collapse; font-size:11px; }
          #corPrintArea th, #corPrintArea td{ border:1px solid #333; padding:4px 6px; text-align:center; }
          #corPrintArea th{ background:#ddd !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
          #corPrintArea .print-title{ font-size:16px; font-weight:bold; margin-bottom:8px; }
          #corPrintArea .print-sub{ font-size:11px; color:#555; margin-bottom:12px; }
          #corPrintArea .nota-verde{ background:#dcfce7 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
          #corPrintArea .nota-amarela{ background:#fef9c3 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
          #corPrintArea .nota-vermelha{ background:#fee2e2 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
        }

        .cor-respostas{ display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin-top:12px; }
        @media (max-width: 980px){ .correcao-grid{ grid-template-columns: 1fr; } .cor-respostas{ grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } }
        .cor-resp-card{ border:1px solid var(--border-color); border-radius:12px; padding:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; background: rgba(2,6,23,0.02); overflow:hidden; min-width:0; }
        body.dark-mode .cor-resp-card{ background: rgba(255,255,255,0.04); }
        .cor-resp-card .qn{ width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:900; background: rgba(100,116,139,.15); color: var(--text-main); }
        .cor-resp-input{ width:64px; flex:0 0 64px; padding:10px; border-radius:10px; border:1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); text-align:center; font-weight:900; text-transform:uppercase; }
        .cor-resp-input.ok{ background: rgba(22,163,74,.15); border-color: rgba(22,163,74,.55); }
        .cor-resp-input.no{ background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.55); }
        .cor-resp-input.na{ background: rgba(100,116,139,.08); }
        .cor-resp-meta{ flex:1 1 100%; min-width:0; }
        .cor-resp-meta > div{ font-size:.72rem; color: var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        body.dark-mode .cor-resp-input.ok{ background: rgba(22,163,74,.20); }
        body.dark-mode .cor-resp-input.no{ background: rgba(220,38,38,.18); }
        body.dark-mode .cor-resp-input.na{ background: rgba(148,163,184,.10); }

        .cor-legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
        .cor-legend .leg{ padding:6px 10px; border-radius:999px; font-size:.75rem; border:1px solid var(--border-color); }
        .cor-legend .leg.ok{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.4); }
        .cor-legend .leg.no{ background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.35); }
        .cor-legend .leg.na{ background: rgba(100,116,139,.08); }

        .cor-stats-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
        @media (max-width: 980px){ .cor-stats-grid{ grid-template-columns: 1fr; } }
        .cor-chart-box{ height: 240px; }
        .cor-chart-box canvas{ width:100% !important; height:100% !important; }

        /* Dashboard: Comparar Turmas */
        .dash-compare-controls{ display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap; }
        .dash-compare-controls label{ display:flex; flex-direction:column; gap:4px; font-size:0.75rem; color:#64748b; }
        .dash-compare-controls select{
            padding:8px 10px; border-radius:10px; border:1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-main);
        }
        #cmpTurmasTable tbody tr:hover{ background: rgba(2,6,23,0.04); }
        .cmp-bar{ display:flex; width:220px; height:10px; border-radius:999px; overflow:hidden; background:#e2e8f0; }
        .cmp-bar > span{ height:100%; }
.cmp-bar.cmp-bins{ height:8px; width:220px; background:#e2e8f0; }
.cmp-bar.cmp-bins > span{ height:100%; }
.cmp-bar.cmp-bins > span:nth-child(1){ background: var(--farol-vermelho); }
.cmp-bar.cmp-bins > span:nth-child(2){ background: #f97316; }
.cmp-bar.cmp-bins > span:nth-child(3){ background: var(--farol-amarelo); }
.cmp-bar.cmp-bins > span:nth-child(4){ background: #84cc16; }
.cmp-bar.cmp-bins > span:nth-child(5){ background: var(--farol-verde); }
.cmp-mini-meta{ font-size:0.78rem; color:#64748b; line-height:1.25; }
.cmp-mini-meta .cmp-k{ font-weight:600; color: var(--text-main); }
        .cmp-badge{ font-size:0.72rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border-color); color: var(--text-main); background: var(--card-bg); }

        .big-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .bar-row { margin-bottom: 15px; } .bar-bg { width: 100%; background: #f1f5f9; height: 12px; border-radius: 6px; overflow: hidden; } .bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s; }
        .mapa-container { display: none; gap: 20px; height: calc(100vh - 180px); }
        .mapa-container.act-fullscreen{ height: 100vh !important; max-height: 100vh !important; }
        .mapa-container.act-fullscreen .mapa-livres{ height: 100%; }
        .mapa-container.act-fullscreen .sala-grid-wrap{ height: 100%; max-height: 100%; }
        /* Fallback (se o navegador não suportar Fullscreen API) */
        body.mapa-fs-fallback #viewMapa{ position:fixed; inset:0; z-index:9999; background: var(--bg-body); padding:12px; box-sizing:border-box; display:flex !important; }

        .mapa-livres { width: 280px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden;}
        .mapa-livres-header { background: #f8fafc; padding: 15px; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--text-main);}
        .lista-livres { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; background: var(--bg-body); }
        .sala-grid-wrap { flex: 1; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; min-width: 0;}
        .sala-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; width: 100%; max-width: 900px; flex-shrink: 0; }
        /* Mesa do Professor (decorativa) — abaixo do grid (sem sobrepor carteiras) */
        .sala-grid-wrap{
            --mesa-prof-w: 220px;
            --mesa-prof-h: 64px;
        }
        @media (max-width: 720px){
            .sala-grid-wrap{
                --mesa-prof-w: 180px;
                --mesa-prof-h: 56px;
            }
        }
        .mesa-prof-row{
            width: 100%;
            max-width: 900px;
            margin-top: 18px;
            display: flex;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        .mesa-prof{
            width: var(--mesa-prof-w);
            max-width: 100%;
            min-height: var(--mesa-prof-h);
            border:2px solid var(--border-color);
            border-radius:12px;
            background: var(--bg-body);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            font-weight:800;
            font-size:.78rem;
            color: var(--text-main);
            box-shadow: 0 10px 18px rgba(0,0,0,.08);
            opacity:.96;
            pointer-events:none;
            user-select:none;
            box-sizing:border-box;
            padding: 10px 12px;
        }
        .mesa-prof i{ font-size:1.05rem; opacity:.9; }
        .mesa-prof span{ padding:2px 10px; border-radius:999px; border:1px dashed var(--border-color); }



        .mesa { background: #f1f5f9; border: 2px dashed #cbd5e1; height: 70px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 5px; transition: 0.2s; position: relative;}
        .aluno-drag.mobile-selected { border: 3px solid var(--inclusao) !important; transform: scale(1.05); box-shadow: 0 0 10px rgba(147, 51, 234, 0.5); }
        .mesa.mobile-target { background: #dcfce7; border-color: #16a34a; cursor: pointer; animation: pulseMesa 1s infinite; }
        @keyframes pulseMesa { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .aluno-drag { background: white; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 0.8rem; font-weight: bold; text-align: center; cursor: grab; border-left: 5px solid #cbd5e1; user-select: none; padding: 4px; overflow: hidden; color: #334155; }
        .aulas-container { display: none; flex-direction: column; gap: 20px; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .progress-container { width: 100%; background: #e2e8f0; border-radius: 10px; height: 24px; overflow: hidden; position: relative;}
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 2px; font-size: 0.85rem; font-weight: bold; color: #1e293b; mix-blend-mode: color-burn; }
        .aula-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border-color); transition: 0.2s; color: var(--text-main); }
        .aula-tema { flex: 1; font-weight: 600; font-size: 1.05rem; }
        .aula-tema.concluida { text-decoration: line-through; color: #94a3b8; }
        .aula-data { border: 1px solid #cbd5e1; padding: 6px 10px; border-radius: 6px; font-size: 0.9rem; color: #475569; outline: none; background: var(--input-bg); }
        .add-aula-panel { display: flex; gap: 10px; background: var(--bg-body); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); flex-wrap: wrap; }
        .calendar-container { display: none; flex-direction: column; height: calc(100vh - 180px); background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-nav-btn { background: #f1f5f9; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #475569; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; flex: 1; overflow-y: auto;}
        .cal-day { border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px; min-height: 100px; position: relative; background: #f8fafc; display: flex; flex-direction: column; gap: 2px; cursor: pointer; transition: 0.2s;}
        .cal-day:hover { background: #f1f5f9; border-color: var(--primary); }
        .cal-number { font-weight: bold; color: #334155; display: block; margin-bottom: 5px; }
        .cal-today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-event { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; color: white; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; opacity: 0.9; transition: 0.2s;}
        .cal-event:hover { opacity: 1; transform: scale(1.02); }
        .evt-aula { background-color: #3b82f6; }
        .evt-prova { background-color: #dc2626; }
        .evt-atividade { background-color: #9333ea; }
        .evt-planner { background-color: #f59e0b; }
        .evt-planner.done { background-color: #94a3b8; text-decoration: line-through; opacity:.7; }
        .evt-freq { background-color: #0d9488; font-size: .6rem !important; }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-box { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s ease-out; color: var(--text-main); }
        .modal-xl { width: 900px; max-width: 95%; height: 90vh; display: flex; flex-direction: column; padding: 0; }
        .modal-header-xl { padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body-xl { padding: 2rem; overflow-y: auto; flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .modal-footer-xl { padding: 1rem 2rem; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 1rem; } .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; } 
        .inp { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; background: var(--input-bg); color: var(--text-main); }
        
        .tabs-header { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        .tabela-fixa { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .tabela-fixa th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border-color); font-size: 0.85rem; color: #64748b; background: var(--bg-body); }
        .tabela-fixa td { padding: 10px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .nota-input { width: 70px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; font-weight: bold; background: var(--input-bg); color: var(--text-main); }

        /* FAROL (cores) nas notas (inputs) + trava de 0..10 */
        .nota-input.farol-verde, .nota-input-massa.farol-verde { border-left: 6px solid var(--farol-verde) !important; }
        .nota-input.farol-amarelo, .nota-input-massa.farol-amarelo { border-left: 6px solid var(--farol-amarelo) !important; }
        .nota-input.farol-vermelho, .nota-input-massa.farol-vermelho { border-left: 6px solid var(--farol-vermelho) !important; }

        /* Config (Disciplinas/Avaliações): rolagem para não "prender" edição */
        #modalConfig .modal-box { max-height: 90vh; overflow-y: auto; }
        #cfgDisciplinasList { max-height: 55vh; overflow-y: auto; padding-right: 6px; }
        
        /* Atividades/Games: modal maior + rolagem apenas no corpo (evita sobreposições no modo professor) */
        #modalAtividades .modal-box.modal-xl{ overflow: visible; width: 1100px; max-width: 98%; height: 94vh; }
        #modalAtividades .act-headbar{ flex-wrap: wrap; align-items: flex-start; }
        #modalAtividades .act-body{ overflow-y: auto; }

        /* Atividades/Games: Sorteador de alunos (usa a turma selecionada no menu) */
        #modalAtividades .act-sorteador{ display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border-color); border-radius:12px; background: rgba(15,23,42,.03); min-width: 260px; }
        body.dark-mode #modalAtividades .act-sorteador{ background: rgba(255,255,255,.05); }
        #modalAtividades .act-sorteio-out{ min-width: 180px; max-width: 360px; padding:8px 10px; border-radius:10px; border:1px dashed rgba(100,116,139,.6); font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; user-select:none; }
        #modalAtividades .act-sorteio-out.has-name{ border-style:solid; border-color: rgba(14,165,233,.55); background: rgba(14,165,233,.10); }
        #modalAtividades .act-sorteio-meta{ font-size:.72rem; color: var(--text-muted,#64748b); white-space:nowrap; }
        @media (max-width: 980px){
          #modalAtividades .act-sorteador{ width:100%; justify-content:space-between; }
          #modalAtividades .act-sorteio-out{ max-width: 240px; }
        }

        /* Gráficos (Chart.js) */
        #chartEvolucao { display: block; }
        #chartEvolucao canvas { width: 100% !important; height: 100% !important; }
        .farol-box-modal { text-align: right; background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .chart-wrap { display: flex; justify-content: space-around; align-items: flex-end; height: 200px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 20px; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 40px; height: 100%; justify-content: flex-end; position: relative; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s; position: relative; }
        .chart-bar:hover::after { content: attr(data-val); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        .col-lp .chart-bar { background: var(--primary); } .col-red .chart-bar { background: #ec4899; }

        .timeline-container { background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-top: 10px; }
        .occ-list { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; }
        .occ-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; border-left: 4px solid #94a3b8; }
                .occ-del { position:absolute; right:8px; top:8px; width:22px; height:22px; border:none; border-radius:6px; background:transparent; cursor:pointer; color:#94a3b8; font-size:1.1rem; line-height:1; }
        .occ-del:hover { color:#ef4444; background: rgba(239,68,68,0.08); }
.report-text { width: 100%; height: 100px; margin-top: 10px; padding: 10px; border: 1px solid #fcd34d; border-radius: 6px; resize: none; background: #fefce8; color: #451a03; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--inclusao); }
        input:checked + .slider:before { transform: translateX(26px); }
        #winnerName { font-size: 3rem; font-weight: 800; color: var(--primary); text-align: center; margin: 30px 0; animation: popIn 0.5s; }
        
        /* TIMER */
        #timerDisplay { font-size: 6rem; font-weight: 800; text-align: center; color: var(--text-main); font-variant-numeric: tabular-nums; line-height: 1; margin: 20px 0; }
        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .timer-presets { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

        /* TAGS PARA PARECER */
        .tags-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .tag-chip { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; user-select: none; }
        .tag-chip:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .tag-chip.negative:hover { background: #ef4444; border-color: #ef4444; }

        /* BNCC BADGE */
        .badge-bncc { font-size: 0.75rem; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; border: 1px solid #bae6fd; margin-right: 5px; font-family: monospace; display: inline-block;}

        

        /* BLOOM BADGE */
        .badge-bloom { font-size: 0.75rem; background: rgba(147,51,234,0.12); color: var(--inclusao); padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(147,51,234,0.25); margin-right: 5px; display: inline-block; }
.mapa-controls { display:flex; gap:5px; padding:10px; border-bottom:1px solid var(--border-color); background:var(--card-bg); justify-content: center; align-items: center;}
        .mapa-controls select { padding: 5px; border-radius: 4px; border: 1px solid #cbd5e1; }
        
        /* TOAST NOTIFICATIONS */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10000; pointer-events: none; }
        .toast { pointer-events: auto; background: white; border-left: 5px solid var(--primary); padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideInRight 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast.success { border-left-color: var(--farol-verde); }
        .toast.error { border-left-color: var(--farol-vermelho); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* GROUP GENERATOR */
        .group-result { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .group-card { background: #f1f5f9; padding: 10px; border-radius: 6px; border-left: 4px solid var(--primary); border-top:1px solid #cbd5e1;border-right:1px solid #cbd5e1;border-bottom:1px solid #cbd5e1; }
        .group-title { font-weight: bold; color: var(--primary); margin-bottom: 5px; border-bottom: 1px solid #cbd5e1; padding-bottom: 3px; display:flex; justify-content:space-between; align-items:center; }
        .group-member { font-size: 0.9rem; margin-bottom: 2px; padding:2px 0; }
        .group-member .gm-badge{font-size:.65rem;padding:1px 5px;border-radius:3px;margin-left:4px;}
        .group-member .gm-fixed{background:#ede9fe;color:#7c3aed;}

        /* Sorteador enhanced */
        .sort-slot{height:80px;overflow:hidden;border:2px solid var(--border-color);border-radius:12px;margin:12px auto;max-width:350px;position:relative;background:var(--card-bg);}
        .sort-reel{transition:transform 0.1s linear;display:flex;flex-direction:column;align-items:center;}
        .sort-reel .sort-name{height:80px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;color:var(--primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;padding:0 10px;}
        .sort-slot::before,.sort-slot::after{content:'';position:absolute;left:0;right:0;height:20px;z-index:2;pointer-events:none;}
        .sort-slot::before{top:0;background:linear-gradient(to bottom,var(--card-bg),transparent);}
        .sort-slot::after{bottom:0;background:linear-gradient(to top,var(--card-bg),transparent);}
        .sort-opt{font-size:.82rem;display:inline-flex;align-items:center;gap:3px;cursor:pointer;padding:3px 8px;border:1px solid var(--border-color);border-radius:6px;}
        .sort-opt:has(input:checked){background:#eff6ff;border-color:#3b82f6;}
        .sort-history{font-size:.75rem;color:#64748b;max-height:60px;overflow-y:auto;margin:8px 0;text-align:left;padding:0 10px;}
        .sort-winner{animation:sortPop .5s ease-out;}
        @keyframes sortPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
        .sort-confetti{position:absolute;pointer-events:none;z-index:10;}

        /* Mapa enhanced */
        .mesa.disabled{background:#1e293b22!important;border-color:#475569!important;opacity:.3;pointer-events:none;}
        .mesa.disabled::after{content:'✕';position:absolute;font-size:1.2rem;color:#94a3b8;}
        .mesa.swap-target{border-color:#f59e0b!important;border-style:solid!important;cursor:pointer!important;}
        .aluno-drag .mesa-badges{position:absolute;top:1px;right:2px;display:flex;gap:1px;font-size:.55rem;}
        .aluno-drag .mb-paee{color:#9333ea;} .aluno-drag .mb-risk{color:#dc2626;} .aluno-drag .mb-beh{color:#f59e0b;}
        .mesa-tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:6px 10px;border-radius:6px;font-size:.7rem;white-space:nowrap;z-index:100;pointer-events:none;opacity:0;transition:.2s;}
        .mesa:hover .mesa-tooltip,.aluno-drag:hover .mesa-tooltip{opacity:1;}

        /* Group colors */
        .grp-color-0{border-left-color:#dc2626!important;} .grp-color-1{border-left-color:#2563eb!important;} .grp-color-2{border-left-color:#16a34a!important;} .grp-color-3{border-left-color:#f59e0b!important;}
        .grp-color-4{border-left-color:#7c3aed!important;} .grp-color-5{border-left-color:#ec4899!important;} .grp-color-6{border-left-color:#0d9488!important;} .grp-color-7{border-left-color:#ea580c!important;}
        @media print{.group-result{max-height:none!important;overflow:visible!important;} .group-card{break-inside:avoid;} .modal-overlay{position:static!important;background:none!important;} .modal-box{box-shadow:none!important;max-height:none!important;overflow:visible!important;width:100%!important;}}

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .btn-tool, .btn-primary, .btn-view, .btn-bim, .tab-btn { min-height: 44px; padding: 12px; }
            .grid-alunos { grid-template-columns: 1fr; }
            .modal-body-xl { grid-template-columns: 1fr; }
            .mapa-container { flex-direction: column; height: auto; }
            .mapa-livres { width: 100%; height: 150px; }
            .sala-grid { grid-template-columns: repeat(4, 1fr); }
            .add-aula-panel input { width: 100% !important; margin-bottom: 5px; }
            .add-aula-panel select { width: 100% !important; margin-bottom: 5px; }
        }

        /* IMPRESSÃO */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 20px; color: black; }
            .print-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
            .print-logo { font-size: 2rem; font-weight: bold; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; }
            .print-footer { margin-top: 50px; display: flex; justify-content: space-between; }
            .print-sign { border-top: 1px solid #000; width: 40%; text-align: center; padding-top: 5px; }
        }

        .copy-area { width: 100%; height: 300px; padding: 10px; border: 1px solid #cbd5e1; background: #f8fafc; font-family: monospace; white-space: pre; overflow: auto; }
        
        /* ANIMAÇÕES */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card-aluno {
            opacity: 0;
            transform: translateY(16px);
        }
        .card-aluno.card-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .card-aluno.card-visible:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -4px rgba(0,0,0,0.1), 0 8px 16px -4px rgba(0,0,0,0.06);
            border-color: var(--primary);
        }
        
        .top-bar {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* ESTADO VAZIO MELHORADO */
        .empty-state {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-body) 100%);
            border-radius: 16px;
            border: 2px dashed var(--border-color);
            animation: fadeIn 0.5s ease-out;
        }
        
        /* MOBILE RESPONSIVE APRIMORADO */
        @media (max-width: 1024px) {
            .controls-section {
                flex-wrap: wrap;
            }
            .control-group {
                flex: 1 1 auto;
                min-width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
            .top-bar {
                padding: 20px;
                gap: 15px;
            }
            .top-row {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            .title-area h1 {
                font-size: 1.5rem;
            }
            .bimestre-selector {
                width: 100%;
                grid-template-columns: repeat(4, 1fr);
                display: grid;
            }
            .btn-bim {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
            .controls-section {
                flex-direction: column;
                gap: 10px;
            }
            .control-group, .tools-group, .filters-group {
                width: 100%;
                justify-content: center;
            }
            .control-label {
                display: none;
            }
            .view-toggle {
                grid-template-columns: repeat(2, 1fr);
                width: 100%;
            }
            .btn-view {
                padding: 12px;
            }
            .tools-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                width: 100%;
            }
            .filters-group {
                flex-direction: column;
                gap: 8px;
            }
            .btn-inclusao, .btn-risco {
                width: 100%;
                justify-content: center;
            }
            .btn-primary {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
            }
            .grid-alunos { 
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .card-aluno {
                padding: 1.25rem;
            }
            .search-bar {
                padding: 14px 45px 14px 45px;
            }
        }
        
        @media (max-width: 480px) {
            .title-area h1 {
                font-size: 1.25rem;
            }
            .btn-bim {
                font-size: 0.7rem;
                padding: 10px 6px;
            }
            .btn-bim i {
                display: none;
            }
            .aluno-nome {
                font-size: 1.1rem;
            }
            .farol-badge {
                font-size: 1.1rem;
            }
        }
    
/* --- Ocorrências: botão moderno (isolado) --- */
.add-occ-box{display:flex;gap:10px;align-items:flex-start}
.occ-input{flex:1;resize:none;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-main);border-radius:10px;padding:10px 12px;line-height:1.25;min-height:40px;box-shadow:0 1px 2px rgba(15,23,42,.06) inset}
.occ-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(15,23,42,.12)}
.btn-occ{width:40px;height:40px;border:none;border-radius:12px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 14px rgba(15,23,42,.18);transition:transform .08s ease,box-shadow .2s ease,filter .2s ease}
.btn-occ:hover{filter:brightness(1.03);box-shadow:0 8px 18px rgba(15,23,42,.22)}
.btn-occ:active{transform:translateY(1px) scale(.98);box-shadow:0 4px 10px rgba(15,23,42,.16)}
.btn-occ:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(15,23,42,.16),0 8px 18px rgba(15,23,42,.22)}
.btn-occ i{font-size:14px}
/* --- fim --- */

/* ==========================
   RANKING VIEW
   ========================== */
.ranking-container {
    display:none; flex-direction:column; gap:0;
    background:var(--card-bg); border-radius:16px;
    border:1px solid var(--border-color);
    overflow:hidden;
    box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
    max-height:calc(100vh - 200px);
}
.ranking-header-bar {
    padding:20px 24px 16px;
    background:linear-gradient(135deg, var(--card-bg) 0%, var(--bg-body) 100%);
    border-bottom:1px solid var(--border-color);
    flex-shrink:0;
    position:sticky; top:0; z-index:2;
}
.ranking-scroll-body {
    flex:1; overflow-y:auto; overflow-x:hidden;
    scroll-behavior:smooth;
    -webkit-overflow-scrolling:touch;
}
/* Custom scrollbar */
.ranking-scroll-body::-webkit-scrollbar { width:6px; }
.ranking-scroll-body::-webkit-scrollbar-track { background:transparent; }
.ranking-scroll-body::-webkit-scrollbar-thumb { background:var(--border-color); border-radius:3px; }
.ranking-scroll-body::-webkit-scrollbar-thumb:hover { background:var(--text-muted); }

/* Ranking — rolagem na tela principal + tela cheia */
body.ranking-view:not(.ranking-is-fullscreen) #viewRanking{
  max-height:none;
  overflow:visible;
}
body.ranking-view:not(.ranking-is-fullscreen) #viewRanking .ranking-scroll-body{
  overflow:visible;
  flex:0 0 auto;
}
body.ranking-is-fullscreen #viewRanking{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  max-height:none !important;
  border-radius:0 !important;
  margin:0 !important;
  z-index:10050;
}
body.ranking-is-fullscreen #viewRanking .ranking-scroll-body{
  overflow-y:auto;
  flex:1;
}
body.ranking-is-fullscreen main{ overflow:hidden !important; }

.ranking-title-row { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
.ranking-title { font-size:1.4rem; font-weight:900; color:var(--text-main); display:flex; align-items:center; gap:10px; }
.ranking-title i { color:#f59e0b; font-size:1.5rem; }
.ranking-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.ranking-select { width:auto; min-width:150px; padding:8px 12px; font-weight:700; font-size:0.85rem; }
.ranking-badges-row { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
.ranking-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; font-size:0.78rem; font-weight:700; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-main); }
.ranking-badge i { font-size:0.7rem; }
.ranking-badge.active { background:var(--primary); color:#fff; border-color:var(--primary); }

/* === PODIUM === */
.ranking-podium-section { padding:30px 24px 20px; display:flex; justify-content:center; align-items:flex-end; gap:0; min-height:280px; flex-shrink:0; }
.ranking-divider { height:1px; background:linear-gradient(90deg, transparent, var(--border-color), transparent); margin:0 24px; flex-shrink:0; position:relative; }
.ranking-scroll-hint {
    display:flex; align-items:center; justify-content:center; gap:8px;
    padding:8px 0; color:var(--text-muted); font-size:0.78rem; font-weight:600;
    flex-shrink:0; cursor:pointer; transition:color 0.2s;
}
.ranking-scroll-hint:hover { color:var(--primary); }
.ranking-scroll-hint i { animation:scrollHintPulse 1.5s ease-in-out infinite; }
@keyframes scrollHintPulse { 0%,100%{transform:translateY(0);opacity:0.5;} 50%{transform:translateY(4px);opacity:1;} }
.ranking-scroll-hint.hidden { display:none; }
.podium-slot { display:flex; flex-direction:column; align-items:center; position:relative; }
.podium-avatar {
    width:72px; height:72px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:1.6rem; font-weight:900; color:#fff;
    position:relative; z-index:2;
    box-shadow:0 8px 20px rgba(0,0,0,0.15);
    margin-bottom:-12px;
}
.podium-slot[data-pos="1"] .podium-avatar { width:88px; height:88px; font-size:2rem; margin-bottom:-16px; }

.podium-medal {
    position:absolute; top:-8px; right:-4px; z-index:3;
    width:28px; height:28px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:0.75rem; font-weight:900; color:#fff;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.podium-slot[data-pos="1"] .podium-medal { background:linear-gradient(135deg,#f59e0b,#d97706); width:32px; height:32px; font-size:0.85rem; }
.podium-slot[data-pos="2"] .podium-medal { background:linear-gradient(135deg,#94a3b8,#64748b); }
.podium-slot[data-pos="3"] .podium-medal { background:linear-gradient(135deg,#d97706,#a16207); }

.podium-name { font-weight:800; font-size:0.9rem; color:var(--text-main); text-align:center; margin-top:0; max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.podium-slot[data-pos="1"] .podium-name { font-size:1.05rem; max-width:140px; }
.podium-points { font-weight:900; font-size:1.1rem; color:var(--primary); }
.podium-slot[data-pos="1"] .podium-points { font-size:1.3rem; color:#f59e0b; }

.podium-base {
    width:130px; border-radius:12px 12px 0 0;
    display:flex; flex-direction:column; align-items:center;
    justify-content:flex-start; padding:20px 8px 12px;
    gap:4px; position:relative;
}
.podium-slot[data-pos="1"] .podium-base { width:150px; height:160px; background:linear-gradient(180deg,#fef3c7 0%,#fde68a 100%); border:2px solid #f59e0b; border-bottom:none; z-index:1; }
.podium-slot[data-pos="2"] .podium-base { width:130px; height:120px; background:linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 100%); border:2px solid #94a3b8; border-bottom:none; }
.podium-slot[data-pos="3"] .podium-base { width:130px; height:90px; background:linear-gradient(180deg,#fef3c7 0%,#fed7aa 100%); border:2px solid #d97706; border-bottom:none; }

body.dark-mode .podium-slot[data-pos="1"] .podium-base { background:linear-gradient(180deg,#422006 0%,#713f12 100%); border-color:#b45309; }
body.dark-mode .podium-slot[data-pos="2"] .podium-base { background:linear-gradient(180deg,#1e293b 0%,#334155 100%); border-color:#475569; }
body.dark-mode .podium-slot[data-pos="3"] .podium-base { background:linear-gradient(180deg,#451a03 0%,#7c2d12 100%); border-color:#9a3412; }

.podium-crown {
    position:absolute; top:-36px; left:50%; transform:translateX(-50%);
    font-size:1.8rem; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    animation:crownBounce 2s ease-in-out infinite;
}
@keyframes crownBounce { 0%,100%{transform:translateX(-50%) translateY(0);} 50%{transform:translateX(-50%) translateY(-6px);} }

.podium-empty { opacity:0.3; }
.podium-empty .podium-avatar { background:#cbd5e1 !important; }
.podium-empty .podium-name { color:var(--text-muted); }

/* === RANKING LIST === */
.ranking-list-section { padding:0 24px 24px; }
.rank-row-top3 { background: linear-gradient(90deg, rgba(251,191,36,0.06) 0%, transparent 100%); border-left: 3px solid #f59e0b; }
.ranking-list-header { display:grid; grid-template-columns:50px 1fr 100px 120px 60px; gap:12px; padding:10px 16px; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border-color); }

.rank-row {
    display:grid; grid-template-columns:50px 1fr 100px 120px 60px; gap:12px; align-items:center;
    padding:12px 16px; border-bottom:1px solid var(--border-color);
    transition:background 0.15s ease; border-radius:8px; margin:2px 0;
}
.rank-row:hover { background:rgba(37,99,235,0.04); }
body.dark-mode .rank-row:hover { background:rgba(96,165,250,0.08); }

.rank-pos { font-weight:900; font-size:1.1rem; color:var(--text-main); text-align:center; min-width:32px; }
.rank-pos-badge { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:50%; font-size:0.85rem; font-weight:900; }
.rank-pos-badge.gold { background:linear-gradient(135deg,#fef3c7,#fde68a); color:#92400e; border:2px solid #f59e0b; }
.rank-pos-badge.silver { background:linear-gradient(135deg,#f1f5f9,#e2e8f0); color:#475569; border:2px solid #94a3b8; }
.rank-pos-badge.bronze { background:linear-gradient(135deg,#fed7aa,#fde68a); color:#7c2d12; border:2px solid #d97706; }

.rank-student { display:flex; align-items:center; gap:10px; min-width:0; }
.rank-student-avatar { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.85rem; font-weight:800; color:#fff; flex-shrink:0; }
.rank-student-info { min-width:0; }
.rank-student-name { font-weight:700; font-size:0.95rem; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rank-student-turma { font-size:0.72rem; color:var(--text-muted); }

.rank-bar-wrap { position:relative; height:24px; background:var(--bg-body); border-radius:12px; overflow:hidden; border:1px solid var(--border-color); }
.rank-bar { height:100%; border-radius:12px; transition:width 0.6s cubic-bezier(0.16,1,0.3,1); min-width:4px; }
.rank-bar-label { position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:0.7rem; font-weight:700; color:var(--text-main); }

.rank-total { font-weight:900; font-size:1.1rem; color:var(--text-main); text-align:center; }



.rank-mini-btn{
    border:none;
    background:rgba(148,163,184,.18);
    cursor:pointer;
    font-size:0.78rem;
    line-height:1;
    padding:4px 8px;
    border-radius:10px;
    color:var(--text-main);
    transition:transform .08s ease, filter .15s ease;
}
.rank-mini-btn:hover{ filter:brightness(1.05); }
.rank-mini-btn:active{ transform:translateY(1px) scale(.98); }
.rank-mini-btn.minus{ background:rgba(239,68,68,.14); color:#b91c1c; }
.rank-mini-btn.plus{ background:rgba(34,197,94,.16); color:#15803d; }

.rank-add-btn {
    border:none; background:var(--primary); color:#fff; width:28px; height:28px;
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    cursor:pointer; font-size:0.75rem; transition:transform 0.12s ease, box-shadow 0.2s ease;
    box-shadow:0 2px 6px rgba(37,99,235,0.3);
}
.rank-add-btn:hover { transform:scale(1.15); box-shadow:0 4px 12px rgba(37,99,235,0.4); }

/* Modal pontos */
.rank-modal-body { display:flex; flex-direction:column; gap:12px; }
.rank-label { font-size:0.78rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:2px; }
.rank-pts-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.rank-pts-row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.rank-quick-btn {
    border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-main);
    padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:800; font-size:0.85rem;
    transition:all 0.12s ease;
}
.rank-quick-btn:hover { background:var(--primary); color:#fff; border-color:var(--primary); }
.rank-quick-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }

/* Confetti burst */
.confetti-burst { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99999; }
.confetti-piece {
    position:absolute; width:10px; height:10px; opacity:0;
    animation:confettiFall 1.5s ease-out forwards;
}
@keyframes confettiFall {
    0% { opacity:1; transform:translateY(0) rotate(0deg) scale(1); }
    100% { opacity:0; transform:translateY(100vh) rotate(720deg) scale(0.3); }
}

/* Empty ranking state */
.ranking-empty {
    text-align:center; padding:60px 20px; color:var(--text-muted);
}
.ranking-empty i { font-size:3.5rem; margin-bottom:16px; display:block; opacity:0.3; }
.ranking-empty p { font-size:1rem; margin:4px 0; }

/* Streak badge */
.rank-streak { display:inline-flex; align-items:center; gap:3px; font-size:0.68rem; font-weight:700; padding:2px 6px; border-radius:4px; background:#fef3c7; color:#92400e; }
body.dark-mode .rank-streak { background:#422006; color:#fde68a; }

/* === WEEKLY HISTORY === */
.rank-hist-modal .modal-box {
    width:900px; max-width:98vw; max-height:92vh; overflow:hidden; display:flex; flex-direction:column;
}
.rank-hist-header { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:16px; }
.rank-hist-header h3 { margin:0; color:var(--text-main); font-size:1.2rem; }
.rank-hist-config { display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px 16px; background:var(--bg-body); border-radius:10px; margin-bottom:16px; }
.rank-hist-config label { font-size:0.8rem; font-weight:700; color:var(--text-muted); display:flex; align-items:center; gap:6px; }
.rank-hist-config select, .rank-hist-config input[type="date"] { padding:6px 10px; border-radius:8px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-main); font-size:0.82rem; font-weight:600; }
.rank-hist-body { flex:1; overflow-y:auto; overflow-x:auto; -webkit-overflow-scrolling:touch; }
.rank-hist-body::-webkit-scrollbar { width:6px; height:6px; }
.rank-hist-body::-webkit-scrollbar-track { background:transparent; }
.rank-hist-body::-webkit-scrollbar-thumb { background:var(--border-color); border-radius:3px; }

.rank-hist-week-card { background:var(--card-bg); border:1px solid var(--border-color); border-radius:12px; margin-bottom:12px; overflow:hidden; transition:box-shadow 0.2s; }
.rank-hist-week-card:hover { box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.rank-hist-week-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; cursor:pointer; user-select:none; background:var(--bg-body); border-bottom:1px solid transparent; transition:background 0.2s; }
.rank-hist-week-header:hover { background:var(--border-color); }
.rank-hist-week-header.open { border-bottom-color:var(--border-color); }
.rank-hist-week-title { font-weight:800; font-size:0.92rem; color:var(--text-main); display:flex; align-items:center; gap:8px; }
.rank-hist-week-title i { color:var(--primary); font-size:0.8rem; transition:transform 0.2s; }
.rank-hist-week-header.open .rank-hist-week-title i.fa-chevron-right { transform:rotate(90deg); }
.rank-hist-week-meta { display:flex; gap:12px; align-items:center; font-size:0.78rem; color:var(--text-muted); font-weight:600; }
.rank-hist-week-meta span { display:inline-flex; align-items:center; gap:4px; }

.rank-hist-week-body { display:none; padding:0; }
.rank-hist-week-body.open { display:block; }

.rank-hist-table { width:100%; border-collapse:collapse; font-size:0.82rem; }
.rank-hist-table thead th { padding:8px 12px; text-align:left; font-size:0.72rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); background:var(--bg-body); border-bottom:1px solid var(--border-color); position:sticky; top:0; z-index:1; }
.rank-hist-table tbody td { padding:8px 12px; border-bottom:1px solid var(--border-color); color:var(--text-main); }
.rank-hist-table tbody tr:last-child td { border-bottom:none; }
.rank-hist-table tbody tr:hover { background:rgba(99,102,241,0.04); }
.rank-hist-table .hist-pos { font-weight:900; text-align:center; width:40px; color:var(--primary); }
.rank-hist-table .hist-pts { font-weight:900; text-align:center; min-width:50px; }
.rank-hist-table .hist-pts.positive { color:#16a34a; }
.rank-hist-table .hist-pts.negative { color:#dc2626; }
.rank-hist-table .hist-pts.zero { color:var(--text-muted); }
.rank-hist-table .hist-detail { font-size:0.7rem; color:var(--text-muted); display:flex; gap:6px; }
.rank-hist-table .hist-name { font-weight:600; }
.rank-hist-trend { display:inline-flex; align-items:center; gap:2px; font-size:0.72rem; font-weight:700; }
.rank-hist-trend.up { color:#16a34a; }
.rank-hist-trend.down { color:#dc2626; }
.rank-hist-trend.same { color:var(--text-muted); }

.rank-hist-empty { text-align:center; padding:40px 20px; color:var(--text-muted); }
.rank-hist-empty i { font-size:2.5rem; opacity:0.3; display:block; margin-bottom:12px; }

.rank-hist-summary { display:flex; gap:8px; flex-wrap:wrap; padding:12px 16px; }
.rank-hist-summary-card { flex:1; min-width:120px; padding:10px 14px; border-radius:10px; background:var(--bg-body); border:1px solid var(--border-color); text-align:center; }
.rank-hist-summary-card .val { font-size:1.3rem; font-weight:900; color:var(--primary); }
.rank-hist-summary-card .lbl { font-size:0.7rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; margin-top:2px; }

.rank-hist-tabs { display:flex; gap:4px; margin-bottom:12px; }
.rank-hist-tab { padding:6px 14px; border-radius:8px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-muted); font-size:0.8rem; font-weight:700; cursor:pointer; transition:all 0.2s; }
.rank-hist-tab:hover { border-color:var(--primary); color:var(--primary); }
.rank-hist-tab.active { background:var(--primary); color:#fff; border-color:var(--primary); }

@media(max-width:640px){
    .rank-hist-config { flex-direction:column; gap:8px; }
    .rank-hist-week-header { flex-direction:column; gap:6px; align-items:flex-start; }
    .rank-hist-table .hist-detail { display:none; }
    .rank-hist-table thead th:nth-child(4),
    .rank-hist-table tbody td:nth-child(4) { display:none; }
    .rank-hist-summary { flex-direction:column; }
}

/* Responsive ranking */
@media(max-width:768px){
    .ranking-container { max-height:calc(100vh - 160px); border-radius:12px; }
    .ranking-header-bar { padding:14px 16px 12px; }
    .ranking-podium-section { gap:0; padding:20px 12px 16px; min-height:220px; }
    .podium-base { width:100px !important; }
    .podium-slot[data-pos="1"] .podium-base { width:110px !important; height:130px !important; }
    .podium-slot[data-pos="2"] .podium-base { height:100px !important; }
    .podium-slot[data-pos="3"] .podium-base { height:75px !important; }
    .podium-avatar { width:56px !important; height:56px !important; font-size:1.2rem !important; }
    .podium-slot[data-pos="1"] .podium-avatar { width:68px !important; height:68px !important; }
    .podium-name { font-size:0.78rem !important; max-width:95px !important; }
    .podium-points { font-size:0.9rem !important; }
    .ranking-list-header, .rank-row { grid-template-columns:40px 1fr 80px 50px; }
    .ranking-list-header > :nth-child(4), .rank-row > :nth-child(4) { display:none; }
    .ranking-title { font-size:1.1rem; }
    .rank-pts-grid { grid-template-columns:1fr; }
    .ranking-scroll-body::-webkit-scrollbar { width:4px; }
}
@media(max-width:480px){
    .ranking-container { max-height:calc(100vh - 140px); }
    .ranking-podium-section { min-height:180px; padding:16px 8px 12px; }
    .ranking-list-header, .rank-row { grid-template-columns:32px 1fr 50px; }
    .ranking-list-header > :nth-child(3), .rank-row > :nth-child(3) { display:none; }
    .ranking-list-header > :nth-child(4), .rank-row > :nth-child(4) { display:none; }
    .podium-base { width:85px !important; }
    .podium-slot[data-pos="1"] .podium-base { width:95px !important; }
}

/* ==========================
   PLANNER (v1) — Modal
   ========================== */
.planner-headbar{
  padding: 12px 18px;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-body) 100%);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.planner-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.planner-tab{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-main);
  padding: 8px 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight:700;
  font-size:0.9rem;
  display:flex;
  align-items:center;
  gap:8px;
  transition: all .15s ease;
}
.planner-tab:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(15,23,42,.08); }
.planner-tab.active{
  background: rgba(37, 99, 235, 0.12);
  border-color: rgba(37, 99, 235, 0.35);
  color: var(--text-main);
}
.planner-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.btn-planner{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-main);
  padding: 8px 12px;
  border-radius: 10px;
  cursor:pointer;
  font-weight:700;
  font-size:0.9rem;
  display:flex;
  align-items:center;
  gap:8px;
  transition: all .15s ease;
}
.btn-planner:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(15,23,42,.08); }
.btn-planner.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }
.planner-body{
  padding: 18px;
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 18px;
  height: calc(90vh - 72px - 58px - 58px); /* modal-xl height - header - headbar - footer (aprox) */
  overflow:hidden;
}
@media (max-width: 980px){
  .planner-body{ grid-template-columns: 1fr; height: auto; overflow: visible; }
}
.planner-panel{
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 14px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height: 0;
}
.planner-panel-header{
  padding: 12px 12px 10px 12px;
  border-bottom: 1px solid var(--border-color);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.planner-filters{
  display:grid;
  grid-template-columns: 1fr 160px 170px 150px;
  gap:10px;
}
@media (max-width: 980px){
  .planner-filters{ grid-template-columns: 1fr; }
}
.planner-list{
  padding: 10px;
  overflow:auto;
  flex:1;
}
.planner-empty{
  padding: 18px;
  color:#64748b;
  font-size:0.95rem;
}
.planner-item{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
  cursor:pointer;
  transition: all .15s ease;
}
.planner-item:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(15,23,42,.08); }
.planner-item.active{ border-color: rgba(37, 99, 235, 0.45); box-shadow: 0 10px 16px rgba(37,99,235,.10); }
.planner-item.done{ opacity: .75; }
.planner-item .t1{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.planner-item-actions{ display:flex; align-items:center; gap:6px; }
.planner-delmini{
  border:1px solid rgba(239,68,68,.40);
  background: rgba(239,68,68,.14);
  color:#ef4444;
  border-radius: 10px;
  padding: 6px 9px;
  cursor:pointer;
  line-height:1;
}
.planner-delmini:hover{ background: rgba(239,68,68,.22); }
body.dark-mode .planner-delmini{
  border-color: rgba(248,113,113,.45);
  background: rgba(248,113,113,.18);
  color:#f87171;
}
.planner-title{
  font-weight: 800;
  display:flex;
  align-items:center;
  gap:10px;
}
.planner-title .txt{ line-height:1.2; }
.planner-badges{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top: 8px;
}
.planner-badge{
  font-size:0.78rem;
  padding: 4px 8px;
  border-radius: 999px;
  border:1px solid var(--border-color);
  background: rgba(15,23,42,.03);
  color: var(--text-main);
}
body.dark-mode .planner-badge{ background: rgba(255,255,255,.06); }
.planner-badge.overdue{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }
.planner-form{
  padding: 14px;
  overflow:auto;
  flex:1;
}
.planner-form h3{
  margin-bottom: 10px;
  font-size: 1.05rem;
}
.planner-form .form-row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media (max-width: 980px){
  .planner-form .form-row{ grid-template-columns: 1fr; }
}
.planner-form .form-group{ margin-bottom: 12px; }
.planner-form label{ font-size:0.85rem; font-weight:700; display:block; margin-bottom:6px; color:#64748b; }
.planner-form .inp{ width:100%; }
.planner-form .actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top: 8px;
}
.planner-mini{
  font-size:0.82rem;
  color:#64748b;
}




.planner-alerts{
  padding: 10px 12px;
  border-bottom: 1px dashed var(--border-color);
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.planner-alert{
  font-size:0.82rem;
  font-weight:900;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid var(--border-color);
  background: rgba(2,132,199,.08);
  color: var(--text-main);
  display:flex;
  align-items:center;
  gap:8px;
}
.planner-alert.danger{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.10); }
.planner-alert.warn{ border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12); }
.planner-alert.ok{ border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.10); }
.planner-alert.mini{ font-weight:800; opacity:.9; }

.planner-weekbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 10px 0 10px;
}
.planner-weekbar .wklabel{
  font-weight:900;
  font-size:0.95rem;
  color: var(--text-main);
}
.planner-week-grid{
  display:grid;
  grid-template-columns: repeat(7, minmax(160px, 1fr));
  gap:10px;
  padding: 10px;
}
@media (max-width: 1100px){
  .planner-week-grid{ grid-template-columns: 1fr; }
}
.planner-day{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  border-radius: 14px;
  min-height: 150px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.planner-day .hd{
  padding: 10px 10px 8px 10px;
  border-bottom:1px solid var(--border-color);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  background: rgba(15,23,42,.02);
}
body.dark-mode .planner-day .hd{ background: rgba(255,255,255,.05); }
.planner-day .dname{ font-weight:900; font-size:0.92rem; }
.planner-day .ddate{ font-size:0.78rem; color:#64748b; font-weight:800; }
.planner-day .body{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  overflow:auto;
  flex:1;
}
.planner-day.drop-hover{ outline: 3px dashed rgba(37,99,235,.55); outline-offset: -6px; }
.planner-taskcard{
  border:1px solid var(--border-color);
  border-radius: 12px;
  padding: 10px;
  background: rgba(37,99,235,.06);
  cursor:grab;
  transition: transform .12s ease, box-shadow .12s ease;
}
.planner-taskcard:active{ cursor:grabbing; }
.planner-taskcard:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(15,23,42,.08); }
.planner-taskcard.done{ opacity:.7; background: rgba(15,23,42,.04); }
.planner-taskcard .t{ font-weight:900; line-height:1.15; }
.planner-taskcard .m{
  display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;
}
.planner-chip{
  font-size:0.74rem;
  font-weight:900;
  padding: 3px 7px;
  border-radius: 999px;
  border:1px solid var(--border-color);
  background: rgba(15,23,42,.03);
}
.planner-chip.overdue{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.10); }
.planner-chip.repeat{ border-color: rgba(14,165,233,.45); background: rgba(14,165,233,.10); }
.planner-undated{
  padding: 0 10px 10px 10px;
}
.planner-undated .ttl{
  font-weight:900; font-size:0.9rem; color: var(--text-main);
  display:flex; align-items:center; gap:8px; padding: 2px 4px;
}



/* --- PLANNER: Tela Cheia (FullScreen) --- */
#modalPlanner .modal-box:fullscreen,
#modalPlanner .modal-box:-webkit-full-screen,
#modalPlanner .modal-box:-moz-full-screen,
#modalPlanner .modal-box:-ms-fullscreen{
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  border-radius: 0 !important;
  margin: 0 !important;
}
body.planner-is-fullscreen #modalPlanner{ background: transparent !important; backdrop-filter: none !important; }
body.planner-is-fullscreen #modalPlanner .planner-body{
  height: auto !important;
  flex: 1 !important;
  min-height: 0 !important;
  overflow: hidden !important;
}
/* --- fim fullscreen planner --- */

/* ==========================
   ATIVIDADES (v1) — Modal
   ========================== */
.act-headbar{
  padding: 12px 18px;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-body) 100%);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.act-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.act-tab{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-main);
  padding: 8px 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight:800;
  font-size:0.9rem;
  display:flex;
  align-items:center;
  gap:8px;
  transition: all .15s ease;
}
.act-tab:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(15,23,42,.08); }
.act-tab.active{
  background: rgba(37, 99, 235, 0.12);
  border-color: rgba(37, 99, 235, 0.35);
}
.act-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

.act-body{
  padding: 18px;
  display:flex;
  flex-direction:column;
  gap: 16px;
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overscroll-behavior: contain;
}

.act-view{ flex:1; min-height:0; }
.act-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media (max-width: 980px){
  .act-grid{ grid-template-columns: 1fr; }
}
.act-panel{
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 14px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height: 0;
}
.act-panel-header{
  padding: 12px 12px 10px 12px;
  border-bottom: 1px solid var(--border-color);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.act-panel-body{
  padding: 12px;
  overflow:auto;
  flex: 1;
}
.act-mini{ color:#64748b; font-size:0.9rem; }
.act-title{
  font-weight:900;
  display:flex;
  align-items:center;
  gap:10px;
  font-size:1.05rem;
}

.act-kbd{
  display:grid;
  grid-template-columns: repeat(13, minmax(0, 1fr));
  gap:6px;
}
@media (max-width: 760px){
  .act-kbd{ grid-template-columns: repeat(10, minmax(0, 1fr)); }
}
.act-kbd button{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-main);
  border-radius: 10px;
  padding: 8px 0;
  font-weight: 900;
  cursor:pointer;
  transition: all .12s ease;
}
.act-kbd button:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(15,23,42,.08); }
.act-kbd button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.act-word{
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: .12em;
  word-break: break-word;
}
.act-badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.act-badge{
  font-size:0.85rem;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid var(--border-color);
  background: rgba(15,23,42,.03);
  color: var(--text-main);
  font-weight: 800;
}
body.dark-mode .act-badge{ background: rgba(255,255,255,.06); }

/* Cores + animação (apenas dentro do modal de Atividades) */
#modalAtividades{ --actA: rgba(59,130,246,.18); --actB: rgba(236,72,153,.18); --actC: rgba(34,197,94,.18); --actD: rgba(250,204,21,.20); }
#modalAtividades .modal-header-xl{
  background: linear-gradient(135deg, rgba(59,130,246,.18) 0%, rgba(236,72,153,.16) 50%, rgba(34,197,94,.14) 100%);
  background-size: 200% 200%;
  animation: actGradientMove 10s ease infinite;
}
body.dark-mode #modalAtividades .modal-header-xl{
  background: linear-gradient(135deg, rgba(59,130,246,.18) 0%, rgba(236,72,153,.14) 50%, rgba(34,197,94,.12) 100%);
}
@keyframes actGradientMove{
  0%{ background-position: 0% 50%; }
  50%{ background-position: 100% 50%; }
  100%{ background-position: 0% 50%; }
}

#modalAtividades[data-act-tab="forca"]{ --actA: rgba(239,68,68,.16); --actB: rgba(59,130,246,.18); }
#modalAtividades[data-act-tab="vf"]{ --actA: rgba(34,197,94,.18); --actB: rgba(168,85,247,.16); }
#modalAtividades[data-act-tab="mem"]{ --actA: rgba(250,204,21,.22); --actB: rgba(6,182,212,.16); }
#modalAtividades[data-act-tab="fc"]{ --actA: rgba(14,165,233,.18); --actB: rgba(99,102,241,.18); }

#modalAtividades .act-headbar{ background: linear-gradient(135deg, var(--actA) 0%, var(--actB) 100%); }
#modalAtividades .act-tab.active{
  background: linear-gradient(135deg, var(--actA) 0%, var(--actB) 100%);
  border-color: rgba(37, 99, 235, 0.0);
  box-shadow: 0 10px 20px rgba(15,23,42,.08);
}
#modalAtividades .act-panel{ box-shadow: 0 10px 22px rgba(15,23,42,.06); }

#modalAtividades .btn-primary{
  border: none !important;
  background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(236,72,153,.92));
  box-shadow: 0 10px 18px rgba(15,23,42,.10);
}
#modalAtividades .btn-primary:hover{ transform: translateY(-1px); }

/* Forca: teclado com feedback */
#modalAtividades .act-kbd button.hit{
  background: rgba(34,197,94,.18);
  border-color: rgba(34,197,94,.35);
  color: #14532d;
}
#modalAtividades .act-kbd button.miss{
  background: rgba(239,68,68,.14);
  border-color: rgba(239,68,68,.32);
  color: #7f1d1d;
}
body.dark-mode #modalAtividades .act-kbd button.hit{ color: #bbf7d0; }
body.dark-mode #modalAtividades .act-kbd button.miss{ color: #fecaca; }

/* Forca: desenho (forca) */
.act-hang-wrap{ display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }
.act-hangman{
  width: 230px;
  max-width: 100%;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid var(--border-color);
  background: linear-gradient(135deg, rgba(59,130,246,.10) 0%, rgba(236,72,153,.08) 60%, rgba(34,197,94,.08) 100%);
}
.act-hang-right{ flex:1; min-width: 220px; }
#forcaSvg{ width:100%; height:auto; display:block; }
#forcaSvg line, #forcaSvg circle{ stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
#forcaSvg .gallows line{ stroke: rgba(37,99,235,.70); }
#forcaSvg .man .part{ stroke: rgba(239,68,68,.78); opacity: 0; transition: opacity .18s ease; }
#forcaSvg .man .part.on{ opacity: 1; }
body.dark-mode #forcaSvg .gallows line{ stroke: rgba(147,197,253,.72); }
body.dark-mode #forcaSvg .man .part{ stroke: rgba(252,165,165,.85); }

/* Forca: explicação teórica pós-jogo */
.act-theory{
  margin-top: 12px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid var(--border-color);
  background: linear-gradient(135deg, rgba(250,204,21,.22) 0%, rgba(34,197,94,.14) 100%);
  max-height: 240px;
  overflow: auto;
}
.act-theory-title{
  font-weight: 900;
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom: 6px;
}
.act-theory-text{
  white-space: pre-wrap;
  line-height: 1.35;
}


/* V/F: badge colorida */
#modalAtividades #vfBadgeAnswer.vfV{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
#modalAtividades #vfBadgeAnswer.vfF{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.32); }

/* V/F: botões grandes (aluno) */
#modalAtividades .vf-choices{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
#modalAtividades .vf-btn{
  flex:1;
  min-width: 220px;
  padding: 14px 16px;
  border-radius: 16px;
  font-weight: 1000;
  font-size: 1.15rem;
  border: 2px solid transparent;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  box-shadow: 0 14px 26px rgba(15,23,42,.10);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  user-select:none;
}
#modalAtividades .vf-btn:hover{ transform: translateY(-2px) scale(1.01); box-shadow: 0 18px 34px rgba(15,23,42,.14); }
#modalAtividades .vf-btn:active{ transform: translateY(0) scale(.99); }
#modalAtividades .vf-btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; box-shadow: none; }
#modalAtividades .vf-true{
  background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.90));
  color: #052e16;
  border-color: rgba(34,197,94,.45);
}
#modalAtividades .vf-false{
  background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(244,63,94,.90));
  color: #450a0a;
  border-color: rgba(239,68,68,.40);
}
body.dark-mode #modalAtividades .vf-true{ color:#ecfdf5; }
body.dark-mode #modalAtividades .vf-false{ color:#fff1f2; }

/* V/F: resultado destacado (Acertou/Errou) */
#modalAtividades #vfBadgeResult{
  font-size: 1.10rem;
  padding: 10px 14px;
  border-radius: 999px;
  border: 2px solid var(--border-color);
  font-weight: 1000;
  letter-spacing: .04em;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 14px 28px rgba(15,23,42,.12);
}
#modalAtividades #vfBadgeResult.vf-ok{
  background: linear-gradient(135deg, rgba(34,197,94,.34), rgba(16,185,129,.20));
  border-color: rgba(34,197,94,.55);
  color: #052e16;
  animation: vfWin .35s ease-out;
  box-shadow: 0 16px 34px rgba(34,197,94,.18), 0 14px 28px rgba(15,23,42,.10);
}
#modalAtividades #vfBadgeResult.vf-bad{
  background: linear-gradient(135deg, rgba(239,68,68,.30), rgba(244,63,94,.18));
  border-color: rgba(239,68,68,.55);
  color: #450a0a;
  animation: vfLose .35s ease-out;
  box-shadow: 0 16px 34px rgba(239,68,68,.16), 0 14px 28px rgba(15,23,42,.10);
}
body.dark-mode #modalAtividades #vfBadgeResult.vf-ok{ color:#ecfdf5; }
body.dark-mode #modalAtividades #vfBadgeResult.vf-bad{ color:#fff1f2; }
@keyframes vfWin{
  0%{ transform: scale(.94); filter: saturate(1.05); }
  70%{ transform: scale(1.07); }
  100%{ transform: scale(1); }
}
@keyframes vfLose{
  0%{ transform: translateX(0); }
  20%{ transform: translateX(-7px); }
  40%{ transform: translateX(7px); }
  60%{ transform: translateX(-5px); }
  80%{ transform: translateX(5px); }
  100%{ transform: translateX(0); }
}

/* Memória: cartas mais vivas */
#modalAtividades .act-mcard.flipped{
  /* Cor por PAR (usa --pairHue definido no card) */
  /* cores sólidas (sem gradiente) */
  background: hsl(var(--pairHue, 248), 86%, 84%);
  border-color: hsla(var(--pairHue, 248), 70%, 38%, .45);
  color: #0b1220;
  animation: actPop .16s ease-out;
}
#modalAtividades .act-mcard.matched{
  /* Mantém a cor do par + destaque de acerto */
  /* cores sólidas (sem gradiente) */
  background: hsl(var(--pairHue, 248), 86%, 78%);
  border-color: rgba(34,197,94,.45);
  box-shadow: 0 12px 22px rgba(34,197,94,.12);
}
#modalAtividades .act-mcard.matched::before{
  content: "✓";
  position: absolute;
  top: 8px;
  right: 10px;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 1000;
  font-size: 0.95rem;
  background: rgba(34,197,94,.18);
  border: 1px solid rgba(34,197,94,.35);
  color: #052e16;
}
body.dark-mode #modalAtividades .act-mcard.flipped{ color:#0b1220; }
body.dark-mode #modalAtividades .act-mcard.matched::before{ color:#ecfdf5; }
@keyframes actPop{ from{ transform: scale(.98); } to{ transform: scale(1); } }

/* Flashcards (texto + virar) */
#modalAtividades .fc-card{
  border: 2px solid rgba(37,99,235,.35);
  background: rgba(37,99,235,.06);
  border-radius: 16px;
  padding: 18px;
  min-height: 190px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  gap: 10px;
  cursor:pointer;
  user-select:none;
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}
#modalAtividades .fc-card:hover{ transform: translateY(-2px); box-shadow: 0 18px 34px rgba(15,23,42,.12); }
#modalAtividades .fc-card .fc-side{
  font-size: .78rem;
  font-weight: 900;
  letter-spacing: .08em;
  text-transform: uppercase;
  opacity: .85;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid var(--border-color);
  background: var(--card-bg);
}
#modalAtividades .fc-card .fc-text{
  font-size: 1.35rem;
  font-weight: 950;
  line-height: 1.25;
  white-space: pre-wrap;
  word-break: break-word;
}
#modalAtividades .fc-card.flipped{ border-color: rgba(34,197,94,.40); background: rgba(34,197,94,.08); }
#modalAtividades .fc-card.flipped .fc-side{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
#modalAtividades .fc-small{ font-size: .85rem; color:#64748b; }
body.dark-mode #modalAtividades .fc-small{ color:#94a3b8; }


/* Modo professor (oculta painel de banco/config para os alunos) */
#modalAtividades.act-locked .act-view .act-grid{ grid-template-columns: 1fr !important; }
#modalAtividades.act-locked .act-view .act-grid > .act-panel:first-child{ display:none !important; }

/* Modo apresentação: mostra só o jogo/sessão */
#modalAtividades.act-present .act-view .act-grid{ grid-template-columns: 1fr !important; }
#modalAtividades.act-present .act-view .act-grid > .act-panel:first-child{ display:none; }

/* Apresentação: “limpa” a interface para projetar (mantém apenas Apresentar/Tela cheia) */
#modalAtividades.act-present .act-tabs{ display:none !important; }
#modalAtividades.act-present #actBtnTeacher{ display:none !important; }
#modalAtividades.act-present .act-actions button:not(#actBtnPresent):not(#actBtnFullscreen){ display:none !important; }
#modalAtividades.act-present .act-headbar{ justify-content:flex-end; }
#modalAtividades.act-present .act-view .act-panel-header{ display:none !important; }
#modalAtividades.act-present .act-view .act-panel{ border:none; background: transparent; }
#modalAtividades.act-present .act-view .act-panel-body{ padding: 0; }
#modalAtividades.act-present .act-body{ padding-top: 10px; }

/* Tela cheia do modal */
#modalAtividades.act-fullscreen{ background: rgba(0,0,0,0.65); }
#modalAtividades.act-fullscreen .modal-box.modal-xl{
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  border-radius: 0 !important;
}
#modalAtividades.act-fullscreen .act-body{ padding: 16px; }


.act-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top: 10px;
  max-height: 320px;
  overflow: auto;
  padding-right: 4px;
}
.act-item{
  border:1px solid var(--border-color);
  border-radius: 12px;
  padding: 10px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.act-item .txt{ flex:1; min-width:0; }
.act-item .txt b{ display:block; }
.act-item .btn-x{
  border:1px solid var(--border-color);
  background: var(--card-bg);
  border-radius: 10px;
  padding: 6px 10px;
  cursor:pointer;
  font-weight:900;
}

.act-mgrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
}
.act-mgrid.grid-8{ grid-template-columns: repeat(4, 1fr); }
.act-mgrid.grid-12{ grid-template-columns: repeat(4, 1fr); }
.act-mgrid.grid-16{ grid-template-columns: repeat(4, 1fr); }
.act-mgrid.grid-24{ grid-template-columns: repeat(6, 1fr); gap:6px; }
.act-mgrid.grid-24 .mem-card,.act-mgrid.grid-24 .act-mcard{ min-height:55px!important; font-size:.78rem!important; padding:6px!important; }
@media (max-width: 760px){
  .act-mgrid{ grid-template-columns: repeat(3, 1fr); }
  .act-mgrid.grid-24{ grid-template-columns: repeat(4, 1fr); gap:4px; }
}
.act-mcard{
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  border-radius: 14px;
  min-height: 74px;
  padding: 10px;
  cursor:pointer;
  font-weight: 900;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  line-height: 1.15;
  user-select:none;
  position: relative;
  overflow: hidden;
  transition: transform .12s ease, box-shadow .2s ease;
}
.act-mcard:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(15,23,42,.08); }
.act-mcard.matched{ opacity:.75; cursor:default; transform:none; box-shadow:none; }
.act-mcard.hidden{ color:#94a3b8; }


        /* === DIAGNÓSTICO RÁPIDO (Painel) === */
        .diag-fab{
            position: fixed;
            left: 18px;
            bottom: 18px;
            width: 46px;
            height: 46px;
            border-radius: 999px;
            background: var(--bg-sidebar);
            color: #fff;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            z-index: 10001;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            opacity: .80;
            transition: transform .12s ease, opacity .12s ease;
        }
        .diag-fab:hover{ opacity: 1; transform: translateY(-1px); }
        body.dark-mode .diag-fab{ background: #111827; }

        .diag-tabs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
        .diag-tabbtn{
            border:1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-main);
            padding: 6px 10px;
            border-radius: 10px;
            cursor:pointer;
            font-size: .85rem;
            display:flex;
            gap:6px;
            align-items:center;
        }
        .diag-tabbtn.active{
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37,99,235,.15);
        }
        .diag-panel{
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
            background: var(--card-bg);
            max-height: 62vh;
            overflow:auto;
        }
        .diag-row{ border-bottom:1px dashed var(--border-color); padding:8px 0; }
        .diag-row:last-child{ border-bottom:0; }
        .diag-muted{ color:#64748b; font-size:.85rem; }
        .diag-badge{ padding:2px 8px; border-radius:999px; font-size:.72rem; display:inline-block; }
        .diag-badge.err{ background:#fee2e2; color:#991b1b; }
        .diag-badge.warn{ background:#fef9c3; color:#854d0e; }
        .diag-badge.ok{ background:#dcfce7; color:#166534; }
        .diag-pre{ white-space:pre-wrap; font-size:.78rem; background: rgba(148,163,184,.12); padding:8px; border-radius:10px; }

/* ===== V13 NEW FEATURES CSS ===== */

/* Planner Badge */
.planner-badge{
  position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; 
  background:#ef4444; color:#fff; font-size:0.7rem; font-weight:700;
  border-radius:99px; display:flex; align-items:center; justify-content:center;
  padding:0 4px; pointer-events:none; z-index:2;
  animation: pulseBadge 2s infinite;
}
@keyframes pulseBadge{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.15);} }
.btn-tool{ position:relative; }

/* Import CSV modal */
.csv-drop-zone{
  border:2px dashed #475569; border-radius:12px; padding:30px 16px; text-align:center;
  cursor:pointer; transition:0.2s; color:#94a3b8; margin:12px 0;
}
.csv-drop-zone:hover,.csv-drop-zone.dragover{ border-color:#0ea5e9; background:rgba(14,165,233,.08); color:#0ea5e9; }
.csv-preview-table{ width:100%; border-collapse:collapse; max-height:250px; overflow-y:auto; display:block; margin-top:10px; }
.csv-preview-table th,.csv-preview-table td{ padding:6px 10px; border:1px solid var(--border-color); font-size:0.82rem; text-align:left; }
.csv-preview-table th{ background:rgba(14,165,233,.1); position:sticky; top:0; }
.csv-status{ margin-top:8px; font-size:0.85rem; color:#0ea5e9; }

/* Advanced search */
.search-filters-row{
  display:flex; gap:6px; flex-wrap:wrap; padding:0 20px 8px; align-items:center;
}
.search-filter-chip{
  padding:4px 10px; border-radius:20px; font-size:0.78rem; cursor:pointer;
  border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);
  transition:0.2s; display:flex; align-items:center; gap:4px; white-space:nowrap;
}
.search-filter-chip:hover,.search-filter-chip.active{
  border-color:#0ea5e9; background:rgba(14,165,233,.12); color:#0ea5e9;
}
.search-filter-chip.active-red{ border-color:#ef4444; background:rgba(239,68,68,.1); color:#ef4444; }

/* Frequency / Chamada */
.freq-table{ width:100%; border-collapse:collapse; }
.freq-table th,.freq-table td{ padding:6px 8px; border:1px solid var(--border-color); font-size:0.82rem; text-align:center; }
.freq-table th{ background:rgba(14,165,233,.08); }
.freq-btn{ width:28px; height:28px; border:none; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:700; }
.freq-btn.P{ background:#dcfce7; color:#166534; } .freq-btn.P:hover{ background:#bbf7d0; }
.freq-btn.F{ background:#fee2e2; color:#991b1b; } .freq-btn.F:hover{ background:#fecaca; }
.freq-btn.J{ background:#fef9c3; color:#854d0e; } .freq-btn.J:hover{ background:#fde68a; }
.freq-btn.none{ background:#f1f5f9; color:#94a3b8; }
.freq-pct{ font-weight:600; }
.freq-pct.good{ color:#16a34a; } .freq-pct.warn{ color:#f59e0b; } .freq-pct.danger{ color:#dc2626; }
.freq-header-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
.freq-header-row input[type="date"]{ padding:6px 10px; border-radius:8px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color); }
.freq-header-row select,.freq-header-row input[type="number"]{ padding:6px 10px; border-radius:8px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color); }

/* Fullscreen frequency */
#modalFrequencia.freq-fullscreen{ background:var(--bg-color,#fff); align-items:stretch; padding:0; }
#modalFrequencia.freq-fullscreen>.modal-box{
  max-width:100%!important; width:100%!important; max-height:100vh!important; height:100vh!important;
  border-radius:0!important; margin:0!important; padding:16px 24px!important;
  overflow-y:auto!important; box-shadow:none!important;
  position:fixed!important; inset:0!important; z-index:10000!important;
  background:var(--card-bg,#fff)!important;
}
.freq-registro-aula{
  width:100%; padding:8px 12px; border-radius:8px; border:1px solid var(--border-color);
  background:var(--card-bg); color:var(--text-color); font-family:inherit; font-size:0.85rem;
  resize:vertical; min-height:48px; margin-top:8px;
}
.freq-meta-row{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-bottom:10px; padding:10px 12px; background:rgba(14,165,233,.05); border-radius:10px; border:1px solid rgba(14,165,233,.12); }
.freq-meta-row label{ font-size:0.82rem; display:flex; flex-direction:column; gap:3px; }
.freq-meta-row label span{ font-weight:600; font-size:0.75rem; color:#64748b; text-transform:uppercase; letter-spacing:.3px; }
.freq-fullscreen-btn{ background:none; border:1px solid var(--border-color); border-radius:8px; width:34px; height:34px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text-color); transition:.15s; }
.freq-fullscreen-btn:hover{ background:rgba(14,165,233,.12); border-color:#0ea5e9; color:#0ea5e9; }

/* === V17: Enhanced Frequency/Attendance === */
.freq-btn.saved{animation:freqSavedPulse .5s ease-out;}
@keyframes freqSavedPulse{0%{box-shadow:0 0 0 0 rgba(22,163,74,.5);}100%{box-shadow:0 0 0 14px rgba(22,163,74,0);}}
.freq-undo-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 18px;border-radius:10px;font-size:.82rem;font-weight:600;display:flex;align-items:center;gap:10px;z-index:100001;box-shadow:0 8px 24px rgba(0,0,0,.25);animation:freqUndoIn .3s ease-out;}
@keyframes freqUndoIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
.freq-undo-toast button{background:#0ea5e9;color:#fff;border:none;padding:5px 12px;border-radius:6px;font-size:.78rem;font-weight:700;cursor:pointer;}
.freq-undo-toast button:hover{background:#0284c7;}

.freq-cal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100000;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s;}
.freq-cal-box{background:var(--card-bg,#fff);border-radius:16px;padding:20px 24px;max-width:600px;width:95%;max-height:85vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.2);}
.freq-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin:10px 0;}
.freq-cal-cell{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;cursor:default;transition:.15s;}
.freq-cal-cell:hover{filter:brightness(1.1);transform:scale(1.08);}
.freq-cal-cell.hdr{background:transparent;color:#64748b;font-size:.65rem;font-weight:600;}
.freq-cal-cell.empty{background:transparent;}
.freq-cal-cell.P{background:#dcfce7;color:#166534;} .freq-cal-cell.F{background:#fee2e2;color:#991b1b;}
.freq-cal-cell.J{background:#fef9c3;color:#854d0e;} .freq-cal-cell.none{background:#f1f5f9;color:#cbd5e1;}
.freq-cal-cell.today{box-shadow:inset 0 0 0 2px #0ea5e9;}

.freq-table tr.freq-unmarked{background:rgba(250,204,21,.10);}
.freq-table tr.freq-unmarked td:nth-child(2)::after{content:' ⚠';font-size:.65rem;color:#ca8a04;}
.freq-search-wrap{position:relative;margin-bottom:8px;}
.freq-search-wrap input{width:100%;padding:7px 12px 7px 32px;border:1px solid var(--border-color);border-radius:8px;font-size:.82rem;background:var(--card-bg);color:var(--text-color);}
.freq-search-wrap i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:.78rem;}
.freq-date-nav{display:inline-flex;align-items:center;gap:4px;}
.freq-date-nav button{width:28px;height:28px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);color:var(--text-color);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.75rem;transition:.15s;}
.freq-date-nav button:hover{background:rgba(14,165,233,.12);border-color:#0ea5e9;color:#0ea5e9;}
.freq-pattern-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:8px;font-size:.72rem;font-weight:600;border:1px solid;}
.freq-pattern-chip.warn{background:#fef3c7;color:#92400e;border-color:#fde68a;}
.freq-pattern-chip.danger{background:#fee2e2;color:#991b1b;border-color:#fecaca;}
.freq-pattern-chip.info{background:#e0f2fe;color:#0c4a6e;border-color:#bae6fd;}

.freq-monthly-table{border-collapse:collapse;font-size:.68rem;width:100%;}
.freq-monthly-table th,.freq-monthly-table td{padding:3px 4px;border:1px solid var(--border-color);text-align:center;min-width:24px;}
.freq-monthly-table th{background:rgba(14,165,233,.08);font-weight:700;position:sticky;top:0;z-index:2;}
.freq-monthly-table td.P{background:#dcfce7;color:#166534;font-weight:700;}
.freq-monthly-table td.F{background:#fee2e2;color:#991b1b;font-weight:700;}
.freq-monthly-table td.J{background:#fef9c3;color:#854d0e;font-weight:700;}
.freq-monthly-table td.name-col{text-align:left;position:sticky;left:0;background:var(--card-bg);z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px;font-weight:500;}
.freq-monthly-table tr:hover td{filter:brightness(.97);}
.freq-monthly-table td.weekend{background:rgba(148,163,184,.08);}
.freq-monthly-table tfoot td{font-weight:800;background:rgba(14,165,233,.05);border-top:2px solid var(--border-color);}

.freq-trend-canvas{width:100%;height:180px;}

@media print{.freq-cal-overlay,.freq-undo-toast{display:none!important;}}
@media(max-width:600px){.freq-monthly-table{font-size:.6rem;}.freq-monthly-table th,.freq-monthly-table td{padding:2px;min-width:18px;}}

/* === NEW GAMES: Relacionar, Roleta, Caça-palavras, Cruzadinha === */
.rel-board{display:flex;gap:24px;justify-content:center;flex-wrap:wrap;min-height:200px;align-items:flex-start;}
.rel-col{display:flex;flex-direction:column;gap:8px;min-width:140px;}
.rel-item{padding:10px 16px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;font-size:.9rem;font-weight:600;transition:.2s;text-align:center;user-select:none;}
.rel-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1);}
.rel-item.selected{border-color:#7c3aed;background:rgba(124,58,237,.12);box-shadow:0 0 0 3px rgba(124,58,237,.2);}
.rel-item.matched{border-color:#16a34a;background:rgba(22,163,74,.1);opacity:.7;cursor:default;}
.rel-item.wrong{animation:relShake .4s;border-color:#dc2626;}
@keyframes relShake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}
.rel-lines{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}

/* Roleta */
.roleta-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;}
.roleta-canvas-wrap{position:relative;width:320px;height:320px;}
.roleta-canvas-wrap canvas{width:100%;height:100%;}
.roleta-pointer{position:absolute;top:-12px;left:50%;transform:translateX(-50%);font-size:28px;z-index:2;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));}
.roleta-result{font-size:1.4rem;font-weight:900;text-align:center;min-height:40px;color:var(--text-main);}
@keyframes roletaPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
.roleta-result.show{animation:roletaPulse .5s ease;}

/* Caça-palavras */
.ws-grid{display:inline-grid;gap:0;border:2px solid var(--border-color);border-radius:8px;overflow:hidden;user-select:none;touch-action:none;}
.ws-cell{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;cursor:pointer;transition:background .15s;border:1px solid rgba(0,0,0,.05);}
.ws-cell:hover{background:rgba(124,58,237,.08);}
.ws-cell.selecting{background:rgba(124,58,237,.25);color:#7c3aed;}
.ws-cell.found{background:rgba(22,163,74,.18);color:#166534;font-weight:900;}
.ws-wordlist{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.ws-wordlist span{padding:4px 10px;border-radius:6px;font-size:.78rem;font-weight:600;background:#f1f5f9;color:#475569;border:1px solid var(--border-color);}
.ws-wordlist span.found{background:#dcfce7;color:#166534;text-decoration:line-through;border-color:#16a34a;}
body.dark-mode .ws-cell{border-color:rgba(255,255,255,.06);}
body.dark-mode .ws-wordlist span{background:#1e293b;color:#94a3b8;}

/* Cruzadinha */
.cw-grid{display:inline-grid;gap:0;border:2px solid var(--border-color);border-radius:6px;overflow:hidden;}
.cw-cell{width:36px;height:36px;position:relative;}
.cw-cell.black{background:#1e293b;}
body.dark-mode .cw-cell.black{background:#0f172a;}
.cw-cell input{width:100%;height:100%;border:1px solid var(--border-color);text-align:center;font-weight:700;font-size:.9rem;text-transform:uppercase;background:var(--card-bg);color:var(--text-main);padding:0;}
.cw-cell input:focus{outline:2px solid #7c3aed;z-index:1;position:relative;}
.cw-cell input.correct{background:rgba(22,163,74,.12);color:#166534;}
.cw-cell input.wrong{background:rgba(220,38,38,.12);color:#991b1b;}
.cw-cell .cw-num{position:absolute;top:1px;left:2px;font-size:.55rem;font-weight:700;color:#7c3aed;z-index:1;pointer-events:none;}
.cw-clues{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;font-size:.82rem;}
.cw-clues h4{margin:0 0 6px;font-size:.78rem;text-transform:uppercase;letter-spacing:.3px;color:#7c3aed;}
.cw-clues div{padding:2px 0;}
.cw-clues .cw-clue-num{font-weight:700;color:#7c3aed;margin-right:4px;}

/* Ranking */
.ranking-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10001;display:flex;align-items:center;justify-content:center;}
.ranking-box{background:var(--card-bg);color:var(--text-main);width:500px;max-width:95vw;max-height:85vh;overflow-y:auto;border-radius:14px;padding:20px;position:relative;}
.ranking-list{margin-top:10px;}
.ranking-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;margin:4px 0;transition:.2s;}
.ranking-row:nth-child(-n+3){font-weight:700;}
.ranking-row:nth-child(1){background:rgba(250,204,21,.15);font-size:1.05rem;}
.ranking-row:nth-child(2){background:rgba(192,192,192,.12);}
.ranking-row:nth-child(3){background:rgba(205,127,50,.1);}
.ranking-pos{width:28px;text-align:center;font-weight:900;color:#7c3aed;}
.ranking-name{flex:1;}
.ranking-score{font-size:1.1rem;font-weight:900;color:var(--text-main);min-width:40px;text-align:center;}
.ranking-btns button{border:none;width:28px;height:28px;border-radius:6px;cursor:pointer;font-weight:700;font-size:.85rem;}
.ranking-btns .rk-plus{background:#dcfce7;color:#166534;}
.ranking-btns .rk-minus{background:#fee2e2;color:#991b1b;}
.ranking-btns .rk-plus:hover{background:#bbf7d0;} .ranking-btns .rk-minus:hover{background:#fecaca;}

/* Sound toggle */
.act-sound-toggle{cursor:pointer;font-size:.78rem;display:flex;align-items:center;gap:4px;color:#64748b;user-select:none;}
.act-sound-toggle:hover{color:var(--text-main);}

/* Boletim (Student Report) */
.boletim-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:10000; display:flex; align-items:center; justify-content:center; }
.boletim-container{ background:#fff; color:#1e293b; width:750px; max-height:90vh; overflow-y:auto; border-radius:12px; padding:30px; position:relative; }
.boletim-header{ text-align:center; border-bottom:2px solid #1e293b; padding-bottom:12px; margin-bottom:16px; }
.boletim-header h2{ margin:0; font-size:1.4rem; } .boletim-header p{ margin:4px 0; font-size:0.9rem; color:#475569; }
.boletim-table{ width:100%; border-collapse:collapse; margin:12px 0; }
.boletim-table th,.boletim-table td{ padding:6px 8px; border:1px solid #cbd5e1; font-size:0.82rem; text-align:center; }
.boletim-table th{ background:#f1f5f9; font-weight:600; }
.boletim-section{ margin-top:16px; }
.boletim-section h3{ font-size:1rem; border-bottom:1px solid #e2e8f0; padding-bottom:4px; margin-bottom:8px; }
.boletim-close{ position:absolute; top:12px; right:12px; background:none; border:none; font-size:1.3rem; cursor:pointer; color:#64748b; }
.boletim-actions{ display:flex; gap:8px; justify-content:center; margin-top:16px; }
.boletim-actions button{ padding:8px 16px; border:none; border-radius:8px; cursor:pointer; font-size:0.85rem; }
.boletim-btn-print{ background:#0ea5e9; color:#fff; } .boletim-btn-print:hover{ background:#0284c7; }
@media print{
  body *{ visibility:hidden !important; }
  .boletim-overlay,.boletim-overlay *{ visibility:visible !important; }
  .boletim-overlay{ position:fixed; inset:0; background:#fff; }
  .boletim-container{ width:100%; max-height:none; box-shadow:none; border-radius:0; }
  .boletim-close,.boletim-actions{ display:none !important; }
}

/* Backup reminder bar */
.backup-reminder-bar{
  position:fixed; bottom:0; left:0; right:0; z-index:9999;
  background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff;
  padding:10px 20px; display:flex; align-items:center; justify-content:space-between;
  font-size:0.9rem; box-shadow:0 -2px 10px rgba(0,0,0,.2);
  animation: slideUp 0.3s ease;
}
@keyframes slideUp{ from{transform:translateY(100%)} to{transform:translateY(0)} }
.backup-reminder-bar button{ padding:6px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.82rem; }
.backup-reminder-bar .btn-reminder-yes{ background:#fff; color:#d97706; }
.backup-reminder-bar .btn-reminder-no{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.5); margin-left:6px; }

/* New dashboard charts */
.dash-card.chart-pie{ min-height:280px; }
.dash-chart-pie-wrap{ display:flex; gap:20px; align-items:center; justify-content:center; flex-wrap:wrap; }
.dash-chart-pie-wrap canvas{ max-width:220px; max-height:220px; }

/* ===== V14 NEW FEATURES CSS ===== */

/* F2: Ata/Relatório da turma */
.ata-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center;}
.ata-container{background:#fff;color:#1e293b;width:95vw;max-width:1000px;max-height:92vh;overflow-y:auto;border-radius:12px;padding:24px;position:relative;}
.ata-table{width:100%;border-collapse:collapse;font-size:.78rem;margin:12px 0;}
.ata-table th,.ata-table td{padding:5px 6px;border:1px solid #cbd5e1;text-align:center;}
.ata-table th{background:#f1f5f9;font-weight:600;white-space:nowrap;}
.ata-table .sit-ap{background:#dcfce7;color:#166534;font-weight:700;} .ata-table .sit-rec{background:#fef9c3;color:#854d0e;font-weight:700;} .ata-table .sit-rep{background:#fee2e2;color:#991b1b;font-weight:700;}
.ata-close{position:absolute;top:10px;right:12px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;}
.ata-actions{display:flex;gap:8px;justify-content:center;margin-top:14px;}
.ata-actions button{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;}
@media print{.ata-overlay,.ata-overlay *{visibility:visible!important;}.ata-overlay{position:fixed;inset:0;background:#fff;}.ata-container{width:100%;max-height:none;box-shadow:none;border-radius:0;}.ata-close,.ata-actions{display:none!important;}.ata-table{font-size:.7rem;}}

/* F4: Atividades checklist */
.ativ-manager{margin-top:12px;}
.ativ-add-row{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;}
.ativ-add-row input{flex:1;min-width:150px;padding:6px 10px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);font-size:.85rem;}
.ativ-check-table{width:100%;border-collapse:collapse;}
.ativ-check-table th,.ativ-check-table td{padding:5px 6px;border:1px solid var(--border-color);font-size:.8rem;text-align:center;}
.ativ-check-table th{background:rgba(14,165,233,.08);white-space:nowrap;}
.ativ-check-table td:first-child{text-align:left;}
.ativ-chk{width:18px;height:18px;cursor:pointer;accent-color:#16a34a;}
.ativ-del{background:none;border:none;color:#dc2626;cursor:pointer;font-size:.8rem;padding:2px 4px;}
.ativ-pct{font-weight:600;font-size:.75rem;}

/* F7: Theme customization */
.theme-picker{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
.theme-swatch{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.15s;}
.theme-swatch:hover,.theme-swatch.active{border-color:#fff;box-shadow:0 0 0 2px var(--primary);}
.font-size-control{display:flex;align-items:center;gap:8px;margin:8px 0;}
.font-size-control button{width:30px;height:30px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);cursor:pointer;font-weight:700;}

/* F8: Universal search results */
.search-results-panel{position:absolute;top:100%;left:0;right:0;background:var(--card-bg,#fff);border:1px solid var(--border-color);border-radius:0 0 12px 12px;max-height:350px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.15);display:none;}
.search-results-panel.open{display:block;}
.sr-group-title{padding:6px 12px;font-size:.72rem;font-weight:700;text-transform:uppercase;color:#64748b;background:rgba(14,165,233,.06);letter-spacing:.5px;}
.sr-item{padding:8px 12px;cursor:pointer;font-size:.84rem;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(0,0,0,.04);}
.sr-item:hover{background:rgba(14,165,233,.08);}
.sr-item .sr-type{font-size:.65rem;padding:2px 6px;border-radius:4px;font-weight:600;white-space:nowrap;}
.sr-item .sr-type.t-aluno{background:#dbeafe;color:#1d4ed8;} .sr-item .sr-type.t-aula{background:#dcfce7;color:#166534;}
.sr-item .sr-type.t-planner{background:#fef9c3;color:#854d0e;} .sr-item .sr-type.t-chamada{background:#fce7f3;color:#9d174d;}
.search-container{position:relative;}

/* F9: Sparkline */
.sparkline-box{display:flex;align-items:center;gap:6px;margin:6px 0;}
.sparkline-box canvas{border-radius:4px;}
.sparkline-trend{font-size:.72rem;font-weight:700;}
.sparkline-trend.up{color:#16a34a;} .sparkline-trend.down{color:#dc2626;} .sparkline-trend.stable{color:#64748b;}

/* F12: Sidebar badges */
.turma-badge{min-width:20px;height:20px;border-radius:10px;font-size:.7rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 5px;}
.turma-badge.normal{background:rgba(255,255,255,.15);color:rgba(255,255,255,.7);}
.turma-badge.risco{background:#fee2e2;color:#991b1b;}

/* F13: Note validation */
input.nota-invalid{border-color:#ef4444!important;background:rgba(239,68,68,.08)!important;animation:shakeInput .3s;}
@keyframes shakeInput{0%,100%{transform:translateX(0);}25%{transform:translateX(-4px);}75%{transform:translateX(4px);}}
.nota-tooltip{position:absolute;background:#991b1b;color:#fff;padding:3px 8px;border-radius:4px;font-size:.72rem;white-space:nowrap;z-index:50;pointer-events:none;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);}

/* F14: Audit trail */
.audit-panel{max-height:400px;overflow-y:auto;}
.audit-entry{padding:6px 10px;border-bottom:1px solid var(--border-color);font-size:.8rem;display:flex;gap:8px;align-items:flex-start;}
.audit-ts{color:#64748b;font-size:.72rem;white-space:nowrap;min-width:120px;}
.audit-msg{flex:1;}

/* ===== V15 FEATURES CSS ===== */

/* F11: Sidebar toggle */
.sidebar-toggle{
  position:fixed;top:12px;left:12px;z-index:25;width:40px;height:40px;border-radius:10px;
  border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);
  cursor:pointer;display:none;align-items:center;justify-content:center;font-size:1.1rem;
  box-shadow:0 2px 8px rgba(0,0,0,.12);transition:.2s;
}
.sidebar-toggle:hover{background:var(--primary);color:#fff;}
/* Desktop: toggle hides sidebar completely */
body.sidebar-hidden .sidebar-toggle{display:flex;}
body.sidebar-hidden aside{display:none;}
body.sidebar-hidden main{margin-left:0;}
/* Mobile: sidebar is drawer overlay */
@media(max-width:980px){
  .sidebar-toggle{display:flex!important;z-index:201;}
  aside{position:fixed;left:0;top:0;bottom:0;z-index:200;width:280px;
    transform:translateX(-100%);transition:transform .25s ease;overflow-y:auto;}
  body.sidebar-open aside{transform:translateX(0)!important;display:flex!important;}
  body:not(.sidebar-open) aside{transform:translateX(-100%);}
  /* On mobile, sidebar-hidden just means the drawer is closed (default state) */
  body.sidebar-hidden aside{display:flex;transform:translateX(-100%);}
  .sidebar-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:199;
    display:none;opacity:0;transition:opacity .25s;}
  body.sidebar-open .sidebar-backdrop{display:block;opacity:1;}
}

/* F12: Mobile PWA improvements */

/* === TABLET (<=980px) === */
@media(max-width:980px){
  main{padding-top:56px!important;}
  .dash-container{grid-template-columns:1fr 1fr!important;gap:12px!important;}
}

/* === MOBILE (<=768px) === */
@media(max-width:768px){
  /* Root: fix scroll and layout */
  body{-webkit-tap-highlight-color:transparent;overscroll-behavior-y:contain;height:auto!important;min-height:100vh;overflow:auto!important;}
  main{flex:1;padding:10px!important;padding-top:56px!important;padding-bottom:70px!important;overflow:visible!important;height:auto!important;min-height:0;}

  /* Top bar: compact */
  .top-bar{padding:10px!important;gap:8px!important;border-radius:10px!important;margin-bottom:12px!important;position:sticky!important;top:0!important;z-index:150!important;background:var(--card-bg)!important;box-shadow:0 2px 10px rgba(0,0,0,.08)!important;}
  .top-row{gap:6px!important;flex-direction:column!important;}
  .title-area h1{font-size:1.1rem!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .title-subtitle{font-size:.7rem!important;}

  /* Bimestre: compact 4-column */
  .bimestre-selector{width:100%!important;display:grid!important;grid-template-columns:repeat(4,1fr)!important;gap:3px!important;}
  .btn-bim{padding:8px 4px!important;font-size:.72rem!important;min-height:40px!important;}
  .btn-bim i{display:none!important;}

  /* Controls: stack vertically, scrollable */
  .controls-section{flex-direction:column!important;gap:6px!important;} 
  .control-group,.tools-group,.filters-group{width:100%!important;}
  .control-label{display:none!important;}

  /* View toggle: 3 columns */
  .view-toggle{grid-template-columns:repeat(3,1fr)!important;width:100%!important;gap:3px!important;}
  .btn-view{padding:8px 6px!important;font-size:.72rem!important;min-height:40px!important;}
  .btn-view span{display:none!important;} /* hide text, keep icon */

  /* Tools: 2x2 grid */
  .tools-group{display:grid!important;grid-template-columns:repeat(3,1fr)!important;gap:4px!important;}
  .btn-tool{min-width:44px!important;min-height:44px!important;padding:8px!important;font-size:.85rem!important;}
  .btn-tool span{display:none!important;}

  /* Search bar: prevent iOS zoom */
  .search-bar{font-size:16px!important;padding:12px 40px!important;border-radius:10px!important;}

  /* Filter chips: horizontal scroll */
  .search-filters-row{overflow-x:auto!important;flex-wrap:nowrap!important;gap:4px!important;padding-bottom:4px!important;-webkit-overflow-scrolling:touch;}
  .search-filter-chip{padding:7px 10px!important;font-size:.7rem!important;white-space:nowrap!important;flex-shrink:0!important;}

  /* Grid alunos: single column, tighter cards */
  main .grid-alunos{grid-template-columns:1fr;gap:10px;}
  main .card-aluno{padding:12px;border-radius:10px;}
  main .aluno-nome{font-size:1rem;}
  main .card-stats{flex-direction:column;gap:4px;}
  main .card-stat{padding:6px 8px;font-size:.75rem;}

  /* Dashboard: single column */
  .dash-container{grid-template-columns:1fr!important;gap:10px!important;}
  .dash-card{padding:12px!important;}

  /* Calendar: tighter grid */
  .cal-grid{gap:3px!important;}
  .cal-day{min-height:60px!important;padding:2px!important;border-radius:4px!important;}
  .cal-number{font-size:.72rem!important;}
  .cal-event{font-size:.55rem!important;padding:1px 2px!important;margin-bottom:1px!important;}
  .cal-header{flex-wrap:wrap!important;gap:6px!important;}
  .cal-nav-btn{padding:8px 12px!important;font-size:.8rem!important;}

  /* Modals: full width bottom sheet */
  .modal-overlay{align-items:stretch!important;}
  .modal-box{max-width:100vw!important;width:100vw!important;height:100vh!important;max-height:100vh!important;margin:0!important;
    border-radius:0!important;padding:14px!important;padding-bottom:calc(14px + env(safe-area-inset-bottom, 0px))!important;overflow-y:auto!important;}
  .modal-header-xl{position:sticky;top:0;z-index:3;}
  .modal-footer-xl{position:sticky;bottom:0;z-index:3;}

  /* Frequency modal */
  .freq-table td,.freq-table th{padding:3px 2px!important;font-size:.68rem!important;}
  .freq-btn{width:34px!important;height:34px!important;font-size:.78rem!important;border-radius:6px!important;}
  .freq-header-row{flex-direction:column!important;gap:4px!important;}

  /* Planner */
  .planner-body{grid-template-columns:1fr!important;height:auto!important;}
  .planner-filters{grid-template-columns:1fr!important;gap:6px!important;}
  .planner-item{padding:8px!important;}

  /* Tables */
  .tabela-dados th,.tabela-dados td{padding:4px 3px!important;font-size:.7rem!important;}

  /* ATA / Diário overlays */
  .ata-container,.diario-container{padding:10px!important;max-height:95vh!important;width:100vw!important;max-width:100vw!important;margin:0!important;border-radius:12px 12px 0 0!important;}
  .ata-table{font-size:.6rem!important;}
  .ata-table th,.ata-table td{padding:2px 3px!important;}
  .diario-entry-body{grid-template-columns:1fr!important;gap:6px!important;}
  .comp-turmas-table th,.comp-turmas-table td{padding:4px 3px!important;font-size:.68rem!important;}

  /* Toast: full width on mobile */
  .toast-container{left:10px!important;right:10px!important;bottom:75px!important;}
  .toast{min-width:auto!important;width:100%!important;}

  /* Bottom nav bar for mobile */
  .mobile-nav{display:flex!important;}
}

/* === SMALL PHONE (<=480px) === */
@media(max-width:480px){
  .title-area h1{font-size:1rem!important;}
  .btn-bim{font-size:.65rem!important;padding:6px 2px!important;}
  .view-toggle{grid-template-columns:repeat(3,1fr)!important;}
  .tools-group{grid-template-columns:repeat(2,1fr)!important;}
  .cal-day{min-height:50px!important;}
  .cal-event{font-size:.5rem!important;}
  main .card-aluno{padding:10px;}
  .modal-box{padding:12px!important;}
}

/* Print support for overlays */
@media print{
  .diario-overlay,.diario-overlay *,.mensal-overlay-wrap,.mensal-overlay-wrap *{visibility:visible!important;}
  .diario-overlay,.mensal-overlay-wrap{position:fixed;inset:0;background:#fff!important;}
  .diario-container,.mensal-container-wrap{width:100%!important;max-width:100%!important;max-height:none!important;box-shadow:none!important;border-radius:0!important;overflow:visible!important;}
  .diario-overlay button,.mensal-overlay-wrap button,.sidebar-toggle,.sidebar-backdrop,.mobile-nav{display:none!important;}
  aside{display:none!important;}
  .mensal-table{font-size:.55rem!important;}
  .mensal-table th,.mensal-table td{padding:1px 2px!important;}
}

/* Mobile bottom navigation bar */
.mobile-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:var(--bg-sidebar);border-top:1px solid rgba(255,255,255,.1);
  padding:4px 0;padding-bottom:max(4px,env(safe-area-inset-bottom,4px));
  justify-content:space-around;align-items:center;gap:0;
  box-shadow:0 -2px 10px rgba(0,0,0,.2);
}
.mobile-nav button{
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
  background:none;border:none;color:#94a3b8;font-size:.6rem;padding:6px 4px;
  cursor:pointer;flex:1;min-height:44px;transition:.15s;border-radius:8px;
}
.mobile-nav button i{font-size:1.1rem;}
.mobile-nav button.active{color:#0ea5e9;}
.mobile-nav button:active{background:rgba(14,165,233,.1);}

/* Mobile: card lists for tables (Lista / Entregas) */
.mobile-table-cards{display:none;margin-top:10px;}
.mobile-table-cards .mcard{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);}
.mcard-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
.mcard-title{font-weight:800;font-size:.95rem;line-height:1.2;}
.mcard-sub{font-size:.75rem;color:#64748b;white-space:nowrap;}
.mcard-tags{display:flex;flex-wrap:wrap;gap:6px;}
.mchip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.5);font-size:.75rem;background:rgba(14,165,233,.06);}
.mchip b{font-weight:800;}
.mcard-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px;}
.mcheck{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border:1px solid rgba(148,163,184,.35);border-radius:10px;background:rgba(2,6,23,.02);}
.mcheck input{width:22px;height:22px;min-width:22px;}
.mcheck .lbl{display:flex;align-items:center;gap:10px;font-weight:700;font-size:.85rem;}
@media(max-width:768px){
  /* Keep table scroll contained (when still used) */
  .tabela-dados{display:block!important;overflow-x:auto!important;-webkit-overflow-scrolling:touch;max-width:100%!important;}
  .tabela-dados thead,.tabela-dados tbody{white-space:nowrap;}
  .tabela-dados th:first-child,.tabela-dados td:first-child{position:sticky;left:0;background:var(--card-bg);z-index:2;}
  /* Map gestures: pinch-to-zoom + pan */
  #salaGrid{transform-origin:0 0;will-change:transform;touch-action:none;}
  .sala-grid-wrap{overflow:hidden;}
}


/* F4: Diário de Classe */
.diario-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center;}
.diario-container{background:#fff;color:#1e293b;width:96vw;max-width:1100px;max-height:94vh;overflow-y:auto;border-radius:12px;padding:20px;position:relative;}
.diario-nav{display:flex;gap:6px;align-items:center;justify-content:center;margin:10px 0;flex-wrap:wrap;}
.diario-nav button{padding:6px 14px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer;font-size:.82rem;transition:.15s;}
.diario-nav button:hover,.diario-nav button.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9;}
.diario-entry{border:1px solid #e2e8f0;border-radius:10px;margin:10px 0;overflow:hidden;}
.diario-entry-header{background:#f1f5f9;padding:10px 14px;font-weight:600;font-size:.88rem;display:flex;justify-content:space-between;align-items:center;}
.diario-entry-body{padding:12px 14px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:768px){.diario-entry-body{grid-template-columns:1fr;}}
.diario-field{font-size:.82rem;}
.diario-field label{font-weight:600;color:#475569;display:block;margin-bottom:3px;font-size:.72rem;text-transform:uppercase;letter-spacing:.3px;}
.diario-chamada-mini{display:flex;gap:3px;flex-wrap:wrap;}
.diario-chamada-mini span{width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;}
.diario-chamada-mini span.P{background:#dcfce7;color:#166534;} .diario-chamada-mini span.F{background:#fee2e2;color:#991b1b;} .diario-chamada-mini span.J{background:#fef9c3;color:#854d0e;}

/* F10: Diário mensal imprimível */
.mensal-table{width:100%;border-collapse:collapse;font-size:.65rem;}
.mensal-table th,.mensal-table td{border:1px solid #cbd5e1;padding:2px 3px;text-align:center;min-width:22px;}
.mensal-table th{background:#f1f5f9;font-weight:600;}
.mensal-table td.P{background:#dcfce7;color:#166534;} .mensal-table td.F{background:#fee2e2;color:#991b1b;} .mensal-table td.J{background:#fef9c3;color:#854d0e;}
.mensal-table td.total{font-weight:700;background:#f8fafc;}

/* F8/F9: Comparativo turmas + evolução */
.comp-turmas-table{width:100%;border-collapse:collapse;margin:12px 0;}
.comp-turmas-table th,.comp-turmas-table td{padding:8px 10px;border:1px solid var(--border-color);font-size:.82rem;text-align:center;}
.comp-turmas-table th{background:rgba(14,165,233,.08);font-weight:600;}
.comp-turmas-table td:first-child{text-align:left;font-weight:600;}
.comp-turmas-bar{height:8px;border-radius:4px;background:#e2e8f0;overflow:hidden;min-width:60px;}
.comp-turmas-bar-fill{height:100%;border-radius:4px;transition:width .3s;}
.dash-evo-chart{margin:12px 0;padding:12px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;}

/* === V16: Enhanced Dashboard Stats === */
.dash-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;grid-column:1/-1;margin-bottom:2px;}
.dash-kpi{background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;padding:16px 18px;position:relative;overflow:hidden;transition:box-shadow .2s,transform .15s;}
.dash-kpi:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-2px);}
.dash-kpi-icon{position:absolute;top:12px;right:14px;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;opacity:.85;}
.dash-kpi-label{font-size:.7rem;color:#64748b;text-transform:uppercase;letter-spacing:.4px;font-weight:600;}
.dash-kpi-value{font-size:1.85rem;font-weight:900;margin:4px 0 2px;line-height:1.1;}
.dash-kpi-sub{font-size:.72rem;color:#94a3b8;}
.dash-kpi-delta{display:inline-flex;align-items:center;gap:3px;font-size:.7rem;font-weight:700;padding:2px 7px;border-radius:6px;margin-left:4px;}
.dash-kpi-delta.up{background:rgba(22,163,74,.1);color:#16a34a;}
.dash-kpi-delta.down{background:rgba(220,38,38,.1);color:#dc2626;}
.dash-kpi-delta.neutral{background:rgba(100,116,139,.1);color:#64748b;}

.dash-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;}
.dash-stat-item{text-align:center;padding:12px 8px;border-radius:10px;background:rgba(14,165,233,.04);border:1px solid rgba(14,165,233,.1);}
.dash-stat-item .stat-val{font-size:1.35rem;font-weight:800;color:var(--primary);}
.dash-stat-item .stat-lbl{font-size:.68rem;color:#64748b;margin-top:2px;text-transform:uppercase;letter-spacing:.3px;}

.dash-rank-list{list-style:none;padding:0;margin:0;}
.dash-rank-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:8px;margin-bottom:4px;font-size:.82rem;transition:background .15s;}
.dash-rank-item:hover{background:rgba(14,165,233,.06);}
.dash-rank-pos{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:800;color:#fff;flex-shrink:0;}
.dash-rank-pos.gold{background:linear-gradient(135deg,#f59e0b,#d97706);}
.dash-rank-pos.silver{background:linear-gradient(135deg,#94a3b8,#64748b);}
.dash-rank-pos.bronze{background:linear-gradient(135deg,#d97706,#92400e);}
.dash-rank-pos.normal{background:#cbd5e1;color:#475569;}
.dash-rank-pos.danger{background:#fca5a5;color:#991b1b;}
.dash-rank-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-main);}
.dash-rank-score{font-weight:800;font-size:.85rem;min-width:36px;text-align:right;}
.dash-rank-bar{flex:0 0 80px;height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden;}
.dash-rank-bar>div{height:100%;border-radius:3px;transition:width .4s;}

.dash-scatter-wrap{position:relative;width:100%;height:260px;}
.dash-scatter-wrap canvas{width:100%!important;height:100%!important;}

.dash-comp-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:6px;}
.dash-comp-col{display:flex;flex-direction:column;align-items:center;gap:4px;}
.dash-comp-bar-v{width:28px;border-radius:4px 4px 0 0;transition:height .4s;min-height:2px;}
.dash-comp-lbl{font-size:.65rem;color:#64748b;text-align:center;}
.dash-comp-val{font-size:.68rem;font-weight:700;}

@media(max-width:900px){.dash-kpi-row{grid-template-columns:repeat(2,1fr);}}
@media(max-width:500px){.dash-kpi-row{grid-template-columns:1fr;}.dash-kpi-value{font-size:1.4rem;}}

/* === V16B: Trajetória, Heatmap, BoxPlot, Voláteis, PDF === */
.dash-traj-list{list-style:none;padding:0;margin:0;max-height:380px;overflow-y:auto;}
.dash-traj-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;margin-bottom:3px;font-size:.8rem;transition:background .15s;}
.dash-traj-item:hover{background:rgba(14,165,233,.05);}
.dash-traj-arrow{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:900;flex-shrink:0;}
.dash-traj-arrow.up{background:rgba(22,163,74,.12);color:#16a34a;}
.dash-traj-arrow.down{background:rgba(220,38,38,.12);color:#dc2626;}
.dash-traj-arrow.stable{background:rgba(100,116,139,.1);color:#64748b;}
.dash-traj-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-main);font-weight:500;}
.dash-traj-vals{display:flex;align-items:center;gap:4px;font-size:.78rem;font-variant-numeric:tabular-nums;}
.dash-traj-old{color:#94a3b8;text-decoration:line-through;}
.dash-traj-new{font-weight:800;}
.dash-traj-delta{font-size:.7rem;font-weight:700;padding:1px 6px;border-radius:4px;}
.dash-traj-delta.pos{background:rgba(22,163,74,.1);color:#16a34a;}
.dash-traj-delta.neg{background:rgba(220,38,38,.1);color:#dc2626;}

.dash-heatmap-wrap{overflow-x:auto;overflow-y:auto;max-height:420px;border:1px solid var(--border-color);border-radius:10px;}
.dash-heatmap{border-collapse:collapse;font-size:.72rem;width:100%;}
.dash-heatmap th{position:sticky;top:0;background:var(--card-bg);padding:7px 6px;border-bottom:2px solid var(--border-color);font-weight:700;white-space:nowrap;z-index:2;font-size:.68rem;text-transform:uppercase;letter-spacing:.3px;color:#64748b;}
.dash-heatmap th:first-child{position:sticky;left:0;z-index:3;min-width:120px;}
.dash-heatmap td{padding:5px 6px;text-align:center;border-bottom:1px solid var(--border-color);font-weight:600;transition:all .15s;cursor:default;}
.dash-heatmap td:first-child{position:sticky;left:0;background:var(--card-bg);z-index:1;text-align:left;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;}
.dash-heatmap tr:hover td{filter:brightness(1.05);}

.dash-boxplot-wrap{position:relative;width:100%;height:220px;}
.dash-boxplot-wrap canvas{width:100%!important;height:100%!important;}

.dash-volatil-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:8px;margin-bottom:3px;font-size:.8rem;}
.dash-volatil-item:hover{background:rgba(245,158,11,.05);}
.dash-volatil-bar{flex:0 0 100px;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;}
.dash-volatil-bar>div{height:100%;border-radius:4px;transition:width .4s;}

.dash-pdf-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .15s;box-shadow:0 2px 8px rgba(124,58,237,.25);}
.dash-pdf-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.35);}

@media print{
  .v16-enhanced,.v16b-enhanced{break-inside:avoid;page-break-inside:avoid;}
  .dash-pdf-btn,.v15-freqalerts,.diagFab,#diagFab,.sidebar,.topbar,.dash-kpi:hover{box-shadow:none!important;transform:none!important;}
}
@media(max-width:700px){
  .dash-heatmap-wrap{max-height:300px;}
  .dash-traj-list{max-height:280px;}
}

/* ===== DASHBOARD ENHANCEMENTS V18 ===== */
.dash-quick-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;grid-column:1/-1;order:-20;padding:10px 0;}
.dash-quick-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:10px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .18s;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.dash-quick-btn:hover{border-color:var(--primary);color:var(--primary);box-shadow:0 2px 8px rgba(37,99,235,.12);transform:translateY(-1px);}
.dash-quick-btn i{font-size:.85rem;}
.dash-quick-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary);}
.dash-quick-btn.primary:hover{filter:brightness(1.1);color:#fff;}

.dash-bim-filter{display:inline-flex;gap:3px;margin-left:auto;}
.dash-bim-pill{padding:4px 12px;border-radius:16px;border:1px solid var(--border-color);background:transparent;color:#64748b;font-size:.75rem;font-weight:600;cursor:pointer;transition:.15s;}
.dash-bim-pill.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.dash-bim-pill:hover:not(.active){background:rgba(37,99,235,.06);}

.dash-section{grid-column:1/-1;margin-top:4px;}
.dash-section-header{display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;user-select:none;border-bottom:1px solid var(--border-color);margin-bottom:10px;}
.dash-section-header h4{margin:0;font-size:.82rem;color:#64748b;text-transform:uppercase;letter-spacing:.5px;flex:1;}
.dash-section-header .dash-section-toggle{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7rem;color:#94a3b8;transition:transform .2s;}
.dash-section-header .dash-section-toggle.collapsed{transform:rotate(-90deg);}
.dash-section-body{display:grid;grid-template-columns:inherit;gap:inherit;}
.dash-section-body.collapsed{display:none;}

.dash-progress-card{grid-column:1/-1;order:-5;}
.dash-progress-bar-wrap{height:10px;background:#f1f5f9;border-radius:6px;overflow:hidden;margin:6px 0;}
.dash-progress-bar-fill{height:100%;border-radius:6px;transition:width .5s;background:linear-gradient(90deg,#2563eb,#06b6d4);}
.dash-progress-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;}
.dash-progress-stat{font-size:.78rem;color:#64748b;}
.dash-progress-stat b{color:var(--text-color);}

.dash-highlights{grid-column:1/-1;order:-4;}
.dash-highlight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:8px;}
.dash-highlight-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--card-bg);transition:all .15s;}
.dash-highlight-item:hover{box-shadow:0 2px 8px rgba(0,0,0,.06);}
.dash-highlight-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.dash-highlight-info{flex:1;min-width:0;}
.dash-highlight-name{font-size:.78rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dash-highlight-desc{font-size:.68rem;color:#94a3b8;}

.dash-kpi.clickable{cursor:pointer;transition:all .18s;border-radius:12px;}
.dash-kpi.clickable:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-2px);background:rgba(14,165,233,.03);}
.dash-kpi.clickable::after{content:'Ver detalhes →';display:block;font-size:.62rem;color:#94a3b8;margin-top:4px;opacity:0;transition:opacity .18s;}
.dash-kpi.clickable:hover::after{opacity:1;}

.dash-agenda-card{grid-column:1/-1;order:-3;}
.dash-agenda-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:6px;margin-top:8px;}
.dash-agenda-day{padding:10px;border-radius:10px;border:1px solid var(--border-color);text-align:center;font-size:.78rem;transition:.15s;}
.dash-agenda-day.today{border-color:var(--primary);background:rgba(37,99,235,.04);box-shadow:0 0 0 1px var(--primary);}
.dash-agenda-day .day-label{font-weight:700;color:#64748b;font-size:.7rem;text-transform:uppercase;margin-bottom:4px;}
.dash-agenda-day .day-date{font-size:.68rem;color:#94a3b8;margin-bottom:6px;}
.dash-agenda-day .day-status{font-weight:700;font-size:.72rem;}
.dash-agenda-day .day-status.done{color:#16a34a;}.dash-agenda-day .day-status.pending{color:#f59e0b;}.dash-agenda-day .day-status.none{color:#cbd5e1;}

.dash-turma-rank{grid-column:1/-1;}
.dash-turma-rank-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px;}
.dash-turma-rank-item{padding:14px;border-radius:12px;border:1px solid var(--border-color);background:var(--card-bg);cursor:pointer;transition:.18s;}
.dash-turma-rank-item:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(37,99,235,.08);transform:translateY(-1px);}
.dash-turma-rank-item .trk-name{font-size:.9rem;font-weight:800;margin-bottom:8px;}
.dash-turma-rank-item .trk-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.72rem;}
.dash-turma-rank-item .trk-stat{display:flex;justify-content:space-between;}
.dash-turma-rank-item .trk-stat-val{font-weight:800;}
.dash-turma-minibar{height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden;margin-top:8px;}
.dash-turma-minibar>div{height:100%;border-radius:3px;transition:width .4s;}

.dash-skeleton{grid-column:1/-1;order:-100;display:flex;gap:14px;flex-wrap:wrap;}
.dash-skeleton-item{flex:1;min-width:140px;height:80px;background:linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 50%,#f1f5f9 75%);background-size:200% 100%;border-radius:12px;animation:dashSkeletonPulse 1.5s infinite;}
@keyframes dashSkeletonPulse{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

@media(max-width:700px){
  .dash-quick-actions{gap:6px;}.dash-quick-btn{padding:6px 10px;font-size:.74rem;}
  .dash-highlight-grid{grid-template-columns:1fr;}
  .dash-agenda-grid{grid-template-columns:repeat(3,1fr);}
  .dash-turma-rank-grid{grid-template-columns:1fr;}
}

/* ===== V15 GAME ENHANCEMENTS CSS ===== */

/* Score bar */
.act-scorebar{display:flex;gap:12px;align-items:center;padding:8px 12px;background:rgba(14,165,233,.06);border:1px solid rgba(14,165,233,.15);border-radius:10px;margin:8px 0;font-size:.82rem;flex-wrap:wrap;}
.act-scorebar .sc-item{display:flex;align-items:center;gap:4px;font-weight:600;}
.sc-correct{color:#16a34a;} .sc-wrong{color:#dc2626;} .sc-total{color:#0ea5e9;} .sc-pct{color:#7c3aed;}
.act-scorebar .sc-timer{margin-left:auto;font-variant-numeric:tabular-nums;font-weight:700;font-size:1rem;}
.sc-timer.warning{color:#f59e0b;animation:pulse .5s infinite alternate;}
.sc-timer.danger{color:#dc2626;animation:pulse .3s infinite alternate;}
@keyframes pulse{from{opacity:1}to{opacity:.5}}

/* Feedback animations */
@keyframes actConfetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(-60px) rotate(360deg);opacity:0}}
@keyframes actShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
@keyframes actFlashGreen{0%{box-shadow:0 0 0 0 rgba(22,163,74,.5)}100%{box-shadow:0 0 0 30px rgba(22,163,74,0)}}
@keyframes actFlashRed{0%{box-shadow:0 0 0 0 rgba(220,38,38,.5)}100%{box-shadow:0 0 0 30px rgba(220,38,38,0)}}
.act-feedback-correct{animation:actFlashGreen .5s ease-out;}
.act-feedback-wrong{animation:actShake .4s ease-out,actFlashRed .5s ease-out;}
.act-confetti-particle{position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;animation:actConfetti .8s ease-out forwards;}
.act-result-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4rem;font-weight:900;pointer-events:none;z-index:10;animation:fadeIn .2s ease-out;}
.act-result-overlay.correct{color:rgba(22,163,74,.3);} .act-result-overlay.wrong{color:rgba(220,38,38,.3);}

/* TV Mode (bigger everything for projector) */
#modalAtividades.act-tv .act-view .act-panel-body{font-size:1.1rem;}
#modalAtividades.act-tv .vf-btn{font-size:1.8rem!important;padding:24px 40px!important;min-width:180px!important;}
#modalAtividades.act-tv #vfShow{font-size:2rem!important;}
#modalAtividades.act-tv #forcaWord{font-size:2.5rem!important;letter-spacing:8px!important;}
#modalAtividades.act-tv .act-key{width:52px!important;height:52px!important;font-size:1.3rem!important;}
#modalAtividades.act-tv .act-mgrid{gap:10px!important;}
#modalAtividades.act-tv .mem-card{min-height:90px!important;font-size:1.2rem!important;}
#modalAtividades.act-tv #fcText{font-size:2rem!important;}
#modalAtividades.act-tv .act-scorebar{font-size:1rem;}
#modalAtividades.act-tv .quiz-option{font-size:1.3rem!important;padding:18px 24px!important;}
#modalAtividades.act-tv .comp-input{font-size:1.5rem!important;padding:14px!important;}
#modalAtividades.act-tv .ord-word{font-size:1.3rem!important;padding:14px 20px!important;}

/* Progress bar */
.act-progress{height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;width:100%;margin:4px 0;}
.act-progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#0ea5e9,#7c3aed);transition:width .3s;}

/* Timer config */
.act-timer-cfg{display:inline-flex;gap:4px;align-items:center;font-size:.78rem;}
.act-timer-cfg select{padding:4px 6px;border-radius:6px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);font-size:.78rem;}

/* Session end summary */
.act-summary{background:linear-gradient(135deg,rgba(14,165,233,.08),rgba(124,58,237,.08));border:1px solid rgba(14,165,233,.2);border-radius:12px;padding:16px;margin:10px 0;text-align:center;}
.act-summary h3{margin:0 0 8px;font-size:1.1rem;} .act-summary .big{font-size:2.5rem;font-weight:900;margin:8px 0;}
.act-summary .detail{font-size:.85rem;color:#64748b;margin:4px 0;}

/* Quiz game */
.quiz-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0;}
.quiz-option{padding:14px 18px;border:2px solid var(--border-color);border-radius:10px;background:var(--card-bg);cursor:pointer;font-size:1rem;font-weight:600;transition:.2s;text-align:left;}
.quiz-option:hover{border-color:#0ea5e9;transform:translateY(-1px);}
.quiz-option.correct{background:#dcfce7!important;border-color:#16a34a!important;color:#166534!important;}
.quiz-option.wrong{background:#fee2e2!important;border-color:#dc2626!important;color:#991b1b!important;}
.quiz-option.dimmed{opacity:.5;pointer-events:none;}
@media(max-width:600px){.quiz-options{grid-template-columns:1fr;}}

/* Complete phrase */
.comp-phrase{font-size:1.2rem;font-weight:600;line-height:1.6;margin:12px 0;}
.comp-blank{display:inline-block;border-bottom:3px solid #0ea5e9;min-width:80px;text-align:center;margin:0 4px;}
.comp-input{padding:10px;border:2px solid var(--border-color);border-radius:8px;font-size:1.1rem;width:100%;max-width:300px;margin:10px 0;}
.comp-input.correct{border-color:#16a34a;background:#dcfce7;} .comp-input.wrong{border-color:#dc2626;background:#fee2e2;}

/* Word order */
.ord-words{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:14px 0;min-height:50px;}
.ord-word{padding:10px 16px;background:var(--card-bg);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:.2s;user-select:none;}
.ord-word:hover{border-color:#0ea5e9;transform:translateY(-2px);}
.ord-word.placed{opacity:.3;pointer-events:none;}
.ord-answer{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:12px 0;min-height:50px;padding:10px;border:2px dashed var(--border-color);border-radius:10px;}
.ord-answer .ord-word{background:#eff6ff;border-color:#93c5fd;cursor:pointer;}
.ord-answer .ord-word.correct{background:#dcfce7;border-color:#16a34a;} .ord-answer .ord-word.wrong{background:#fee2e2;border-color:#dc2626;}

/* Leitner boxes */
.fc-leitner{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap;}
.fc-leitner button{padding:8px 14px;border:2px solid var(--border-color);border-radius:8px;background:var(--card-bg);cursor:pointer;font-weight:600;font-size:.85rem;transition:.2s;}
.fc-leitner .fc-l-wrong{border-color:#dc2626;color:#dc2626;} .fc-leitner .fc-l-ok{border-color:#f59e0b;color:#f59e0b;} .fc-leitner .fc-l-know{border-color:#16a34a;color:#16a34a;}
.fc-leitner button:hover{transform:translateY(-1px);}

/* Bulk import modal */
.bulk-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10001;display:flex;align-items:center;justify-content:center;}
.bulk-container{background:#fff;color:#1e293b;width:94vw;max-width:700px;max-height:90vh;overflow-y:auto;border-radius:14px;padding:20px;position:relative;}
body.dark-mode .bulk-container{background:#1e293b;color:#e2e8f0;}
.bulk-container h3{margin:0 0 8px;}
.bulk-textarea{width:100%;min-height:200px;padding:12px;border:2px solid #cbd5e1;border-radius:10px;font-family:monospace;font-size:.85rem;line-height:1.5;resize:vertical;background:var(--card-bg,#fff);color:var(--text-color,#1e293b);}
.bulk-textarea:focus{border-color:#7c3aed;outline:none;}
.bulk-hint{background:#f5f3ff;border:1px solid #ddd6fe;border-radius:8px;padding:10px 12px;margin:10px 0;font-size:.78rem;color:#5b21b6;line-height:1.6;}
body.dark-mode .bulk-hint{background:#2d2052;border-color:#5b21b6;color:#c4b5fd;}
.bulk-hint code{background:#ede9fe;padding:1px 5px;border-radius:3px;font-size:.75rem;}
body.dark-mode .bulk-hint code{background:#3b2d6e;}
.bulk-preview{margin:10px 0;padding:10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-size:.78rem;max-height:150px;overflow-y:auto;}
body.dark-mode .bulk-preview{background:#1a2e1a;border-color:#166534;}
.bulk-preview .bp-ok{color:#16a34a;} .bulk-preview .bp-err{color:#dc2626;}
.bulk-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}


</style>
</head>
<body>
    
    <button class="btn-zen-exit" data-onclick="toggleZenMode()"><i class="fas fa-compress"></i> Sair do Modo Foco</button>

    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Menu"><i class="fas fa-bars"></i></button>
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

    <aside>
        <div class="brand"><i class="fas fa-shapes"></i> SGP Pro</div>
        <div class="sidebar-title">Minhas Turmas</div>
        <ul id="listaTurmas"></ul>
        <button class="btn-add-turma" data-onclick="abrirModal('modalNovaTurma')"><i class="fas fa-plus"></i> Nova Turma</button>

        <div class="file-actions">
            <div id="backupAlert" class="backup-warning"><i class="fas fa-triangle-exclamation"></i> Backup pendente!</div>
            
            <div class="sidebar-title">Gestão</div>
            <button class="btn-file btn-save" data-onclick="baixarBackup()"><i class="fas fa-download"></i> Baixar Dados</button>
            <button class="btn-file btn-load" data-onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Abrir Arquivo</button>
            <input type="file" id="fileInput" style="display: none;" data-onchange="carregarBackup(this)">
            <button class="btn-file btn-excel" data-onclick="exportarCSV()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
            <button class="btn-file btn-load" data-onclick="abrirModalImportCSV()" style="background:#059669;color:#fff;"><i class="fas fa-file-arrow-up"></i> Importar CSV</button>
            <button class="btn-file btn-copy" data-onclick="abrirModalCopiarTabela()"><i class="fas fa-copy"></i> Copiar Tabela</button>
            <button class="btn-file btn-config" data-onclick="abrirConfig()"><i class="fas fa-cog"></i> Configurações</button>
            <button class="btn-file btn-dark" data-onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Noturno</button>
        </div>
    </aside>

    <main>
        <div class="top-bar">
            <!-- Linha Superior: Título e Bimestre -->
            <div class="top-row">
                <div class="title-area">
                    <h1 id="tituloPrincipal">Visão Geral</h1>
                    <div class="title-subtitle">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Sistema de Gestão Pedagógica</span>
                    </div>
                </div>
                
                <div class="bimestre-selector">
                    <button id="btnBim1" class="btn-bim active" data-onclick="mudarBimestre(1)">
                        <i class="fas fa-1"></i> 1º Bim
                    </button>
                    <button id="btnBim2" class="btn-bim" data-onclick="mudarBimestre(2)">
                        <i class="fas fa-2"></i> 2º Bim
                    </button>
                    <button id="btnBim3" class="btn-bim" data-onclick="mudarBimestre(3)">
                        <i class="fas fa-3"></i> 3º Bim
                    </button>
                    <button id="btnBim4" class="btn-bim" data-onclick="mudarBimestre(4)">
                        <i class="fas fa-4"></i> 4º Bim
                    </button>
                </div>
                <button id="btnAutoTest" class="btn-primary" style="padding:10px 14px;border-radius:10px;font-size:0.9rem;white-space:nowrap;" data-onclick="executarAutoTeste()"><i class="fas fa-stethoscope"></i> AutoTeste</button>
            </div>
            
            <!-- Linha de Controles -->
            <div class="controls-section">
                <!-- Grupo: Visualizações -->
                <div class="control-group">
                    <span class="control-label"><i class="fas fa-eye"></i> Visão</span>
                    <div class="view-toggle">
                        <button id="btnViewCards" class="btn-view active" data-onclick="mudarVisao('cards')" title="Cards">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="btnViewLista" class="btn-view" data-onclick="mudarVisao('lista')" title="Lista SED">
                            <i class="fas fa-list"></i>
                        </button>
                        <button id="btnViewMassa" class="btn-view" data-onclick="mudarVisao('massa')" title="Edição em Massa">
                            <i class="fas fa-table"></i>
                        </button>
                        <button id="btnViewEntregas" class="btn-view" data-onclick="mudarVisao('entregas')" title="Entregas">
                            <i class="fas fa-check-double"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grupo: Análises -->
                <div class="control-group">
                    <span class="control-label"><i class="fas fa-chart-line"></i> Análise</span>
                    <div class="view-toggle cols-5">
                        <button id="btnViewAnual" class="btn-view" data-onclick="mudarVisao('anual')" title="Conselho (Anual)">
                            <i class="fas fa-graduation-cap"></i>
                        </button>
                        <button id="btnViewDash" class="btn-view" data-onclick="mudarVisao('dash')" title="Dashboard">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                        <button id="btnViewCorrecao" class="btn-view" data-onclick="mudarVisao('correcao')" title="Correção (Provas/Atividades)">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <button id="btnViewAulas" class="btn-view" data-onclick="mudarVisao('aulas')" title="Cronograma">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </button>
                        <button id="btnViewCalendar" class="btn-view" data-onclick="mudarVisao('calendar')" title="Calendário">
                            <i class="far fa-calendar-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grupo: Mapa & Ranking -->
                <div class="control-group">
                    <span class="control-label"><i class="fas fa-map"></i> Layout</span>
                    <div class="view-toggle">
                        <button id="btnViewMapa" class="btn-view" data-onclick="mudarVisao('mapa')" title="Mapa de Sala">
                            <i class="fas fa-border-all"></i>
                        </button>
                        <button id="btnViewRanking" class="btn-view" data-onclick="mudarVisao('ranking')" title="Ranking da Sala">
                            <i class="fas fa-trophy"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grupo: Ferramentas -->
                <div class="tools-group">
                    <button class="btn-tool" data-onclick="toggleZenMode()" title="Modo Foco">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="btn-tool" data-onclick="abrirTimer()" title="Cronômetro">
                        <i class="fas fa-stopwatch"></i>
                    </button>
                    <button class="btn-tool" id="btnPlannerTool" data-onclick="abrirPlanner()" title="Planner">
                        <i class="fas fa-clipboard-list"></i><span id="plannerBadge" class="planner-badge" style="display:none;">0</span>
                    </button>
                    <button class="btn-tool" data-onclick="abrirFrequencia()" title="Chamada/Frequência">
                        <i class="fas fa-clipboard-check"></i>
                    </button>
                    <button class="btn-tool" data-onclick="abrirAtividades()" title="Atividades">
                        <i class="fas fa-gamepad"></i>
                    </button>
                    <button class="btn-tool" data-onclick="sortearAluno()" title="Sorteio">
                        <i class="fas fa-dice"></i>
                    </button>
                    <button class="btn-tool" data-onclick="abrirGeradorGrupos()" title="Gerar Grupos">
                        <i class="fas fa-users-cog"></i>
                    </button>
                    <button class="btn-tool" id="btnPrivacy" data-onclick="togglePrivacy()" title="Privacidade">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
                
                <!-- Grupo: Filtros -->
                <div class="filters-group">
                    <button id="btnFiltroInclusao" class="btn-inclusao" data-onclick="toggleFiltroInclusao()">
                        <i class="fas fa-universal-access"></i> Elegivel
                    </button>
                    <button id="btnFiltroRisco" class="btn-risco" data-onclick="toggleFiltroRisco()">
                        <i class="fas fa-exclamation-triangle"></i> Risco
                    </button>
                </div>
                
                <!-- Botão Principal -->
                <button class="btn-primary" data-onclick="abrirModalAluno()">
                    <i class="fas fa-user-plus"></i> Novo Aluno
                </button>
            </div>
        </div>

        <!-- BUSCA GLOBAL -->
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchGlobal" class="search-bar" placeholder="Buscar alunos, aulas, planner, registros..." data-oninput="aplicarBuscaGlobal()">
            <button class="search-clear" id="searchClear" data-onclick="limparBusca()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="bannerRisco" class="banner-risco" style="display:none;"><span><i class="fas fa-search"></i> Busca Ativa</span><button class="btn-copy-risco" data-onclick="copiarListaRisco()"><i class="fab fa-whatsapp"></i> Copiar</button></div>

        <!-- V13: Advanced Search Filters -->
        <div class="search-filters-row" id="searchFiltersRow">
            <span style="font-size:0.75rem;color:#64748b;">Filtros:</span>
            <button class="search-filter-chip" id="sfMedia5" data-onclick="toggleSearchFilter('media5')"><i class="fas fa-exclamation-triangle"></i> Média &lt; 5</button>
            <button class="search-filter-chip" id="sfMedia7" data-onclick="toggleSearchFilter('media7')"><i class="fas fa-chart-line"></i> Média &lt; 7</button>
            <button class="search-filter-chip" id="sfOcorrencia" data-onclick="toggleSearchFilter('ocorrencia')"><i class="fas fa-flag"></i> Com ocorrência</button>
            <button class="search-filter-chip" id="sfComportamento" data-onclick="toggleSearchFilter('comportamento')"><i class="fas fa-user-slash"></i> Comportamento &lt; 7</button>
            <button class="search-filter-chip" id="sfFreqBaixa" data-onclick="toggleSearchFilter('freqBaixa')"><i class="fas fa-clock"></i> Frequência &lt; 75%</button>
            <button class="search-filter-chip" id="sfBoletim" data-onclick="gerarBoletimTurma()" style="border-color:#8b5cf6;color:#8b5cf6;"><i class="fas fa-print"></i> Boletim Turma</button>
            <button class="search-filter-chip" id="sfAta" data-onclick="gerarAtaTurma()" style="border-color:#0ea5e9;color:#0ea5e9;"><i class="fas fa-file-signature"></i> Ata da Turma</button>
            <button class="search-filter-chip" id="sfDiario" data-onclick="abrirDiarioClasse()" style="border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-book-open"></i> Diário</button>
            <button class="search-filter-chip" id="sfMensal" data-onclick="abrirDiarioMensal()" style="border-color:#0d9488;color:#0d9488;"><i class="fas fa-calendar-check"></i> Mensal</button>
            <button class="search-filter-chip" id="sfAtividades" data-onclick="abrirControleEntregas()" style="border-color:#16a34a;color:#16a34a;"><i class="fas fa-list-check"></i> Entregas</button>
            <button class="search-filter-chip" id="sfAudit" data-onclick="abrirAuditTrail()" style="border-color:#64748b;color:#64748b;"><i class="fas fa-clock"></i> Histórico</button>
        </div>

        <div id="gridAlunos" class="grid-alunos"></div>
        <table id="tabelaFechamento" class="tabela-dados"><thead><tr><th>#</th><th>Nome</th><th>Turma</th><th class="lbl-mat1">Média 1</th><th class="lbl-mat2">Média 2</th><th>Comp.</th></tr></thead><tbody id="tbodyFechamento"></tbody></table>
        <div id="mobileFechamentoCards" class="mobile-table-cards" style="display:none;"></div>

        
        <!-- NOVA VIEW: EDIÇÃO EM MASSA -->
        <div id="viewMassa" style="display:none;">
            <h2 style="margin-bottom:8px; color:var(--text-main);"><i class="fas fa-edit"></i> Edição em Massa de Notas</h2>
            <p class="massa-subtitle">Edite as notas de múltiplos alunos simultaneamente. Use Tab/Enter/setas para navegar entre células.</p>

            <div id="massaUnsavedBar" class="massa-unsaved-bar">
                <i class="fas fa-exclamation-triangle"></i> Alterações não salvas
                <span class="massa-auto-save-hint">Auto-save em breve...</span>
                <button class="massa-tool-btn" onclick="salvarEdicaoMassa()" style="margin-left:8px;background:var(--farol-verde);color:#fff;border:none;"><i class="fas fa-save"></i> Salvar agora</button>
            </div>

            <div class="massa-toolbar">
                <div class="massa-disc-nav" id="massaDiscNav"></div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn-massa-fs" id="btnMassaFullscreen" data-onclick="massaToggleFullscreen()" title="Tela cheia">
                        <i class="fas fa-expand"></i> Tela cheia
                    </button>
                    <button id="btnSalvarMassaInline" class="btn-salvar-massa-inline" data-onclick="salvarEdicaoMassa()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>

            <div class="massa-toolbar-extra" id="massaToolbarExtra">
                <button class="massa-tool-btn" onclick="__massaImportCSV()" title="Importar notas de arquivo CSV"><i class="fas fa-file-import"></i> Importar CSV</button>
                <button class="massa-tool-btn" onclick="__massaExportCSV()" title="Exportar notas como CSV"><i class="fas fa-file-export"></i> Exportar CSV</button>
            </div>

            <div id="massaProgressBar" class="massa-progress"></div>

            <div class="massa-search-wrap">
                <i class="fas fa-search"></i>
                <input type="text" id="massaSearchInput" placeholder="Buscar aluno..." oninput="__massaFilterBySearch()">
            </div>

            <div id="massaDiscTitle" class="massa-subtitle"></div>

            <div class="massa-table-wrap">
                <table class="tabela-dados" style="display:table;">
                    <thead>
                        <tr id="trMassaHead"></tr>
</thead>
                    <tbody id="tbodyMassa"></tbody>
                </table>
            </div>
</div>
        <button id="btnSalvarMassa" class="btn-salvar-massa" data-onclick="salvarEdicaoMassa()">
            <i class="fas fa-save"></i> Salvar Alterações
        </button>

        <table id="tabelaEntregas" class="tabela-dados"><thead><tr><th>#</th><th>Nome</th><th>Turma</th><th>Redação 1</th><th>Redação 2</th></tr></thead><tbody id="tbodyEntregas"></tbody></table>
        <div id="mobileEntregasCards" class="mobile-table-cards" style="display:none;"></div>


        <div id="viewAnual" class="anual-container" style="display:none;">
            <h2 style="margin-bottom:15px; color:var(--text-main);">Conselho de Classe (Anual) - <span class="lbl-mat1">Matéria 1</span></h2>
            <div style="margin-bottom: 10px; color: #64748b; font-size: 0.9rem;">
                <i class="fas fa-calculator"></i> Simulador: "Pts Faltantes" considera aprovação com 20 pontos totais (Média 5.0).
            </div>
            <table class="tabela-dados">
                <thead>
                    <tr><th>#</th><th>Nome</th><th>1º Bim</th><th>2º Bim</th><th>3º Bim</th><th>4º Bim</th><th>Média Final</th><th>Pts Faltantes</th><th>Situação</th></tr>
                </thead>
                <tbody id="tbodyAnual"></tbody>
            </table>
        </div>

        <div id="viewAulas" class="aulas-container">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div><h2 style="color:var(--text-main);">Cronograma</h2></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-tool" data-onclick="clonarAulas()" title="Copiar"><i class="fas fa-copy"></i> Importar</button>
                    <button class="btn-primary" style="background:#475569;" data-onclick="abrirPlanoSemanal()"><i class="fas fa-clipboard-list"></i> Plano Semanal</button>
                    <button class="btn-primary" style="background:#475569;" data-onclick="abrirModal('modalAulasLote')">Lote</button>
                </div>
            </div>
            <div class="progress-container"><div id="progressBarAulas" class="progress-bar"></div><div id="progressTextAulas" class="progress-text">0%</div></div>
            <div class="add-aula-panel">
                <input type="text" id="inputBNCC" class="inp" placeholder="Cód. BNCC (Ex: EF69LP01)" style="width: 160px; margin-right: 10px;">
                <input type="text" id="inputNovaAula" class="inp" placeholder="Tema..." style="flex:1;">
                <select id="inputBloomNivel" class="inp" style="width: 170px;" data-onchange="onBloomNivelChangeCrono()">
                    <option value="">Bloom (nível)</option>
                    <option value="Lembrar">Lembrar</option>
                    <option value="Compreender">Compreender</option>
                    <option value="Aplicar">Aplicar</option>
                    <option value="Analisar">Analisar</option>
                    <option value="Avaliar">Avaliar</option>
                    <option value="Criar">Criar</option>
                </select>
                <input type="text" id="inputBloomVerbo" class="inp" placeholder="Verbo (Bloom)" style="width: 170px;" list="dlBloomVerbosCrono">
                <datalist id="dlBloomVerbosCrono"></datalist>
                <button class="btn-primary" data-onclick="addAulaIndividual()">Add</button>
            </div>
            
            <!-- Aplicação geral (BNCC + Tema) em múltiplas turmas -->
            <div id="aulaGeralBox" style="margin-top:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text-muted); user-select:none;">
                    <input type="checkbox" id="aulaModoGeral" data-onchange="toggleAulaModoGeral(this.checked)">
                    Aplicar em várias turmas (geral)
                </label>
                <div id="aulaTurmasActions" style="display:none; margin-top:8px; gap:8px; flex-wrap:wrap; align-items:center;">
    <button class="btn-primary" style="padding:6px 10px; font-size:12px; background:#475569;" data-onclick="aulaSelecionarTodasTurmas();return false;"><i class="fas fa-check-double"></i> Marcar todas</button>
    <button class="btn-primary" style="padding:6px 10px; font-size:12px; background:#475569;" data-onclick="aulaLimparSelecaoTurmas();return false;"><i class="fas fa-eraser"></i> Limpar</button>
</div>
<div id="aulaTurmasChecklist" style="display:none; margin-top:8px; max-height:160px; overflow:auto; padding-right:6px; border:1px solid var(--border-color); border-radius:12px; padding:10px; background:var(--card-bg);"></div>
                <div id="aulaAplicarStatus" style="margin-top:6px; font-size:12px; color:var(--text-muted);"></div>
            </div>

            <div id="listaDeAulas" style="display:flex; flex-direction:column;"></div>
        </div>

        <div id="viewCalendar" class="calendar-container">
            <div class="cal-header"><button class="cal-nav-btn" data-onclick="mudarMes(-1)">Anterior</button><h2 id="lblMesAno">Mês Ano</h2><button class="cal-nav-btn" data-onclick="mudarMes(1)">Próximo</button></div>
            <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:4px 0 8px;font-size:.72rem;">
              <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#3b82f6;"></span> Aula</span>
              <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#dc2626;"></span> Prova</span>
              <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#9333ea;"></span> Atividade</span>
              <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#f59e0b;"></span> Planner</span>
              <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#0d9488;"></span> Chamada</span>
            </div>
            <div class="cal-grid" id="calendarGrid"></div>
        </div>

        <div id="viewDashboard" class="dash-container">
            <div class="dash-card"><h3>Total</h3><div id="dashTotal" class="big-number">0</div></div>
            <div class="dash-card"><h3 class="lbl-mat1">Matéria 1</h3><div class="bar-row"><div class="bar-label"><span>Verde</span><span id="txtLpVerde">0%</span></div><div class="bar-bg"><div id="barLpVerde" class="bar-fill" style="background:var(--farol-verde);width:0%;"></div></div></div><div class="bar-row"><div class="bar-label"><span>Amarelo</span><span id="txtLpAma">0%</span></div><div class="bar-bg"><div id="barLpAma" class="bar-fill" style="background:var(--farol-amarelo);width:0%;"></div></div></div><div class="bar-row"><div class="bar-label"><span>Vermelho</span><span id="txtLpVerm">0%</span></div><div class="bar-bg"><div id="barLpVerm" class="bar-fill" style="background:var(--farol-vermelho);width:0%;"></div></div></div></div>
            <div class="dash-card"><h3 class="lbl-mat2">Matéria 2</h3><div class="bar-row"><div class="bar-label"><span>Verde</span><span id="txtRedVerde">0%</span></div><div class="bar-bg"><div id="barRedVerde" class="bar-fill" style="background:var(--farol-verde);width:0%;"></div></div></div><div class="bar-row"><div class="bar-label"><span>Amarelo</span><span id="txtRedAma">0%</span></div><div class="bar-bg"><div id="barRedAma" class="bar-fill" style="background:var(--farol-amarelo);width:0%;"></div></div></div><div class="bar-row"><div class="bar-label"><span>Vermelho</span><span id="txtRedVerm">0%</span></div><div class="bar-bg"><div id="barRedVerm" class="bar-fill" style="background:var(--farol-vermelho);width:0%;"></div></div></div></div>

            <div class="dash-card wide">
                <h3>Gráfico de Médias (por Bimestre)</h3>
                <div class="dash-chart-box">
                    <canvas id="dashChartBimestres"></canvas>
                </div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:8px;">
                    Considera os alunos filtrados (turma selecionada) e as médias registradas em cada bimestre.
                </div>
            </div>

            <!-- V13: Pie Charts -->
            <div class="dash-card chart-pie">
                <h3>Distribuição por Farol — <span class="lbl-mat1">Matéria 1</span></h3>
                <div class="dash-chart-pie-wrap"><canvas id="dashPieMat1"></canvas></div>
            </div>
            <div class="dash-card chart-pie">
                <h3>Distribuição por Farol — <span class="lbl-mat2">Matéria 2</span></h3>
                <div class="dash-chart-pie-wrap"><canvas id="dashPieMat2"></canvas></div>
            </div>
            <div class="dash-card wide">
                <h3>Histograma de Notas — <span class="lbl-mat1">Matéria 1</span></h3>
                <div class="dash-chart-box"><canvas id="dashHistMat1"></canvas></div>
            </div>
            <div class="dash-card wide">
                <h3>Histograma de Notas — <span class="lbl-mat2">Matéria 2</span></h3>
                <div class="dash-chart-box"><canvas id="dashHistMat2"></canvas></div>
            </div>
        
            <div class="dash-card wide" id="dashCompareTurmas">
                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                    <h3 style="margin:0;">Comparar turmas</h3>
                    <div class="dash-compare-controls">
                        <label>Bimestre
                            <select id="cmpTurmasBim" aria-label="Bimestre"></select>
                        </label>
                        <label>Disciplina
                            <select id="cmpTurmasDisc" aria-label="Disciplina"></select>
                        </label>
                        <label>Métrica
                            <select id="cmpTurmasMetric" aria-label="Métrica"></select>
                        </label>
                        <button class="btn btn-secondary" id="btnCmpTurmasAtualizar" type="button" title="Atualizar">
                            <i class="fas fa-rotate"></i>
                        </button>
                    </div>
                </div>
                <div id="cmpTurmasSummary" style="margin-top:8px; font-size:0.85rem; color:#64748b;"></div>
                <div style="margin-top:12px; overflow:auto; border:1px solid var(--border-color); border-radius:12px;">
                    <table id="cmpTurmasTable" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border-color);">#</th>
                                <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border-color);">Turma</th>
                                <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border-color);">Alunos</th>
                                <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border-color);">Média</th>
                                <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border-color);">Distribuição</th>
                            </tr>
                        </thead>
                        <tbody id="cmpTurmasTbody"></tbody>
                    </table>
                </div>
            </div>

        </div>

        
        <div id="viewCorrecao" class="correcao-container" style="display:none;">
            <div class="correcao-head">
                <div>
                    <h2 style="margin:0; color:var(--text-main);">Correção de Provas/Atividades</h2>
                    <div class="sub" style="margin-top:4px;">Defina o gabarito e corrija por aluno. As estatísticas são geradas automaticamente por turma.</div>
                </div>
                <div class="correcao-head-controls">
                    <label class="mini-label">Turma
                        <select id="corTurmaSelect" class="inp"></select>
                    </label>
                    <label class="mini-label">Prova
    <div class="cor-prova-row">
        <select id="corProvaSelect" class="inp"></select>
        <button class="btn-tool" data-onclick="corRenomearProva()" title="Renomear prova"><i class="fas fa-pen"></i></button>
        <button class="btn-tool" data-onclick="corExcluirProva()" title="Excluir prova" style="color:#dc2626;"><i class="fas fa-trash"></i></button>
    </div>
</label>
                    <button class="btn btn-primary" id="corNovaProvaBtn" data-onclick="corNovaProva()"><i class="fas fa-plus"></i> Nova Prova</button>
                    <button class="btn-tool" data-onclick="corPrintList()" title="Imprimir lista de resultados" style="font-size:1.05rem;"><i class="fas fa-print"></i></button>
                </div>
                <div id="corDiscBadge" style="width:100%;margin-top:2px;"></div>
            </div>

            <div class="correcao-grid">
                <div class="card">
                    <div class="card-top">
                        <h3>Gabarito e referência (BNCC/Aula)</h3>
                        <div class="hint">10 questões (A–D). Edite o gabarito e o código/ aula associado a cada questão.</div>
                    </div>
                    <div class="cor-table-wrap">
                        <table class="tabela-fixa cor-table">
                            <thead>
                                <tr>
                                    <th style="width:70px;">Questão</th>
                                    <th style="width:140px;">Gabarito</th>
                                    <th>Código BNCC / Aula</th>
                                </tr>
                            </thead>
                            <tbody id="corGabaritoTbody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-top">
                        <h3>Respostas do aluno</h3>
                        <div class="hint">Digite ou selecione A, B, C ou D. O campo fica verde se acertou e vermelho se errou.</div>
                    </div>

                    <div class="cor-aluno-controls">
                        <label class="mini-label">Aluno
                            <select id="corAlunoSelect" class="inp"></select>
                        </label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <div class="cor-acertos">
                                <span>Acertos:</span>
                                <strong id="corAcertosLbl">0/10</strong>
                            </div>
                            <div class="cor-nota-final" id="corNotaFinalBox">
                                <span>Nota:</span>
                                <span class="cor-nota-val" id="corNotaFinalLbl">0.0</span>
                            </div>
                        </div>
                    </div>

                    <div class="cor-respostas" id="corRespostasGrid"></div>
                    <div class="cor-legend">
                        <span class="leg ok">Acerto</span>
                        <span class="leg no">Erro</span>
                        <span class="leg na">Em branco</span>
                    </div>
                </div>

                <div class="card wide">
                    <div class="card-top">
                        <h3>Estatísticas da turma</h3>
                        <div class="hint">Percentual de acerto por questão e por código BNCC/Aula (considera apenas alunos com respostas registradas).</div>
                    </div>

                    <div class="cor-stats-grid">
                        <div class="cor-stat-block">
                            <h4>Por questão</h4>
                            <div class="cor-chart-box"><canvas id="corChartQuestoes"></canvas></div>
                            <div class="cor-table-wrap">
                                <table class="tabela-fixa">
                                    <thead><tr><th>Questão</th><th>Acertos</th><th>Erros</th><th>% Acerto</th></tr></thead>
                                    <tbody id="corStatsQuestoesTbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="cor-stat-block">
                            <h4>Por BNCC/Aula</h4>
                            <div class="cor-chart-box"><canvas id="corChartBNCC"></canvas></div>
                            <div class="cor-table-wrap">
                                <table class="tabela-fixa">
                                    <thead><tr><th>BNCC/Aula</th><th>Acertos</th><th>Erros</th><th>% Acerto</th></tr></thead>
                                    <tbody id="corStatsBnccTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div id="corPrintArea" style="display:none;"></div>
        </div>

<div id="viewMapa" class="mapa-container">
            <div class="mapa-livres"><div class="mapa-livres-header">Alunos sem carteira</div><div id="listaAlunosLivres" class="lista-livres" ondrop="dropLivre(event)" ondragover="allowDrop(event)"></div></div>
            <div class="sala-grid-wrap">
                <div class="mapa-controls" style="flex-wrap:wrap;gap:6px;">
                    <select id="mapaGridSize" class="inp" style="width:auto;padding:4px 6px;font-size:.78rem;" data-onchange="mapaChangeGrid()">
                        <option value="6x6">6×6 (36)</option>
                        <option value="6x7">6×7 (42)</option>
                        <option value="5x5">5×5 (25)</option>
                        <option value="7x5">7×5 (35)</option>
                        <option value="4x8">4×8 (32)</option>
                        <option value="5x8">5×8 (40)</option>
                    </select>
                    <button class="btn-tool" data-onclick="mapaAutoDistribuir()" title="Distribuir automaticamente"><i class="fas fa-wand-magic-sparkles"></i></button>
                    <button id="btnMapaSwap" class="btn-tool" data-onclick="mapaToggleSwap()" title="Trocar 2 alunos de lugar"><i class="fas fa-arrows-rotate"></i></button>
                    <button class="btn-tool" data-onclick="mapaToggleDisable()" title="Desabilitar/habilitar mesas"><i class="fas fa-square-minus"></i></button>
                    <button class="btn-tool" data-onclick="mapaImprimir()" title="Imprimir mapa"><i class="fas fa-print"></i></button>
                    <span style="border-left:1px solid var(--border-color);height:20px;"></span>
                    <input type="text" id="inputNomeLayout" placeholder="Cenário..." style="padding:4px 6px;width:100px;font-size:.78rem;">
                    <button class="btn-tool" data-onclick="salvarLayout()"><i class="fas fa-save"></i></button>
                    <select id="selectLayouts" data-onchange="carregarLayout()"><option value="">Carregar...</option></select>
                    <button class="btn-tool" data-onclick="apagarLayout()" style="color:red;"><i class="fas fa-trash"></i></button>
                    <button id="btnMapaResetZoom" class="btn-tool" data-onclick="mapaResetZoom()" title="Reset zoom"><i class="fas fa-rotate-left"></i></button>
                    <button id="btnMapaFullscreen" class="btn-tool" data-onclick="mapaToggleFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i></button>
                </div>
                <div id="mapaSwapMsg" style="display:none;padding:4px 10px;background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;font-size:.78rem;text-align:center;color:#92400e;">🔄 Modo troca: clique em 2 alunos para trocar de lugar. Clique ↻ para sair.</div>
<div id="salaGrid" class="sala-grid"></div>
                <div class="mesa-prof-row"><div class="mesa-prof" aria-hidden="true"><i class="fas fa-user-tie"></i><span>Mesa do Professor</span></div></div>
            </div>
        </div>

        <!-- ===== RANKING VIEW ===== -->
        <div id="viewRanking" class="ranking-container" style="display:none;">
            <div class="ranking-header-bar">
                <div class="ranking-title-row">
                    <div class="ranking-title"><i class="fas fa-trophy"></i> Ranking da Sala</div>
                    <div class="ranking-controls">
                        <select id="rankCategoria" class="inp ranking-select" data-onchange="renderizarRanking()">
                            <option value="total">Pontuação Total</option>
                            <option value="notas">Notas</option>
                            <option value="comportamento">Comportamento</option>
                            <option value="participacao">Participação</option>
                            <option value="bonus">Bônus</option>
                        </select>
                        <button class="btn-tool" data-onclick="rankAddPontosModal()" title="Adicionar pontos"><i class="fas fa-plus-circle"></i></button>
                        <button class="btn-tool" data-onclick="rankHistoricoSemanalAbrir()" title="Histórico Semanal"><i class="fas fa-calendar-week"></i></button>
                        <button class="btn-tool" data-onclick="rankExportarPDF()" title="Exportar ranking"><i class="fas fa-file-export"></i></button>
                        <button class="btn-tool" data-onclick="rankResetar()" title="Resetar pontos"><i class="fas fa-rotate-left"></i></button>
                        <button id="btnRankFullscreen" class="btn-tool" data-onclick="rankToggleFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="ranking-badges-row" id="rankBadgesRow"></div>
            </div>
            <div class="ranking-scroll-body" id="rankScrollBody">
                <div class="ranking-podium-section" id="rankPodium"></div>
                <div class="ranking-scroll-hint" id="rankScrollHint" onclick="document.getElementById('rankList').scrollIntoView({behavior:'smooth'})">
                    <i class="fas fa-chevron-down"></i> Ver ranking completo <i class="fas fa-chevron-down"></i>
                </div>
                <div class="ranking-divider"></div>
                <div class="ranking-list-section" id="rankList"></div>
            </div>
        </div>

        <!-- Modal: Adicionar Pontos -->
        <div id="modalRankPontos" class="modal-overlay" style="display:none;">
            <div class="modal-box" style="max-width:520px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;color:var(--text-main);font-size:1.2rem;"><i class="fas fa-star" style="color:var(--warning);"></i> Adicionar Pontos</h3>
                    <button data-onclick="fecharModalRankPontos()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">✕</button>
                </div>
                <div class="rank-modal-body">
                    <label class="rank-label">Aluno(s)</label>
                    <select id="rankPontosAluno" class="inp" multiple style="min-height:120px;">
                    </select>
                    <div class="rank-pts-grid">
                        <div>
                            <label class="rank-label">Categoria</label>
                            <select id="rankPontosCategoria" class="inp">
                                <option value="notas">Notas</option>
                                <option value="comportamento">Comportamento</option>
                                <option value="participacao">Participação</option>
                                <option value="bonus">Bônus</option>
                            </select>
                        </div>
                        <div>
                            <label class="rank-label">Pontos</label>
                            <div class="rank-pts-row">
                                <button class="rank-quick-btn" data-onclick="rankSetPontos(1)">+1</button>
                                <button class="rank-quick-btn" data-onclick="rankSetPontos(2)">+2</button>
                                <button class="rank-quick-btn" data-onclick="rankSetPontos(5)">+5</button>
                                <button class="rank-quick-btn" data-onclick="rankSetPontos(10)">+10</button>
                                <input type="number" id="rankPontosValor" class="inp" min="-50" max="100" value="1" style="width:60px;text-align:center;">
                            </div>
                        </div>
                    </div>
                    <label class="rank-label">Motivo / Atividade (opcional)</label>
                    <input type="text" id="rankPontosMotivo" class="inp" placeholder="Ex: Quiz Frações (Aula 3)...">
                </div>
                <div style="display:flex;gap:10px;margin-top:16px;">
                    <button class="btn-primary" data-onclick="rankConfirmarPontos()" style="flex:1;"><i class="fas fa-check"></i> Confirmar</button>
                    <button class="btn-tool" data-onclick="fecharModalRankPontos()" style="flex:0;">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Histórico de Pontos (Aluno) -->
<div id="modalRankAlunoHist" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="max-width:820px; max-height:92vh; overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h3 id="rankAlunoHistTitle" style="margin:0;color:var(--text-main);font-size:1.15rem;">
                <i class="fas fa-clipboard-list" style="color:#0ea5e9;"></i> Histórico de Pontos
            </h3>
            <button data-onclick="rankAlunoHistFechar()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">✕</button>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
            <input type="text" id="rankAlunoHistBusca" class="inp" placeholder="Buscar por atividade/motivo..." oninput="rankAlunoHistRender()" style="flex:1;min-width:220px;">
            <select id="rankAlunoHistCat" class="inp" style="width:190px;" data-onchange="rankAlunoHistRender()">
                <option value="">Todas categorias</option>
                <option value="notas">Notas</option>
                <option value="comportamento">Comportamento</option>
                <option value="participacao">Participação</option>
                <option value="bonus">Bônus</option>
            </select>
        </div>
        <div id="rankAlunoHistBody" style="overflow:auto;max-height:70vh;border:1px solid var(--border-color);border-radius:12px;background:var(--card-bg);padding:10px;"></div>
        <div style="margin-top:8px;font-size:0.78rem;color:var(--text-muted);">
            Dica: ao adicionar pontos, escreva o nome da atividade em <b>Motivo / Atividade</b>.
        </div>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
            <button class="btn-tool" data-onclick="rankAlunoHistFechar()">Fechar</button>
        </div>
    </div>
</div>

        <!-- Modal: Histórico Semanal do Ranking -->
        <div id="modalRankHistorico" class="modal-overlay rank-hist-modal" style="display:none;">
            <div class="modal-box">
                <div class="rank-hist-header">
                    <h3><i class="fas fa-calendar-week" style="color:#6366f1;"></i> Histórico Semanal</h3>
                    <button data-onclick="rankHistoricoSemanalFechar()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">✕</button>
                </div>
                <div class="rank-hist-config">
                    <label>
                        <i class="fas fa-play"></i> Início da semana:
                        <select id="rankHistDiaInicio" class="inp" data-onchange="rankHistoricoRenderizar()">
                            <option value="0">Domingo</option>
                            <option value="1">Segunda</option>
                            <option value="2">Terça</option>
                            <option value="3">Quarta</option>
                            <option value="4">Quinta</option>
                            <option value="5" selected>Sexta</option>
                            <option value="6">Sábado</option>
                        </select>
                    </label>
                    <label>
                        <i class="fas fa-stop"></i> Fim da semana:
                        <span id="rankHistDiaFim" style="font-weight:800;color:var(--text-main);">Quinta</span>
                    </label>
                    <label>
                        <i class="fas fa-calendar"></i> A partir de:
                        <input type="date" id="rankHistDataInicio" class="inp" data-onchange="rankHistoricoRenderizar()">
                    </label>
                    <label>
                        <i class="fas fa-calendar-check"></i> Até:
                        <input type="date" id="rankHistDataFim" class="inp" data-onchange="rankHistoricoRenderizar()">
                    </label>
                </div>
                <div class="rank-hist-tabs">
                    <button class="rank-hist-tab active" data-onclick="rankHistSetView('semanal')">📊 Por Semana</button>
                    <button class="rank-hist-tab" data-onclick="rankHistSetView('evolucao')">📈 Evolução</button>
                </div>
                <div class="rank-hist-body" id="rankHistBody">
                </div>
            </div>
        </div>
    </main>

    <div id="toastContainer" class="toast-container" aria-live="polite" role="status"></div>

    <div id="diagFab" class="diag-fab" title="Diagnóstico (Ctrl+Shift+D)" data-onclick="abrirDiagnosticoPainel()"><i class="fas fa-bug"></i></div>


        
        <!-- MODAIS -->
        <!-- Painel rápido de Diagnóstico -->
        <div id="modalDiagPanel" class="modal-overlay" style="display:none;">
            <div class="modal-box" style="width: 980px; max-width: 98vw; max-height: 92vh; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
                    <h2 style="margin:0;">Diagnóstico</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                        <button class="btn-secondary" data-onclick="diagExecutarTestes(); __renderDiagnosticoPainel();"><i class="fas fa-stethoscope"></i> Testes</button>
                        <button class="btn-secondary" data-onclick="diagCopiarRelatorio()"><i class="fas fa-copy"></i> Copiar relatório</button>
                        <button class="btn-secondary" data-onclick="baixarLog()"><i class="fas fa-file-arrow-down"></i> Baixar log</button>
                        <button class="btn-secondary" data-onclick="salvarEstadoArquivo()"><i class="fas fa-floppy-disk"></i> Salvar estado</button>
                        <button class="btn-secondary" data-onclick="abrirEstadoArquivo()"><i class="fas fa-folder-open"></i> Abrir estado</button>
                        <button class="btn-secondary" data-onclick="baixarBackup()"><i class="fas fa-download"></i> Backup ZIP</button>
                        <button class="btn-secondary" data-onclick="diagLimpar(); __renderDiagnosticoPainel();"><i class="fas fa-broom"></i> Limpar</button>
                        <button class="btn-secondary" data-onclick="fecharDiagnosticoPainel()"><i class="fas fa-xmark"></i> Fechar</button>
                    </div>
                </div>

                <div class="diag-tabs" style="margin-top:12px;">
                    <button id="diagTabBtn_status" class="diag-tabbtn active" data-onclick="__diagTab('status')"><i class="fas fa-circle-info"></i> Status</button>
                    <button id="diagTabBtn_errors" class="diag-tabbtn" data-onclick="__diagTab('errors')"><i class="fas fa-triangle-exclamation"></i> Erros</button>
                    <button id="diagTabBtn_logs" class="diag-tabbtn" data-onclick="__diagTab('logs')"><i class="fas fa-list"></i> Logs</button>
                </div>

                <div id="diagPanel_status" class="diag-panel"></div>
                <div id="diagPanel_errors" class="diag-panel" style="display:none;"></div>
                <div id="diagPanel_logs" class="diag-panel" style="display:none;"></div>
            </div>
        </div>

        <!-- Falha ao salvar (quota/localStorage) -->
        <div id="modalSaveFail" class="modal-overlay" style="display:none;">
            <div class="modal-box" style="width: 560px; max-width: 95vw;">
                <h2>Falha ao salvar</h2>
                <div id="saveFailMsg" style="margin-top:8px; color:#64748b; font-size:0.95rem;"></div>
                <div style="margin-top:10px; font-size:0.85rem; color:#94a3b8;">
                    Dica: faça um backup ZIP e, se necessário, limpe dados antigos em Configurações do navegador (armazenamento do site).
                </div>
                <div class="modal-footer-xl" style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
                    <button class="btn-primary" data-onclick="__saveFailBackupNow()"><i class="fas fa-download"></i> Baixar backup ZIP agora</button>
                    <button class="btn-secondary" data-onclick="document.getElementById('modalSaveFail').style.display='none'">Fechar</button>
                </div>
            </div>
        </div>

    <div id="modalConfig" class="modal-overlay">
        <div class="modal-box" style="width: 820px; max-width: 95vw;">
            <h2>Configurações</h2>

            <div class="form-group">
                <label>Matéria 1 (coluna principal)</label>
                <select id="cfgSlot1" class="inp"></select>
            </div>

            <div class="form-group">
                <label>Matéria 2</label>
                <select id="cfgSlot2" class="inp"></select>
            </div>

            <hr style="margin: 15px 0;">

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <h3 style="margin:0;">Disciplinas e Avaliações</h3>
                <button class="btn-primary" style="padding:6px 10px;" data-onclick="cfgAdicionarDisciplina()"><i class="fas fa-plus"></i> Disciplina</button>
            </div>

            <div id="cfgDisciplinasList" style="margin-top:10px;"></div>

            <div style="margin-top:15px; background:#f0fdf4; padding:10px; border-radius:6px; border:1px solid #bbf7d0;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="cfgRecSubs">
                    <strong>Recuperação Substitui Média da Matéria 1?</strong>
                </label>
                <p style="font-size:0.8rem; color:#166534; margin-top:5px;">Se marcado, o sistema compara a média das avaliações (exceto "Recup.") com a nota da avaliação "Recup.". A maior nota prevalece.</p>
            </div>

            
            <hr style="margin: 18px 0;">

            <h3 style="margin:0 0 10px 0;">Tema (Cores)</h3>
            <div class="form-group">
              <label>Tamanho da fonte</label>
              <div class="font-size-control">
                <button onclick="adjustFontSize(-1)">A-</button>
                <span id="fontSizeDisplay" style="font-size:.85rem;min-width:30px;text-align:center;">16</span>
                <button onclick="adjustFontSize(1)">A+</button>
              </div>
            </div>
            <div class="form-group">
              <label>Cor de destaque rápida</label>
              <div class="theme-picker">
                <div class="theme-swatch" style="background:#0ea5e9;" onclick="setAccentColor('#0ea5e9')" title="Azul"></div>
                <div class="theme-swatch" style="background:#8b5cf6;" onclick="setAccentColor('#8b5cf6')" title="Roxo"></div>
                <div class="theme-swatch" style="background:#16a34a;" onclick="setAccentColor('#16a34a')" title="Verde"></div>
                <div class="theme-swatch" style="background:#dc2626;" onclick="setAccentColor('#dc2626')" title="Vermelho"></div>
                <div class="theme-swatch" style="background:#f59e0b;" onclick="setAccentColor('#f59e0b')" title="Laranja"></div>
                <div class="theme-swatch" style="background:#ec4899;" onclick="setAccentColor('#ec4899')" title="Rosa"></div>
                <div class="theme-swatch" style="background:#475569;" onclick="setAccentColor('#475569')" title="Cinza"></div>
              </div>
            </div>
            <div class="form-group">
                <label>Paletas prontas</label>
                <select id="cfgThemePreset" class="inp"></select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                <div class="form-group">
                    <label>Cor principal</label>
                    <input id="cfgTheme_primary" type="color" class="inp" style="height:42px; padding:6px;">
                </div>
                <div class="form-group">
                    <label>Cor secundária</label>
                    <input id="cfgTheme_secondary" type="color" class="inp" style="height:42px; padding:6px;">
                </div>
                <div class="form-group">
                    <label>Cor de fundo</label>
                    <input id="cfgTheme_bg" type="color" class="inp" style="height:42px; padding:6px;">
                </div>
                <div class="form-group">
                    <label>Cor dos cards</label>
                    <input id="cfgTheme_card" type="color" class="inp" style="height:42px; padding:6px;">
                </div>
                <div class="form-group" style="grid-column:1 / -1;">
                    <label>Cor dos textos</label>
                    <input id="cfgTheme_text" type="color" class="inp" style="height:42px; padding:6px;">
                </div>
            </div>
            <p style="font-size:0.8rem; color:#64748b; margin-top:6px;">
                Dica: escolha uma paleta pronta ou use “Personalizado” para definir as cores.
            </p>

            <hr style="margin: 18px 0;">

            <h3 style="margin:0 0 10px 0;">Histórico e Backups</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-secondary" data-onclick="undo()" title="Ctrl+Z"><i class="fas fa-undo"></i> Desfazer</button>
                <button class="btn-secondary" data-onclick="redo()" title="Ctrl+Y"><i class="fas fa-redo"></i> Refazer</button>
                <button class="btn-secondary" data-onclick="criarBackupAgora()"><i class="fas fa-box-archive"></i> Criar backup</button>
                <button class="btn-secondary" data-onclick="restaurarUltimoBackup()"><i class="fas fa-rotate-left"></i> Restaurar último</button>
                <button class="btn-secondary" data-onclick="baixarLog()"><i class="fas fa-file-arrow-down"></i> Baixar log</button>
            </div>

            <div id="cfgBackupsList" style="margin-top:10px; max-height: 180px; overflow:auto; border:1px solid var(--border-color); border-radius:10px; padding:10px; background:var(--input-bg);">
                <div style="font-size:0.85rem; color:#64748b;">Nenhum backup ainda.</div>
            </div>
            <div id="cfgAuditInfo" style="margin-top:8px; font-size:0.85rem; color:#64748b;"></div>

            <hr style="margin: 18px 0;">

            <h3 style="margin:0 0 10px 0;">Diagnóstico</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-secondary" data-onclick="diagExecutarTestes()"><i class="fas fa-stethoscope"></i> Executar testes</button>
                <button class="btn-secondary" data-onclick="diagCopiarRelatorio()"><i class="fas fa-copy"></i> Copiar relatório</button>
                <button class="btn-secondary" data-onclick="diagLimpar()"><i class="fas fa-broom"></i> Limpar</button>
            </div>

            <div id="cfgDiagStatus" style="margin-top:10px; font-size:0.9rem; color:#64748b;"></div>
            <div id="cfgDiagErrors" style="margin-top:10px; max-height: 180px; overflow:auto; border:1px solid var(--border-color); border-radius:10px; padding:10px; background:var(--input-bg);">
                <div style="font-size:0.85rem; color:#64748b;">Sem registros de erro nesta sessão.</div>
            </div>
            <div id="cfgDiagTests" style="margin-top:10px; max-height: 220px; overflow:auto; border:1px solid var(--border-color); border-radius:10px; padding:10px; background:var(--input-bg);">
                <div style="font-size:0.85rem; color:#64748b;">Nenhum teste executado ainda.</div>
            </div>


<div style="text-align: right; margin-top: 20px;">
                <button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button>
                <button data-onclick="salvarConfig()" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalCopiarTabela" class="modal-overlay">
        <div class="modal-box" style="width: 600px;">
            <h2>Copiar para Planilha</h2>
            <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px;">Abaixo está a tabela com formatação condicional (Cores). Clique em "Copiar", vá ao Excel e tecle Ctrl+V.</p>
            <div id="tabelaCopyContainer" class="copy-area"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button>
                <button data-onclick="copiarConteudoTabela()" class="btn-primary"><i class="fas fa-copy"></i> Copiar</button>
            </div>
        </div>
    </div>

    <div id="modalGeradorGrupos" class="modal-overlay">
        <div class="modal-box" style="width:700px;max-width:96vw;max-height:92vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 style="margin:0;"><i class="fas fa-users-cog"></i> Gerador de Grupos</h2>
                <button class="btn-tool" data-onclick="fecharModais()" title="Fechar"><i class="fas fa-times"></i></button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
                <div class="form-group">
                    <label>Modo</label>
                    <select id="selectModoGrupo" class="inp" data-onchange="grupoModoChanged()">
                        <option value="qtdGrupos">Por quantidade de grupos</option>
                        <option value="qtdAlunos">Por alunos por grupo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="lblQtdGrupo">Quantidade de Grupos</label>
                    <input type="number" id="inputQtdGrupos" class="inp" value="4" min="2">
                </div>
                <div class="form-group">
                    <label>Critério</label>
                    <select id="selectTipoGrupo" class="inp">
                        <option value="aleatorio">Aleatório</option>
                        <option value="equilibrado">Equilibrado (Notas)</option>
                        <option value="comportamento">Equilibrado (Comportamento)</option>
                        <option value="misto">Misto (Notas + Comportamento)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <label style="font-size:.78rem;color:#64748b;cursor:pointer;display:flex;align-items:center;gap:4px;"><input type="checkbox" id="grpExcludeAbsent"> Excluir ausentes do dia</label>
                </div>
            </div>
            <details style="margin:8px 0;">
                <summary style="cursor:pointer;font-size:.82rem;color:#7c3aed;font-weight:600;">⚙️ Opções avançadas</summary>
                <div style="padding:8px;display:flex;flex-direction:column;gap:8px;">
                    <div class="form-group">
                        <label>Não juntar (um par por linha: <code>Nome1 ; Nome2</code>)</label>
                        <textarea id="grpSeparar" class="inp" rows="3" placeholder="João ; Maria&#10;Pedro ; Ana"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Fixar alunos em grupos (<code>Nome ; Grupo 1</code>)</label>
                        <textarea id="grpFixar" class="inp" rows="3" placeholder="João ; 1&#10;Maria ; 2"></textarea>
                    </div>
                </div>
            </details>
            <button data-onclick="gerarGrupos()" class="btn-primary" style="width:100%;justify-content:center;"><i class="fas fa-shuffle"></i> Gerar Grupos</button>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button data-onclick="grpCopiarTexto()" class="btn-planner"><i class="fas fa-copy"></i> Copiar texto</button>
                <button data-onclick="grpImprimir()" class="btn-planner"><i class="fas fa-print"></i> Imprimir</button>
                <span style="flex:1;"></span>
                <span id="grpHistoricoInfo" style="font-size:.72rem;color:#64748b;align-self:center;"></span>
            </div>
            <hr style="margin:10px 0;">
            <div id="resultadoGrupos" class="group-result"></div>
        </div>
    </div>

    <div id="modalAulasLote" class="modal-overlay"><div class="modal-box"><h2>Aulas em Lote</h2><textarea id="inputAulasLote" class="inp" rows="10"></textarea><div style="text-align: right; margin-top: 20px;"><button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button><button data-onclick="salvarAulasLote()" class="btn-primary">Salvar</button></div></div></div>

    <div id="modalPlanoSemanal" class="modal-overlay">
      <div class="modal-box" id="planoSemanalBox" style="max-width: 1100px; width: 96%; max-height: 92vh; overflow:hidden; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <h2 style="margin:0;">Plano Semanal</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn-tool" id="btnPlanoSemanalFullscreen" data-onclick="togglePlanoSemanalFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i></button>
            <button class="btn-tool" data-onclick="fecharModais()" title="Fechar"><i class="fas fa-times"></i></button>
          </div>
        </div>

        <div id="planoSemanalScroll" style="flex:1; min-height:0; overflow:auto; padding-right:6px; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;">

        <div id="planoPreenchWrap" style="margin-top:10px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg); overflow:hidden;">
          <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px 0; gap:8px; flex-wrap:wrap;">
            <span style="font-size:.85rem; font-weight:700; color:var(--text-main);"><i class="fas fa-pen-to-square" style="color:#7c3aed;"></i> Preenchimento Rápido</span>
            <span id="planoPreenchProgress" style="font-size:.72rem; color:var(--text-muted);"></span>
          </div>
          <div id="planoPreenchTabs" style="display:flex; gap:4px; padding:8px 14px 0; flex-wrap:wrap;">
            <button class="plano-pr-tab plano-pr-tab-active" data-campo="conteudo" data-onclick="planoPreenchTab('conteudo')">1. Conteúdo</button>
            <button class="plano-pr-tab" data-campo="habilidades" data-onclick="planoPreenchTab('habilidades')">2. Habilidades</button>
            <button class="plano-pr-tab" data-campo="objetivos" data-onclick="planoPreenchTab('objetivos')">3. Objetivos</button>
            <button class="plano-pr-tab" data-campo="sensibilizacao" data-onclick="planoPreenchTab('sensibilizacao')">4. Sensibilização</button>
            <button class="plano-pr-tab" data-campo="desenvolvimento" data-onclick="planoPreenchTab('desenvolvimento')">5. Desenvolvimento</button>
            <button class="plano-pr-tab" data-campo="recursos" data-onclick="planoPreenchTab('recursos')">6. Recursos</button>
            <button class="plano-pr-tab" data-campo="avaliacao" data-onclick="planoPreenchTab('avaliacao')">7. Avaliação</button>
          </div>
          <div style="padding:8px 14px 12px;">
            <textarea id="planoPreenchTexto" class="inp" rows="7" style="width:100%; white-space:pre; font-size:13px;" placeholder="Cole aqui — uma linha por aula:&#10;Aula 1: Frações e números decimais&#10;Aula 2: Geometria plana&#10;Aula 3: Álgebra&#10;..."></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center;">
              <button class="btn-primary" style="background:#7c3aed;" data-onclick="planoPreenchAplicar()"><i class="fas fa-check"></i> Aplicar</button>
              <button class="btn-primary" style="background:#475569;" data-onclick="planoPreenchAplicarEProximo()"><i class="fas fa-forward-step"></i> Aplicar + Próximo</button>
              <button class="btn-primary" style="background:#475569;" data-onclick="planoPreenchLerCampo()"><i class="fas fa-eye"></i> Ver Atual</button>
              <span style="flex:1;"></span>
              <span id="planoPreenchStatus" style="font-size:.72rem; color:var(--text-muted);"></span>
            </div>
          </div>
        </div>
        <span id="planoLoteMaxSpan" style="display:none;">7</span>


        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
          <div class="form-group" style="margin:0;">
            <label style="font-size:12px; color:var(--text-muted);">Semana começa</label>
            <input type="date" id="planoSemanaInicio" class="inp" style="width:170px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:12px; color:var(--text-muted);">Semana termina</label>
            <input type="date" id="planoSemanaFim" class="inp" style="width:170px;">
          </div>

          <div class="form-group" style="margin:0; width:240px;">
            <label style="font-size:12px; color:var(--text-muted);">Disciplina</label>
            <select id="planoDisciplina" class="inp"></select>
          </div>

          <div class="form-group" style="margin:0; width:210px;">
            <label style="font-size:12px; color:var(--text-muted);">Aulas na semana</label>
            <div style="display:flex; gap:6px; align-items:center;">
              <button class="btn-tool" data-onclick="planoAdjustAulas(-1)" title="Remover aula"><i class="fas fa-minus"></i></button>
              <input type="number" id="planoQtdAulas" class="inp" value="7" min="1" max="50" style="width:84px; text-align:center;">
              <button class="btn-tool" data-onclick="planoAdjustAulas(1)" title="Adicionar aula"><i class="fas fa-plus"></i></button>
            </div>
          </div>

          <div class="form-group" style="margin:0; width:180px;">
            <label style="font-size:12px; color:var(--text-muted);">Escopo</label>
            <select id="planoEscopo" class="inp">
              <option value="turma">Turma atual</option>
              <option value="geral">Plano geral</option>
            </select>
          </div>
          <div class="form-group" style="margin:0; flex:1; min-width:240px;">
            <label style="font-size:12px; color:var(--text-muted);">Planos salvos</label>
            <select id="planoSemanaLista" class="inp"></select>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn-primary" data-onclick="novoPlanoSemana()"><i class="fas fa-file"></i> Novo</button>
            <button class="btn-primary" style="background:#475569;" data-onclick="duplicarPlanoSemana()"><i class="fas fa-clone"></i> Duplicar</button>
            <button class="btn-primary" data-onclick="salvarPlanoSemana()"><i class="fas fa-save"></i> Salvar</button>
            <button class="btn-file btn-load" style="padding:10px 12px;" data-onclick="excluirPlanoSemana()" title="Excluir"><i class="fas fa-trash"></i></button>
          </div>
        </div>

        <div id="planoGeralAplicarWrap" style="display:none; margin-top:10px; padding:10px; border:1px dashed var(--border-color); border-radius:14px; background:rgba(0,0,0,0.02);">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div style="display:flex; flex-direction:column; gap:4px;">
              <div style="font-size:12px; color:var(--text-muted); font-weight:600;">Aplicar este plano geral para turmas</div>
              <div style="font-size:12px; color:var(--text-muted);">Selecione as turmas abaixo e clique em “Aplicar”.</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn-primary" style="background:#475569;" data-onclick="selecionarTodasTurmasPlano()"><i class="fas fa-check-double"></i> Todas</button>
              <button class="btn-primary" style="background:#475569;" data-onclick="limparSelecaoTurmasPlano()"><i class="fas fa-eraser"></i> Limpar</button>
              <button class="btn-primary" data-onclick="aplicarPlanoGeralNasTurmas()"><i class="fas fa-arrow-right"></i> Aplicar</button>
            </div>
          </div>
          <div id="planoTurmasChecklist" style="margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; max-height:160px; overflow:auto; padding-right:6px;"></div>
          <div id="planoAplicarStatus" style="margin-top:8px; font-size:12px; color:var(--text-muted);"></div>
        </div>

        <div id="planoSemanalBody" style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; max-height:none; overflow:visible; padding-right:0;">
          <!-- Aula 1 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 1</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(1)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula1_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 1 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula1_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(1)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula1_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano1">
              <datalist id="dlBloomVerbosPlano1"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula1_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula1_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula1_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula1_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula1_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula1_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula1_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>
          <!-- Aula 2 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 2</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(2)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula2_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 2 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula2_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(2)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula2_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano2">
              <datalist id="dlBloomVerbosPlano2"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula2_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula2_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula2_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula2_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula2_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula2_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula2_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>
          <!-- Aula 3 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 3</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(3)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula3_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 3 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula3_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(3)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula3_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano3">
              <datalist id="dlBloomVerbosPlano3"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula3_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula3_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula3_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula3_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula3_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula3_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula3_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>
          <!-- Aula 4 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 4</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(4)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula4_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 4 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula4_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(4)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula4_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano4">
              <datalist id="dlBloomVerbosPlano4"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula4_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula4_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula4_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula4_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula4_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula4_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula4_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>
          <!-- Aula 5 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 5</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(5)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula5_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 5 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula5_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(5)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula5_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano5">
              <datalist id="dlBloomVerbosPlano5"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula5_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula5_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula5_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula5_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula5_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula5_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula5_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>

          <!-- Aula 6 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 6</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(6)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula6_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 6 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula6_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(6)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula6_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano6">
              <datalist id="dlBloomVerbosPlano6"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula6_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula6_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula6_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula6_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula6_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula6_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula6_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>

          <!-- Aula 7 -->
          <div style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula 7</h3>
              <button class="btn-tool" data-onclick="extrairPlanoAula(7)" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>
            </div>
            <textarea id="pl_aula7_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula 7 (opcional)"></textarea>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="pl_aula7_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano(7)">
                <option value="">Bloom (nível alvo)</option>
                <option value="Lembrar">Lembrar</option>
                <option value="Compreender">Compreender</option>
                <option value="Aplicar">Aplicar</option>
                <option value="Analisar">Analisar</option>
                <option value="Avaliar">Avaliar</option>
                <option value="Criar">Criar</option>
              </select>
              <input type="text" id="pl_aula7_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano7">
              <datalist id="dlBloomVerbosPlano7"></datalist>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">
              <textarea id="pl_aula7_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>
              <textarea id="pl_aula7_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>
              <textarea id="pl_aula7_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>
              <textarea id="pl_aula7_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>
              <textarea id="pl_aula7_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>
              <textarea id="pl_aula7_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>
              <textarea id="pl_aula7_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>
            </div>
          </div>

        </div>

        <div style="margin-top:12px;">
          <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:6px;">Plano consolidado (agrupado por tipo)</label>
          <textarea id="planoSemanalResumo" class="inp" rows="12" style="width:100%; white-space:pre;"></textarea>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:10px; flex-wrap:wrap;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <select id="planoResumoModo" class="inp" style="width:220px; padding:10px 12px;" data-onchange="planoResumoModoChanged()">
                <option value="por_aula">Padrão (por aula)</option>
                <option value="por_grupo">Agrupar aulas (grupos)</option>
              </select>
              <input id="planoGruposDef" class="inp" style="width:260px; padding:10px 12px;" placeholder="Grupos: 1-4;5-7;8-10 (opcional)">
              <button class="btn-primary" style="background:#475569;" data-onclick="gerarResumoPlanoSemana()"><i class="fas fa-bolt"></i> Gerar</button>
              <button class="btn-primary" data-onclick="copiarResumoPlanoSemana()"><i class="fas fa-copy"></i> Copiar</button>
              <button class="btn-primary" style="background:#475569;" data-onclick="exportarPlanoSemanaPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
            <div id="planoSemanaStatus" style="font-size:12px; color:var(--text-muted);"></div>
          </div>
        </div>
        </div>

      </div>
    </div>
    <div id="planoSemanalPrint" style="position:fixed; left:-9999px; top:0; width:794px; padding:24px; background:#fff; color:#000; font-family: Arial, sans-serif;"></div>
    <div id="modalNovaTurma" class="modal-overlay"><div class="modal-box"><h2>Criar Turma</h2><div class="form-group"><input type="text" id="inputNomeTurma" class="inp"></div><div style="text-align: right; margin-top: 20px;"><button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button><button data-onclick="salvarTurma()" class="btn-primary">Salvar</button></div></div></div>
    <div id="modalNovoAluno" class="modal-overlay"><div class="modal-box"><h2>Adicionar Alunos</h2><div class="form-group"><select id="selectTurmaAluno" class="inp"></select></div><div class="form-group"><textarea id="inputNomes" class="inp" rows="5"></textarea></div><div style="text-align: right; margin-top: 20px;"><button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button><button data-onclick="salvarAlunos()" class="btn-primary">Cadastrar</button></div></div></div>
    <div id="modalSorteio" class="modal-overlay">
        <div class="modal-box" style="text-align:center;max-width:520px;">
            <h2 style="color:#64748b;"><i class="fas fa-dice"></i> Sorteador</h2>
            <div style="display:flex;gap:8px;justify-content:center;margin:8px 0;flex-wrap:wrap;">
                <label class="sort-opt"><input type="radio" name="sortMode" value="1" checked> 1 aluno</label>
                <label class="sort-opt"><input type="radio" name="sortMode" value="2"> Dupla</label>
                <label class="sort-opt"><input type="radio" name="sortMode" value="3"> Trio</label>
                <label class="sort-opt"><input type="radio" name="sortMode" value="n"> N:</label>
                <input type="number" id="sortN" class="inp" value="4" min="1" max="20" style="width:50px;padding:4px;">
            </div>
            <label style="font-size:.78rem;color:#64748b;cursor:pointer;"><input type="checkbox" id="sortExcludeAbsent"> Excluir ausentes do dia</label>
            <div id="sortSlot" class="sort-slot">
                <div id="sortReel" class="sort-reel"></div>
            </div>
            <div id="sortResult" style="min-height:60px;margin:10px 0;"></div>
            <div id="sortHistory" class="sort-history"></div>
            <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px;">
                <button data-onclick="sortearAluno()" class="btn-primary"><i class="fas fa-dice"></i> Sortear</button>
                <button data-onclick="sortLimparHistorico()" class="btn-planner"><i class="fas fa-rotate"></i> Limpar histórico</button>
                <button data-onclick="fecharModais()" class="btn-planner">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modalEventoCal" class="modal-overlay">
        <div class="modal-box">
            <h2>Novo Evento</h2>
            <input type="hidden" id="inputDataCal">
            <div class="form-group">
                <label>Tipo</label>
                <select id="inputTipoEvento" class="inp">
                    <option value="aula">Aula</option>
                    <option value="prova">Prova</option>
                    <option value="atividade">Atividade</option>
                </select>
            </div>
            <div class="form-group">
                <label>Descrição</label>
                <input type="text" id="inputDescEvento" class="inp" placeholder="Ex: Prova Mensal, Aula 12...">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button data-onclick="fecharModais()" style="padding: 8px 15px; border:none; bg:transparent; cursor:pointer;">Cancelar</button>
                <button data-onclick="salvarEventoCal()" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalTimer" class="modal-overlay">
        <div class="modal-box" style="text-align:center; width: 600px;">
            <h2 style="color:#64748b;"><i class="fas fa-clock"></i> Cronômetro de Atividade</h2>
            <div id="timerDisplay">00:00</div>
            <div class="timer-controls">
                <button class="btn-primary" style="background:#16a34a; font-size:1.2rem; padding:15px 30px;" data-onclick="startTimer()"><i class="fas fa-play"></i></button>
                <button class="btn-primary" style="background:#f59e0b; font-size:1.2rem; padding:15px 30px;" data-onclick="pauseTimer()"><i class="fas fa-pause"></i></button>
                <button class="btn-primary" style="background:#ef4444; font-size:1.2rem; padding:15px 30px;" data-onclick="resetTimer()"><i class="fas fa-stop"></i></button>
            </div>
            <div class="timer-presets">
                <button class="btn-tool" data-onclick="setTimer(5)">05 min</button>
                <button class="btn-tool" data-onclick="setTimer(15)">15 min</button>
                <button class="btn-tool" data-onclick="setTimer(30)">30 min</button>
                <button class="btn-tool" data-onclick="setTimer(50)">50 min</button>
            </div>
            <div style="margin-top:20px; text-align:right;"><button data-onclick="fecharModais()" style="background:none; border:none; cursor:pointer; color:#64748b;">Fechar</button></div>
        </div>
    </div>

    <div id="modalDetalhes" class="modal-overlay">
        <div class="modal-box modal-xl">
            <div class="modal-header-xl">
                <div><h2 id="detNome" style="color: var(--primary); margin-bottom: 5px;">Nome</h2><span id="detTurma" style="color: #64748b; font-size: 0.9rem; font-weight: bold;">Turma</span></div>
                <button data-onclick="fecharModais()" style="font-size: 1.5rem; border: none; bg: none; cursor: pointer; color: #94a3b8;">&times;</button>
            </div>
            <div class="modal-body-xl">
                <div class="col-left">
                    <div class="tabs-header">
                        <button class="tab-btn active" id="btnTabLP" data-onclick="mudarAba('lp')"><span class="lbl-mat1">Matéria 1</span></button>
                        <button class="tab-btn" id="btnTabRED" data-onclick="mudarAba('red')"><span class="lbl-mat2">Matéria 2</span></button>
                        <button class="tab-btn" id="btnTabPAEE" data-onclick="mudarAba('paee')" style="color:var(--inclusao);">Inclusão</button>
                        <button class="tab-btn" id="btnTabEVO" data-onclick="mudarAba('evo')"><i class="fas fa-chart-line"></i> Evolução</button>
                    </div>
                    
                    <div id="tabLP" class="tab-content active">
                        <table class="tabela-fixa">
    <thead><tr><th>Avaliação</th><th>Peso</th><th>Nota</th></tr></thead>
    <tbody id="tbodyAvalLP"></tbody>
</table>
                        <div class="farol-box-modal"><span>Média <span class="lbl-mat1"></span></span> <span id="spanMedia_lp" style="font-size: 2rem; font-weight: bold;">0.0</span></div>
                    </div>
                    <div id="tabRED" class="tab-content">
                        <div style="background:#e0f2fe; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #bae6fd;">
                            <label style="font-weight:bold; color:#0369a1; display:block; margin-bottom:5px;"><i class="fas fa-book"></i> Livro do Bimestre</label>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="inputLivro" class="inp" placeholder="Título do livro..." style="flex:2;">
                                <select id="selectStatusLivro" class="inp" style="flex:1;">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Lendo">Lendo</option>
                                    <option value="Concluído">Concluído</option>
                                    <option value="Apresentou">Apresentou</option>
                                </select>
                            </div>
                        </div>

                        <table class="tabela-fixa">
    <thead><tr><th>Avaliação</th><th>Peso</th><th>Nota</th></tr></thead>
    <tbody id="tbodyAvalRED"></tbody>
</table>
                        <div class="farol-box-modal"><span>Média <span class="lbl-mat2"></span></span> <span id="spanMedia_red" style="font-size: 2rem; font-weight: bold;">0.0</span></div>
                    </div>
                    <div id="tabPAEE" class="tab-content">
                        <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; border: 1px solid #d8b4fe; margin-bottom: 20px;">
                            <label style="display:flex; align-items:center; justify-content:space-between; cursor:pointer;"><span style="font-weight:bold; color:var(--inclusao);">Aluno Elegivel?</span><label class="switch"><input type="checkbox" id="checkElegivel"><span class="slider"></span></label></label>
                        </div>
                        <div class="form-group"><label>Diagnóstico</label><input type="text" id="inputLaudo" class="inp" placeholder="CID..."></div>
                        <label style="font-weight:600; font-size:0.9rem; margin-bottom:10px; display:block;">Adaptações:</label>
                        <div class="intel-grid" style="grid-template-columns: 1fr;">
                            <label class="check-intel"><input type="checkbox" name="adapt" value="Prova Oral"> Prova Oral</label><label class="check-intel"><input type="checkbox" name="adapt" value="Tempo Estendido"> Tempo Estendido</label><label class="check-intel"><input type="checkbox" name="adapt" value="Fonte Ampliada"> Fonte Ampliada</label>
                        </div>
                        <div class="form-group" style="margin-top:15px;"><label>Registro PEI</label><textarea id="txtPEI" class="inp" rows="4"></textarea></div>
                    </div>
                    <div id="tabEVO" class="tab-content">
                        <h3 style="margin-bottom:10px; font-size:1rem; color:#64748b;">Comparativo de Médias por Bimestre</h3>
                        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:10px;">
                            <span style="display:flex; align-items:center; gap:5px; font-size:0.8rem;"><span style="width:10px; height:10px; background:var(--primary);"></span> <span class="lbl-mat1">Mat1</span></span>
                            <span style="display:flex; align-items:center; gap:5px; font-size:0.8rem;"><span style="width:10px; height:10px; background:#ec4899;"></span> <span class="lbl-mat2">Mat2</span></span>
                        </div>
                        <div class="chart-wrap" id="chartEvolucao"></div>
                    </div>

                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 15px; background: #f0fdf4; padding: 15px; border-radius: 8px;"><span style="font-size: 1.5rem;"><i class="fas fa-shield-heart"></i></span><input type="range" id="sliderComp" min="0" max="10" step="0.5" class="slider-comp" data-oninput="document.getElementById('valComp').innerText = this.value"><span id="valComp" style="font-weight: bold; font-size: 1.2rem; color: var(--farol-verde);">10</span></div>
                </div>
                <div class="col-right">
                    <h3 style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; color: #334155;">
                        <i class="fas fa-clipboard-list" style="color: #f59e0b; font-size: 1.2rem;"></i> Ocorrências
                    </h3>
                    <div class="timeline-container"><div class="add-occ-box"><textarea id="inputNovaOcorrencia" class="occ-input" rows="1" placeholder="..."></textarea><button type="button" class="btn-occ" data-onclick="addOcorrencia()" title="Adicionar ocorrência" aria-label="Adicionar ocorrência"><i class="fas fa-plus"></i></button></div><div id="listaOcorrencias" class="occ-list"></div></div>
                    <br>
                    
                    <div class="report-section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="color:#b45309; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-signature"></i> Parecer
                            </h4>
                            <button class="report-btn" data-onclick="gerarParecer()" style="border:none; background:transparent; cursor:pointer; font-size:1.1rem; color:#b45309;" title="Gerar Sugestão Base">
                                <i class="fas fa-wand-magic-sparkles"></i>
                            </button>
                        </div>
                        <div class="tags-container" style="margin-top:10px;">
                            <span class="tag-chip" data-onclick="addTagParecer('participativo')">Participativo</span>
                            <span class="tag-chip" data-onclick="addTagParecer('esforçado')">Esforçado</span>
                            <span class="tag-chip" data-onclick="addTagParecer('leitura')">Lê bem</span>
                            <span class="tag-chip negative" data-onclick="addTagParecer('conversa')">Conversa</span>
                            <span class="tag-chip negative" data-onclick="addTagParecer('celular')">Usa Celular</span>
                            <span class="tag-chip negative" data-onclick="addTagParecer('faltas')">Faltoso</span>
                        </div>
                        <textarea id="txtParecer" class="report-text" style="height:150px;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer-xl">
                <div><button class="btn-primary" style="background:#475569;" data-onclick="imprimirFicha()"><i class="fas fa-print"></i> PDF</button></div>
                <div style="display: flex; gap: 10px;"><button data-onclick="fecharModais()" style="padding: 10px 20px; border: 1px solid #cbd5e1; bg: white; cursor: pointer;">Cancelar</button><button data-onclick="salvarAlteracoesDetalhadas()" class="btn-primary" style="background: var(--farol-verde);">Salvar</button></div>
            </div>
        </div>
    </div>

    
    <!-- PLANNER (Modal) -->
    <div id="modalPlanner" class="modal-overlay" style="display:none;">
        <div class="modal-box modal-xl">
            <div class="modal-header-xl">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="display:flex; align-items:center; gap:10px; font-size:1.25rem; font-weight:800;">
                        <i class="fas fa-clipboard-list" style="color:var(--primary);"></i> Planner
                    </div>
                    <div style="font-size:0.85rem; color:#64748b;">Tarefas, prazos e rotinas — tudo offline.</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="plannerFsBtn" class="btn-planner" data-onclick="plannerToggleFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i></button>
                    <button class="btn-planner" data-onclick="fecharModais()" title="Fechar"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="planner-headbar">
                <div class="planner-tabs" role="tablist" aria-label="Visões do Planner">
                    <button id="plannerTabToday" class="planner-tab active" data-onclick="plannerSetView('today')"><i class="fas fa-sun"></i> Hoje</button>
                    <button id="plannerTabWeek" class="planner-tab" data-onclick="plannerSetView('week')"><i class="fas fa-calendar-week"></i> Semana</button>
                    <button id="plannerTabAll" class="planner-tab" data-onclick="plannerSetView('all')"><i class="fas fa-list-check"></i> Todas</button>
                </div>
                <div class="planner-actions">
                    <button class="btn-planner" data-onclick="plannerExportJSON()"><i class="fas fa-file-arrow-down"></i> Exportar</button>
                    <button class="btn-planner" data-onclick="document.getElementById('plannerImportFile').click()"><i class="fas fa-file-arrow-up"></i> Importar</button>
                    <input type="file" id="plannerImportFile" style="display:none;" accept="application/json" data-onchange="plannerImportFile(this)">
                </div>
            </div>

            <div class="planner-body">
                <!-- Lista -->
                <div class="planner-panel">
                    <div class="planner-panel-header">
                        <div class="planner-filters">
                            <input id="plannerSearch" class="inp" placeholder="Buscar no Planner..." data-oninput="plannerRender()">
                            <select id="plannerFilterStatus" class="inp" data-onchange="plannerRender()">
                                <option value="open">Abertas</option>
                                <option value="all">Todas</option>
                                <option value="done">Concluídas</option>
                            </select>
                            <select id="plannerFilterTurma" class="inp" data-onchange="plannerRender()">
                                <option value="all">Todas as turmas</option>
                            </select>
                            <select id="plannerFilterBimestre" class="inp" data-onchange="plannerRender()">
                                <option value="all">Todos os bimestres</option>
                                <option value="">Sem bimestre</option>
                                <option value="1">1º bimestre</option>
                                <option value="2">2º bimestre</option>
                                <option value="3">3º bimestre</option>
                                <option value="4">4º bimestre</option>
                            </select>
                        </div>
                        <div class="planner-mini" id="plannerStats">—</div>
                    </div>
                    <div id="plannerAlerts" class="planner-alerts"></div>
                    <div id="plannerList" class="planner-list"></div>
                </div>

                <!-- Editor -->
                <div class="planner-panel">
                    <div class="planner-form">
                        <h3><i class="fas fa-pen-to-square" style="color:var(--primary);"></i> <span id="plannerFormTitle">Nova tarefa</span></h3>

                        <div class="form-group">
                            <label for="plannerTitle">Título</label>
                            <input id="plannerTitle" class="inp" placeholder="Ex: Corrigir redações do 7ºA">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plannerDate">Data</label>
                                <input id="plannerDate" type="date" class="inp">
                            </div>
                            <div class="form-group">
                                <label for="plannerTime">Hora (opcional)</label>
                                <input id="plannerTime" type="time" class="inp">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plannerTurma">Turma (opcional)</label>
                                <select id="plannerTurma" class="inp">
                                    <option value="">Sem turma</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plannerBimestre">Bimestre (opcional)</label>
                                <select id="plannerBimestre" class="inp">
                                    <option value="">Sem bimestre</option>
                                    <option value="1">1º</option>
                                    <option value="2">2º</option>
                                    <option value="3">3º</option>
                                    <option value="4">4º</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plannerCategory">Categoria</label>
                                <select id="plannerCategory" class="inp">
                                    <option value="Geral">Geral</option>
                                    <option value="Aula">Aula</option>
                                    <option value="Correção">Correção</option>
                                    <option value="Lançamento">Lançamento</option>
                                    <option value="Reunião">Reunião</option>
                                    <option value="Contato">Contato</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plannerRepeat">Repetição</label>
                                <select id="plannerRepeat" class="inp">
                                    <option value="">Não repetir</option>
                                    <option value="daily">Diária</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="biweekly">Quinzenal</option>
                                    <option value="monthly">Mensal</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="plannerPriority">Prioridade</label>
                                <select id="plannerPriority" class="inp">
                                    <option value="Média">Média</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plannerStatus">Status</label>
                                <select id="plannerStatus" class="inp">
                                    <option value="open">Aberta</option>
                                    <option value="done">Concluída</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="plannerNotes">Observações</label>
                            <textarea id="plannerNotes" class="inp" rows="5" placeholder="Notas rápidas, lembretes de sala, links..."></textarea>
                        </div>

                        <div class="actions">
                            <button class="btn-primary" data-onclick="plannerSaveFromForm()"><i class="fas fa-save"></i> Salvar</button>
                            <button class="btn-planner" data-onclick="plannerClearForm()"><i class="fas fa-eraser"></i> Limpar</button>
                            <button id="plannerDeleteBtn" class="btn-planner danger" data-onclick="plannerDeleteSelected()" style="display:none;"><i class="fas fa-trash"></i> Excluir</button>
                        </div>

                        <div class="planner-mini" style="margin-top:10px;">
                            Dica: clique numa tarefa à esquerda para editar. As tarefas ficam salvas no seu PC (offline).
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer-xl">
                <div class="planner-mini"><i class="fas fa-shield-heart"></i> Planner local: seus dados ficam no navegador (localStorage).</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-planner" data-onclick="plannerNewTaskToday()"><i class="fas fa-plus"></i> Nova (hoje)</button>
                    <button class="btn-planner" data-onclick="fecharModais()"><i class="fas fa-xmark"></i> Fechar</button>
                </div>
            </div>
        </div>
    </div>


    
    <!-- ATIVIDADES (Modal) -->
    <div id="modalAtividades" class="modal-overlay" style="display:none;">
        <div class="modal-box modal-xl">
            <div class="modal-header-xl">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="display:flex; align-items:center; gap:10px; font-size:1.25rem; font-weight:800;">
                        <i class="fas fa-gamepad" style="color:var(--primary);"></i> Atividades
                    </div>
                    <div style="font-size:0.85rem; color:#64748b;">Jogos rápidos para sala: Forca, Verdadeiro/Falso, Memória e Flashcards — tudo offline.</div>
                </div>
                <button class="btn-planner" data-onclick="fecharModais()" title="Fechar"><i class="fas fa-times"></i></button>
            </div>

            <div class="act-headbar">
                <div class="act-tabs" role="tablist" aria-label="Atividades">
                    <button id="actTabForca" class="act-tab active" data-onclick="atividadesSetTab('forca')"><i class="fas fa-skull"></i> Forca</button>
                    <button id="actTabVF" class="act-tab" data-onclick="atividadesSetTab('vf')"><i class="fas fa-check-double"></i> V/F</button>
                    <button id="actTabMem" class="act-tab" data-onclick="atividadesSetTab('mem')"><i class="fas fa-clone"></i> Memória</button>
                    <button id="actTabFC" class="act-tab" data-onclick="atividadesSetTab('fc')"><i class="fas fa-id-card"></i> Flashcards</button>
                    <button id="actTabQuiz" class="act-tab" data-onclick="atividadesSetTab('quiz')"><i class="fas fa-list-ol"></i> Quiz</button>
                    <button id="actTabComp" class="act-tab" data-onclick="atividadesSetTab('comp')"><i class="fas fa-pen-nib"></i> Completar</button>
                    <button id="actTabOrd" class="act-tab" data-onclick="atividadesSetTab('ord')"><i class="fas fa-sort"></i> Ordenar</button>

                    <button id="actTabRel" class="act-tab" data-onclick="atividadesSetTab('rel')"><i class="fas fa-arrows-left-right"></i> Relacionar</button>
                    <button id="actTabRoleta" class="act-tab" data-onclick="atividadesSetTab('roleta')"><i class="fas fa-circle-notch"></i> Roleta</button>
                    <button id="actTabWs" class="act-tab" data-onclick="atividadesSetTab('ws')"><i class="fas fa-magnifying-glass"></i> Caça-palavras</button>
                    <button id="actTabCw" class="act-tab" data-onclick="atividadesSetTab('cw')"><i class="fas fa-hashtag"></i> Cruzadinha</button>
                </div>

                <div id="actSorteadorWrap" class="act-sorteador" title="Sorteador de alunos (escolha a turma aqui)">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <button id="actBtnSorteioAluno" class="btn-planner" data-onclick="actSorteioAluno()" title="Sortear um aluno da turma selecionada"><i class="fas fa-dice"></i> Sortear aluno</button>
                        <button id="actBtnSorteioReset" class="btn-planner" data-onclick="actSorteioReset()" title="Reiniciar sorteio (sem repetir)"><i class="fas fa-rotate"></i></button>
                        <select id="actSorteioTurmaSel" class="inp" data-onchange="actSorteioSetTurma(this.value)" title="Escolha a turma do sorteio" style="max-width:220px; padding:8px 10px; border-radius:10px;">
                            <option value="Todas">Todas as turmas</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; min-width:0;">
                        <div id="actSorteioOut" class="act-sorteio-out" data-onclick="actSorteioCopiar()" aria-live="polite">—</div>
                        <div id="actSorteioMeta" class="act-sorteio-meta"></div>
                    </div>
                </div>

                <div class="act-actions">
                    <button class="btn-planner" data-onclick="atividadesExportAll()"><i class="fas fa-file-arrow-down"></i> Exportar</button>
                    <button class="btn-planner" data-onclick="document.getElementById('actImportFile').click()"><i class="fas fa-file-arrow-up"></i> Importar</button>
                    <button id="actBtnTeacher" class="btn-planner" data-onclick="atividadesToggleTeacher()" title="Modo professor: desbloquear/ocultar banco"><i class="fas fa-lock"></i> Professor</button>
                    
                    <button id="actBtnPresent" class="btn-planner" data-onclick="atividadesTogglePresent()" title="Modo apresentação (mostra só o jogo)"><i class="fas fa-tv"></i> Apresentar</button>
                    <button id="actBtnTV" class="btn-planner" data-onclick="actToggleTVMode()" title="Modo TV (botões grandes para projetor)"><i class="fas fa-desktop"></i> TV</button>
                    <button id="actBtnFullscreen" class="btn-planner" data-onclick="atividadesToggleFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i> Tela cheia</button>
                    <input type="file" id="actImportFile" style="display:none;" accept="application/json" data-onchange="atividadesImportFile(this)">
                </div>
            </div>

            <div class="act-body">
                <!-- FORCA -->
                <div id="actViewForca" class="act-view">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-pen"></i> Configurar</div>
                                <div class="act-mini">Digite uma palavra (ou use o banco). Dica opcional. Depois clique em <b>Iniciar</b>.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group">
                                    <label for="forcaPalavra">Palavra</label>
                                    <input id="forcaPalavra" class="inp" placeholder="Ex: NOTÍCIA">
                                </div>
                                <div class="form-group">
                                    <label for="forcaDica">Dica (opcional)</label>
                                    <input id="forcaDica" class="inp" placeholder="Ex: gênero textual">
                                </div>
                                <div class="form-group">
                                    <label for="forcaTeoria">Explicação teórica (aparece após o jogo)</label>
                                    <textarea id="forcaTeoria" class="inp" rows="4" placeholder="Explique rapidamente o conceito/teoria relacionada a esta palavra."></textarea>
                                </div>

                                <div class="form-group" style="margin-top:10px;">
                                    <label for="forcaLista">Sequência de palavras (1 por linha)</label>
                                    <textarea id="forcaLista" class="inp" rows="5" placeholder="Cole aqui uma lista. Formato sugerido:
PALAVRA | dica | explicação teórica
Ex.: ANÁFORA | retoma termo anterior | É um mecanismo de coesão..."></textarea>
                                    <div class="planner-mini" style="margin-top:6px;">
                                        Dica e explicação são opcionais. Você pode separar por <b>|</b>, <b>;</b> ou TAB.
                                    </div>
                                    <div class="actions" style="margin-top:10px;">
                                        <button class="btn-planner" data-onclick="forcaAdicionarLista()"><i class="fas fa-list-check"></i> Adicionar lista</button>
                                        <button class="btn-planner" data-onclick="forcaLimparLista()"><i class="fas fa-eraser"></i> Limpar campo</button>
                                    </div>
                                </div>

                                <div class="actions" style="gap:10px; flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="forcaIniciar()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-planner" data-onclick="forcaAdicionarAoBanco()"><i class="fas fa-plus"></i> Banco</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('forca')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="forcaSortear()"><i class="fas fa-shuffle"></i> Sortear</button>
                                    <button class="btn-planner" data-onclick="forcaIniciarSessao()"><i class="fas fa-layer-group"></i> Sessão</button>
                                    <button class="btn-planner danger" data-onclick="forcaLimparBanco()"><i class="fas fa-trash"></i> Limpar banco</button>
                                </div>

                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Banco de palavras (<span id="forcaBancoCount">0</span>)</div>
                                <div id="forcaBancoList" class="act-list"></div>
                            </div>
                        </div>

                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-gamepad"></i> Jogo</div>
                                <div class="act-mini">Clique nas letras (ou digite no teclado). <b>Esc</b> fecha o modal.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="act-hang-wrap">
                                    <div id="forcaHangman" class="act-hangman" aria-label="Desenho da forca">
                                        <svg id="forcaSvg" viewBox="0 0 200 200" role="img" aria-label="Forca">
                                            <g class="gallows">
                                                <line x1="20" y1="180" x2="140" y2="180" />
                                                <line x1="50" y1="180" x2="50" y2="20" />
                                                <line x1="48" y1="20" x2="120" y2="20" />
                                                <line x1="120" y1="20" x2="120" y2="40" />
                                                <line x1="50" y1="55" x2="75" y2="20" />
                                            </g>
                                            <g class="man">
                                                <circle class="part" data-step="1" cx="120" cy="55" r="15" />
                                                <line class="part" data-step="2" x1="120" y1="70" x2="120" y2="115" />
                                                <line class="part" data-step="3" x1="120" y1="85" x2="100" y2="100" />
                                                <line class="part" data-step="4" x1="120" y1="85" x2="140" y2="100" />
                                                <line class="part" data-step="5" x1="120" y1="115" x2="105" y2="145" />
                                                <line class="part" data-step="6" x1="120" y1="115" x2="135" y2="145" />
                                            </g>
                                        </svg>
                                    </div>

                                    <div class="act-hang-right">
                                        <div id="forcaDisplay" class="act-word">—</div>
                                        <div class="act-badges">
                                            <span class="act-badge">Erros: <span id="forcaErros">0</span>/<span id="forcaMaxErros">6</span></span>
                                            <span class="act-badge">Erradas: <span id="forcaErradas">—</span></span>
                                            <span class="act-badge">Dica: <span id="forcaDicaShow">—</span></span>
                                            <span class="act-badge">Sessão: <span id="forcaSessao">—</span></span>
                                        </div>
                                    </div>
                                </div>

                                <div style="height:12px;"></div>
                                <div id="forcaKeyboard" class="act-kbd"></div>
                                <div class="actions" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="forcaReiniciar()"><i class="fas fa-rotate"></i> Reiniciar</button>
                                    <button class="btn-planner" data-onclick="forcaRevelar()"><i class="fas fa-eye"></i> Revelar</button>
                                    <button id="forcaBtnNext" class="btn-primary" data-onclick="forcaProxima()" title="Avançar para a próxima palavra do banco"><i class="fas fa-forward"></i> Próxima</button>
                                </div>

                                <div id="forcaTheoryWrap" class="act-theory" style="display:none;">
                                    <div class="act-theory-title"><i class="fas fa-lightbulb"></i> Explicação</div>
                                    <div id="forcaTheoryText" class="act-theory-text"></div>
                                </div>

                                <div id="forcaMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VERDADEIRO / FALSO -->
                <div id="actViewVF" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-list"></i> Banco (V/F)</div>
                                <div class="act-mini">Adicione <b>perguntas</b> com a resposta correta e uma <b>explicação teórica</b>. Depois clique em <b>Iniciar sessão</b>.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group">
                                    <label for="vfTexto">Pergunta/afirmação</label>
                                    <textarea id="vfTexto" class="inp" rows="3" placeholder="Ex: O lide responde às perguntas: quem, o quê, quando, onde, como e por quê."></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="vfResposta">Resposta correta</label>
                                        <select id="vfResposta" class="inp">
                                            <option value="V">Verdadeiro</option>
                                            <option value="F">Falso</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button class="btn-primary" style="width:100%;" data-onclick="vfAdicionar()"><i class="fas fa-plus"></i> Adicionar</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="vfTeoria">Explicação teórica (aparece após responder)</label>
                                    <textarea id="vfTeoria" class="inp" rows="4" placeholder="Explique rapidamente por que é verdadeiro ou falso."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="vfTag">Categoria/Tag (opcional)</label>
                                    <input id="vfTag" class="inp" placeholder="Ex: Gramática, Interpretação, Ortografia">
                                </div>

                                <div class="actions" style="gap:10px; flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="vfIniciarSessao()"><i class="fas fa-play"></i> Iniciar sessão</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('vf')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="vfEmbaralhar()"><i class="fas fa-shuffle"></i> Embaralhar</button>
                                    <button class="btn-planner danger" data-onclick="vfLimparBanco()"><i class="fas fa-trash"></i> Limpar banco</button>
                                </div>

                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Itens (<span id="vfCount">0</span>)</div>
                                <div id="vfList" class="act-list"></div>
                            </div>
                        </div>

                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-chalkboard"></i> Sessão</div>
                                <div class="act-mini">Na área do aluno aparece só a pergunta. O aluno responde com os botões <b>Verdadeiro</b> (verde) ou <b>Falso</b> (vermelho).</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="act-mini" id="vfProgress">—</div>
                                <div style="height:10px;"></div>

                                <div id="vfShow" style="font-size:1.25rem; font-weight:900; line-height:1.25;">Adicione perguntas para começar.</div>

                                <div id="vfChoices" class="vf-choices" style="display:none;">
                                    <button id="vfBtnV" class="vf-btn vf-true" data-onclick="vfResponder('V')"><i class="fas fa-check"></i> Verdadeiro</button>
                                    <button id="vfBtnF" class="vf-btn vf-false" data-onclick="vfResponder('F')"><i class="fas fa-xmark"></i> Falso</button>
                                </div>

                                <div class="act-badges" id="vfBadgeArea" style="display:none;">
                                    <span class="act-badge" id="vfBadgeAnswer">—</span>
                                    <span class="act-badge" id="vfBadgeResult">—</span>
                                </div>

                                <div id="vfTheoryWrap" class="act-theory" style="display:none;">
                                    <div class="act-theory-title"><i class="fas fa-lightbulb"></i> Explicação</div>
                                    <div id="vfTheoryText" class="act-theory-text"></div>
                                </div>

                                <div class="actions" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="vfIniciarSessao()"><i class="fas fa-play"></i> Iniciar sessão</button>
                                    <button id="vfBtnNext" class="btn-primary" data-onclick="vfProxima()" title="Avançar para a próxima pergunta"><i class="fas fa-forward"></i> Próxima</button>
                                    <button class="btn-planner" data-onclick="vfResetSessao()"><i class="fas fa-rotate"></i> Reset</button>
                                </div>

                                <div id="vfMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MEMÓRIA -->
                <div id="actViewMem" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-layer-group"></i> Banco (pares)</div>
                                <div class="act-mini">Crie pares (ex: termo ⇄ definição). O jogo usa 8 pares (16 cartas) por padrão.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group">
                                    <label for="memA">Lado A</label>
                                    <input id="memA" class="inp" placeholder="Ex: Lide">
                                </div>
                                <div class="form-group">
                                    <label for="memB">Lado B</label>
                                    <input id="memB" class="inp" placeholder="Ex: 6 perguntas (quem, o quê, quando, onde, como, por quê)">
                                </div>
                                <div class="actions" style="gap:10px; flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="memAdicionar()"><i class="fas fa-plus"></i> Adicionar par</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('mem')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="memIniciar(4)"><i class="fas fa-play"></i> 4 pares</button>
                                    <button class="btn-planner" data-onclick="memIniciar(6)"><i class="fas fa-play"></i> 6 pares</button>
                                    <button class="btn-planner" data-onclick="memIniciar(8)"><i class="fas fa-play"></i> 8 pares</button>
                                    <button class="btn-planner" data-onclick="memIniciar(12)"><i class="fas fa-play"></i> 12 pares</button>
                                    <button class="btn-planner danger" data-onclick="memLimparBanco()"><i class="fas fa-trash"></i> Limpar banco</button>
                                </div>

                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Pares (<span id="memCount">0</span>)</div>
                                <div id="memList" class="act-list"></div>
                            </div>
                        </div>

                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-clone"></i> Jogo da Memória</div>
                                <div class="act-mini">Encontre os pares. Clique em duas cartas para comparar.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="act-badges">
                                    <span class="act-badge">Movimentos: <span id="memMoves">0</span></span>
                                    <span class="act-badge">Pares: <span id="memMatches">0</span>/<span id="memTarget">8</span></span>
                                </div>
                                <div style="height:12px;"></div>
                                <div id="memGrid" class="act-mgrid"></div>
                                <div class="actions" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="memReiniciar()"><i class="fas fa-rotate"></i> Reiniciar</button>
                                </div>
                                <div id="memMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FLASHCARDS -->
                <div id="actViewFC" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-id-card"></i> Banco (Flashcards)</div>
                                <div class="act-mini">Crie cartões de estudo (Frente ⇄ Verso). Depois clique em <b>Iniciar</b> para usar em sequência.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group">
                                    <label for="fcFront">Frente (pergunta/termo)</label>
                                    <textarea id="fcFront" class="inp" rows="2" placeholder="Ex: O que é anáfora?"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="fcBack">Verso (resposta/explicação)</label>
                                    <textarea id="fcBack" class="inp" rows="4" placeholder="Ex: Anáfora é um recurso de coesão que retoma um termo anterior..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="fcTag">Tag/Tema (opcional)</label>
                                    <input id="fcTag" class="inp" placeholder="Ex: Coesão textual">
                                </div>

                                <div class="actions" style="gap:10px; flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="fcAdicionar()"><i class="fas fa-plus"></i> Adicionar</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('fc')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="fcIniciarSessao(false)"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-planner" data-onclick="fcIniciarSessao(true)"><i class="fas fa-shuffle"></i> Iniciar embaralhado</button>
                                    <button class="btn-planner danger" data-onclick="fcLimparBanco()"><i class="fas fa-trash"></i> Limpar banco</button>
                                </div>

                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Cartões (<span id="fcCount">0</span>)</div>
                                <div id="fcList" class="act-list"></div>
                            </div>
                        </div>

                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-chalkboard"></i> Sessão</div>
                                <div class="act-mini">Clique no cartão para <b>virar</b>. Use <b>Próxima</b> para avançar na sequência.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="act-mini" id="fcProgress">—</div>
                                <div style="height:10px;"></div>

                                <div id="fcCard" class="fc-card" data-onclick="fcVirar()" role="button" tabindex="0" data-onkeydown="if(event.key==='Enter' || event.key===' '){ fcVirar(); }">
                                    <div id="fcSide" class="fc-side">Frente</div>
                                    <div id="fcText" class="fc-text">Adicione flashcards para começar.</div>
                                    <div id="fcHint" class="fc-small" style="display:none;">Clique para virar</div>
                                </div>

                                <div class="actions" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="fcVirar()"><i class="fas fa-repeat"></i> Virar</button>
                                    <button id="fcBtnPrev" class="btn-planner" data-onclick="fcAnterior()"><i class="fas fa-backward"></i> Anterior</button>
                                    <button id="fcBtnNext" class="btn-planner" data-onclick="fcProximo()"><i class="fas fa-forward"></i> Próxima</button>
                                    <button class="btn-planner" data-onclick="fcAleatorio()"><i class="fas fa-dice"></i> Aleatório</button>
                                    <button class="btn-planner" data-onclick="fcReiniciar()"><i class="fas fa-rotate"></i> Reiniciar</button>
                                </div>

                                <div id="fcMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QUIZ MÚLTIPLA ESCOLHA -->
                <div id="actViewQuiz" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-list-ol"></i> Banco (Quiz)</div>
                                <div class="act-mini">Crie perguntas com 4 alternativas. Marque a correta.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Pergunta</label><textarea id="quizPerg" class="inp" rows="2" placeholder="Ex: Qual figura de linguagem consiste em repetir palavras?"></textarea></div>
                                <div class="form-group"><label>A)</label><input id="quizA" class="inp" placeholder="Alternativa A"></div>
                                <div class="form-group"><label>B)</label><input id="quizB" class="inp" placeholder="Alternativa B"></div>
                                <div class="form-group"><label>C)</label><input id="quizC" class="inp" placeholder="Alternativa C"></div>
                                <div class="form-group"><label>D)</label><input id="quizD" class="inp" placeholder="Alternativa D"></div>
                                <div class="form-row"><div class="form-group"><label>Correta</label><select id="quizCorreta" class="inp"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select></div>
                                <div class="form-group"><label>&nbsp;</label><button class="btn-primary" style="width:100%;" data-onclick="quizAdicionar()"><i class="fas fa-plus"></i> Adicionar</button></div></div>
                                <div class="form-group"><label>Explicação (opcional)</label><textarea id="quizExp" class="inp" rows="2" placeholder="Por que esta é a resposta correta?"></textarea></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;"><button class="btn-planner" data-onclick="quizIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button><button class="btn-planner" data-onclick="actBulkOpen('quiz')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button><button class="btn-planner danger" data-onclick="quizLimparBanco()"><i class="fas fa-trash"></i> Limpar</button></div>
                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Perguntas (<span id="quizCount">0</span>)</div>
                                <div id="quizList" class="act-list"></div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-chalkboard"></i> Sessão</div></div>
                            <div class="act-panel-body" style="position:relative;">
                                <div id="quizScorebar"></div>
                                <div id="quizProgress" class="act-mini">—</div>
                                <div id="quizShow" style="font-size:1.25rem;font-weight:900;line-height:1.25;margin:10px 0;">Adicione perguntas para começar.</div>
                                <div id="quizOptions" class="quiz-options"></div>
                                <div id="quizTheoryWrap" class="act-theory" style="display:none;"><div class="act-theory-title"><i class="fas fa-lightbulb"></i> Explicação</div><div id="quizTheoryText" class="act-theory-text"></div></div>
                                <div class="actions" style="margin-top:12px;gap:10px;flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="quizIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button id="quizBtnNext" class="btn-primary" data-onclick="quizProxima()"><i class="fas fa-forward"></i> Próxima</button>
                                </div>
                                <div id="quizMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COMPLETAR FRASE -->
                <div id="actViewComp" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-pen-nib"></i> Banco (Completar)</div>
                                <div class="act-mini">Escreva frases com <b>___</b> no lugar da palavra a completar.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Frase (use ___ para a lacuna)</label><textarea id="compFrase" class="inp" rows="2" placeholder="Ex: O sujeito da oração é quem ___ a ação."></textarea></div>
                                <div class="form-group"><label>Resposta correta</label><input id="compResp" class="inp" placeholder="Ex: pratica"></div>
                                <div class="form-group"><label>Explicação (opcional)</label><input id="compExp" class="inp" placeholder="Explicação breve"></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="compAdicionar()"><i class="fas fa-plus"></i> Adicionar</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('comp')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="compIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-planner danger" data-onclick="compLimparBanco()"><i class="fas fa-trash"></i> Limpar</button>
                                </div>
                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Frases (<span id="compCount">0</span>)</div>
                                <div id="compList" class="act-list"></div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-chalkboard"></i> Sessão</div></div>
                            <div class="act-panel-body" style="position:relative;">
                                <div id="compScorebar"></div>
                                <div id="compProgress" class="act-mini">—</div>
                                <div id="compShow" class="comp-phrase">Adicione frases para começar.</div>
                                <div id="compInputArea" style="display:none;text-align:center;"><input id="compAnswer" class="comp-input" placeholder="Digite a resposta..." autocomplete="off"><br><button class="btn-primary" data-onclick="compVerificar()" style="margin-top:8px;"><i class="fas fa-check"></i> Verificar</button></div>
                                <div id="compTheoryWrap" class="act-theory" style="display:none;"><div class="act-theory-title"><i class="fas fa-lightbulb"></i> Explicação</div><div id="compTheoryText" class="act-theory-text"></div></div>
                                <div class="actions" style="margin-top:12px;gap:10px;flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="compIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button id="compBtnNext" class="btn-primary" data-onclick="compProxima()"><i class="fas fa-forward"></i> Próxima</button>
                                </div>
                                <div id="compMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ORDENAR PALAVRAS -->
                <div id="actViewOrd" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header">
                                <div class="act-title"><i class="fas fa-sort"></i> Banco (Ordenar)</div>
                                <div class="act-mini">Escreva frases corretas. O jogo embaralha as palavras para o aluno reordenar.</div>
                            </div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Frase na ordem correta</label><textarea id="ordFrase" class="inp" rows="2" placeholder="Ex: O gato bebeu o leite da tigela."></textarea></div>
                                <div class="form-group"><label>Dica (opcional)</label><input id="ordDica" class="inp" placeholder="Ex: Sujeito + Verbo + Objeto"></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="ordAdicionar()"><i class="fas fa-plus"></i> Adicionar</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('ord')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="ordIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-planner danger" data-onclick="ordLimparBanco()"><i class="fas fa-trash"></i> Limpar</button>
                                </div>
                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Frases (<span id="ordCount">0</span>)</div>
                                <div id="ordList" class="act-list"></div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-chalkboard"></i> Sessão</div></div>
                            <div class="act-panel-body" style="position:relative;">
                                <div id="ordScorebar"></div>
                                <div id="ordProgress" class="act-mini">—</div>
                                <div id="ordHint" class="act-mini" style="display:none;"></div>
                                <div id="ordAnswer" class="ord-answer"></div>
                                <div id="ordWords" class="ord-words"></div>
                                <div class="actions" style="margin-top:12px;gap:10px;flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="ordIniciarSessao()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-primary" data-onclick="ordVerificar()"><i class="fas fa-check"></i> Verificar</button>
                                    <button id="ordBtnNext" class="btn-primary" data-onclick="ordProxima()"><i class="fas fa-forward"></i> Próxima</button>
                                    <button class="btn-planner" data-onclick="ordLimpar()"><i class="fas fa-rotate"></i> Limpar</button>
                                </div>
                                <div id="ordMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- RELACIONAR COLUNAS -->
                <div id="actViewRel" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-arrows-left-right"></i> Banco (Relacionar)</div><div class="act-mini">Adicione pares para relacionar. Formato: <b>Item A | Item B</b></div></div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Item A (esquerda)</label><input id="relA" class="inp" placeholder="Ex: Brasil"></div>
                                <div class="form-group"><label>Item B (direita)</label><input id="relB" class="inp" placeholder="Ex: Brasília"></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="relAdicionar()"><i class="fas fa-plus"></i> Adicionar</button>
                                    <button class="btn-planner" data-onclick="actBulkOpen('rel')" style="background:#7c3aed22;border-color:#7c3aed;color:#7c3aed;"><i class="fas fa-paste"></i> Colar em Lote</button>
                                    <button class="btn-planner" data-onclick="relIniciar()"><i class="fas fa-play"></i> Iniciar</button>
                                    <button class="btn-planner danger" data-onclick="relLimparBanco()"><i class="fas fa-trash"></i> Limpar</button>
                                </div>
                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-database"></i> Pares (<span id="relCount">0</span>)</div>
                                <div id="relList" class="act-list"></div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-gamepad"></i> Jogo</div><div class="act-mini">Clique em um item da esquerda, depois no correspondente da direita.</div></div>
                            <div class="act-panel-body" style="position:relative;">
                                <div id="relScorebar"></div>
                                <div id="relBoard" class="rel-board" style="min-height:200px;"><div class="act-mini">Adicione pares e clique Iniciar.</div></div>
                                <div class="actions" style="margin-top:12px;gap:10px;flex-wrap:wrap;">
                                    <button class="btn-planner" data-onclick="relIniciar()"><i class="fas fa-play"></i> Reiniciar</button>
                                </div>
                                <div id="relMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROLETA -->
                <div id="actViewRoleta" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-circle-notch"></i> Itens da Roleta</div><div class="act-mini">Adicione itens manualmente ou importe de outro banco.</div></div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Novo item</label><input id="roletaItem" class="inp" placeholder="Ex: Grupo 1"></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="roletaAdd()"><i class="fas fa-plus"></i> Adicionar</button>
                                    <button class="btn-planner" data-onclick="roletaFromBank('forca')"><i class="fas fa-skull"></i> Da Forca</button>
                                    <button class="btn-planner" data-onclick="roletaFromBank('vf')"><i class="fas fa-check-double"></i> Do V/F</button>
                                    <button class="btn-planner" data-onclick="roletaFromBank('fc')"><i class="fas fa-id-card"></i> Dos Flashcards</button>
                                    <button class="btn-planner" data-onclick="roletaFromAlunos()"><i class="fas fa-users"></i> Dos Alunos</button>
                                    <button class="btn-planner danger" data-onclick="roletaLimpar()"><i class="fas fa-trash"></i> Limpar</button>
                                </div>
                                <div class="act-mini" style="margin-top:10px;"><i class="fas fa-list"></i> Itens (<span id="roletaCount">0</span>)</div>
                                <div id="roletaList" class="act-list" style="max-height:200px;overflow-y:auto;"></div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-circle-notch"></i> Roleta</div></div>
                            <div class="act-panel-body" style="text-align:center;">
                                <div class="roleta-wrap">
                                    <div class="roleta-canvas-wrap"><div class="roleta-pointer">▼</div><canvas id="roletaCanvas" width="640" height="640"></canvas></div>
                                    <div id="roletaResult" class="roleta-result">Adicione itens e gire!</div>
                                    <button class="btn-primary" data-onclick="roletaSpin()" style="font-size:1.1rem;padding:14px 32px;"><i class="fas fa-rotate"></i> Girar!</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CAÇA-PALAVRAS -->
                <div id="actViewWs" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-magnifying-glass"></i> Caça-palavras</div><div class="act-mini">Adicione palavras ou importe do banco da Forca.</div></div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Palavras (uma por linha)</label><textarea id="wsWords" class="inp" rows="5" placeholder="CASA&#10;ESCOLA&#10;PROFESSOR&#10;ALUNO"></textarea></div>
                                <div class="form-row" style="gap:10px;">
                                    <div class="form-group"><label>Grade</label><select id="wsSize" class="inp"><option value="10">10×10</option><option value="12">12×12</option><option value="15" selected>15×15</option><option value="18">18×18</option></select></div>
                                </div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="wsGerar()"><i class="fas fa-play"></i> Gerar</button>
                                    <button class="btn-planner" data-onclick="wsFromForca()"><i class="fas fa-skull"></i> Da Forca</button>
                                    <button class="btn-planner" data-onclick="wsRevelar()"><i class="fas fa-eye"></i> Revelar</button>
                                </div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-magnifying-glass"></i> Grade</div></div>
                            <div class="act-panel-body" style="text-align:center;overflow-x:auto;">
                                <div id="wsGrid" style="display:inline-block;"></div>
                                <div id="wsWordList" class="ws-wordlist"></div>
                                <div id="wsMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CRUZADINHA -->
                <div id="actViewCw" class="act-view" style="display:none;">
                    <div class="act-grid">
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-hashtag"></i> Cruzadinha</div><div class="act-mini">Palavras + dicas. Use o banco da Forca ou digite.</div></div>
                            <div class="act-panel-body">
                                <div class="form-group"><label>Palavras e dicas (palavra | dica)</label><textarea id="cwInput" class="inp" rows="6" placeholder="CASA | Lugar onde moramos&#10;ESCOLA | Lugar de aprendizado&#10;ALUNO | Quem estuda"></textarea></div>
                                <div class="actions" style="gap:10px;flex-wrap:wrap;">
                                    <button class="btn-primary" data-onclick="cwGerar()"><i class="fas fa-play"></i> Gerar</button>
                                    <button class="btn-planner" data-onclick="cwFromForca()"><i class="fas fa-skull"></i> Da Forca</button>
                                    <button class="btn-planner" data-onclick="cwVerificar()"><i class="fas fa-check"></i> Verificar</button>
                                    <button class="btn-planner" data-onclick="cwRevelar()"><i class="fas fa-eye"></i> Revelar</button>
                                </div>
                            </div>
                        </div>
                        <div class="act-panel">
                            <div class="act-panel-header"><div class="act-title"><i class="fas fa-hashtag"></i> Grade</div></div>
                            <div class="act-panel-body" style="text-align:center;overflow-x:auto;">
                                <div id="cwGrid"></div>
                                <div id="cwClues" class="cw-clues"></div>
                                <div id="cwMsg" class="act-mini" style="margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Timer global config -->
            <div style="padding:4px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:.78rem;border-top:1px solid var(--border-color);">
                <span class="act-timer-cfg"><i class="fas fa-clock"></i> Timer: <select id="actTimerCfg" data-onchange="actSetTimerCfg()"><option value="0">Sem limite</option><option value="30">30s</option><option value="60">60s</option><option value="90">90s</option></select></span>
                <span style="color:#64748b;">|</span>
                <span id="actGlobalScore" style="font-weight:600;color:#64748b;">Placar: —</span>
                <span style="color:#64748b;">|</span>
                <label class="act-sound-toggle" title="Efeitos sonoros"><input type="checkbox" id="actSoundToggle" checked onchange="actSoundEnabled=this.checked"> <i class="fas fa-volume-high"></i> Sons</label>
                <span style="color:#64748b;">|</span>
                <button style="padding:2px 10px;border:1px solid #cbd5e1;border-radius:6px;background:transparent;cursor:pointer;font-size:.72rem;color:#64748b;" data-onclick="actRankingOpen()"><i class="fas fa-trophy"></i> Ranking</button>
                <button style="padding:2px 10px;border:1px solid #cbd5e1;border-radius:6px;background:transparent;cursor:pointer;font-size:.72rem;color:#64748b;" data-onclick="actQROpen()"><i class="fas fa-qrcode"></i> QR</button>
            </div>

            <div class="modal-footer-xl">
                <div class="planner-mini"><i class="fas fa-shield-heart"></i> Atividades locais: ficam no navegador (localStorage) e podem ser exportadas/importadas.</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-planner" data-onclick="fecharModais()"><i class="fas fa-xmark"></i> Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal: AutoTeste -->
    <div id="modalAutoTeste" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="max-width:780px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 style="margin:0;color:var(--text-main);font-size:1.2rem;"><i class="fas fa-stethoscope" style="color:var(--primary);"></i> AutoTeste do Sistema</h3>
                <button data-onclick="fecharModalAutoTeste()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">✕</button>
            </div>
            <div id="autoTesteBody" style="max-height:70vh;overflow:auto;padding-right:6px;"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;">
                <button class="btn-primary" style="padding:10px 14px;" data-onclick="autoTesteCopiar()"><i class="fas fa-copy"></i> Copiar relatório</button>
                <button class="btn-primary" style="padding:10px 14px;background:transparent;color:var(--text-main);border:2px solid var(--border-color);" data-onclick="fecharModalAutoTeste()"><i class="fas fa-times"></i> Fechar</button>
            </div>
        </div>
    </div>





    <div id="printArea" style="visibility:hidden;"></div>

    <script>
        // --- ESTADOS ---
        let turmas=[], alunos=[], aulas=[], planosSemana={}, correcaoProvas={}, filtroTurma='Todas', alunoEdicaoID=null, abaAtual='lp', visaoAtual='cards', bimestreAtual=1, filtroRiscoAtivo=false, filtroInclusaoAtivo=false, privacyMode=false, currMes=new Date().getMonth(), currAno=new Date().getFullYear();
        // === Eventos internos (evita monkey patches) ===
        const __SGP_EVT = (()=> {
            const map = Object.create(null);
            return {
                on(name, fn){
                    if(!name || typeof fn !== 'function') return;
                    (map[name] = map[name] || []).push(fn);
                },
                emit(name, payload){
                    const arr = map[name];
                    if(!arr || !arr.length) return;
                    arr.forEach(fn => { try{ fn(payload); }catch(e){ console.warn('[SGP] evento', name, 'falhou', e); try{ if(typeof __diagCapture==='function') __diagCapture(e, 'evt:'+name); }catch(_){} } });
                }
            };
        })();

        // === LocalStorage seguro (quota/JSON) ===
        function __isQuotaError(e){
            try{
                return !!(e && (e.name === 'QuotaExceededError' || e.code === 22 || e.number === -2147024882));
            }catch(_){ return false; }
        }
        function __safeLSSet(key, value){
            try{
                localStorage.setItem(key, value);
                return true;
            }catch(e){
                console.warn('[SGP] Falha ao salvar no localStorage:', key, e);
                const isQuota = (typeof __isQuotaError==='function') ? __isQuotaError(e) : false;
                try{ if(typeof __diagCapture==='function') __diagCapture(e, 'localStorage.setItem', {key, quota:isQuota}); }catch(_){}
                try{
                    if(typeof __AUDIT !== 'undefined' && Array.isArray(__AUDIT)){
                        __AUDIT.push({ ts: Date.now(), msg: isQuota ? "Falha ao salvar: armazenamento cheio (quota)" : "Falha ao salvar no armazenamento (localStorage)" });
                        if(__AUDIT.length > 500) __AUDIT.shift();
                    }
                }catch(_){}
                try{
                    if(isQuota && typeof __showSaveFailDialog === 'function'){
                        __showSaveFailDialog("Armazenamento do navegador cheio. Para evitar perda de dados, baixe um backup ZIP agora.");
                    }else if(typeof showToast === 'function'){
                        showToast(isQuota
                            ? "Armazenamento do navegador cheio. Faça um backup (ZIP) e limpe dados antigos."
                            : "Falha ao salvar dados no navegador.", "error");
                    }
                }catch(_){}
                return false;
            }
        }
        // === IDs numéricos seguros (evita colisões de Date.now()+Math.random por perda de precisão) ===
        function __idSeqNext(){
            try{
                const K = 'sgp_id_seq';
                let v = parseInt(localStorage.getItem(K) || '0', 10);
                if(!isFinite(v) || v < 0) v = 0;
                v = (v + 1) % 1000; // 0..999
                __safeLSSet(K, String(v));
                return v;
            }catch(_){
                return Math.floor(Math.random()*1000);
            }
        }
        function __newId(){
            // Safe integer: (ms * 1000) + seq (0..999)
            return (Date.now() * 1000) + __idSeqNext();
        }
        function __dedupeAlunoIds(){
            try{
                if(!Array.isArray(alunos) || alunos.length < 2) return;
                const seen = new Map();
                const dupes = [];
                for(let i=0;i<alunos.length;i++){
                    const a = alunos[i];
                    const k = (a && (a.id!==undefined && a.id!==null)) ? String(a.id) : '';
                    if(!k) continue;
                    if(seen.has(k)) dupes.push({idx:i, old:k});
                    else seen.set(k, i);
                }
                if(!dupes.length) return;

                const remaps = [];
                for(const d of dupes){
                    let nid = __newId();
                    let guard = 0;
                    while(seen.has(String(nid)) && guard < 6){ nid = __newId(); guard++; }
                    alunos[d.idx].id = nid;
                    remaps.push({old:d.old, neu:String(nid)});
                    seen.set(String(nid), d.idx);
                }

                // Aplica remapeamentos em dados que usam alunoId como chave
                for(const r of remaps){
                    const oldK = r.old, newK = r.neu;

                    // Entregas
                    try{
                        const E = window.__sgpEntregas;
                        if(E && typeof E === 'object'){
                            Object.keys(E).forEach(k=>{
                                const blk = E[k];
                                if(blk && blk.entregas && typeof blk.entregas === 'object'){
                                    if(blk.entregas[oldK] !== undefined && blk.entregas[newK] === undefined){
                                        try{ blk.entregas[newK] = JSON.parse(JSON.stringify(blk.entregas[oldK])); }
                                        catch(_){ blk.entregas[newK] = blk.entregas[oldK]; }
                                    }
                                }
                            });
                            __safeLSSet('sgp_entregas', JSON.stringify(E));
                        }
                    }catch(_){}

                    // Frequência
                    try{
                        const F = window.__sgpFrequencia;
                        if(F && typeof F === 'object'){
                            Object.keys(F).forEach(k=>{
                                const reg = F[k];
                                if(reg && typeof reg === 'object'){
                                    if(reg[oldK] !== undefined && reg[newK] === undefined){
                                        reg[newK] = reg[oldK];
                                    }
                                }
                            });
                            __safeLSSet('sgp_frequencia', JSON.stringify(F));
                        }
                    }catch(_){}

                    // Ranking
                    try{
                        const R = JSON.parse(localStorage.getItem('sgp_ranking_v1')||'{}');
                        if(R && typeof R === 'object'){
                            Object.keys(R).forEach(turma=>{
                                const byB = R[turma];
                                if(!byB || typeof byB !== 'object') return;
                                Object.keys(byB).forEach(bim=>{
                                    const byId = byB[bim];
                                    if(byId && typeof byId === 'object'){
                                        if(byId[oldK] !== undefined && byId[newK] === undefined){
                                            try{ byId[newK] = JSON.parse(JSON.stringify(byId[oldK])); }
                                            catch(_){ byId[newK] = byId[oldK]; }
                                        }
                                    }
                                });
                            });
                            __safeLSSet('sgp_ranking_v1', JSON.stringify(R));
                        }
                    }catch(_){}
                }

                try{ if(typeof salvarDadosLocal === 'function') salvarDadosLocal(); }catch(_){}
                try{ if(typeof showToast === 'function') showToast('IDs de alunos corrigidos (colisão detectada).', 'warning'); }catch(_){}
            }catch(e){
                try{ if(typeof __diagCapture==='function') __diagCapture(e, '__dedupeAlunoIds'); }catch(_){}
            }
        }






        // === Helper DOM: remover elemento com segurança (evita optional chaining em handlers inline) ===
        function __sgpRemoveEl(id){
            try{
                var el = document.getElementById(id);
                if(!el) return;
                if(typeof el.remove === 'function') el.remove();
                else if(el.parentNode) el.parentNode.removeChild(el);
            }catch(_){ }
        }


        // === Helpers adicionais: storage remove + detecção de modo temporário + bibliotecas externas + arquivo de estado ===
        function __safeLSRemove(key){
            try{ localStorage.removeItem(key); return true; }
            catch(e){
                console.warn('[SGP] Falha ao remover do localStorage:', key, e);
                try{ if(typeof __diagCapture==='function') __diagCapture(e, 'localStorage.removeItem', {key}); }catch(_){}
                return false;
            }
        }

        function __isTempPath(){
            try{
                const href = String(location && location.href ? location.href : '');
                return /AppData\/Local\/Temp|\/Temp\//i.test(href);
            }catch(_){ return false; }
        }

        function __warnTempPath(){
            try{
                if(!__isTempPath()) return;
                const msg = "Aviso: você abriu o SGP em uma pasta temporária (TEMP). Isso pode fazer os dados 'sumirem' porque o navegador trata como outra origem. Extraia o ZIP para uma pasta fixa (ex.: Documentos\\SGP) e abra o HTML de lá.";
                try{ if(typeof showToast==='function') showToast(msg, "warning"); }catch(_){}
                try{ if(typeof __AUDIT!=='undefined' && Array.isArray(__AUDIT)) __AUDIT.push({ts:Date.now(), msg:"TEMP: " + msg}); }catch(_){}
            }catch(_){}
        }

        function __ensureHtml2pdfFallback(){
            try{
                if(typeof window.html2pdf === 'function') return true;
                // Se o CDN não carregou (offline), cria um fallback compatível que usa impressão do navegador.
                window.html2pdf = function(){
                    const api = {
                        _el: null,
                        _opt: null,
                        set(opt){ api._opt = opt || null; return api; },
                        from(el){ api._el = el || null; return api; },
                        save(filename){
                            try{
                                const title = (filename || (api._opt && api._opt.filename) || 'documento');
                                const win = window.open('', '_blank');
                                if(!win) throw new Error("Pop-up bloqueado");
                                win.document.open();
                                win.document.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>'+String(title).replace(/</g,'&lt;')+'</title>');
                                win.document.write('<style>body{font-family:Arial,sans-serif; padding:16px;}@page{margin:12mm;} </style>');
                                win.document.write('</head><body>');
                                if(api._el){
                                    win.document.write(api._el.outerHTML);
                                }else{
                                    win.document.write('<div>Conteúdo indisponível para impressão.</div>');
                                }
                                win.document.write('</body></html>');
                                win.document.close();
                                win.focus();
                                setTimeout(()=>{ try{ win.print(); }catch(_){ } }, 450);
                                try{ if(typeof showToast==='function') showToast("PDF offline: abrindo impressão do navegador como alternativa.", "warning"); }catch(_){}
                            }catch(e){
                                try{ if(typeof showToast==='function') showToast("Não foi possível abrir a impressão (pop-up bloqueado).", "error"); }catch(_){}
                                try{ if(typeof __diagCapture==='function') __diagCapture(e, 'html2pdf_fallback'); }catch(_){}
                            }
                            return api;
                        }
                    };
                    return api;
                };
                return true;
            }catch(_){ return false; }
        }

        function __checkExternalLibs(){
            try{
                const missing = [];
                const hadErrs = Array.isArray(window.__SGP_LIB_ERRORS) && window.__SGP_LIB_ERRORS.length;
                if(typeof window.html2pdf !== 'function'){ missing.push('PDF (html2pdf)'); __ensureHtml2pdfFallback(); }
                if(typeof window.Chart !== 'function'){ missing.push('Gráficos (Chart.js)'); }
                if(hadErrs || missing.length){
                    const msg = missing.length
                      ? ("Modo offline: bibliotecas externas não carregaram (" + missing.join(', ') + "). Alguns recursos usarão alternativas.")
                      : ("Aviso: houve falha ao carregar bibliotecas externas. Alguns recursos podem ficar limitados.");
                    try{ if(typeof showToast==='function') showToast(msg, "warning"); }catch(_){}
                    try{ if(typeof __AUDIT!=='undefined' && Array.isArray(__AUDIT)) __AUDIT.push({ts:Date.now(), msg:"LIBS: " + msg}); }catch(_){}
                }
            }catch(_){}
        }

        function __downloadBlob(blob, filename){
            try{
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                a.href = url;
                a.download = filename || 'arquivo';
                // Alguns navegadores exigem que o link esteja no DOM
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){ } }, 2500);
            }catch(e){
                try{ console.error(e); }catch(_){}
            }
        }

        function __exportState(){
            const out = {
                format: "SGP_STATE_EXPORT_V1",
                exportedAt: new Date().toISOString(),
                appTitle: document.title,
                storage: {}
            };
            try{
                for(let i=0;i<localStorage.length;i++){
                    const k = localStorage.key(i);
                    if(k && k.startsWith('sgp_')){
                        out.storage[k] = localStorage.getItem(k);
                    }
                }
            }catch(e){
                try{ if(typeof __diagCapture==='function') __diagCapture(e, '__exportState'); }catch(_){}
            }
            return out;
        }

        function __importStateObject(obj){
            if(!obj || typeof obj !== 'object') throw new Error("Arquivo inválido");
            const storage = obj.storage;
            if(!storage || typeof storage !== 'object') throw new Error("Arquivo inválido (sem storage)");
            // Grava as chaves sgp_ exatamente como estavam
            const keys = Object.keys(storage).filter(k=>k && k.startsWith('sgp_'));
            if(!keys.length) throw new Error("Arquivo inválido (sem chaves sgp_)");
            keys.forEach(k=>{
                __safeLSSet(k, storage[k]);
            });
        }

        function __openFileViaInput(accept){
            return new Promise((resolve, reject)=>{
                try{
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = accept || '.json,application/json';
                    input.style.display = 'none';
                    document.body.appendChild(input);
                    input.addEventListener('change', ()=>{
                        const f = input.files && input.files[0];
                        input.remove();
                        if(!f) return reject(new Error("Nenhum arquivo selecionado"));
                        resolve(f);
                    });
                    input.click();
                }catch(e){ reject(e); }
            });
        }

        async function salvarEstadoArquivo(){
            try{
                const obj = __exportState();
                const jsonStr = JSON.stringify(obj, null, 2);
                const suggested = 'sgp_estado_' + new Date().toISOString().slice(0,10) + '.json';

                if(window.showSaveFilePicker){
                    const handle = await window.showSaveFilePicker({
                        suggestedName: suggested,
                        types: [{ description: 'Arquivo JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(jsonStr);
                    await writable.close();
                }else{
                    __downloadBlob(new Blob([jsonStr], {type:'application/json'}), suggested);
                }

                dadosNaoSalvosEmArquivo = false;
                try{ if(typeof showToast==='function') showToast("Estado salvo em arquivo (.json)."); }catch(_){}
                try{ if(typeof __AUDIT!=='undefined' && Array.isArray(__AUDIT)) __AUDIT.push({ts:Date.now(), msg:"Arquivo: estado salvo (.json)"}); }catch(_){}
            }catch(e){
                console.error(e);
                try{ if(typeof showToast==='function') showToast("Erro ao salvar estado em arquivo.", "error"); }catch(_){}
                try{ if(typeof __diagCapture==='function') __diagCapture(e, 'salvarEstadoArquivo'); }catch(_){}
            }
        }

        async function abrirEstadoArquivo(){
            try{
                const ok = confirm("Importar estado irá substituir os dados locais salvos neste navegador. Deseja continuar?");
                if(!ok) return;

                let file = null;
                if(window.showOpenFilePicker){
                    const [handle] = await window.showOpenFilePicker({
                        multiple: false,
                        types: [{ description: 'Arquivo JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    file = await handle.getFile();
                }else{
                    file = await __openFileViaInput('.json,application/json');
                }
                const txt = await file.text();
                const obj = JSON.parse(txt);
                __importStateObject(obj);

                try{ if(typeof showToast==='function') showToast("Estado importado. Recarregando..."); }catch(_){}
                setTimeout(()=>{ try{ location.reload(); }catch(_){ } }, 650);
            }catch(e){
                console.error(e);
                try{ if(typeof showToast==='function') showToast("Erro ao abrir/importar estado.", "error"); }catch(_){}
                try{ if(typeof __diagCapture==='function') __diagCapture(e, 'abrirEstadoArquivo'); }catch(_){}
            }
        }

// === STATUS DE BACKUP (sidebar) ===
// Mostra/oculta o alerta "Backup Pendente!" de forma persistente.
// Regra: se o último salvamento local (core) for mais recente que o último backup ZIP, então o alerta aparece.
function checkBackupStatus(){
  try{
    const el = document.getElementById('backupAlert');
    if(!el) return;

    let lastSave = 0;
    try{
      const ls = parseInt(localStorage.getItem('sgp_last_core_save') || '0', 10);
      if(!isNaN(ls) && ls>0) lastSave = ls;
    }catch(_){}

    // Fallback: tenta ler o ts do core atômico (se existir) como fonte de "último salvamento"
    if(!lastSave){
      try{
        const k = (typeof __SGP_ATOMIC_CORE_KEY === 'string') ? __SGP_ATOMIC_CORE_KEY : 'sgp_state_core_v1';
        const raw = localStorage.getItem(k);
        if(raw){
          const obj = JSON.parse(raw);
          const ts = parseInt(obj && obj.ts ? obj.ts : 0, 10);
          if(!isNaN(ts) && ts>0) lastSave = ts;
        }
      }catch(_){}
    }

    let lastBackup = 0;
    try{
      const lb = parseInt(localStorage.getItem('sgp_last_backup') || '0', 10);
      if(!isNaN(lb) && lb>0) lastBackup = lb;
    }catch(_){}

    const pending = !!(lastSave && (!lastBackup || lastBackup < lastSave));

    // Persistência simples (para casos em que o usuário fecha antes de salvar de novo)
    try{ __safeLSSet('sgp_backup_pending', pending ? '1' : '0'); }catch(_){}

    el.style.display = pending ? 'block' : 'none';

    // Tooltip informativo (sem alterar layout)
    try{
      if(lastBackup){
        el.title = 'Último backup: ' + new Date(lastBackup).toLocaleString('pt-BR');
      }else{
        el.title = 'Nenhum backup ZIP registrado ainda.';
      }
    }catch(_){}
  }catch(_){}
}




        let timerInterval=null, timeLeft=0;
        let dadosNaoSalvosEmArquivo = false;
        let alunoSelecionadoParaMover = null;
        let buscaGlobal = '';
        let notasModificadas = false; // Controle de modificação na edição em massa
        
        // CONFIGURAÇÕES GLOBAIS
        let config = {
            materia1: "Português",
            materia2: "Redação",
            pesos: { a1: 15, a2: 15, a3: 15, a4: 15, a5: 30, rec: 10 },
            rec_substitui: false
        };
        let layouts = {}; 

        // PLANNER (v1)
        let plannerTasks = [];
        let plannerView = 'today';
        let plannerSelectedId = null;
        let plannerWeekAnchorISO = null; // segunda-feira da semana em foco
        


        
        // === PERFORMANCE & ATALHOS (v12.8) ===
        let __renderHandle = 0;
        function scheduleRenderVisaoContent(){
            if(__renderHandle) return;
            const run = () => { __renderHandle = 0; renderizarVisaoContent(); };
            if(window.requestAnimationFrame){
                __renderHandle = requestAnimationFrame(run);
            } else {
                __renderHandle = setTimeout(run, 16);
            }
        }

        function _isTypingTarget(el){
            if(!el) return false;
            const tag = (el.tagName || '').toUpperCase();
            return tag === 'INPUT' || tag === 'TEXTAREA' || el.isContentEditable;
        }

        let __buscaTimer = null;

        function _isModalOpenById(id){
            const el = document.getElementById(id);
            if(!el) return false;
            const st = getComputedStyle(el);
            return st.display !== 'none' && st.visibility !== 'hidden' && st.opacity !== '0';
        }
        function _anyModalOpen(){
            return Array.from(document.querySelectorAll('.modal-overlay')).some(m=>{
                const st = getComputedStyle(m);
                return st.display !== 'none' && st.visibility !== 'hidden' && st.opacity !== '0';
            });
        }

        function initKeyboardShortcuts(){
            if(window.__SGP_KB_BOUND) return;
            window.__SGP_KB_BOUND = true;

            document.addEventListener('keydown', (e)=>{
                const key = e.key;
                const active = document.activeElement;

                const ctrl = e.ctrlKey || e.metaKey;
                const shift = e.shiftKey;

                const typing = _isTypingTarget(active);

                // Diagnóstico: Ctrl+Shift+D
                if(ctrl && shift && (key === 'D' || key === 'd')){
                    e.preventDefault();
                    if(typeof abrirDiagnosticoPainel === 'function') abrirDiagnosticoPainel();
                    return;
                }

                // Focar busca global: "/" ou Ctrl+K ou Ctrl+F (não interfere ao digitar)
                if(!typing && (key === '/' || (ctrl && key.toLowerCase() === 'k') || (ctrl && key.toLowerCase() === 'f'))){
                    e.preventDefault();
                    const inp = document.getElementById('searchGlobal');
                    if(inp){
                        inp.focus();
                        if(typeof inp.select === 'function') inp.select();
                    }
                    return;
                }

                // Novo aluno: Ctrl+N
                if(!typing && ctrl && key.toLowerCase() === 'n'){
                    e.preventDefault();
                    if(typeof abrirModalAluno === 'function') abrirModalAluno();
                    return;
                }

                // Trocar bimestre: teclas 1-4 (apenas fora de inputs e sem modal aberto)
                if(!typing && !ctrl && !e.altKey && !e.metaKey && /^[1-4]$/.test(key) && !_anyModalOpen()){
                    const nb = parseInt(key, 10);
                    if(typeof mudarBimestre === 'function') mudarBimestre(nb);
                    return;
                }

                // Fechar modais / limpar busca: Esc
                if(key === 'Escape'){
                    if(_anyModalOpen()){
                        e.preventDefault();
                        if(typeof fecharModais === 'function') fecharModais();
                        return;
                    }
                    const search = document.getElementById('searchGlobal');
                    if(search && search.value){
                        e.preventDefault();
                        if(typeof limparBusca === 'function') limparBusca();
                        return;
                    }
                    return;
                }

                // Salvar: Ctrl+S (ou Cmd+S no Mac)
                if(ctrl && key.toLowerCase() === 's'){
                    e.preventDefault();

                    if(_isModalOpenById('modalDetalhes') && typeof salvarAlteracoesDetalhadas === 'function'){
                        salvarAlteracoesDetalhadas();
                        return;
                    }
                    if(_isModalOpenById('modalConfig') && typeof salvarConfig === 'function'){
                        salvarConfig();
                        return;
                    }
                    // Edição em massa
                    const btn = document.getElementById('btnSalvarMassa');
                    if(visaoAtual === 'massa' && btn && getComputedStyle(btn).display !== 'none' && typeof salvarEdicaoMassa === 'function'){
                        salvarEdicaoMassa();
                        return;
                    }
                    // Evita "Salvar página" do navegador
                    return;
                }

                // Undo/Redo (histórico interno) - não interfere ao digitar
                if(!typing && ctrl && !shift && key.toLowerCase() === 'z'){
                    e.preventDefault();
                    if(typeof undo === 'function') undo();
                    return;
                }
                if(!typing && ctrl && (key.toLowerCase() === 'y' || (shift && key.toLowerCase() === 'z'))){
                    e.preventDefault();
                    if(typeof redo === 'function') redo();
                    return;
                }

            }, {capture:true});
        }


/* =========================
   CORREÇÃO (PROVAS/ATIVIDADES)
   - Gabarito (10 questões A-D)
   - Respostas por aluno (campo verde/vermelho)
   - Estatísticas por questão e por BNCC/Aula
   Armazenamento: localStorage 'sgp_correcao_provas'
========================= */

let __corChartQ = null;
let __corChartB = null;

function escAttr(s){ return escHTML(s); }

function corSave(){
  try{
    const str = JSON.stringify(correcaoProvas || {});
    if(typeof __safeLSSet === 'function'){
      if(!__safeLSSet('sgp_correcao_provas', str)){
        try{ if(typeof showToast==='function') showToast('Erro ao salvar correção (armazenamento cheio?)', 'error'); }catch(_){}
      }
    } else {
      localStorage.setItem('sgp_correcao_provas', str);
    }
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corSave',{}); }catch(_){}
    try{ if(typeof showToast==='function') showToast('Erro ao salvar correção.', 'error'); }catch(_){}
  }
  // Marca que há alterações locais mais recentes que o último backup ZIP
  try{
    const __now = Date.now();
    if(typeof __safeLSSet === 'function'){
      __safeLSSet('sgp_last_core_save', __now);
      __safeLSSet('sgp_backup_pending', '1');
    }else{
      localStorage.setItem('sgp_last_core_save', String(__now));
      localStorage.setItem('sgp_backup_pending', '1');
    }
  }catch(_){}

  try{ checkBackupStatus(); }catch(_){}
}

function corGetTurmaSelecionada(){
  const sel = document.getElementById('corTurmaSelect');
  const t = (sel && sel.value) ? sel.value : (filtroTurma && filtroTurma!=='Todas' ? filtroTurma : (turmas[0]||''));
  return t || '';
}

function corEnsureTurma(turma){
  if(!turma) return null;
  if(!correcaoProvas) correcaoProvas = {};
  if(!correcaoProvas[turma]) correcaoProvas[turma] = { provas:{}, activeProvaId:null };
  if(!correcaoProvas[turma].provas) correcaoProvas[turma].provas = {};
  return correcaoProvas[turma];
}

function corEnsureProva(turma){
  const ctx = corEnsureTurma(turma);
  if(!ctx) return null;

  let pid = ctx.activeProvaId;
  if(pid && ctx.provas && ctx.provas[pid]) return ctx.provas[pid];

  // cria prova padrão
  pid = 'p_' + Date.now();
  const prova = {
    id: pid,
    nome: 'Prova 1',
    createdAt: new Date().toISOString(),
    questions: Array.from({length:10}).map(()=>({ g:'', ref:'' })),
    answers: {} // alunoId -> ['A'..]
  };
  ctx.provas[pid] = prova;
  ctx.activeProvaId = pid;
  corSave();
  return prova;
}

function corGetProvaCtx(){
  const turma = corGetTurmaSelecionada();
  const prova = corEnsureProva(turma);
  return { turma, prova, ctx: corEnsureTurma(turma) };
}

function corNovaProva(){
  try{
    const turma = corGetTurmaSelecionada();
    if(!turma){ showToast && showToast('Selecione uma turma.', 'error'); return; }
    const nome = (prompt('Nome da prova (ex.: Avaliação Diagnóstica 1):', 'Prova '+(new Date().toLocaleDateString('pt-BR'))) || '').trim();
    if(!nome) return;

    // Oferece vincular a uma disciplina
    let _discId = null, _avId = null;
    const discs = config && Array.isArray(config.disciplinas) ? config.disciplinas : [];
    if(discs.length > 0){
      const opcoes = discs.map((d,i) => `${i+1}) ${d.nome}`).join('\n');
      const resp = prompt('Deseja vincular esta prova a uma disciplina?\nDigite o número da disciplina ou deixe vazio para NÃO vincular:\n\n' + opcoes);
      if(resp && resp.trim()){
        const idx = parseInt(resp.trim()) - 1;
        if(idx >= 0 && idx < discs.length){
          _discId = discs[idx].id;
          const avs = discs[idx].avaliacoes || [];
          if(avs.length > 0){
            const opAv = avs.map((a,j) => `${j+1}) ${a.nome}`).join('\n');
            const rAv = prompt('Qual atividade/avaliação desta disciplina?\n\n' + opAv);
            if(rAv && rAv.trim()){
              const jIdx = parseInt(rAv.trim()) - 1;
              if(jIdx >= 0 && jIdx < avs.length) _avId = avs[jIdx].id;
            }
          }
        }
      }
    }

    const tctx = corEnsureTurma(turma);
    const pid = 'p_' + Date.now();
    const provaObj = {
      id: pid,
      nome,
      createdAt: new Date().toISOString(),
      questions: Array.from({length:10}).map(()=>({ g:'', ref:'' })),
      answers: {}
    };
    if(_discId){ provaObj._discId = _discId; provaObj._avId = _avId; provaObj._syncKey = 'manual_' + _discId + '_' + (_avId||''); }
    tctx.provas[pid] = provaObj;
    tctx.activeProvaId = pid;
    corSave();
    corRenderAll();
    showToast && showToast('Prova criada!', 'success');
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corNovaProva',{}); }catch(_){}
  }
}

function corRenomearProva(){
  try{
    const turma = corGetTurmaSelecionada();
    if(!turma){ showToast && showToast('Selecione uma turma.', 'error'); return; }
    const tctx = corEnsureTurma(turma);
    const provaSel = document.getElementById('corProvaSelect');
    const pid = (provaSel && provaSel.value) ? provaSel.value : (tctx ? tctx.activeProvaId : null);
    if(!tctx || !pid || !tctx.provas || !tctx.provas[pid]){ showToast && showToast('Selecione uma prova para renomear.', 'error'); return; }
    const prova = tctx.provas[pid];
    const novo = (prompt('Novo nome da prova:', (prova.nome||'')) || '').trim();
    if(!novo) return;
    prova.nome = novo;
    corSave();
    // Atualiza apenas os seletores (não mexe nas respostas)
    corRenderSelectors();
    if(provaSel) provaSel.value = pid;
    showToast && showToast('Prova renomeada!', 'success');
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corRenomearProva',{}); }catch(_){}
  }
}

function corExcluirProva(){
  try{
    const turma = corGetTurmaSelecionada();
    if(!turma){ showToast && showToast('Selecione uma turma.', 'error'); return; }
    const tctx = corEnsureTurma(turma);
    const provaSel = document.getElementById('corProvaSelect');
    const pid = (provaSel && provaSel.value) ? provaSel.value : (tctx ? tctx.activeProvaId : null);
    if(!tctx || !pid || !tctx.provas || !tctx.provas[pid]){ showToast && showToast('Selecione uma prova para excluir.', 'error'); return; }
    const nome = tctx.provas[pid].nome || 'esta prova';
    const ok = confirm(`Excluir "${nome}"?\n\nEssa ação não pode ser desfeita.`);
    if(!ok) return;

    delete tctx.provas[pid];

    // Define próxima prova ativa (se existir)
    const restantes = Object.values(tctx.provas||{}).sort((a,b)=>String(a.createdAt||'').localeCompare(String(b.createdAt||'')));
    tctx.activeProvaId = restantes.length ? restantes[restantes.length-1].id : null;

    corSave();
    // Garante que exista ao menos uma prova para a UI não ficar vazia
    corEnsureProva(turma);
    corRenderAll();
    showToast && showToast('Prova excluída.', 'success');
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corExcluirProva',{}); }catch(_){}
  }
}


function corSetActiveProva(turma, provaId){
  const tctx = corEnsureTurma(turma);
  if(!tctx || !tctx.provas || !tctx.provas[provaId]) return;
  tctx.activeProvaId = provaId;
  corSave();
}

function corRenderSelectors(){
  const turmaSel = document.getElementById('corTurmaSelect');
  const provaSel = document.getElementById('corProvaSelect');

  if(turmaSel){
    // preserva a seleção do usuário ao re-renderizar (evita voltar para a 1ª turma)
    const current = turmaSel.value || '';
    turmaSel.innerHTML = turmas.map(t=>`<option value="${escAttr(t)}">${escHTML(t)}</option>`).join('') || `<option value="">(sem turmas)</option>`;
    const prefer = (current && Array.isArray(turmas) && turmas.includes(current))
      ? current
      : ((filtroTurma && filtroTurma!=='Todas') ? filtroTurma : (turmas[0] || ''));
    turmaSel.value = prefer || (turmas[0]||'');
  }

  const turma = corGetTurmaSelecionada();
  const tctx = corEnsureTurma(turma);
  if(provaSel){
    const provasArr = tctx ? Object.values(tctx.provas||{}) : [];
    if(provasArr.length===0){ corEnsureProva(turma); }
    const provas = Object.values((correcaoProvas[turma]||{}).provas||{});
    const opts = provas
      .sort((a,b)=>String(a.createdAt||'').localeCompare(String(b.createdAt||'')))
      .map(p=>`<option value="${escAttr(p.id)}">${escHTML(p.nome||p.id)}</option>`).join('');
    provaSel.innerHTML = opts || `<option value="">(sem provas)</option>`;
    provaSel.value = (correcaoProvas[turma] && correcaoProvas[turma].activeProvaId) ? correcaoProvas[turma].activeProvaId : (provas[0] ? provas[0].id : '');
  }

  // aluno select
  const alunoSel = document.getElementById('corAlunoSelect');
  if(alunoSel){
    const lista = alunos.filter(a=>a && a.turma===turma);
    alunoSel.innerHTML = lista.map(a=>`<option value="${escAttr(a.id)}">${escHTML(a.nome || 'Aluno')}</option>`).join('') || `<option value="">(sem alunos)</option>`;
    if(!alunoSel.value && lista[0]) alunoSel.value = lista[0].id;
  }
}

function corGetSelectedProva(){
  const turma = corGetTurmaSelecionada();
  const provaSel = document.getElementById('corProvaSelect');
  const pid = provaSel && provaSel.value ? provaSel.value : (correcaoProvas[turma] ? correcaoProvas[turma].activeProvaId : null);
  if(pid) corSetActiveProva(turma, pid);
  return corEnsureProva(turma);
}

function corRenderGabarito(){
  const { turma } = corGetProvaCtx();
  const prova = corGetSelectedProva();
  const tb = document.getElementById('corGabaritoTbody');
  if(!tb || !prova) return;

  tb.innerHTML = '';
  for(let i=0;i<10;i++){
    const q = prova.questions[i] || (prova.questions[i]={g:'',ref:''});
    const tr = document.createElement('tr');

    const tdN = document.createElement('td');
    tdN.innerHTML = `<span class="cor-qnum">${i+1}</span>`;
    tr.appendChild(tdN);

    const tdG = document.createElement('td');
    tdG.innerHTML = `
      <select class="inp cor-sel" data-q="${i}" aria-label="Gabarito questão ${i+1}">
        <option value="">—</option>
        <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
      </select>`;
    tr.appendChild(tdG);

    const tdR = document.createElement('td');
    tdR.innerHTML = `<input class="inp" data-qref="${i}" placeholder="Ex.: EF67LPxx / Aula 3" value="${escAttr(q.ref||'')}">`;
    tr.appendChild(tdR);

    tb.appendChild(tr);

    const sel = tdG.querySelector('select');
    sel.value = (q.g||'').toUpperCase();
    sel.addEventListener('change', function(){
      const v = (this.value||'').toUpperCase();
      q.g = (['A','B','C','D'].includes(v) ? v : '');
      corSave();
      corRenderAluno();
      corRenderStats();
      // Auto-post when gabarito changes
      try{
        const _turma = corGetTurmaSelecionada();
        const _prova = corGetSelectedProva();
        if(_prova && _prova._discId) corAutoPostAllGrades(_prova, _turma);
      }catch(_){}
    });

    const inp = tdR.querySelector('input');
    inp.addEventListener('input', function(){
      q.ref = (this.value||'').trim();
      corSave();
      corRenderStats();
    });
  }
}

function corGetAlunoSelecionadoId(){
  const sel = document.getElementById('corAlunoSelect');
  return sel && sel.value ? sel.value : '';
}

function corEnsureAlunoAnswers(prova, alunoId){
  if(!prova.answers) prova.answers = {};
  if(!prova.answers[alunoId] || !Array.isArray(prova.answers[alunoId])) prova.answers[alunoId] = Array.from({length:10}).map(()=> '');
  if(prova.answers[alunoId].length<10){
    prova.answers[alunoId] = prova.answers[alunoId].concat(Array.from({length:10-prova.answers[alunoId].length}).map(()=> ''));
  }
  return prova.answers[alunoId];
}

function corNormalizeAlt(v){
  v = String(v||'').trim().toUpperCase();
  if(!['A','B','C','D'].includes(v)) return '';
  return v;
}

function corCalcAcertos(prova, alunoId){
  const ans = corEnsureAlunoAnswers(prova, alunoId);
  let ac=0;
  for(let i=0;i<10;i++){
    const g = corNormalizeAlt((prova.questions[i]||{}).g);
    const r = corNormalizeAlt(ans[i]);
    if(g && r && g===r) ac++;
  }
  return ac;
}

function corRenderAluno(){
  const prova = corGetSelectedProva();
  const alunoId = corGetAlunoSelecionadoId();
  const grid = document.getElementById('corRespostasGrid');
  if(!grid || !prova) return;

  grid.innerHTML = '';
  if(!alunoId){
    document.getElementById('corAcertosLbl') && (document.getElementById('corAcertosLbl').textContent='0/10');
    const _nfLbl = document.getElementById('corNotaFinalLbl');
    const _nfBox = document.getElementById('corNotaFinalBox');
    if(_nfLbl) _nfLbl.textContent = '0.0';
    if(_nfBox){ _nfBox.classList.remove('farol-v','farol-a','farol-r'); _nfBox.classList.add('farol-r'); }
    return;
  }

  const ans = corEnsureAlunoAnswers(prova, alunoId);

  for(let i=0;i<10;i++){
    const card = document.createElement('div');
    card.className = 'cor-resp-card';

    const qn = document.createElement('div');
    qn.className = 'qn';
    qn.textContent = String(i+1);
    card.appendChild(qn);

    const input = document.createElement('input');
    input.className = 'cor-resp-input';
    input.setAttribute('maxlength','1');
    input.setAttribute('inputmode','text');
    input.setAttribute('aria-label', 'Resposta questão '+(i+1));
    input.value = (ans[i]||'').toUpperCase();
    input.dataset.q = String(i);
    card.appendChild(input);

    const meta = document.createElement('div');
    meta.className = 'cor-resp-meta';
    meta.innerHTML = `<div>Gabarito: <strong>${escHTML((prova.questions[i]||{}).g || '—')}</strong></div>
                      <div>${escHTML((prova.questions[i]||{}).ref || '')}</div>`;
    card.appendChild(meta);

    grid.appendChild(card);

    function updateClass(){
      const g = corNormalizeAlt((prova.questions[i]||{}).g);
      const r = corNormalizeAlt(input.value);
      input.classList.remove('ok','no','na');
      if(!r) input.classList.add('na');
      else if(g && r===g) input.classList.add('ok');
      else input.classList.add('no');
    }
    updateClass();

    input.addEventListener('input', function(){
      const v = corNormalizeAlt(this.value);
      this.value = v;
      ans[i] = v;
      corSave();
      updateClass();
      // acertos + nota final
      const ac = corCalcAcertos(prova, alunoId);
      const lbl = document.getElementById('corAcertosLbl');
      if(lbl) lbl.textContent = `${ac}/10`;
      corUpdateNotaFinal(prova, alunoId);
      corAutoPostGrade(prova, alunoId);
      corRenderStats();
    });
  }

  const ac = corCalcAcertos(prova, alunoId);
  const lbl = document.getElementById('corAcertosLbl');
  if(lbl) lbl.textContent = `${ac}/10`;
  corUpdateNotaFinal(prova, alunoId);
}

function corComputeStats(prova, turma){
  const alunosTurma = alunos.filter(a=>a && a.turma===turma);
  const answeredIds = Object.keys(prova.answers||{}).filter(id=>Array.isArray(prova.answers[id]));
  const validIds = answeredIds.filter(id=>{
    const arr = prova.answers[id]||[];
    return arr.some(x=>String(x||'').trim()!=='');
  });
  const N = validIds.length;

  const perQ = Array.from({length:10}).map(()=>({ac:0, er:0, pct:0}));
  const perRef = {}; // ref -> {ac,er,pct}

  validIds.forEach(id=>{
    const arr = corEnsureAlunoAnswers(prova, id);
    for(let i=0;i<10;i++){
      const g = corNormalizeAlt((prova.questions[i]||{}).g);
      const r = corNormalizeAlt(arr[i]);
      const ok = (g && r && g===r);
      if(ok) perQ[i].ac++; else perQ[i].er++;
      const ref = String((prova.questions[i]||{}).ref || '—').trim() || '—';
      if(!perRef[ref]) perRef[ref] = {ac:0, er:0};
      if(ok) perRef[ref].ac++; else perRef[ref].er++;
    }
  });

  perQ.forEach(q=>{
    const tot = q.ac + q.er;
    q.pct = tot? Math.round((q.ac/tot)*1000)/10 : 0;
  });

  Object.keys(perRef).forEach(k=>{
    const o = perRef[k];
    const tot = o.ac + o.er;
    o.pct = tot? Math.round((o.ac/tot)*1000)/10 : 0;
  });

  return { N, perQ, perRef };
}


// Paleta simples para gráficos de barras: uma cor por barra (HSLA)
function corBarColors(labels, alpha){
  try{
    const arr = Array.isArray(labels) ? labels : [];
    const n = Math.max(1, arr.length || 1);
    const a = (alpha==null)?0.75:alpha;
    return (arr.length?arr:['—']).map((_,i)=>{
      const hue = Math.round((i * 360) / n);
      return `hsla(${hue}, 85%, 55%, ${a})`;
    });
  }catch(_){
    return ['rgba(37,99,235,0.75)'];
  }
}

function corRenderStats(){
  const turma = corGetTurmaSelecionada();
  const prova = corGetSelectedProva();
  if(!prova) return;

  const qsTb = document.getElementById('corStatsQuestoesTbody');
  const bnTb = document.getElementById('corStatsBnccTbody');

  const stats = corComputeStats(prova, turma);

  if(qsTb){
    qsTb.innerHTML = stats.perQ.map((q,i)=>{
      return `<tr><td><strong>${i+1}</strong></td><td>${q.ac}</td><td>${q.er}</td><td><strong>${q.pct}%</strong></td></tr>`;
    }).join('');
  }

  if(bnTb){
    const entries = Object.entries(stats.perRef)
      .sort((a,b)=> (b[1].pct - a[1].pct));
    bnTb.innerHTML = entries.map(([k,o])=>{
      return `<tr><td style="max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><strong>${escHTML(k)}</strong></td><td>${o.ac}</td><td>${o.er}</td><td><strong>${o.pct}%</strong></td></tr>`;
    }).join('');
  }

  // Charts (usa Chart.js ou o miniChart interno)
  try{
    const c1 = document.getElementById('corChartQuestoes');
    if(c1 && c1.getContext){
      if(__corChartQ) __corChartQ.destroy();
      
const qLabels = Array.from({length:10}).map((_,i)=>String(i+1));
const qColors = corBarColors(qLabels, 0.75);
const qBorders = corBarColors(qLabels, 1);
__corChartQ = new Chart(c1.getContext('2d'), {
  type: 'bar',
  data: { 
    labels: qLabels, 
    datasets: [{
      label: '% Acerto (Questão)', 
      data: stats.perQ.map(q=>q.pct),
      backgroundColor: qColors,
      borderColor: qBorders,
      borderWidth: 1
    }]
  },
  options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, suggestedMax:100 } } }
});
}
  }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'corChartQ',{}); }catch(_){} }

  try{
    const c2 = document.getElementById('corChartBNCC');
    if(c2 && c2.getContext){
      const labels = Object.entries(stats.perRef).map(([k])=>k);
      const data = Object.entries(stats.perRef).map(([,o])=>o.pct);
      if(__corChartB) __corChartB.destroy();
      
const bLabels = labels.length ? labels : ['—'];
const bData = data.length ? data : [0];
const bColors = corBarColors(bLabels, 0.75);
const bBorders = corBarColors(bLabels, 1);
__corChartB = new Chart(c2.getContext('2d'), {
  type: 'bar',
  data: { 
    labels: bLabels, 
    datasets: [{
      label: '% Acerto (BNCC/Aula)', 
      data: bData,
      backgroundColor: bColors,
      borderColor: bBorders,
      borderWidth: 1
    }]
  },
  options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, suggestedMax:100 } } }
});
}
  }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'corChartB',{}); }catch(_){} }
}

function corBindEvents(){
  const turmaSel = document.getElementById('corTurmaSelect');
  const provaSel = document.getElementById('corProvaSelect');
  const alunoSel = document.getElementById('corAlunoSelect');

  if(turmaSel && !turmaSel.dataset.bound){
    turmaSel.dataset.bound='1';
    turmaSel.addEventListener('change', function(){
      corEnsureProva(this.value);
      corRenderAll();
    });
  }
  if(provaSel && !provaSel.dataset.bound){
    provaSel.dataset.bound='1';
    provaSel.addEventListener('change', function(){
      const turma = corGetTurmaSelecionada();
      corSetActiveProva(turma, this.value);
      corRenderAll();
    });
  }
  if(alunoSel && !alunoSel.dataset.bound){
    alunoSel.dataset.bound='1';
    alunoSel.addEventListener('change', function(){
      corRenderAluno();
    });
  }
}

function corRenderAll(){
  corSyncDiscActivities();
  corRenderSelectors();
  corBindEvents();
  corRenderGabarito();
  corRenderAluno();
  corRenderStats();
  corRenderDiscBadge();
}

/* ======= SINCRONIZAÇÃO AUTOMÁTICA: Disciplinas -> Correção ======= */
function corSyncDiscActivities(){
  try{
    if(!config || !Array.isArray(config.disciplinas)) return;
    let changed = false;

    // Build set of valid syncKeys from current config
    const validSyncKeys = new Set();
    config.disciplinas.forEach(disc=>{
      if(!disc || !disc.id || !Array.isArray(disc.avaliacoes)) return;
      disc.avaliacoes.forEach(av=>{
        if(!av || !av.id) return;
        validSyncKeys.add('sync_' + disc.id + '_' + av.id);
      });
    });

    turmas.forEach(turma=>{
      const tctx = corEnsureTurma(turma);
      if(!tctx) return;

      // 1) Create missing synced provas
      config.disciplinas.forEach(disc=>{
        if(!disc || !disc.id || !Array.isArray(disc.avaliacoes)) return;
        disc.avaliacoes.forEach(av=>{
          if(!av || !av.id) return;
          const syncKey = 'sync_' + disc.id + '_' + av.id;
          const exists = Object.values(tctx.provas||{}).some(p=> p && p._syncKey === syncKey);
          if(!exists){
            const pid = 'p_sync_' + disc.id + '_' + av.id + '_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
            tctx.provas[pid] = {
              id: pid,
              nome: (disc.nome||'Disciplina') + ' — ' + (av.nome||'Atividade'),
              createdAt: new Date().toISOString(),
              questions: Array.from({length:10}).map(()=>({ g:'', ref:'' })),
              answers: {},
              _syncKey: syncKey,
              _discId: disc.id,
              _avId: av.id,
              _autoSync: true
            };
            changed = true;
          }
        });
      });

      // 2) Clean orphaned auto-synced provas (discipline/activity removed from config)
      Object.keys(tctx.provas||{}).forEach(pid=>{
        const p = tctx.provas[pid];
        if(p && p._autoSync && p._syncKey && !validSyncKeys.has(p._syncKey)){
          // Only remove if no student answers exist
          const hasAnswers = Object.values(p.answers||{}).some(ans =>
            Array.isArray(ans) && ans.some(x => String(x||'').trim()!=='')
          );
          if(!hasAnswers){
            delete tctx.provas[pid];
            changed = true;
          }
        }
      });
    });

    if(changed) corSave();
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corSyncDiscActivities',{}); }catch(_){}
  }
}

/* ======= NOTA FINAL: calcula nota do aluno na prova ======= */
function corCalcNotaFinal(prova, alunoId){
  if(!prova || !alunoId) return 0;
  const totalQ = (prova.questions||[]).filter(q => corNormalizeAlt(q.g)).length;
  if(totalQ === 0) return 0;
  const ac = corCalcAcertos(prova, alunoId);
  return Math.round((ac / totalQ) * 100) / 10; // nota de 0 a 10
}

function corUpdateNotaFinal(prova, alunoId){
  const box = document.getElementById('corNotaFinalBox');
  const lbl = document.getElementById('corNotaFinalLbl');
  if(!box || !lbl) return;
  const nota = corCalcNotaFinal(prova, alunoId);
  lbl.textContent = nota.toFixed(1);
  box.classList.remove('farol-v','farol-a','farol-r');
  if(nota >= 7) box.classList.add('farol-v');
  else if(nota >= 5) box.classList.add('farol-a');
  else box.classList.add('farol-r');
}

/* ======= AUTO-POST: lança nota na disciplina do aluno ======= */
function corAutoPostGrade(prova, alunoId){
  try{
    if(!prova || !alunoId) return;
    if(!prova._discId || !prova._avId) return; // sem vínculo
    const aluno = alunos.find(a => a && a.id === alunoId);
    if(!aluno || !aluno.bimestres) return;
    const bim = aluno.bimestres[bimestreAtual];
    if(!bim) return;
    if(!bim.notas_disc || typeof bim.notas_disc !== 'object') bim.notas_disc = {};
    if(!bim.notas_disc[prova._discId]) bim.notas_disc[prova._discId] = {};
    const nota = corCalcNotaFinal(prova, alunoId);
    bim.notas_disc[prova._discId][prova._avId] = nota;
    // Sync legados
    try{ _syncBimestreRefs(bim); }catch(_){}
    // Recalcula média para a disciplina vinculada
    const disc = getDiscById(prova._discId);
    if(disc){
      const notas = bim.notas_disc[prova._discId];
      const media = calcularMediaDisc(prova._discId, notas).toFixed(1);
      // Atualiza campos legados (slot1 -> media_lp, slot2 -> media_red)
      if(prova._discId === config.slot1) bim.media_lp = media;
      if(prova._discId === config.slot2) bim.media_red = media;
      // Armazena media genérica para qualquer disciplina (suporte a 3+ disciplinas)
      if(!bim.medias_disc || typeof bim.medias_disc !== 'object') bim.medias_disc = {};
      bim.medias_disc[prova._discId] = parseFloat(media);
    }
    salvarDadosLocal();
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corAutoPostGrade',{}); }catch(_){}
  }
}

/* Auto-post grades for ALL students of a prova (batch) */
function corAutoPostAllGrades(prova, turma){
  try{
    if(!prova || !prova._discId || !prova._avId) return;
    const alunosTurma = alunos.filter(a => a && a.turma === turma);
    alunosTurma.forEach(a => {
      const ans = (prova.answers||{})[a.id];
      if(Array.isArray(ans) && ans.some(x => String(x||'').trim()!=='')) {
        corAutoPostGrade(prova, a.id);
      }
    });
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corAutoPostAllGrades',{}); }catch(_){}
  }
}

/* ======= BADGE DE DISCIPLINA VINCULADA ======= */
function corRenderDiscBadge(){
  const el = document.getElementById('corDiscBadge');
  if(!el) return;
  const prova = corGetSelectedProva();
  if(!prova || !prova._discId){
    el.innerHTML = '';
    return;
  }
  const disc = getDiscById(prova._discId);
  const av = disc ? (disc.avaliacoes||[]).find(a=>a.id===prova._avId) : null;
  const discNome = disc ? disc.nome : prova._discId;
  const avNome = av ? av.nome : prova._avId;
  el.innerHTML = `<span class="cor-disc-badge"><i class="fas fa-link"></i> Vinculada: ${escHTML(discNome)} → ${escHTML(avNome)}</span>
    <span class="cor-sync-info"><i class="fas fa-bolt"></i> Notas lançadas automaticamente no bimestre ${bimestreAtual}</span>`;
}

/* ======= IMPRIMIR LISTA DE RESULTADOS ======= */
function corPrintList(){
  try{
    const turma = corGetTurmaSelecionada();
    const prova = corGetSelectedProva();
    if(!turma || !prova){ showToast && showToast('Selecione uma turma e prova.', 'error'); return; }
    const alunosTurma = alunos.filter(a => a && a.turma === turma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
    if(!alunosTurma.length){ showToast && showToast('Nenhum aluno nesta turma.', 'error'); return; }

    const nQ = (prova.questions||[]).length || 10;
    let thQ = '';
    for(let i=0;i<nQ;i++) thQ += `<th style="width:35px;">Q${i+1}<br><small style="font-size:9px;color:#666;">${escHTML(corNormalizeAlt((prova.questions[i]||{}).g)||'—')}</small></th>`;

    let rows = '';
    alunosTurma.forEach((a,idx)=>{
      const ans = corEnsureAlunoAnswers(prova, a.id);
      const ac = corCalcAcertos(prova, a.id);
      const nota = corCalcNotaFinal(prova, a.id);
      const cls = nota>=7 ? 'nota-verde' : (nota>=5 ? 'nota-amarela' : 'nota-vermelha');
      let tds = '';
      for(let i=0;i<nQ;i++){
        const r = corNormalizeAlt(ans[i]);
        const g = corNormalizeAlt((prova.questions[i]||{}).g);
        const ok = (g && r && g===r);
        const cellCls = !r ? '' : (ok ? 'nota-verde' : 'nota-vermelha');
        tds += `<td class="${cellCls}">${escHTML(r||'—')}</td>`;
      }
      rows += `<tr><td style="text-align:left;font-weight:600;">${idx+1}. ${escHTML(a.nome||'Aluno')}</td>${tds}<td><strong>${ac}/${nQ}</strong></td><td class="${cls}"><strong>${nota.toFixed(1)}</strong></td></tr>`;
    });

    const printArea = document.getElementById('corPrintArea');
    if(!printArea) return;
    const discInfo = prova._discId ? (() => {
      const d = getDiscById(prova._discId);
      return d ? (' | Disciplina: ' + (d.nome||'')) : '';
    })() : '';
    printArea.innerHTML = `
      <div class="print-title">${escHTML(prova.nome||'Prova')} — Turma: ${escHTML(turma)}</div>
      <div class="print-sub">Bimestre ${bimestreAtual}${escHTML(discInfo)} | Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</div>
      <table>
        <thead><tr><th style="text-align:left;min-width:140px;">Aluno</th>${thQ}<th>Acertos</th><th>Nota</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="margin-top:12px;font-size:10px;color:#888;">
        <span style="display:inline-block;width:12px;height:12px;background:#dcfce7;border:1px solid #999;margin-right:3px;vertical-align:middle;"></span> Verde (≥7)&nbsp;&nbsp;
        <span style="display:inline-block;width:12px;height:12px;background:#fef9c3;border:1px solid #999;margin-right:3px;vertical-align:middle;"></span> Amarelo (5-6.9)&nbsp;&nbsp;
        <span style="display:inline-block;width:12px;height:12px;background:#fee2e2;border:1px solid #999;margin-right:3px;vertical-align:middle;"></span> Vermelho (<5)
      </div>`;
    printArea.style.display = 'block';
    window.print();
    setTimeout(()=>{ printArea.style.display='none'; }, 500);
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'corPrintList',{}); }catch(_){}
  }
}

function initCorrecao(){
  try{
    // garante estrutura mínima
    if(!correcaoProvas || typeof correcaoProvas !== 'object' || Array.isArray(correcaoProvas)) correcaoProvas = {};
    // se já existe filtro de turma ativo, prepara
    if(filtroTurma && filtroTurma!=='Todas') corEnsureProva(filtroTurma);
    // renderiza se a visão atual for correção
    if(visaoAtual==='correcao') corRenderAll();
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'initCorrecao',{}); }catch(_){}
  }
}

function __sgpMainOnLoad(){ 
            carregarDados(); try{ if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers(); }catch(_){ }
            try{ __warnTempPath(); }catch(_){ } try{ __checkExternalLibs(); }catch(_){ } checkBackupStatus(); garantirEstruturaNova(); initMenuTurmas(); renderizarMenu(); gerarMesas(); renderizarVisao(); atualizarLabelsConfig(); initKeyboardShortcuts(); initOcorrenciasUI(); initElegivelUI(); initPlanner(); initAtividades(); initCorrecao(); }
        window.addEventListener('load', __sgpMainOnLoad);


        window.onbeforeunload = function() {
            if(dadosNaoSalvosEmArquivo) return "Você tem alterações não salvas em arquivo. Deseja sair?";
        };

        // === NOVAS FUNÇÕES: BUSCA GLOBAL ===
        function aplicarBuscaGlobal() {
            const input = document.getElementById('searchGlobal');
            const clearBtn = document.getElementById('searchClear');
            clearTimeout(__buscaTimer);
            __buscaTimer = setTimeout(() => {
                buscaGlobal = (input?.value || '').toLowerCase();
                if(buscaGlobal) clearBtn.classList.add('visible');
                else clearBtn.classList.remove('visible');
                scheduleRenderVisaoContent();
            }, 180);
        }

        function limparBusca() {
            const input = document.getElementById('searchGlobal');
            if(input) input.value = '';
            buscaGlobal = '';
            const clearBtn = document.getElementById('searchClear');
            if(clearBtn) clearBtn.classList.remove('visible');
            scheduleRenderVisaoContent();
        }

        // === NOVAS FUNÇÕES: EDIÇÃO EM MASSA ===
        
/* (removido) Função duplicada antiga: renderizarEdicaoMassa */

/* (removido) Função duplicada antiga: marcarModificacao */

/* (removido) Função duplicada antiga: salvarEdicaoMassa */
// Funções auxiliares para cálculo de média
        
/* (removido) Função duplicada antiga: calcularMediaLPIndividual */

/* (removido) Função duplicada antiga: calcularMediaRED */
// --- FUNÇÕES DE INTERFACE ---
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function togglePrivacy() { privacyMode=!privacyMode; document.body.classList.toggle('privacy-active'); const btn=document.getElementById('btnPrivacy'); btn.innerHTML=privacyMode?'<i class="fas fa-eye"></i>':'<i class="fas fa-eye-slash"></i>'; btn.classList.toggle('active'); }
        
        function toggleZenMode() {
            document.body.classList.toggle('zen-mode');
        }

        function showToast(msg, type='success') {
            try{
                const now = Date.now();
                const k = String(type)+'|'+String(msg);
                if(window.__sgpLastToastKey === k && (now - (window.__sgpLastToastAt||0)) < 350) return;
                window.__sgpLastToastKey = k;
                window.__sgpLastToastAt = now;
            }catch(_){ }
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = `toast ${type}`;

            const iconClass = (type==='success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle');
            const iconColor = (type==='success' ? 'var(--farol-verde)' : 'var(--farol-vermelho)');

            // Evita injeção/quebra de layout: msg entra como texto puro (sem innerHTML)
            const icon = document.createElement('i');
            icon.className = iconClass;
            icon.style.color = iconColor;

            const span = document.createElement('span');
            span.textContent = (msg ?? '').toString();

            t.appendChild(icon);
            t.appendChild(document.createTextNode(' '));
            t.appendChild(span);

            c.appendChild(t);
            setTimeout(() => {
                t.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => t.remove(), 500);
            }, 3000);
        }

        function abrirModalCopiarTabela() {
            if(filtroTurma === 'Todas') return showToast("Selecione uma turma primeiro.", "error");
            const lista = getAlunosFiltrados();
            if(lista.length === 0) return showToast("Turma vazia.", "error");
            
            let html = '<table border="1" style="border-collapse: collapse; width: 100%; font-family: sans-serif;">';
            html += `<thead><tr style="background-color: #f3f4f6;">
                <th style="padding: 5px; border: 1px solid #999;">#</th>
                <th style="padding: 5px; border: 1px solid #999;">Nome</th>
                <th style="padding: 5px; border: 1px solid #999;">${_escHTML(config.materia1)}</th>
                <th style="padding: 5px; border: 1px solid #999;">${_escHTML(config.materia2)}</th>
                <th style="padding: 5px; border: 1px solid #999;">Comp.</th>
            </tr></thead><tbody>`;
            
            lista.forEach((a, i) => {
                const b = a.bimestres[bimestreAtual];
                const getStyle = (val) => {
                    const n = parseFloat(val);
                    if(n >= 7) return 'background-color: #dcfce7; color: #166534;';
                    if(n >= 5) return 'background-color: #fef3c7; color: #92400e;';
                    return 'background-color: #fee2e2; color: #991b1b;';
                };

                html += `<tr>
                    <td style="border: 1px solid #999; padding: 5px;">${i+1}</td>
                    <td style="border: 1px solid #999; padding: 5px;">${_escHTML(a.nome)}</td>
                    <td style="border: 1px solid #999; padding: 5px; text-align: center; font-weight: bold; ${getStyle(b.media_lp)}">${b.media_lp.replace('.',',')}</td>
                    <td style="border: 1px solid #999; padding: 5px; text-align: center; font-weight: bold; ${getStyle(b.media_red)}">${b.media_red.replace('.',',')}</td>
                    <td style="border: 1px solid #999; padding: 5px; text-align: center;">${__u(b.comportamento)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            
            document.getElementById('tabelaCopyContainer').innerHTML = html;
            abrirModal('modalCopiarTabela');
        }

        function copiarConteudoTabela() {
            const container = document.getElementById('tabelaCopyContainer');
            const range = document.createRange();
            range.selectNode(container);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                showToast("Tabela copiada com cores!");
            } catch (err) {
                showToast("Erro ao copiar.", "error");
            }
            
            window.getSelection().removeAllRanges();
        }

        // [REMOVED] Old sortearAluno - replaced by advanced version with absent exclusion (see below)

        function abrirGeradorGrupos() {
            if(filtroTurma==='Todas') return showToast("Selecione uma turma.", "error");
            abrirModal('modalGeradorGrupos');
            document.getElementById('resultadoGrupos').innerHTML = '';
        }

        // [REMOVED] Old gerarGrupos - replaced by advanced version with modo/qtdGrupos support (see below)

        function clonarAulas() {
            if(filtroTurma === 'Todas') return showToast("Selecione a turma de DESTINO.", "error");
            const origem = prompt(`Você está na turma ${filtroTurma}.\nDigite o nome exato da turma de ORIGEM para copiar as aulas do ${bimestreAtual}º Bimestre:`);
            if(!origem || origem === filtroTurma) return;
            const aulasOrigem = aulas.filter(a => a.turma === origem && a.bimestre === bimestreAtual);
            if(aulasOrigem.length === 0) return showToast("Nenhuma aula encontrada na origem.", "error");
            if(confirm(`Copiar ${__u(aulasOrigem.length)} aulas de ${origem} para ${filtroTurma}?`)) {
                aulasOrigem.forEach(a => { aulas.push({ id: __newId(), turma: filtroTurma, bimestre: bimestreAtual, tema: a.tema, bncc: a.bncc || '', status: false, data: "" }); });
                salvarDadosLocal(); renderizarAulas(); renderizarCalendario();
                showToast("Aulas copiadas!");
            }
        }

        // --- TIMER FUNCTIONS ---
        function abrirTimer() { abrirModal('modalTimer'); }
        function setTimer(min) { timeLeft = min * 60; updateTimerDisplay(); }
        function startTimer() { if(timerInterval) return; timerInterval = setInterval(() => { if(timeLeft > 0) { timeLeft--; updateTimerDisplay(); } else { stopTimer(); showToast("Tempo esgotado!", "error"); } }, 1000); }
        function pauseTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { pauseTimer(); timeLeft = 0; updateTimerDisplay(); }
        function stopTimer() { pauseTimer(); }
        function updateTimerDisplay() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timerDisplay').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

        // --- CONFIGURAÇÕES & LAYOUTS ---
        
/* (removido) Função duplicada antiga: abrirConfig */

/* (removido) Função duplicada antiga: salvarConfig */

/* (removido) Função duplicada antiga: atualizarLabelsConfig */
function salvarLayout() {
            if(filtroTurma==='Todas') return showToast("Selecione uma turma", "error");
            const nome = document.getElementById('inputNomeLayout').value;
            if(!nome) return showToast("Digite um nome", "error");
            const mapData = {};
            alunos.filter(a => a.turma === filtroTurma).forEach(a => {
                mapData[a.id] = a.mesa;
            });
            if(!layouts[filtroTurma]) layouts[filtroTurma] = {};
            layouts[filtroTurma][nome] = mapData;
            salvarDadosLocal();
            showToast("Layout salvo!");
            carregarSelectLayouts();
        }
        function carregarSelectLayouts(){
            const s = document.getElementById('selectLayouts'); s.innerHTML = '<option value="">Carregar...</option>';
            if(layouts[filtroTurma]) {
                Object.keys(layouts[filtroTurma]).forEach(k => {
                    s.innerHTML += `<option value="${_escHTML(k)}">${_escHTML(k)}</option>`;
                });
            }
        }
        function carregarLayout(){
            const nome = document.getElementById('selectLayouts').value;
            if(!nome || !layouts[filtroTurma] || !layouts[filtroTurma][nome]) return;
            const map = layouts[filtroTurma][nome];
            alunos.filter(a => a.turma === filtroTurma).forEach(a => {
                a.mesa = map[a.id] !== undefined ? map[a.id] : null;
            });
            salvarDadosLocal();
            renderizarMapa();
            showToast("Layout carregado!");
        }
        function apagarLayout(){
             const nome = document.getElementById('selectLayouts').value;
             if(nome && confirm("Apagar layout?")) {
                 delete layouts[filtroTurma][nome];
                 salvarDadosLocal();
                 carregarSelectLayouts();
                 showToast("Layout apagado.");
             }
        }

        // --- CORE ---
        
/* (removido) Função duplicada antiga: garantirEstruturaNova */

function carregarDados() { 
  const __safe = (raw, fallback, key) => {
    if(!raw) return fallback;
    try { return JSON.parse(raw); }
    catch(e){
      console.warn('[SGP] localStorage inválido em', key, e);
      try{ if(typeof __diagCapture==='function') __diagCapture(e,'JSON.parse',{key}); }catch(_){}
      return fallback;
    }
  };

  let loadedCore = false;

  // 1) Preferência: core atômico (uma chave)
  try{
    const coreRaw = localStorage.getItem(__SGP_ATOMIC_CORE_KEY);
    const core = __safe(coreRaw, null, __SGP_ATOMIC_CORE_KEY);
    if(core && typeof core === 'object' && !Array.isArray(core)){
      turmas = Array.isArray(core.turmas) ? core.turmas : [];
      alunos = Array.isArray(core.alunos) ? core.alunos : [];
      aulas = Array.isArray(core.aulas) ? core.aulas : [];
      planosSemana = core.planosSemana || core.planos_semanais || {};
      if(!planosSemana || typeof planosSemana !== 'object' || Array.isArray(planosSemana)) planosSemana = {};

	      correcaoProvas = __safe(localStorage.getItem('sgp_correcao_provas'), null, 'sgp_correcao_provas');
      // Fallback: se chave separada falhou/vazia, tenta recuperar do blob atômico
      if(!correcaoProvas || typeof correcaoProvas !== 'object' || Array.isArray(correcaoProvas)){
        if(core.correcaoProvas && typeof core.correcaoProvas === 'object' && !Array.isArray(core.correcaoProvas)){
          correcaoProvas = core.correcaoProvas;
          try{ if(typeof __safeLSSet==='function') __safeLSSet('sgp_correcao_provas', JSON.stringify(correcaoProvas)); }catch(_){}
        } else {
          correcaoProvas = {};
        }
      }

      const cfg = core.config;
      if(cfg && typeof cfg === 'object' && !Array.isArray(cfg)) config = cfg;

      const lays = core.layouts;
      if(lays && typeof lays === 'object' && !Array.isArray(lays)) layouts = lays;

      loadedCore = true;
    }
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'carregarDados.atomic'); }catch(_){}
  }

  // 2) Fallback: formato antigo (múltiplas chaves)
  if(!loadedCore){
    try{
      const t=localStorage.getItem('sgp_turmas'),
            a=localStorage.getItem('sgp_alunos'),
            au=localStorage.getItem('sgp_aulas'),
            p=localStorage.getItem('sgp_planos_semanais'),
            cp=localStorage.getItem('sgp_correcao_provas'),
            c=localStorage.getItem('sgp_config'),
            l=localStorage.getItem('sgp_layouts');

      turmas = __safe(t, [], 'sgp_turmas'); 
      if(!Array.isArray(turmas)) turmas = [];
      alunos = __safe(a, [], 'sgp_alunos');
      if(!Array.isArray(alunos)) alunos = [];
      aulas = __safe(au, [], 'sgp_aulas');
      if(!Array.isArray(aulas)) aulas = [];

      planosSemana = __safe(p, {}, 'sgp_planos_semanais');
      if(!planosSemana || typeof planosSemana !== 'object' || Array.isArray(planosSemana)) planosSemana = {};

      correcaoProvas = __safe(cp, {}, 'sgp_correcao_provas');
      if(!correcaoProvas || typeof correcaoProvas !== 'object' || Array.isArray(correcaoProvas)) correcaoProvas = {};

      const cfg = __safe(c, null, 'sgp_config');
      if(cfg && typeof cfg === 'object' && !Array.isArray(cfg)) config = cfg;

      const lays = __safe(l, null, 'sgp_layouts');
      if(lays && typeof lays === 'object' && !Array.isArray(lays)) layouts = lays;
    }catch(e){
      try{ if(typeof __diagCapture==='function') __diagCapture(e,'carregarDados.legacy'); }catch(_){}
    }
  }

  // Normaliza schema se existir
  try{ if(typeof ensureConfigSchema === 'function') ensureConfigSchema(); }catch(_){}

  // Planner (v1): mantém em chave própria; initPlanner faz a consistência final
  try{
    const pl=localStorage.getItem('sgp_planner');
    plannerTasks = __safe(pl, [], 'sgp_planner');
    if(!Array.isArray(plannerTasks)) plannerTasks = [];
    if(typeof plannerNormalizeTasks === 'function') plannerTasks = plannerNormalizeTasks(plannerTasks);
  }catch(_){
    plannerTasks = [];
  }

  try{ if(typeof __loadExtras === 'function') __loadExtras(); }catch(_){}
  try{ if(typeof __dedupeAlunoIds === 'function') __dedupeAlunoIds(); }catch(_){}

}


// === Persistência atômica (core) — evita estado parcial e reduz duplicação de chaves ===
const __SGP_ATOMIC_CORE_KEY = 'sgp_state_core_v1';
const __SGP_ATOMIC_CORE_TMP = 'sgp_state_core_tmp_v1';

function __buildAtomicCoreState(){
  return {
    dataVersion: 1,
    ts: Date.now(),
    turmas,
    alunos,
    aulas,
    planosSemana,
    config,
    layouts,
    correcaoProvas: (typeof correcaoProvas !== 'undefined' && correcaoProvas) ? correcaoProvas : {}
  };
}

function __atomicSaveCore(){
  try{
    const str = JSON.stringify(__buildAtomicCoreState());
    if(!__safeLSSet(__SGP_ATOMIC_CORE_TMP, str)) return false;
    if(!__safeLSSet(__SGP_ATOMIC_CORE_KEY, str)) return false;

    try{ __safeLSRemove(__SGP_ATOMIC_CORE_TMP); }catch(_){}

    // Migração: remove chaves antigas do core (evita duplicação e quota)
    try{
      __safeLSRemove('sgp_turmas');
      __safeLSRemove('sgp_alunos');
      __safeLSRemove('sgp_aulas');
      __safeLSRemove('sgp_planos_semanais');
      __safeLSRemove('sgp_config');
      __safeLSRemove('sgp_layouts');
    }catch(_){}

    return true;
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e, '__atomicSaveCore'); }catch(_){}
    return false;
  }
}

function salvarDadosLocal() { 
  try{
    const ok = (typeof __atomicSaveCore === 'function') ? __atomicSaveCore() : false;

    // Fallback (último recurso): grava no formato antigo apenas se o modo atômico falhar
    if(!ok){
      __safeLSSet('sgp_turmas', JSON.stringify(turmas));
      __safeLSSet('sgp_alunos', JSON.stringify(alunos));
      __safeLSSet('sgp_aulas', JSON.stringify(aulas || []));
      __safeLSSet('sgp_planos_semanais', JSON.stringify(planosSemana || {}));
      __safeLSSet('sgp_config', JSON.stringify(config));
      __safeLSSet('sgp_layouts', JSON.stringify(layouts || {}));
    }

    // Planner/Atividades/Extras têm persistência própria; aqui garantimos o core consistente.
    dadosNaoSalvosEmArquivo = true;
    // Marca que há alterações locais mais recentes que o último backup ZIP
    try{ __safeLSSet('sgp_last_core_save', Date.now()); }catch(_){ }
    try{ __safeLSSet('sgp_backup_pending', '1'); }catch(_){ }
    try{ if(typeof checkBackupStatus==='function') checkBackupStatus(); }catch(_){ }

    if(__SGP_EVT && typeof __SGP_EVT.emit==='function') __SGP_EVT.emit('afterSave', { ok });
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e, 'salvarDadosLocal'); }catch(_){}
  }
}

function __pad2(n){ return String(n).padStart(2,'0'); }
        function __backupFileName(){
            const d=new Date();
            const y=d.getFullYear(), m=__pad2(d.getMonth()+1), da=__pad2(d.getDate());
            const hh=__pad2(d.getHours()), mm=__pad2(d.getMinutes());
            return `SGP_backup_${y}-${m}-${da}_${hh}${mm}.zip`;
        }

        // CRC32 (para ZIP "store")
        const __CRC_TABLE = (function(){
            const table = new Uint32Array(256);
            for(let i=0;i<256;i++){
                let c=i;
                for(let k=0;k<8;k++){
                    c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                }
                table[i]=c>>>0;
            }
            return table;
        })();
        function __crc32(u8){
            let c = 0xFFFFFFFF;
            for(let i=0;i<u8.length;i++){
                c = __CRC_TABLE[(c ^ u8[i]) & 0xFF] ^ (c >>> 8);
            }
            return (c ^ 0xFFFFFFFF) >>> 0;
        }
        function __u16(v){ return new Uint8Array([v & 255, (v>>>8)&255]); }
        function __u32(v){ return new Uint8Array([v & 255, (v>>>8)&255, (v>>>16)&255, (v>>>24)&255]); }

        function __zipStore(fileTuples){
            // fileTuples: Array<[name:string, content:string]>
            const enc = new TextEncoder();
            const parts = [];
            const central = [];
            let offset = 0;

            function pushPart(u8){
                parts.push(u8);
                offset += u8.length;
            }

            fileTuples.forEach(([name, content])=>{
                const nameBytes = enc.encode(String(name));
                const dataBytes = (content instanceof Uint8Array) ? content : enc.encode(String(content));
                const crc = __crc32(dataBytes);
                const size = dataBytes.length;
                const localHeaderOffset = offset;

                // Local file header
                pushPart(__u32(0x04034b50));
                pushPart(__u16(20));      // version needed
                pushPart(__u16(0));       // flags
                pushPart(__u16(0));       // compression (store)
                pushPart(__u16(0));       // mod time
                pushPart(__u16(0));       // mod date
                pushPart(__u32(crc));
                pushPart(__u32(size));    // compressed size
                pushPart(__u32(size));    // uncompressed size
                pushPart(__u16(nameBytes.length));
                pushPart(__u16(0));       // extra len
                pushPart(nameBytes);
                pushPart(dataBytes);

                // Central directory header (build later)
                const cd = [];
                const pushCD = (u8)=>cd.push(u8);
                pushCD(__u32(0x02014b50));
                pushCD(__u16(20)); // version made by
                pushCD(__u16(20)); // version needed
                pushCD(__u16(0));  // flags
                pushCD(__u16(0));  // compression
                pushCD(__u16(0));  // mod time
                pushCD(__u16(0));  // mod date
                pushCD(__u32(crc));
                pushCD(__u32(size));
                pushCD(__u32(size));
                pushCD(__u16(nameBytes.length));
                pushCD(__u16(0)); // extra
                pushCD(__u16(0)); // comment
                pushCD(__u16(0)); // disk start
                pushCD(__u16(0)); // internal attrs
                pushCD(__u32(0)); // external attrs
                pushCD(__u32(localHeaderOffset));
                pushCD(nameBytes);
                central.push(...cd);
            });

            const centralOffset = offset;
            central.forEach(u8=>pushPart(u8));
            const centralSize = offset - centralOffset;
            const totalEntries = fileTuples.length;

            // End of central directory
            pushPart(__u32(0x06054b50));
            pushPart(__u16(0)); // disk number
            pushPart(__u16(0)); // start disk
            pushPart(__u16(totalEntries));
            pushPart(__u16(totalEntries));
            pushPart(__u32(centralSize));
            pushPart(__u32(centralOffset));
            pushPart(__u16(0)); // comment length

            return new Blob(parts, {type:"application/zip"});
        }

        function __zipReadStore(arrayBuffer){
            // Returns { filename: stringContent }
            const u8 = new Uint8Array(arrayBuffer);
            const dv = new DataView(arrayBuffer);

            // find EOCD
            const EOCD_SIG = 0x06054b50;
            let eocd = -1;
            const maxComment = 0xFFFF;
            const start = Math.max(0, u8.length - (22 + maxComment));
            for(let i=u8.length-22; i>=start; i--){
                if(dv.getUint32(i, true) === EOCD_SIG){
                    eocd = i; break;
                }
            }
            if(eocd < 0) throw new Error("ZIP inválido (EOCD não encontrado).");

            const totalEntries = dv.getUint16(eocd + 10, true);
            const cdSize = dv.getUint32(eocd + 12, true);
            const cdOffset = dv.getUint32(eocd + 16, true);

            let ptr = cdOffset;
            const out = {};
            const CEN_SIG = 0x02014b50;
            const LOC_SIG = 0x04034b50;
            const dec = new TextDecoder('utf-8');

            for(let n=0;n<totalEntries;n++){
                if(dv.getUint32(ptr, true) !== CEN_SIG) throw new Error("ZIP inválido (central dir).");
                const comp = dv.getUint16(ptr + 10, true);
                const cSize = dv.getUint32(ptr + 20, true);
                const nameLen = dv.getUint16(ptr + 28, true);
                const extraLen = dv.getUint16(ptr + 30, true);
                const commentLen = dv.getUint16(ptr + 32, true);
                const localOff = dv.getUint32(ptr + 42, true);

                const nameBytes = u8.slice(ptr + 46, ptr + 46 + nameLen);
                const name = dec.decode(nameBytes);

                // local header
                if(dv.getUint32(localOff, true) !== LOC_SIG) throw new Error("ZIP inválido (local header).");
                const lNameLen = dv.getUint16(localOff + 26, true);
                const lExtraLen = dv.getUint16(localOff + 28, true);
                const dataOff = localOff + 30 + lNameLen + lExtraLen;

                if(comp !== 0) throw new Error("ZIP com compressão não suportada.");
                const data = u8.slice(dataOff, dataOff + cSize);
                out[name] = dec.decode(data);

                ptr = ptr + 46 + nameLen + extraLen + commentLen;
                if(ptr > cdOffset + cdSize) break;
            }
            return out;
        }

        function __collectBackupFiles(){
            // Normaliza o que precisa antes de exportar
            try{ if(typeof plannerNormalizeTasks === 'function') plannerTasks = plannerNormalizeTasks(plannerTasks); }catch(e){}
            const meta = {
                app: "SGP Pro",
                version: "v16",
                exportedAt: new Date().toISOString()
            };
            const core = { turmas, alunos, aulas, planosSemana, config, layouts };
            const planner = plannerTasks || [];

            // Preferências de interface (UI) — tema/cor/fonte/sidebar/grid
            const uiPrefs = {};
            try{
                ['sgp_darkmode','sgp_accent','sgp_fontsize','sgp_sidebar_hidden','sgp_mapa_grid','sgp_plano_disc_last'].forEach(k=>{
                    const v = localStorage.getItem(k);
                    if(v !== null && typeof v !== 'undefined') uiPrefs[k] = v;
                });
            }catch(_){ }

            const _lsArr = (k)=>{ try{ const r=localStorage.getItem(k); const v=r?JSON.parse(r):null; return Array.isArray(v)?v:[]; }catch(_){ return []; } };
            const acts = {
                forca: (typeof forcaBank !== 'undefined' && Array.isArray(forcaBank)) ? (forcaBank || []) : _lsArr('sgp_atividades_forca_bank'),
                vf: (typeof vfBank !== 'undefined' && Array.isArray(vfBank)) ? (vfBank || []) : _lsArr('sgp_atividades_vf_bank'),
                memoria: (typeof memBank !== 'undefined' && Array.isArray(memBank)) ? (memBank || []) : _lsArr('sgp_atividades_mem_bank'),
                flashcards: (typeof fcBank !== 'undefined' && Array.isArray(fcBank)) ? (fcBank || []) : _lsArr('sgp_atividades_fc_bank'),
                relacoes: (typeof relBank !== 'undefined' && Array.isArray(relBank)) ? (relBank || []) : _lsArr('sgp_atividades_rel_bank'),
                roleta: (typeof roletaBank !== 'undefined' && Array.isArray(roletaBank)) ? (roletaBank || []) : _lsArr('sgp_atividades_roleta_bank')
            };

            const extras = {
                audit: (typeof __AUDIT !== 'undefined') ? (__AUDIT || []) : [],
                autobackups: (typeof __BACKUPS !== 'undefined') ? (__BACKUPS || []) : []
            };

            const files = [
                ["manifest.json", JSON.stringify(meta, null, 2)],
                ["sgp_core.json", JSON.stringify(core, null, 2)],
                ["sgp_planner.json", JSON.stringify(planner, null, 2)],
                ["sgp_ui_prefs.json", JSON.stringify(uiPrefs, null, 2)],
                ["atividades_forca.json", JSON.stringify(acts.forca, null, 2)],
                ["atividades_vf.json", JSON.stringify(acts.vf, null, 2)],
                ["atividades_memoria.json", JSON.stringify(acts.memoria, null, 2)],
                ["atividades_flashcards.json", JSON.stringify(acts.flashcards, null, 2)],
                ["atividades_relacoes.json", JSON.stringify(acts.relacoes, null, 2)],
                ["atividades_roleta.json", JSON.stringify(acts.roleta, null, 2)],
                ["extras_audit.json", JSON.stringify(extras.audit, null, 2)],
                ["extras_autobackups.json", JSON.stringify(extras.autobackups, null, 2)]
            ];

            // Correção (Provas/Atividades)
            try{
                const cp = (typeof correcaoProvas !== 'undefined' && correcaoProvas && typeof correcaoProvas==='object')
                  ? correcaoProvas
                  : JSON.parse(localStorage.getItem('sgp_correcao_provas')||'{}');
                files.push(['sgp_correcao_provas.json', JSON.stringify(cp || {}, null, 2)]);
            }catch(_){}

            // === DADOS ADICIONAIS (V13+) ===
            // Frequência / Chamada
            try{ files.push(['sgp_frequencia.json', JSON.stringify((window.__sgpFrequencia && typeof window.__sgpFrequencia==='object') ? window.__sgpFrequencia : (JSON.parse(localStorage.getItem('sgp_frequencia')||'{}')), null, 2)]); }catch(_){}
            // Entregas
            try{ files.push(['sgp_entregas.json', JSON.stringify((window.__sgpEntregas && typeof window.__sgpEntregas==='object') ? window.__sgpEntregas : (JSON.parse(localStorage.getItem('sgp_entregas')||'{}')), null, 2)]); }catch(_){}
            // Ranking da Sala
            try{ files.push(['sgp_ranking_v1.json', JSON.stringify(JSON.parse(localStorage.getItem('sgp_ranking_v1')||'{}'), null, 2)]); }catch(_){}
            // Ranking: histórico semanal config
            try{ files.push(['sgp_rank_hist_cfg.json', JSON.stringify(JSON.parse(localStorage.getItem('sgp_rank_hist_cfg')||'{}'), null, 2)]); }catch(_){}
            // Quiz (atividades)
            try{ files.push(['atividades_quiz.json', JSON.stringify((typeof quizBank!=='undefined') ? (quizBank||[]) : JSON.parse(localStorage.getItem('sgp_atividades_quiz_bank')||'[]'), null, 2)]); }catch(_){}
            // Completar (atividades)
            try{ files.push(['atividades_completar.json', JSON.stringify((typeof compBank!=='undefined') ? (compBank||[]) : JSON.parse(localStorage.getItem('sgp_atividades_comp_bank')||'[]'), null, 2)]); }catch(_){}
            // Ordenar (atividades)
            try{ files.push(['atividades_ordenar.json', JSON.stringify((typeof ordBank!=='undefined') ? (ordBank||[]) : JSON.parse(localStorage.getItem('sgp_atividades_ord_bank')||'[]'), null, 2)]); }catch(_){}
            // Audit Log
            try{ files.push(['sgp_audit_log.json', JSON.stringify(window.__sgpAuditLog||[], null, 2)]); }catch(_){}
            // Frequency events log
            try{ files.push(['sgp_freq_events.json', JSON.stringify(window.__sgpFreqEvents||[], null, 2)]); }catch(_){}

            return files;
        }

        function baixarBackup() { 
            try{
                const zipBlob = __zipStore(__collectBackupFiles());
                __downloadBlob(zipBlob, __backupFileName());
__safeLSSet('sgp_last_backup', Date.now()); 
                try{ __safeLSSet('sgp_backup_pending', '0'); }catch(_){ }
                try{ try{
                const cur = parseInt(localStorage.getItem('sgp_last_core_save')||'0', 10);
                const now = Date.now();
                __safeLSSet('sgp_last_core_save', String((!isNaN(cur) && cur>0) ? cur : now));
            }catch(_){ } }catch(_){ }
                checkBackupStatus();
                dadosNaoSalvosEmArquivo = false;
                showToast("Backup ZIP baixado!");
            }catch(e){
                console.error(e);
                showToast("Erro ao gerar backup ZIP.", "error");
            }
        }

        
        function carregarBackup(i) { 
            const file = i.files && i.files[0];
            if(!file) { i.value=''; return; }

            const name = (file.name || '').toLowerCase();

            // --- ZIP (novo) ---
            if(name.endsWith('.zip') || (file.type && String(file.type).includes('zip'))){
                const r = new FileReader();
                r.onload = (e)=>{
                    try{
                        const files = __zipReadStore(e.target.result);
                        const readJson = (fname)=>{
                            if(!files || typeof files[fname] === 'undefined') return null;
                            try{ return JSON.parse(files[fname]); }catch(err){ return null; }
                        };

                        const core = readJson('sgp_core.json');
                        if(!core) throw new Error("Backup ZIP inválido (sgp_core.json ausente).");

                        turmas = Array.isArray(core.turmas) ? core.turmas : [];
                        alunos = Array.isArray(core.alunos) ? core.alunos : [];
                        aulas  = Array.isArray(core.aulas)  ? core.aulas  : [];
                        const __ps = core.planosSemana || core.planos_semanais;
                        planosSemana = (__ps && typeof __ps === 'object' && !Array.isArray(__ps)) ? __ps : {};
                        const __cfg = core.config;
                        if(__cfg && typeof __cfg === 'object' && !Array.isArray(__cfg)) config = __cfg;
                        layouts = (core.layouts && typeof core.layouts === 'object' && !Array.isArray(core.layouts)) ? core.layouts : {};

                        const pl = readJson('sgp_planner.json');
                        plannerTasks = Array.isArray(pl) ? pl : (pl && pl.tasks ? pl.tasks : []);
                        try{ plannerTasks = plannerNormalizeTasks(plannerTasks); }catch(e){}
// Atividades (bancos)
                        const bkForca = readJson('atividades_forca.json');
                        const bkVf = readJson('atividades_vf.json');
                        const bkMem = readJson('atividades_memoria.json');
                        const bkFc = readJson('atividades_flashcards.json');
                        const bkRel = readJson('atividades_relacoes.json');
                        const bkRoleta = readJson('atividades_roleta.json');

                        if(typeof forcaBank !== 'undefined' && Array.isArray(bkForca)) forcaBank = bkForca;
                        if(typeof vfBank !== 'undefined' && Array.isArray(bkVf)) vfBank = bkVf;
                        if(typeof memBank !== 'undefined' && Array.isArray(bkMem)) memBank = bkMem;
                        if(typeof fcBank !== 'undefined' && Array.isArray(bkFc)) fcBank = bkFc;
                        if(typeof relBank !== 'undefined' && Array.isArray(bkRel)) relBank = bkRel;
                        if(typeof roletaBank !== 'undefined' && Array.isArray(bkRoleta)) roletaBank = bkRoleta;

                        // Extras (opcional)
                        const exAudit = readJson('extras_audit.json');
                        const exBackups = readJson('extras_autobackups.json');
                        if(typeof __AUDIT !== 'undefined' && Array.isArray(exAudit)) __AUDIT = exAudit;
                        if(typeof __BACKUPS !== 'undefined' && Array.isArray(exBackups)) __BACKUPS = exBackups;

                        // Persiste no localStorage (mesmo formato do app)
                        try{
                            // Core é salvo de forma atômica via salvarDadosLocal() mais abaixo (evita duplicação de chaves)
                            __safeLSSet('sgp_planner', JSON.stringify(plannerTasks || []));
                        }catch(e){} 

                        // UI prefs (tema/cor/fonte/sidebar/grid)
                        try{
                            const ui = readJson('sgp_ui_prefs.json');
                            if(ui && typeof ui === 'object'){
                                Object.keys(ui).forEach(k=>{
                                    try{ if(k && String(k).startsWith('sgp_')) __safeLSSet(k, String(ui[k])); }catch(_){}
                                });
                                try{ if(localStorage.getItem('sgp_darkmode')==='1') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); }catch(_){}
                                try{ const a=localStorage.getItem('sgp_accent'); if(a) document.documentElement.style.setProperty('--primary', a); }catch(_){}
                                try{ const fs=localStorage.getItem('sgp_fontsize'); if(fs) document.documentElement.style.fontSize=fs+'px'; }catch(_){}
                                try{ if(typeof initSidebarMobile==='function') initSidebarMobile(); }catch(_){}
                            }
                        }catch(_){}



// Atividades storages
                        try{
                            if(typeof ACT_STORAGE !== 'undefined'){
                                if(typeof bkForca !== 'undefined' && bkForca) __safeLSSet(ACT_STORAGE.forca, JSON.stringify(forcaBank||[]));
                                if(typeof bkVf !== 'undefined' && bkVf) __safeLSSet(ACT_STORAGE.vf, JSON.stringify(vfBank||[]));
                                if(typeof bkMem !== 'undefined' && bkMem) __safeLSSet(ACT_STORAGE.mem, JSON.stringify(memBank||[]));
                                if(typeof bkFc !== 'undefined' && bkFc) __safeLSSet(ACT_STORAGE.fc, JSON.stringify(fcBank||[]));
                                if(typeof bkRel !== 'undefined' && bkRel) __safeLSSet(ACT_STORAGE.rel, JSON.stringify(relBank||[]));
                                if(typeof bkRoleta !== 'undefined' && bkRoleta) __safeLSSet(ACT_STORAGE.roleta, JSON.stringify(roletaBank||[]));
                            }
                        }catch(e){}

                        // Restore quiz/completar/ordenar banks
                        try{
                            const bkQuiz = readJson('atividades_quiz.json');
                            if(Array.isArray(bkQuiz)){
                                if(typeof quizBank !== 'undefined') quizBank = bkQuiz;
                                __safeLSSet('sgp_atividades_quiz_bank', JSON.stringify(bkQuiz));
                            }
                        }catch(_){}
                        try{
                            const bkComp = readJson('atividades_completar.json');
                            if(Array.isArray(bkComp)){
                                if(typeof compBank !== 'undefined') compBank = bkComp;
                                __safeLSSet('sgp_atividades_comp_bank', JSON.stringify(bkComp));
                            }
                        }catch(_){}
                        try{
                            const bkOrd = readJson('atividades_ordenar.json');
                            if(Array.isArray(bkOrd)){
                                if(typeof ordBank !== 'undefined') ordBank = bkOrd;
                                __safeLSSet('sgp_atividades_ord_bank', JSON.stringify(bkOrd));
                            }
                        }catch(_){}

                        try{ if(typeof __saveExtras === 'function') __saveExtras(); }catch(e){}

                        // Restore frequência from backup
                        try{
                            const bkFreq = readJson('sgp_frequencia.json');
                            if(bkFreq && typeof bkFreq === 'object'){
                                window.__sgpFrequencia = bkFreq;
                                __safeLSSet('sgp_frequencia', JSON.stringify(bkFreq));
                            }
                        }catch(_){}

                        // Restore entregas from backup
                        try{
                            const bkEntregas = readJson('sgp_entregas.json');
                            if(bkEntregas && typeof bkEntregas === 'object'){
                                window.__sgpEntregas = bkEntregas;
                                __safeLSSet('sgp_entregas', JSON.stringify(bkEntregas));
                            }
                        }catch(_){}

                        // Restore ranking from backup
                        try{
                            const bkRanking = readJson('sgp_ranking_v1.json');
                            if(bkRanking && typeof bkRanking === 'object'){
                                __safeLSSet('sgp_ranking_v1', JSON.stringify(bkRanking));
                            }
                        }catch(_){}

                        // Restore ranking hist config from backup
                        try{
                            const bkHistCfg = readJson('sgp_rank_hist_cfg.json');
                            if(bkHistCfg && typeof bkHistCfg === 'object'){
                                __safeLSSet('sgp_rank_hist_cfg', JSON.stringify(bkHistCfg));
                            }
                        }catch(_){}

                        // Restore audit log from backup
                        try{
                            const bkAuditLog = readJson('sgp_audit_log.json');
                            if(Array.isArray(bkAuditLog)){
                                window.__sgpAuditLog = bkAuditLog;
                                __safeLSSet('sgp_audit_log', JSON.stringify(bkAuditLog));
                            }
                        }catch(_){}

                        // Restore freq events from backup
                        try{
                            const bkFreqEvents = readJson('sgp_freq_events.json');
                            if(Array.isArray(bkFreqEvents)){
                                window.__sgpFreqEvents = bkFreqEvents;
                                __safeLSSet('sgp_freq_events', JSON.stringify(bkFreqEvents));
                            }
                        }catch(_){}

                        // Restore correção de provas (sgp_correcao_provas)
                        try{
                            const bkCor = readJson('sgp_correcao_provas.json');
                            if(bkCor && typeof bkCor === 'object'){
                                correcaoProvas = bkCor;
                                try{ if(typeof __safeLSSet==='function') __safeLSSet('sgp_correcao_provas', JSON.stringify(bkCor)); else localStorage.setItem('sgp_correcao_provas', JSON.stringify(bkCor)); }catch(__){}
                            }
                        }catch(_){ }

                        garantirEstruturaNova();
                        salvarDadosLocal();
                        renderizarMenu(); 
                        renderizarVisao(); 
                        atualizarLabelsConfig(); 
                        renderizarVisaoContent();
                        if(typeof initAtividades === 'function') initAtividades();
                        if(typeof initPlanner === 'function') initPlanner();
                        if(typeof initCorrecao === 'function') initCorrecao();
                        // Reload quiz/comp/ord banks (not covered by initAtividades)
                        try{ if(typeof quizLoad==='function'){ quizLoad(); quizRenderBank(); } }catch(_){}
                        try{ if(typeof compLoad==='function'){ compLoad(); compRenderBank(); } }catch(_){}
                        try{ if(typeof ordLoad==='function'){ ordLoad(); ordRenderBank(); } }catch(_){}
                        try{ __safeLSSet('sgp_last_backup', Date.now()); }catch(_){}
                        try{ __safeLSSet('sgp_backup_pending', '0'); }catch(_){}
                        try{ try{
                const cur = parseInt(localStorage.getItem('sgp_last_core_save')||'0', 10);
                const now = Date.now();
                __safeLSSet('sgp_last_core_save', String((!isNaN(cur) && cur>0) ? cur : now));
            }catch(_){ } }catch(_){}
                        try{ checkBackupStatus(); }catch(_){}
                        try{ dadosNaoSalvosEmArquivo = false; }catch(_){}
                        showToast("Backup ZIP carregado!");
                    }catch(err){
                        console.error(err);
                        showToast("Erro ao carregar backup ZIP.", "error");
                    }finally{
                        i.value='';
                    }
                };
                r.readAsArrayBuffer(file);
                return;
            }

            // --- JSON (legado) ---
            const r=new FileReader(); 
            r.onload=e=>{
                try{
                    const d=JSON.parse(e.target.result); 
                    if(d.turmas){
                        turmas=d.turmas;
                        alunos=d.alunos;
                        aulas=d.aulas||[]; 
                        planosSemana=d.planosSemana||d.planos_semanais||planosSemana||{}; 
                        config=d.config||config; 
                        layouts=d.layouts||{};
                        // Correção (Provas/Atividades)
                        try{
                          const dcp = d.correcaoProvas || d.sgp_correcao_provas || d.sgp_correcao_provas_v1 || null;
                          if(dcp && typeof dcp === 'object'){
                            correcaoProvas = dcp;
                            try{ if(typeof __safeLSSet==='function') __safeLSSet('sgp_correcao_provas', JSON.stringify(correcaoProvas||{})); else localStorage.setItem('sgp_correcao_provas', JSON.stringify(correcaoProvas||{})); }catch(_){ }
                          }
                        }catch(_){ }
                        // Planner (v1)
                        if(typeof d.planner !== 'undefined') plannerTasks = Array.isArray(d.planner) ? d.planner : (d.planner?.tasks || []);
                        else if(typeof d.plannerTasks !== 'undefined') plannerTasks = Array.isArray(d.plannerTasks) ? d.plannerTasks : [];
                        try{ __safeLSSet('sgp_planner', JSON.stringify(plannerTasks||[])); }catch(e){}
                        garantirEstruturaNova();
                        salvarDadosLocal();
                        renderizarMenu();
                        renderizarVisao();
                        atualizarLabelsConfig();
                        try{ if(typeof initCorrecao === 'function') initCorrecao(); }catch(_){}
                        showToast("Backup carregado!");
                        try{ __safeLSSet('sgp_last_backup', Date.now()); }catch(_){ }
                        try{ __safeLSSet('sgp_backup_pending', '0'); }catch(_){ }
                        try{ checkBackupStatus(); }catch(_){ }
                        try{ dadosNaoSalvosEmArquivo = false; }catch(_){ }
                    }
                }catch(e){
                    showToast("Erro ao carregar.", "error");
                }
            }; 
            r.readAsText(file); 
            i.value=''; 
        }

        // [REMOVED] Old exportarCSV - replaced by V13 complete version (see below)

        // --- FILTROS & RENDER ---
        function toggleFiltroRisco(){
            filtroRiscoAtivo = !filtroRiscoAtivo;
            if(filtroRiscoAtivo) filtroInclusaoAtivo = false;
            atualizarInterfaceFiltros();
            setTimeout(() => { renderizarVisao(); }, 10);
        }

        function toggleFiltroInclusao(){
            filtroInclusaoAtivo = !filtroInclusaoAtivo;
            if(filtroInclusaoAtivo) filtroRiscoAtivo = false;
            atualizarInterfaceFiltros();
            setTimeout(() => { renderizarVisao(); }, 10);
        }
        
        function atualizarInterfaceFiltros() {
            const btnRisco = document.getElementById('btnFiltroRisco');
            const btnInclusao = document.getElementById('btnFiltroInclusao');
            const banner = document.getElementById('bannerRisco');

            if (filtroRiscoAtivo) {
                btnRisco.classList.add('active');
                banner.style.display = 'flex';
            } else {
                btnRisco.classList.remove('active');
                banner.style.display = 'none';
            }

            if (filtroInclusaoAtivo) {
                btnInclusao.classList.add('active');
            } else {
                btnInclusao.classList.remove('active');
            }
        }
        
        function getAlunosFiltrados(){ 
            let l = filtroTurma === 'Todas' ? [...alunos] : alunos.filter(a => a.turma === filtroTurma);
            
            // Aplica busca global
            if(buscaGlobal) {
                l = l.filter(a => ((a._nomeLower || (a._nomeLower = (a.nome||'').toLowerCase()))).includes(buscaGlobal));
            }
            
            if(filtroRiscoAtivo){
                l = l.filter(a => {
                    const b = a.bimestres[bimestreAtual];
                    return (parseFloat(b.media_lp) < 5 || parseFloat(b.media_red) < 5 || _migrateEntregaStatus(b.entregas_red.r1)!=='entregue' || _migrateEntregaStatus(b.entregas_red.r2)!=='entregue');
                });
            }
            
            if(filtroInclusaoAtivo){
                l = l.filter(a => a.elegivel);
            }
            
            return l;
        }
        
        function copiarListaRisco(){ const l=getAlunosFiltrados(); let t=`[RISCO] *Risco - ${filtroTurma}*\n`; l.forEach(a=>t+=`${__u(a.nome)}\n`); navigator.clipboard.writeText(t); showToast("Lista copiada!"); }

        function mudarBimestre(n){bimestreAtual=n; document.querySelectorAll('.btn-bim').forEach(b=>b.classList.remove('active')); document.getElementById('btnBim'+n).classList.add('active'); renderizarVisao();}
        function mudarVisao(t){
            visaoAtual=t; 
            document.body.classList.remove('ranking-view');
            if(t!=='ranking') document.body.classList.remove('ranking-is-fullscreen');

            ['btnViewCards','btnViewLista','btnViewMassa','btnViewEntregas','btnViewAulas','btnViewDash','btnViewCorrecao','btnViewMapa','btnViewCalendar','btnViewAnual','btnViewRanking'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('active');}); 
            ['gridAlunos','tabelaFechamento','viewMassa','tabelaEntregas','viewAulas','viewDashboard','viewCorrecao','viewMapa','viewCalendar','viewAnual','viewRanking'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';}); 
            const btnEl=document.getElementById('btnView'+(t.charAt(0).toUpperCase()+t.slice(1)));
            if(btnEl) btnEl.classList.add('active'); 
            
            if(t==='cards')document.getElementById('gridAlunos').style.display='grid';
            else if(t==='lista')document.getElementById('tabelaFechamento').style.display='table';
            else if(t==='massa')document.getElementById('viewMassa').style.display='block';
            else if(t==='entregas')document.getElementById('tabelaEntregas').style.display='table';
            else if(t==='anual')document.getElementById('viewAnual').style.display='block';
            else if(t==='aulas')document.getElementById('viewAulas').style.display='flex';
            else if(t==='calendar'){document.getElementById('viewCalendar').style.display='flex'; renderizarCalendario();}
            else if(t==='dash')document.getElementById('viewDashboard').style.display='grid';
            else if(t==='correcao'){document.getElementById('viewCorrecao').style.display='flex'; corRenderAll();}
            else if(t==='mapa'){document.getElementById('viewMapa').style.display='flex'; carregarSelectLayouts(); mapaUpdateFullscreenUI();}
            else if(t==='ranking'){document.getElementById('viewRanking').style.display='flex'; document.body.classList.add('ranking-view'); if(typeof rankUpdateFullscreenUI==='function') rankUpdateFullscreenUI();}
            renderizarVisaoContent();
            if(visaoAtual==='correcao'){ try{ corRenderAll(); }catch(_){ } }
        }
        function renderizarVisaoContent(){ 
            if(visaoAtual==='cards')renderizarGrid(); 
            else if(visaoAtual==='lista')renderizarListaSED(); 
            else if(visaoAtual==='massa')renderizarEdicaoMassa();
            else if(visaoAtual==='entregas')renderizarListaEntregas(); 
            else if(visaoAtual==='anual')renderizarTabelaAnual();
            else if(visaoAtual==='aulas')renderizarAulas(); 
            else if(visaoAtual==='dash')renderizarDashboard(); 
            else if(visaoAtual==='mapa')renderizarMapa();
            else if(visaoAtual==='ranking')renderizarRanking();
        }

        // --- MENU TURMAS: render robusto + clique confiável (event delegation) ---
function escHTML(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
}

function initMenuTurmas(){
    const ul = document.getElementById('listaTurmas');
    if(!ul || ul.dataset.bound==='1') return;
    ul.dataset.bound='1';

    ul.addEventListener('click', function(e){
        const delBtn = e.target.closest('.btn-trash-turma');
        if(delBtn){
            e.stopPropagation();
            const raw = delBtn.getAttribute('data-del-turma') || '';
            const turma = decodeURIComponent(raw);
            return delTurma(turma, e);
        }

        const item = e.target.closest('.turma-item');
        if(item){
            const raw = item.getAttribute('data-turma') || '';
            const turma = decodeURIComponent(raw);
            return selTurma(turma);
        }
    });
}

function renderizarMenu(){
    const ul = document.getElementById('listaTurmas');
    if(!ul) return;

    let htmlBuffer =
        `<li class="turma-item ${filtroTurma === 'Todas' ? 'active' : ''}" data-turma="${encodeURIComponent('Todas')}">
            <span><i class="fas fa-layer-group"></i> Todas</span>
        </li>`;

    turmas.forEach(t => {
        const safeText = escHTML(t);
        const enc = encodeURIComponent(t);

        htmlBuffer += `
        <li class="turma-item ${filtroTurma === t ? 'active' : ''}" data-turma="${enc}">
            <span><i class="fas fa-users"></i> ${safeText}</span>
            <button class="btn-trash-turma" type="button" data-del-turma="${enc}" aria-label="Excluir turma" title="Excluir turma">
                <i class="fas fa-trash"></i>
            </button>
        </li>`;
    });

    ul.innerHTML = htmlBuffer;
    if(document.getElementById('aulaModoGeral')?.checked) renderAulaTurmasChecklist();
}

function selTurma(n){
            filtroTurma=n; 
            document.getElementById('tituloPrincipal').innerText=n; 
            renderizarMenu(); 
            renderizarVisaoContent();
            if(visaoAtual==='correcao'){ try{ corRenderAll(); }catch(_){ } }
        }

        function getCorFarol(m){m=parseFloat(m); if(m>=7)return'var(--farol-verde)'; if(m>=5)return'var(--farol-amarelo)'; return'var(--farol-vermelho)';}
        function getFarolCls(m){m=parseFloat(m); if(m>=7)return'fc-verde'; if(m>=5)return'fc-amarelo'; return'fc-vermelho';}

        // Notas: parse + trava (0..10) + farol por cor diretamente no input
        function parseNota(v){
            if(v === null || typeof v === 'undefined') return 0;
            if(typeof v === 'string') v = v.replace(',', '.');
            const n = parseFloat(v);
            return isFinite(n) ? n : 0;
        }
        function clampNota(v){
            let n = parseNota(v);
            if(n > 10) n = 10;
            if(n < 0) n = 0;
            return n;
        }
        function getFarolClassByNota(v){
            const n = clampNota(v);
            if(n >= 7) return 'farol-verde';
            if(n >= 5) return 'farol-amarelo';
            return 'farol-vermelho';
        }
        function handleNotaInput(inp){
            if(!inp) return;
            const raw = (typeof inp.value === 'string') ? inp.value : String(inp.value ?? '');
            const n = clampNota(raw);
            // mantém entrada consistente e bloqueia > 10
            if(raw.trim() === '' || parseNota(raw) !== n){
                inp.value = n;
            }
            inp.classList.remove('farol-verde','farol-amarelo','farol-vermelho');
            inp.classList.add(getFarolClassByNota(n));
        }

        
        // Hook system for card rendering extensions
        const _cardRenderHooks = [];
        const _sparkCache = new Map(); // Cache sparkline data to avoid double computation
        
        // IntersectionObserver for staggered card reveal animation
        let _cardRevealObserver = null;
        function _initCardObserver(){
            if(_cardRevealObserver) return;
            _cardRevealObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry, i) => {
                    if(entry.isIntersecting){
                        const el = entry.target;
                        const delay = parseInt(el.dataset.cardIdx || '0') * 40;
                        setTimeout(() => el.classList.add('card-visible'), Math.min(delay, 300));
                        _cardRevealObserver.unobserve(el);
                    }
                });
            }, { threshold: 0.05 });
        }

        // Build sparkline data for a student (all bimestres)
        function _buildSparklineData(a){
            const vals=[];
            [1,2,3,4].forEach(bim => {
                const b=a.bimestres[bim]; if(!b) return;
                _syncBimestreRefs(b);
                const m1=parseFloat(b.media_lp)||0, m2=parseFloat(b.media_red)||0;
                vals.push((m1+m2)/2);
            });
            return vals;
        }
        function _getSparklineTrend(vals){
            if(vals.length < 2) return { cls:'stable', icon:'→' };
            const trend = vals[vals.length-1] - vals[0];
            if(trend > 0.5) return { cls:'up', icon:'↑' };
            if(trend < -0.5) return { cls:'down', icon:'↓' };
            return { cls:'stable', icon:'→' };
        }

        function renderizarGrid(){
            const d = document.getElementById('gridAlunos');
            const l = getAlunosFiltrados();
            _sparkCache.clear();
            
            if (l.length === 0) {
                d.innerHTML = '<div class="empty-state" style="text-align:center; padding:60px; color:var(--text-muted,#94a3b8); font-size:1.1rem;"><i class="fas fa-inbox" style="font-size:3rem; display:block; margin-bottom:15px; opacity:0.5;"></i>Nenhum aluno encontrado</div>';
                return;
            }

            _initCardObserver();

            // Build a map of current IDs for efficient diffing
            const newIds = new Set(l.map(a => String(a.id)));
            const existingCards = d.querySelectorAll('.card-aluno[data-id]');
            const existingMap = new Map();
            existingCards.forEach(c => existingMap.set(c.getAttribute('data-id'), c));

            // Remove cards no longer in filtered list
            existingMap.forEach((card, id) => {
                if(!newIds.has(id)){
                    _cardRevealObserver.unobserve(card);
                    card.remove();
                }
            });

            // Build or update each card
            const fragment = document.createDocumentFragment();
            l.forEach((a, idx) => {
                const b = a.bimestres[bimestreAtual];
                const cardId = String(a.id);
                let card = existingMap.get(cardId);

                if(card){
                    // Update existing card content
                    _updateCardContent(card, a, b, idx);
                } else {
                    // Create new card
                    card = _createCardElement(a, b, idx);
                    _cardRevealObserver.observe(card);
                }
                fragment.appendChild(card);
            });

            d.innerHTML = '';
            d.appendChild(fragment);

            // Draw sparklines on canvas elements (must be in DOM)
            // Reuse cached sparkline data stored during _fillCardHTML via _sparkCache
            l.forEach(a => {
                const cvs = d.querySelector(`.card-aluno[data-id="${a.id}"] .sparkline-canvas`);
                if(cvs){
                    const vals = _sparkCache.get(String(a.id));
                    if(vals && vals.length >= 2) drawSparkline(cvs, vals, 80, 28);
                }
            });

            // Run any registered extension hooks
            _cardRenderHooks.forEach(fn => { try{ fn(d, l); }catch(_){} });
        }

        function _createCardElement(a, b, idx){
            const card = document.createElement('div');
            card.className = 'card-aluno';
            card.setAttribute('data-id', a.id);
            card.setAttribute('data-card-idx', idx);
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'article');
            card.setAttribute('aria-label', 'Aluno ' + (a.nome || ''));
            // Keyboard navigation: Enter/Space opens student details
            card.addEventListener('keydown', function(e){
                if(e.key === 'Enter' || e.key === ' '){
                    // Don't trigger if focus is on a button inside the card
                    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
                    e.preventDefault();
                    abrirDetalhes(a.id);
                }
            });
            _fillCardHTML(card, a, b, idx);
            return card;
        }

        function _updateCardContent(card, a, b, idx){
            card.setAttribute('data-card-idx', idx);
            card.setAttribute('aria-label', 'Aluno ' + (a.nome || ''));
            // Check if content actually changed
            const oldHash = card.dataset.hash || '';
            const newHash = `${idx}_${b.media_lp}_${b.media_red}_${b.comportamento}_${a.elegivel}`;
            if(oldHash === newHash) return;
            _fillCardHTML(card, a, b, idx);
            card.dataset.hash = newHash;
        }

        function _fillCardHTML(card, a, b, idx){
            const bg = a.elegivel ? `<span class="badge-inclusao"><i class="fas fa-universal-access"></i> Elegivel</span>` : '';
            const compVal = parseFloat(b.comportamento) || 0;
            
            // Build sparkline section (single call, cached for canvas draw pass)
            const sparkVals = _buildSparklineData(a);
            _sparkCache.set(String(a.id), sparkVals);
            const trend = _getSparklineTrend(sparkVals);
            const sparkHTML = sparkVals.length >= 2
                ? `<div class="sparkline-box"><canvas class="sparkline-canvas" width="80" height="28"></canvas><span class="sparkline-trend ${trend.cls}">${trend.icon}</span></div>`
                : '';

            card.dataset.hash = `${idx}_${b.media_lp}_${b.media_red}_${b.comportamento}_${a.elegivel}`;
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-info-row">
                            <span class="aluno-numero">${idx + 1}</span>
                            <span class="aluno-nome-wrap">
                                <a class="aluno-nome" data-onclick="abrirDetalhes(${__u(a.id)})" title="${_escHTML(a.nome)}">${_escHTML(a.nome)}</a>
                            </span>
                            ${bg}
                        </div>
                        <span class="aluno-turma"><i class="fas fa-users"></i> ${_escHTML(a.turma)}</span>
                    </div>
                    <div class="card-actions-row">
                        <div class="blitz-box" title="Modo Blitz (Comportamento)">
                            <i class="fas fa-bolt blitz-icon"></i>
                            <button class="btn-blitz minus" data-onclick="funcBlitz(${__u(a.id)}, -0.5)" aria-label="Diminuir comportamento">−</button>
                            <button class="btn-blitz plus" data-onclick="funcBlitz(${__u(a.id)}, 0.5)" aria-label="Aumentar comportamento">+</button>
                        </div>
                        <button class="btn-boletim-card" data-onclick="abrirBoletim(${__u(a.id)})" title="Boletim" aria-label="Ver boletim">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn-delete-card" data-onclick="confirmarDelAluno(${__u(a.id)})" title="Remover aluno" aria-label="Remover aluno">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${sparkHTML}
                <div class="card-stats">
                    <div class="stat-item">
                        <span><i class="fas fa-book"></i> ${_escHTML(config.materia1)}</span>
                        <div class="farol-badge">
                            <i class="fas fa-circle ${getFarolCls(b.media_lp)}"></i>
                            <span>${__u(b.media_lp)}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span><i class="fas fa-pen"></i> ${_escHTML(config.materia2)}</span>
                        <div class="farol-badge">
                            <i class="fas fa-circle ${getFarolCls(b.media_red)}"></i>
                            <span>${__u(b.media_red)}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span><i class="fas fa-user-check"></i> Comportamento</span>
                        <div class="farol-badge">
                            <i class="fas fa-circle ${getFarolCls(compVal)}"></i>
                            <span>${__u(compVal)}</span>
                        </div>
                    </div>
                </div>`;
        }
        
        function funcBlitz(id, valor) {
            const a = alunos.find(al => al.id === id);
            if(a) {
                const b = a.bimestres[bimestreAtual];
                let novo = parseFloat(b.comportamento) + valor;
                if(novo > 10) novo = 10;
                if(novo < 0) novo = 0;
                b.comportamento = novo;
                
                const tipo = valor > 0 ? "Elogio (Blitz)" : "Apontamento (Blitz)";
                b.ocorrencias.push({
                    id: Date.now(),
                    data: new Date().toLocaleDateString(),
                    texto: `${tipo}: Ajuste de ${valor > 0 ? '+' : ''}${valor}. Nota atual: ${novo}`
                });
                
                salvarDadosLocal();
                showToast(`Comportamento de ${a.nome.split(' ')[0]}: ${novo}`);
                renderizarVisaoContent(); 
            }
        }

                function __isMobileUI(){ return window.innerWidth <= 768; }

        function renderizarListaSED(){
            const table = document.getElementById('tabelaFechamento');
            const tbody = document.getElementById('tbodyFechamento');
            const cards = document.getElementById('mobileFechamentoCards');

            const lista = getAlunosFiltrados().sort((a,b)=>a.nome.localeCompare(b.nome));

            let htmlBuffer = '';
            lista.forEach((a, idx)=>{
                const b = a.bimestres[bimestreAtual];
                htmlBuffer += `<tr><td>${idx+1}</td><td>${_escHTML(a.nome)}</td><td>${_escHTML(a.turma)}</td><td>${__u(b.media_lp)}</td><td>${__u(b.media_red)}</td><td>${__u(b.comportamento)}</td></tr>`;
            });
            if(tbody) tbody.innerHTML = htmlBuffer;

            // Mobile: render as cards (better touch + readability)
            if(__isMobileUI() && cards){
                try{ if(table) table.style.display='none'; }catch(_){}
                cards.style.display='block';
                let cbuf = '';
                lista.forEach((a, idx)=>{
                    const b = a.bimestres[bimestreAtual] || {};
                    cbuf += `
                      <div class="mcard">
                        <div class="mcard-head">
                          <div>
                            <div class="mcard-title">${idx+1}. ${_escHTML(a.nome)}</div>
                            <div class="mcard-sub">${_escHTML(a.turma||'')}</div>
                          </div>
                        </div>
                        <div class="mcard-tags">
                          <span class="mchip"><b>LP</b> ${__u(b.media_lp)}</span>
                          <span class="mchip"><b>RED</b> ${__u(b.media_red)}</span>
                          <span class="mchip"><b>Comp</b> ${__u(b.comportamento)}</span>
                        </div>
                      </div>`;
                });
                cards.innerHTML = cbuf || `<div class="mcard" style="text-align:center;color:#64748b;">Nenhum aluno.</div>`;
            }else{
                if(cards) cards.style.display='none';
                try{ if(table && visaoAtual==='lista') table.style.display='table'; }catch(_){}
            }
        }

        function _migrateEntregaStatus(val){
            // Migrate old boolean values to new status strings
            if(val === true) return 'entregue';
            if(val === false || val === undefined || val === null || val === 0) return 'pendente';
            if(typeof val === 'string' && ['entregue','rascunho','revisao','pendente'].includes(val)) return val;
            return 'pendente';
        }
        function _entregaStatusInfo(st){
            const map = {
                'entregue':  {label:'Entregue',    icon:'fa-check-circle',       cls:'st-entregue'},
                'rascunho':  {label:'Rascunho',    icon:'fa-pencil-alt',         cls:'st-rascunho'},
                'revisao':   {label:'Em revisão',   icon:'fa-exclamation-circle', cls:'st-revisao'},
                'pendente':  {label:'Pendente',     icon:'fa-times-circle',       cls:'st-pendente'}
            };
            return map[st] || map['pendente'];
        }
        function _entregaSelectHTML(alunoId, key, currentStatus){
            const si = _entregaStatusInfo(currentStatus);
            return `<select class="entrega-select ${si.cls}" data-onchange="mEnt(${__u(alunoId)},'${key}',this.value)">
              <option value="pendente" ${currentStatus==='pendente'?'selected':''}>⊘ Pendente</option>
              <option value="rascunho" ${currentStatus==='rascunho'?'selected':''}>✏ Rascunho</option>
              <option value="revisao"  ${currentStatus==='revisao' ?'selected':''}>⚠ Em revisão</option>
              <option value="entregue" ${currentStatus==='entregue'?'selected':''}>✔ Entregue</option>
            </select>`;
        }
        function _entregaBadgeHTML(st){
            const si = _entregaStatusInfo(st);
            return `<span class="entrega-badge ${si.cls}"><i class="fas ${si.icon} fa-circle"></i> ${si.label}</span>`;
        }

        function renderizarListaEntregas(){
            const table = document.getElementById('tabelaEntregas');
            const tbody = document.getElementById('tbodyEntregas');
            const cards = document.getElementById('mobileEntregasCards');

            const lista = getAlunosFiltrados();

            // Ensure migration of old boolean values
            lista.forEach(a => {
                const b = a.bimestres[bimestreAtual];
                if(!b.entregas_red) b.entregas_red = {};
                b.entregas_red.r1 = _migrateEntregaStatus(b.entregas_red.r1);
                b.entregas_red.r2 = _migrateEntregaStatus(b.entregas_red.r2);
            });

            // Summary counts
            let counts = {r1:{entregue:0,rascunho:0,revisao:0,pendente:0}, r2:{entregue:0,rascunho:0,revisao:0,pendente:0}};
            lista.forEach(a => {
                const b = a.bimestres[bimestreAtual];
                ['r1','r2'].forEach(k => { const st = b.entregas_red[k] || 'pendente'; if(counts[k][st] !== undefined) counts[k][st]++; });
            });

            let htmlBuffer = '';
            lista.forEach((a, idx)=>{
                const b = a.bimestres[bimestreAtual];
                const st1 = b.entregas_red.r1 || 'pendente';
                const st2 = b.entregas_red.r2 || 'pendente';
                const si1 = _entregaStatusInfo(st1);
                const si2 = _entregaStatusInfo(st2);
                htmlBuffer += `<tr>
                  <td>${idx+1}</td>
                  <td>${_escHTML(a.nome)}</td>
                  <td>${_escHTML(a.turma)}</td>
                  <td style="text-align:center;">${_entregaSelectHTML(a.id, 'r1', st1)}</td>
                  <td style="text-align:center;">${_entregaSelectHTML(a.id, 'r2', st2)}</td>
                </tr>`;
            });
            if(tbody) tbody.innerHTML = htmlBuffer;

            // Mobile: render as cards
            if(__isMobileUI() && cards){
                try{ if(table) table.style.display='none'; }catch(_){}
                cards.style.display='block';
                let cbuf = '';
                lista.forEach((a, idx)=>{
                    const b = a.bimestres[bimestreAtual];
                    const st1 = b.entregas_red.r1 || 'pendente';
                    const st2 = b.entregas_red.r2 || 'pendente';
                    cbuf += `
                      <div class="mcard">
                        <div class="mcard-head">
                          <div>
                            <div class="mcard-title">${idx+1}. ${_escHTML(a.nome)}</div>
                            <div class="mcard-sub">${_escHTML(a.turma||'')}</div>
                          </div>
                        </div>
                        <div class="mcard-grid">
                          <label class="mcheck" style="flex-direction:column;align-items:flex-start;gap:4px;">
                            <span class="lbl" style="font-weight:600;font-size:.78rem;">Redação 1</span>
                            ${_entregaSelectHTML(a.id, 'r1', st1)}
                          </label>
                          <label class="mcheck" style="flex-direction:column;align-items:flex-start;gap:4px;">
                            <span class="lbl" style="font-weight:600;font-size:.78rem;">Redação 2</span>
                            ${_entregaSelectHTML(a.id, 'r2', st2)}
                          </label>
                        </div>
                      </div>`;
                });
                cards.innerHTML = cbuf || `<div class="mcard" style="text-align:center;color:#64748b;">Nenhum aluno.</div>`;
            }else{
                if(cards) cards.style.display='none';
                try{ if(table && visaoAtual==='entregas') table.style.display='table'; }catch(_){}
            }
        }
        function mEnt(id,k,v){
            const a = alunos.find(al=>al.id===id);
            if(!a) return;
            const b = a.bimestres[bimestreAtual];
            if(!b.entregas_red) b.entregas_red = {};
            b.entregas_red[k] = v;
            salvarDadosLocal();
            renderizarListaEntregas();
        }
        
        function renderizarTabelaAnual() {
            const t = document.getElementById('tbodyAnual');
            const lista = getAlunosFiltrados(); 
            
            if(lista.length === 0) {
                t.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Nenhum aluno nesta turma.</td></tr>';
                return;
            }

            let htmlBuffer = '';
            lista.forEach((a, idx) => {
                let soma = 0;
                let cols = '';
                let bimestresFechados = 0;
                
                [1,2,3,4].forEach(b => {
                    const media = parseFloat(a.bimestres[b].media_lp) || 0;
                    if(a.bimestres[b].media_lp !== "0.0") bimestresFechados++; 
                    soma += media;
                    const cor = getCorFarol(media);
                    cols += `<td style="color:${cor};">${media.toFixed(1)}</td>`;
                });
                
                const metaAnual = 20;
                const faltam = metaAnual - soma;
                let msgFalta = '';
                if(faltam <= 0) {
                    msgFalta = '<span style="color:var(--farol-verde); font-weight:bold;"><i class="fas fa-check"></i> Atingido</span>';
                } else {
                    const bimsRestantes = 4 - bimestresFechados;
                    if(bimsRestantes > 0) {
                        const mediaNec = (faltam / bimsRestantes).toFixed(1);
                         msgFalta = `<span style="color:#b45309; font-weight:bold;">Faltam ${faltam.toFixed(1)}</span>`;
                    } else {
                         msgFalta = `<span style="color:red; font-weight:bold;">Faltam ${faltam.toFixed(1)}</span>`;
                    }
                }

                const final = (soma / 4).toFixed(1);
                const nfFinal = parseFloat(final) || 0;
                const corFinal = getCorFarol(nfFinal);
                let bgFinal = 'rgba(220, 38, 38, 0.10)';
                if(nfFinal >= 7) bgFinal = 'rgba(22, 163, 74, 0.10)';
                else if(nfFinal >= 5) bgFinal = 'rgba(245, 158, 11, 0.12)';
                let status = '<span style="color:var(--farol-verde); font-weight:bold;">Aprovado</span>';
                if(final < 5) status = '<span style="color:var(--farol-vermelho); font-weight:bold;">Recuperação</span>';
                
                htmlBuffer += `<tr>
                    <td>${idx+1}</td>
                    <td>${_escHTML(a.nome)}</td>
                    ${cols}
                    <td style="font-weight:bold; background:${bgFinal}; color:${corFinal};">${final}</td>
                    <td>${msgFalta}</td>
                    <td>${status}</td>
                </tr>`;
            });
            t.innerHTML = htmlBuffer;
        }

        
        // BLOOM (Taxonomia) — nível alvo + verbos sugeridos (Cronograma e Plano Semanal)
        const __BLOOM_VERBOS = {
          "Lembrar": ["identificar","listar","reconhecer","definir","nomear","localizar","selecionar","relacionar"],
          "Compreender": ["explicar","resumir","interpretar","parafrasear","exemplificar","descrever","classificar","recontar"],
          "Aplicar": ["aplicar","usar","executar","resolver","produzir","demonstrar","empregar","praticar"],
          "Analisar": ["comparar","relacionar","inferir","diferenciar","examinar","decompor","identificar padrões","organizar evidências"],
          "Avaliar": ["avaliar","justificar","argumentar","criticar","defender","julgar","validar","recomendar"],
          "Criar": ["planejar","elaborar","produzir","escrever","propor","criar","desenhar","construir"]
        };

        function __getBloomVerbos(nivel){
          nivel = (nivel || "").trim();
          return __BLOOM_VERBOS[nivel] || [];
        }

        function __fillBloomDatalist(nivel, dlId){
          const dl = document.getElementById(dlId);
          if(!dl) return;
          const verbs = __getBloomVerbos(nivel);
          dl.innerHTML = (verbs || []).map(v => `<option value="${v}"></option>`).join("");
        }

        function onBloomNivelChangeCrono(){
          const nivel = document.getElementById('inputBloomNivel')?.value || "";
          __fillBloomDatalist(nivel, 'dlBloomVerbosCrono');
        }

        function onBloomNivelChangePlano(n){
          const nivel = document.getElementById(`pl_aula${n}_bloomNivel`)?.value || "";
          __fillBloomDatalist(nivel, `dlBloomVerbosPlano${n}`);
        }

        function __initBloomUI(){
          try{ if(document.getElementById('inputBloomNivel')) onBloomNivelChangeCrono(); }catch(e){}
          [1,2,3,4,5,6,7].forEach(n=>{
            try{ if(document.getElementById(`pl_aula${n}_bloomNivel`)) onBloomNivelChangePlano(n); }catch(e){}
          });
        }

// AULAS E CALENDÁRIO
        function renderizarAulas(){
            const d=document.getElementById('listaDeAulas'); 
            const l=aulas.filter(a=>a.turma===filtroTurma&&a.bimestre===bimestreAtual); 
            let c=0; 
            if(l.length===0) { d.innerHTML='<div style="padding:20px;text-align:center;color:#94a3b8;">Vazio</div>'; return; }
            
            let htmlBuffer = '';
            l.forEach(a=>{
                if(a.status)c++; 
                const bnccHtml = a.bncc ? `<span class="badge-bncc" title="Habilidade BNCC">${__u(a.bncc)}</span>` : '';
                const bloomHtml = a.bloomNivel ? `<span class="badge-bloom" title="Bloom: ${escHTML(a.bloomNivel)}${a.bloomVerbo? ' • Verbo: '+escHTML(a.bloomVerbo):''}">${escHTML(a.bloomNivel)}</span>` : '';
                htmlBuffer+=`<div class="aula-item">
                    <input type="checkbox" class="aula-check" ${a.status?'checked':''} data-onchange="toggleAula(${__u(a.id)},this.checked)">
                    <div class="aula-tema ${a.status?'concluida':''}">
                        ${bnccHtml}
                        ${bloomHtml}
                        ${__u(a.tema)}
                    </div>
                    <input type="date" class="aula-data" value="${a.data||''}" data-onchange="updateDataAula(${__u(a.id)},this.value)" style="margin-left:auto;">
                    <button data-onclick="excluirAula(${__u(a.id)})" style="margin-left:10px;border:none;background:none;color:red;cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>`; 
            }); 
            d.innerHTML = htmlBuffer;
            const p=l.length>0?Math.round((c/l.length)*100):0; 
            document.getElementById('progressBarAulas').style.width=p+'%'; 
            document.getElementById('progressTextAulas').innerText=p+'%';
        }
        function toggleAula(id,v){const a=aulas.find(x=>x.id===id); if(a){a.status=v;salvarDadosLocal();renderizarAulas();}}
        function updateDataAula(id,v){const a=aulas.find(x=>x.id===id); if(a){a.data=v;salvarDadosLocal();}}
        
        // --- CRONOGRAMA: Aplicar BNCC + Tema em múltiplas turmas (modo geral) ---
        let aulaTurmasSelecionadas = [];

        function toggleAulaModoGeral(on){
            const list = document.getElementById('aulaTurmasChecklist');
            if(!list) return;
            const acts = document.getElementById('aulaTurmasActions');
            if(acts) acts.style.display = on ? 'flex' : 'none';
            list.style.display = on ? 'block' : 'none';
            if(on) renderAulaTurmasChecklist();
            updateAulaAplicarStatus();
        }

        function renderAulaTurmasChecklist(){
            const list = document.getElementById('aulaTurmasChecklist');
            if(!list) return;

            // Remove seleções que não existem mais
            aulaTurmasSelecionadas = aulaTurmasSelecionadas.filter(t => turmas.includes(t));

            if(turmas.length === 0){
                list.innerHTML = '<div style="padding:8px; color:var(--text-muted); font-size:12px;">Nenhuma turma cadastrada.</div>';
                updateAulaAplicarStatus();
                return;
            }

            let buf = '';
            turmas.forEach(t => {
                const enc = encodeURIComponent(t);
                const checked = aulaTurmasSelecionadas.includes(t) ? 'checked' : '';
                buf += `
                    <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--border-color); border-radius:10px; background:var(--bg-body);">
                        <input type="checkbox" class="aula-turma-check" data-turma="${enc}" ${checked} data-onchange="toggleTurmaAulaGeral(this)">
                        <span style="font-size:13px;">${escHTML(t)}</span>
                    </label>`;
            });

            list.innerHTML = `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px;">${buf}</div>`;
            updateAulaAplicarStatus();
        }

        function toggleTurmaAulaGeral(cb){
            const turma = decodeURIComponent(cb.getAttribute('data-turma') || '');
            if(!turma) return;

            if(cb.checked){
                if(!aulaTurmasSelecionadas.includes(turma)) aulaTurmasSelecionadas.push(turma);
            } else {
                aulaTurmasSelecionadas = aulaTurmasSelecionadas.filter(x => x !== turma);
            }
            updateAulaAplicarStatus();
        }

        function aulaSelecionarTodasTurmas(){
            aulaTurmasSelecionadas = turmas.slice();
            renderAulaTurmasChecklist();
        }

        function aulaLimparSelecaoTurmas(){
            aulaTurmasSelecionadas = [];
            renderAulaTurmasChecklist();
        }

        function getTurmasSelecionadasAulas(){
            return aulaTurmasSelecionadas.slice();
        }

        function updateAulaAplicarStatus(){
            const status = document.getElementById('aulaAplicarStatus');
            const on = document.getElementById('aulaModoGeral')?.checked;
            if(!status) return;

            if(!on){ status.innerText = ''; return; }

            if(aulaTurmasSelecionadas.length === 0){
                status.innerText = 'Selecione pelo menos 1 turma para aplicar.';
            } else {
                status.innerText = `Aplicar em: ${__u(aulaTurmasSelecionadas.length)} turma(s).`;
            }
        }

function addAulaIndividual(){
            const t = (document.getElementById('inputNovaAula').value || '').trim(); 
            const b = (document.getElementById('inputBNCC').value || '').trim();
            const bloomNivel = (document.getElementById('inputBloomNivel')?.value || '').trim();
            const bloomVerbo = (document.getElementById('inputBloomVerbo')?.value || '').trim();
            const geral = document.getElementById('aulaModoGeral')?.checked;

            if(!t) return showToast("Preencha Tema", "error");

            // Modo geral: aplica a mesma aula (BNCC + Tema) em múltiplas turmas
            if(geral){
                const sel = getTurmasSelecionadasAulas();
                if(!sel || sel.length === 0) return showToast("Selecione Turma", "error");

                sel.forEach(tr => {
                    aulas.push({id:__newId(),turma:tr,bimestre:bimestreAtual,tema:t, bncc:b, bloomNivel:bloomNivel, bloomVerbo:bloomVerbo, status:false,data:"", tipo:'aula'});
                });

                salvarDadosLocal();
                renderizarAulas();
                document.getElementById('inputNovaAula').value='';
                document.getElementById('inputBNCC').value='';
                return showToast(`Aula adicionada em ${__u(sel.length)} turma(s)`, "success");
            }

            // Modo tradicional: somente turma selecionada no filtro
            if(filtroTurma!=='Todas'){
                aulas.push({id:__newId(),turma:filtroTurma,bimestre:bimestreAtual,tema:t, bncc:b, bloomNivel:bloomNivel, bloomVerbo:bloomVerbo, status:false,data:"", tipo:'aula'});
                salvarDadosLocal();
                renderizarAulas();
                document.getElementById('inputNovaAula').value='';
                document.getElementById('inputBNCC').value='';
            }else showToast("Selecione Turma", "error");
        }

        function excluirAula(id){aulas=aulas.filter(x=>x.id!==id);salvarDadosLocal();renderizarAulas();}
        function salvarAulasLote(){
            const tx = (document.getElementById('inputAulasLote').value || '');
            const geral = document.getElementById('aulaModoGeral')?.checked;

            const linhas = tx.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            if(linhas.length === 0) return showToast("Preencha as aulas", "error");

            // Modo geral: aplica as aulas em múltiplas turmas
            if(geral){
                const sel = getTurmasSelecionadasAulas();
                if(!sel || sel.length === 0) return showToast("Selecione Turma", "error");

                sel.forEach(tr => {
                    linhas.forEach(l => {
                        aulas.push({id:__newId(),turma:tr,bimestre:bimestreAtual,tema:l, bncc:'', status:false,data:"", tipo:'aula'});
                    });
                });

                salvarDadosLocal();
                fecharModais();
                renderizarAulas();
                return showToast(`Aulas adicionadas em ${__u(sel.length)} turma(s)`, "success");
            }

            // Modo tradicional: somente turma selecionada no filtro
            if(filtroTurma!=='Todas'){
                linhas.forEach(l => {
                    aulas.push({id:__newId(),turma:filtroTurma,bimestre:bimestreAtual,tema:l, bncc:'', status:false,data:"", tipo:'aula'});
                });
                salvarDadosLocal();
                fecharModais();
                renderizarAulas();
            }else showToast("Selecione Turma", "error");
        }
        function mudarMes(d){currMes+=d;if(currMes>11){currMes=0;currAno++;}if(currMes<0){currMes=11;currAno--;}renderizarCalendario();}
        function renderizarCalendario(){
            const mN=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]; document.getElementById('lblMesAno').innerText=`${mN[currMes]} ${currAno}`; const g=document.getElementById('calendarGrid'); 
            let htmlBuffer = '';
            ["D","S","T","Q","Q","S","S"].forEach(d=>htmlBuffer+=`<div style="text-align:center;font-weight:bold;">${d}</div>`);
            
            const fd=new Date(currAno,currMes,1).getDay(); const dim=new Date(currAno,currMes+1,0).getDate(); const t=new Date();
            for(let i=0;i<fd;i++)htmlBuffer+=`<div></div>`;

            // Build planner tasks lookup by date
            const plannerByDate={};
            try{
              (plannerTasks||[]).forEach(tk=>{
                if(!tk.date) return;
                if(!plannerByDate[tk.date]) plannerByDate[tk.date]=[];
                plannerByDate[tk.date].push(tk);
              });
            }catch(_){}

            // Build frequency lookup by date
            const freqByDate={};
            try{
              const freq=window.__sgpFrequencia||{};
              Object.keys(freq).forEach(key=>{
                const p=key.split('|');
                if(filtroTurma!=='Todas' && p[0]!==filtroTurma) return;
                const dt=p[2]; if(!dt) return;
                const reg=freq[key]||{};
                let countP=0,countF=0;
                Object.keys(reg).forEach(k=>{ if(k==='_meta') return; if(reg[k]==='P') countP++; else if(reg[k]==='F') countF++; });
                if(countP+countF>0) freqByDate[dt]={P:countP,F:countF,turma:p[0]};
              });
            }catch(_){}

            // Build registro de aula lookup
            const registroByDate={};
            try{
              const freq=window.__sgpFrequencia||{};
              Object.keys(freq).forEach(key=>{
                const p=key.split('|');
                if(filtroTurma!=='Todas' && p[0]!==filtroTurma) return;
                const meta=(freq[key]||{})._meta;
                if(meta && meta.registroAula) registroByDate[p[2]]=meta.registroAula;
              });
            }catch(_){}
            
            for(let d=1;d<=dim;d++){
                const dt=`${currAno}-${String(currMes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const evs=aulas.filter(a=>a.data===dt);
                let h=''; 

                // Aulas/eventos
                evs.forEach(e=>{
                    let cClass = 'evt-aula';
                    if(e.tipo === 'prova') cClass = 'evt-prova';
                    if(e.tipo === 'atividade') cClass = 'evt-atividade';
                    h+=`<div class="cal-event ${cClass}" data-onclick="excluirEventoCal(${__u(e.id)}, event)" title="${_escHTML(e.tema||'')}">${__u(e.turma?e.turma+': ':'')}${__u(e.tema)}</div>`
                });

                // Planner tasks
                const pTasks=plannerByDate[dt]||[];
                pTasks.forEach(tk=>{
                    const isDone=tk.status==='done';
                    const icon=isDone?'✓':'📋';
                    h+=`<div class="cal-event evt-planner ${isDone?'done':''}" onclick="try{abrirPlanner();}catch(e){}" title="${_escHTML(tk.title||'')}">${icon} ${_escHTML((tk.title||'').substring(0,20))}</div>`;
                });

                // Frequency indicator
                const fr=freqByDate[dt];
                if(fr){
                    h+=`<div class="cal-event evt-freq" title="Chamada: ${fr.P}P ${fr.F}F${fr.turma?' — '+fr.turma:''}">📝 ${fr.P}P ${fr.F}F</div>`;
                }

                const cl=(d===t.getDate()&&currMes===t.getMonth()&&currAno===t.getFullYear())?'cal-today':'';
                htmlBuffer+=`<div class="cal-day ${cl}" data-date="${dt}" data-onclick="abrirModalEvento('${dt}')"><span class="cal-number">${d}</span>${h}</div>`;
            }
            g.innerHTML = htmlBuffer;
        }
        function abrirModalEvento(dt) {
            if(filtroTurma === 'Todas') return showToast("Selecione uma turma.", "error");
            document.getElementById('inputDataCal').value = dt;
            document.getElementById('inputDescEvento').value = '';
            abrirModal('modalEventoCal');
        }
        function salvarEventoCal() {
            const dt = document.getElementById('inputDataCal').value;
            const desc = document.getElementById('inputDescEvento').value;
            const tipo = document.getElementById('inputTipoEvento').value;
            if(desc && filtroTurma !== 'Todas') {
                aulas.push({id:Date.now(), turma:filtroTurma, bimestre:bimestreAtual, tema:desc, bncc:'', status:false, data:dt, tipo:tipo});
                salvarDadosLocal();
                fecharModais();
                renderizarCalendario();
                if(visaoAtual === 'aulas') renderizarAulas();
            } else {
                showToast("Preencha a descrição.", "error");
            }
        }
        function excluirEventoCal(id, e) {
            e.stopPropagation();
            if(confirm("Excluir este evento do calendário?")) {
                excluirAula(id);
                renderizarCalendario();
            }
        }

        let __dashChartBim = null;

        function renderizarDashboard(){
            ensureConfigSchema();
            const lista = getAlunosFiltrados();
            const total = lista.length;

            const elTotal = document.getElementById('dashTotal');
            if(elTotal) elTotal.innerText = total;

            // Distribuição por farol (bimestre atual)
            const c1 = {verde:0, amarelo:0, vermelho:0};
            const c2 = {verde:0, amarelo:0, vermelho:0};

            const cat = (m)=> (m>=7 ? 'verde' : (m>=5 ? 'amarelo' : 'vermelho'));

            lista.forEach(a=>{
                const b = a?.bimestres?.[bimestreAtual];
                if(!b) return;
                _syncBimestreRefs(b);

                const m1 = clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
                const m2 = clampNota(calcularMediaDisc(config.slot2, b.notas_red));

                c1[cat(m1)]++;
                c2[cat(m2)]++;
            });

            const pct = (n)=> total ? (n/total*100) : 0;

            const setBar = (barId, txtId, val) => {
                const bar = document.getElementById(barId);
                const txt = document.getElementById(txtId);
                const p = val.toFixed(0);
                if(bar) bar.style.width = `${p}%`;
                if(txt) txt.innerText = `${p}%`;
            };

            setBar('barLpVerde','txtLpVerde', pct(c1.verde));
            setBar('barLpAma','txtLpAma', pct(c1.amarelo));
            setBar('barLpVerm','txtLpVerm', pct(c1.vermelho));
            setBar('barRedVerde','txtRedVerde', pct(c2.verde));
            setBar('barRedAma','txtRedAma', pct(c2.amarelo));
            setBar('barRedVerm','txtRedVerm', pct(c2.vermelho));

            // Gráfico (médias da turma por bimestre)
            const canvas = document.getElementById('dashChartBimestres');
            if(!canvas) return;

            // Se Chart.js não carregar, evita quebrar a tela
            if(typeof Chart === 'undefined'){
                canvas.replaceWith(canvas.cloneNode(true));
                return;
            }

            const labels = ['1º Bim','2º Bim','3º Bim','4º Bim'];
            const data1 = [], data2 = [];

            [1,2,3,4].forEach(bim=>{
                let s1=0, n1=0, s2=0, n2=0;
                lista.forEach(a=>{
                    const b = a?.bimestres?.[bim];
                    if(!b) return;
                    _syncBimestreRefs(b);

                    const m1 = clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
                    const m2 = clampNota(calcularMediaDisc(config.slot2, b.notas_red));

                    s1 += m1; n1++;
                    s2 += m2; n2++;
                });
                data1.push(n1 ? +(s1/n1).toFixed(2) : 0);
                data2.push(n2 ? +(s2/n2).toFixed(2) : 0);
            });

            const lbl1 = getDiscById(config.slot1)?.nome || 'Matéria 1';
            const lbl2 = getDiscById(config.slot2)?.nome || 'Matéria 2';

            // Cores a partir do tema
            const rootStyle = getComputedStyle(document.documentElement);
            const col1 = (rootStyle.getPropertyValue('--primary') || '#2563eb').trim();
            const col2 = '#ec4899';

            if(typeof Chart !== 'function'){
                try{ if(typeof showToast==='function') showToast('Gráficos indisponíveis (Chart.js não carregou).', 'warning'); }catch(_){ }
                try{ canvas.style.display='none'; const msg=document.createElement('div'); msg.className='muted'; msg.style.cssText='padding:8px; color:#64748b; font-size:0.9rem;'; msg.textContent='Gráficos indisponíveis offline.'; canvas.parentElement && canvas.parentElement.appendChild(msg); }catch(_){ }
                return;
            }

            if(__dashChartBim) __dashChartBim.destroy();
            __dashChartBim = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: lbl1, data: data1, tension: 0.25, borderColor: col1, backgroundColor: col1, pointRadius: 3 },
                        { label: lbl2, data: data2, tension: 0.25, borderColor: col2, backgroundColor: col2, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { min: 0, max: 10, ticks: { stepSize: 1 } }
                    }
                }
            });
        
            try{ renderDashCompareTurmas(); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'dash.compare'); }catch(_){} }
}
        

        // DASH: Comparar turmas (média, distribuição e ranking por atividade)
let __cmpTurmasCache = { key:'', res:null, agg:null };

function __cmpLastCoreSave(){
    try{ return parseInt(localStorage.getItem('sgp_last_core_save')||'0',10) || 0; }catch(_){ return 0; }
}
function __cmpMakeKey(bim, discId, metric){
    return [bim, String(discId||''), String(metric||''), __cmpLastCoreSave()].join('|');
}
function __cmpInferTouched(notas, disc){
    try{
        if(!notas || typeof notas !== 'object') return false;
        if(notas.__touched) return true;
        // Heurística (dados antigos): se existir qualquer nota > 0, considera preenchido
        for(const av of (disc?.avaliacoes||[])){
            const n = clampNota(notas?.[av.id]);
            if(n > 0) return true;
        }
        try{ if(clampNota(notas?.['rec']) > 0) return true; }catch(_){}
        return false;
    }catch(_){ return false; }
}
function __cmpIsDiscEmpty(notas, disc){
    try{
        if(!notas || typeof notas !== 'object') return true;
        for(const av of (disc?.avaliacoes||[])){
            const raw = notas[av.id];
            if(raw === null || typeof raw === 'undefined') continue;
            if(typeof raw === 'string' && raw.trim()==='') continue;
            const n = clampNota(raw);
            if(n !== 0) return false;
        }
        const rec = notas['rec'];
        if(!(rec===null || typeof rec==='undefined' || (typeof rec==='string' && rec.trim()===''))){
            if(clampNota(rec) !== 0) return false;
        }
        return true;
    }catch(_){ return true; }
}
function __cmpPercentile(sorted, p){
    const n = sorted.length;
    if(!n) return 0;
    if(n===1) return sorted[0];
    const idx = (n-1)*p;
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if(lo===hi) return sorted[lo];
    const w = idx - lo;
    return sorted[lo]*(1-w) + sorted[hi]*w;
}
function __cmpCalcPercentiles(values){
    const arr = (values||[]).slice().sort((a,b)=>a-b);
    const p25 = __cmpPercentile(arr, 0.25);
    const p50 = __cmpPercentile(arr, 0.50);
    const p75 = __cmpPercentile(arr, 0.75);
    let lt4=0, ge9=0;
    arr.forEach(v=>{ if(v < 4) lt4++; if(v >= 9) ge9++; });
    const tot = arr.length||1;
    return { p25, p50, p75, lt4: lt4/tot*100, ge9: ge9/tot*100 };
}
function __cmpBinIndex(v){
    const n = clampNota(v);
    if(n < 2) return 0;
    if(n < 4) return 1;
    if(n < 6) return 2;
    if(n < 8) return 3;
    return 4;
}
        function __cmpTurmasEnsureUI(){
            const card = document.getElementById('dashCompareTurmas');
            if(!card) return false;
            if(card.dataset.init === '1') return true;

            const selBim = document.getElementById('cmpTurmasBim');
            const selDisc = document.getElementById('cmpTurmasDisc');
            const selMetric = document.getElementById('cmpTurmasMetric');
            const btn = document.getElementById('btnCmpTurmasAtualizar');

            if(!selBim || !selDisc || !selMetric) return false;

            // Bimestres 1..4
            selBim.innerHTML = '';
            [1,2,3,4].forEach(n=>{
                const o=document.createElement('option');
                o.value=String(n);
                o.textContent = n+'º';
                selBim.appendChild(o);
            });
            selBim.value = String(bimestreAtual || 1);

            // Disciplinas
            ensureConfigSchema();
            selDisc.innerHTML = '';
            (config.disciplinas||[]).forEach(d=>{
                const o=document.createElement('option');
                o.value=d.id;
                o.textContent = d.nome || d.id;
                selDisc.appendChild(o);
            });
            selDisc.value = String(config.slot1 || (config.disciplinas?.[0]?.id||''));

            const updateMetric = ()=>{
                const discId = selDisc.value;
                const disc = getDiscById(discId);
                selMetric.innerHTML = '';

                const o0=document.createElement('option');
                o0.value='__media__';
                o0.textContent='Média do bimestre';
                selMetric.appendChild(o0);

                (disc?.avaliacoes||[]).forEach(av=>{
                    const o=document.createElement('option');
                    o.value=av.id;
                    o.textContent=av.nome || av.id;
                    selMetric.appendChild(o);
                });

                // Mantém seleção se possível
                if(!selMetric.value) selMetric.value='__media__';
            };

            selDisc.addEventListener('change', ()=>{ updateMetric(); renderDashCompareTurmas(true); });
            selBim.addEventListener('change', ()=>{ renderDashCompareTurmas(true); });
            selMetric.addEventListener('change', ()=>{ renderDashCompareTurmas(true); });

            if(btn){
                btn.addEventListener('click', ()=> renderDashCompareTurmas(true));
            }

            updateMetric();
            card.dataset.init = '1';
            return true;
        }

        function renderDashCompareTurmas(force){
    const ok = __cmpTurmasEnsureUI();
    if(!ok) return;

    const selBim = document.getElementById('cmpTurmasBim');
    const selDisc = document.getElementById('cmpTurmasDisc');
    const selMetric = document.getElementById('cmpTurmasMetric');
    const tbody = document.getElementById('cmpTurmasTbody');
    const summary = document.getElementById('cmpTurmasSummary');

    if(!selBim || !selDisc || !selMetric || !tbody) return;

    ensureConfigSchema();

    const bim = parseInt(selBim.value || bimestreAtual || 1, 10) || 1;
    const discId = selDisc.value || config.slot1;
    const metric = selMetric.value || '__media__';

    const disc = getDiscById(discId);
    if(!disc){
        tbody.innerHTML = '';
        if(summary) summary.textContent = 'Disciplina não encontrada.';
        return;
    }

    const cacheKey = (typeof __cmpMakeKey==='function') ? __cmpMakeKey(bim, discId, metric) : '';
    let res = null, agg = null;

    if(!force && __cmpTurmasCache && __cmpTurmasCache.key === cacheKey && Array.isArray(__cmpTurmasCache.res)){
        res = __cmpTurmasCache.res;
        agg = __cmpTurmasCache.agg;
    }else{
        const cat = (m)=> (m>=7 ? 'verde' : (m>=5 ? 'amarelo' : 'vermelho'));
        const alunosByTurma = new Map();
        (alunos||[]).forEach(a=>{
            const t = a?.turma;
            if(typeof t === 'undefined' || t === null) return;
            if(!alunosByTurma.has(t)) alunosByTurma.set(t, []);
            alunosByTurma.get(t).push(a);
        });

        res = [];
        let totalSum = 0, totalCnt = 0;

        (turmas||[]).forEach(t=>{
            const lst = alunosByTurma.get(t) || [];
            const total = lst.length;

            let sum=0, cnt=0;
            let semBim=0, semNota=0;
            const dist = {verde:0, amarelo:0, vermelho:0};
            const bins = [0,0,0,0,0];
            const vals = [];

            lst.forEach(a=>{
                const b = a?.bimestres?.[bim];
                if(!b){ semBim++; return; }

                // Mantém compatibilidade com o sistema (refs/migração)
                try{ _syncBimestreRefs(b); }catch(_){}

                const notasDisc = (b.notas_disc && typeof b.notas_disc === 'object') ? b.notas_disc[discId] : null;
                if(!notasDisc || typeof notasDisc !== 'object'){ semNota++; return; }

                const touched = (typeof __cmpInferTouched==='function') ? __cmpInferTouched(notasDisc, disc) : false;
                const empty = (typeof __cmpIsDiscEmpty==='function') ? __cmpIsDiscEmpty(notasDisc, disc) : false;

                // Regra: se está "vazio" e nunca foi tocado, não entra na comparação (evita 0 padrão distorcer)
                if(empty && !touched){ semNota++; return; }

                let v=0;
                if(metric==='__media__'){
                    v = clampNota(calcularMediaDisc(discId, notasDisc));
                }else{
                    const raw = notasDisc[metric];
                    if(raw === null || typeof raw === 'undefined' || (typeof raw === 'string' && raw.trim()==='')){
                        semNota++; return;
                    }
                    v = clampNota(raw);
                }

                sum += v;
                cnt += 1;
                totalSum += v;
                totalCnt += 1;

                dist[cat(v)]++;
                const bi = (typeof __cmpBinIndex==='function') ? __cmpBinIndex(v) : 0;
                bins[bi] = (bins[bi]||0) + 1;
                vals.push(v);
            });

            const avg = cnt ? (sum/cnt) : NaN;
            const pct = cnt ? ((typeof __cmpCalcPercentiles==='function') ? __cmpCalcPercentiles(vals) : null) : null;

            res.push({
                turma: t,
                total,
                valid: cnt,
                semBim,
                semNota,
                media: avg,
                dist,
                bins,
                pct
            });
        });

        // Ranking (maior média primeiro; turmas sem dados vão para o fim)
        res.sort((a,b)=> {
            const am = (a.valid ? a.media : -1);
            const bm = (b.valid ? b.media : -1);
            return (bm - am) || String(a.turma).localeCompare(String(b.turma),'pt-BR');
        });

        // Agregados para o resumo
        const comDados = res.filter(x=>x.valid>0);
        const top = comDados.length ? comDados[0] : null;
        const bottom = comDados.length ? comDados[comDados.length-1] : null;

        agg = {
            totalSum, totalCnt,
            semDadosTurmas: res.filter(x=>x.valid===0).length,
            top, bottom
        };

        if(cacheKey){
            __cmpTurmasCache = { key: cacheKey, res, agg };
        }
    }

    const fmt1 = (n)=> (Math.round((n||0)*10)/10).toFixed(1);

    // Resumo
    if(summary){
        if(!res || res.length===0){
            summary.textContent = 'Nenhuma turma cadastrada.';
        }else{
            const labelMetric = (metric==='__media__')
                ? 'Média do bimestre'
                : (disc.avaliacoes||[]).find(a=>a.id===metric)?.nome || metric;

            const mediaGeral = (agg && agg.totalCnt) ? (agg.totalSum/agg.totalCnt) : 0;

            const extra = (agg && agg.semDadosTurmas)
                ? ` · <span class="cmp-badge">${agg.semDadosTurmas}</span> turma(s) sem dados nesta métrica`
                : '';

            const bestTxt = (agg && agg.top) ? ` · Melhor <span class="cmp-badge">${__u(agg.top.turma)} (${fmt1(agg.top.media)})</span>` : '';
            const worstTxt = (agg && agg.bottom) ? ` · Pior <span class="cmp-badge">${__u(agg.bottom.turma)} (${fmt1(agg.bottom.media)})</span>` : '';

            summary.innerHTML =
                `Bimestre <span class="cmp-badge">${bim}º</span> · Disciplina <span class="cmp-badge">${__u(disc.nome||disc.id)}</span> · Métrica <span class="cmp-badge">${__u(labelMetric)}</span> · Média geral <span class="cmp-badge">${fmt1(mediaGeral)}</span>${bestTxt}${worstTxt}${extra}`
                + `<div class="cmp-mini-meta" style="margin-top:6px;">`+
                  `Obs.: Média/distribuição usam apenas <span class="cmp-k">notas preenchidas</span>. Alunos sem nota (ou sem bimestre) são excluídos da média e sinalizados na linha.</div>`;
        }
    }

    const bar = (r)=>{
        const valid = r.valid || 0;
        const total = r.total || 0;

        // Farol (3 faixas)
        const pv = valid ? (r.dist.verde/valid*100) : 0;
        const pa = valid ? (r.dist.amarelo/valid*100) : 0;
        const pr = valid ? (r.dist.vermelho/valid*100) : 0;

        // Bins (0-2,2-4,4-6,6-8,8-10)
        const p0 = valid ? (r.bins[0]/valid*100) : 0;
        const p1 = valid ? (r.bins[1]/valid*100) : 0;
        const p2 = valid ? (r.bins[2]/valid*100) : 0;
        const p3 = valid ? (r.bins[3]/valid*100) : 0;
        const p4 = valid ? (r.bins[4]/valid*100) : 0;

        const pct = r.pct;
        const meta = valid
            ? `P25 ${fmt1(pct?.p25||0)} · P50 ${fmt1(pct?.p50||0)} · P75 ${fmt1(pct?.p75||0)} · <4 ${((pct?.lt4||0)).toFixed(0)}% · ≥9 ${((pct?.ge9||0)).toFixed(0)}%`
            : `Sem dados para esta métrica`;

        const missNota = r.semNota || 0;
        const missBim = r.semBim || 0;

        const missTxt = (missNota || missBim)
            ? ` · Sem nota: ${missNota}${missBim ? ` · Sem bimestre: ${missBim}` : ''}`
            : '';

        return `<div style="display:flex; flex-direction:column; gap:6px; min-width:340px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="cmp-bar" title="Farol — Verde ${pv.toFixed(0)}% · Amarelo ${pa.toFixed(0)}% · Vermelho ${pr.toFixed(0)}%">
                    <span style="width:${pv}%; background:var(--farol-verde);"></span>
                    <span style="width:${pa}%; background:var(--farol-amarelo);"></span>
                    <span style="width:${pr}%; background:var(--farol-vermelho);"></span>
                </div>
                <span style="font-size:0.8rem; color:#64748b;">${valid ? `${pv.toFixed(0)}% · ${pa.toFixed(0)}% · ${pr.toFixed(0)}%` : '—'}</span>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="cmp-bar cmp-bins" title="Faixas — 0–2 ${p0.toFixed(0)}% · 2–4 ${p1.toFixed(0)}% · 4–6 ${p2.toFixed(0)}% · 6–8 ${p3.toFixed(0)}% · 8–10 ${p4.toFixed(0)}%">
                    <span style="width:${p0}%;"></span>
                    <span style="width:${p1}%;"></span>
                    <span style="width:${p2}%;"></span>
                    <span style="width:${p3}%;"></span>
                    <span style="width:${p4}%;"></span>
                </div>
                <span style="font-size:0.8rem; color:#64748b;">${valid ? `${p0.toFixed(0)}·${p1.toFixed(0)}·${p2.toFixed(0)}·${p3.toFixed(0)}·${p4.toFixed(0)}%` : '—'}</span>
            </div>
            <div class="cmp-mini-meta">${meta} · <span class="cmp-k">Válidas</span> ${valid}/${total}${missTxt}</div>
        </div>`;
    };

    let html='';
    (res||[]).forEach((r, i)=>{
        const mediaTxt = (r.valid ? fmt1(r.media) : '—');
        html += `<tr>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border-color); color:#64748b;">${i+1}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border-color); font-weight:600;">${__u(r.turma)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border-color); text-align:right;">${r.total}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border-color); text-align:right; font-variant-numeric: tabular-nums;">${mediaTxt}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border-color);">${bar(r)}</td>
        </tr>`;
    });
    tbody.innerHTML = html || `<tr><td colspan="5" style="padding:14px; color:#64748b;">Sem dados para comparar.</td></tr>`;
}

        // MAPA
        function _mapaNomeCurto(nome){
            nome = (nome||'').toString().trim();
            if(!nome) return '';
            const parts = nome.split(/\s+/).filter(Boolean);
            if(parts.length===1) return parts[0];
            const stop = new Set(['DE','DA','DO','DOS','DAS','E']);
            let sobrenome = '';
            for(let i=parts.length-1;i>=0;i--){
                const p = parts[i] || '';
                if(!stop.has(p.toUpperCase())) { sobrenome = p; break; }
            }
            if(!sobrenome) sobrenome = parts[parts.length-1] || '';
            const ini = (sobrenome.trim()[0]||'').toUpperCase();
            return ini ? `${parts[0]} ${ini}.` : parts[0];
        }
        function _mapaTotalMesas(){
            try{
                return (typeof mapaGridCols==='number' && typeof mapaGridRows==='number') ? (mapaGridCols*mapaGridRows) : 36;
            }catch(_){ return 36; }
        }
        function _mapaSeatValida(i){
            const total=_mapaTotalMesas();
            const n=parseInt(i,10);
            if(!Number.isFinite(n)) return false;
            if(n<0 || n>=total) return false;
            try{ if(typeof mapaDisabledDesks!=='undefined' && mapaDisabledDesks && mapaDisabledDesks.has(n)) return false; }catch(_){}
            return true;
        }
        function _mapaMoverParaMesaSemConflito(aluno, destino){
            const alvo=parseInt(destino,10);
            if(!Number.isFinite(alvo)){ aluno.mesa=null; return; }

            // Se já existe outro aluno na mesa destino, faz swap (ou manda o outro para "livres")
            const outro = alunos.find(x=>x && x.id!==aluno.id && x.mesa===alvo);
            if(outro){
                if(_mapaSeatValida(aluno.mesa)) outro.mesa = aluno.mesa;
                else outro.mesa = null;
            }

            aluno.mesa = _mapaSeatValida(alvo) ? alvo : null;
        }

        function gerarMesas(){const g=document.getElementById('salaGrid');g.innerHTML='';for(let i=0;i<36;i++)g.innerHTML+=`<div id="mesa_${i}" class="mesa" ondrop="drop(event,${i})" ondragover="allowDrop(event)" data-onclick="touchSelectMesa(${i})"></div>`;}
        function renderizarMapa(){
            if(filtroTurma==='Todas')return; 
            const ls=getAlunosFiltrados(); 
            const lv=document.getElementById('listaAlunosLivres'); 
            lv.innerHTML=''; 
            
            document.querySelectorAll('.mesa').forEach(m=>{m.innerHTML='';m.style.borderStyle='dashed'; m.classList.remove('mobile-target');});
            
            ls.forEach(a=>{
                const c=getCorFarol(a.bimestres[bimestreAtual].media_lp); 
                const h=`<div id="drag_${__u(a.id)}" class="aluno-drag ${alunoSelecionadoParaMover===a.id ? 'mobile-selected' : ''}" draggable="true" ondragstart="drag(event)" data-onclick="touchSelectAluno(${__u(a.id)})" style="border-left-color:${c}">${_escHTML(_mapaNomeCurto(a.nome))}</div>`; 
                if(a.mesa!==null && a.mesa<36){
                    const m=document.getElementById('mesa_'+a.mesa); 
                    if(m){m.innerHTML=h;m.style.borderStyle='solid';}
                }else lv.innerHTML+=h;
            });

            if(alunoSelecionadoParaMover !== null) {
                document.querySelectorAll('.mesa').forEach(m => {
                    if(m.innerHTML === '') m.classList.add('mobile-target');
                });
            }
        }
        function drag(ev){ev.dataTransfer.setData("id",ev.target.id);} function allowDrop(ev){ev.preventDefault();} function drop(ev,d){
            ev.preventDefault();
            let id=ev.dataTransfer.getData("id");
            let a=alunos.find(x=>x.id==id.replace('drag_',''));
            if(a){
                _mapaMoverParaMesaSemConflito(a,d);
                salvarDadosLocal();
                renderizarMapa();
            }
        } function dropLivre(ev){ev.preventDefault();let id=ev.dataTransfer.getData("id");let a=alunos.find(x=>x.id==id.replace('drag_',''));if(a){a.mesa=null;salvarDadosLocal();renderizarMapa();}}

        function touchSelectAluno(id) {
            if(alunoSelecionadoParaMover === id) {
                alunoSelecionadoParaMover = null;
            } else {
                alunoSelecionadoParaMover = id;
            }
            renderizarMapa();
        }
        function touchSelectMesa(index) {
            if(alunoSelecionadoParaMover !== null) {
                const a = alunos.find(x => x.id === alunoSelecionadoParaMover);
                if(a) {
                    _mapaMoverParaMesaSemConflito(a,index);
                    alunoSelecionadoParaMover = null;
                    salvarDadosLocal();
                    renderizarMapa();
                }
            }
        }

        function salvarTurma(){const n=document.getElementById('inputNomeTurma').value;if(n&&!turmas.includes(n)){turmas.push(n);salvarDadosLocal();document.getElementById('inputNomeTurma').value='';fecharModais();selTurma(n); showToast("Turma criada!");}}
        function delTurma(n,e){e.stopPropagation();if(confirm("Excluir?")){turmas=turmas.filter(t=>t!==n);alunos=alunos.filter(a=>a.turma!==n);filtroTurma='Todas';salvarDadosLocal();renderizarMenu();renderizarVisaoContent(); showToast("Turma excluída.");}}
        function abrirModalAluno(){if(turmas.length===0)return showToast("Crie Turma", "error"); const s=document.getElementById('selectTurmaAluno');s.innerHTML='';turmas.forEach(t=>s.innerHTML+=`<option value="${_escHTML(t)}">${_escHTML(t)}</option>`);if(filtroTurma!=='Todas')s.value=filtroTurma;abrirModal('modalNovoAluno');}
        function salvarAlunos(){const t=document.getElementById('selectTurmaAluno').value, ns=document.getElementById('inputNomes').value.split('\n'); const dL=()=>({a1:0,a2:0,a3:0,a4:0,a5:0,rec:0}); const dR=()=>({r1:0,r2:0,leit:0}); ns.forEach(n=>{if(n.trim())alunos.push({id:__newId(),nome:n.trim(),turma:t,mesa:null,inteligencias:[],bimestres:{1:{notas_lp:dL(),media_lp:"0.0",notas_red:dR(),media_red:"0.0",entregas_red:{r1:'pendente',r2:'pendente'},livro:"",status_livro:"Pendente",comportamento:10,ocorrencias:[],parecer:""},2:{notas_lp:dL(),media_lp:"0.0",notas_red:dR(),media_red:"0.0",entregas_red:{r1:'pendente',r2:'pendente'},livro:"",status_livro:"Pendente",comportamento:10,ocorrencias:[],parecer:""},3:{notas_lp:dL(),media_lp:"0.0",notas_red:dR(),media_red:"0.0",entregas_red:{r1:'pendente',r2:'pendente'},livro:"",status_livro:"Pendente",comportamento:10,ocorrencias:[],parecer:""},4:{notas_lp:dL(),media_lp:"0.0",notas_red:dR(),media_red:"0.0",entregas_red:{r1:'pendente',r2:'pendente'},livro:"",status_livro:"Pendente",comportamento:10,ocorrencias:[],parecer:""}}})});salvarDadosLocal();document.getElementById('inputNomes').value='';fecharModais();selTurma(t); showToast("Alunos cadastrados!");}
        function delAluno(id){if(confirm("Excluir?")){alunos=alunos.filter(a=>a.id!==id);salvarDadosLocal();renderizarVisaoContent();}}
        function confirmarDelAluno(id){
            const a = alunos.find(al => al.id === id);
            const nomeCurto = a ? (a.nome || '').split(' ')[0] : 'este aluno';
            if(confirm(`Tem certeza que deseja excluir "${nomeCurto}"?\n\nEsta ação não pode ser desfeita.`)){
                alunos = alunos.filter(al => al.id !== id);
                salvarDadosLocal();
                showToast(`${nomeCurto} removido(a)`);
                renderizarVisaoContent();
            }
        }

        function mudarAba(aba){['btnTabLP','btnTabRED','btnTabPAEE','btnTabEVO'].forEach(i=>document.getElementById(i).classList.remove('active')); ['tabLP','tabRED','tabPAEE','tabEVO'].forEach(i=>document.getElementById(i).classList.remove('active')); if(aba==='lp'){document.getElementById('btnTabLP').classList.add('active');document.getElementById('tabLP').classList.add('active');} else if(aba==='red'){document.getElementById('btnTabRED').classList.add('active');document.getElementById('tabRED').classList.add('active');} else if(aba==='paee'){document.getElementById('btnTabPAEE').classList.add('active');document.getElementById('tabPAEE').classList.add('active');} else {document.getElementById('btnTabEVO').classList.add('active');document.getElementById('tabEVO').classList.add('active'); renderizarGraficoEvolucao();}}

        
/* (removido) Função duplicada antiga: abrirDetalhes */
let __evoChart = null;

        function renderizarGraficoEvolucao() {
            ensureConfigSchema();
            const a = alunos.find(al => al.id === alunoEdicaoID);
            if(!a) return;

            const c = document.getElementById('chartEvolucao');
            if(!c) return;

            // Se Chart.js não carregar, usa fallback simples (barras)
            if(typeof Chart === 'undefined'){
                c.innerHTML = '';
                [1, 2, 3, 4].forEach(bim => {
                    const d = a.bimestres?.[bim] || {};
                    _syncBimestreRefs(d);
                    const lp = clampNota(calcularMediaDisc(config.slot1, d.notas_lp));
                    const red = clampNota(calcularMediaDisc(config.slot2, d.notas_red));
                    const hLP = Math.min(lp * 10, 100);
                    const hRED = Math.min(red * 10, 100);
                    c.innerHTML += `<div class="chart-col col-lp"><div class="chart-bar" style="height:${hLP}%;" data-val="${lp.toFixed(1)}"></div><div class="chart-lbl">${bim}ºB</div></div><div class="chart-col col-red"><div class="chart-bar" style="height:${hRED}%;" data-val="${red.toFixed(1)}"></div></div>`;
                });
                return;
            }

            c.innerHTML = '<canvas id="chartEvolucaoCanvas"></canvas>';
            const ctx = document.getElementById('chartEvolucaoCanvas').getContext('2d');

            const labels = ['1º Bim','2º Bim','3º Bim','4º Bim'];
            const data1 = [];
            const data2 = [];

            [1, 2, 3, 4].forEach(bim => {
                const d = a.bimestres?.[bim] || {};
                _syncBimestreRefs(d);
                data1.push(clampNota(calcularMediaDisc(config.slot1, d.notas_lp)));
                data2.push(clampNota(calcularMediaDisc(config.slot2, d.notas_red)));
            });

            const lbl1 = getDiscById(config.slot1)?.nome || 'Matéria 1';
            const lbl2 = getDiscById(config.slot2)?.nome || 'Matéria 2';

            const rootStyle = getComputedStyle(document.documentElement);
            const col1 = (rootStyle.getPropertyValue('--primary') || '#2563eb').trim();
            const col2 = '#ec4899';

            if(typeof Chart !== 'function'){
                try{ if(typeof showToast==='function') showToast('Gráficos indisponíveis (Chart.js não carregou).', 'warning'); }catch(_){ }
                try{ const holder = document.getElementById('evoChart') ? document.getElementById('evoChart').parentElement : null; if(holder){ const msg=document.createElement('div'); msg.className='muted'; msg.style.cssText='padding:8px; color:#64748b; font-size:0.9rem;'; msg.textContent='Gráficos indisponíveis offline.'; holder.appendChild(msg);} }catch(_){ }
                return;
            }

            if(__evoChart) __evoChart.destroy();
            __evoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: lbl1, data: data1, tension: 0.25, borderColor: col1, backgroundColor: col1, pointRadius: 3 },
                        { label: lbl2, data: data2, tension: 0.25, borderColor: col2, backgroundColor: col2, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { min: 0, max: 10, ticks: { stepSize: 1 } }
                    }
                }
            });
        }


        
/* (removido) Função duplicada antiga: salvarAlteracoesDetalhadas */

/* (removido) Função duplicada antiga: calcularEmTempoReal */
function _ensureOcorrenciasSchema(b){
  if(!b) return;
  if(!Array.isArray(b.ocorrencias)) b.ocorrencias = [];
  // Migra itens antigos
  b.ocorrencias.forEach(o=>{
    if(typeof o !== 'object' || o===null) return;
    if(typeof o.ts !== 'number'){
      // tenta derivar ts de data textual, senão usa agora
      const parsed = o.data ? Date.parse(o.data) : NaN;
      o.ts = Number.isFinite(parsed) ? parsed : (typeof o.id === 'number' ? o.id : Date.now());
    }
    if(typeof o.id !== 'number') o.id = o.ts;
    if(typeof o.texto !== 'string') o.texto = String(o.texto ?? o.text ?? '').trim();
    if(typeof o.data !== 'string') o.data = new Date(o.ts).toLocaleString();
  });
}

function _getAlunoBimestreAtual(){
  const a = alunos.find(al => al.id === alunoEdicaoID);
  if(!a || !a.bimestres) return null;
  const b = a.bimestres[bimestreAtual];
  if(!b) return null;
  _ensureOcorrenciasSchema(b);
  return {a,b};
}

function renderizarOcorrencias(lista){
  const d = document.getElementById('listaOcorrencias');
  if(!d) return;
  const l = Array.isArray(lista) ? lista : [];
  if(l.length === 0){
    d.innerHTML = `<div style="font-size:0.85rem; color:#64748b;">Nenhuma ocorrência registrada.</div>`;
    return;
  }
  const sorted = [...l].sort((x,y)=> (y.ts||0) - (x.ts||0));
  d.innerHTML = sorted.map(o=>{
    const when = _escHTML(o.data || (o.ts ? new Date(o.ts).toLocaleString() : ''));
    const texto = _escHTML(o.texto ?? '');
    return `<div class="occ-item" style="position:relative; padding-right:32px;">
      <button class="occ-del" data-onclick="removerOcorrencia(${__u(o.id)})" title="Excluir ocorrência" aria-label="Excluir ocorrência">×</button>
      <strong>${when}</strong>: ${texto}
    </div>`;
  }).join('');
}

function addOcorrencia(){
  const ta = document.getElementById('inputNovaOcorrencia');
  if(!ta) return;
  const t = (ta.value || '').trim();
  if(!t){
    showToast("Digite uma ocorrência.", "info");
    return;
  }
  const ctx = _getAlunoBimestreAtual();
  if(!ctx) return;

  const now = Date.now();
  ctx.b.ocorrencias.push({ id: now, ts: now, data: new Date(now).toLocaleString(), texto: t });

  ta.value = '';
  salvarDadosLocal();
  renderizarOcorrencias(ctx.b.ocorrencias);
  showToast("Ocorrência registrada.", "success");
}

function removerOcorrencia(occId){
  const ctx = _getAlunoBimestreAtual();
  if(!ctx) return;
  ctx.b.ocorrencias = (ctx.b.ocorrencias || []).filter(o => (o.id !== occId));
  salvarDadosLocal();
  renderizarOcorrencias(ctx.b.ocorrencias);
  showToast("Ocorrência excluída.", "info");
}

function initOcorrenciasUI(){
  const ta = document.getElementById('inputNovaOcorrencia');
  if(!ta || ta.__occInit) return;
  ta.__occInit = true;

  // Enter adiciona (Shift+Enter quebra linha)
  ta.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Enter' && !ev.shiftKey){
      ev.preventDefault();
      addOcorrencia();
    }
  });

  // Auto-ajuste de altura (suave)
  const auto = ()=>{
    ta.style.height = 'auto';
    ta.style.height = Math.min(120, ta.scrollHeight) + 'px';
  };
  ta.addEventListener('input', auto);
}


function initElegivelUI(){
  const chk = document.getElementById('checkElegivel');
  if(!chk || chk.__elegInit) return;
  chk.__elegInit = true;

  chk.addEventListener('change', ()=>{
    const a = alunos.find(al => al.id === alunoEdicaoID);
    if(!a) return;

    // garante boolean por aluno (não por turma)
    a.elegivel = !!chk.checked;

    // atualiza o cabeçalho do card do aluno
    const detNome = document.getElementById('detNome');
    if(detNome){
      detNome.innerHTML = _escHTML(a.nome) + (a.elegivel ? ' <i class="fas fa-universal-access" style="color:var(--inclusao);"></i>' : '');
    }

    salvarDadosLocal();
    // atualiza listas/visões (inclusive filtro "Elegivel")
    renderizarVisaoContent();
  });
}


        function gerarParecer() { const a=alunos.find(al=>al.id===alunoEdicaoID);const b=a.bimestres[bimestreAtual];const mlp=parseFloat(b.media_lp)||0;const mred=parseFloat(b.media_red)||0;const comp=b.comportamento;const classificar=(n)=>{if(n>=7)return"bom desempenho";if(n>=5)return"desempenho mediano";return"dificuldades de assimilação"};let txt=`No ${bimestreAtual}º Bimestre, ${__u(a.nome)} apresenta ${classificar(mlp)} em ${__u(config.materia1)} (Média: ${mlp}). Em ${__u(config.materia2)}, demonstra ${classificar(mred)} (Média: ${mred}). `; if(comp>=8)txt+=`Excelente comportamento (Avaliação: ${comp}). `; else txt+=`Comportamento regular (Avaliação: ${comp}). `; document.getElementById('txtParecer').value=txt; }
        
        function addTagParecer(tipo) {
            const frases = {
                'participativo': 'Demonstra grande interesse e participa ativamente das aulas. ',
                'esforçado': 'É um aluno esforçado e realiza as tarefas propostas. ',
                'leitura': 'Possui boa leitura e compreensão de texto. ',
                'conversa': 'Apresenta conversas paralelas frequentes que prejudicam o foco. ',
                'celular': 'O uso excessivo de celular tem atrapalhado seu rendimento. ',
                'faltas': 'O número elevado de faltas impactou a sequência de aprendizado. '
            };
            const txt = document.getElementById('txtParecer');
            txt.value += frases[tipo] || '';
        }

        
/* (removido) Função duplicada antiga: imprimirFicha */
function abrirModal(id) { document.getElementById(id).style.display = 'flex'; }
        function fecharModais() {
            // Fecha todos os modais
            document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none');
            // Se estiver em tela cheia (ex: Atividades), sai para evitar ficar preso
            try{
                if(document.fullscreenElement){
                    if(document.exitFullscreen) document.exitFullscreen();
                    else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
                    else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
                    else if(document.msExitFullscreen) document.msExitFullscreen();
                }
            }catch(_){}
            // Hook interno (ex.: restaurar tema/UI ao fechar)
            try{ __SGP_EVT.emit('afterCloseModals'); }catch(_){}
        }
        function renderizarVisao() { renderizarVisaoContent(); }
        window.addEventListener('click', e => { if(e.target.classList.contains('modal-overlay')) fecharModais(); });
    

/* === PATCH v12.1 — Disciplinas/Avaliações dinâmicas (slots Matéria 1/2) === */
let __cfgDraft = null;

function _deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
function _uid(prefix){ return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6); }
function _escHTML(str){
  return String(str ?? '').replace(/[&<>"']/g, (ch) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[ch]));
}

function __u(v){ return _escHTML(v); }

function __j(v){
  try{ return _escHTML(JSON.stringify(String(v))); }
  catch(_){ return '&quot;&quot;'; }
}


// === SGP: Data Handlers (substitui onclick/onchange inline por listeners) ===
(function __installDataHandlers(){
  const EVT = ['click','change','input','keydown','keyup','submit','dblclick'];

  function _capErr(e, ctx, extra){
    try{ if(typeof __diagCapture==='function') __diagCapture(e, ctx, extra||{}); }catch(_){ }
  }

  // === Executor seguro para handlers em string (SEM eval / compilação dinâmica) ===
  // Suporta:
  // - chamadas simples: fn(...);
  // - return false / return true / return fn(...);
  // - if(cond){ ... }  (condições simples com event.key/ctrlKey/etc + && ||)
  // - event.stopPropagation()/preventDefault()
  // - document.getElementById('id').click()/focus() e atribuições básicas (innerText/textContent/value/checked)
  const _ALLOWED_LHS_PROPS = new Set(['innerText','textContent','value','checked','className']);
  const _ALLOWED_EL_METHODS = new Set(['click','focus','blur','showModal','close','scrollIntoView']);
  const _ALLOWED_EVENT_PROPS = new Set(['key','code','ctrlKey','shiftKey','altKey','metaKey','type']);
  const _ALLOWED_EVENT_METHODS = new Set(['stopPropagation','stopImmediatePropagation','preventDefault']);
  const _ALLOWED_STYLE_PROPS = new Set(['display','visibility','opacity']);

  function _trim(s){ return (s==null?'':String(s)).trim(); }

  function _splitTopLevel(str, sep){
    // divide por sep apenas no nível 0 (fora de aspas/parênteses/chaves)
    const out=[];
    let cur='';
    let q=null;
    let esc=false;
    let depthParen=0, depthBrack=0, depthBrace=0;
    for(let i=0;i<str.length;i++){
      const ch=str[i];
      if(esc){ cur+=ch; esc=false; continue; }
      if(q){
        cur+=ch;
        if(ch==='\\'){ esc=true; continue; }
        if(ch===q) q=null;
        continue;
      }
      if(ch==="'" || ch==='"' || ch==='`'){ q=ch; cur+=ch; continue; }
      if(ch==='(') depthParen++;
      else if(ch===')') depthParen=Math.max(0,depthParen-1);
      else if(ch==='[') depthBrack++;
      else if(ch===']') depthBrack=Math.max(0,depthBrack-1);
      else if(ch==='{') depthBrace++;
      else if(ch==='}') depthBrace=Math.max(0,depthBrace-1);

      if(ch===sep && depthParen===0 && depthBrack===0 && depthBrace===0){
        out.push(cur);
        cur='';
      }else{
        cur+=ch;
      }
    }
    if(cur!=='') out.push(cur);
    return out;
  }

  function _unquote(s){
    s=_trim(s);
    const q = (s.startsWith("'") && s.endsWith("'")) ? "'" : ((s.startsWith('"') && s.endsWith('"')) ? '"' : null);
    if(!q) return null;
    let body = s.slice(1,-1);
    // escapes básicos compatíveis com strings inline
    body = body.replace(/\\\\/g,'\\')
               .replace(/\\n/g,'\n')
               .replace(/\\t/g,'\t')
               .replace(/\\r/g,'\r')
               .replace(/\\"/g,'"')
               .replace(/\\'/g,"'");
    return body;
  }

  function _parseLiteral(expr){
    const t=_trim(expr);
    if(t==='true') return true;
    if(t==='false') return false;
    if(t==='null') return null;
    if(t==='undefined') return undefined;
    if(/^[-+]?\d+(\.\d+)?$/.test(t)) return Number(t);
    const uq=_unquote(t);
    if(uq!==null) return uq;
    return undefined; // "unknown"
  }

  function _safeGetElement(getExpr){
    // document.getElementById('x') | document.querySelector('...')
    const m = _trim(getExpr).match(/^document\.(getElementById|querySelector)\(\s*(['"])(.*?)\2\s*\)$/);
    if(!m) return null;
    const kind=m[1], sel=m[3];
    try{
      return kind==='getElementById' ? document.getElementById(sel) : document.querySelector(sel);
    }catch(_){ return null; }
  }

  function _evalValue(expr, event, el){
    const t=_trim(expr);
    const lit=_parseLiteral(t);
    if(lit !== undefined || t==='undefined') return lit;

    if(t==='this' || t==='el') return el;
    if(t==='event') return event;

    // this.value / this.checked / this.dataset.x
    let m=t.match(/^(this|el)\.(value|checked|innerText|textContent)$/);
    if(m) return el ? el[m[2]] : undefined;

    m=t.match(/^(this|el)\.dataset\.([A-Za-z0-9_\-]+)$/);
    if(m) return el && el.dataset ? el.dataset[m[2]] : undefined;

    // event.key / event.ctrlKey etc
    m=t.match(/^event\.([A-Za-z0-9_\-]+)$/);
    if(m){
      const p=m[1];
      if(_ALLOWED_EVENT_PROPS.has(p)) return event ? event[p] : undefined;
      return undefined;
    }
    m=t.match(/^event\.target\.(value|checked)$/);
    if(m) return event && event.target ? event.target[m[1]] : undefined;

    // document.getElementById('x').value etc
    m=t.match(/^(document\.(?:getElementById|querySelector)\(\s*['"][^'"]+['"]\s*\))\.(value|checked|innerText|textContent)$/);
    if(m){
      const node=_safeGetElement(m[1]);
      return node ? node[m[2]] : undefined;
    }

    return undefined;
  }

  function _evalCond(cond, event, el){
    // split top-level on '||'
    const parts=[];
    let cur='', q=null, esc=false, depth=0;
    for(let i=0;i<cond.length;i++){
      const ch=cond[i];
      if(esc){ cur+=ch; esc=false; continue; }
      if(q){
        cur+=ch;
        if(ch==='\\'){ esc=true; continue; }
        if(ch===q) q=null;
        continue;
      }
      if(ch==="'"||ch==='"'||ch==='`'){ q=ch; cur+=ch; continue; }
      if(ch==='(') depth++;
      else if(ch===')') depth=Math.max(0,depth-1);
      if(ch==='|' && cond[i+1]==='|' && depth===0){
        parts.push(cur); cur=''; i++; continue;
      }
      cur+=ch;
    }
    if(cur!=='') parts.push(cur);

    function evalAtom(atom){
      atom=_trim(atom);
      if(!atom) return false;
      // parentheses
      if(atom.startsWith('(') && atom.endsWith(')')){
        return _evalCond(atom.slice(1,-1), event, el);
      }
      // negation
      if(atom.startsWith('!')) return !evalAtom(atom.slice(1));

      // event.key==='Enter' etc
      let m = atom.match(/^event\.(key|code)\s*(===|==|!==|!=)\s*(['"])(.*?)\3$/);
      if(m){
        const left = event ? event[m[1]] : undefined;
        const right = m[4];
        if(m[2]==='==='||m[2]==='==') return String(left)===String(right);
        return String(left)!==String(right);
      }

      // event.ctrlKey etc (boolean)
      m = atom.match(/^event\.(ctrlKey|shiftKey|altKey|metaKey)$/);
      if(m) return !!(event && event[m[1]]);

      // this.checked (boolean)
      m = atom.match(/^(this|el)\.(checked)$/);
      if(m) return !!(el && el.checked);

      // literal truthy
      const lit=_parseLiteral(atom);
      if(lit!==undefined || atom==='undefined') return !!lit;

      return false;
    }

    function evalAnd(expr){
      // split top-level on '&&'
      const ands=[];
      let c='', qq=null, ee=false, d=0;
      for(let i=0;i<expr.length;i++){
        const ch=expr[i];
        if(ee){ c+=ch; ee=false; continue; }
        if(qq){
          c+=ch;
          if(ch==='\\'){ ee=true; continue; }
          if(ch===qq) qq=null;
          continue;
        }
        if(ch==="'"||ch==='"'||ch==='`'){ qq=ch; c+=ch; continue; }
        if(ch==='(') d++;
        else if(ch===')') d=Math.max(0,d-1);
        if(ch==='&' && expr[i+1]==='&' && d===0){
          ands.push(c); c=''; i++; continue;
        }
        c+=ch;
      }
      if(c!=='') ands.push(c);

      for(const a of ands){
        if(!evalAtom(_trim(a))) return false;
      }
      return true;
    }

    for(const p of parts){
      if(evalAnd(p)) return true;
    }
    return false;
  }

  function _callGlobal(fnName, args, el){
    const fn = window[fnName];
    if(typeof fn !== 'function') throw new Error('Função não encontrada: '+fnName);
    return fn.apply(el, args);
  }

  function _parseArgs(argStr, event, el){
    const s=_trim(argStr);
    if(!s) return [];
    const parts=_splitTopLevel(s,',');
    const args=[];
    for(const p of parts){
      args.push(_evalValue(p, event, el));
    }
    return args;
  }

  function _runSimple(stmt, event, el){
    stmt=_trim(stmt);
    if(!stmt) return {type:'none'};

    // return ...
    if(stmt.startsWith('return ')){
      const expr=_trim(stmt.slice(7));
      if(expr==='false') return {type:'return', value:false};
      if(expr==='true') return {type:'return', value:true};

      // return fn(...)
      const m=expr.match(/^([A-Za-z_$][\w$]*)\s*\(([\s\S]*)\)\s*$/);
      if(m){
        const args=_parseArgs(m[2], event, el);
        const v=_callGlobal(m[1], args, el);
        return {type:'return', value:v};
      }
      // return literal
      const lit=_parseLiteral(expr);
      return {type:'return', value:lit};
    }

    if(stmt==='return false') return {type:'return', value:false};
    if(stmt==='return true') return {type:'return', value:true};

    // event.method()
    let m = stmt.match(/^event\.(stopPropagation|stopImmediatePropagation|preventDefault)\(\s*\)\s*$/);
    if(m){
      const meth=m[1];
      if(event && _ALLOWED_EVENT_METHODS.has(meth) && typeof event[meth]==='function') event[meth]();
      return {type:'none'};
    }

    // this.method()
    m = stmt.match(/^(this|el)\.(click|focus|blur|scrollIntoView)\(\s*\)\s*$/);
    if(m){
      const meth=m[2];
      if(el && _ALLOWED_EL_METHODS.has(meth) && typeof el[meth]==='function') el[meth]();
      return {type:'none'};
    }

    // document.getElementById('x').method()
    m = stmt.match(/^(document\.(?:getElementById|querySelector)\(\s*['"][^'"]+['"]\s*\))\.(click|focus|blur|showModal|close|scrollIntoView)\(\s*\)\s*$/);
    if(m){
      const node=_safeGetElement(m[1]);
      const meth=m[2];
      if(node && _ALLOWED_EL_METHODS.has(meth) && typeof node[meth]==='function') node[meth]();
      return {type:'none'};
    }

    // assignments: <getter>.<prop> = <value>
    m = stmt.match(/^(document\.(?:getElementById|querySelector)\(\s*['"][^'"]+['"]\s*\))\.(innerText|textContent|value|checked|className)\s*=\s*([\s\S]+)$/);
    if(m){
      const node=_safeGetElement(m[1]);
      const prop=m[2];
      if(node && _ALLOWED_LHS_PROPS.has(prop)){
        const val=_evalValue(m[3], event, el);
        node[prop]=val==null?'':val;
      }
      return {type:'none'};
    }
    // style assignments (ex.: document.getElementById('x').style.display='none')
    m = stmt.match(/^(document\.(?:getElementById|querySelector)\(\s*['"][^'"]+['"]\s*\))\.style\.(display|visibility|opacity)\s*=\s*([\s\S]+)$/);
    if(m){
      const node=_safeGetElement(m[1]);
      const prop=m[2];
      if(node && node.style && _ALLOWED_STYLE_PROPS.has(prop)){
        const val=_evalValue(m[3], event, el);
        node.style[prop]=val==null?'':String(val);
      }
      return {type:'none'};
    }
    m = stmt.match(/^(this|el)\.style\.(display|visibility|opacity)\s*=\s*([\s\S]+)$/);
    if(m){
      const prop=m[2];
      if(el && el.style && _ALLOWED_STYLE_PROPS.has(prop)){
        const val=_evalValue(m[3], event, el);
        el.style[prop]=val==null?'':String(val);
      }
      return {type:'none'};
    }

    m = stmt.match(/^(this|el)\.(innerText|textContent|value|checked|className)\s*=\s*([\s\S]+)$/);
    if(m){
      const prop=m[2];
      if(el && _ALLOWED_LHS_PROPS.has(prop)){
        const val=_evalValue(m[3], event, el);
        el[prop]=val==null?'':val;
      }
      return {type:'none'};
    }

    // fn(...)
    m = stmt.match(/^([A-Za-z_$][\w$]*)\s*\(([\s\S]*)\)\s*$/);
    if(m){
      const args=_parseArgs(m[2], event, el);
      _callGlobal(m[1], args, el);
      return {type:'none'};
    }

    // fallback (não permitido)
    throw new Error('Handler não suportado: '+stmt.slice(0,200));
  }

  function _runCode(code, event, el){
    const raw = String(code||'');
    if(raw.length>5000) throw new Error('Handler muito grande');

    const statements=_splitTopLevel(raw,';').map(_trim).filter(Boolean);
    let ret;
    for(const st of statements){
      const s=_trim(st);
      if(!s) continue;

      // if (...) { ... } else { ... }
      if(s.startsWith('if(') || s.startsWith('if (')){
        const m = s.match(/^if\s*\(([\s\S]*?)\)\s*\{([\s\S]*?)\}\s*(?:else\s*\{([\s\S]*?)\})?\s*$/);
        if(!m) throw new Error('If inválido');
        const cond=m[1], thenCode=m[2], elseCode=m[3];
        const ok=_evalCond(cond, event, el);
        const branch = ok ? thenCode : (elseCode||'');
        if(branch){
          const inner=_splitTopLevel(branch,';').map(_trim).filter(Boolean);
          for(const ist of inner){
            const rr=_runSimple(ist, event, el);
            if(rr.type==='return'){ ret=rr.value; return ret; }
          }
        }
        continue;
      }

      const rr=_runSimple(s, event, el);
      if(rr.type==='return'){ ret=rr.value; return ret; }
    }
    return ret;
  }

  function _bindOne(el, evt, code){
    const mark = '__sgp_on_'+evt;
    if(el[mark]) return;

    el.addEventListener(evt, function(event){
      try{
        const r = _runCode(code, event, el);
        if(r === false){
          event.preventDefault();
          event.stopPropagation();
        }
      }catch(e){
        _capErr(e, 'handler.run.safe', {evt, code: String(code||'').slice(0,500)});
      }
    }, (evt==='submit'));

    el[mark] = true;
  }

  function _scan(root){
    try{
      const scope = root && root.querySelectorAll ? root : document;
      EVT.forEach(function(evt){
        const attr = 'data-on'+evt;
        // Also check the root element itself (querySelectorAll only searches descendants)
        if(scope !== document && scope.matches && scope.matches('['+attr+']')){
          const code = scope.getAttribute(attr);
          if(code) _bindOne(scope, evt, code);
        }
        const nodes = scope.querySelectorAll('['+attr+']');
        nodes.forEach(function(el){
          const code = el.getAttribute(attr);
          if(!code) return;
          _bindOne(el, evt, code);
        });
      });
    }catch(e){ _capErr(e, 'handler.scan', {}); }
  }

  function _setup(){
    _scan(document);
    if(window.__sgpDataHandlerObs) return;
    try{
      window.__sgpDataHandlerObs = new MutationObserver(function(muts){
        muts.forEach(function(mu){
          mu.addedNodes && mu.addedNodes.forEach(function(n){
            if(n && n.nodeType === 1) _scan(n);
          });
        });
      });
      window.__sgpDataHandlerObs.observe(document.documentElement, {childList:true, subtree:true});
    }catch(e){ _capErr(e, 'handler.observe', {}); }
  }

  window.__SGP_setupDataHandlers = _setup;
})();

function getDiscById(id, cfg=config){ return (cfg?.disciplinas||[]).find(d=>d.id===id) || null; }

function _syncConfigLegacyFields(){
  const d1=getDiscById(config.slot1);
  const d2=getDiscById(config.slot2);
  config.materia1 = d1 ? d1.nome : "Matéria 1";
  config.materia2 = d2 ? d2.nome : "Matéria 2";
  // Campos legados (mantém compatibilidade, quando existirem)
  const pesos = {};
  (d1?.avaliacoes||[]).forEach(av => { pesos[av.id] = parseFloat(av.peso)||0; });
  if(!config.pesos || typeof config.pesos !== 'object') config.pesos = {};
  ['a1','a2','a3','a4','a5','rec'].forEach(k => {
    if(typeof pesos[k] !== 'undefined') config.pesos[k] = pesos[k];
  });
}

function ensureConfigSchema(){
  if(!config || typeof config !== 'object') config = {};
  // Migra config antigo -> novo
  if(!Array.isArray(config.disciplinas)){
    const old = config || {};
    const m1 = old.materia1 || "Português";
    const m2 = old.materia2 || "Redação e Leitura";
    const p  = (old.pesos && typeof old.pesos === 'object') ? old.pesos : {a1:15,a2:15,a3:15,a4:15,a5:30,rec:10};

    config = {
      disciplinas: [
        { id:'lp',  nome:m1, avaliacoes:[
          {id:'a1', nome:'Ativ 1', peso: (p.a1 ?? 15)},
          {id:'a2', nome:'Ativ 2', peso: (p.a2 ?? 15)},
          {id:'a3', nome:'Ativ 3', peso: (p.a3 ?? 15)},
          {id:'a4', nome:'Ativ 4', peso: (p.a4 ?? 15)},
          {id:'a5', nome:'Ativ 5', peso: (p.a5 ?? 30)},
          {id:'rec', nome:'Recup.', peso: (p.rec ?? 10)}
        ]},
        { id:'red', nome:m2, avaliacoes:[
          {id:'r1',   nome:'Redação 1', peso:40},
          {id:'r2',   nome:'Redação 2', peso:40},
          {id:'leit', nome:'Leitura',   peso:20}
        ]}
      ],
      slot1:'lp',
      slot2:'red',
      rec_substitui: !!old.rec_substitui
    };
  }

  // Normaliza schema
  if(!config.disciplinas.length){
    config.disciplinas = [{ id:'lp', nome:'Português', avaliacoes:[{id:'a1',nome:'Avaliação 1',peso:100}] }];
  }
  // Garante ao menos 2 disciplinas (Matéria 1 e Matéria 2)
  if(config.disciplinas.length===1){
    const baseId = config.disciplinas[0]?.id;
    const useRed = (baseId==='lp' && !(config.disciplinas||[]).some(d=>d.id==='red'));
    const newId = useRed ? 'red' : _uid('disc');
    config.disciplinas.push({ id:newId, nome: useRed ? 'Redação e Leitura' : 'Nova Disciplina 2', avaliacoes: useRed ? [
      {id:'r1', nome:'Redação 1', peso:40},
      {id:'r2', nome:'Redação 2', peso:40},
      {id:'leit', nome:'Leitura', peso:20}
    ] : [{ id:_uid('av'), nome:'Avaliação 1', peso:100 }] });
  }
  if(!config.slot1) config.slot1 = config.disciplinas[0]?.id;
  if(!config.slot2) config.slot2 = config.disciplinas[1]?.id || config.disciplinas[0]?.id;
  if(config.slot1===config.slot2 && (config.disciplinas||[]).length>1){
    const alt = (config.disciplinas||[]).find(d=>d.id!==config.slot1);
    if(alt) config.slot2 = alt.id;
  }
  if(typeof config.rec_substitui === 'undefined') config.rec_substitui = false;

  config.disciplinas.forEach(d=>{
    if(!d.id) d.id = _uid('disc');
    if(!d.nome || !String(d.nome).trim()) d.nome = 'Disciplina';
    if(!Array.isArray(d.avaliacoes) || d.avaliacoes.length===0){
      d.avaliacoes = [{ id:_uid('av'), nome:'Avaliação 1', peso:100 }];
    }
    d.avaliacoes.forEach(av=>{
      if(!av.id) av.id = _uid('av');
      if(!av.nome || !String(av.nome).trim()) av.nome = 'Avaliação';
      av.peso = isFinite(parseFloat(av.peso)) ? parseFloat(av.peso) : 0;
    });
  });

  // Tema (cores)
  if(!config.tema || typeof config.tema !== 'object') {
    config.tema = { preset: 'Azul', cores: { primary:'#2563eb', secondary:'#1e40af', bg:'#f8fafc', card:'#ffffff', text:'#334155' } };
  }
  if(!config.tema.preset) config.tema.preset = 'Azul';
  if(!config.tema.cores || typeof config.tema.cores !== 'object') {
    config.tema.cores = { primary:'#2563eb', secondary:'#1e40af', bg:'#f8fafc', card:'#ffffff', text:'#334155' };
  }

  _syncConfigLegacyFields();
}

function _syncBimestreRefs(b){
  if(!b) return;
  if(!b.notas_disc || typeof b.notas_disc !== 'object') b.notas_disc = {};

  const d1 = getDiscById(config.slot1);
  const d2 = getDiscById(config.slot2);

  if(d1){
    if(!b.notas_disc[d1.id]) b.notas_disc[d1.id] = {};
    b.notas_lp = b.notas_disc[d1.id];
    d1.avaliacoes.forEach(av => { if(typeof b.notas_lp[av.id] === 'undefined') b.notas_lp[av.id] = 0; });
  } else {
    b.notas_lp = b.notas_lp || {};
  }

  if(d2){
    if(!b.notas_disc[d2.id]) b.notas_disc[d2.id] = {};
    b.notas_red = b.notas_disc[d2.id];
    d2.avaliacoes.forEach(av => { if(typeof b.notas_red[av.id] === 'undefined') b.notas_red[av.id] = 0; });
  } else {
    b.notas_red = b.notas_red || {};
  }
}

function _syncAllStudents(){
  alunos.forEach(a=>{
    if(!a.bimestres) return;
    [1,2,3,4,5,6,7].forEach(i=>{
      const b=a.bimestres[i];
      if(!b) return;

      // Migra antigas notas_lp/notas_red para notas_disc, se necessário
      if(!b.notas_disc || typeof b.notas_disc !== 'object'){
        b.notas_disc = {};
        if(b.notas_lp) b.notas_disc['lp']  = b.notas_lp;
        if(b.notas_red) b.notas_disc['red'] = b.notas_red;
      }
      _syncBimestreRefs(b);

      // Recalcula médias
      b.media_lp  = calcularMediaLPIndividual(b.notas_lp, b.notas_lp?.rec);
      b.media_red = calcularMediaRED(b.notas_red);
    });
  });
}

function calcularMediaDisc(discId, notas){
  const disc = getDiscById(discId);
  if(!disc) return 0;

  let total=0, sum=0;
  (disc.avaliacoes||[]).forEach(av=>{
    const w = parseFloat(av.peso)||0;
    const n = clampNota(notas?.[av.id]);
    if(w>0){ total += w; sum += n*w; }
  });
  let media = total>0 ? (sum/total) : 0;

  // Regra de recuperação (apenas Matéria 1 e apenas se existir "rec")
  if(config.rec_substitui && discId===config.slot1){
    const rec = clampNota(notas?.['rec']);
    let totalAt=0, sumAt=0;
    (disc.avaliacoes||[]).forEach(av=>{
      if(av.id==='rec') return;
      const w=parseFloat(av.peso)||0;
      const n=clampNota(notas?.[av.id]);
      if(w>0){ totalAt+=w; sumAt+=n*w; }
    });
    const mediaAt = totalAt>0 ? (sumAt/totalAt) : 0;
    media = Math.max(mediaAt, rec);
  }

  return media;
}

// Wrappers legados
function calcularMediaLPIndividual(notas, rec){ return calcularMediaDisc(config.slot1, notas).toFixed(1); }
function calcularMediaRED(notas){ return calcularMediaDisc(config.slot2, notas).toFixed(1); }

/* ======= CONFIG UI ======= */
function abrirConfig(){
  ensureConfigSchema();
  __cfgDraft = _deepClone(config);
  renderConfigModal();
  abrirModal('modalConfig');
}

function renderConfigModal(){
  const sel1=document.getElementById('cfgSlot1');
  const sel2=document.getElementById('cfgSlot2');
  if(!sel1 || !sel2) return;

  sel1.innerHTML=''; sel2.innerHTML='';

  (__cfgDraft.disciplinas||[]).forEach(d=>{
    const o1=document.createElement('option');
    o1.value=d.id; o1.textContent=d.nome;
    const o2=o1.cloneNode(true);
    sel1.appendChild(o1); sel2.appendChild(o2);
  });

  sel1.value = __cfgDraft.slot1 || (__cfgDraft.disciplinas[0]?.id || '');
  sel2.value = __cfgDraft.slot2 || (__cfgDraft.disciplinas[1]?.id || __cfgDraft.disciplinas[0]?.id || '');

  const chk=document.getElementById('cfgRecSubs');
  if(chk) chk.checked = !!__cfgDraft.rec_substitui;

  sel1.onchange=()=>{ __cfgDraft.slot1 = sel1.value; _renderDisciplinasList(); };
  sel2.onchange=()=>{ __cfgDraft.slot2 = sel2.value; _renderDisciplinasList(); };
  if(chk) chk.onchange=(e)=>{ __cfgDraft.rec_substitui = e.target.checked; };

  _renderDisciplinasList();
  _renderTemaConfig();
  _renderHistoricoConfig();
  _renderDiagnosticoConfig();
}

function _renderDisciplinasList(){
  const container=document.getElementById('cfgDisciplinasList');
  if(!container) return;
  container.innerHTML='';

  (__cfgDraft.disciplinas||[]).forEach(d=>{
    const card=document.createElement('div');
    card.style.border='1px solid var(--border-color)';
    card.style.borderRadius='10px';
    card.style.padding='12px';
    card.style.margin='10px 0';
    card.style.background='var(--card-bg)';

    const head=document.createElement('div');
    head.style.display='flex';
    head.style.alignItems='center';
    head.style.gap='10px';

    const name=document.createElement('input');
    name.type='text';
    name.className='inp';
    name.value=d.nome || '';
    name.style.flex='1';
    name.oninput=(e)=>{
      d.nome = e.target.value;
      // Atualiza labels dos selects
      Array.from(document.querySelectorAll(`#cfgSlot1 option[value="${__u(d.id)}"], #cfgSlot2 option[value="${__u(d.id)}"]`))
        .forEach(o => o.textContent = d.nome || 'Disciplina');
    };

    const badge=document.createElement('span');
    badge.style.fontSize='0.75rem';
    badge.style.padding='4px 8px';
    badge.style.borderRadius='999px';
    badge.style.border='1px solid #e2e8f0';
    badge.style.background='#f1f5f9';
    badge.style.whiteSpace='nowrap';
    badge.textContent = (d.id===__cfgDraft.slot1) ? 'Matéria 1' : ((d.id===__cfgDraft.slot2) ? 'Matéria 2' : '—');

    const del=document.createElement('button');
    del.className='btn-tool';
    del.innerHTML='<i class="fas fa-trash"></i>';
    del.title='Excluir disciplina';
    del.style.color='red';
    del.onclick=()=>cfgExcluirDisciplina(d.id);

    head.appendChild(name);
    head.appendChild(badge);
    head.appendChild(del);

    const sub=document.createElement('div');
    sub.style.display='flex';
    sub.style.alignItems='center';
    sub.style.justifyContent='space-between';
    sub.style.marginTop='12px';

    const st=document.createElement('strong');
    st.textContent='Avaliações';

    const add=document.createElement('button');
    add.className='btn-tool';
    add.innerHTML='<i class="fas fa-plus"></i>';
    add.title='Adicionar avaliação';
    add.onclick=()=>cfgAdicionarAvaliacao(d.id);

    sub.appendChild(st);
    sub.appendChild(add);

    const table=document.createElement('table');
    table.className='tabela-fixa';
    table.style.marginTop='8px';
    table.innerHTML='<thead><tr><th>Nome</th><th style="width:120px;">Peso (%)</th><th style="width:44px;"></th></tr></thead>';

    const tb=document.createElement('tbody');

    (d.avaliacoes||[]).forEach(av=>{
      const tr=document.createElement('tr');

      const tdN=document.createElement('td');
      const inpN=document.createElement('input');
      inpN.type='text';
      inpN.className='inp';
      inpN.value=av.nome || '';
      inpN.oninput=(e)=>{ av.nome = e.target.value; };
      tdN.appendChild(inpN);

      const tdP=document.createElement('td');
      const inpP=document.createElement('input');
      inpP.type='number';
      inpP.className='inp';
      inpP.min='0';
      inpP.step='1';
      inpP.value=(av.peso ?? 0);
      inpP.oninput=(e)=>{ av.peso = parseFloat(e.target.value)||0; };
      tdP.appendChild(inpP);

      const tdD=document.createElement('td');
      tdD.style.textAlign='center';
      const btnD=document.createElement('button');
      btnD.className='btn-tool';
      btnD.innerHTML='<i class="fas fa-times"></i>';
      btnD.title='Excluir avaliação';
      btnD.style.color='red';
      btnD.onclick=()=>cfgExcluirAvaliacao(d.id, av.id);
      tdD.appendChild(btnD);

      tr.appendChild(tdN);
      tr.appendChild(tdP);
      tr.appendChild(tdD);
      tb.appendChild(tr);
    });

    table.appendChild(tb);

    const hint=document.createElement('div');
    hint.style.fontSize='0.78rem';
    hint.style.color='#64748b';
    hint.style.marginTop='6px';
    hint.textContent='Pesos podem somar qualquer valor (o sistema normaliza automaticamente).';

    card.appendChild(head);
    card.appendChild(sub);
    card.appendChild(table);
    card.appendChild(hint);

    container.appendChild(card);
  });
}

function cfgAdicionarDisciplina(){
  if(!__cfgDraft) return;
  __cfgDraft.disciplinas = __cfgDraft.disciplinas || [];
  __cfgDraft.disciplinas.push({
    id: _uid('disc'),
    nome: 'Nova Disciplina',
    avaliacoes: [{ id:_uid('av'), nome:'Avaliação 1', peso:100 }]
  });
  renderConfigModal();
}

function cfgExcluirDisciplina(discId){
  if(!__cfgDraft) return;
  if((__cfgDraft.disciplinas||[]).length<=2) return showToast("Não é possível ficar com menos de 2 disciplinas (Matéria 1 e Matéria 2).", "error");
  if(!confirm("Excluir esta disciplina?")) return;

  __cfgDraft.disciplinas = (__cfgDraft.disciplinas||[]).filter(d=>d.id!==discId);

  if(__cfgDraft.slot1===discId) __cfgDraft.slot1 = __cfgDraft.disciplinas[0]?.id || '';
  if(__cfgDraft.slot2===discId) __cfgDraft.slot2 = __cfgDraft.disciplinas[1]?.id || __cfgDraft.disciplinas[0]?.id || '';

  renderConfigModal();
}

function cfgAdicionarAvaliacao(discId){
  if(!__cfgDraft) return;
  const disc = (__cfgDraft.disciplinas||[]).find(d=>d.id===discId);
  if(!disc) return;
  disc.avaliacoes = disc.avaliacoes || [];
  const n = disc.avaliacoes.length + 1;
  disc.avaliacoes.push({ id:_uid('av'), nome:`Avaliação ${n}`, peso:10 });
  _renderDisciplinasList();
}

function cfgExcluirAvaliacao(discId, avalId){
  if(!__cfgDraft) return;
  const disc = (__cfgDraft.disciplinas||[]).find(d=>d.id===discId);
  if(!disc) return;
  if((disc.avaliacoes||[]).length<=1) return showToast("Não é possível excluir a última avaliação.", "error");
  disc.avaliacoes = (disc.avaliacoes||[]).filter(a=>a.id!==avalId);
  _renderDisciplinasList();
}

function salvarConfig(){
  if(!__cfgDraft) return;

  const slot1=document.getElementById('cfgSlot1')?.value;
  const slot2=document.getElementById('cfgSlot2')?.value;

  if(!slot1 || !slot2) return showToast("Selecione Matéria 1 e Matéria 2.", "error");
  if(slot1===slot2) return showToast("Matéria 1 e Matéria 2 devem ser diferentes.", "error");

  __cfgDraft.slot1 = slot1;
  __cfgDraft.slot2 = slot2;
  __cfgDraft.rec_substitui = document.getElementById('cfgRecSubs')?.checked ? true : false;

  (__cfgDraft.disciplinas||[]).forEach(d=>{
    d.nome = (d.nome||'').trim() || 'Disciplina';
    d.avaliacoes = Array.isArray(d.avaliacoes) ? d.avaliacoes : [];
    if(d.avaliacoes.length===0) d.avaliacoes = [{ id:_uid('av'), nome:'Avaliação 1', peso:100 }];
    d.avaliacoes.forEach(av=>{
      av.nome = (av.nome||'').trim() || 'Avaliação';
      av.peso = isFinite(parseFloat(av.peso)) ? parseFloat(av.peso) : 0;
    });
  });

  config = _deepClone(__cfgDraft);
  ensureConfigSchema();
  _syncAllStudents();

  salvarDadosLocal();
  atualizarLabelsConfig();
  applyThemeFromConfig();
  fecharModais();
  renderizarVisaoContent();
  showToast("Configurações salvas!");
}

/* ======= MODAL (DETALHES) — tabelas dinâmicas ======= */
function renderTabelaAvaliacoesModal(tabKey){
  ensureConfigSchema();

  const discId = (tabKey==='lp') ? config.slot1 : config.slot2;
  const disc = getDiscById(discId);

  const tbody = document.getElementById(tabKey==='lp' ? 'tbodyAvalLP' : 'tbodyAvalRED');
  if(!tbody) return;

  tbody.innerHTML='';

  (disc?.avaliacoes||[]).forEach(av=>{
    const tr=document.createElement('tr');

    const tdNome=document.createElement('td');
    tdNome.textContent = av.nome;

    const tdPeso=document.createElement('td');
    const span=document.createElement('span');
    span.className = (tabKey==='red') ? 'peso-badge-red' : 'peso-badge';
    if(/leitura/i.test(av.nome)) { span.style.background='#d1fae5'; span.style.color='#065f46'; }
    span.textContent = `${parseFloat(av.peso)||0}%`;
    tdPeso.appendChild(span);

    const tdNota=document.createElement('td');
    const inp=document.createElement('input');
    inp.type='number';
    inp.className='nota-input';
    inp.min='0'; inp.max='10'; inp.step='0.5';
    inp.dataset.disc = discId;
    inp.dataset.eval = av.id;
    inp.oninput = (e)=>{ handleNotaInput(e.target); calcularEmTempoReal(); };
    tdNota.appendChild(inp);

    tr.appendChild(tdNome);
    tr.appendChild(tdPeso);
    tr.appendChild(tdNota);

    tbody.appendChild(tr);
  });
}

function _coletarNotasModal(tabKey){
  const tbody = document.getElementById(tabKey==='lp' ? 'tbodyAvalLP' : 'tbodyAvalRED');
  const notas = {};
  if(!tbody) return notas;
  tbody.querySelectorAll('input[data-eval]').forEach(inp=>{
    notas[inp.dataset.eval] = clampNota(inp.value);
  });
  return notas;
}

function calcularEmTempoReal(){
  ensureConfigSchema();
  const notas1=_coletarNotasModal('lp');
  const notas2=_coletarNotasModal('red');
  const m1 = calcularMediaDisc(config.slot1, notas1);
  const m2 = calcularMediaDisc(config.slot2, notas2);

  const s1=document.getElementById('spanMedia_lp');
  const s2=document.getElementById('spanMedia_red');
  if(s1){ s1.innerText = m1.toFixed(1); s1.style.color = getCorFarol(m1); }
  if(s2){ s2.innerText = m2.toFixed(1); s2.style.color = getCorFarol(m2); }
}

function abrirDetalhes(id){
  ensureConfigSchema();
  const a=alunos.find(al=>al.id===id); if(!a) return;
  alunoEdicaoID = id;

  const b=a.bimestres[bimestreAtual];
  _syncBimestreRefs(b);

  document.getElementById('detNome').innerText = privacyMode ? '••••••••' : a.nome;
  document.getElementById('detTurma').innerText = `${__u(a.turma)} — ${bimestreAtual}º Bimestre`;

  // Inclusão (Elegível) — por aluno
  const chkEleg = document.getElementById('checkElegivel');
  if(chkEleg) chkEleg.checked = !!a.elegivel;

  renderTabelaAvaliacoesModal('lp');
  renderTabelaAvaliacoesModal('red');

  // Preenche valores
  const notas1 = b.notas_lp || {};
  const notas2 = b.notas_red || {};
  document.querySelectorAll('#tbodyAvalLP input[data-eval]').forEach(inp => { inp.value = (notas1[inp.dataset.eval] ?? 0); handleNotaInput(inp); });
  document.querySelectorAll('#tbodyAvalRED input[data-eval]').forEach(inp => { inp.value = (notas2[inp.dataset.eval] ?? 0); handleNotaInput(inp); });

  // Livro (mantém)
  const inLivro=document.getElementById('inputLivro');
  const selStatus=document.getElementById('selectStatusLivro');
  if(inLivro) inLivro.value = b.livro || '';
  if(selStatus) selStatus.value = b.status_livro || 'Pendente';

  // Parecer
  const txt=document.getElementById('txtParecer');
  if(txt) txt.value = b.parecer || '';

  // Médias
  b.media_lp = calcularMediaLPIndividual(b.notas_lp, b.notas_lp?.rec);
  b.media_red = calcularMediaRED(b.notas_red);
  const _sLP = document.getElementById('spanMedia_lp');
  const _sRD = document.getElementById('spanMedia_red');
  if(_sLP){ _sLP.innerText = b.media_lp; _sLP.style.color = getCorFarol(b.media_lp); }
  if(_sRD){ _sRD.innerText = b.media_red; _sRD.style.color = getCorFarol(b.media_red); }

  abrirModal('modalDetalhes');
}

function salvarAlteracoesDetalhadas(){
  ensureConfigSchema();
  const a=alunos.find(al=>al.id===alunoEdicaoID); if(!a) return;
  const b=a.bimestres[bimestreAtual];
  _syncBimestreRefs(b);

  // Livro
  const inLivro=document.getElementById('inputLivro');
  const selStatus=document.getElementById('selectStatusLivro');
  if(inLivro) b.livro = inLivro.value || '';
  if(selStatus) b.status_livro = selStatus.value || 'Pendente';

  // Notas Matéria 1/2
  const d1=config.slot1, d2=config.slot2;
  b.notas_disc = b.notas_disc || {};
  if(!b.notas_disc[d1]) b.notas_disc[d1] = {};
  if(!b.notas_disc[d2]) b.notas_disc[d2] = {};

  document.querySelectorAll('#tbodyAvalLP input[data-eval]').forEach(inp=>{
    b.notas_disc[d1][inp.dataset.eval] = clampNota(inp.value);
  });
  document.querySelectorAll('#tbodyAvalRED input[data-eval]').forEach(inp=>{
    b.notas_disc[d2][inp.dataset.eval] = clampNota(inp.value);
  });


  try{ b.notas_disc[d1].__touched = true; b.notas_disc[d2].__touched = true; }catch(_){ }
  _syncBimestreRefs(b);

  // Auto-mark entregas_red as 'entregue' when a grade > 0 is entered
  if(!b.entregas_red) b.entregas_red = {};
  const _redNotas = b.notas_disc[d2] || {};
  if(parseFloat(_redNotas['r1']||0) > 0 && _migrateEntregaStatus(b.entregas_red.r1) !== 'entregue'){
    b.entregas_red.r1 = 'entregue';
  }
  if(parseFloat(_redNotas['r2']||0) > 0 && _migrateEntregaStatus(b.entregas_red.r2) !== 'entregue'){
    b.entregas_red.r2 = 'entregue';
  }

  // Parecer
  const txt=document.getElementById('txtParecer');
  if(txt) b.parecer = txt.value || '';

  // Médias
  b.media_lp = calcularMediaLPIndividual(b.notas_lp, b.notas_lp?.rec);
  b.media_red = calcularMediaRED(b.notas_red);


  // Inclusão (Elegível) — por aluno
  const chkEleg = document.getElementById('checkElegivel');
  if(chkEleg) a.elegivel = !!chkEleg.checked;

  salvarDadosLocal();
  renderizarVisaoContent();
  showToast("Alterações salvas!");
}

/* ======= MASSA V18 ENHANCED ======= */
let massaDiscSelecionada = null;
let __massaSortCol = null;
let __massaSortAsc = true;
let __massaSearchFilter = '';
let __massaAutoSaveTimer = null;
let __massaModifiedInputs = new Set();

function _massaDiscDefault(){
  ensureConfigSchema();
  return massaDiscSelecionada || config.slot1 || (config.disciplinas?.[0]?.id) || null;
}

// Bug #1: Auto-save before switching discipline
function massaSetDisc(discId){
  if(notasModificadas){
    salvarEdicaoMassa(true); // silent save
  }
  massaDiscSelecionada = discId;
  __massaSearchFilter = '';
  __massaSortCol = null;
  __massaSortAsc = true;
  const si = document.getElementById('massaSearchInput');
  if(si) si.value = '';
  document.querySelectorAll('#massaDiscNav .massa-disc-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.disc === discId);
  });
  renderizarEdicaoMassa();
}

function massaRenderDiscNav(){
  ensureConfigSchema();
  const nav = document.getElementById('massaDiscNav');
  if(!nav) return;
  const discs = Array.isArray(config.disciplinas) ? config.disciplinas : [];
  if(discs.length === 0){ nav.innerHTML = ''; return; }
  const current = _massaDiscDefault();
  if(!massaDiscSelecionada) massaDiscSelecionada = current;
  nav.innerHTML = discs.map(d=>{
    const icon = (d.id===config.slot1) ? 'fa-book' : (d.id===config.slot2) ? 'fa-pen-nib' : 'fa-layer-group';
    const active = (d.id === massaDiscSelecionada) ? 'active' : '';
    return `<button class="massa-disc-btn ${active}" data-disc="${__u(d.id)}" data-onclick="massaSetDisc('${__u(d.id)}')">
      <i class="fas ${icon}"></i> ${_escHTML(d.nome||'Disciplina')}
    </button>`;
  }).join('');
}

function massaToggleFullscreen(){
  const el = document.getElementById('viewMassa') || document.documentElement;
  const btn = document.getElementById('btnMassaFullscreen');
  const isFs = !!document.fullscreenElement;
  if(!isFs){
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
    if(req) req.call(el);
  } else {
    const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
    if(exit) exit.call(document);
  }
  setTimeout(()=>{
    const fsNow = !!document.fullscreenElement;
    if(btn) btn.innerHTML = fsNow ? '<i class="fas fa-compress"></i> Sair da tela cheia' : '<i class="fas fa-expand"></i> Tela cheia';
  }, 50);
}

document.addEventListener('fullscreenchange', ()=>{
  const btn = document.getElementById('btnMassaFullscreen');
  if(btn){
    const fsNow = !!document.fullscreenElement;
    btn.innerHTML = fsNow ? '<i class="fas fa-compress"></i> Sair da tela cheia' : '<i class="fas fa-expand"></i> Tela cheia';
  }
});

// Bug #3: Real-time media calculation per row
function __massaRecalcRowMedia(input){
  const tr = input.closest('tr');
  if(!tr) return;
  const discId = input.dataset.disc;
  const inputs = tr.querySelectorAll('.nota-input-massa[data-disc="'+discId+'"]');
  const disc = getDiscById(discId);
  if(!disc) return;
  // Build temp notas object
  const notas = {};
  inputs.forEach(inp => { notas[inp.dataset.eval] = clampNota(inp.value); });
  const media = calcularMediaDisc(discId, notas);
  const cor = getCorFarol(media);
  const mediaCell = tr.querySelector('td:last-child strong');
  if(mediaCell){
    mediaCell.style.color = cor;
    mediaCell.textContent = isFinite(media) ? media.toFixed(1) : media;
  }
  // Also update column stats
}

// Feature #13: Column statistics
function __massaUpdateColStats(){
  const tr = document.getElementById('trMassaStats');
  if(!tr) return;
  const discId = _massaDiscDefault();
  const disc = getDiscById(discId);
  if(!disc){ tr.innerHTML = ''; return; }
  const avs = disc.avaliacoes || [];
  
  let cols = '<td></td><td></td><td></td>';
  avs.forEach((av, ci) => {
    const inputs = document.querySelectorAll('.nota-input-massa[data-eval="'+av.id+'"][data-disc="'+discId+'"]');
    let sum=0, n=0, min=10, max=0;
    inputs.forEach(inp => {
      const v = clampNota(inp.value);
      if(v > 0 || inp.value !== '0'){ sum += v; n++; min = Math.min(min, v); max = Math.max(max, v); }
    });
    const avg = n > 0 ? (sum/n).toFixed(1) : '—';
    if(n === 0){ min = 0; max = 0; }
    cols += '<td style="text-align:center;"><span class="massa-col-stat">μ '+avg+' ('+min.toFixed(0)+'–'+max.toFixed(0)+')</span>' +
      '<div class="massa-col-actions"><button class="massa-col-btn" onclick="__massaFillColumn(\''+av.id+'\',\''+discId+'\')" title="Preencher coluna">Preencher</button>' +
      '<button class="massa-col-btn" onclick="__massaSortByCol(\''+av.id+'\')" title="Ordenar">Ordenar</button></div></td>';
  });
  // Media column
  cols += '<td></td>';
  tr.innerHTML = cols;
}

// Feature #7: Progress bar
function __massaUpdateProgress(){
  const el = document.getElementById('massaProgressBar');
  if(!el) return;
  const discId = _massaDiscDefault();
  const disc = getDiscById(discId);
  if(!disc){ el.innerHTML = ''; return; }
  const lista = getAlunosFiltrados();
  if(!lista.length){ el.innerHTML = ''; return; }
  const avs = disc.avaliacoes || [];
  
  let filled = 0, total = 0;
  lista.forEach(a => {
    const b = a?.bimestres?.[bimestreAtual];
    if(!b) return;
    _syncBimestreRefs(b);
    if(!b.notas_disc || !b.notas_disc[discId]) return;
    const notas = b.notas_disc[discId];
    avs.forEach(av => {
      total++;
      const v = notas?.[av.id];
      if(v !== undefined && v !== null && v !== 0 && v !== '0' && v !== '') filled++;
    });
  });
  if(total === 0){ el.innerHTML = ''; return; }
  const pct = Math.round(filled / total * 100);
  const col = pct >= 80 ? '#16a34a' : (pct >= 50 ? '#f59e0b' : '#dc2626');
  el.innerHTML = '<div class="massa-progress-bar"><div style="width:'+pct+'%;background:'+col+';"></div></div>' +
    '<span><b>'+filled+'/'+total+'</b> notas lançadas ('+pct+'%)</span>' +
    '<span style="margin-left:auto;font-size:.72rem;">'+lista.length+' alunos</span>';
}

// Feature #10: Unsaved changes indicator + Feature #9: Auto-save
function marcarModificacao(input){
  notasModificadas=true;
  if(input){
    input.classList.add('massa-modified');
    __massaModifiedInputs.add(input);
    __massaRecalcRowMedia(input);
  }
  // Show unsaved bar
  const bar = document.getElementById('massaUnsavedBar');
  if(bar) bar.classList.add('visible');
  const btn=document.getElementById('btnSalvarMassa');
  if(btn) btn.style.display='flex';
  const btn2=document.getElementById('btnSalvarMassaInline');
  if(btn2) btn2.style.display='flex';
  
  // Auto-save with debounce (4 seconds)
  clearTimeout(__massaAutoSaveTimer);
  __massaAutoSaveTimer = setTimeout(()=>{
    if(notasModificadas) salvarEdicaoMassa(false);
  }, 4000);
}

// Feature #5: Keyboard navigation
function __massaKeyboardNav(e, input){
  const tbody = document.getElementById('tbodyMassa');
  if(!tbody) return;
  const allInputs = Array.from(tbody.querySelectorAll('.nota-input-massa:not([style*="display:none"])'));
  const idx = allInputs.indexOf(input);
  if(idx < 0) return;
  
  const disc = getDiscById(_massaDiscDefault());
  const numCols = disc ? (disc.avaliacoes||[]).length : 1;
  let target = null;
  
  if(e.key === 'Enter'){
    e.preventDefault();
    // Move down in same column
    target = allInputs[idx + numCols];
  } else if(e.key === 'ArrowDown'){
    e.preventDefault();
    target = allInputs[idx + numCols];
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    target = allInputs[idx - numCols];
  } else if(e.key === 'ArrowRight' && input.selectionStart >= input.value.length){
    e.preventDefault();
    target = allInputs[idx + 1];
  } else if(e.key === 'ArrowLeft' && input.selectionStart <= 0){
    e.preventDefault();
    target = allInputs[idx - 1];
  }
  
  if(target){
    target.focus();
    target.select();
  }
}

// Feature #6: Search/filter
function __massaFilterBySearch(){
  const si = document.getElementById('massaSearchInput');
  __massaSearchFilter = (si?.value || '').toLowerCase();
  const tbody = document.getElementById('tbodyMassa');
  if(!tbody) return;
  const rows = tbody.querySelectorAll('tr.row-aluno-massa');
  rows.forEach(tr => {
    const nameTd = tr.querySelector('td:nth-child(2)');
    const name = (nameTd?.textContent || '').toLowerCase();
    tr.style.display = (!__massaSearchFilter || name.includes(__massaSearchFilter)) ? '' : 'none';
  });
}

// Feature #14: Sort by column
function __massaSortByCol(evalId){
  if(__massaSortCol === evalId){
    __massaSortAsc = !__massaSortAsc;
  } else {
    __massaSortCol = evalId;
    __massaSortAsc = true;
  }
  // If modified, save first
  if(notasModificadas) salvarEdicaoMassa(true);
  renderizarEdicaoMassa();
}

// Feature #12: Fill column with value
function __massaFillColumn(evalId, discId){
  let old = document.getElementById('massaFillOverlay');
  if(old) old.remove();
  
  const disc = getDiscById(discId);
  const av = disc ? (disc.avaliacoes||[]).find(a=>a.id===evalId) : null;
  const avName = av?.nome || evalId;
  
  const overlay = document.createElement('div');
  overlay.id = 'massaFillOverlay';
  overlay.className = 'massa-fill-overlay';
  overlay.onclick = function(e){ if(e.target === this) this.remove(); };
  overlay.innerHTML = '<div class="massa-fill-box">' +
    '<h3><i class="fas fa-fill-drip"></i> Preencher "' + escHTML(avName) + '"</h3>' +
    '<p style="font-size:.82rem;color:#64748b;margin:0 0 12px;">Valor será aplicado a todos os alunos visíveis.</p>' +
    '<input type="number" id="massaFillValue" min="0" max="10" step="0.5" placeholder="Nota (0-10)" autofocus>' +
    '<div class="btn-row">' +
      '<button style="padding:8px 16px;border:1px solid var(--border-color);border-radius:8px;background:transparent;cursor:pointer;" onclick="this.closest(\'.massa-fill-overlay\').remove()">Cancelar</button>' +
      '<button style="padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;" onclick="__massaDoFillColumn(\''+evalId+'\',\''+discId+'\')">Aplicar</button>' +
    '</div></div>';
  document.body.appendChild(overlay);
  setTimeout(()=>{ const inp=document.getElementById('massaFillValue'); if(inp) inp.focus(); }, 100);
}

function __massaDoFillColumn(evalId, discId){
  const valInp = document.getElementById('massaFillValue');
  if(!valInp) return;
  const val = clampNota(valInp.value);
  const inputs = document.querySelectorAll('.nota-input-massa[data-eval="'+evalId+'"][data-disc="'+discId+'"]');
  inputs.forEach(inp => {
    const tr = inp.closest('tr');
    if(tr && tr.style.display === 'none') return; // skip hidden (filtered)
    inp.value = val;
    handleNotaInput(inp);
    inp.classList.add('massa-modified');
  });
  marcarModificacao(null);
  // recalc all medias
  document.querySelectorAll('#tbodyMassa .nota-input-massa[data-eval="'+evalId+'"]').forEach(inp => __massaRecalcRowMedia(inp));
  const overlay = document.getElementById('massaFillOverlay');
  if(overlay) overlay.remove();
  showToast('Coluna preenchida com ' + val.toFixed(1));
}

// Feature #11: Paste from spreadsheet
function __massaHandlePaste(e){
  const input = e.target;
  if(!input.classList.contains('nota-input-massa')) return;
  
  const text = (e.clipboardData || window.clipboardData)?.getData('text');
  if(!text || !text.includes('\t') && !text.includes('\n')) return; // not tabular
  
  e.preventDefault();
  const rows = text.trim().split(/\r?\n/).map(r => r.split('\t').map(c => c.trim()));
  if(!rows.length) return;
  
  const tbody = document.getElementById('tbodyMassa');
  if(!tbody) return;
  const disc = getDiscById(_massaDiscDefault());
  if(!disc) return;
  const avs = disc.avaliacoes || [];
  
  // Find starting position
  const allInputs = Array.from(tbody.querySelectorAll('.nota-input-massa'));
  const startIdx = allInputs.indexOf(input);
  if(startIdx < 0) return;
  
  const numCols = avs.length;
  const startCol = startIdx % numCols;
  const startRow = Math.floor(startIdx / numCols);
  
  let count = 0;
  rows.forEach((cells, ri) => {
    cells.forEach((cell, ci) => {
      const targetIdx = (startRow + ri) * numCols + (startCol + ci);
      if(targetIdx < allInputs.length){
        const targetInput = allInputs[targetIdx];
        const val = clampNota(cell.replace(',', '.'));
        targetInput.value = val;
        handleNotaInput(targetInput);
        targetInput.classList.add('massa-modified');
        __massaRecalcRowMedia(targetInput);
        count++;
      }
    });
  });
  
  if(count > 0){
    marcarModificacao(null);
    showToast(count + ' notas coladas com sucesso!');
  }
}

// Feature #15: Import CSV
function __massaImportCSV(){
  let old = document.getElementById('massaImportOverlay');
  if(old) old.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'massaImportOverlay';
  overlay.className = 'massa-fill-overlay';
  overlay.onclick = function(e){ if(e.target === this) this.remove(); };
  overlay.innerHTML = '<div class="massa-fill-box" style="max-width:500px;">' +
    '<h3><i class="fas fa-file-import"></i> Importar CSV</h3>' +
    '<p style="font-size:.8rem;color:#64748b;margin:0 0 10px;">Formato: <code>Nome;Nota1;Nota2;...</code> (separador: <b>;</b> ou <b>,</b> ou <b>Tab</b>)</p>' +
    '<div class="massa-import-zone" id="massaDropZone" onclick="document.getElementById(\'massaFileInput\').click()">' +
      '<i class="fas fa-cloud-upload-alt" style="font-size:1.5rem;color:var(--primary);"></i><br>' +
      'Clique ou arraste um arquivo CSV aqui' +
    '</div>' +
    '<input type="file" id="massaFileInput" accept=".csv,.txt,.tsv" style="display:none;" onchange="__massaProcessCSVFile(this.files[0])">' +
    '<textarea id="massaCSVText" rows="5" placeholder="Ou cole o conteúdo CSV aqui..." style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:8px;font-family:monospace;font-size:.78rem;resize:vertical;margin-bottom:10px;"></textarea>' +
    '<div class="btn-row">' +
      '<button style="padding:8px 16px;border:1px solid var(--border-color);border-radius:8px;background:transparent;cursor:pointer;" onclick="this.closest(\'.massa-fill-overlay\').remove()">Cancelar</button>' +
      '<button style="padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;" onclick="__massaDoImportCSV()">Importar</button>' +
    '</div></div>';
  document.body.appendChild(overlay);
  
  // Drag and drop
  const zone = document.getElementById('massaDropZone');
  if(zone){
    zone.ondragover = function(e){ e.preventDefault(); this.classList.add('dragover'); };
    zone.ondragleave = function(){ this.classList.remove('dragover'); };
    zone.ondrop = function(e){ e.preventDefault(); this.classList.remove('dragover'); if(e.dataTransfer.files.length) __massaProcessCSVFile(e.dataTransfer.files[0]); };
  }
}

function __massaProcessCSVFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const txt = document.getElementById('massaCSVText');
    if(txt) txt.value = e.target.result;
  };
  reader.readAsText(file);
}

function __massaDoImportCSV(){
  const txt = document.getElementById('massaCSVText')?.value;
  if(!txt || !txt.trim()){ showToast('Nenhum conteúdo para importar.', 'error'); return; }
  
  const discId = _massaDiscDefault();
  const disc = getDiscById(discId);
  if(!disc){ showToast('Selecione uma disciplina.', 'error'); return; }
  const avs = disc.avaliacoes || [];
  const lista = getAlunosFiltrados();
  
  // Detect separator
  const firstLine = txt.trim().split(/\r?\n/)[0] || '';
  let sep = ';';
  if(firstLine.includes('\t')) sep = '\t';
  else if(!firstLine.includes(';') && firstLine.includes(',')) sep = ',';
  
  const rows = txt.trim().split(/\r?\n/).map(r => r.split(sep).map(c => c.trim()));
  
  // Try to match by name
  let matched = 0;
  rows.forEach(cells => {
    if(cells.length < 2) return;
    const nome = cells[0].toLowerCase().trim();
    const aluno = lista.find(a => (a.nome||'').toLowerCase().trim() === nome);
    if(!aluno) return;
    
    const b = aluno.bimestres[bimestreAtual];
    _syncBimestreRefs(b);
    if(!b.notas_disc) b.notas_disc = {};
    if(!b.notas_disc[discId]) b.notas_disc[discId] = {};
    
    const notas = cells.slice(1);
    avs.forEach((av, i) => {
      if(i < notas.length && notas[i] !== ''){
        b.notas_disc[discId][av.id] = clampNota(notas[i].replace(',', '.'));
      }
    });
    try{ b.notas_disc[discId].__touched = true; }catch(_){}
    matched++;
  });
  
  if(matched > 0){
    salvarDadosLocal();
    showToast(matched + ' aluno(s) importados com sucesso!');
    renderizarEdicaoMassa();
  } else {
    showToast('Nenhum aluno correspondente encontrado. Verifique os nomes.', 'error');
  }
  
  const overlay = document.getElementById('massaImportOverlay');
  if(overlay) overlay.remove();
}

// Export CSV
function __massaExportCSV(){
  const discId = _massaDiscDefault();
  const disc = getDiscById(discId);
  if(!disc){ showToast('Selecione uma disciplina.', 'error'); return; }
  const avs = disc.avaliacoes || [];
  const lista = getAlunosFiltrados();
  
  let csv = 'Nome;' + avs.map(av => av.nome || av.id).join(';') + ';Média\n';
  lista.forEach(a => {
    const b = a?.bimestres?.[bimestreAtual];
    if(!b) return;
    _syncBimestreRefs(b);
    const notas = b.notas_disc?.[discId] || {};
    const media = calcularMediaDisc(discId, notas);
    csv += (a.nome||'') + ';' + avs.map(av => (notas[av.id]??0)).join(';') + ';' + (isFinite(media)?media.toFixed(1):0) + '\n';
  });
  
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'notas_' + (disc.nome||'disc') + '_' + bimestreAtual + 'bim.csv';
  link.click();
  URL.revokeObjectURL(url);
  showToast('CSV exportado com sucesso!');
}

// Enhanced header (sorting removed per preference)
function _renderMassaHeader(discId){
  const tr=document.getElementById('trMassaHead');
  if(!tr) return;
  ensureConfigSchema();
  const id = discId || _massaDiscDefault();
  const disc = getDiscById(id);

  const cols=[];
  cols.push('<th>#</th><th>Nome</th><th>Turma</th>');

  if(disc){
    const cls = (id===config.slot1) ? 'lbl-mat1' : (id===config.slot2) ? 'lbl-mat2' : '';
    (disc.avaliacoes||[]).forEach(av=>{
      cols.push('<th class="'+cls+'">'+_escHTML(String(av.nome||'')).slice(0,22)+'</th>');
    });
    cols.push('<th class="'+cls+'">Média</th>');
  } else {
    cols.push('<th>Notas</th>');
  }
  tr.innerHTML = cols.join('');
}

function renderizarEdicaoMassa(){
  ensureConfigSchema();
  // Sorting UI removed: ensure no hidden sort state persists
  __massaSortCol = null; __massaSortAsc = true;
  massaRenderDiscNav();
  
  const tbody=document.getElementById('tbodyMassa');
  let lista=getAlunosFiltrados();
  const discId = _massaDiscDefault();
  const disc = getDiscById(discId);
  
  _renderMassaHeader(discId);
  
  const ttl = document.getElementById('massaDiscTitle');
  if(ttl){
    ttl.innerHTML = disc
      ? '<i class="fas fa-tag"></i> Disciplina: <strong>'+_escHTML(disc.nome||'')+'</strong> • <i class="fas fa-calendar"></i> '+bimestreAtual+'º bimestre • <small style="color:#94a3b8;">Dica: Cole dados do Excel com Ctrl+V</small>'
      : '<i class="fas fa-tag"></i> Disciplina não encontrada • <i class="fas fa-calendar"></i> '+bimestreAtual+'º bimestre';
  }
  
  if(!tbody) return;
  if(!lista || lista.length===0){
    tbody.innerHTML = '<tr><td colspan="50" style="text-align:center; padding:20px;">Selecione uma turma ou nenhum aluno encontrado</td></tr>';
    return;
  }
  if(!disc){
    tbody.innerHTML = '<tr><td colspan="50" style="text-align:center; padding:20px;">Nenhuma disciplina encontrada. Vá em Configurações e crie pelo menos uma disciplina.</td></tr>';
    return;
  }
  
  // Feature #14: Sort
  if(__massaSortCol){
    lista = lista.slice().sort((a, b) => {
      const ba = a.bimestres[bimestreAtual] || {};
      const bb = b.bimestres[bimestreAtual] || {};
      _syncBimestreRefs(ba); _syncBimestreRefs(bb);
      let va, vb;
      if(__massaSortCol === '__nome__'){
        va = (a.nome||'').toLowerCase(); vb = (b.nome||'').toLowerCase();
        return __massaSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
      } else if(__massaSortCol === '__media__'){
        const na = ba.notas_disc?.[discId] || {};
        const nb = bb.notas_disc?.[discId] || {};
        va = calcularMediaDisc(discId, na);
        vb = calcularMediaDisc(discId, nb);
      } else {
        va = clampNota(ba.notas_disc?.[discId]?.[__massaSortCol]);
        vb = clampNota(bb.notas_disc?.[discId]?.[__massaSortCol]);
      }
      return __massaSortAsc ? (va - vb) : (vb - va);
    });
  }
  
  const avs = disc.avaliacoes || [];
  let buf='';
  lista.forEach((a, idx)=>{
    const b=a.bimestres[bimestreAtual];
    _syncBimestreRefs(b);
    if(!b.notas_disc || typeof b.notas_disc !== 'object') b.notas_disc = {};
    if(!b.notas_disc[discId]) b.notas_disc[discId] = {};
    const notas = b.notas_disc[discId];
    avs.forEach(av => { if(typeof notas[av.id] === 'undefined') notas[av.id] = 0; });
    
    const media = calcularMediaDisc(discId, notas);
    const cor = getCorFarol(media);
    
    // Feature #8: highlight empty/zero
    const hasAnyFilled = avs.some(av => {
      const v = notas?.[av.id]; return v !== undefined && v !== null && v !== 0 && v !== '0';
    });
    
    buf += '<tr class="row-aluno-massa" data-nome="'+_escHTML((a.nome||'').toLowerCase())+'">' +
      '<td>'+(idx+1)+'</td>' +
      '<td class="massa-td-nome"><div class="massa-nome" title="'+_escHTML(String(a.nome||'').replace(/\s+/g,' ').trim())+'">'+(privacyMode ? '••••••••' : _escHTML(String(a.nome||'').replace(/\s+/g,' ').trim()))+'</div></td>' +
      '<td>'+_escHTML(a.turma)+'</td>';
    
    avs.forEach(av=>{
      const v=(notas?.[av.id] ?? 0);
      const emptyClass = (!hasAnyFilled || v === 0) ? ' massa-empty' : '';
      buf += '<td><input type="number" class="nota-input-massa'+emptyClass+'" data-aluno="'+__u(a.id)+'" data-disc="'+discId+'" data-eval="'+__u(av.id)+'" value="'+v+'" min="0" max="10" step="0.5" data-oninput="handleNotaInput(this); marcarModificacao(this)" onkeydown="__massaKeyboardNav(event, this)" onpaste="__massaHandlePaste(event)"></td>';
    });
    
    buf += '<td><strong style="color:'+cor+'">'+(isFinite(media) ? media.toFixed(1) : media)+'</strong></td></tr>';
  });
  
  tbody.innerHTML = buf;
  tbody.querySelectorAll('.nota-input-massa').forEach(inp=>handleNotaInput(inp));
  
  // Reset unsaved state
  const bar = document.getElementById('massaUnsavedBar');
  if(bar && !notasModificadas) bar.classList.remove('visible');
  
  // Update progress & stats
  __massaUpdateProgress();
  __massaUpdateColStats();
  
  // Re-apply search filter
  if(__massaSearchFilter){
    const si = document.getElementById('massaSearchInput');
    if(si) si.value = __massaSearchFilter;
    __massaFilterBySearch();
  }
}

function salvarEdicaoMassa(silent){
  ensureConfigSchema();
  const inputs=document.querySelectorAll('.nota-input-massa');
  if(!inputs || inputs.length===0) return;
  
  clearTimeout(__massaAutoSaveTimer);
  
  const alunoMap = new Map();
  alunos.forEach(a => alunoMap.set(a.id, a));
  const changes = new Map();
  
  inputs.forEach(inp=>{
    const alunoId=parseFloat(inp.dataset.aluno);
    const discId=inp.dataset.disc;
    const evalId=inp.dataset.eval;
    handleNotaInput(inp);
    const valor=clampNota(inp.value);
    if(!changes.has(alunoId)) changes.set(alunoId, {});
    const perAluno = changes.get(alunoId);
    if(!perAluno[discId]) perAluno[discId] = {};
    perAluno[discId][evalId] = valor;
  });
  
  changes.forEach((discMap, alunoId)=>{
    const aluno=alunoMap.get(alunoId);
    if(!aluno) return;
    const b=aluno.bimestres[bimestreAtual];
    if(!b.notas_disc || typeof b.notas_disc !== 'object') b.notas_disc = {};
    Object.keys(discMap).forEach(discId=>{
      if(!b.notas_disc[discId]) b.notas_disc[discId] = {};
      try{ b.notas_disc[discId].__touched = true; }catch(_){ }
      const evs = discMap[discId];
      Object.keys(evs).forEach(evId=>{ b.notas_disc[discId][evId] = evs[evId]; });
    });
    _syncBimestreRefs(b);
    b.media_lp = calcularMediaLPIndividual(b.notas_lp, b.notas_lp?.rec);
    b.media_red = calcularMediaRED(b.notas_red);
    try{
      const d2id = config.slot2;
      if(d2id && b.notas_disc[d2id]){
        if(!b.entregas_red) b.entregas_red = {};
        const _rn = b.notas_disc[d2id];
        if(parseFloat(_rn['r1']||0) > 0 && _migrateEntregaStatus(b.entregas_red.r1) !== 'entregue') b.entregas_red.r1 = 'entregue';
        if(parseFloat(_rn['r2']||0) > 0 && _migrateEntregaStatus(b.entregas_red.r2) !== 'entregue') b.entregas_red.r2 = 'entregue';
      }
    }catch(_){}
  });
  
  salvarDadosLocal();
  notasModificadas=false;
  
  // Visual feedback
  const bar = document.getElementById('massaUnsavedBar');
  if(bar) bar.classList.remove('visible');
  const btn=document.getElementById('btnSalvarMassa');
  if(btn) btn.style.display='none';
  const btn2=document.getElementById('btnSalvarMassaInline');
  if(btn2) btn2.style.display='none';
  
  // Flash saved inputs
  __massaModifiedInputs.forEach(inp => {
    try{
      inp.classList.remove('massa-modified');
      inp.classList.add('massa-just-saved');
      setTimeout(()=> inp.classList.remove('massa-just-saved'), 600);
    }catch(_){}
  });
  __massaModifiedInputs.clear();
  
  if(!silent) showToast("Todas as notas foram salvas com sucesso!");
  __massaUpdateProgress();
  __massaUpdateColStats();
}


/* === Mapa de Sala: Tela Cheia === */
function mapaToggleFullscreen(){
  const el = document.getElementById('viewMapa') || document.documentElement;
  const btn = document.getElementById('btnMapaFullscreen');
  const fsEl = document.fullscreenElement;
  const isFsOnMapa = !!(fsEl && (fsEl===el || el.contains(fsEl)));
  if(fsEl && !isFsOnMapa){
    const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
    if(exit) { try{ exit.call(document); }catch(_){} }
  }
  const isFs = !!document.fullscreenElement && isFsOnMapa;
  if(!isFs){
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
    if(req){
      try{ req.call(el); }catch(_){ document.body.classList.add('mapa-fs-fallback'); el.classList.add('act-fullscreen'); }
    }else{
      document.body.classList.add('mapa-fs-fallback'); el.classList.add('act-fullscreen');
    }
  }else{
    const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
    if(exit){ try{ exit.call(document); }catch(_){} }
    document.body.classList.remove('mapa-fs-fallback');
    el.classList.remove('act-fullscreen');
  }
  setTimeout(mapaUpdateFullscreenUI, 60);
}

function mapaUpdateFullscreenUI(){
  const el = document.getElementById('viewMapa');
  if(!el) return;
  const fsEl = document.fullscreenElement;
  const isFs = !!(fsEl && (fsEl===el || el.contains(fsEl))) || document.body.classList.contains('mapa-fs-fallback');
  el.classList.toggle('act-fullscreen', isFs);
  const btn = document.getElementById('btnMapaFullscreen');
  if(btn){
    btn.innerHTML = isFs ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
    btn.title = isFs ? 'Sair da tela cheia' : 'Tela cheia';
  }
}

if(!window.__MAPA_FS_LISTENER){
  window.__MAPA_FS_LISTENER = true;
  document.addEventListener('fullscreenchange', mapaUpdateFullscreenUI);
  document.addEventListener('webkitfullscreenchange', mapaUpdateFullscreenUI);
  document.addEventListener('mozfullscreenchange', mapaUpdateFullscreenUI);
  document.addEventListener('MSFullscreenChange', mapaUpdateFullscreenUI);
}


/* ======= LABELS ======= */
function atualizarLabelsConfig(){
  ensureConfigSchema();
  document.querySelectorAll('.lbl-mat1').forEach(e => e.innerText = config.materia1);
  document.querySelectorAll('.lbl-mat2').forEach(e => e.innerText = config.materia2);
  _renderMassaHeader(_massaDiscDefault());
}

/* ======= IMPRESSÃO (dinâmica) ======= */
function imprimirFicha(){
  if(!alunoEdicaoID) return;
  abrirBoletim(alunoEdicaoID);
}

/* ======= ESTRUTURA (override) ======= */
function garantirEstruturaNova(){
  let s=false;
  if(!aulas){aulas=[];s=true;}

  ensureConfigSchema();

  const makeNotesForDisc = (disc) => {
    const o={};
    (disc?.avaliacoes||[]).forEach(av => { o[av.id]=0; });
    return o;
  };

  alunos.forEach(a=>{
    if(typeof a.elegivel==='undefined'){a.elegivel=false;a.laudo="";a.adaptacoes=[];a.pei_texto="";s=true;}
    if(!a.bimestres){
      a.bimestres={};
      [1,2,3,4,5,6,7].forEach(i=>{
        const d1=getDiscById(config.slot1);
        const d2=getDiscById(config.slot2);
        const notas_disc = {};
        if(d1) notas_disc[d1.id] = makeNotesForDisc(d1);
        if(d2) notas_disc[d2.id] = makeNotesForDisc(d2);

        a.bimestres[i]={
          notas_disc,
          notas_lp: d1 ? notas_disc[d1.id] : {},
          media_lp:"0.0",
          notas_red: d2 ? notas_disc[d2.id] : {},
          media_red:"0.0",
          entregas_red:{r1:'pendente',r2:'pendente'},
          livro:"",
          status_livro:"Pendente",
          comportamento:10,
          ocorrencias:[],
          parecer:""
        };
      });
      s=true;
    }

    [1,2,3,4,5,6,7].forEach(i=>{
      const b=a.bimestres[i];
      if(!b) return;

      if(typeof b.livro === 'undefined') { b.livro=""; b.status_livro="Pendente"; s=true; }

      if(!b.notas_disc || typeof b.notas_disc !== 'object'){
        b.notas_disc = {};
        if(b.notas_lp)  b.notas_disc['lp']  = b.notas_lp;
        if(b.notas_red) b.notas_disc['red'] = b.notas_red;
        s=true;
      }

      _syncBimestreRefs(b);

      b.media_lp  = calcularMediaLPIndividual(b.notas_lp, b.notas_lp?.rec);
      b.media_red = calcularMediaRED(b.notas_red);
    });
  });

  if(aulas.length > 0) {
    aulas.forEach(a => { 
      if(!a.tipo) { a.tipo = 'aula'; s=true; } 
      if(typeof a.bncc === 'undefined') { a.bncc = ''; s=true; } 
    });
  }

  if(typeof config.rec_substitui === 'undefined') { config.rec_substitui = false; s=true; }

  if(s) salvarDadosLocal();
}

// Garantia extra em execuções já em andamento
try { ensureConfigSchema(); _syncAllStudents(); } catch(e) {}



/* ============================================================
   Tema (Cores) + Histórico (Undo/Redo) + Log + Backups Automáticos
   (Adições solicitadas – sem alterar a tela inicial)
   ============================================================ */

const __THEME_PRESETS = {
  "Azul":  { primary:"#2563eb", secondary:"#1e40af", bg:"#f8fafc", card:"#ffffff", text:"#334155" },
  "Verde": { primary:"#16a34a", secondary:"#166534", bg:"#f8fafc", card:"#ffffff", text:"#334155" },
  "Roxo":  { primary:"#7c3aed", secondary:"#5b21b6", bg:"#f8fafc", card:"#ffffff", text:"#334155" },
  "Preto": { primary:"#0f172a", secondary:"#334155", bg:"#0b1220", card:"#0f172a", text:"#e2e8f0" },
  "Personalizado": { primary:"#2563eb", secondary:"#1e40af", bg:"#f8fafc", card:"#ffffff", text:"#334155" }
};

function __normHex(v, fallback){
  if(!v) return fallback;
  const s=String(v).trim();
  if(/^#[0-9a-fA-F]{6}$/.test(s)) return s;
  return fallback;
}

function __getThemeColors(theme){
  const presetName = (theme && theme.preset) ? String(theme.preset) : "Azul";
  if(presetName !== "Personalizado"){
    const base = __THEME_PRESETS[presetName] || __THEME_PRESETS["Azul"];
    return {...base};
  }
  const c = (theme && theme.cores && typeof theme.cores==='object') ? theme.cores : {};
  const d = __THEME_PRESETS["Azul"];
  return {
    primary: __normHex(c.primary, d.primary),
    secondary: __normHex(c.secondary, d.secondary),
    bg: __normHex(c.bg, d.bg),
    card: __normHex(c.card, d.card),
    text: __normHex(c.text, d.text)
  };
}

function __applyThemeColors(colors){
  const root=document.documentElement;
  root.style.setProperty('--primary', colors.primary);
  root.style.setProperty('--primary-dark', colors.secondary);
  root.style.setProperty('--bg-body', colors.bg);
  root.style.setProperty('--card-bg', colors.card);
  root.style.setProperty('--text-main', colors.text);
}

function applyThemeFromConfig(){
  try{
    ensureConfigSchema();
    const colors = __getThemeColors(config.tema);
    __applyThemeColors(colors);
  }catch(e){
    // silencioso
  }
}

function _renderTemaConfig(){
  const sel=document.getElementById('cfgThemePreset');
  const iP=document.getElementById('cfgTheme_primary');
  const iS=document.getElementById('cfgTheme_secondary');
  const iB=document.getElementById('cfgTheme_bg');
  const iC=document.getElementById('cfgTheme_card');
  const iT=document.getElementById('cfgTheme_text');
  if(!sel || !iP || !iS || !iB || !iC || !iT) return;

  // garante estrutura no draft
  if(!__cfgDraft.tema || typeof __cfgDraft.tema!=='object'){
    __cfgDraft.tema = { preset:'Azul', cores:{...__THEME_PRESETS["Azul"]} };
  }
  if(!__cfgDraft.tema.preset) __cfgDraft.tema.preset='Azul';
  if(!__cfgDraft.tema.cores || typeof __cfgDraft.tema.cores!=='object'){
    __cfgDraft.tema.cores = {...__THEME_PRESETS["Azul"]};
  }

  // popula select (uma vez)
  if(sel.options.length===0){
    Object.keys(__THEME_PRESETS).forEach(name=>{
      const opt=document.createElement('option');
      opt.value=name;
      opt.textContent=name;
      sel.appendChild(opt);
    });
  }

  const preset = String(__cfgDraft.tema.preset || 'Azul');
  sel.value = __THEME_PRESETS[preset] ? preset : 'Azul';

  const colors = __getThemeColors(__cfgDraft.tema);
  iP.value = colors.primary;
  iS.value = colors.secondary;
  iB.value = colors.bg;
  iC.value = colors.card;
  iT.value = colors.text;

  const isCustom = (sel.value === 'Personalizado');
  [iP,iS,iB,iC,iT].forEach(inp=>inp.disabled = !isCustom);

  sel.onchange = ()=>{
    const val = sel.value;
    __cfgDraft.tema.preset = val;
    if(val !== 'Personalizado'){
      __cfgDraft.tema.cores = {...(__THEME_PRESETS[val] || __THEME_PRESETS["Azul"])};
    }
    const c2 = __getThemeColors(__cfgDraft.tema);
    iP.value=c2.primary; iS.value=c2.secondary; iB.value=c2.bg; iC.value=c2.card; iT.value=c2.text;
    const customNow = (val==='Personalizado');
    [iP,iS,iB,iC,iT].forEach(inp=>inp.disabled = !customNow);
    // prévia imediata sem afetar a tela inicial
    __applyThemeColors(c2);
  };

  function onCustomChange(){
    __cfgDraft.tema.preset = 'Personalizado';
    sel.value = 'Personalizado';
    __cfgDraft.tema.cores = {
      primary: iP.value,
      secondary: iS.value,
      bg: iB.value,
      card: iC.value,
      text: iT.value
    };
    __applyThemeColors(__getThemeColors(__cfgDraft.tema));
  }

  iP.oninput=onCustomChange;
  iS.oninput=onCustomChange;
  iB.oninput=onCustomChange;
  iC.oninput=onCustomChange;
  iT.oninput=onCustomChange;
}

/* ==========================
   Histórico / Undo / Redo
   ========================== */

const __HIST = {
  max: 50,
  undo: [],
  redo: [],
  lastSnapshot: null,
  mute: false
};

let __AUDIT = [];
let __BACKUPS = [];
let __lastBackupAt = 0;

function __snapshotObj(){
  // inclui tudo o que o usuário precisa recuperar
  return {
    turmas, alunos, aulas,
    planosSemana,
    config, layouts,
    correcaoProvas: (typeof correcaoProvas !== 'undefined' && correcaoProvas) ? correcaoProvas : {},
    planner: (typeof plannerTasks !== 'undefined') ? (plannerTasks || []) : [],
    atividades: {
      forca: (typeof forcaBank !== 'undefined') ? (forcaBank || []) : [],
      vf: (typeof vfBank !== 'undefined') ? (vfBank || []) : [],
      memoria: (typeof memBank !== 'undefined') ? (memBank || []) : [],
      flashcards: (typeof fcBank !== 'undefined') ? (fcBank || []) : []
    }
  };
}
function __snapshotStr(){
  try { return JSON.stringify(__snapshotObj()); } catch(e){ return null; }
}

function __loadExtras(){
  try{
    __AUDIT = JSON.parse(localStorage.getItem('sgp_audit') || '[]') || [];
  }catch(e){ __AUDIT = []; }
  try{
    __BACKUPS = JSON.parse(localStorage.getItem('sgp_autobackups') || '[]') || [];
  }catch(e){ __BACKUPS = []; }
  try{
    __lastBackupAt = parseInt(localStorage.getItem('sgp_lastBackupAt') || '0', 10) || 0;
  }catch(e){ __lastBackupAt = 0; }
}

function __saveExtras(){
  __safeLSSet('sgp_audit', JSON.stringify(__AUDIT));
  __safeLSSet('sgp_autobackups', JSON.stringify(__BACKUPS));
  __safeLSSet('sgp_lastBackupAt', String(__lastBackupAt||0));
}
function __countChangedAlunos(beforeArr, afterArr){
  try{
    const mapB=new Map((beforeArr||[]).map(a=>[a.id, JSON.stringify(a)]));
    let changed=0;
    (afterArr||[]).forEach(a=>{
      const s=JSON.stringify(a);
      if(mapB.get(a.id)!==s) changed++;
    });
    return changed;
  }catch(e){
    return null;
  }
}

function __logChange(beforeStr, afterStr){
  const ts = Date.now();
  let changed=null;
  try{
    const b=JSON.parse(beforeStr||'{}');
    const a=JSON.parse(afterStr||'{}');
    changed = __countChangedAlunos(b.alunos, a.alunos);
  }catch(e){}
  const msg = (changed===null)
    ? "Alteração salva"
    : `Alteração salva (${changed} aluno(s) alterado(s))`;
  __AUDIT.push({ ts, msg });
  if(__AUDIT.length > 500) __AUDIT.shift();
}

function __maybeAutoBackup(snapshotStr){
  const now = Date.now();
  const INTERVAL = 5 * 60 * 1000; // 5 min
  if(!snapshotStr) return;
  if(now - (__lastBackupAt||0) < INTERVAL) return;

  __BACKUPS.unshift({ id: 'bkp_'+now, ts: now, snapshot: snapshotStr });
  __BACKUPS = __BACKUPS.slice(0, 10);
  __lastBackupAt = now;
}

function __renderBackupsUI(){
  const box=document.getElementById('cfgBackupsList');
  const info=document.getElementById('cfgAuditInfo');
  if(info){
    const u=__HIST.undo.length, r=__HIST.redo.length;
    const a=__AUDIT.length, b=__BACKUPS.length;
    info.innerHTML = `Histórico: <strong>${u}</strong> / Refazer: <strong>${r}</strong> • Log: <strong>${a}</strong> • Backups: <strong>${b}</strong>`;
  }
  if(!box) return;

  if(!__BACKUPS.length){
    box.innerHTML = `<div style="font-size:0.85rem; color:#64748b;">Nenhum backup ainda.</div>`;
    return;
  }

  const fmt = (t)=>{
    const d=new Date(t);
    return d.toLocaleString('pt-BR');
  };

  let html = '';
  __BACKUPS.forEach((bkp, idx)=>{
    html += `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 6px; border-bottom:1px solid var(--border-color);">
        <div style="font-size:0.9rem;">
          <strong>#${idx+1}</strong> • ${fmt(bkp.ts)}
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn-secondary" style="padding:6px 10px;" data-onclick="restaurarBackup('${__u(bkp.id)}')"><i class="fas fa-rotate-left"></i></button>
          <button class="btn-secondary" style="padding:6px 10px;" data-onclick="excluirBackup('${__u(bkp.id)}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>`;
  });

  box.innerHTML = html;
}

function _renderHistoricoConfig(){
  __renderBackupsUI();
}

function __applySnapshot(snapshotStr, label){
  if(!snapshotStr) return;
  let data=null;
  try{ data=JSON.parse(snapshotStr); }catch(e){ return showToast("Snapshot inválido.", "error"); }

  __HIST.mute = true;
  try{
    turmas = data.turmas || [];
    alunos = data.alunos || [];
    aulas = data.aulas || [];
    planosSemana = data.planosSemana || data.planos_semanais || {};
    config = data.config || config;
    layouts = data.layouts || layouts;

    // Planner
    if(typeof data.planner !== 'undefined') plannerTasks = Array.isArray(data.planner) ? data.planner : (data.planner?.tasks || []);
    else if(typeof data.plannerTasks !== 'undefined') plannerTasks = Array.isArray(data.plannerTasks) ? data.plannerTasks : [];
    else plannerTasks = (typeof plannerTasks !== 'undefined') ? (plannerTasks || []) : [];
    try{ plannerTasks = plannerNormalizeTasks(plannerTasks); }catch(e){}

    // Atividades (bancos)
    const acts = data.atividades || {};
    if(typeof forcaBank !== 'undefined') forcaBank = Array.isArray(acts.forca) ? acts.forca : (forcaBank || []);
    if(typeof vfBank !== 'undefined') vfBank = Array.isArray(acts.vf) ? acts.vf : (vfBank || []);
    if(typeof memBank !== 'undefined') memBank = Array.isArray(acts.memoria) ? acts.memoria : (memBank || []);
    if(typeof fcBank !== 'undefined') fcBank = Array.isArray(acts.flashcards) ? acts.flashcards : (fcBank || []);

    // Correção de provas
    if(data.correcaoProvas && typeof data.correcaoProvas === 'object' && !Array.isArray(data.correcaoProvas)){
      correcaoProvas = data.correcaoProvas;
      try{ corSave(); }catch(_){}
    }

    ensureConfigSchema();
    _syncAllStudents();

    // persiste no storage usando o mesmo formato do app
    salvarDadosLocal();
    try{ __safeLSSet('sgp_planner', JSON.stringify(plannerTasks || [])); }catch(e){}

    try{
      if(typeof ACT_STORAGE !== 'undefined'){
        __safeLSSet(ACT_STORAGE.forca, JSON.stringify(forcaBank || []));
        __safeLSSet(ACT_STORAGE.vf, JSON.stringify(vfBank || []));
        __safeLSSet(ACT_STORAGE.mem, JSON.stringify(memBank || []));
        __safeLSSet(ACT_STORAGE.fc, JSON.stringify(fcBank || []));
      }
    }catch(e){}

    __HIST.lastSnapshot = __snapshotStr();
  }finally{
    __HIST.mute = false;
  }

  applyThemeFromConfig();
  fecharModais();
  renderizarMenu();
  renderizarVisao();
  renderizarVisaoContent();
  showToast(label || "Restaurado!");
  __renderBackupsUI();
}

// [REMOVED] Old undo/redo using __HIST - replaced by atomic undo/redo system (see below)

function criarBackupAgora(){
  const snap = __snapshotStr();
  const now = Date.now();
  if(!snap) return showToast("Não foi possível criar backup.", "error");
  __BACKUPS.unshift({ id: 'bkp_'+now, ts: now, snapshot: snap });
  __BACKUPS = __BACKUPS.slice(0, 10);
  __lastBackupAt = now;
  __saveExtras();
  __renderBackupsUI();
  showToast("Backup criado!");
}

function restaurarUltimoBackup(){
  if(!__BACKUPS.length) return showToast("Sem backups.");
  __applySnapshot(__BACKUPS[0].snapshot, "Backup restaurado!");
}

function restaurarBackup(id){
  const b = __BACKUPS.find(x=>x.id===id);
  if(!b) return showToast("Backup não encontrado.", "error");
  __applySnapshot(b.snapshot, "Backup restaurado!");
}

function excluirBackup(id){
  __BACKUPS = __BACKUPS.filter(x=>x.id!==id);
  __saveExtras();
  __renderBackupsUI();
  showToast("Backup removido.");
}

function baixarLog(){
  try{
    const data = JSON.stringify(__AUDIT, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const d = new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    a.download = `sgp_log_${yyyy}-${mm}-${dd}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }catch(e){
    showToast("Não foi possível baixar o log.", "error");
  }
}


// === Hooks (substitui monkey-patch de funções globais) ===

// Após salvar no localStorage: registra undo/redo, log e auto-backup
__SGP_EVT.on('afterSave', ()=>{
  try{
    if(typeof __HIST !== 'object' || !__HIST) return;
    if(__HIST.mute) return;
    if(typeof __snapshotStr !== 'function') return;

    const after = __snapshotStr();
    if(!after) return;

    if(!__HIST.lastSnapshot){
      __HIST.lastSnapshot = after;
      return;
    }
    if(after === __HIST.lastSnapshot) return;

    const before = __HIST.lastSnapshot;

    __HIST.undo.push({ ts: Date.now(), before, after });
    if(__HIST.undo.length > __HIST.max) __HIST.undo.shift();
    __HIST.redo = [];
    __HIST.lastSnapshot = after;

    try{ if(typeof __logChange === 'function') __logChange(before, after); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'__logChange'); }catch(_){} }
    try{ if(typeof __maybeAutoBackup === 'function') __maybeAutoBackup(after); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'__maybeAutoBackup'); }catch(_){} }
    try{ if(typeof __saveExtras === 'function') __saveExtras(); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'__saveExtras'); }catch(_){} }
    try{ if(typeof __renderBackupsUI === 'function') __renderBackupsUI(); }catch(_){}
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e,'afterSave'); }catch(_){}
  }
});

// Ao fechar modais: garante restauração de tema e UI de Bloom
__SGP_EVT.on('afterCloseModals', ()=>{
  try{ if(typeof applyThemeFromConfig === 'function') applyThemeFromConfig(); }catch(_){}
  try{ if(typeof __initBloomUI === 'function') __initBloomUI(); }catch(_){}
});
/* === DIAGNÓSTICO (v12.9) — Health Check + Safety + Testes === */
const __DIAG = {
  errors: [],
  lastTests: null,
  lastTestsTs: null,
  notifiedOnce: false,
};

function __diagTS(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString('pt-BR');
  }catch(e){
    return String(ts||'');
  }
}

function __diagCapture(err, context, extra){
  try{
    const e = (err && err.reason) ? err.reason : err;
    const msg = (e && e.message) ? e.message : (typeof e === 'string' ? e : 'Erro desconhecido');
    const stack = (e && e.stack) ? String(e.stack) : '';
    const rec = {
      ts: Date.now(),
      context: context || 'runtime',
      message: msg,
      stack,
      extra: extra || null
    };
    __DIAG.errors.unshift(rec);
    if(__DIAG.errors.length > 60) __DIAG.errors.pop();

    // aviso discreto (apenas 1x por sessão)
    if(!__DIAG.notifiedOnce && typeof showToast === 'function'){
      __DIAG.notifiedOnce = true;
      showToast("Erro interno detectado. Abra Configurações > Diagnóstico para detalhes.", "error");
    }

    _renderDiagnosticoConfig();
  }catch(_){
    // não faz nada: diagnóstico nunca pode quebrar o app
  }
}

(function __installGlobalDiag(){
  window.addEventListener('error', function(ev){
    try{
      __diagCapture(ev.error || ev.message || ev, 'window.error', {
        file: ev.filename,
        line: ev.lineno,
        col: ev.colno
      });
      // log leve (sem poluir)
      try{
        if(typeof __AUDIT !== 'undefined' && Array.isArray(__AUDIT)){
          __AUDIT.push({ ts: Date.now(), msg: "Erro capturado (window.error): " + String(ev.message||'') });
          if(__AUDIT.length > 500) __AUDIT.shift();
        }
      }catch(_){}
      try{ if(typeof __renderDiagnosticoPainel==='function') __renderDiagnosticoPainel(true); }catch(_){}
    }catch(_){}
  }, true);

  window.addEventListener('unhandledrejection', function(ev){
    try{
      __diagCapture(ev.reason || ev, 'unhandledrejection');
      try{
        if(typeof __AUDIT !== 'undefined' && Array.isArray(__AUDIT)){
          __AUDIT.push({ ts: Date.now(), msg: "Promise rejeitada (unhandledrejection)" });
          if(__AUDIT.length > 500) __AUDIT.shift();
        }
      }catch(_){}
      try{ if(typeof __renderDiagnosticoPainel==='function') __renderDiagnosticoPainel(true); }catch(_){}
    }catch(_){}
  }, true);
})();

function _renderDiagnosticoConfig(){
  const boxStatus = document.getElementById('cfgDiagStatus');
  const boxErr = document.getElementById('cfgDiagErrors');
  const boxTests = document.getElementById('cfgDiagTests');
  if(!boxStatus || !boxErr || !boxTests) return;

  const errCount = (__DIAG.errors || []).length;
  const lastTs = __DIAG.lastTestsTs ? __diagTS(__DIAG.lastTestsTs) : '—';
  boxStatus.innerHTML = `
    <div><strong>Erros nesta sessão:</strong> ${errCount} &nbsp;•&nbsp; <strong>Últimos testes:</strong> ${lastTs}</div>
    <div style="margin-top:4px; font-size:0.85rem; color:#94a3b8;">Se algum botão parar de responder, copie o relatório e me envie.</div>
  `;

  if(errCount === 0){
    boxErr.innerHTML = `<div style="font-size:0.85rem; color:#64748b;">Sem registros de erro nesta sessão.</div>`;
  } else {
    boxErr.innerHTML = (__DIAG.errors || []).slice(0, 25).map((r,i)=>`
      <div style="border-bottom:1px dashed var(--border-color); padding:8px 0;">
        <div style="display:flex; justify-content:space-between; gap:10px;">
          <strong style="color:var(--text-main);">${_escHTML(r.context || 'erro')}</strong>
          <span style="font-size:0.8rem; color:#64748b;">${__diagTS(r.ts)}</span>
        </div>
        <div style="margin-top:4px; font-size:0.9rem; color:#b91c1c;">${_escHTML(r.message || '')}</div>
        ${r.extra ? `<div style="margin-top:3px; font-size:0.8rem; color:#64748b;">${_escHTML(JSON.stringify(r.extra))}</div>` : ``}
        ${r.stack ? `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:0.85rem;">Detalhes</summary><pre style="white-space:pre-wrap; font-size:0.75rem; margin-top:6px;">${_escHTML(r.stack)}</pre></details>` : ``}
      </div>
    `).join('');
  }

  if(!__DIAG.lastTests){
    boxTests.innerHTML = `<div style="font-size:0.85rem; color:#64748b;">Nenhum teste executado ainda.</div>`;
  } else {
    const res = __DIAG.lastTests;
    const items = (res.items || []);
    const badge = (lvl)=>{
      if(lvl==='error') return `<span style="padding:2px 8px; border-radius:999px; background:#fee2e2; color:#991b1b; font-size:0.75rem;">ERRO</span>`;
      if(lvl==='warn')  return `<span style="padding:2px 8px; border-radius:999px; background:#fef9c3; color:#854d0e; font-size:0.75rem;">AVISO</span>`;
      return `<span style="padding:2px 8px; border-radius:999px; background:#dcfce7; color:#166534; font-size:0.75rem;">OK</span>`;
    };
    boxTests.innerHTML = `
      <div style="margin-bottom:10px;">
        <strong>Resumo:</strong> ${res.summary || ''}<br>
        <span style="font-size:0.85rem; color:#64748b;">Erros: ${res.counts?.error||0} • Avisos: ${res.counts?.warn||0} • OK: ${res.counts?.ok||0}</span>
      </div>
      ${items.map(it=>`
        <div style="border-bottom:1px dashed var(--border-color); padding:8px 0;">
          <div style="display:flex; align-items:center; gap:10px;">
            ${badge(it.level)}
            <strong style="color:var(--text-main);">${_escHTML(it.title||'')}</strong>
          </div>
          ${it.detail ? `<div style="margin-top:4px; font-size:0.9rem; color:#475569;">${_escHTML(it.detail)}</div>` : ``}
        </div>
      `).join('')}
    `;
  }
}

function diagLimpar(){
  __DIAG.errors = [];
  __DIAG.lastTests = null;
  __DIAG.lastTestsTs = null;
  __DIAG.notifiedOnce = false;
  _renderDiagnosticoConfig();
  if(typeof showToast === 'function') showToast("Diagnóstico limpo.", "success");
}

/* === Painel de Diagnóstico (atalho + modal único) === */
function __estimateLocalStorageUsage(){
  try{
    let total = 0;
    const keys = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      const v = localStorage.getItem(k) || '';
      const bytes = (k.length + v.length) * 2; // aproximado UTF-16
      total += bytes;
      keys.push({ key: k, bytes });
    }
    keys.sort((a,b)=>b.bytes-a.bytes);
    return {
      totalBytes: total,
      totalKB: Math.round(total/1024),
      topKeys: keys.slice(0, 12)
    };
  }catch(e){
    return { error: (e && e.message) ? e.message : String(e) };
  }
}

let __diagTabSel = 'status';
function __diagTab(name){
  __diagTabSel = name || 'status';
  ['status','errors','logs'].forEach(t=>{
    const p=document.getElementById('diagPanel_'+t);
    const b=document.getElementById('diagTabBtn_'+t);
    if(p) p.style.display = (t===__diagTabSel ? 'block' : 'none');
    if(b) b.classList.toggle('active', t===__diagTabSel);
  });
  __renderDiagnosticoPainel();
}

function abrirDiagnosticoPainel(){
  try{
    abrirModal('modalDiagPanel');
    __diagTab(__diagTabSel || 'status');
    __renderDiagnosticoPainel();
  }catch(e){
    try{ if(typeof showToast==='function') showToast("Não foi possível abrir o diagnóstico.", "error"); }catch(_){}
    try{ if(typeof __diagCapture==='function') __diagCapture(e, 'abrirDiagnosticoPainel'); }catch(_){}
  }
}
function fecharDiagnosticoPainel(){
  const m=document.getElementById('modalDiagPanel');
  if(m) m.style.display='none';
}

function __renderDiagnosticoPainel(silent){
  try{
    const modal = document.getElementById('modalDiagPanel');
    const isOpen = modal && modal.style.display==='flex';
    if(!isOpen && silent) return;

    const st = document.getElementById('diagPanel_status');
    const er = document.getElementById('diagPanel_errors');
    const lg = document.getElementById('diagPanel_logs');
    if(!st || !er || !lg) return;

    // STATUS
    const errCount = (__DIAG.errors || []).length;
    const lastTs = __DIAG.lastTestsTs ? __diagTS(__DIAG.lastTestsTs) : '—';
    const stor = __estimateLocalStorageUsage();
    const storTop = (stor && stor.topKeys) ? stor.topKeys.map(x=>`<div class="diag-row"><strong>${_escHTML(x.key)}</strong><div class="diag-muted">${Math.round(x.bytes/1024)} KB</div></div>`).join('') : '';
    st.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="diag-badge ${errCount? 'err':'ok'}">${errCount? ('ERROS: '+errCount) : 'SEM ERROS'}</span>
        <span class="diag-badge ok">Últimos testes: ${_escHTML(lastTs)}</span>
        <span class="diag-badge warn">Storage: ${stor && stor.totalKB ? (stor.totalKB+' KB') : '—'}</span>
      </div>
      <div class="diag-muted" style="margin-top:8px;">Se algum botão parar de responder, clique em <strong>Copiar relatório</strong> e me envie aqui.</div>
      <div style="margin-top:12px;">
        <strong>Maiores chaves no localStorage</strong>
        <div style="margin-top:8px;">${storTop || '<div class="diag-muted">Não foi possível estimar.</div>'}</div>
      </div>
    `;

    // ERROS
    if(errCount === 0){
      er.innerHTML = `<div class="diag-muted">Sem registros de erro nesta sessão.</div>`;
    } else {
      er.innerHTML = (__DIAG.errors || []).slice(0, 40).map((r)=>`
        <div class="diag-row">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <strong>${_escHTML(r.context || 'erro')}</strong>
            <span class="diag-muted">${_escHTML(__diagTS(r.ts))}</span>
          </div>
          <div style="margin-top:4px; color:#b91c1c; font-size:.92rem;">${_escHTML(r.message || '')}</div>
          ${r.extra ? `<div class="diag-muted" style="margin-top:3px;">${_escHTML(JSON.stringify(r.extra))}</div>` : ``}
          ${r.stack ? `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:0.85rem;">Detalhes</summary><pre class="diag-pre" style="margin-top:6px;">${_escHTML(r.stack)}</pre></details>` : ``}
        </div>
      `).join('');
    }

    // LOGS (auditoria + backups)
    const audit = (Array.isArray(__AUDIT)? __AUDIT.slice(Math.max(0, __AUDIT.length-120)) : []);
    const backups = (Array.isArray(__BACKUPS)? __BACKUPS.slice(0, 10) : []);
    const auditHtml = (audit && audit.length) ? audit.slice().reverse().map(a=>`
        <div class="diag-row">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <strong>${_escHTML(a.msg || '')}</strong>
            <span class="diag-muted">${_escHTML(__diagTS(a.ts))}</span>
          </div>
        </div>`).join('') : `<div class="diag-muted">Sem eventos recentes.</div>`;
    const backupsHtml = (backups && backups.length) ? backups.map(b=>`
        <div class="diag-row">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <strong>${_escHTML(b.id || 'backup')}</strong>
            <span class="diag-muted">${_escHTML(__diagTS(b.ts))}</span>
          </div>
        </div>`).join('') : `<div class="diag-muted">Nenhum backup interno recente.</div>`;

    lg.innerHTML = `
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <strong>Auditoria (salvamentos/avisos)</strong>
          <div style="margin-top:8px;">${auditHtml}</div>
        </div>
        <div>
          <strong>Backups internos</strong>
          <div class="diag-muted" style="margin-top:2px;">(não confundir com backup ZIP)</div>
          <div style="margin-top:8px;">${backupsHtml}</div>
        </div>
      </div>
    `;
  }catch(e){
    try{ if(typeof __diagCapture==='function') __diagCapture(e, '__renderDiagnosticoPainel'); }catch(_){}
  }
}

let __saveFailCooldown = 0;
function __showSaveFailDialog(message){
  try{
    const now = Date.now();
    if(now - __saveFailCooldown < 1500) return;
    __saveFailCooldown = now;

    const msgEl = document.getElementById('saveFailMsg');
    if(msgEl) msgEl.textContent = (message || "Falha ao salvar.");
    const m = document.getElementById('modalSaveFail');
    if(m) m.style.display='flex';
  }catch(e){
    try{ if(typeof showToast==='function') showToast("Falha ao salvar dados.", "error"); }catch(_){}
  }
}
function __saveFailBackupNow(){
  try{
    if(typeof baixarBackup==='function') baixarBackup();
  }catch(e){
    try{ if(typeof showToast==='function') showToast("Não foi possível gerar o backup ZIP.", "error"); }catch(_){}
  }finally{
    const m=document.getElementById('modalSaveFail');
    if(m) m.style.display='none';
  }
}




function __runSystemTests(){
  const items = [];
  const counts = { ok:0, warn:0, error:0 };
  const push = (level, title, detail)=>{
    items.push({ level, title, detail });
    if(level==='error') counts.error++;
    else if(level==='warn') counts.warn++;
    else counts.ok++;
  };

  // Ambiente básico
  push(Array.isArray(turmas) ? 'ok' : 'error', "Turmas carregadas", Array.isArray(turmas) ? `Total: ${__u(turmas.length)}` : "Variável turmas inválida.");
  push(Array.isArray(alunos) ? 'ok' : 'error', "Alunos carregados", Array.isArray(alunos) ? `Total: ${__u(alunos.length)}` : "Variável alunos inválida.");
  push(config && typeof config==='object' ? 'ok' : 'error', "Configuração carregada", (config && typeof config==='object') ? "OK" : "Config inválida.");

  // Schema config
  if(config && typeof config==='object'){
    if(Array.isArray(config.disciplinas)){
      push('ok', "Disciplinas (schema novo)", `Total: ${__u(config.disciplinas.length)} (slot1: ${config.slot1||'—'} / slot2: ${config.slot2||'—'})`);
      (config.disciplinas||[]).forEach((d,idx)=>{
        if(!d || typeof d!=='object') return push('error', `Disciplina #${idx+1} inválida`, "Objeto ausente.");
        if(!d.id || !d.nome) push('warn', `Disciplina sem id/nome`, `idx=${idx}`);
        if(!Array.isArray(d.avaliacoes) || d.avaliacoes.length===0){
          push('error', `Avaliações ausentes em ${d.nome||d.id||('disc#'+idx)}`, "Crie pelo menos 1 avaliação.");
        } else {
          const sum = (d.avaliacoes||[]).reduce((acc,av)=>acc + (parseFloat(av.peso)||0), 0);
          if(sum<=0) push('error', `Pesos inválidos em ${__u(d.nome)}`, "A soma dos pesos precisa ser maior que 0.");
          else push('ok', `Pesos OK — ${__u(d.nome)}`, `Soma: ${sum}`);
          (d.avaliacoes||[]).forEach(av=>{
            if(!av.id || !av.nome) push('warn', `Avaliação sem id/nome (${__u(d.nome)})`, JSON.stringify(av||{}));
            const w = parseFloat(av.peso);
            if(!(w>=0)) push('warn', `Peso inválido (${__u(d.nome)} / ${av.nome||av.id})`, `Peso: ${__u(av.peso)}`);
          });
        }
      });
    } else {
      push('warn', "Schema antigo detectado", "Será migrado automaticamente ao abrir Configurações.");
    }
  }

  // Integridade dos alunos
  if(Array.isArray(alunos)){
    const ids = new Set();
    alunos.forEach((a,idx)=>{
      if(!a || typeof a!=='object') return push('error', `Aluno #${idx+1} inválido`, "Objeto ausente.");
      if(!a.nome || typeof a.nome!=='string') push('warn', `Aluno sem nome (#${idx+1})`, "Preencha o nome.");
      if(a.id===undefined || a.id===null) push('warn', `Aluno sem id (${a.nome||('#'+idx)})`, "ID ausente.");
      else {
        const k = String(a.id);
        if(ids.has(k)) push('warn', `ID duplicado (${a.nome||('#'+idx)})`, `id=${k}`);
        ids.add(k);
      }
      if(!a.bimestres || typeof a.bimestres!=='object'){
        push('warn', `Bimestres ausentes (${a.nome||('#'+idx)})`, "Estrutura bimestres não encontrada.");
      } else {
        [1,2,3,4].forEach(bi=>{
          const b=a.bimestres[bi];
          if(!b) return push('warn', `Bimestre ${bi} ausente (${a.nome||('#'+idx)})`, "Pode indicar dados incompletos.");
          // notas_disc & slots
          const nd = b.notas_disc;
          if(!nd || typeof nd!=='object') push('warn', `notas_disc ausente (${a.nome||('#'+idx)} / B${bi})`, "O sistema pode recriar automaticamente ao salvar.");
          if(config && Array.isArray(config.disciplinas) && config.slot1){
            const d1 = (config.disciplinas||[]).find(d=>d.id===config.slot1);
            if(d1){
              const notas = (nd && nd[d1.id]) ? nd[d1.id] : b.notas_lp;
              (d1.avaliacoes||[]).forEach(av=>{
                const v = notas ? notas[av.id] : undefined;
                const n = (v===undefined) ? NaN : parseFloat(String(v).replace(',','.'));
                if(isNaN(n)) push('warn', `Nota vazia/não numérica (${a.nome||('#'+idx)} / ${__u(d1.nome)} / B${bi})`, `Avaliação: ${__u(av.nome)}`);
                else if(n<0 || n>10) push('warn', `Nota fora de 0–10 (${a.nome||('#'+idx)} / ${__u(d1.nome)} / B${bi})`, `${__u(av.nome)}: ${v}`);
              });
            }
          }
          if(config && Array.isArray(config.disciplinas) && config.slot2){
            const d2 = (config.disciplinas||[]).find(d=>d.id===config.slot2);
            if(d2){
              const notas = (nd && nd[d2.id]) ? nd[d2.id] : b.notas_red;
              (d2.avaliacoes||[]).forEach(av=>{
                const v = notas ? notas[av.id] : undefined;
                const n = (v===undefined) ? NaN : parseFloat(String(v).replace(',','.'));
                if(isNaN(n)) push('warn', `Nota vazia/não numérica (${a.nome||('#'+idx)} / ${__u(d2.nome)} / B${bi})`, `Avaliação: ${__u(av.nome)}`);
                else if(n<0 || n>10) push('warn', `Nota fora de 0–10 (${a.nome||('#'+idx)} / ${__u(d2.nome)} / B${bi})`, `${__u(av.nome)}: ${v}`);
              });
            }
          }
        });
      }
    });
    push('ok', "IDs verificados", `Total únicos: ${__u(ids.size)}`);
  }

  const summary = (counts.error>0)
    ? "Foram encontrados erros. Corrija os itens marcados como ERRO."
    : (counts.warn>0 ? "Sem erros críticos, mas há avisos para revisão." : "Tudo certo! Nenhum problema encontrado.");
  return { counts, items, summary };
}

function diagExecutarTestes(){
  try{
    const res = __runSystemTests();
    __DIAG.lastTests = res;
    __DIAG.lastTestsTs = Date.now();
    _renderDiagnosticoConfig();
    if(typeof showToast === 'function') showToast("Testes concluídos. Veja o resultado em Diagnóstico.", "success");
  }catch(e){
    __diagCapture(e, 'diagExecutarTestes');
    if(typeof showToast === 'function') showToast("Falha ao executar testes.", "error");
  }
}

function diagCopiarRelatorio(){
  try{
    const storage = (typeof __estimateLocalStorageUsage==='function') ? __estimateLocalStorageUsage() : null;
    const payload = {
      app: "SGP",
      version: "v12.13 (diag+logs)",
      ts: new Date().toISOString(),
      ua: navigator.userAgent,
      counts: {
        turmas: Array.isArray(turmas)? turmas.length : null,
        alunos: Array.isArray(alunos)? alunos.length : null,
        aulas: Array.isArray(aulas)? aulas.length : null
      },
      storage,
      lastErrors: (__DIAG.errors||[]).slice(0, 20),
      lastTests: __DIAG.lastTests || null,
      auditTail: (Array.isArray(__AUDIT)? __AUDIT.slice(Math.max(0, __AUDIT.length-60)) : null),
      backupsMeta: (Array.isArray(__BACKUPS)? (__BACKUPS||[]).slice(0, 8).map(b=>({id:b.id, ts:b.ts})) : null)
    };
    const text = JSON.stringify(payload, null, 2);

    const doCopyFallback = ()=>{
      const ta=document.createElement('textarea');
      ta.value=text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    };

    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>{
        if(typeof showToast === 'function') showToast("Relatório copiado.", "success");
      }).catch(()=>{
        doCopyFallback();
        if(typeof showToast === 'function') showToast("Relatório copiado.", "success");
      });
    }else{
      doCopyFallback();
      if(typeof showToast === 'function') showToast("Relatório copiado.", "success");
    }
  }catch(e){
    __diagCapture(e, 'diagCopiarRelatorio');
    if(typeof showToast === 'function') showToast("Não foi possível copiar o relatório.", "error");
  }
}

/* === Safety wrapper: não deixa erros em cliques quebrarem o app === */
function __wrapSafeGlobal(fnName){
  try{
    const fn = window[fnName];
    if(typeof fn !== 'function') return;
    if(fn.__safeWrapped) return;
    const wrapped = function(...args){
      try{
        return fn.apply(this, args);
      }catch(e){
        __diagCapture(e, `fn:${fnName}`);
        // fallback leve: tenta re-render e não interrompe a UI
        try{ if(typeof renderizarVisao === 'function') renderizarVisao(); }catch(_){}
      }
    };
    wrapped.__safeWrapped = true;
    wrapped.__orig = fn;
    window[fnName] = wrapped;
  }catch(_){}
}

(function __wrapAllOnclickSafely(){
  const names = [
    'abrirConfig','abrirDetalhes','abrirGeradorGrupos','abrirModal','abrirModalAluno','abrirModalCopiarTabela','abrirModalEvento','abrirTimer',
    'addAulaIndividual','addOcorrencia','addTagParecer','apagarLayout','baixarBackup','baixarLog','cfgAdicionarDisciplina','clonarAulas','copiarConteudoTabela',
    'copiarListaRisco','criarBackupAgora','delAluno','delTurma','excluirAula','excluirBackup','excluirEventoCal','exportarCSV','fecharModais','funcBlitz',
    'gerarGrupos','gerarParecer','imprimirFicha','limparBusca','mudarAba','mudarBimestre','mudarMes','mudarVisao','pauseTimer','redo','resetTimer',
    'restaurarBackup','restaurarUltimoBackup','salvarAlteracoesDetalhadas','salvarAlunos','salvarAulasLote','salvarConfig','salvarEdicaoMassa','salvarEventoCal',
    'salvarLayout','salvarTurma','selTurma','setTimer','sortearAluno','startTimer','toggleDarkMode','toggleFiltroInclusao','toggleFiltroRisco','togglePrivacy',
    'toggleZenMode','touchSelectAluno','touchSelectMesa','undo','diagExecutarTestes','diagCopiarRelatorio','diagLimpar'
  ];
  names.forEach(__wrapSafeGlobal);
})();




/* ============================
   Planos de Aula (Plano Semanal)
   - 7 aulas/semana (LP)
   - Gera consolidado agrupado por tipo (na ordem solicitada)
   ============================ */
let __planoUIInited = false;
const __PLANO_GERAL_KEY = "__PLANO_GERAL__";

// ===== Plano Semanal: multi-disciplina + aulas dinâmicas + grupos =====
let __planoQtdAulas = 7;
let __planoMaxAulasDom = 7;
let __planoDiscId = '';

function __planoListDisciplinas(){
  try{ return (config && Array.isArray(config.disciplinas)) ? config.disciplinas : []; }catch(e){ return []; }
}
function __planoDiscName(id){
  const d = __planoListDisciplinas().find(x=>x && x.id===id);
  return d ? (d.nome || id) : (id || '');
}
function __planoGetDefaultDiscId(){
  const list = __planoListDisciplinas();
  let last='';
  try{ last = localStorage.getItem('sgp_plano_disc_last') || ''; }catch(_){ last=''; }
  if(last && list.some(d=>d && d.id===last)) return last;
  const slot1 = (config && config.slot1) ? String(config.slot1) : '';
  if(slot1 && list.some(d=>d && d.id===slot1)) return slot1;
  return (list[0] && list[0].id) ? String(list[0].id) : '';
}
function __planoGetSelectedDiscId(){
  const sel = document.getElementById('planoDisciplina');
  const v = sel ? String(sel.value||'') : '';
  return v || (__planoDiscId || '');
}
function __planoPrefsKey(discId){ return 'sgp_plano_prefs_' + String(discId || '__none__'); }
function __planoLoadPrefs(discId){
  discId = discId || __planoGetSelectedDiscId();
  try{
    const raw = localStorage.getItem(__planoPrefsKey(discId));
    return raw ? (JSON.parse(raw)||{}) : {};
  }catch(_){ return {}; }
}
function __planoSavePrefs(discId, patch){
  discId = discId || __planoGetSelectedDiscId();
  const cur = __planoLoadPrefs(discId);
  const next = Object.assign({}, cur, patch||{});
  try{
    if(typeof __safeLSSet==='function') __safeLSSet(__planoPrefsKey(discId), JSON.stringify(next));
    else localStorage.setItem(__planoPrefsKey(discId), JSON.stringify(next));
  }catch(_){
    try{ localStorage.setItem(__planoPrefsKey(discId), JSON.stringify(next)); }catch(__){}
  }
  return next;
}

function __planoIndexExistingCards(){
  let max=0;
  for(let i=1;i<=50;i++){
    const t=document.getElementById('pl_aula'+i+'_texto');
    if(!t) break;
    let card=null;
    try{ card = t.closest('div[style*="padding:12px"], .plano-aula-card'); }catch(_){ card=null; }
    if(card){
      if(!card.id) card.id = 'pl_card_aula'+i;
      card.classList.add('plano-aula-card');
      card.dataset.aulaN = String(i);
    }
    max=i;
  }
  __planoMaxAulasDom = Math.max(__planoMaxAulasDom, max || 7);
}

function __planoBindAulaShortcut(n){
  const t=document.getElementById('pl_aula'+n+'_texto');
  if(!t || t.__plBound) return;
  t.__plBound = true;
  t.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){
      e.preventDefault();
      try{ extrairPlanoAula(n); }catch(_){}
    }
  });
}

function __planoAulaCardHTML(n){
  const nn=String(n);
  var html='';
  html += '<div class="plano-aula-card" id="pl_card_aula'+nn+'" data-aula-n="'+nn+'" style="padding:12px; border:1px solid var(--border-color); border-radius:14px; background:var(--card-bg);">';
  html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
  html += '<h3 style="margin:0; font-size:14px; color:var(--text-main);">Aula '+nn+'</h3>';
  html += '<button class="btn-tool" data-onclick="extrairPlanoAula('+nn+')" title="Extrair do texto"><i class="fas fa-wand-magic-sparkles"></i></button>';
  html += '</div>';
  html += '<textarea id="pl_aula'+nn+'_texto" class="inp" rows="3" placeholder="Cole o texto completo da Aula '+nn+' (opcional)"></textarea>';
  html += '<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">';
  html += '<select id="pl_aula'+nn+'_bloomNivel" class="inp" style="width: 190px;" data-onchange="onBloomNivelChangePlano('+nn+')">';
  html += '<option value="">Bloom (nível alvo)</option>';
  html += '<option value="Lembrar">Lembrar</option><option value="Compreender">Compreender</option><option value="Aplicar">Aplicar</option><option value="Analisar">Analisar</option><option value="Avaliar">Avaliar</option><option value="Criar">Criar</option>';
  html += '</select>';
  html += '<input type="text" id="pl_aula'+nn+'_bloomVerbo" class="inp" placeholder="Verbo-alvo (Bloom)" style="flex:1; min-width: 200px;" list="dlBloomVerbosPlano'+nn+'">';
  html += '<datalist id="dlBloomVerbosPlano'+nn+'"></datalist>';
  html += '</div>';
  html += '<div style="display:grid; grid-template-columns: 1fr; gap:6px; margin-top:8px;">';
  html += '<textarea id="pl_aula'+nn+'_conteudo" class="inp" rows="2" placeholder="1. Conteúdo"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_habilidades" class="inp" rows="2" placeholder="2. Habilidades"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_objetivos" class="inp" rows="2" placeholder="3. Objetivos"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_sensibilizacao" class="inp" rows="2" placeholder="4. Sensibilização"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_desenvolvimento" class="inp" rows="2" placeholder="5. Desenvolvimento e estratégias da aula"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_recursos" class="inp" rows="2" placeholder="6. Recursos utilizados na aula"></textarea>';
  html += '<textarea id="pl_aula'+nn+'_avaliacao" class="inp" rows="2" placeholder="7. Avaliação/Sistematização da aula"></textarea>';
  html += '</div>';
  html += '</div>';
  return html;
}

function __planoEnsureCard(n){
  if(document.getElementById('pl_aula'+n+'_texto')) return;
  const body=document.getElementById('planoSemanalBody');
  if(!body) return;
  const wrap=document.createElement('div');
  wrap.innerHTML=__planoAulaCardHTML(n);
  const card=wrap.firstElementChild;
  if(card) body.appendChild(card);
  __planoBindAulaShortcut(n);
  try{ if(typeof onBloomNivelChangePlano==='function') onBloomNivelChangePlano(n); }catch(_){}
}

function planoSetQtdAulas(qtd){
  let n=parseInt(qtd,10);
  if(!n||n<1) n=1;
  if(n>50) n=50;
  for(let i=1;i<=n;i++) __planoEnsureCard(i);
  __planoMaxAulasDom = Math.max(__planoMaxAulasDom, n);
  for(let i=1;i<=__planoMaxAulasDom;i++){
    const card=document.getElementById('pl_card_aula'+i);
    if(card) card.style.display = (i<=n)? '' : 'none';
  }
  __planoQtdAulas = n;
  const inp=document.getElementById('planoQtdAulas');
  if(inp) inp.value=String(n);
  const span=document.getElementById('planoLoteMaxSpan');
  if(span) span.textContent=String(n);
  const discId=__planoGetSelectedDiscId();
  if(discId) __planoSavePrefs(discId, {qtdAulas:n});
}

function planoAdjustAulas(delta){
  const inp=document.getElementById('planoQtdAulas');
  const cur=inp? parseInt(inp.value,10) : __planoQtdAulas;
  planoSetQtdAulas((cur||1)+(delta||0));
}

function __planoRefreshDisciplinasUI(){
  const sel=document.getElementById('planoDisciplina');
  if(!sel) return;
  const list=__planoListDisciplinas();
  const current=sel.value || __planoDiscId || '';
  let desired=current || __planoGetDefaultDiscId();
  sel.innerHTML='';
  list.forEach(d=>{
    if(!d||!d.id) return;
    const opt=document.createElement('option');
    opt.value=String(d.id);
    opt.textContent=d.nome || d.id;
    sel.appendChild(opt);
  });
  if(desired && Array.from(sel.options).some(o=>o.value===desired)) sel.value=desired;
  else if(sel.options.length) sel.value=sel.options[0].value;
  __planoDiscId = sel.value || '';
  try{ localStorage.setItem('sgp_plano_disc_last', __planoDiscId); }catch(_){}
}

function planoDisciplinaChanged(){
  const sel=document.getElementById('planoDisciplina');
  __planoDiscId = sel ? (sel.value||'') : '';
  try{ localStorage.setItem('sgp_plano_disc_last', __planoDiscId); }catch(_){}

  const prefs=__planoLoadPrefs(__planoDiscId);
  if(prefs && prefs.qtdAulas) planoSetQtdAulas(prefs.qtdAulas);
  const modo=document.getElementById('planoResumoModo');
  if(modo && prefs && prefs.resumoModo) modo.value=prefs.resumoModo;
  const g=document.getElementById('planoGruposDef');
  if(g && prefs && typeof prefs.gruposDef==='string') g.value=prefs.gruposDef;
  try{ planoResumoModoChanged(true); }catch(_){}

  __renderListaPlanosSemana();
  const selPlan=document.getElementById('planoSemanaLista');
  if(selPlan) selPlan.value='';

  const planos=__getPlanosTurma();
  if(planos && planos.length){
    const recent=planos.slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))[0];
    if(recent){
      if(selPlan) selPlan.value=recent.id;
      __fillPlanoToUI(recent);
      const r=document.getElementById('planoSemanalResumo');
      if(r) r.value=recent.resumo||'';
      return;
    }
  }
  novoPlanoSemana();
}

function planoResumoModoChanged(silent){
  const sel=document.getElementById('planoResumoModo');
  const g=document.getElementById('planoGruposDef');
  const mode = sel ? (sel.value||'por_aula') : 'por_aula';
  if(g){
    g.disabled = (mode !== 'por_grupo');
    g.style.opacity = (mode !== 'por_grupo') ? '0.6' : '1';
  }
  const discId=__planoGetSelectedDiscId();
  if(discId) __planoSavePrefs(discId, {resumoModo:mode, gruposDef: g ? (g.value||'') : ''});
  if(!silent){
    try{ showToast(mode==='por_grupo' ? 'Modo: Agrupar aulas (grupos).' : 'Modo: Padrão (por aula).', 'success'); }catch(_){}
  }
}

function __planoWirePrefsAutoSave(){
  const qtd=document.getElementById('planoQtdAulas');
  if(qtd && !qtd.__plBound){
    qtd.__plBound=true;
    qtd.addEventListener('change', ()=> planoSetQtdAulas(qtd.value));
  }
  const g=document.getElementById('planoGruposDef');
  if(g && !g.__plBound){
    g.__plBound=true;
    g.addEventListener('change', ()=>{
      const discId=__planoGetSelectedDiscId();
      if(discId) __planoSavePrefs(discId, {gruposDef:g.value||''});
    });
  }
}

function __planoNumsToRanges(nums){
  const arr=(nums||[]).slice().sort((a,b)=>a-b);
  if(!arr.length) return '';
  const ranges=[];
  let start=arr[0], prev=arr[0];
  for(let i=1;i<arr.length;i++){
    const n=arr[i];
    if(n===prev+1){ prev=n; continue; }
    ranges.push(start===prev? String(start) : (String(start)+'-'+String(prev)));
    start=prev=n;
  }
  ranges.push(start===prev? String(start) : (String(start)+'-'+String(prev)));
  return ranges.join(',');
}

function __planoParseGroups(defStr, maxN){
  maxN = parseInt(maxN,10) || __planoQtdAulas || 7;
  if(maxN<1) maxN=1;
  if(maxN>50) maxN=50;
  const s=String(defStr||'').replace(/\r/g,'').trim();
  if(!s){
    return [{label:'Aulas 1-'+maxN, nums:Array.from({length:maxN},(_,i)=>i+1)}];
  }
  const parts=s.split(/[\n;]/).map(x=>String(x||'').trim()).filter(Boolean);
  const groups=[];
  parts.forEach(part=>{
    let label='';
    let expr=part;
    if(part.indexOf('=')>=0 || part.indexOf(':')>=0){
      const sep = (part.indexOf('=')>=0) ? '=' : ':';
      const idx = part.indexOf(sep);
      label = part.slice(0, idx).trim();
      expr = part.slice(idx+1).trim();
    }
    const nums=[];
    expr.split(/[\s,]+/).map(t=>t.trim()).filter(Boolean).forEach(tok=>{
      const m = tok.match(/^(\d{1,2})\s*[-–]\s*(\d{1,2})$/);
      if(m){
        let a=parseInt(m[1],10), b=parseInt(m[2],10);
        if(!a||!b) return;
        if(a>b){ const tmp=a; a=b; b=tmp; }
        for(let k=a;k<=b;k++) nums.push(k);
      }else{
        const n=parseInt(tok,10);
        if(n) nums.push(n);
      }
    });
    const uniq=[];
    const seen=new Set();
    nums.forEach(n=>{
      if(n>=1 && n<=maxN && !seen.has(n)){ seen.add(n); uniq.push(n); }
    });
    if(!uniq.length) return;
    if(!label) label = 'Aulas ' + __planoNumsToRanges(uniq);
    groups.push({label:label, nums:uniq});
  });
  if(!groups.length){
    return [{label:'Aulas 1-'+maxN, nums:Array.from({length:maxN},(_,i)=>i+1)}];
  }
  return groups;
}

function __montarResumoPlanoPorGrupos(payload){
  const inicio=payload.inicio, fim=payload.fim;
  const aulas=payload.aulas||[];
  const discId=payload.discId||__planoGetSelectedDiscId();
  const grupos=payload.grupos||__planoParseGroups('', aulas.length||__planoQtdAulas);

  const categorias=[
    {n:1, titulo:'Conteúdo', key:'conteudo'},
    {n:2, titulo:'Habilidades', key:'habilidades'},
    {n:3, titulo:'Objetivos', key:'objetivos'},
    {n:4, titulo:'Sensibilização', key:'sensibilizacao'},
    {n:5, titulo:'Desenvolvimento e estratégias da aula', key:'desenvolvimento'},
    {n:6, titulo:'Recursos utlizados na aula', key:'recursos'},
    {n:7, titulo:'Avaliação/Sistematização da aula', key:'avaliacao'}
  ];

  let out='';
  if(inicio && fim){
    out += 'Semana: '+__formatDateBR(inicio)+' a '+__formatDateBR(fim)+'\n';
  }
  const discName=__planoDiscName(discId);
  if(discName){
    out += 'Disciplina: '+discName+'\n\n';
  }else{
    out += '\n';
  }

  grupos.forEach(g=>{
    out += g.label+'\n\n';
    categorias.forEach(cat=>{
      out += cat.n+'. '+cat.titulo+':\n';
      let any=false;
      (g.nums||[]).forEach(n=>{
        const a=aulas[n-1]||{};
        let line=__limparTexto(a[cat.key]);
        if(cat.key==='habilidades'){
          const bl=__limparTexto(a.bloomNivel);
          const vb=__limparTexto(a.bloomVerbo);
          const parts=[];
          if(bl) parts.push('Bloom: '+bl);
          if(vb) parts.push('Verbo: '+vb);
          if(parts.length){
            if(line) line = line + ' — ' + parts.join(' | ');
            else line = parts.join(' | ');
          }
        }
        if(line){
          any=true;
          out += 'Aula '+n+': '+line+'\n';
        }
      });
      if(!any) out += '—\n';
      out += '\n';
    });
    out += '\n';
  });

  return String(out||'').trim();
}

function __planoBuildResumo(collected){
  const modoEl=document.getElementById('planoResumoModo');
  const modo = modoEl ? (modoEl.value||'por_aula') : 'por_aula';
  const gEl=document.getElementById('planoGruposDef');
  const gruposDef = gEl ? (gEl.value||'') : '';
  if(modo==='por_grupo'){
    const grupos=__planoParseGroups(gruposDef, (collected && collected.aulas ? collected.aulas.length : __planoQtdAulas));
    return __montarResumoPlanoPorGrupos({inicio:collected.inicio, fim:collected.fim, aulas:collected.aulas, grupos:grupos, discId:collected.discId});
  }
  return __montarResumoPlano({inicio:collected.inicio, fim:collected.fim, aulas:collected.aulas});
}


function abrirPlanoSemanal(){
  // permite Plano Geral mesmo sem turma selecionada
  if(!__planoUIInited) initPlanoSemanalUI();
  abrirModal('modalPlanoSemanal');

  __planoRefreshDisciplinasUI();
  __planoWirePrefsAutoSave();

  const esc = document.getElementById('planoEscopo');
  if(esc){
    if(filtroTurma === 'Todas') esc.value = 'geral';
    else if(!esc.value) esc.value = 'turma';
  }
  __syncPlanoEscopoUI();

  // aplica prefs da disciplina
  const discId = __planoGetSelectedDiscId() || __planoGetDefaultDiscId();
  if(discId){
    const prefs = __planoLoadPrefs(discId);
    if(prefs && prefs.qtdAulas) planoSetQtdAulas(prefs.qtdAulas);
    const modo=document.getElementById('planoResumoModo');
    if(modo && prefs && prefs.resumoModo) modo.value=prefs.resumoModo;
    const g=document.getElementById('planoGruposDef');
    if(g && prefs && typeof prefs.gruposDef==='string' && !g.value) g.value=prefs.gruposDef;
  }
  planoResumoModoChanged(true);

  __renderListaPlanosSemana();
  const sel = document.getElementById('planoSemanaLista');
  if(sel && sel.value) carregarPlanoSemana(sel.value);
  else{
    const planos = __getPlanosTurma();
    if(planos && planos.length){
      const recent = planos.slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))[0];
      if(recent){
        if(sel) sel.value = recent.id;
        __fillPlanoToUI(recent);
      }else novoPlanoSemana();
    }else novoPlanoSemana();
  }
  const st = document.getElementById('planoSemanaStatus');
  if(st) st.innerText = '';
}


function initPlanoSemanalUI(){
  __planoUIInited = true;
  __planoIndexExistingCards();

  const ini = document.getElementById('planoSemanaInicio');
  const fim = document.getElementById('planoSemanaFim');
  const sel = document.getElementById('planoSemanaLista');

  if(ini){
    ini.addEventListener('change', ()=>{
      if(fim && !fim.value && ini.value){
        try{
          const d = new Date(ini.value + 'T00:00:00');
          d.setDate(d.getDate() + 6);
          fim.value = d.toISOString().slice(0,10);
        }catch(e){}
      }
      __updatePlanoKeyPreview();
    });
  }
  if(fim) fim.addEventListener('change', __updatePlanoKeyPreview);
  if(sel){
    sel.addEventListener('change', ()=>{ if(sel.value) carregarPlanoSemana(sel.value); });
  }

  // Ctrl+Enter no texto da aula
  for(let i=1;i<=__planoMaxAulasDom;i++) __planoBindAulaShortcut(i);

  const esc = document.getElementById('planoEscopo');
  if(esc){
    esc.addEventListener('change', ()=>{
      if(esc.value === 'turma' && filtroTurma === 'Todas') esc.value = 'geral';
      __syncPlanoEscopoUI();
      __renderListaPlanosSemana();
      novoPlanoSemana();
    });
  }

  const discSel = document.getElementById('planoDisciplina');
  if(discSel) discSel.addEventListener('change', planoDisciplinaChanged);

  __planoWirePrefsAutoSave();
  __syncPlanoEscopoUI();
}


function __getEscopoPlano(){
  return (document.getElementById('planoEscopo')?.value || 'turma');
}


function togglePlanoSemanalFullscreen(){
  const box = document.getElementById('planoSemanalBox');
  if(!box) return;
  const on = !box.classList.contains('is-fullscreen');
  if(on) box.classList.add('is-fullscreen'); else box.classList.remove('is-fullscreen');
  const btn = document.getElementById('btnPlanoSemanalFullscreen');
  if(btn){
    const icon = btn.querySelector('i');
    if(icon) icon.className = on ? 'fas fa-compress' : 'fas fa-expand';
  }
}

function __planoParseLote(raw, maxN){
  raw = String(raw||'').replace(/\r/g,'').trim();
  maxN = parseInt(maxN,10) || __planoQtdAulas || 7;
  if(maxN<1) maxN=1;
  if(maxN>50) maxN=50;
  const out = new Array(maxN).fill('');
  if(!raw) return out;

  const re = /(?:^|\n)\s*(?:Aula\s*)?(\d{1,2})\s*[:\-]\s*/gi;
  const ms = [];
  let m;
  while((m = re.exec(raw))){
    const n = parseInt(m[1],10);
    if(!n || n<1 || n>maxN) continue;
    ms.push({n, start:m.index, after: re.lastIndex});
  }
  if(ms.length >= 2){
    ms.sort((a,b)=>a.start-b.start);
    for(let i=0;i<ms.length;i++){
      const cur = ms[i];
      const next = ms[i+1];
      const seg = raw.slice(cur.after, next ? next.start : raw.length).trim();
      if(seg){
        out[cur.n-1] = out[cur.n-1] ? (out[cur.n-1] + "\n\n" + seg) : seg;
      }
    }
    return out;
  }

  let blocks = raw.split(/\n-{3,}\n/).map(s=>s.trim()).filter(Boolean);
  if(blocks.length < 2){
    blocks = raw.split(/\n\s*\n+/).map(s=>s.trim()).filter(Boolean);
  }
  if(blocks.length < 2){
    blocks = raw.split(/\n/).map(s=>s.trim()).filter(Boolean);
  }

  for(let i=0;i<maxN;i++){
    if(blocks[i]) out[i] = blocks[i];
  }
  return out;
}


function planoLoteDistribuir(){
  const tx = (document.getElementById('planoLoteTexto')||{}).value || '';
  const segs = __planoParseLote(tx, __planoQtdAulas||7);
  let filled = 0;
  for(let i=1;i<=__planoQtdAulas;i++){
    const seg = (segs[i-1]||'').trim();
    if(!seg) continue;
    const el = document.getElementById('pl_aula'+i+'_texto');
    if(el){ el.value = seg; filled++; }
  }
  if(filled===0) return showToast('Nada para distribuir (use títulos Aula 1: ... ou separe por blocos).', 'error');
  showToast('Distribuído em '+filled+' aula(s).', 'success');
}


function __planoExtrairAulaSilent(n){
  const el = document.getElementById(`pl_aula${n}_texto`);
  const txt = el ? (el.value||'') : '';
  if(!String(txt).trim()) return false;
  const campos = __extrairCampos(txt);
  if(!campos || Object.keys(campos).length===0) return false;

  const set = (k,val)=>{ const e=document.getElementById(`pl_aula${n}_${k}`); if(e && val) e.value = val; };
  set('conteudo', campos.conteudo);
  set('habilidades', campos.habilidades);
  set('objetivos', campos.objetivos);
  set('sensibilizacao', campos.sensibilizacao);
  set('desenvolvimento', campos.desenvolvimento);
  set('recursos', campos.recursos);
  set('avaliacao', campos.avaliacao);
  return true;
}

function planoLoteDistribuirEExtrair(){
  planoLoteDistribuir();
  let ok = 0;
  for(let i=1;i<=__planoQtdAulas;i++){
    try{ if(__planoExtrairAulaSilent(i)) ok++; }catch(e){}
  }
  if(ok>0) showToast('Extração concluída em '+ok+' aula(s).', 'success');
}


function planoLoteLimpar(){
  const t = document.getElementById('planoLoteTexto');
  if(t) t.value = '';
  showToast('Entrada em massa limpa.', 'success');
}


/* =============================================
   PREENCHIMENTO RÁPIDO — campo-a-campo em lote
   ============================================= */

var __planoPreenchCampoAtual = 'conteudo';
var __planoPreenchCampos = ['conteudo','habilidades','objetivos','sensibilizacao','desenvolvimento','recursos','avaliacao'];
var __planoPreenchNomes = {
  conteudo:'Conteúdo', habilidades:'Habilidades', objetivos:'Objetivos',
  sensibilizacao:'Sensibilização', desenvolvimento:'Desenvolvimento e estratégias',
  recursos:'Recursos utilizados', avaliacao:'Avaliação/Sistematização'
};

function planoPreenchTab(campo){
  __planoPreenchCampoAtual = campo;
  // Atualiza visual dos tabs
  var tabs = document.querySelectorAll('#planoPreenchTabs .plano-pr-tab');
  tabs.forEach(function(t){
    var c = t.getAttribute('data-campo');
    t.classList.remove('plano-pr-tab-active');
    if(c === campo) t.classList.add('plano-pr-tab-active');
  });
  // Atualiza placeholder
  var tx = document.getElementById('planoPreenchTexto');
  if(tx){
    var nome = __planoPreenchNomes[campo] || campo;
    var maxN = __planoQtdAulas || 7;
    var ph = '';
    for(var i=1; i<=Math.min(maxN,5); i++) ph += 'Aula '+i+': ('+nome+' da aula '+i+')\n';
    if(maxN > 5) ph += '...\n';
    tx.placeholder = ph;
    tx.value = '';
  }
  __planoPreenchUpdateProgress();
}

function __planoPreenchParseLinhas(raw, maxN){
  raw = String(raw||'').replace(/\r/g,'').trim();
  if(!raw) return [];
  maxN = parseInt(maxN,10) || __planoQtdAulas || 7;

  // Tenta formato "Aula N:" ou "N." ou "N:" ou "N -"
  var reAula = /(?:^|\n)\s*(?:Aula\s*)?(\d{1,2})\s*[.:\-–]\s*/gi;
  var matches = [], m;
  while((m = reAula.exec(raw))){
    var n = parseInt(m[1],10);
    if(n >= 1 && n <= maxN) matches.push({n:n, start:m.index, after:reAula.lastIndex});
  }
  if(matches.length >= 2){
    matches.sort(function(a,b){ return a.start - b.start; });
    var out = new Array(maxN).fill('');
    for(var i=0; i<matches.length; i++){
      var cur = matches[i];
      var next = matches[i+1];
      var seg = raw.slice(cur.after, next ? next.start : raw.length).trim();
      if(seg) out[cur.n - 1] = seg;
    }
    return out;
  }

  // Tenta separar por "---"
  var blocks = raw.split(/\n-{3,}\n/).map(function(s){return s.trim();}).filter(Boolean);
  if(blocks.length < 2){
    // Cada linha = uma aula
    blocks = raw.split(/\n/).map(function(s){return s.trim();}).filter(Boolean);
  }
  // Remove prefixos numéricos residuais
  blocks = blocks.map(function(b){ return b.replace(/^\d{1,2}\s*[.:\-–]\s*/, '').trim(); });

  var out = new Array(maxN).fill('');
  for(var i=0; i<Math.min(blocks.length, maxN); i++) out[i] = blocks[i];
  return out;
}

function planoPreenchAplicar(){
  var campo = __planoPreenchCampoAtual;
  var raw = (document.getElementById('planoPreenchTexto')||{}).value || '';
  var maxN = __planoQtdAulas || 7;
  if(!raw.trim()) return showToast('Cole o texto antes de aplicar.', 'error');

  var items = __planoPreenchParseLinhas(raw, maxN);
  var filled = 0;
  for(var i=1; i<=maxN; i++){
    var val = (items[i-1]||'').trim();
    if(!val) continue;
    var el = document.getElementById('pl_aula'+i+'_'+campo);
    if(!el) continue;
    el.value = val;
    filled++;
  }
  if(filled === 0) return showToast('Nenhum conteúdo distribuído. Verifique o formato.', 'error');

  var nome = __planoPreenchNomes[campo] || campo;
  showToast(nome+' → '+filled+' aula(s) preenchida(s).', 'success');
  __planoPreenchMarkDone(campo);
  __planoPreenchUpdateProgress();

  var st = document.getElementById('planoPreenchStatus');
  if(st) st.textContent = '✓ '+nome+': '+filled+'/'+maxN;
}

function planoPreenchAplicarEProximo(){
  var raw = (document.getElementById('planoPreenchTexto')||{}).value || '';
  if(raw.trim()) planoPreenchAplicar();
  // Avança para próximo campo
  var idx = __planoPreenchCampos.indexOf(__planoPreenchCampoAtual);
  var next = (idx + 1) % __planoPreenchCampos.length;
  planoPreenchTab(__planoPreenchCampos[next]);
}

function planoPreenchLerCampo(){
  var campo = __planoPreenchCampoAtual;
  var maxN = __planoQtdAulas || 7;
  var lines = [];
  for(var i=1; i<=maxN; i++){
    var el = document.getElementById('pl_aula'+i+'_'+campo);
    var val = el ? (el.value||'').trim() : '';
    lines.push('Aula '+i+': '+(val || '—'));
  }
  var tx = document.getElementById('planoPreenchTexto');
  if(tx) tx.value = lines.join('\n');
  showToast('Campos atuais exibidos.', 'success');
}

function __planoPreenchMarkDone(campo){
  var tabs = document.querySelectorAll('#planoPreenchTabs .plano-pr-tab');
  tabs.forEach(function(t){
    if(t.getAttribute('data-campo') === campo){
      t.classList.add('plano-pr-tab-done');
    }
  });
}

function __planoPreenchUpdateProgress(){
  var el = document.getElementById('planoPreenchProgress');
  if(!el) return;
  var maxN = __planoQtdAulas || 7;
  var done = 0;
  __planoPreenchCampos.forEach(function(campo){
    var has = false;
    for(var i=1; i<=maxN; i++){
      var e = document.getElementById('pl_aula'+i+'_'+campo);
      if(e && e.value && e.value.trim()){ has = true; break; }
    }
    if(has) done++;
  });
  el.textContent = done+'/7 campos com dados';
  // Atualiza visual done nos tabs
  var tabs = document.querySelectorAll('#planoPreenchTabs .plano-pr-tab');
  tabs.forEach(function(t){
    var c = t.getAttribute('data-campo');
    var has = false;
    for(var i=1; i<=maxN; i++){
      var e = document.getElementById('pl_aula'+i+'_'+c);
      if(e && e.value && e.value.trim()){ has = true; break; }
    }
    if(has) t.classList.add('plano-pr-tab-done');
    else t.classList.remove('plano-pr-tab-done');
  });
}

// Inicializa progresso ao abrir
var __origAbrirPlanoSemanal = typeof abrirPlanoSemanal === 'function' ? abrirPlanoSemanal : null;
(function(){
  var _patchInterval = setInterval(function(){
    if(typeof abrirPlanoSemanal !== 'function') return;
    var _orig = abrirPlanoSemanal;
    if(_orig.__preenchPatched) return;
    abrirPlanoSemanal = function(){
      _orig.apply(this, arguments);
      try{ __planoPreenchUpdateProgress(); }catch(e){}
    };
    abrirPlanoSemanal.__preenchPatched = true;
    clearInterval(_patchInterval);
  }, 200);
})();


function __getPlanoStoreKey(){
  const esc = __getEscopoPlano();
  if(esc === 'geral') return __PLANO_GERAL_KEY;
  return filtroTurma;
}

function __getPlanosTurma(){
  const all = __getPlanosTurmaAll();
  const disc = __planoGetSelectedDiscId() || __planoGetDefaultDiscId();
  const defDisc = __planoGetDefaultDiscId();
  return (all||[]).filter(p=>{
    if(!p) return false;
    const pid = p.discId ? String(p.discId) : defDisc;
    return pid === disc;
  });
}


function __getPlanosTurmaAll(){
  if(!planosSemana) planosSemana = {};
  const key = __getPlanoStoreKey();
  if(!key || key === 'Todas') return [];
  if(!planosSemana[key]) planosSemana[key] = [];
  return planosSemana[key];
}

function __setPlanosForKey(arr){
  const key = __getPlanoStoreKey();
  if(!key || key === 'Todas') return;
  const disc = __planoGetSelectedDiscId() || __planoGetDefaultDiscId();
  const defDisc = __planoGetDefaultDiscId();
  const all = (__getPlanosTurmaAll()||[]).slice();
  const kept = all.filter(p=>{
    if(!p) return false;
    const pid = p.discId ? String(p.discId) : defDisc;
    return pid !== disc;
  });
  planosSemana[key] = kept.concat(arr||[]);
}


function __syncPlanoEscopoUI(){
  const wrap = document.getElementById('planoGeralAplicarWrap');
  const box = document.getElementById('planoTurmasChecklist');
  const st = document.getElementById('planoAplicarStatus');
  const esc = __getEscopoPlano();

  if(wrap){
    wrap.style.display = (esc === 'geral') ? 'block' : 'none';
  }
  if(st) st.textContent = '';

  if(esc === 'geral'){
    if(box) __renderChecklistTurmasPlano();
  }
}

function __renderChecklistTurmasPlano(){
  const box = document.getElementById('planoTurmasChecklist');
  if(!box) return;
  box.innerHTML = '';

  const list = (turmas || []).slice().sort((a,b)=>String(a).localeCompare(String(b), 'pt-BR'));
  if(list.length === 0){
    box.innerHTML = '<div style="font-size:12px; color:var(--text-muted);">Nenhuma turma cadastrada ainda.</div>';
    return;
  }

  list.forEach(t=>{
    const id = 'chkPlanoTurma_' + String(t).replace(/[^a-zA-Z0-9]/g,'_');
    const item = document.createElement('label');
    item.style.display = 'flex';
    item.style.gap = '8px';
    item.style.alignItems = 'center';
    item.style.padding = '8px 10px';
    item.style.border = '1px solid var(--border-color)';
    item.style.borderRadius = '12px';
    item.style.background = 'var(--card-bg)';
    item.style.cursor = 'pointer';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = t;
    cb.id = id;

    const sp = document.createElement('span');
    sp.textContent = t;
    sp.style.fontSize = '13px';
    sp.style.color = 'var(--text-main)';

    item.appendChild(cb);
    item.appendChild(sp);
    box.appendChild(item);
  });
}

function selecionarTodasTurmasPlano(){
  const box = document.getElementById('planoTurmasChecklist');
  if(!box) return;
  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = true);
}

function limparSelecaoTurmasPlano(){
  const box = document.getElementById('planoTurmasChecklist');
  if(!box) return;
  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = false);
}

function aplicarPlanoGeralNasTurmas(){
  if(__getEscopoPlano() !== 'geral') return;
  const box = document.getElementById('planoTurmasChecklist');
  const st = document.getElementById('planoAplicarStatus');
  const checked = box ? Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.value) : [];
  if(checked.length === 0) return showToast('Selecione ao menos uma turma.', 'error');

  const col = __collectPlanoFromUI();
  const inicio = col.inicio, fim = col.fim, aulas = col.aulas;
  if(!inicio || !fim) return showToast('Preencha a semana (início e fim).', 'error');

  const resumo = __planoBuildResumo(col);
  document.getElementById('planoSemanalResumo').value = resumo;

  const now = Date.now();
  const baseId = 'AP_' + (col.discId||'disc') + '_' + inicio + '_' + fim;

  checked.forEach(t=>{
    if(!planosSemana) planosSemana = {};
    if(!planosSemana[t]) planosSemana[t] = [];
    const planos = planosSemana[t];
    const plano = {id: baseId, inicio, fim, aulas: JSON.parse(JSON.stringify(aulas)), resumo, discId: col.discId, qtdAulas: col.qtdAulas, resumoModo: col.resumoModo, gruposDef: col.gruposDef, updatedAt: now, origem: 'geral'};
    const idx = planos.findIndex(x=>x.id===baseId);
    if(idx>=0) planos[idx] = plano; else planos.push(plano);
    planosSemana[t] = planos;
  });

  salvarDadosLocal();
  if(st) st.textContent = 'Aplicado para ' + __u(checked.length) + ' turma(s).';
  showToast('Plano aplicado para ' + __u(checked.length) + ' turma(s).', 'success');
}


function __formatDateBR(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split('-');
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

function __updatePlanoKeyPreview(){
  const ini = document.getElementById('planoSemanaInicio')?.value || '';
  const fim = document.getElementById('planoSemanaFim')?.value || '';
  const st = document.getElementById('planoSemanaStatus');
  if(st){
    if(ini && fim) st.innerText = `Semana: ${__formatDateBR(ini)} a ${__formatDateBR(fim)}`;
    else st.innerText = '';
  }
}

function __renderListaPlanosSemana(){
  const sel = document.getElementById('planoSemanaLista');
  if(!sel) return;
  const planos = __getPlanosTurma();
  const current = sel.value;
  sel.innerHTML = "";
  const opt0 = document.createElement('option');
  opt0.value = "";
  opt0.textContent = "— Selecionar —";
  sel.appendChild(opt0);

  planos
    .slice()
    .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))
    .forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id;
      const label = (p.inicio && p.fim) ? `${__formatDateBR(p.inicio)} a ${__formatDateBR(p.fim)}` : (p.id||"Plano");
      opt.textContent = label;
      sel.appendChild(opt);
    });

  // tenta manter seleção
  if(current){
    sel.value = current;
    if(!sel.value) sel.value = "";
  }
}

function __collectPlanoFromUI(){
  const inicioEl = document.getElementById('planoSemanaInicio');
  const fimEl = document.getElementById('planoSemanaFim');
  const inicio = inicioEl ? (inicioEl.value || '') : '';
  const fim = fimEl ? (fimEl.value || '') : '';

  const qtdEl = document.getElementById('planoQtdAulas');
  const qtdVal = qtdEl ? parseInt(qtdEl.value,10) : __planoQtdAulas;
  if(qtdVal && qtdVal !== __planoQtdAulas) planoSetQtdAulas(qtdVal);

  const aulas=[];
  for(let i=1;i<=__planoQtdAulas;i++){
    aulas.push({
      texto: (document.getElementById('pl_aula'+i+'_texto')||{}).value || '',
      conteudo: (document.getElementById('pl_aula'+i+'_conteudo')||{}).value || '',
      habilidades: (document.getElementById('pl_aula'+i+'_habilidades')||{}).value || '',
      objetivos: (document.getElementById('pl_aula'+i+'_objetivos')||{}).value || '',
      sensibilizacao: (document.getElementById('pl_aula'+i+'_sensibilizacao')||{}).value || '',
      desenvolvimento: (document.getElementById('pl_aula'+i+'_desenvolvimento')||{}).value || '',
      recursos: (document.getElementById('pl_aula'+i+'_recursos')||{}).value || '',
      avaliacao: (document.getElementById('pl_aula'+i+'_avaliacao')||{}).value || '',
      bloomNivel: (document.getElementById('pl_aula'+i+'_bloomNivel')||{}).value || '',
      bloomVerbo: (document.getElementById('pl_aula'+i+'_bloomVerbo')||{}).value || ''
    });
  }

  const discId = __planoGetSelectedDiscId() || __planoGetDefaultDiscId();
  const modoEl = document.getElementById('planoResumoModo');
  const resumoModo = modoEl ? (modoEl.value || 'por_aula') : 'por_aula';
  const gEl = document.getElementById('planoGruposDef');
  const gruposDef = gEl ? (gEl.value || '') : '';

  return {inicio, fim, aulas, discId, qtdAulas: __planoQtdAulas, resumoModo, gruposDef};
}


function __fillPlanoToUI(plano){
  if(!plano) return;

  const discSel = document.getElementById('planoDisciplina');
  const defDisc = __planoGetDefaultDiscId();
  const pid = plano.discId ? String(plano.discId) : defDisc;
  if(discSel && pid && Array.from(discSel.options).some(o=>o.value===pid)) discSel.value = pid;
  __planoDiscId = discSel ? (discSel.value||pid||'') : (pid||'');

  const prefs = __planoLoadPrefs(__planoDiscId);
  const qtd = plano.qtdAulas || (Array.isArray(plano.aulas)? plano.aulas.length : 0) || (prefs && prefs.qtdAulas) || 7;
  planoSetQtdAulas(qtd);

  document.getElementById('planoSemanaInicio').value = plano.inicio || '';
  document.getElementById('planoSemanaFim').value = plano.fim || '';

  const modoEl=document.getElementById('planoResumoModo');
  if(modoEl) modoEl.value = plano.resumoModo || modoEl.value || 'por_aula';
  const gEl=document.getElementById('planoGruposDef');
  if(gEl) gEl.value = (typeof plano.gruposDef==='string') ? plano.gruposDef : (gEl.value||'');
  planoResumoModoChanged(true);

  const arr = (plano.aulas||[]);
  for(let i=1;i<=__planoQtdAulas;i++){
    const a = arr[i-1] || {};
    const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = val||''; };
    set('pl_aula'+i+'_texto', a.texto);
    set('pl_aula'+i+'_conteudo', a.conteudo);
    set('pl_aula'+i+'_habilidades', a.habilidades);
    set('pl_aula'+i+'_objetivos', a.objetivos);
    set('pl_aula'+i+'_sensibilizacao', a.sensibilizacao);
    set('pl_aula'+i+'_desenvolvimento', a.desenvolvimento);
    set('pl_aula'+i+'_recursos', a.recursos);
    set('pl_aula'+i+'_avaliacao', a.avaliacao);
    set('pl_aula'+i+'_bloomNivel', a.bloomNivel);
    set('pl_aula'+i+'_bloomVerbo', a.bloomVerbo);
    try{ onBloomNivelChangePlano(i); }catch(e){}
  }

  __updatePlanoKeyPreview();
}


function novoPlanoSemana(){
  document.getElementById('planoSemanaLista').value = '';
  document.getElementById('planoSemanaInicio').value = '';
  document.getElementById('planoSemanaFim').value = '';

  const discId = __planoGetSelectedDiscId() || __planoGetDefaultDiscId();
  if(discId){
    const prefs = __planoLoadPrefs(discId);
    if(prefs && prefs.qtdAulas) planoSetQtdAulas(prefs.qtdAulas);
  }

  for(let i=1;i<=__planoMaxAulasDom;i++){
    ['texto','conteudo','habilidades','objetivos','sensibilizacao','desenvolvimento','recursos','avaliacao','bloomNivel','bloomVerbo'].forEach(k=>{
      const el = document.getElementById('pl_aula'+i+'_'+k);
      if(el) el.value = '';
    });
  }
  document.getElementById('planoSemanalResumo').value = '';
  __updatePlanoKeyPreview();
  showToast('Plano semanal pronto para preencher.', 'success');
}


function carregarPlanoSemana(id){
  const planos = __getPlanosTurma();
  const p = planos.find(x=>x.id===id);
  if(!p) return;
  __fillPlanoToUI(p);
  // também gera resumo se existir
  document.getElementById('planoSemanalResumo').value = p.resumo || "";
}

function salvarPlanoSemana(){
  const col = __collectPlanoFromUI();
  const inicio = col.inicio, fim = col.fim, aulas = col.aulas, discId = col.discId;
  if(!inicio || !fim) return showToast('Preencha a semana (início e fim).', 'error');
  const sel = document.getElementById('planoSemanaLista');
  const planos = __getPlanosTurma();

  const resumo = __planoBuildResumo(col);
  document.getElementById('planoSemanalResumo').value = resumo;

  const now = Date.now();
  let id = sel.value;
  if(!id){
    id = (discId||'disc') + '_' + inicio + '_' + fim + '_' + now;
  }
  const plano = {id, inicio, fim, aulas, resumo, discId, qtdAulas: col.qtdAulas, resumoModo: col.resumoModo, gruposDef: col.gruposDef, updatedAt: now};
  const idx = planos.findIndex(x=>x.id===id);
  if(idx>=0) planos[idx] = plano;
  else planos.push(plano);

  __setPlanosForKey(planos);
  salvarDadosLocal();
  __renderListaPlanosSemana();
  sel.value = id;
  showToast('Plano semanal salvo!', 'success');
}


function duplicarPlanoSemana(){
  const sel = document.getElementById('planoSemanaLista');
  const planos = __getPlanosTurma().slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  if(planos.length === 0) return showToast('Não há plano anterior para duplicar.', 'error');
  const base = sel.value ? __getPlanosTurma().find(x=>x.id===sel.value) : planos[0];
  if(!base) return showToast('Não há plano para duplicar.', 'error');

  const now = Date.now();
  const novo = JSON.parse(JSON.stringify(base));
  novo.id = (base.discId||'disc') + '_' + (base.inicio||'') + '_' + (base.fim||'') + '_dup_' + now;
  novo.updatedAt = now;
  novo.inicio = '';
  novo.fim = '';
  __fillPlanoToUI(novo);
  document.getElementById('planoSemanaLista').value = '';
  document.getElementById('planoSemanalResumo').value = '';
  showToast('Duplicado! Agora ajuste a semana e salve.', 'success');
}


function excluirPlanoSemana(){
  const sel = document.getElementById('planoSemanaLista');
  if(!sel.value) return showToast("Selecione um plano para excluir.", "error");
  if(!confirm("Excluir este plano semanal?")) return;
  const planos = __getPlanosTurma();
  const idx = planos.findIndex(x=>x.id===sel.value);
  if(idx>=0){
    planos.splice(idx,1);
    __setPlanosForKey(planos);
    salvarDadosLocal();
    __renderListaPlanosSemana();
    novoPlanoSemana();
    showToast("Plano excluído.", "success");
  }
}

function __limparTexto(t){
  if(!t) return "";
  return String(t).replace(/\r/g,'').trim();
}

function __safeLine(v){
  const t = __limparTexto(v);
  return t ? t : "—";
}

/* Monta o texto consolidado exatamente na ordem solicitada */
function __montarResumoPlano({inicio,fim,aulas}){
  const grupos = [
    {titulo:"Conteúdo", key:"conteudo"},
    {titulo:"Habilidades", key:"habilidades"},
    {titulo:"Objetivos", key:"objetivos"},
    {titulo:"Sensibilização", key:"sensibilizacao"},
    {titulo:"Desenvolvimento e estratégias da aula", key:"desenvolvimento"},
    {titulo:"Recursos utlizados na aula", key:"recursos"},
    {titulo:"Avaliação/Sistematização da aula", key:"avaliacao"},
  ];

  let out = "";
  if(inicio && fim){
    out += `Semana: ${__formatDateBR(inicio)} a ${__formatDateBR(fim)}\n\n`;
  }

  grupos.forEach(g=>{
    out += `${__u(g.titulo)}:\n\n`;
    aulas.forEach((a,idx)=>{
      const n = (a && a.__n != null) ? a.__n : (idx+1);
      let linha = __safeLine(a[g.key]);
      if(g.key === 'habilidades'){
        const bl = __limparTexto(a.bloomNivel);
        const vb = __limparTexto(a.bloomVerbo);
        const parts = [];
        if(bl) parts.push(`Bloom: ${bl}`);
        if(vb) parts.push(`Verbo: ${vb}`);
        if(parts.length){
          if(linha === "—") linha = "";
          linha = (linha ? (linha + " — ") : "") + parts.join(" | ");
        }
        if(!linha) linha = "—";
      }
      out += `Aula ${n} (${linha})\n`;
    });
    out += "\n";
  });

  return out.trim();
}

function __planoParseRange(val){
  val = String(val||'').trim();
  const m = /^\s*(\d)\s*[-:]\s*(\d)\s*$/.exec(val);
  if(!m) return {ini:1,fim:7};
  let ini = parseInt(m[1],10), fim = parseInt(m[2],10);
  if(!ini || !fim) return {ini:1,fim:7};
  if(ini>fim){ const t=ini; ini=fim; fim=t; }
  ini = Math.max(1, Math.min(7, ini));
  fim = Math.max(1, Math.min(7, fim));
  return {ini,fim};
}

function gerarResumoPlanoSemana(){
  const col = __collectPlanoFromUI();
  const inicio = col.inicio, fim = col.fim;
  if(!inicio || !fim) return showToast('Preencha a semana (início e fim).', 'error');
  const resumo = __planoBuildResumo(col);
  document.getElementById('planoSemanalResumo').value = resumo;
  showToast('Plano consolidado gerado.', 'success');
}


function copiarResumoPlanoSemana(){
  const t = document.getElementById('planoSemanalResumo').value || "";
  if(!t.trim()) return showToast("Nada para copiar.", "error");
  navigator.clipboard.writeText(t).then(()=>showToast("Copiado!", "success")).catch(()=>showToast("Não foi possível copiar.", "error"));
}

function exportarPlanoSemanaPDF(){
  const col = __collectPlanoFromUI();
  const inicio = col.inicio, fim = col.fim;
  if(!inicio || !fim) return showToast('Preencha a semana (início e fim).', 'error');
  const resumo = document.getElementById('planoSemanalResumo').value || __planoBuildResumo(col);
  document.getElementById('planoSemanalResumo').value = resumo;

  const box = document.getElementById('planoSemanalPrint');
  const esc = __getEscopoPlano();
  const turma = (esc === 'geral') ? 'Plano Geral' : (filtroTurma || 'Turma');
  const discName = __planoDiscName(col.discId || __planoGetSelectedDiscId());

  box.innerHTML = '' +
    '<h2 style="margin:0 0 6px 0;">Plano Semanal</h2>' +
    '<div style="margin-bottom:12px; font-size:12px;">' +
      '<div><b>Turma:</b> '+turma+'</div>' +
      (discName ? '<div><b>Disciplina:</b> '+discName+'</div>' : '') +
      '<div><b>Semana:</b> '+__formatDateBR(inicio)+' a '+__formatDateBR(fim)+'</div>' +
    '</div>' +
    '<pre style="white-space:pre-wrap; font-size:12px; line-height:1.35; border:1px solid #ddd; padding:12px; border-radius:8px;">'+resumo.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</pre>';

  const opt = { margin: 10, filename: 'plano_semanal_'+turma+'_'+(discName||'')+'_'+inicio+'_a_'+fim+'.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
  if(typeof html2pdf === 'function'){ html2pdf().set(opt).from(box).save(); }
  else {
    try{ __ensureHtml2pdfFallback(); html2pdf().set(opt).from(box).save(opt && opt.filename ? opt.filename : undefined); }
    catch(e){ try{ if(typeof showToast==='function') showToast('Exportar PDF indisponível.', 'error'); }catch(_){} }
  }
}


function __extrairCampos(txt){
  txt = __limparTexto(txt);
  if(!txt) return {};
  // normaliza
  const lower = txt.toLowerCase();

  const keys = [
    {key:'conteudo', labels:['conteúdo','conteudo']},
    {key:'habilidades', labels:['habilidades','habilidade']},
    {key:'objetivos', labels:['objetivos','objetivo']},
    {key:'sensibilizacao', labels:['sensibilização','sensibilizacao']},
    {key:'desenvolvimento', labels:['desenvolvimento e estratégias da aula','desenvolvimento e estrategias da aula','desenvolvimento e estratégias','desenvolvimento e estrategias','desenvolvimento','estratégias','estrategias']},
    {key:'recursos', labels:['recursos utlizados na aula','recursos utilizados na aula','recursos utilizados','recursos utlizados','recursos']},
    {key:'avaliacao', labels:['avaliação/sistematização da aula','avaliacao/sistematizacao da aula','avaliação/sistematização','avaliacao/sistematizacao','avaliação','avaliacao','sistematização','sistematizacao']},
  ];

  const found = [];
  keys.forEach(k=>{
    let best = -1;
    let bestLen = 0;
    k.labels.forEach(lab=>{
      // procura com separador ":" ou "-"
      const re = new RegExp(`(^|\\n)\\s*${lab.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&')}\\s*[:\\-]\\s*`, 'i');
      const m = re.exec(txt);
      if(m && (best === -1 || m.index < best)){
        best = m.index;
        bestLen = m[0].length;
      }
    });
    if(best !== -1){
      found.push({key:k.key, start: best, after: best + bestLen});
    }
  });

  found.sort((a,b)=>a.start-b.start);
  const out = {};
  found.forEach((f,idx)=>{
    const next = found[idx+1];
    const sliceEnd = next ? next.start : txt.length;
    const raw = txt.slice(f.after, sliceEnd);
    out[f.key] = __limparTexto(raw);
  });
  return out;
}

function extrairPlanoAula(n){
  const txt = document.getElementById(`pl_aula${n}_texto`)?.value || "";
  if(!txt.trim()) return showToast("Cole o texto da aula para extrair.", "error");
  const campos = __extrairCampos(txt);
  if(!campos || Object.keys(campos).length===0){
    return showToast("Não consegui identificar os títulos (Conteúdo, Habilidades, etc.).", "error");
  }
  const set = (k,val)=>{ const el=document.getElementById(`pl_aula${n}_${k}`); if(el && val) el.value = val; };
  set('conteudo', campos.conteudo);
  set('habilidades', campos.habilidades);
  set('objetivos', campos.objetivos);
  set('sensibilizacao', campos.sensibilizacao);
  set('desenvolvimento', campos.desenvolvimento);
  set('recursos', campos.recursos);
  set('avaliacao', campos.avaliacao);
  showToast(`Aula ${n}: informações extraídas.`, "success");
}

// Wrap safety for new functions (evita travar botões se der erro)
['abrirPlanoSemanal','novoPlanoSemana','carregarPlanoSemana','salvarPlanoSemana','duplicarPlanoSemana','excluirPlanoSemana','gerarResumoPlanoSemana','copiarResumoPlanoSemana','exportarPlanoSemanaPDF','extrairPlanoAula','togglePlanoSemanalFullscreen','planoLoteDistribuir','planoLoteDistribuirEExtrair','planoLoteLimpar','planoPreenchTab','planoPreenchAplicar','planoPreenchAplicarEProximo','planoPreenchLerCampo','selecionarTodasTurmasPlano','limparSelecaoTurmasPlano','aplicarPlanoGeralNasTurmas','onBloomNivelChangeCrono','onBloomNivelChangePlano','planoAdjustAulas','planoDisciplinaChanged','planoResumoModoChanged','planoSetQtdAulas']
  .forEach(fn=>{ try{ if(typeof __wrapSafeGlobal === 'function') __wrapSafeGlobal(fn); }catch(e){} });


/* ==========================
   PLANNER (v1) — Offline Tasks
   ========================== */

function _plannerEsc(str){
  return String(str ?? '').replace(/[&<>"']/g, (ch) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[ch]));
}
function _plannerUID(){
  try{ return (typeof _uid === 'function') ? _uid('pl') : ('pl_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6)); }
  catch(e){ return 'pl_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6); }
}
function _plannerLocalISODate(d){
  const dt = d instanceof Date ? d : new Date(d);
  const off = dt.getTimezoneOffset();
  return new Date(dt.getTime() - off*60000).toISOString().slice(0,10);
}
function _plannerStartOfDayISO(){
  return _plannerLocalISODate(new Date());
}

function _plannerStartOfWeekISO(isoDate){
  const base = isoDate ? new Date(isoDate + 'T00:00:00') : new Date();
  const day = base.getDay(); // 0 dom ... 6 sáb
  const diffToMon = (day === 0) ? -6 : (1 - day);
  const monday = new Date(base);
  monday.setDate(base.getDate() + diffToMon);
  monday.setHours(0,0,0,0);
  return _plannerLocalISODate(monday);
}
function _plannerAddDaysISO(isoDate, days){
  const d = new Date((isoDate || _plannerStartOfDayISO()) + 'T00:00:00');
  d.setDate(d.getDate() + (days||0));
  d.setHours(0,0,0,0);
  return _plannerLocalISODate(d);
}
function _plannerAddMonthsISO(isoDate, months){
  const d = new Date((isoDate || _plannerStartOfDayISO()) + 'T00:00:00');
  const y = d.getFullYear();
  const m = d.getMonth();
  const day = d.getDate();
  const target = new Date(y, m + (months||0), 1);
  const dim = new Date(target.getFullYear(), target.getMonth()+1, 0).getDate();
  target.setDate(Math.min(day, dim));
  target.setHours(0,0,0,0);
  return _plannerLocalISODate(target);
}
function _plannerParseDateTimeISO(task){
  const date = task?.date ? String(task.date) : '9999-12-31';
  const time = task?.time ? String(task.time) : '23:59';
  return date + 'T' + time;
}
function _plannerPriorityWeight(p){
  if(p === 'Alta') return 0;
  if(p === 'Média' || p === 'Media') return 1;
  return 2;
}


function plannerCoerceTasks(input){
  // Garantia de compatibilidade com versões antigas do storage/backup
  // Aceita: Array, objeto {tasks:[...]}, objeto-mapa {id:{...}}, ou string JSON.
  if(Array.isArray(input)) return input;
  if(!input) return [];
  try{
    if(typeof input === 'string'){
      return plannerCoerceTasks(JSON.parse(input));
    }
    if(typeof input === 'object'){
      if(Array.isArray(input.tasks)) return input.tasks;
      if(Array.isArray(input.items)) return input.items;
      // se for um mapa (id -> task), converte para lista
      const vals = Object.values(input);
      if(Array.isArray(vals) && vals.length && typeof vals[0] === 'object') return vals;
    }
  }catch(e){}
  return [];
}

function plannerNormalizeTasks(input){
  const arr = plannerCoerceTasks(input);
  return (arr||[]).filter(Boolean).map(t=>({
    id: t.id || _plannerUID(),
    title: (t.title ?? t.titulo ?? '').toString(),
    date: t.date || t.data || '',
    time: t.time || t.hora || '',
    turma: t.turma || '',
    bimestre: String((t.bimestre ?? t.bim ?? t.bimestreLetivo ?? t.bimestreEscolar ?? '') || ''),
    category: t.category || t.categoria || 'Geral',
    repeat: String((t.repeat ?? t.repeticao ?? t.recurrence ?? t.recorrencia ?? '') || ''),
    priority: t.priority || t.prioridade || 'Média',
    status: (t.status === 'done' || t.concluida) ? 'done' : 'open',
    notes: t.notes || t.obs || t.observacoes || '',
    createdAt: t.createdAt || Date.now(),
    updatedAt: t.updatedAt || Date.now()
  }));
}


function plannerLoadFromStorage(){
  try{
    const raw = localStorage.getItem('sgp_planner');
    plannerTasks = raw ? plannerNormalizeTasks(raw) : [];
  }catch(e){
    plannerTasks = [];
  }
}

function plannerPersist(){
  try{ __safeLSSet('sgp_planner', JSON.stringify(plannerCoerceTasks(plannerTasks))); }catch(e){}
}

function initPlanner(){
  // Normaliza dados do Planner (compatibilidade com versões antigas do storage/backup)
  plannerTasks = plannerNormalizeTasks(plannerTasks);
  if(!plannerTasks.length){
    // se carregarDados não trouxe, tenta do storage
    try{ if(localStorage.getItem('sgp_planner')) plannerLoadFromStorage(); }catch(e){}
  }
  // mantém o storage consistente (array normalizado)
  plannerPersist();

  // se o modal já estiver no DOM, prepara estado inicial do formulário
  const dateInp = document.getElementById('plannerDate');
  if(dateInp && !dateInp.value) dateInp.value = _plannerStartOfDayISO();

  // semana em foco (para a grade semanal)
  if(!plannerWeekAnchorISO) plannerWeekAnchorISO = _plannerStartOfWeekISO(_plannerStartOfDayISO());

  // define view inicial
  plannerSetView(plannerView || 'today', true);
}

function abrirPlanner(){
  abrirModal('modalPlanner');
  plannerRefreshTurmasUI();
  plannerClearForm();
  plannerRender();
  plannerUpdateFullscreenUI();
}

function plannerUpdateFullscreenUI(){
  const btn = document.getElementById('plannerFsBtn');
  if(!btn) return;
  const isFs = !!document.fullscreenElement;
  btn.innerHTML = isFs ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
  btn.title = isFs ? 'Sair da tela cheia' : 'Tela cheia';
  document.body.classList.toggle('planner-is-fullscreen', isFs);
}

function plannerToggleFullscreen(){
  const box = document.querySelector('#modalPlanner .modal-box');
  if(!box) return;
  try{
    if(document.fullscreenElement){
      if(document.exitFullscreen) document.exitFullscreen();
      else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
      else if(document.msExitFullscreen) document.msExitFullscreen();
      return;
    }
    const req = box.requestFullscreen || box.webkitRequestFullscreen || box.mozRequestFullScreen || box.msRequestFullscreen;
    if(req){
      // Alguns navegadores não aceitam navigationUI em file://, então tentamos sem.
      try{ req.call(box, {navigationUI:'hide'}); }catch(_){ req.call(box); }
    }else{
      // Fallback: apenas ajusta layout (sem modo fullscreen do navegador)
      document.body.classList.toggle('planner-is-fullscreen');
      plannerUpdateFullscreenUI();
    }
  }catch(e){
    document.body.classList.toggle('planner-is-fullscreen');
    plannerUpdateFullscreenUI();
  }
}

// Mantém o ícone sincronizado quando o usuário sai com ESC
document.addEventListener('fullscreenchange', plannerUpdateFullscreenUI);
document.addEventListener('webkitfullscreenchange', plannerUpdateFullscreenUI);
document.addEventListener('mozfullscreenchange', plannerUpdateFullscreenUI);
document.addEventListener('MSFullscreenChange', plannerUpdateFullscreenUI);


function plannerRefreshTurmasUI(){
  const turmasList = Array.isArray(turmas) ? turmas : [];
  const selFilter = document.getElementById('plannerFilterTurma');
  const selTurma  = document.getElementById('plannerTurma');

  const build = (sel, includeAll)=>{
    if(!sel) return;
    const current = sel.value;
    const opts = [];
    if(includeAll) opts.push({v:'all', t:'Todas as turmas'});
    else opts.push({v:'', t:'Sem turma'});
    turmasList.forEach(t=>{
      const nome = (typeof t === 'string') ? t : (t?.nome || t?.turma || '');
      if(nome) opts.push({v:nome, t:nome});
    });
    sel.innerHTML = opts.map(o=>`<option value="${_plannerEsc(o.v)}">${_plannerEsc(o.t)}</option>`).join('');
    // tenta manter seleção
    if(current && Array.from(sel.options).some(o=>o.value===current)) sel.value = current;
  };

  build(selFilter, true);
  build(selTurma, false);
}

function plannerSetView(view, skipRender){
  plannerView = view || 'today';
  const tabs = [
    ['plannerTabToday','today'],
    ['plannerTabWeek','week'],
    ['plannerTabAll','all']
  ];
  tabs.forEach(([id,v])=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(v===plannerView) el.classList.add('active');
    else el.classList.remove('active');
  });
  if(plannerView === 'week' && !plannerWeekAnchorISO) plannerWeekAnchorISO = _plannerStartOfWeekISO(_plannerStartOfDayISO());
  if(!skipRender) plannerRender();
}

function plannerComputeWeekRange(anchorISO){
  const start = _plannerStartOfWeekISO(anchorISO || plannerWeekAnchorISO || _plannerStartOfDayISO());
  const end = _plannerAddDaysISO(start, 6);
  return {start, end};
}

function plannerWeekNav(deltaDays){
  plannerWeekAnchorISO = _plannerAddDaysISO(plannerWeekAnchorISO || _plannerStartOfWeekISO(_plannerStartOfDayISO()), deltaDays);
  plannerRender();
}
function plannerWeekToday(){
  plannerWeekAnchorISO = _plannerStartOfWeekISO(_plannerStartOfDayISO());
  plannerRender();
}
function plannerQuickAddDate(iso){
  // pré-preenche data e abre editor
  const dateEl = document.getElementById('plannerDate');
  if(dateEl) dateEl.value = iso || _plannerStartOfDayISO();
  const stEl = document.getElementById('plannerStatus');
  if(stEl) stEl.value = 'open';
  plannerSelectedId = null;
  const ft = document.getElementById('plannerFormTitle'); if(ft) ft.innerText = 'Nova tarefa';
  const del = document.getElementById('plannerDeleteBtn'); if(del) del.style.display='none';
  const titleEl = document.getElementById('plannerTitle'); if(titleEl) titleEl.focus();
}

function plannerGetBaseFilteredTasks(){
  const q = (document.getElementById('plannerSearch')?.value || '').toLowerCase().trim();
  const st = (document.getElementById('plannerFilterStatus')?.value || 'open');
  const turma = (document.getElementById('plannerFilterTurma')?.value || 'all');
  const bim = (document.getElementById('plannerFilterBimestre')?.value || 'all');

  let list = plannerCoerceTasks(plannerTasks).slice();

  // status filter
  if(st === 'open') list = list.filter(t => t.status !== 'done');
  else if(st === 'done') list = list.filter(t => t.status === 'done');

  // turma filter
  if(turma !== 'all') list = list.filter(t => (t.turma || '') === turma);

  // bimestre filter
  if(bim !== 'all'){
    if(bim === '') list = list.filter(t => !(t.bimestre || ''));
    else list = list.filter(t => String(t.bimestre || '') === String(bim));
  }

  // search
  if(q){
    list = list.filter(t=>{
      const hay = (t.title + ' ' + (t.notes||'') + ' ' + (t.turma||'') + ' ' + (t.category||'') + ' ' + (t.bimestre||'') + ' ' + (t.repeat||'')).toLowerCase();
      return hay.includes(q);
    });
  }

  return list;
}

function plannerGetFilteredTasks(){
  const today = _plannerStartOfDayISO();
  const week = plannerComputeWeekRange();

  let list = plannerGetBaseFilteredTasks();

  // view filter
  if(plannerView === 'today'){
    list = list.filter(t => (t.date || '') === today);
  } else if(plannerView === 'week'){
    list = list.filter(t => {
      const d = (t.date || '');
      if(!d) return false;
      return d >= week.start && d <= week.end;
    });
  }

  // sort: open first, then date/time, then prioridade
  list.sort((a,b)=>{
    const sa = (a.status === 'done') ? 1 : 0;
    const sb = (b.status === 'done') ? 1 : 0;
    if(sa !== sb) return sa - sb;

    const da = _plannerParseDateTimeISO(a);
    const db = _plannerParseDateTimeISO(b);
    if(da < db) return -1;
    if(da > db) return 1;

    const pa = _plannerPriorityWeight(a.priority);
    const pb = _plannerPriorityWeight(b.priority);
    if(pa !== pb) return pa - pb;

    return (a.title||'').localeCompare(b.title||'');
  });

  return list;
}


function plannerBuildAlertsHTML(){
  const today = _plannerStartOfDayISO();
  const openTasks = (plannerTasks||[]).filter(t=>t.status!=='done');
  const overdue = openTasks.filter(t=>t.date && t.date < today).length;
  const dueToday = openTasks.filter(t=>(t.date||'')===today).length;

  const wk = plannerComputeWeekRange(_plannerStartOfDayISO());
  const dueWeek = openTasks.filter(t=>t.date && t.date >= wk.start && t.date <= wk.end).length;

  // por turma
  const byTurma = {};
  openTasks.forEach(t=>{
    const k = (t.turma||'').trim();
    if(!k) return;
    byTurma[k] = (byTurma[k]||0) + 1;
  });
  const topTurmas = Object.entries(byTurma).sort((a,b)=>b[1]-a[1]).slice(0,3);

  // por bimestre
  const byBim = {'1':0,'2':0,'3':0,'4':0};
  openTasks.forEach(t=>{
    const b = String(t.bimestre||'').trim();
    if(byBim.hasOwnProperty(b)) byBim[b] += 1;
  });

  const chips = [];
  if(overdue) chips.push(`<div class="planner-alert danger"><i class="fas fa-triangle-exclamation"></i> ${overdue} atrasada(s)</div>`);
  if(dueToday) chips.push(`<div class="planner-alert warn"><i class="fas fa-calendar-day"></i> ${dueToday} para hoje</div>`);
  if(dueWeek) chips.push(`<div class="planner-alert"><i class="fas fa-calendar-week"></i> ${dueWeek} nesta semana</div>`);
  if(!overdue && !dueToday && !dueWeek) chips.push(`<div class="planner-alert ok"><i class="fas fa-check"></i> Tudo em dia</div>`);

  const bimTxt = Object.entries(byBim).filter(([k,v])=>v>0).map(([k,v])=>`B${k}: ${v}`).join(' • ');
  if(bimTxt) chips.push(`<div class="planner-alert mini"><i class="fas fa-layer-group"></i> ${_plannerEsc(bimTxt)}</div>`);

  if(topTurmas.length){
    const ttxt = topTurmas.map(([k,v])=>`${k} (${v})`).join(' • ');
    chips.push(`<div class="planner-alert mini"><i class="fas fa-users"></i> ${_plannerEsc(ttxt)}</div>`);
  }

  return chips.join('');
}

function plannerDragTask(ev, id){
  try{ ev.dataTransfer.setData('text/plain', id); }catch(_){}
}
function plannerAllowDrop(ev){
  ev.preventDefault();
  const el = ev.currentTarget;
  if(el) el.classList.add('drop-hover');
}
function plannerDropOnDay(ev, iso){
  ev.preventDefault();
  const el = ev.currentTarget;
  if(el) el.classList.remove('drop-hover');
  const id = (ev.dataTransfer && ev.dataTransfer.getData('text/plain')) || '';
  if(!id) return;
  const idx = (plannerTasks||[]).findIndex(t=>t.id===id);
  if(idx<0) return;
  plannerTasks[idx].date = iso || '';
  plannerTasks[idx].updatedAt = Date.now();
  plannerPersist();
  plannerRender();
}
function plannerDropLeave(ev){
  const el = ev.currentTarget;
  if(el) el.classList.remove('drop-hover');
}

function plannerRenderWeekGrid(listEl){
  const base = plannerGetBaseFilteredTasks();
  const range = plannerComputeWeekRange();
  const today = _plannerStartOfDayISO();

  const weekTasks = base.filter(t=>{
    const d=(t.date||'');
    return d && d>=range.start && d<=range.end;
  });
  const undated = base.filter(t=>!(t.date||''));

  const names = ['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'];
  const cols = [];
  for(let i=0;i<7;i++){
    const iso = _plannerAddDaysISO(range.start, i);
    const d = iso.split('-').reverse().join('/');
    const tasks = weekTasks.filter(t=>(t.date||'')===iso);
    tasks.sort((a,b)=>_plannerParseDateTimeISO(a).localeCompare(_plannerParseDateTimeISO(b)));

    const cards = tasks.map(t=>{
      const isDone = t.status==='done';
      const isOverdue = (!isDone && t.date && t.date<today);
      const chips = [
        (t.time? `<span class="planner-chip"><i class="far fa-clock"></i> ${_plannerEsc(t.time)}</span>`:''),
        (t.turma? `<span class="planner-chip"><i class="fas fa-users"></i> ${_plannerEsc(t.turma)}</span>`:''),
        (t.bimestre? `<span class="planner-chip"><i class="fas fa-layer-group"></i> B${_plannerEsc(t.bimestre)}</span>`:''),
        (t.priority? `<span class="planner-chip"><i class="fas fa-flag"></i> ${_plannerEsc(t.priority)}</span>`:''),
        (t.repeat? `<span class="planner-chip repeat"><i class="fas fa-rotate"></i> ${_plannerEsc(plannerRepeatLabel(t.repeat))}</span>`:''),
        (isOverdue? `<span class="planner-chip overdue"><i class="fas fa-triangle-exclamation"></i> Atrasada</span>`:'')
      ].filter(Boolean).join('');
      return `
        <div class="planner-taskcard${isDone?' done':''}" draggable="true" ondragstart="plannerDragTask(event,'${_plannerEsc(t.id)}')" data-onclick="plannerSelectTask('${_plannerEsc(t.id)}')">
          <div class="t">${_plannerEsc(t.title||'(sem título)')}</div>
          <div class="m">${chips}</div>
        </div>
      `;
    }).join('') || `<div class="planner-empty" style="padding:10px; font-size:0.85rem;">—</div>`;

    cols.push(`
      <div class="planner-day" ondragover="plannerAllowDrop(event)" ondrop="plannerDropOnDay(event,'${iso}')" ondragleave="plannerDropLeave(event)">
        <div class="hd">
          <div>
            <div class="dname">${names[i]}</div>
            <div class="ddate">${d}</div>
          </div>
          <button class="btn-planner" style="padding:6px 10px;" data-onclick="plannerQuickAddDate('${iso}')"><i class="fas fa-plus"></i></button>
        </div>
        <div class="body">${cards}</div>
      </div>
    `);
  }

  const label = `${range.start.split('-').reverse().join('/')} — ${range.end.split('-').reverse().join('/')}`;
  const undatedCards = undated.length ? undated.map(t=>`
      <div class="planner-taskcard${t.status==='done'?' done':''}" draggable="true" ondragstart="plannerDragTask(event,'${_plannerEsc(t.id)}')" data-onclick="plannerSelectTask('${_plannerEsc(t.id)}')">
        <div class="t">${_plannerEsc(t.title||'(sem título)')}</div>
        <div class="m">
          ${t.turma? `<span class="planner-chip"><i class="fas fa-users"></i> ${_plannerEsc(t.turma)}</span>`:''}
          ${t.bimestre? `<span class="planner-chip"><i class="fas fa-layer-group"></i> B${_plannerEsc(t.bimestre)}</span>`:''}
          ${t.repeat? `<span class="planner-chip repeat"><i class="fas fa-rotate"></i> ${_plannerEsc(plannerRepeatLabel(t.repeat))}</span>`:''}
        </div>
      </div>
  `).join('') : `<div class="planner-empty" style="padding:10px; font-size:0.85rem;">(sem tarefas sem data)</div>`;

  listEl.innerHTML = `
    <div class="planner-weekbar">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn-planner" data-onclick="plannerWeekNav(-7)"><i class="fas fa-chevron-left"></i></button>
        <button class="btn-planner" data-onclick="plannerWeekToday()"><i class="fas fa-bullseye"></i> Hoje</button>
        <button class="btn-planner" data-onclick="plannerWeekNav(7)"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="wklabel"><i class="fas fa-calendar-week"></i> Semana: ${_plannerEsc(label)}</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn-planner" data-onclick="plannerQuickAddDate('${today}')"><i class="fas fa-plus"></i> Nova</button>
      </div>
    </div>
    <div class="planner-week-grid">${cols.join('')}</div>
    <div class="planner-undated">
      <div class="ttl"><i class="fas fa-inbox"></i> Sem data (arraste para a semana)</div>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:10px;">
        ${undatedCards}
      </div>
    </div>
  `;
}

function plannerRepeatLabel(rep){
  if(rep==='daily') return 'Diária';
  if(rep==='weekly') return 'Semanal';
  if(rep==='biweekly') return 'Quinzenal';
  if(rep==='monthly') return 'Mensal';
  return '';
}

function plannerRender(){
  const listEl = document.getElementById('plannerList');
  const statsEl = document.getElementById('plannerStats');
  const alertsEl = document.getElementById('plannerAlerts');
  if(!listEl) return;

  const today = _plannerStartOfDayISO();
  const filtered = plannerGetFilteredTasks();

  // stats gerais (não filtrados por busca/status, só para contexto)
  const total = (plannerTasks||[]).length;
  const open = (plannerTasks||[]).filter(t=>t.status!=='done').length;
  const dueToday = (plannerTasks||[]).filter(t=>t.status!=='done' && (t.date||'')===today).length;
  const overdue = (plannerTasks||[]).filter(t=>t.status!=='done' && (t.date||'') && (t.date < today)).length;

  if(statsEl){
    statsEl.innerHTML = `Total: <strong>${total}</strong> • Abertas: <strong>${open}</strong> • Hoje: <strong>${dueToday}</strong>` + (overdue ? ` • Atrasadas: <strong style="color:#dc2626">${overdue}</strong>` : '');
  }
  if(alertsEl){
    alertsEl.innerHTML = plannerBuildAlertsHTML();
  }

  // Grade semanal (drag & drop)
  if(plannerView === 'week'){
    plannerRenderWeekGrid(listEl);
    return;
  }

  if(!filtered.length){
    listEl.innerHTML = `<div class="planner-empty">Nada para mostrar aqui. Use o formulário à direita para criar uma tarefa.</div>`;
    return;
  }

  const htmlItems = filtered.map(t=>{
    const isDone = t.status === 'done';
    const isOverdue = (!isDone && t.date && t.date < today);
    const isActive = (plannerSelectedId && t.id === plannerSelectedId);
    const dt = (t.date ? t.date.split('-').reverse().join('/') : 'Sem data') + (t.time ? ` • ${__u(t.time)}` : '');
    const badges = [
      `<span class="planner-badge${isOverdue ? ' overdue':''}"><i class="far fa-calendar"></i> ${_plannerEsc(dt)}</span>`,
      (t.turma ? `<span class="planner-badge"><i class="fas fa-users"></i> ${_plannerEsc(t.turma)}</span>` : ''),
      (t.bimestre ? `<span class="planner-badge"><i class="fas fa-layer-group"></i> B${_plannerEsc(t.bimestre)}</span>` : ''),
      (t.category ? `<span class="planner-badge"><i class="fas fa-tag"></i> ${_plannerEsc(t.category)}</span>` : ''),
      (t.priority ? `<span class="planner-badge"><i class="fas fa-flag"></i> ${_plannerEsc(t.priority)}</span>` : ''),
      (t.repeat ? `<span class="planner-badge"><i class="fas fa-rotate"></i> ${_plannerEsc(plannerRepeatLabel(t.repeat))}</span>` : '')
    ].filter(Boolean).join('');

    return `
      <div class="planner-item${isDone?' done':''}${isActive?' active':''}" data-onclick="plannerSelectTask('${_plannerEsc(t.id)}')">
        <div class="t1">
          <div class="planner-title">
            <input type="checkbox" ${isDone?'checked':''} data-onclick="event.stopPropagation();" data-onchange="plannerToggleDone('${_plannerEsc(t.id)}', this.checked)">
            <div class="txt">${_plannerEsc(t.title || '(sem título)')}</div>
          </div>
          <div class="planner-item-actions">
            <button class="planner-delmini" title="Excluir" data-onclick="event.stopPropagation(); plannerDeleteById('${_plannerEsc(t.id)}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="planner-badges">${badges}</div>
      </div>
    `;
  }).join('');

  listEl.innerHTML = htmlItems;
}

function plannerSelectTask(id){
  const t = (plannerTasks||[]).find(x=>x.id===id);
  if(!t) return;

  plannerSelectedId = id;

  document.getElementById('plannerFormTitle').innerText = 'Editar tarefa';
  document.getElementById('plannerDeleteBtn').style.display = 'inline-flex';

  document.getElementById('plannerTitle').value = t.title || '';
  document.getElementById('plannerDate').value = t.date || '';
  document.getElementById('plannerTime').value = t.time || '';
  document.getElementById('plannerTurma').value = t.turma || '';
  const bimEl = document.getElementById('plannerBimestre'); if(bimEl) bimEl.value = (t.bimestre || '');
  document.getElementById('plannerCategory').value = t.category || 'Geral';
  const repEl = document.getElementById('plannerRepeat'); if(repEl) repEl.value = (t.repeat || '');
  document.getElementById('plannerPriority').value = t.priority || 'Média';
  document.getElementById('plannerStatus').value = t.status || 'open';
  document.getElementById('plannerNotes').value = t.notes || '';

  plannerRender();
}

function plannerClearForm(){
  plannerSelectedId = null;
  const today = _plannerStartOfDayISO();

  const ft = document.getElementById('plannerFormTitle');
  if(ft) ft.innerText = 'Nova tarefa';

  const delBtn = document.getElementById('plannerDeleteBtn');
  if(delBtn) delBtn.style.display = 'none';

  const title = document.getElementById('plannerTitle');
  if(title) title.value = '';

  const date = document.getElementById('plannerDate');
  if(date) date.value = today;

  const time = document.getElementById('plannerTime');
  if(time) time.value = '';

  const turma = document.getElementById('plannerTurma');
  if(turma) turma.value = '';

  
  const bimEl = document.getElementById('plannerBimestre');
  if(bimEl) bimEl.value = '';
const cat = document.getElementById('plannerCategory');
  if(cat) cat.value = 'Geral';

  
  const repEl = document.getElementById('plannerRepeat');
  if(repEl) repEl.value = '';
const pr = document.getElementById('plannerPriority');
  if(pr) pr.value = 'Média';

  const st = document.getElementById('plannerStatus');
  if(st) st.value = 'open';

  const notes = document.getElementById('plannerNotes');
  if(notes) notes.value = '';

  plannerRender();
}

function plannerNewTaskToday(){
  plannerSetView('today');
  plannerClearForm();
  const title = document.getElementById('plannerTitle');
  if(title) title.focus();
}

function plannerSaveFromForm(){
  const title = (document.getElementById('plannerTitle')?.value || '').trim();
  if(!title) return showToast ? showToast("Digite um título.", "error") : alert("Digite um título.");

  const task = {
    id: plannerSelectedId || _plannerUID(),
    title,
    date: document.getElementById('plannerDate')?.value || '',
    time: document.getElementById('plannerTime')?.value || '',
    turma: document.getElementById('plannerTurma')?.value || '',
    bimestre: String(document.getElementById('plannerBimestre')?.value || ''),
    category: document.getElementById('plannerCategory')?.value || 'Geral',
    repeat: String(document.getElementById('plannerRepeat')?.value || ''),
    priority: document.getElementById('plannerPriority')?.value || 'Média',
    status: document.getElementById('plannerStatus')?.value || 'open',
    notes: document.getElementById('plannerNotes')?.value || '',
    updatedAt: Date.now()
  };

  const idx = (plannerTasks||[]).findIndex(t=>t.id===task.id);
  if(idx >= 0){
    task.createdAt = plannerTasks[idx].createdAt || Date.now();
    plannerTasks[idx] = { ...plannerTasks[idx], ...task };
  } else {
    task.createdAt = Date.now();
    plannerTasks.unshift(task);
  }

  plannerPersist();
  plannerSelectedId = task.id;

  // após salvar, mantém o formulário em modo edição e mostra opção de excluir
  const ft = document.getElementById('plannerFormTitle');
  if(ft) ft.innerText = 'Editar tarefa';
  const db = document.getElementById('plannerDeleteBtn');
  if(db) db.style.display = 'inline-flex';

  if(showToast) showToast("Tarefa salva!");
  plannerRender();
}

function plannerNextDateForRepeat(task){
  const base = task.date || _plannerStartOfDayISO();
  const rep = (task.repeat || '').toString();
  if(!rep) return '';
  if(rep === 'daily') return _plannerAddDaysISO(base, 1);
  if(rep === 'weekly') return _plannerAddDaysISO(base, 7);
  if(rep === 'biweekly') return _plannerAddDaysISO(base, 14);
  if(rep === 'monthly') return _plannerAddMonthsISO(base, 1);
  return '';
}

function plannerToggleDone(id, checked){
  const idx = (plannerTasks||[]).findIndex(t=>t.id===id);
  if(idx < 0) return;

  const t = plannerTasks[idx];
  plannerTasks[idx].status = checked ? 'done' : 'open';
  plannerTasks[idx].updatedAt = Date.now();

  // recorrência: ao concluir, cria próxima ocorrência
  if(checked && t && t.repeat){
    const nextDate = plannerNextDateForRepeat(t);
    if(nextDate){
      const exists = (plannerTasks||[]).some(x =>
        x.id !== t.id &&
        (x.status !== 'done') &&
        (x.date || '') === nextDate &&
        (x.title || '') === (t.title || '') &&
        (x.turma || '') === (t.turma || '') &&
        String(x.bimestre || '') === String(t.bimestre || '') &&
        (x.repeat || '') === (t.repeat || '')
      );
      if(!exists){
        const nextTask = {
          ...t,
          id: _plannerUID(),
          status: 'open',
          date: nextDate,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };
        // mantém histórico: nova ocorrência no topo
        plannerTasks.unshift(nextTask);
      }
    }
  }

  plannerPersist();
  plannerRender();
}

function plannerDeleteById(id){
  if(!id) return;
  if(!confirm("Excluir esta tarefa?")) return;
  plannerTasks = (plannerTasks||[]).filter(t=>t.id!==id);
  plannerPersist();
  if(showToast) showToast("Tarefa excluída!");
  if(plannerSelectedId === id){
    plannerClearForm(); // já re-renderiza
  } else {
    plannerRender();
  }
}

function plannerDeleteSelected(){
  if(!plannerSelectedId) return;
  plannerDeleteById(plannerSelectedId);
}

function plannerExportJSON(){
  const payload = {
    exportedAt: Date.now(),
    planner: plannerTasks || []
  };
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"}));
  a.download = `sgp_planner_${_plannerStartOfDayISO()}.json`;
  a.click();
  if(showToast) showToast("Planner exportado!");
}

function plannerImportFile(input){
  const file = input?.files?.[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = (e)=>{
    try{
      const data = JSON.parse(e.target.result);
      const incoming = Array.isArray(data) ? data : (Array.isArray(data.planner) ? data.planner : (Array.isArray(data.tasks) ? data.tasks : []));
      if(!incoming.length) return showToast ? showToast("Arquivo sem tarefas.", "error") : alert("Arquivo sem tarefas.");
      const replace = confirm("Importar Planner: deseja SUBSTITUIR suas tarefas atuais? (OK = substituir / Cancelar = mesclar)");
      if(replace){
        plannerTasks = incoming;
      } else {
        const map = new Map((plannerTasks||[]).map(t=>[t.id, t]));
        incoming.forEach(t=>{
          const id = t.id || _plannerUID();
          if(!map.has(id)) map.set(id, {...t, id});
        });
        plannerTasks = Array.from(map.values());
      }
      // normaliza e salva
      plannerTasks = (plannerTasks||[]).filter(Boolean).map(t=>({
        id: t.id || _plannerUID(),
        title: (t.title ?? t.titulo ?? '').toString(),
        date: t.date || t.data || '',
        time: t.time || t.hora || '',
        turma: t.turma || '',
        bimestre: String((t.bimestre ?? t.bim ?? t.bimestreLetivo ?? t.bimestreEscolar ?? '') || ''),
        category: t.category || t.categoria || 'Geral',
        repeat: String((t.repeat ?? t.repeticao ?? t.recurrence ?? t.recorrencia ?? '') || ''),
        priority: t.priority || t.prioridade || 'Média',
        status: (t.status === 'done' || t.concluida) ? 'done' : 'open',
        notes: t.notes || t.obs || t.observacoes || '',
        createdAt: t.createdAt || Date.now(),
        updatedAt: Date.now()
      }));
      plannerPersist();
      plannerRefreshTurmasUI();
      plannerClearForm();
      plannerRender();
      if(showToast) showToast("Planner importado!");
    }catch(err){
      if(showToast) showToast("Erro ao importar Planner.", "error");
      else alert("Erro ao importar Planner.");
    }finally{
      input.value = '';
    }
  };
  r.readAsText(file);
}



/* ==========================
   ATIVIDADES (v1) — Forca / V-F / Memória
   ========================== */
const ACT_STORAGE = {
  forca: 'sgp_atividades_forca_bank',
  vf:    'sgp_atividades_vf_bank',
  mem:   'sgp_atividades_mem_bank',
  fc:    'sgp_atividades_fc_bank',
  rel:   'sgp_atividades_rel_bank',
  roleta:'sgp_atividades_roleta_bank'
};

let actTab = 'forca';
let actPresent = false;


let actLocked = true;

// Sorteador de alunos (Atividades/Games) — não repete até esgotar a turma
const ACT_SORTEIO_TURMA_STORAGE = 'sgp_atividades_sorteio_turma';
let __actSorteio = { turmaKey:'', pool:[], total:0, last:null };

function _actSorteioGetTurmaPref(){
  try{ return String(localStorage.getItem(ACT_SORTEIO_TURMA_STORAGE) || '').trim(); }catch(_){ return ''; }
}

function _actSorteioGetTurmasDisponiveis(){
  let arr = [];
  try{
    if(Array.isArray(turmas) && turmas.length){
      arr = turmas.map(t => String(t).trim()).filter(Boolean);
    }
  }catch(_){}
  if(!arr.length){
    try{
      const set = new Set();
      (Array.isArray(alunos) ? alunos : []).forEach(a=>{
        const t = a && (a.turma || a.turmaNome || a.classe || a.class);
        if(t) set.add(String(t).trim());
      });
      arr = Array.from(set);
    }catch(_){}
  }
  arr = arr.map(s=>String(s).trim()).filter(Boolean);
  arr = Array.from(new Set(arr));
  try{ arr.sort((a,b)=>a.localeCompare(b,'pt-BR',{numeric:true,sensitivity:'base'})); }catch(_){ arr.sort(); }
  return arr;
}

function _actSorteioSyncTurmaUI(){
  const sel = document.getElementById('actSorteioTurmaSel');
  if(!sel) return;

  const turmasList = _actSorteioGetTurmasDisponiveis();
  const pref = _actSorteioGetTurmaPref();

  // Reconstrói opções
  sel.innerHTML = '';
  const oAll = document.createElement('option');
  oAll.value = 'Todas';
  oAll.textContent = 'Todas as turmas';
  sel.appendChild(oAll);

  turmasList.forEach(t=>{
    const o = document.createElement('option');
    o.value = t;
    o.textContent = t;
    sel.appendChild(o);
  });

  // Define valor inicial: preferência salva > turma do menu (se não for "Todas") > "Todas"
  let val = pref || '';
  try{
    if(!val && typeof filtroTurma !== 'undefined' && filtroTurma && String(filtroTurma) !== 'Todas'){
      val = String(filtroTurma);
    }
  }catch(_){}
  if(!val) val = 'Todas';

  const exists = Array.from(sel.options).some(o=>o.value === val);
  sel.value = exists ? val : 'Todas';

  // Garante persistência
  try{ localStorage.setItem(ACT_SORTEIO_TURMA_STORAGE, sel.value); }catch(_){}
}

function actSorteioSetTurma(v){
  try{
    const val = String(v || 'Todas');
    try{ localStorage.setItem(ACT_SORTEIO_TURMA_STORAGE, val); }catch(_){}
    __actSorteio.last = null;
    _actSorteioBuildPool();
    _actSorteioRender();
  }catch(_){}
}

function _actSorteioTurmaKey(){
  // Prioridade: seletor do modal (turma do sorteio) -> preferência salva -> turma do menu -> "Todas"
  try{
    const v = String(document.getElementById('actSorteioTurmaSel')?.value || '').trim();
    if(v) return v;
  }catch(_){}
  try{
    const pref = _actSorteioGetTurmaPref();
    if(pref) return pref;
  }catch(_){}
  try{
    const t = (typeof filtroTurma !== 'undefined' && filtroTurma) ? String(filtroTurma) : '';
    if(t) return t;
  }catch(_){}
  return 'Todas';
}

function _actSorteioList(){

  const turma = _actSorteioTurmaKey() || 'Todas';
  let list = Array.isArray(alunos) ? alunos : [];
  if(turma && turma !== 'Todas') list = list.filter(a => (a && a.turma === turma));
  list = list.filter(a => a && a.nome).map(a => ({ id: a.id, nome: String(a.nome), turma: a.turma || turma }));
  return {turma, list};
}

function _actSorteioShuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
  }
  return arr;
}

function _actSorteioBuildPool(){
  const {turma, list} = _actSorteioList();
  __actSorteio.turmaKey = String(turma || 'Todas');
  __actSorteio.total = list.length;
  __actSorteio.pool = _actSorteioShuffle(list.slice());
}

function _actSorteioEnsurePool(){
  const key = String(_actSorteioTurmaKey() || 'Todas');
  if(__actSorteio.turmaKey !== key){
    __actSorteio.last = null;
    _actSorteioBuildPool();
  }
  if(!Array.isArray(__actSorteio.pool)) __actSorteio.pool = [];
  if(!Number.isFinite(__actSorteio.total)) __actSorteio.total = 0;
  if(__actSorteio.total === 0){
    // (re)calcula caso a turma tenha sido criada depois
    _actSorteioBuildPool();
  }
}

function _actSorteioRender(){
  const out = document.getElementById('actSorteioOut');
  const meta = document.getElementById('actSorteioMeta');
  const turma = String(__actSorteio.turmaKey || (_actSorteioTurmaKey() || 'Todas'));
  const total = Number(__actSorteio.total || 0);
  const rest = Array.isArray(__actSorteio.pool) ? __actSorteio.pool.length : 0;

  if(out){
    const nm = (__actSorteio.last && __actSorteio.last.nome) ? __actSorteio.last.nome : '—';
    out.textContent = nm;
    out.classList.toggle('has-name', nm !== '—');
    out.title = (nm !== '—') ? 'Clique para copiar o nome' : '—';
  }
  if(meta){
    meta.textContent = total ? `Turma: ${turma} · Restam: ${rest}/${total} · (sem repetir)` : `Turma: ${turma}`;
  }
}

function actSorteioAluno(){
  _actSorteioEnsurePool();
  if((__actSorteio.total || 0) <= 0){
    try{ _actToast('Nenhum aluno cadastrado nesta turma.', 'error'); }catch(_){ try{ if(showToast) showToast('Nenhum aluno cadastrado nesta turma.', 'error'); }catch(__){} }
    _actSorteioRender();
    return;
  }
  if(__actSorteio.pool.length === 0){
    _actSorteioBuildPool();
    try{ _actToast('Todos já foram sorteados. Reiniciando lista.', 'warn'); }catch(_){ }
  }
  const picked = __actSorteio.pool.pop();
  __actSorteio.last = picked || null;
  _actSorteioRender();
  try{ if(picked && picked.nome) _actToast('Sorteado: ' + picked.nome); }catch(_){ }
}

function actSorteioReset(silent=false){
  _actSorteioBuildPool();
  __actSorteio.last = null;
  _actSorteioRender();
  if(!silent){
    try{ _actToast('Sorteio reiniciado!'); }catch(_){ }
  }
}

function actSorteioCopiar(){
  try{
    const nm = (__actSorteio.last && __actSorteio.last.nome) ? String(__actSorteio.last.nome) : '';
    if(!nm) return;

    // Clipboard pode falhar em file:// ou sem permissão; fallback para prompt
    if(navigator.clipboard && location.protocol !== 'file:'){
      navigator.clipboard.writeText(nm).then(()=>{
        try{ _actToast('Nome copiado!'); }catch(_){ }
      }).catch(()=>{ try{ prompt('Copie o nome:', nm); }catch(_){ } });
    }else{
      try{ prompt('Copie o nome:', nm); }catch(_){ }
    }
  }catch(_){ }
}

function atividadesUpdateTeacherBtn(){
  const b = document.getElementById('actBtnTeacher');
  if(!b) return;
  if(actLocked){
    b.innerHTML = '<i class="fas fa-lock"></i> Professor';
    b.title = 'Modo professor: desbloquear edição do banco/config';
  }else{
    b.innerHTML = '<i class="fas fa-unlock"></i> Editar';
    b.title = 'Bloquear e ocultar banco/config (modo aluno)';
  }
}

function atividadesSetLocked(isLocked=true){
  actLocked = !!isLocked;
  const modal = document.getElementById('modalAtividades');
  if(modal) modal.classList.toggle('act-locked', actLocked);

  // Se entrar no modo professor (desbloqueado), desativa o modo apresentação
  // para que o painel de configuração/banco volte a aparecer.
  if(!actLocked){
    actPresent = false;
    if(modal) modal.classList.remove('act-present');
    const b = document.getElementById('actBtnPresent');
    if(b) b.innerHTML = '<i class="fas fa-tv"></i> Apresentar';
  }

  atividadesUpdateTeacherBtn();
}

function atividadesToggleTeacher(){
  // Alterna entre modo aluno (banco oculto) e modo professor (edição liberada)
  atividadesSetLocked(!actLocked);
}



// Bancos
let forcaBank = [];
let vfBank = [];
let memBank = [];
let fcBank = [];
let relBank = [];
let roletaBank = [];

// Estado Forca
let forcaState = {
  active: false,
  wordRaw: '',
  hint: '',
  theory: '',
  guessed: [], // letras base
  wrong: [],
  maxErr: 6,
  revealed: false,
  finished: false,
  lastResult: ''
};

// Sessão da Forca (usa o banco em sequência)
let forcaSession = {
  started: false,
  order: [],
  idx: 0
};

// Estado V/F
let vfState = {
  started: false,
  order: [],
  idx: 0,
  answered: false,
  choice: null
};

// Estado Memória
let memState = {
  started: false,
  cards: [],
  flipped: [],
  lock: false,
  moves: 0,
  matches: 0,
  target: 8,
  lastPairs: null
};

// Estado Flashcards
let fcState = {
  started: false,
  order: [],
  idx: 0,
  flipped: false
};

function _actToast(msg, type){
  try{
    if(typeof showToast === 'function') showToast(msg, type);
    else alert(msg);
  }catch(_){ alert(msg); }
}

function _actSafeParse(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    const data = JSON.parse(raw);
    return data;
  }catch(_){ return fallback; }
}

function _actNormalizeArray(v){
  if(Array.isArray(v)) return v;
  if(v && typeof v === 'object'){
    if(Array.isArray(v.items)) return v.items;
    if(Array.isArray(v.bank)) return v.bank;
    // mapa -> valores
    return Object.values(v);
  }
  return [];
}

function _actSaveAll(){
  try{
    __safeLSSet(ACT_STORAGE.forca, JSON.stringify(forcaBank));
    __safeLSSet(ACT_STORAGE.vf, JSON.stringify(vfBank));
    __safeLSSet(ACT_STORAGE.mem, JSON.stringify(memBank));
    __safeLSSet(ACT_STORAGE.fc, JSON.stringify(fcBank));
    __safeLSSet(ACT_STORAGE.rel, JSON.stringify(relBank));
    __safeLSSet(ACT_STORAGE.roleta, JSON.stringify(roletaBank));
  }catch(_){}
}

function initAtividades(){
  // Carrega bancos (com normalização)
  forcaBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.forca, []))
    .map(x => ({
      w: String(x?.w ?? x?.word ?? x?.palavra ?? '').trim(),
      h: String(x?.h ?? x?.hint ?? x?.dica ?? '').trim(),
      t: String(x?.t ?? x?.theory ?? x?.teoria ?? x?.explicacao ?? x?.exp ?? '').trim()
    }))
    .filter(x => x.w);

  vfBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.vf, []))
    .map(x => ({
      t: String(x?.t ?? x?.text ?? x?.frase ?? x?.pergunta ?? '').trim(),
      a: (String(x?.a ?? x?.ans ?? x?.resposta ?? 'V').toUpperCase()==='F') ? 'F' : 'V',
      e: String(x?.e ?? x?.exp ?? x?.teoria ?? x?.explicacao ?? x?.explain ?? '').trim()
    }))
    .filter(x => x.t);


  memBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.mem, []))
    .map(x => ({
      a: String(x?.a ?? x?.left ?? '').trim(),
      b: String(x?.b ?? x?.right ?? '').trim()
    }))
    .filter(x => x.a && x.b);

  fcBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.fc, []))
    .map(x => ({
      f: String(x?.f ?? x?.front ?? x?.frente ?? x?.pergunta ?? x?.q ?? '').trim(),
      b: String(x?.b ?? x?.back ?? x?.verso ?? x?.resposta ?? x?.a ?? '').trim(),
      g: String(x?.g ?? x?.tag ?? x?.tema ?? x?.categoria ?? '').trim()
    }))
    .filter(x => x.f && x.b);

  relBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.rel, []))
    .map(x => ({ a: String(x?.a||'').trim(), b: String(x?.b||'').trim() }))
    .filter(x => x.a && x.b);
  roletaBank = _actNormalizeArray(_actSafeParse(ACT_STORAGE.roleta, []))
    .map(x => String(x||'').trim()).filter(Boolean);

  _actSaveAll(); // garante formato atual

  // UI inicial
  try{ _forcaBuildKeyboard(); }catch(_){}
  forcaRenderBank();
  vfRenderBank();
  memRenderBank();
  fcRenderBank();
  try{relRenderBank();}catch(_){}
  try{roletaRenderList();}catch(_){}
  atividadesSetTab('forca');

  // Sorteador (sincroniza estado/UI)
  try{ _actSorteioSyncTurmaUI(); _actSorteioEnsurePool(); _actSorteioRender(); }catch(_){ }

  // Sincroniza UI de tela cheia
  try{
    if(!window.__ACT_FS_LISTENER){
      window.__ACT_FS_LISTENER = true;
      document.addEventListener('fullscreenchange', _atividadesSyncFullscreenUI);
      document.addEventListener('webkitfullscreenchange', _atividadesSyncFullscreenUI);
      document.addEventListener('mozfullscreenchange', _atividadesSyncFullscreenUI);
      document.addEventListener('MSFullscreenChange', _atividadesSyncFullscreenUI);
    }
  }catch(_){}

  // Letras no teclado (só quando modal aberto e forca ativa)
  document.addEventListener('keydown', function(e){
    const m = document.getElementById('modalAtividades');
    if(!m || m.style.display !== 'flex') return;
    if(e.key === 'Escape'){ fecharModais(); return; }
    if(actTab !== 'forca' || !forcaState.active) return;
    if(typeof e.key === 'string' && e.key.length === 1 && /[a-zA-Z]/.test(e.key)){
      forcaGuess(e.key.toUpperCase());
    }
  }, true);
}

function abrirAtividades(){
  abrirModal('modalAtividades');
  // Segurança: ao abrir, começa no modo aluno (banco/config ocultos)
  atividadesSetLocked(true);

  // Reset do modo apresentação (o professor pode ativar depois)
  actPresent = false;
  const modal = document.getElementById('modalAtividades');
  if(modal) modal.classList.remove('act-present');

  const b = document.getElementById('actBtnPresent');
  if(b) b.innerHTML = '<i class="fas fa-tv"></i> Apresentar';

  atividadesSetTab(actTab || 'forca');
  try{ _actSorteioSyncTurmaUI(); _actSorteioEnsurePool(); _actSorteioRender(); }catch(_){ }
}



function atividadesTogglePresent(){
  const modal = document.getElementById('modalAtividades');
  if(!modal) return;

  actPresent = !actPresent;

  // Em modo apresentação, garante que o banco/config fique oculto (modo aluno)
  if(actPresent && !actLocked){
    atividadesSetLocked(true);
  }

  modal.classList.toggle('act-present', actPresent);

  const b = document.getElementById('actBtnPresent');
  if(b){
    b.innerHTML = actPresent ? '<i class="fas fa-list"></i> Painéis' : '<i class="fas fa-tv"></i> Apresentar';
  }
}

function atividadesToggleFullscreen(){
  const modal = document.getElementById('modalAtividades');
  if(!modal) return;
  const box = modal.querySelector('.modal-box') || modal;
  const target = box;
  try{
    const isFs = !!document.fullscreenElement;
    if(!isFs){
      if(target.requestFullscreen) target.requestFullscreen();
      else if(target.webkitRequestFullscreen) target.webkitRequestFullscreen();
      else if(target.mozRequestFullScreen) target.mozRequestFullScreen();
      else if(target.msRequestFullscreen) target.msRequestFullscreen();
      else _actToast('Tela cheia não suportada neste navegador.', 'error');
    }else{
      if(document.exitFullscreen) document.exitFullscreen();
      else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
      else if(document.msExitFullscreen) document.msExitFullscreen();
    }
  }catch(_){
    _actToast('Não foi possível ativar tela cheia (permissão do navegador).', 'error');
  }
}

function _atividadesSyncFullscreenUI(){
  const modal = document.getElementById('modalAtividades');
  if(!modal) return;
  const fsEl = document.fullscreenElement;
  const isFs = !!(fsEl && (fsEl === modal || fsEl === modal.querySelector('.modal-box') || modal.contains(fsEl)));
  modal.classList.toggle('act-fullscreen', isFs);
  const b = document.getElementById('actBtnFullscreen');
  if(b){
    b.innerHTML = isFs ? '<i class="fas fa-compress"></i> Sair tela cheia' : '<i class="fas fa-expand"></i> Tela cheia';
  }
}


/* --- Tabs --- */
function atividadesSetTab(tab){
  actTab = tab;
  const modal = document.getElementById('modalAtividades');
  if(modal) modal.dataset.actTab = tab;
  atividadesUpdateTeacherBtn();
  const map = { forca:['actTabForca','actViewForca'], vf:['actTabVF','actViewVF'], mem:['actTabMem','actViewMem'], fc:['actTabFC','actViewFC'], quiz:['actTabQuiz','actViewQuiz'], comp:['actTabComp','actViewComp'], ord:['actTabOrd','actViewOrd'], rel:['actTabRel','actViewRel'], roleta:['actTabRoleta','actViewRoleta'], ws:['actTabWs','actViewWs'], cw:['actTabCw','actViewCw'] };
  Object.keys(map).forEach(k=>{
    const [btnId, viewId] = map[k];
    const btn = document.getElementById(btnId);
    const view = document.getElementById(viewId);
    if(btn) btn.classList.toggle('active', k===tab);
    if(view) view.style.display = (k===tab) ? 'block' : 'none';
  });
}

/* --- Export/Import (todas) --- */
function atividadesExportAll(){
  const payload = {
    version: 'sgp_atividades_v1',
    exportedAt: new Date().toISOString(),
    forcaBank, vfBank, memBank, fcBank, relBank, roletaBank
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'SGP_Atividades_Backup.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  _actToast('Atividades exportadas!');
}

function atividadesImportFile(input){
  const file = input?.files?.[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = function(){
    try{
      const data = JSON.parse(String(r.result || '{}'));
      const newForca = _actNormalizeArray(data?.forcaBank ?? data?.forca ?? []);
      const newVf    = _actNormalizeArray(data?.vfBank ?? data?.vf ?? []);
      const newMem   = _actNormalizeArray(data?.memBank ?? data?.mem ?? []);
      const newFc    = _actNormalizeArray(data?.fcBank ?? data?.flashcards ?? data?.fc ?? []);

      const replace = confirm("Importar atividades: deseja SUBSTITUIR seus bancos atuais? (OK = substituir / Cancelar = mesclar)");
      if(replace){
        forcaBank = newForca.map(x=>({ w:String(x?.w ?? x?.word ?? x?.palavra ?? '').trim(), h:String(x?.h ?? x?.hint ?? x?.dica ?? '').trim(), t:String(x?.t ?? x?.theory ?? x?.teoria ?? x?.explicacao ?? x?.exp ?? '').trim() })).filter(x=>x.w);
        vfBank = newVf.map(x=>({ t:String(x?.t ?? x?.text ?? x?.frase ?? x?.pergunta ?? '').trim(), a:(String(x?.a ?? x?.ans ?? x?.resposta ?? 'V').toUpperCase()==='F')?'F':'V', e:String(x?.e ?? x?.exp ?? x?.teoria ?? x?.explicacao ?? x?.explain ?? '').trim() })).filter(x=>x.t);
        memBank = newMem.map(x=>({ a:String(x?.a ?? x?.left ?? '').trim(), b:String(x?.b ?? x?.right ?? '').trim() })).filter(x=>x.a && x.b);
        fcBank = newFc.map(x=>({ f:String(x?.f ?? x?.front ?? x?.frente ?? x?.pergunta ?? x?.q ?? '').trim(), b:String(x?.b ?? x?.back ?? x?.verso ?? x?.resposta ?? x?.a ?? '').trim(), g:String(x?.g ?? x?.tag ?? x?.tema ?? x?.categoria ?? '').trim() })).filter(x=>x.f && x.b);
      }else{
        // mescla com dedupe simples
        const fKey = (x)=> (String(x.w||'')+'|'+String(x.h||'')).toUpperCase();
        const vKey = (x)=> (String(x.t||'')+'|'+String(x.a||'')).toUpperCase();
        const mKey = (x)=> (String(x.a||'')+'|'+String(x.b||'')).toUpperCase();
        const cKey = (x)=> (String(x.f||'')+'|'+String(x.b||'')+'|'+String(x.g||'')).toUpperCase();

        const fSet = new Set(forcaBank.map(fKey));
        newForca.forEach(x=>{
          const obj = { w:String(x?.w ?? x?.word ?? x?.palavra ?? '').trim(), h:String(x?.h ?? x?.hint ?? x?.dica ?? '').trim(), t:String(x?.t ?? x?.theory ?? x?.teoria ?? x?.explicacao ?? x?.exp ?? '').trim() };
          if(obj.w && !fSet.has(fKey(obj))){ forcaBank.push(obj); fSet.add(fKey(obj)); }
        });

        const vSet = new Set(vfBank.map(vKey));
        newVf.forEach(x=>{
          const obj = { t:String(x?.t ?? x?.text ?? x?.frase ?? x?.pergunta ?? '').trim(), a:(String(x?.a ?? x?.ans ?? x?.resposta ?? 'V').toUpperCase()==='F')?'F':'V', e:String(x?.e ?? x?.exp ?? x?.teoria ?? x?.explicacao ?? x?.explain ?? '').trim() };
          if(obj.t && !vSet.has(vKey(obj))){ vfBank.push(obj); vSet.add(vKey(obj)); }
        });

        const mSet = new Set(memBank.map(mKey));
        newMem.forEach(x=>{
          const obj = { a:String(x?.a ?? x?.left ?? '').trim(), b:String(x?.b ?? x?.right ?? '').trim() };
          if(obj.a && obj.b && !mSet.has(mKey(obj))){ memBank.push(obj); mSet.add(mKey(obj)); }
        });

        const cSet = new Set(fcBank.map(cKey));
        newFc.forEach(x=>{
          const obj = { f:String(x?.f ?? x?.front ?? x?.frente ?? x?.pergunta ?? x?.q ?? '').trim(), b:String(x?.b ?? x?.back ?? x?.verso ?? x?.resposta ?? x?.a ?? '').trim(), g:String(x?.g ?? x?.tag ?? x?.tema ?? x?.categoria ?? '').trim() };
          if(obj.f && obj.b && !cSet.has(cKey(obj))){ fcBank.push(obj); cSet.add(cKey(obj)); }
        });
      }

      // Import new game banks
      if(data.relBank && Array.isArray(data.relBank)){
        data.relBank.forEach(function(x){ var o={a:String(x?.a||'').trim(),b:String(x?.b||'').trim()}; if(o.a&&o.b) relBank.push(o); });
        try{relRenderBank();}catch(_){}
      }
      if(data.roletaBank && Array.isArray(data.roletaBank)){
        data.roletaBank.forEach(function(x){ var s=String(x||'').trim(); if(s) roletaBank.push(s); });
        try{roletaRenderList();}catch(_){}
      }

      _actSaveAll();
      forcaRenderBank(); vfRenderBank(); memRenderBank(); fcRenderBank();
      _actToast('Atividades importadas!');
    }catch(_){
      _actToast('Erro ao importar atividades.', 'error');
    }finally{
      input.value = '';
    }
  };
  r.readAsText(file);
}

/* ==========================
   FORCA
   ========================== */
function _forcaBaseChar(ch){
  try{ return String(ch).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase(); }
  catch(_){ return String(ch).toUpperCase(); }
}
function _forcaNormalizeWord(w){
  return String(w||'').trim().replace(/\s+/g,' ').toUpperCase();
}
function _forcaIsRevealChar(ch){
  return ch===' ' || ch==='-' || ch==='/' || ch==='·' || ch==='.' || ch===',' || ch===':' || ch===';' || ch==='!' || ch==='?';
}
function _forcaBuildKeyboard(){
  const el = document.getElementById('forcaKeyboard');
  if(!el) return;
  if(el.dataset.ready === '1') return;
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
  el.innerHTML = letters.map(L => `<button type="button" id="forcaKey_${L}" data-onclick="forcaGuess('${L}')">${L}</button>`).join('');
  el.dataset.ready = '1';
}
function forcaRenderBank(){
  const box = document.getElementById('forcaBancoList');
  const cnt = document.getElementById('forcaBancoCount');
  if(cnt) cnt.textContent = String(forcaBank.length);
  if(!box) return;
  if(forcaBank.length === 0){
    box.innerHTML = `<div class="act-mini">Banco vazio. Use “Banco” para guardar palavras.</div>`;
    return;
  }
  box.innerHTML = forcaBank.map((it, i) => `
    <div class="act-item">
      <div class="txt">
        <b>${_escHTML(it.w)}</b>
        <div class="act-mini">${it.h ? _escHTML(it.h) : '—'}</div>
        <div class="act-mini" style="opacity:.95;">${it.t ? ('<i class="fas fa-lightbulb"></i> ' + _escHTML(it.t).slice(0, 90) + (_escHTML(it.t).length>90?'…':'')) : '<i class="fas fa-lightbulb"></i> —'}</div>
      </div>
      <div style="display:flex; gap:6px; align-items:center;">
        <button class="btn-x" title="Usar" data-onclick="forcaUsarBanco(${i})"><i class="fas fa-play"></i></button>
        <button class="btn-x" title="Remover" data-onclick="forcaRemoverBanco(${i})"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  `).join('');
}
function forcaAdicionarAoBanco(){
  const w = _forcaNormalizeWord(document.getElementById('forcaPalavra')?.value || '');
  const h = String(document.getElementById('forcaDica')?.value || '').trim();
  const t = String(document.getElementById('forcaTeoria')?.value || '').trim();
  if(!w){ _actToast('Digite uma palavra para adicionar ao banco.', 'error'); return; }
  forcaBank.push({w, h, t});
  _actSaveAll();
  forcaRenderBank();

  // Mantém a edição fluida para criar sequências
  try{ document.getElementById('forcaPalavra').value = ''; }catch(_){}
  try{ document.getElementById('forcaDica').value = ''; }catch(_){}
  try{ document.getElementById('forcaTeoria').value = ''; }catch(_){}

  _actToast('Adicionado ao banco!');
}

function forcaLimparLista(){
  const ta = document.getElementById('forcaLista');
  if(ta) ta.value = '';
}

function forcaAdicionarLista(){
  const ta = document.getElementById('forcaLista');
  const raw = String(ta?.value || '').trim();
  if(!raw){ _actToast('Cole uma lista (1 por linha) para adicionar.', 'error'); return; }

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let added = 0;

  for(const line of lines){
    // Aceita: PALAVRA | DICA | TEORIA  (ou ; / TAB)
    let parts;
    if(line.includes('|')) parts = line.split('|');
    else if(line.includes(';')) parts = line.split(';');
    else if(line.includes('\t')) parts = line.split('\t');
    else parts = [line];

    parts = parts.map(p => String(p||'').trim());

    const w = _forcaNormalizeWord(parts[0] || '');
    if(!w) continue;

    const h = parts.length > 1 ? String(parts[1] || '').trim() : '';
    const t = parts.length > 2 ? parts.slice(2).join(' | ').trim() : '';
    forcaBank.push({w, h, t});
    added++;
  }

  if(added === 0){ _actToast('Nenhuma linha válida encontrada.', 'error'); return; }
  _actSaveAll();
  forcaRenderBank();
  _actToast(`Adicionados ${added} itens ao banco!`);

  // opcional: limpar campo após adicionar
  try{ ta.value = ''; }catch(_){}
}

function forcaRemoverBanco(i){
  if(i<0 || i>=forcaBank.length) return;
  forcaBank.splice(i,1);
  _actSaveAll();
  forcaRenderBank();
}
function forcaLimparBanco(){
  if(!confirm("Limpar o banco de palavras da Forca?")) return;
  forcaBank = [];
  _actSaveAll();
  forcaRenderBank();
  _actToast('Banco limpo.');
}
function forcaUsarBanco(i){
  const it = forcaBank[i];
  if(!it) return;
  document.getElementById('forcaPalavra').value = it.w;
  document.getElementById('forcaDica').value = it.h || '';
  const te = document.getElementById('forcaTeoria');
  if(te) te.value = (it.t || it.theory || it.teoria || '') || '';
  forcaIniciar();
}
function forcaSortear(){
  if(forcaBank.length === 0){ _actToast('Banco vazio. Adicione palavras primeiro.', 'error'); return; }
  const it = forcaBank[Math.floor(Math.random()*forcaBank.length)];
  document.getElementById('forcaPalavra').value = it.w;
  document.getElementById('forcaDica').value = it.h || '';
  const te = document.getElementById('forcaTeoria');
  if(te) te.value = (it.t || it.theory || it.teoria || '') || '';
  forcaIniciar();
}

function _forcaUpdateDrawing(){
  const svg = document.getElementById('forcaSvg');
  if(!svg) return;
  const parts = svg.querySelectorAll('.man .part');
  const n = Number(forcaState.wrong?.length || 0);
  parts.forEach(p=>{
    const step = parseInt(p.getAttribute('data-step')||'0', 10);
    p.classList.toggle('on', step>0 && step <= n);
  });
}

function _forcaStartWord(w, h, t){
  // Ao iniciar, oculta banco/config (modo aluno) para evitar respostas visíveis
  atividadesSetLocked(true);
  _forcaBuildKeyboard();
  const ww = _forcaNormalizeWord(w||'');
  const hh = String(h||'').trim();
  const tt = String(t||'').trim();
  if(!ww){ _actToast('Digite uma palavra para iniciar.', 'error'); return; }

  forcaState.active = true;
  forcaState.wordRaw = ww;
  forcaState.hint = hh;
  forcaState.theory = tt;
  forcaState.guessed = [];
  forcaState.wrong = [];
  forcaState.revealed = false;
  forcaState.finished = false;
  forcaState.lastResult = '';

  forcaUpdateUI();
}

function forcaIniciarSessao(){
  if(forcaBank.length === 0){ _actToast('Banco vazio. Adicione palavras primeiro.', 'error'); return; }
  // Sessão em sequência (ordem do banco)
  forcaSession.started = true;
  forcaSession.order = forcaBank.map((_,i)=>i);
  forcaSession.idx = 0;

  const it = forcaBank[forcaSession.order[0]];
  _forcaStartWord(it?.w, it?.h, it?.t);
  _actToast('Sessão iniciada!');
}

function forcaIniciar(){
  // Início manual (fora da sessão)
  forcaSession.started = false;
  forcaSession.order = [];
  forcaSession.idx = 0;

  const w = _forcaNormalizeWord(document.getElementById('forcaPalavra')?.value || '');
  const h = String(document.getElementById('forcaDica')?.value || '').trim();
  const t = String(document.getElementById('forcaTeoria')?.value || '').trim();
  _forcaStartWord(w, h, t);
}

function forcaReiniciar(){
  if(!forcaState.wordRaw){
    _actToast('Inicie um jogo primeiro.', 'error');
    return;
  }
  forcaState.active = true;
  forcaState.guessed = [];
  forcaState.wrong = [];
  forcaState.revealed = false;
  forcaState.finished = false;
  forcaState.lastResult = '';
  forcaUpdateUI();
}
function forcaRevelar(){
  if(!forcaState.wordRaw) return;
  forcaState.revealed = true;
  forcaState.active = false;
  forcaState.finished = true;
  forcaState.lastResult = 'reveal';
  forcaUpdateUI("Resposta revelada.");
}

function forcaProxima(){
  // Se não houver sessão ativa, tenta iniciar automaticamente a partir do banco.
  if((!forcaSession.started || !forcaSession.order.length)){
    if(forcaBank.length === 0){
      _actToast('Banco vazio. Adicione palavras primeiro.', 'error');
      return;
    }
    forcaSession.started = true;
    forcaSession.order = forcaBank.map((_,i)=>i);
    // coloca em -1 para que o próximo avanço vá para o primeiro item (0)
    forcaSession.idx = -1;
    _actToast('Sessão iniciada a partir do banco.');
  }

  if(forcaState.active){
    _actToast('Finalize a palavra atual antes de avançar.', 'error');
    return;
  }

  forcaSession.idx++;

  if(forcaSession.idx >= forcaSession.order.length){
    // Fim da sequência: encerra a sessão (não fica em loop)
    forcaSession.started = false;
    forcaSession.order = [];
    forcaSession.idx = 0;
    forcaUpdateUI('Sessão concluída! Clique em “Sessão” para reiniciar.');
    return;
  }

  const it = forcaBank[forcaSession.order[forcaSession.idx]];
  _forcaStartWord(it?.w, it?.h, it?.t);
}
function forcaGuess(letter){
  if(!forcaState.wordRaw || !forcaState.active) return;
  const L = _forcaBaseChar(letter);
  if(!/^[A-Z]$/.test(L)) return;
  if(forcaState.guessed.includes(L) || forcaState.wrong.includes(L)) return;

  const has = forcaState.wordRaw.split('').some(ch=>{
    if(_forcaIsRevealChar(ch)) return false;
    return _forcaBaseChar(ch) === L;
  });
  if(has) forcaState.guessed.push(L);
  else forcaState.wrong.push(L);

  // verifica vitória/derrota
  const masked = _forcaMasked();
  const done = masked.indexOf('_') === -1;
  const lost = forcaState.wrong.length >= forcaState.maxErr;

  if(done){
    forcaState.active = false;
    forcaState.finished = true;
    forcaState.lastResult = 'win';
    forcaUpdateUI("Acertou!");
  }else if(lost){
    forcaState.active = false;
    forcaState.revealed = true;
    forcaState.finished = true;
    forcaState.lastResult = 'lose';
    forcaUpdateUI("Fim de jogo.");
  }else{
    forcaUpdateUI();
  }
}
function _forcaMasked(){
  const w = forcaState.wordRaw || '';
  const out = [];
  for(let i=0;i<w.length;i++){
    const ch = w[i];
    if(_forcaIsRevealChar(ch)){ out.push(ch); continue; }
    const base = _forcaBaseChar(ch);
    out.push( (forcaState.revealed || forcaState.guessed.includes(base)) ? ch : '_' );
  }
  return out.join(' ');
}
function forcaUpdateUI(msg){
  const w = forcaState.wordRaw || '';
  const disp = document.getElementById('forcaDisplay');
  const erros = document.getElementById('forcaErros');
  const maxE = document.getElementById('forcaMaxErros');
  const erradas = document.getElementById('forcaErradas');
  const dica = document.getElementById('forcaDicaShow');
  const m = document.getElementById('forcaMsg');

  if(disp) disp.textContent = w ? _forcaMasked() : '—';
  if(erros) erros.textContent = String(forcaState.wrong.length || 0);
  if(maxE) maxE.textContent = String(forcaState.maxErr);
  if(erradas) erradas.textContent = (forcaState.wrong.length ? forcaState.wrong.join(', ') : '—');
  if(dica) dica.textContent = (forcaState.hint ? forcaState.hint : '—');
  if(m) m.textContent = msg || '';

  // Sessão (progresso)
  const sess = document.getElementById('forcaSessao');
  if(sess){
    if(forcaSession.started && forcaSession.order.length){
      sess.textContent = String(forcaSession.idx + 1) + '/' + String(forcaSession.order.length);
    }else{
      sess.textContent = '—';
    }
  }

  // Teoria (após acertar/errar/revelar)
  const tw = document.getElementById('forcaTheoryWrap');
  const tt = document.getElementById('forcaTheoryText');
  if(tw && tt){
    const show = (!forcaState.active && !!forcaState.wordRaw && !!forcaState.finished);
    tw.style.display = show ? 'block' : 'none';
    tt.textContent = show ? (forcaState.theory ? forcaState.theory : 'Sem explicação cadastrada para esta palavra.') : '';
  }

  // Botão Próxima (somente em sessão e após terminar)
  const bn = document.getElementById('forcaBtnNext');
  if(bn){
    const can = (!!forcaSession.started && !!forcaSession.order.length && !forcaState.active && !!forcaState.wordRaw);
    bn.disabled = !can;
  }

  // Desenho da forca
  _forcaUpdateDrawing();


  // atualiza teclado
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for(const L of letters){
    const b = document.getElementById('forcaKey_'+L);
    if(!b) continue;
    const used = forcaState.guessed.includes(L) || forcaState.wrong.includes(L);
    b.classList.toggle('hit', forcaState.guessed.includes(L));
    b.classList.toggle('miss', forcaState.wrong.includes(L));
    b.disabled = used || !forcaState.active;
  }
}

/* ==========================
   VERDADEIRO / FALSO
   ========================== */
function vfRenderBank(){
  const box = document.getElementById('vfList');
  const cnt = document.getElementById('vfCount');
  if(cnt) cnt.textContent = String(vfBank.length);
  if(!box) return;

  if(vfBank.length === 0){
    box.innerHTML = `<div class="act-mini">Banco vazio. Adicione perguntas.</div>`;
    vfUpdateSessionUI();
    return;
  }

  box.innerHTML = vfBank.map((it, i)=>{
    const ans = (it.a==='V') ? '<i class="fas fa-check"></i> Verdadeiro' : '<i class="fas fa-xmark"></i> Falso';
    const teor = (it.e || '').trim();
    const teorLine = teor ? `<div class="act-mini"><i class="fas fa-lightbulb"></i> ${_escHTML(teor.slice(0,120))}${teor.length>120?'…':''}</div>` : '';
    const tagLine = (it.tag||'').trim() ? `<span style="display:inline-block;background:#ede9fe;color:#7c3aed;padding:1px 6px;border-radius:4px;font-size:.68rem;margin-top:2px;">${_escHTML(it.tag)}</span>` : '';
    return `
      <div class="act-item">
        <div class="txt">
          <b>${_escHTML(ans)}</b> ${tagLine}
          <div class="act-mini">${_escHTML(it.t)}</div>
          ${teorLine}
        </div>
        <button class="btn-x" title="Remover" data-onclick="vfRemover(${i})"><i class="fas fa-trash"></i></button>
      </div>
    `;
  }).join('');

  vfUpdateSessionUI();
}

function vfAdicionar(){
  const t = String(document.getElementById('vfTexto')?.value || '').trim();
  const a = String(document.getElementById('vfResposta')?.value || 'V').toUpperCase()==='F' ? 'F' : 'V';
  const e = String(document.getElementById('vfTeoria')?.value || '').trim();
  const tag = String(document.getElementById('vfTag')?.value || '').trim();

  if(!t){ _actToast('Digite uma pergunta/afirmação para adicionar.', 'error'); return; }

  vfBank.push({ t, a, e, tag });

  document.getElementById('vfTexto').value = '';
  document.getElementById('vfTeoria').value = '';
  const tagEl=document.getElementById('vfTag'); if(tagEl) tagEl.value='';

  _actSaveAll();
  vfRenderBank();
  _actToast('Adicionado!');
}

function vfRemover(i){
  if(i<0 || i>=vfBank.length) return;
  vfBank.splice(i,1);
  _actSaveAll();
  vfRenderBank();
}

function vfLimparBanco(){
  if(!confirm("Limpar o banco de Verdadeiro/Falso?")) return;
  vfBank = [];
  vfResetSessao();
  _actSaveAll();
  vfRenderBank();
}

function vfEmbaralhar(){
  for(let i=vfBank.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [vfBank[i], vfBank[j]] = [vfBank[j], vfBank[i]];
  }
  _actSaveAll();
  vfRenderBank();
  _actToast('Embaralhado!');
}

function vfIniciarSessao(){
  // Ao iniciar, oculta banco/config (modo aluno) para evitar respostas visíveis
  atividadesSetLocked(true);

  if(vfBank.length === 0){ _actToast('Adicione perguntas antes de iniciar.', 'error'); return; }

  vfState.started = true;
  vfState.idx = 0;
  vfState.order = vfBank.map((_,i)=>i);

  // embaralha ordem da sessão
  for(let i=vfState.order.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [vfState.order[i], vfState.order[j]] = [vfState.order[j], vfState.order[i]];
  }

  vfState.answered = false;
  vfState.choice = null;

  const msg = document.getElementById('vfMsg');
  if(msg) msg.textContent = '';

  vfUpdateSessionUI();
}

function vfResetSessao(){
  vfState.started = false;
  vfState.idx = 0;
  vfState.order = [];
  vfState.answered = false;
  vfState.choice = null;
  const msg = document.getElementById('vfMsg');
  if(msg) msg.textContent = '';
  vfUpdateSessionUI();
}

function vfResponder(choice){
  if(!vfState.started || vfBank.length===0){ _actToast('Inicie uma sessão.', 'error'); return; }
  if(vfState.answered) return;

  const c = (String(choice||'V').toUpperCase()==='F') ? 'F' : 'V';
  vfState.answered = true;
  vfState.choice = c;

  vfUpdateSessionUI();
}

function vfProxima(){
  if(!vfState.started || vfBank.length===0){ _actToast('Inicie uma sessão.', 'error'); return; }

  if(!vfState.answered){
    _actToast('Peça para responder (V ou F) antes de avançar.', 'error');
    return;
  }

  vfState.idx++;

  if(vfState.idx >= vfState.order.length){
    // fim da sessão
    vfState.started = false;
    vfState.idx = 0;
    vfState.order = [];
    vfState.answered = false;
    vfState.choice = null;

    const msg = document.getElementById('vfMsg');
    if(msg) msg.textContent = 'Sessão concluída. Clique em “Iniciar sessão” para jogar novamente.';
    vfUpdateSessionUI();
    return;
  }

  vfState.answered = false;
  vfState.choice = null;

  vfUpdateSessionUI();
}

function vfUpdateSessionUI(){
  const show = document.getElementById('vfShow');
  const prog = document.getElementById('vfProgress');

  const choices = document.getElementById('vfChoices');
  const btnV = document.getElementById('vfBtnV');
  const btnF = document.getElementById('vfBtnF');
  const btnNext = document.getElementById('vfBtnNext');

  const badgeArea = document.getElementById('vfBadgeArea');
  const badgeAns = document.getElementById('vfBadgeAnswer');
  const badgeRes = document.getElementById('vfBadgeResult');

  const tw = document.getElementById('vfTheoryWrap');
  const tt = document.getElementById('vfTheoryText');

  if(!show || !prog) return;

  const setButtonsEnabled = (enabled)=>{
    if(btnV) btnV.disabled = !enabled;
    if(btnF) btnF.disabled = !enabled;
  };

  // Estado inicial (sem sessão)
  if(!vfState.started || vfBank.length === 0){
    prog.textContent = '—';
    show.textContent = (vfBank.length===0) ? 'Adicione perguntas para começar.' : 'Clique em “Iniciar sessão”.';

    if(choices) choices.style.display = 'none';
    setButtonsEnabled(false);

    if(badgeArea) badgeArea.style.display = 'none';
    if(tw) tw.style.display = 'none';
    if(btnNext) btnNext.disabled = true;

    return;
  }

  const total = vfState.order.length;
  const idx = vfState.order[vfState.idx] ?? 0;
  const it = vfBank[idx] || null;

  prog.textContent = `Pergunta ${vfState.idx+1}/${total}`;
  show.textContent = it ? it.t : '—';

  if(choices) choices.style.display = 'flex';

  // Enquanto não respondeu
  if(!vfState.answered){
    setButtonsEnabled(true);
    if(btnNext) btnNext.disabled = true;

    if(badgeArea) badgeArea.style.display = 'none';
    if(tw) tw.style.display = 'none';

    if(badgeRes){ badgeRes.classList.remove('vf-ok','vf-bad'); }
    if(badgeAns){ badgeAns.classList.remove('vfV','vfF'); }
    return;
  }

  // Após responder: mostra resultado + explicação
  setButtonsEnabled(false);
  if(btnNext) btnNext.disabled = false;

  if(!it){
    if(badgeArea) badgeArea.style.display = 'none';
    if(tw) tw.style.display = 'none';
    return;
  }

  const correct = (it.a==='F') ? 'F' : 'V';
  const choice = (vfState.choice==='F') ? 'F' : 'V';
  const ok = (choice === correct);

  if(badgeArea && badgeAns && badgeRes){
    badgeArea.style.display = 'flex';

    const ansTxt = (correct==='V') ? 'Verdadeiro' : 'Falso';
    badgeAns.textContent = ansTxt;
    badgeAns.classList.toggle('vfV', correct==='V');
    badgeAns.classList.toggle('vfF', correct!=='V');

    badgeRes.textContent = ok ? 'VOCÊ ACERTOU!' : 'VOCÊ ERROU!';
    badgeRes.classList.toggle('vf-ok', ok);
    badgeRes.classList.toggle('vf-bad', !ok);
  }

  if(tw && tt){
    const teor = String(it.e || '').trim();
    tw.style.display = 'block';
    tt.textContent = teor ? teor : 'Sem explicação cadastrada para esta pergunta.';
  }
}


/* ==========================
   MEMÓRIA
   ========================== */
function memRenderBank(){
  const box = document.getElementById('memList');
  const cnt = document.getElementById('memCount');
  if(cnt) cnt.textContent = String(memBank.length);
  if(!box) return;
  if(memBank.length === 0){
    box.innerHTML = `<div class="act-mini">Banco vazio. Adicione pares.</div>`;
    return;
  }
  box.innerHTML = memBank.map((it,i)=>`
    <div class="act-item">
      <div class="txt">
        <b>${_escHTML(it.a)}</b>
        <div class="act-mini">${_escHTML(it.b)}</div>
      </div>
      <button class="btn-x" title="Remover" data-onclick="memRemover(${i})"><i class="fas fa-trash"></i></button>
    </div>
  `).join('');
}
function memAdicionar(){
  const a = String(document.getElementById('memA')?.value || '').trim();
  const b = String(document.getElementById('memB')?.value || '').trim();
  if(!a || !b){ _actToast('Preencha os dois lados do par.', 'error'); return; }
  memBank.push({a,b});
  document.getElementById('memA').value = '';
  document.getElementById('memB').value = '';
  _actSaveAll();
  memRenderBank();
  _actToast('Par adicionado!');
}
function memRemover(i){
  if(i<0 || i>=memBank.length) return;
  memBank.splice(i,1);
  _actSaveAll();
  memRenderBank();
}
function memLimparBanco(){
  if(!confirm("Limpar o banco de pares da Memória?")) return;
  memBank = [];
  _actSaveAll();
  memRenderBank();
  memResetUI("Banco limpo. Adicione pares para jogar.");
}
function _memShuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function _memHueFor(i, total){
  // Paleta fixa (bons contrastes) — até 12 pares
  const hues = [12, 42, 72, 108, 140, 170, 200, 228, 256, 286, 316, 344];
  if(hues.length) return hues[(i % hues.length)];
  // fallback
  const t = Math.max(1, parseInt(total||8,10) || 8);
  return Math.round((i * 360) / t);
}
function memIniciar(nPairs){
  // Ao iniciar, oculta banco/config (modo aluno) para evitar respostas visíveis
  atividadesSetLocked(true);
  const n = Math.max(2, Math.min(12, parseInt(nPairs||8,10) || 8));
  if(memBank.length < n){
    _actToast(`Você precisa de pelo menos ${n} pares no banco.`, 'error');
    return;
  }
  const pool = memBank.slice();
  _memShuffle(pool);
  const chosen = pool.slice(0, n);
  memState.target = n;
  memState.moves = 0;
  memState.matches = 0;
  memState.lock = false;
  memState.flipped = [];
  memState.started = true;
  memState.lastPairs = chosen;

  const cards = [];
  chosen.forEach((p, idx)=>{
    const pid = 'p'+idx+'_'+Date.now().toString(36);
    const hue = _memHueFor(idx, n);
    cards.push({ id: pid+'_a', pairId: pid, pairHue: hue, text: p.a, state:'hidden' });
    cards.push({ id: pid+'_b', pairId: pid, pairHue: hue, text: p.b, state:'hidden' });
  });
  memState.cards = _memShuffle(cards);
  memRenderGrid();
  memUpdateBadges();
  memMsg('');
}
function memReiniciar(){
  if(memState.lastPairs){
    // reusa última seleção
    const n = memState.target || 8;
    const chosen = memState.lastPairs.slice(0, n);
    memState.moves = 0; memState.matches = 0; memState.lock=false; memState.flipped=[]; memState.started=true;

    const cards = [];
    chosen.forEach((p, idx)=>{
      const pid = 'p'+idx+'_'+Date.now().toString(36);
      const hue = _memHueFor(idx, n);
      cards.push({ id: pid+'_a', pairId: pid, pairHue: hue, text: p.a, state:'hidden' });
      cards.push({ id: pid+'_b', pairId: pid, pairHue: hue, text: p.b, state:'hidden' });
    });
    memState.cards = _memShuffle(cards);
    memRenderGrid();
    memUpdateBadges();
    memMsg('');
  }else{
    memIniciar(memState.target || 8);
  }
}
function memUpdateBadges(){
  const mv = document.getElementById('memMoves');
  const mm = document.getElementById('memMatches');
  const mt = document.getElementById('memTarget');
  if(mv) mv.textContent = String(memState.moves);
  if(mm) mm.textContent = String(memState.matches);
  if(mt) mt.textContent = String(memState.target);
}
function memMsg(t){
  const el = document.getElementById('memMsg');
  if(el) el.textContent = t || '';
}
function memResetUI(msg){
  memState.started = false;
  memState.cards = [];
  memState.flipped = [];
  memState.lock = false;
  memState.moves = 0;
  memState.matches = 0;
  memUpdateBadges();
  const grid = document.getElementById('memGrid');
  if(grid) grid.innerHTML = `<div class="act-mini">${_escHTML(msg||'Adicione pares para jogar.')}</div>`;
  memMsg('');
}
function memRenderGrid(){
  const grid = document.getElementById('memGrid');
  if(!grid) return;
  // Set grid class based on number of cards
  const n=memState.cards?memState.cards.length:0;
  grid.className='act-mgrid'+(n?(' grid-'+n):'');
  if(!memState.started || memState.cards.length === 0){
    grid.innerHTML = `<div class="act-mini">Adicione pares e clique em “Iniciar”.</div>`;
    return;
  }
  grid.innerHTML = memState.cards.map((c, idx)=>{
    const shown = (c.state === 'flipped' || c.state === 'matched');
    const cls = `act-mcard ${__u(c.state)} ${shown ? '' : 'hidden'} ${c.state==='matched'?'matched':''}`;
    const label = shown ? _escHTML(c.text) : '?';
    const hue = (c && (c.pairHue !== undefined && c.pairHue !== null)) ? c.pairHue : 248;
    return `<div class="${cls}" style="--pairHue:${hue};" role="button" tabindex="0" data-onclick="memFlip(${idx})" data-onkeydown="if(event.key==='Enter' || event.key===' '){ memFlip(${idx}); }">${label}</div>`;
  }).join('');
}
function memFlip(idx){
  if(memState.lock) return;
  const c = memState.cards[idx];
  if(!c || c.state === 'matched' || c.state === 'flipped') return;
  c.state = 'flipped';
  memState.flipped.push(idx);
  memRenderGrid();

  if(memState.flipped.length === 2){
    memState.lock = true;
    memState.moves++;
    memUpdateBadges();

    const [i1, i2] = memState.flipped;
    const c1 = memState.cards[i1];
    const c2 = memState.cards[i2];

    if(c1 && c2 && c1.pairId === c2.pairId){
      c1.state = 'matched';
      c2.state = 'matched';
      memState.matches++;
      memState.flipped = [];
      memState.lock = false;
      memUpdateBadges();
      memRenderGrid();
      if(memState.matches >= memState.target){
        memMsg("Você encontrou todos os pares!");
      }
    }else{
      setTimeout(()=>{
        const c1b = memState.cards[i1];
        const c2b = memState.cards[i2];
        if(c1b && c1b.state === 'flipped') c1b.state = 'hidden';
        if(c2b && c2b.state === 'flipped') c2b.state = 'hidden';
        memState.flipped = [];
        memState.lock = false;
        memRenderGrid();
      }, 700);
    }
  }
}


/* ==========================
   FLASHCARDS
   ========================== */
function fcRenderBank(){
  const box = document.getElementById('fcList');
  const cnt = document.getElementById('fcCount');
  if(cnt) cnt.textContent = String(fcBank.length);
  if(!box) return;
  if(fcBank.length === 0){
    box.innerHTML = `<div class="act-mini">Banco vazio. Adicione flashcards.</div>`;
    return;
  }
  box.innerHTML = fcBank.map((it,i)=>{
    const front = String(it.f||'').trim();
    const back  = String(it.b||'').trim();
    const tag   = String(it.g||'').trim();
    const backShort = back.length > 90 ? (back.slice(0, 90) + '…') : back;
    return `
      <div class="act-item">
        <div class="txt">
          <b>${_escHTML(front)}</b>
          <div class="act-mini">${_escHTML(backShort)}</div>
          ${tag ? `<div class="act-mini" style="opacity:.92;"><i class="fas fa-tag"></i> ${_escHTML(tag)}</div>` : ''}
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="btn-x" title="Ir para este cartão" data-onclick="fcIrPara(${i})"><i class="fas fa-play"></i></button>
          <button class="btn-x" title="Remover" data-onclick="fcRemover(${i})"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
  }).join('');
}

function fcAdicionar(){
  const f = String(document.getElementById('fcFront')?.value || '').trim();
  const b = String(document.getElementById('fcBack')?.value || '').trim();
  const g = String(document.getElementById('fcTag')?.value || '').trim();
  if(!f || !b){ _actToast('Preencha Frente e Verso do flashcard.', 'error'); return; }
  fcBank.push({f,b,g});
  try{ document.getElementById('fcFront').value = ''; }catch(_){ }
  try{ document.getElementById('fcBack').value = ''; }catch(_){ }
  try{ document.getElementById('fcTag').value = ''; }catch(_){ }
  _actSaveAll();
  fcRenderBank();
  _actToast('Flashcard adicionado!');
}

function fcRemover(i){
  if(i<0 || i>=fcBank.length) return;
  fcBank.splice(i,1);
  _actSaveAll();
  fcRenderBank();
  // se o item removido afetar a sessão, reinicia de forma segura
  if(fcState.started){
    fcIniciarSessao(false);
  }
}

function fcLimparBanco(){
  if(!confirm('Limpar o banco de Flashcards?')) return;
  fcBank = [];
  _actSaveAll();
  fcRenderBank();
  fcResetUI('Banco vazio. Adicione flashcards para começar.');
}

function fcResetUI(msg){
  fcState.started = false;
  fcState.order = [];
  fcState.idx = 0;
  fcState.flipped = false;
  const side = document.getElementById('fcSide');
  const text = document.getElementById('fcText');
  const hint = document.getElementById('fcHint');
  const prog = document.getElementById('fcProgress');
  if(side) side.textContent = 'Frente';
  if(text) text.textContent = msg || 'Adicione flashcards para começar.';
  if(hint) hint.style.display = 'none';
  if(prog) prog.textContent = '—';
  _fcSyncNavButtons();
  fcMsg('');
}

function _fcSyncNavButtons(){
  const prev = document.getElementById('fcBtnPrev');
  const next = document.getElementById('fcBtnNext');
  const has = fcState.started && fcState.order && fcState.order.length;
  const idx = fcState.idx || 0;
  const max = has ? (fcState.order.length - 1) : 0;
  if(prev) prev.disabled = !has || idx <= 0;
  if(next) next.disabled = !has || idx >= max;
}

function _fcCurrent(){
  if(!fcState.started || !fcState.order || fcState.order.length === 0) return null;
  const ix = fcState.order[fcState.idx];
  if(ix === undefined || ix === null) return null;
  return fcBank[ix] || null;
}

function fcRenderSessao(){
  const it = _fcCurrent();
  const side = document.getElementById('fcSide');
  const text = document.getElementById('fcText');
  const hint = document.getElementById('fcHint');
  const prog = document.getElementById('fcProgress');

  if(!fcState.started || !it){
    fcResetUI('Adicione flashcards para começar.');
    return;
  }

  const total = fcState.order.length;
  const pos = fcState.idx + 1;
  const tag = String(it.g || '').trim();
  if(prog) prog.textContent = `${pos}/${total}${tag ? ' • ' + tag : ''}`;

  const isBack = !!fcState.flipped;
  if(side) side.textContent = isBack ? 'Verso' : 'Frente';
  if(text) text.textContent = isBack ? String(it.b || '') : String(it.f || '');
  if(hint) hint.style.display = 'block';

  const card = document.getElementById('fcCard');
  if(card) card.classList.toggle('flipped', isBack);

  _fcSyncNavButtons();
}

function fcMsg(t){
  const el = document.getElementById('fcMsg');
  if(el) el.textContent = t || '';
}

function fcIniciarSessao(shuffle=false){
  // Ao iniciar, oculta banco/config (modo aluno) para evitar respostas visíveis
  atividadesSetLocked(true);
  if(!Array.isArray(fcBank) || fcBank.length === 0){
    _actToast('Adicione flashcards no banco para iniciar.', 'error');
    fcResetUI('Adicione flashcards para começar.');
    return;
  }
  fcState.started = true;
  fcState.order = fcBank.map((_,i)=>i);
  if(shuffle){
    try{ _memShuffle(fcState.order); }catch(_){ fcState.order.sort(()=>Math.random()-0.5); }
  }
  fcState.idx = 0;
  fcState.flipped = false;
  fcRenderSessao();
  fcMsg('');
}

function fcIrPara(i){
  if(!Array.isArray(fcBank) || fcBank.length === 0) return;
  if(!fcState.started || !Array.isArray(fcState.order) || fcState.order.length !== fcBank.length){
    fcIniciarSessao(false);
  }
  const idx = Math.max(0, Math.min(fcBank.length-1, parseInt(i,10)||0));
  fcState.idx = idx;
  fcState.flipped = false;
  fcRenderSessao();
}

function fcVirar(){
  if(!fcState.started) return;
  fcState.flipped = !fcState.flipped;
  fcRenderSessao();
}

function fcProximo(){
  if(!fcState.started) return;
  if(fcState.idx >= fcState.order.length - 1){
    fcMsg('Fim dos flashcards. Você pode Reiniciar ou escolher Aleatório.');
    _fcSyncNavButtons();
    return;
  }
  fcState.idx++;
  fcState.flipped = false;
  fcRenderSessao();
  fcMsg('');
}

function fcAnterior(){
  if(!fcState.started) return;
  if(fcState.idx <= 0){
    fcMsg('Você já está no primeiro flashcard.');
    _fcSyncNavButtons();
    return;
  }
  fcState.idx--;
  fcState.flipped = false;
  fcRenderSessao();
  fcMsg('');
}

function fcAleatorio(){
  if(!fcState.started){
    fcIniciarSessao(true);
    return;
  }
  const total = fcState.order.length;
  if(!total) return;
  const newIdx = Math.floor(Math.random() * total);
  fcState.idx = newIdx;
  fcState.flipped = false;
  fcRenderSessao();
  fcMsg('');
}

function fcReiniciar(){
  if(!fcState.started){
    fcIniciarSessao(false);
    return;
  }
  fcState.idx = 0;
  fcState.flipped = false;
  fcRenderSessao();
  fcMsg('');
}


window.addEventListener('load', function(){
  __loadExtras();
  applyThemeFromConfig();
  __HIST.lastSnapshot = __snapshotStr();
  __renderBackupsUI();
  // V13: Init new features
  try{ updatePlannerBadge(); }catch(_){}
  try{ initBackupReminder(); }catch(_){}
  try{ initIndexedDB(); }catch(_){}
});

// ===============================================
// V13 FEATURE 1: IMPORT CSV/EXCEL
// ===============================================
function abrirModalImportCSV(){
  let overlay = document.getElementById('modalImportCSV');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.id='modalImportCSV';
    overlay.className='modal-overlay';
    overlay.innerHTML=`<div class="modal-box" style="max-width:600px;">
      <h2><i class="fas fa-file-arrow-up"></i> Importar Alunos via CSV</h2>
      <p style="font-size:0.85rem;color:#64748b;">Formato aceito: <b>Nome;Turma</b> (uma linha por aluno). O separador pode ser <code>;</code> ou <code>,</code>.<br>Também aceita CSV com cabeçalho (<code>Nome;Turma</code> na primeira linha).</p>
      <div class="csv-drop-zone" id="csvDropZone">
        <i class="fas fa-cloud-arrow-up" style="font-size:2rem;"></i><br>
        Arraste um arquivo .csv aqui ou clique para selecionar
        <input type="file" id="csvFileInput" accept=".csv,.txt,.tsv" style="display:none;">
      </div>
      <div id="csvPreviewArea"></div>
      <div id="csvStatus" class="csv-status"></div>
      <div style="text-align:right;margin-top:16px;">
        <button data-onclick="fecharModais()" style="padding:8px 15px;border:none;background:transparent;cursor:pointer;color:var(--text-color);">Cancelar</button>
        <button id="btnConfirmCSV" class="btn-primary" data-onclick="confirmarImportCSV()" style="display:none;">Importar <span id="csvCountLabel">0</span> alunos</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    // Attach data-onclick handlers
    if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
    // Drop zone events
    const zone = document.getElementById('csvDropZone');
    const finp = document.getElementById('csvFileInput');
    zone.addEventListener('click', ()=> finp.click());
    zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', ()=> zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e)=>{ e.preventDefault(); zone.classList.remove('dragover'); if(e.dataTransfer.files.length) processCSVFile(e.dataTransfer.files[0]); });
    finp.addEventListener('change', ()=>{ if(finp.files.length) processCSVFile(finp.files[0]); finp.value=''; });
  }
  window.__csvParsedRows = [];
  document.getElementById('csvPreviewArea').innerHTML='';
  document.getElementById('csvStatus').textContent='';
  document.getElementById('btnConfirmCSV').style.display='none';
  overlay.style.display='flex';
}

function processCSVFile(file){
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length===0) return;
    // Detect separator
    const sep = (lines[0].includes(';')) ? ';' : ',';
    let startIdx = 0;
    const first = lines[0].split(sep).map(s=>s.trim().toLowerCase());
    if(first.includes('nome') || first.includes('name') || first.includes('aluno')){
      startIdx = 1; // skip header
    }
    const rows = [];
    for(let i=startIdx;i<lines.length;i++){
      const parts = lines[i].split(sep).map(s=>s.trim());
      if(parts.length>=2 && parts[0]){
        rows.push({nome: parts[0], turma: parts[1] || 'Sem turma'});
      } else if(parts.length===1 && parts[0]){
        rows.push({nome: parts[0], turma: filtroTurma!=='Todas'?filtroTurma:'Sem turma'});
      }
    }
    window.__csvParsedRows = rows;
    // Auto-detect new turmas
    const newTurmas = [...new Set(rows.map(r=>r.turma))].filter(t=>!turmas.includes(t));
    // Preview
    let html = `<table class="csv-preview-table"><thead><tr><th>#</th><th>Nome</th><th>Turma</th></tr></thead><tbody>`;
    rows.slice(0,50).forEach((r,i)=>{
      html+=`<tr><td>${i+1}</td><td>${escHTML(r.nome)}</td><td>${escHTML(r.turma)}</td></tr>`;
    });
    if(rows.length>50) html+=`<tr><td colspan="3" style="text-align:center;color:#64748b;">... e mais ${rows.length-50} alunos</td></tr>`;
    html+=`</tbody></table>`;
    document.getElementById('csvPreviewArea').innerHTML=html;
    let status = `${rows.length} aluno(s) encontrado(s).`;
    if(newTurmas.length) status += ` Novas turmas: ${newTurmas.join(', ')}`;
    document.getElementById('csvStatus').textContent=status;
    document.getElementById('csvCountLabel').textContent=rows.length;
    document.getElementById('btnConfirmCSV').style.display='inline-block';
  };
  reader.readAsText(file, 'UTF-8');
}

function confirmarImportCSV(){
  const rows = window.__csvParsedRows || [];
  if(rows.length===0) return showToast('Nenhum aluno para importar.','error');
  const dL=()=>({a1:0,a2:0,a3:0,a4:0,a5:0,rec:0});
  const dR=()=>({r1:0,r2:0,leit:0});
  const makeBim=()=>({notas_lp:dL(),media_lp:"0.0",notas_red:dR(),media_red:"0.0",entregas_red:{r1:'pendente',r2:'pendente'},livro:"",status_livro:"Pendente",comportamento:10,ocorrencias:[],parecer:""});
  let added=0;
  rows.forEach(r=>{
    if(!turmas.includes(r.turma)){ turmas.push(r.turma); }
    alunos.push({
      id: __newId(),
      nome: r.nome, turma: r.turma, mesa:null, inteligencias:[],
      bimestres:{1:makeBim(),2:makeBim(),3:makeBim(),4:makeBim()}
    });
    added++;
  });
  garantirEstruturaNova();
  salvarDadosLocal();
  fecharModais();
  initMenuTurmas(); renderizarMenu(); renderizarVisao();
  showToast(`${added} aluno(s) importados com sucesso!`);
}

// ===============================================
// V13 FEATURE 2: EXPORT CSV COMPLETO
// ===============================================
function exportarCSV(){
  const l=getAlunosFiltrados();
  if(l.length===0) return showToast("Nenhum dado para exportar.", "error");
  
  const d1 = getDiscById(config.slot1);
  const d2 = getDiscById(config.slot2);
  const avs1 = (d1?.avaliacoes||[]).map(a=>a.id);
  const avs2 = (d2?.avaliacoes||[]).map(a=>a.id);
  const nm1 = d1?.nome || config.materia1 || 'Mat1';
  const nm2 = d2?.nome || config.materia2 || 'Mat2';
  
  // Header
  let cols = ['ID','Nome','Turma','Bimestre'];
  avs1.forEach(id=> cols.push(`${nm1}_${id}`));
  cols.push(`${nm1}_Media`);
  avs2.forEach(id=> cols.push(`${nm2}_${id}`));
  cols.push(`${nm2}_Media`);
  cols.push('Comportamento','Parecer','Ocorrencias','Frequencia%');
  
  const sep = ';';
  let csv = '\uFEFF' + cols.join(sep) + '\n';
  
  l.forEach((a,idx)=>{
    const b = a.bimestres[bimestreAtual];
    if(!b) return;
    _syncBimestreRefs(b);
    let row = [idx+1, __u(a.nome), __u(a.turma), bimestreAtual];
    // Notas mat1
    avs1.forEach(id=>{ row.push(b.notas_lp?.[id]||0); });
    row.push(b.media_lp||'0.0');
    // Notas mat2
    avs2.forEach(id=>{ row.push(b.notas_red?.[id]||0); });
    row.push(b.media_red||'0.0');
    // Comportamento
    row.push(b.comportamento ?? 10);
    // Parecer
    row.push('"'+(__u(b.parecer||'')).replace(/"/g,'""')+'"');
    // Ocorrências
    const occs = (b.ocorrencias||[]).map(o=> `${o.data||''}: ${(o.tipo||'')} - ${(o.texto||'')}`).join(' | ');
    row.push('"'+(occs).replace(/"/g,'""')+'"');
    // Frequência
    const freq = calcFreqAluno(a.id, bimestreAtual);
    row.push(freq.pct.toFixed(1));
    csv += row.join(sep) + '\n';
  });
  
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href=url;
  link.download=`SGP_Export_Bim${bimestreAtual}_${filtroTurma||'Todas'}.csv`;
  link.click();
  URL.revokeObjectURL(url);
  showToast("CSV exportado com todas as notas!");
}

// ===============================================
// V13 FEATURE 3: IndexedDB as primary storage
// ===============================================
let __sgpDB = null;
const __IDB_NAME = 'SGP_Database';
const __IDB_VERSION = 1;
const __IDB_STORE = 'sgp_data';

function initIndexedDB(){
  if(!window.indexedDB) { console.warn('[SGP] IndexedDB não disponível.'); return; }
  try{
    const req = indexedDB.open(__IDB_NAME, __IDB_VERSION);
    req.onupgradeneeded = function(e){
      const db = e.target.result;
      if(!db.objectStoreNames.contains(__IDB_STORE)){
        db.createObjectStore(__IDB_STORE, {keyPath:'key'});
      }
    };
    req.onsuccess = function(e){
      __sgpDB = e.target.result;
      console.log('[SGP] IndexedDB inicializado.');
      // Mirror current state to IDB
      __idbSaveState();
    };
    req.onerror = function(e){
      console.warn('[SGP] IndexedDB erro:', e.target.error);
    };
  }catch(e){
    console.warn('[SGP] Falha ao inicializar IndexedDB:', e);
  }
}

function __idbSaveState(){
  if(!__sgpDB) return;
  try{
    const tx = __sgpDB.transaction([__IDB_STORE], 'readwrite');
    const store = tx.objectStore(__IDB_STORE);
    store.put({key:'core', value: __buildAtomicCoreState()});
    store.put({key:'planner', value: plannerTasks});
    store.put({key:'frequencia', value: window.__sgpFrequencia || {}});
    try{ store.put({key:'ranking', value: JSON.parse(localStorage.getItem('sgp_ranking_v1')||'{}')||{}}); }catch(_){}
    try{ store.put({key:'entregas', value: window.__sgpEntregas || {}}); }catch(_){}
    try{ store.put({key:'freq_events', value: window.__sgpFreqEvents || []}); }catch(_){}
    try{ store.put({key:'audit_log', value: window.__sgpAuditLog || []}); }catch(_){}
  }catch(e){
    console.warn('[SGP] IDB save error:', e);
  }
}

function __idbLoadState(){
  return new Promise((resolve, reject)=>{
    if(!__sgpDB) return reject('No DB');
    try{
      const tx = __sgpDB.transaction([__IDB_STORE], 'readonly');
      const store = tx.objectStore(__IDB_STORE);
      const req = store.get('core');
      req.onsuccess = function(){
        resolve(req.result ? req.result.value : null);
      };
      req.onerror = function(){ reject(req.error); };
    }catch(e){ reject(e); }
  });
}

// Hook into salvarDadosLocal to also save to IDB
const __origSalvarDadosLocal = salvarDadosLocal;
salvarDadosLocal = function(){
  __origSalvarDadosLocal();
  try{ __idbSaveState(); }catch(_){}
};

// ===============================================
// V13 FEATURE 4: FREQUENCY / CHAMADA
// ===============================================
// Data structure: window.__sgpFrequencia = { "turma|bimestre|date": { alunoId: "P"|"F"|"J" } }
window.__sgpFrequencia = {};
// v15.5: Frequência — alertas + performance/cache + trilha de eventos (mantém estrutura existente)
try{ window.__sgpFreqVersion = parseInt(localStorage.getItem('sgp_freq_version')||'0')||0; }catch(_){ window.__sgpFreqVersion=0; }
window.__sgpFreqAggCache = window.__sgpFreqAggCache || {version:-1, byBim:{}};
window.__sgpFreqDatesCache = window.__sgpFreqDatesCache || {version:-1, byTB:{}};
window.__sgpFreqEvents = window.__sgpFreqEvents || [];

function __freqBumpVersion(){
  try{
    window.__sgpFreqVersion = (window.__sgpFreqVersion||0)+1;
    __safeLSSet('sgp_freq_version', String(window.__sgpFreqVersion));
    __safeLSSet('sgp_last_freq_save', String(Date.now()));
  }catch(_){}
  try{ if(window.__sgpFreqAggCache) window.__sgpFreqAggCache.version = -1; }catch(_){}
  try{ if(window.__sgpFreqDatesCache) window.__sgpFreqDatesCache.version = -1; }catch(_){}
}

function __freqLoadEvents(){
  try{
    const raw = localStorage.getItem('sgp_freq_events');
    if(raw) window.__sgpFreqEvents = JSON.parse(raw) || [];
  }catch(_){ window.__sgpFreqEvents = []; }
}
function __freqSaveEvents(){
  try{ __safeLSSet('sgp_freq_events', JSON.stringify(window.__sgpFreqEvents||[])); }catch(_){}
}
function __freqPruneEvents(){
  try{
    const ev = window.__sgpFreqEvents || [];
    if(!ev.length) return;
    const now = Date.now();
    const maxAge = 1000*60*60*24*120; // 120 dias
    let filtered = ev.filter(e => (now - (e.ts||now)) <= maxAge);
    const maxLen = 2000;
    if(filtered.length > maxLen) filtered = filtered.slice(filtered.length - maxLen);
    window.__sgpFreqEvents = filtered;
  }catch(_){}
}
function __freqLogEvent(e){
  try{
    if(!e) return;
    e.ts = e.ts || Date.now();
    window.__sgpFreqEvents = window.__sgpFreqEvents || [];
    window.__sgpFreqEvents.push(e);
    __freqPruneEvents();
    __freqSaveEvents();
  }catch(_){}
}
try{ __freqLoadEvents(); }catch(_){}


function __loadFrequencia(){
  try{
    const raw = localStorage.getItem('sgp_frequencia');
    if(raw){ window.__sgpFrequencia = JSON.parse(raw) || {}; }
  }catch(_){ window.__sgpFrequencia = {}; }
}
function __saveFrequencia(){
  try{
    __safeLSSet('sgp_frequencia', JSON.stringify(window.__sgpFrequencia));
    try{ __idbSaveState(); }catch(_){}
    try{ __freqBumpVersion(); }catch(_){}
  }catch(_){}
}
// Load on start
try{ __loadFrequencia(); }catch(_){}

function __freqEnsureAggForBim(bim){
  const cache = window.__sgpFreqAggCache || (window.__sgpFreqAggCache={version:-1, byBim:{}});
  const v = window.__sgpFreqVersion || 0;
  if(cache.version===v && cache.byBim && cache.byBim[bim]) return cache.byBim[bim];

  const freq = window.__sgpFrequencia || {};
  const agg = {};
  Object.keys(freq).forEach(key=>{
    const parts = key.split('|');
    if(parseInt(parts[1])!==bim) return;
    const reg = freq[key] || {};
    const meta = reg._meta || {};
    const qtd = Math.max(1, parseInt(meta.qtdAulas)||1);
    Object.keys(reg).forEach(k=>{
      if(k==='_meta') return;
      const val = reg[k];
      if(!val) return;
      const kk = String(k);
      const a = agg[kk] || (agg[kk]={total:0, presentes:0, faltas:0, justificadas:0});
      a.total += qtd;
      if(val==='P') a.presentes += qtd;
      else if(val==='F') a.faltas += qtd;
      else if(val==='J'){ a.justificadas += qtd; a.presentes += qtd; }
    });
  });

  cache.version = v;
  cache.byBim = cache.byBim || {};
  cache.byBim[bim] = agg;
  return agg;
}

function __freqEnsureDatesCache(){
  const cache = window.__sgpFreqDatesCache || (window.__sgpFreqDatesCache={version:-1, byTB:{}});
  const v = window.__sgpFreqVersion || 0;
  if(cache.version===v && cache.byTB) return cache;

  cache.version = v;
  cache.byTB = {};
  const freq = window.__sgpFrequencia || {};

  Object.keys(freq).forEach(key=>{
    const parts = key.split('|');
    if(parts.length<3) return;
    const turma = parts[0];
    const bim = parseInt(parts[1])||0;
    const dt = parts[2];
    const reg = freq[key] || {};
    let has=false;
    for(const k in reg){
      if(k==='_meta') continue;
      if(reg[k]){ has=true; break; }
    }
    if(!has) return;
    const tb = `${turma}|${bim}`;
    (cache.byTB[tb]||(cache.byTB[tb]=[])).push(dt);
  });

  Object.keys(cache.byTB).forEach(tb=>{
    cache.byTB[tb] = Array.from(new Set(cache.byTB[tb])).sort();
  });
  return cache;
}

function __freqGetDatesTurmaBim(turma, bim){
  const cache = __freqEnsureDatesCache();
  return cache.byTB?.[`${turma}|${bim}`] || [];
}

function calcFreqAluno(alunoId, bim){
  const agg = __freqEnsureAggForBim(bim);
  const id = String(alunoId);
  const a = (agg && agg[id]) ? agg[id] : {total:0, presentes:0, faltas:0, justificadas:0};
  const total = a.total||0, presentes = a.presentes||0, faltas = a.faltas||0, justificadas = a.justificadas||0;
  const pct = total>0 ? (presentes/total*100) : 100;
  return {total, presentes, faltas, justificadas, pct};
}

// Data local (YYYY-MM-DD) — evita bug de fuso (ex.: Brasil UTC-3) quando usar toISOString()
function __localISODate(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function __freqTodayStr(){ return __localISODate(new Date()); }
// Helpers de semana (base local) — usados para relatórios semanais de ausências
function __freqAddDaysISO(dateStr, days){
  try{
    const d = new Date((dateStr||__freqTodayStr())+'T12:00:00');
    d.setDate(d.getDate() + (parseInt(days,10)||0));
    return __localISODate(d);
  }catch(_){ return dateStr||__freqTodayStr(); }
}
function __freqWeekStartISO(dateStr){
  try{
    const d = new Date((dateStr||__freqTodayStr())+'T12:00:00');
    const wd = d.getDay(); // 0 dom ... 6 sáb
    const diff = (wd===0 ? -6 : (1 - wd)); // segunda-feira
    d.setDate(d.getDate() + diff);
    return __localISODate(d);
  }catch(_){ return __freqTodayStr(); }
}
function __freqWeekLabel(startStr){
  try{
    const endStr = __freqAddDaysISO(startStr, 6);
    const a = new Date(startStr+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
    const b = new Date(endStr+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
    return `${a}–${b}`;
  }catch(_){ return startStr||''; }
}

function __freqIsWeekend(dateStr){
  const d = new Date((dateStr||__freqTodayStr())+'T00:00:00');
  const w = d.getDay();
  return (w===0 || w===6);
}
function __freqBusinessDaysBetween(fromStr, toStr){
  try{
    if(!fromStr || !toStr) return 0;
    let from = new Date(fromStr+'T00:00:00'); from.setHours(0,0,0,0);
    let to = new Date(toStr+'T00:00:00'); to.setHours(0,0,0,0);
    if(to<=from) return 0;
    let days=0;
    const cur=new Date(from.getTime());
    while(cur<to){
      cur.setDate(cur.getDate()+1);
      const w=cur.getDay();
      if(w!==0 && w!==6) days++;
      if(days>400) break;
    }
    return days;
  }catch(_){ return 0; }
}

function __freqPendenciaHojeTurma(turma, bim){
  const today = __freqTodayStr();
  if(__freqIsWeekend(today)) return {skip:true, today};
  const lista = alunos.filter(a=>a.turma===turma);
  const total = lista.length;
  const key = `${turma}|${bim}|${today}`;
  const reg = (window.__sgpFrequencia||{})[key] || null;
  if(!reg){
    return {skip:false, today, total, missing:true, filled:0, incomplete:total, key};
  }
  let filled=0;
  lista.forEach(a=>{ if(reg[a.id]) filled++; });
  const incomplete = Math.max(0, total - filled);
  return {skip:false, today, total, missing:false, filled, incomplete, key};
}

function __freqUltimoRegistroTurma(turma, bim){
  const dates = __freqGetDatesTurmaBim(turma, bim);
  return dates.length ? dates[dates.length-1] : '';
}

function __freqAlunosBaixaFreq(turma, bim, threshold){
  const thr = (typeof threshold==='number') ? threshold : 75;
  const lista = alunos.filter(a=>a.turma===turma).map(a=>{
    const f = calcFreqAluno(a.id, bim);
    return {id:a.id, nome:a.nome, pct:f.pct, faltas:f.faltas, total:f.total};
  }).filter(x=>x.total>0 && x.pct < thr)
    .sort((a,b)=>a.pct-b.pct);
  return lista;
}

function __freqAlunosStreakF(turma, bim, streakLen){
  const len = streakLen||3;
  const dates = __freqGetDatesTurmaBim(turma, bim);
  if(!dates.length) return [];
  const freq = window.__sgpFrequencia||{};
  const lista = alunos.filter(a=>a.turma===turma);
  const out=[];
  lista.forEach(a=>{
    let streak=0;
    for(let i=dates.length-1;i>=0;i--){
      const key = `${turma}|${bim}|${dates[i]}`;
      const reg = freq[key] || {};
      const v = reg[a.id];
      if(!v){ streak=0; break; }
      if(v==='F'){
        streak++;
        if(streak>=len){
          out.push({id:a.id, nome:a.nome, streak});
          break;
        }
      }else{
        break;
      }
    }
  });
  return out.sort((a,b)=>b.streak-a.streak || (a.nome||'').localeCompare(b.nome||''));
}

function renderFreqAlertsDashboard(){
  try{
    const bim = bimestreAtual;
    const today = __freqTodayStr();
    const turmasList = (turmas||[]).filter(t=>t && t!=='Todas');
    if(!turmasList.length) return '';

    if(filtroTurma && filtroTurma!=='Todas'){
      const turma = filtroTurma;
      const pend = __freqPendenciaHojeTurma(turma, bim);
      const last = __freqUltimoRegistroTurma(turma, bim);
      const diasSem = last ? __freqBusinessDaysBetween(last, today) : 0;
      const baixa = __freqAlunosBaixaFreq(turma, bim, 75);
      const streak = __freqAlunosStreakF(turma, bim, 3);

      const pendTxt = pend.skip ? 'Hoje é fim de semana' : (pend.missing ? 'Chamada pendente' : (pend.incomplete>0 ? `Incompleta (${pend.incomplete} sem marcação)` : 'OK'));
      const pendColor = pend.skip ? '#64748b' : (pend.missing || pend.incomplete>0 ? '#dc2626' : '#16a34a');

      return `
        <div class="dash-card wide" style="border:1px solid rgba(236,72,153,.18);">
          <h3 style="margin:0 0 8px;"><i class="fas fa-user-check"></i> Frequência — Alertas (${escHTML(turma)} • ${bim}ºB)</h3>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:10px;">
            <div style="padding:10px 12px; border:1px solid var(--border-color); border-radius:12px; background:rgba(236,72,153,.04);">
              <div style="font-size:.72rem; color:#64748b; text-transform:uppercase; letter-spacing:.3px;">Chamada de hoje</div>
              <div style="font-size:1rem; font-weight:800; color:${pendColor}; margin-top:6px;">${pendTxt}</div>
              ${(!pend.skip && !pend.missing) ? `<div style="font-size:.78rem; color:#94a3b8; margin-top:4px;">Marcados: ${pend.filled}/${pend.total}</div>` : ''}
            </div>
            <div style="padding:10px 12px; border:1px solid var(--border-color); border-radius:12px;">
              <div style="font-size:.72rem; color:#64748b; text-transform:uppercase; letter-spacing:.3px;">Baixa frequência (&lt;75%)</div>
              <div style="font-size:1.2rem; font-weight:900; margin-top:6px;">${baixa.length}</div>
              <div style="font-size:.78rem; color:#94a3b8; margin-top:4px;">com registros no bimestre</div>
            </div>
            <div style="padding:10px 12px; border:1px solid var(--border-color); border-radius:12px;">
              <div style="font-size:.72rem; color:#64748b; text-transform:uppercase; letter-spacing:.3px;">Faltas seguidas (≥3)</div>
              <div style="font-size:1.2rem; font-weight:900; margin-top:6px;">${streak.length}</div>
              <div style="font-size:.78rem; color:#94a3b8; margin-top:4px;">nos últimos registros</div>
            </div>
            <div style="padding:10px 12px; border:1px solid var(--border-color); border-radius:12px;">
              <div style="font-size:.72rem; color:#64748b; text-transform:uppercase; letter-spacing:.3px;">Último registro</div>
              <div style="font-size:1rem; font-weight:800; margin-top:6px;">${last?escHTML(last):'—'}</div>
              <div style="font-size:.78rem; color:#94a3b8; margin-top:4px;">${last ? `${diasSem} dia(s) útil(eis) sem registro` : 'Sem registros neste bimestre'}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px;">
            <button class="btn-primary" onclick="abrirFrequencia()"><i class="fas fa-clipboard-check"></i> Abrir chamada</button>
            <button class="btn-secondary" onclick="abrirFreqAlertasDetalhes(${__j(turma)}, ${bim})"><i class="fas fa-list"></i> Ver detalhes</button>
          </div>
        </div>`;
    }

    let rows='';
    turmasList.forEach(turma=>{
      const pend = __freqPendenciaHojeTurma(turma, bim);
      const last = __freqUltimoRegistroTurma(turma, bim);
      const diasSem = last ? __freqBusinessDaysBetween(last, today) : 0;
      const baixaCount = __freqAlunosBaixaFreq(turma, bim, 75).length;
      const streakCount = __freqAlunosStreakF(turma, bim, 3).length;

      const pendLbl = pend.skip ? '—' : (pend.missing ? 'Pendente' : (pend.incomplete>0 ? `Incompleta (${pend.incomplete})` : 'OK'));
      const pendClr = pend.skip ? '#64748b' : (pend.missing || pend.incomplete>0 ? '#dc2626' : '#16a34a');

      rows += `<tr>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:left;">${escHTML(turma)}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:center; color:${pendClr}; font-weight:800;">${pendLbl}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:center;">${baixaCount}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:center;">${streakCount}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:center;">${last?escHTML(last):'—'}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:center;">${last?diasSem:'—'}</td>
        <td style="padding:8px 10px; border-bottom:1px solid var(--border-color); text-align:right; white-space:nowrap;">
          <button class="btn-secondary" onclick="selTurma(${__j(turma)}); mudarVisao('dash'); setTimeout(()=>{ try{abrirFrequencia();}catch(_){} }, 50);" title="Abrir chamada"><i class="fas fa-clipboard-check"></i></button>
          <button class="btn-secondary" onclick="abrirFreqAlertasDetalhes(${__j(turma)}, ${bim})" title="Detalhes"><i class="fas fa-list"></i></button>
        </td>
      </tr>`;
    });

    return `
      <div class="dash-card wide" style="border:1px solid rgba(236,72,153,.18);">
        <h3 style="margin:0 0 10px;"><i class="fas fa-user-check"></i> Frequência — Comparar turmas (${bim}ºB)</h3>
        <div style="overflow:auto; border:1px solid var(--border-color); border-radius:12px;">
          <table style="width:100%; border-collapse:collapse; font-size:.85rem;">
            <thead>
              <tr style="background:rgba(236,72,153,.04);">
                <th style="padding:10px; text-align:left; border-bottom:1px solid var(--border-color);">Turma</th>
                <th style="padding:10px; text-align:center; border-bottom:1px solid var(--border-color);">Hoje</th>
                <th style="padding:10px; text-align:center; border-bottom:1px solid var(--border-color);">&lt;75%</th>
                <th style="padding:10px; text-align:center; border-bottom:1px solid var(--border-color);">≥3F seguidas</th>
                <th style="padding:10px; text-align:center; border-bottom:1px solid var(--border-color);">Último</th>
                <th style="padding:10px; text-align:center; border-bottom:1px solid var(--border-color);">Dias úteis</th>
                <th style="padding:10px; text-align:right; border-bottom:1px solid var(--border-color);">Ações</th>
              </tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="7" style="padding:12px; text-align:center; color:#64748b;">Sem turmas cadastradas.</td></tr>`}</tbody>
          </table>
        </div>
        <div style="font-size:.78rem; color:#94a3b8; margin-top:8px;">
          * “Hoje” considera pendente/incompleta apenas em dias úteis. “Dias úteis” conta desde o último registro até hoje.
        </div>
      </div>`;
  }catch(_){ return ''; }
}

function abrirFreqAlertasDetalhes(turma, bim){
  try{
    const today = __freqTodayStr();
    const pend = __freqPendenciaHojeTurma(turma, bim);
    const baixa = __freqAlunosBaixaFreq(turma, bim, 75);
    const streak = __freqAlunosStreakF(turma, bim, 3);

    let pendList = [];
    if(!pend.skip){
      const lista = alunos.filter(a=>a.turma===turma);
      if(pend.missing){
        pendList = lista.map(a=>({id:a.id, nome:a.nome}));
      }else{
        const reg = (window.__sgpFrequencia||{})[pend.key] || {};
        pendList = lista.filter(a=>!reg[a.id]).map(a=>({id:a.id, nome:a.nome}));
      }
    }

    let overlay = document.getElementById('freqAlertsOverlay');
    if(overlay) overlay.remove();

    overlay = document.createElement('div');
    overlay.id='freqAlertsOverlay';
    overlay.className='modal-overlay';
    overlay.style.display='flex';
    overlay.innerHTML = `
      <div class="modal-box" style="max-width:980px; max-height:88vh; overflow:auto;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <h2 style="margin:0;"><i class="fas fa-user-check"></i> Detalhes de Frequência — ${escHTML(turma)} (${bim}ºB)</h2>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn-secondary" onclick="__sgpRemoveEl('freqAlertsOverlay');"><i class="fas fa-xmark"></i> Fechar</button>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn-primary" onclick="selTurma(${__j(turma)}); __sgpRemoveEl('freqAlertsOverlay'); setTimeout(function(){ try{abrirFrequencia();}catch(_){} }, 50);">
            <i class="fas fa-clipboard-check"></i> Abrir chamada
          </button>
        </div>

        <div style="margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:12px;">
          <div style="border:1px solid var(--border-color); border-radius:12px; padding:12px;">
            <h3 style="margin:0 0 8px; font-size:.95rem;">Chamada de hoje (${escHTML(today)})</h3>
            <div style="font-size:.82rem; color:#64748b; margin-bottom:8px;">
              ${pend.skip ? 'Hoje é fim de semana — pendências não são contabilizadas.' : (pend.missing ? 'Registro ainda não criado.' : (pend.incomplete>0 ? `Faltam ${pend.incomplete} marcação(ões).` : 'Tudo lançado.'))}
            </div>
            <div style="max-height:240px; overflow:auto; border-top:1px dashed rgba(148,163,184,.35); padding-top:8px;">
              ${pend.skip ? '<div style="color:#94a3b8;">—</div>' : (pendList.length ? pendList.slice(0,50).map(x=>`<div style="padding:6px 0; border-bottom:1px solid rgba(0,0,0,.04);">${escHTML(x.nome)}</div>`).join('') : '<div style="color:#94a3b8;">Nenhuma pendência.</div>')}
            </div>
          </div>

          <div style="border:1px solid var(--border-color); border-radius:12px; padding:12px;">
            <h3 style="margin:0 0 8px; font-size:.95rem;">Baixa frequência (&lt;75%)</h3>
            <div style="font-size:.82rem; color:#64748b; margin-bottom:8px;">Total: <b>${baixa.length}</b></div>
            <div style="max-height:240px; overflow:auto; border-top:1px dashed rgba(148,163,184,.35); padding-top:8px;">
              ${baixa.length ? baixa.slice(0,60).map(x=>`<div style="display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,.04);"><span>${escHTML(x.nome)}</span><b style="color:#dc2626;">${x.pct.toFixed(0)}%</b></div>`).join('') : '<div style="color:#94a3b8;">Nenhum aluno abaixo do limite.</div>'}
            </div>
          </div>

          <div style="border:1px solid var(--border-color); border-radius:12px; padding:12px;">
            <h3 style="margin:0 0 8px; font-size:.95rem;">Faltas seguidas (≥3)</h3>
            <div style="font-size:.82rem; color:#64748b; margin-bottom:8px;">Total: <b>${streak.length}</b></div>
            <div style="max-height:240px; overflow:auto; border-top:1px dashed rgba(148,163,184,.35); padding-top:8px;">
              ${streak.length ? streak.slice(0,60).map(x=>`<div style="display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,.04);"><span>${escHTML(x.nome)}</span><b style="color:#b45309;">${x.streak}F</b></div>`).join('') : '<div style="color:#94a3b8;">Nenhuma sequência detectada.</div>'}
            </div>
          </div>
        </div>
        <div style="margin-top:10px; font-size:.78rem; color:#94a3b8;">
          Observação: “Faltas seguidas” considera apenas dias com registro e exige que o aluno esteja marcado nesses dias (evita supor falta quando não foi lançado).
        </div>
      </div>
    `;
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.remove(); });
    document.body.appendChild(overlay);
  }catch(_){ showToast("Não foi possível abrir os detalhes de frequência.", "error"); }
}

function __freqMaybeToastPendencia(){
  try{
    if(!filtroTurma || filtroTurma==='Todas') return;
    const bim = bimestreAtual;
    const today = __freqTodayStr();
    if(__freqIsWeekend(today)) return;
    const pend = __freqPendenciaHojeTurma(filtroTurma, bim);
    if(pend.skip) return;

    const key = `sgp_freq_toast_${filtroTurma}_${bim}_${today}`;
    try{ if(sessionStorage.getItem(key)==='1') return; }catch(_){}

    if(pend.missing){
      showToast(`Chamada de hoje (${today}) pendente — ${filtroTurma}.`, "warn");
      try{ sessionStorage.setItem(key,'1'); }catch(_){}
    }else if(pend.incomplete>0){
      showToast(`Chamada de hoje (${today}) incompleta — faltam ${pend.incomplete}.`, "warn");
      try{ sessionStorage.setItem(key,'1'); }catch(_){}
    }
  }catch(_){}
}

function abrirFrequencia(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma primeiro.", "error");
  let overlay = document.getElementById('modalFrequencia');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.id='modalFrequencia';
    overlay.className='modal-overlay';
    overlay.innerHTML=`<div class="modal-box" style="max-width:900px;max-height:85vh;overflow-y:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <h2 style="margin:0;"><i class="fas fa-clipboard-check"></i> Chamada / Frequência</h2>
        <button class="freq-fullscreen-btn" id="freqFullscreenBtn" onclick="freqToggleFullscreen()" title="Tela cheia"><i class="fas fa-expand"></i></button>
      </div>
      <div class="freq-header-row">
        <label>Data:
          <div class="freq-date-nav">
            <button onclick="freqNavDate(-1)" title="Dia útil anterior"><i class="fas fa-chevron-left"></i></button>
            <input type="date" id="freqDate" value="${__freqTodayStr()}">
            <button onclick="freqNavDate(1)" title="Próximo dia útil"><i class="fas fa-chevron-right"></i></button>
            <button onclick="document.getElementById('freqDate').value=__freqTodayStr();renderFrequencia();" title="Hoje" style="font-size:.68rem;width:auto;padding:0 8px;">Hoje</button>
          </div>
        </label>
        <label>Disciplina:
          <select id="freqDisciplina" onchange="freqSaveMeta()">
            <option value="">— Selecione —</option>
          </select>
        </label>
        <label>Aulas:
          <select id="freqQtdAulas" onchange="freqSaveMeta()">
            <option value="1">1 aula</option>
            <option value="2">2 aulas</option>
            <option value="3">3 aulas</option>
            <option value="4">4 aulas</option>
          </select>
        </label>
        <button class="btn-primary" data-onclick="freqMarcarTodosP()"><i class="fas fa-check-double"></i> Todos presentes</button>
        <button class="btn-tool" data-onclick="freqMarcarTodosF()" style="color:#dc2626;"><i class="fas fa-times"></i> Todos ausentes</button>
      </div>
      <div class="freq-meta-row">
        <label style="flex:1;min-width:200px;">
          <span><i class="fas fa-book"></i> Registro de Aula</span>
          <textarea id="freqRegistroAula" class="freq-registro-aula" rows="2" placeholder="Descreva o que foi trabalhado nesta aula..." onblur="freqSaveMeta()"></textarea>
        </label>
      </div>
      <div id="freqTableContainer"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap;gap:8px;">
        <button data-onclick="abrirHistoricoChamadas()" style="padding:8px 15px;border:1px solid var(--primary);background:transparent;color:var(--primary);border-radius:8px;cursor:pointer;font-size:.82rem;"><i class="fas fa-history"></i> Histórico de Chamadas</button>
        <button data-onclick="fecharModais()" style="padding:8px 15px;border:none;background:transparent;cursor:pointer;">Fechar</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
  if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
    document.getElementById('freqDate').addEventListener('change', renderFrequencia);
  }
  overlay.style.display='flex';
  // Bug fix: always reset date to today when reopening
  const freqDateInput = document.getElementById('freqDate');
  if(freqDateInput) freqDateInput.value = __freqTodayStr();
  // Clear search filter on open
  window.__freqSearchFilter = '';
  renderFrequencia();
}

function renderFrequencia(){
  const date = document.getElementById('freqDate')?.value || __freqTodayStr();
  const key = `${filtroTurma}|${bimestreAtual}|${date}`;
  const registro = window.__sgpFrequencia[key] || {};
  const meta = registro._meta || {};
  const lista = alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  
  // Populate discipline dropdown
  const selDisc = document.getElementById('freqDisciplina');
  if(selDisc){
    const prevVal = selDisc.value;
    const savedDisc = meta.disciplina || '';
    selDisc.innerHTML = '<option value="">— Selecione —</option>';
    try{
      ensureConfigSchema();
      (config.disciplinas||[]).forEach(d=>{
        const o = document.createElement('option');
        o.value = d.nome || d.id;
        o.textContent = d.nome || d.id;
        selDisc.appendChild(o);
      });
    }catch(_){}
    // Restore saved value
    if(savedDisc){
      let found = false;
      for(let i=0;i<selDisc.options.length;i++){
        if(selDisc.options[i].value === savedDisc){ found=true; break; }
      }
      if(!found && savedDisc){
        const o = document.createElement('option');
        o.value = savedDisc;
        o.textContent = savedDisc;
        selDisc.appendChild(o);
      }
      selDisc.value = savedDisc;
    }
  }

  // Restore meta fields
  const selAulas = document.getElementById('freqQtdAulas');
  if(selAulas) selAulas.value = meta.qtdAulas || '1';
  const txtRegistro = document.getElementById('freqRegistroAula');
  if(txtRegistro) txtRegistro.value = meta.registroAula || '';
  
  // Search filter
  const searchVal = (window.__freqSearchFilter||'').toLowerCase();
  const listaFiltrada = searchVal ? lista.filter(a=>(a.nome||'').toLowerCase().includes(searchVal)) : lista;
  
  // Count unmarked
  const totalAlunos = lista.length;
  const marcados = lista.filter(a=>registro[a.id]).length;
  const semMarcacao = totalAlunos - marcados;
  
  let html = `<div class="freq-search-wrap"><i class="fas fa-search"></i><input type="text" id="freqSearchInput" placeholder="Buscar aluno... (${semMarcacao>0?semMarcacao+' sem marcação':'todos marcados'})" value="${escHTML(searchVal)}" oninput="window.__freqSearchFilter=this.value;renderFrequencia();"></div>`;
  html += `<table class="freq-table"><thead><tr><th>#</th><th style="text-align:left;">Nome</th><th>Status</th><th>Freq. Bim.</th></tr></thead><tbody>`;
  listaFiltrada.forEach((a,i)=>{
    const status = registro[a.id] || '';
    const freq = calcFreqAluno(a.id, bimestreAtual);
    const globalIdx = lista.indexOf(a);
    const unmarkedClass = status ? '' : ' freq-unmarked';
    const pctClass = freq.pct>=75?'good':(freq.pct>=50?'warn':'danger');
    html+=`<tr class="${unmarkedClass}">
      <td>${globalIdx+1}</td>
      <td style="text-align:left;">${escHTML(a.nome)}</td>
      <td>
        <button class="freq-btn ${status==='P'?'P':'none'}" onclick="setFreq('${a.id}','P')" title="Presente">P</button>
        <button class="freq-btn ${status==='F'?'F':'none'}" onclick="setFreq('${a.id}','F')" title="Falta">F</button>
        <button class="freq-btn ${status==='J'?'J':'none'}" onclick="setFreq('${a.id}','J')" title="Justificada">J</button>
      </td>
      <td><span class="freq-pct ${pctClass}">${freq.pct.toFixed(0)}%</span> <small>(${freq.faltas}F)</small></td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById('freqTableContainer').innerHTML=html;
  // Preserve search input focus
  try{
    const si=document.getElementById('freqSearchInput');
    if(si && searchVal){ si.focus(); si.setSelectionRange(si.value.length, si.value.length); }
  }catch(_){}
}

function freqSaveMeta(){
  const date = document.getElementById('freqDate')?.value || __freqTodayStr();
  const key = `${filtroTurma}|${bimestreAtual}|${date}`;
  if(!window.__sgpFrequencia[key]) window.__sgpFrequencia[key]={};
  const selAulas = document.getElementById('freqQtdAulas');
  const txtRegistro = document.getElementById('freqRegistroAula');
  const selDisc = document.getElementById('freqDisciplina');
  window.__sgpFrequencia[key]._meta = {
    qtdAulas: selAulas ? selAulas.value : '1',
    registroAula: txtRegistro ? txtRegistro.value : '',
    disciplina: selDisc ? selDisc.value : ''
  };
  __saveFrequencia();
  try{ if(visaoAtual==='dash'){ renderizarDashboard(); } }catch(_){}
}

function freqToggleFullscreen(){
  const overlay = document.getElementById('modalFrequencia');
  if(!overlay) return;
  overlay.classList.toggle('freq-fullscreen');
  const isFS = overlay.classList.contains('freq-fullscreen');
  const box = overlay.querySelector('.modal-box');
  if(box){
    if(isFS){
      box.dataset.origStyle = box.getAttribute('style') || '';
      box.style.cssText = 'max-width:100%!important;width:100%!important;max-height:100vh!important;height:100vh!important;border-radius:0!important;margin:0!important;padding:16px 24px!important;overflow-y:auto!important;box-shadow:none!important;position:fixed!important;inset:0!important;z-index:10000!important;background:var(--card-bg,#fff)!important;';
    } else {
      box.style.cssText = box.dataset.origStyle || 'max-width:900px;max-height:85vh;overflow-y:auto;';
    }
  }
  const btn = document.getElementById('freqFullscreenBtn');
  if(btn){
    btn.innerHTML = isFS ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
    btn.title = isFS ? 'Sair da tela cheia' : 'Tela cheia';
  }
}

function freqNavDate(dir){
  const inp=document.getElementById('freqDate');
  if(!inp) return;
  let d=new Date((inp.value||__freqTodayStr())+'T12:00:00');
  let tries=0;
  do{ d.setDate(d.getDate()+dir); tries++; }while((d.getDay()===0||d.getDay()===6)&&tries<10);
  inp.value=__localISODate(d);
  renderFrequencia();
}

function setFreq(alunoId, value){
  // UX: haptic feedback on mobile
  try{ if(navigator.vibrate) navigator.vibrate(50); }catch(_){}
  const date = document.getElementById('freqDate')?.value || __freqTodayStr();
  const key = `${filtroTurma}|${bimestreAtual}|${date}`;
  if(!window.__sgpFrequencia[key]) window.__sgpFrequencia[key]={};
  const current = window.__sgpFrequencia[key][alunoId];
  if(current===value){
    delete window.__sgpFrequencia[key][alunoId]; // toggle off
  } else {
    window.__sgpFrequencia[key][alunoId] = value;
  }
  try{ __freqLogEvent({type:'set', turma:filtroTurma, bim:bimestreAtual, date:date, alunoId:alunoId, value:(window.__sgpFrequencia[key]||{})[alunoId]||''}); }catch(_){ }
__saveFrequencia();
  renderFrequencia();
  try{ if(visaoAtual==='dash'){ renderizarDashboard(); } }catch(_){}
}

function freqMarcarTodosP(){
  const date = document.getElementById('freqDate')?.value || __freqTodayStr();
  const key = `${filtroTurma}|${bimestreAtual}|${date}`;
  if(!window.__sgpFrequencia[key]) window.__sgpFrequencia[key]={};
  alunos.filter(a=>a.turma===filtroTurma).forEach(a=>{ window.__sgpFrequencia[key][a.id]='P'; });
    try{ __freqLogEvent({type:'bulk', turma:filtroTurma, bim:bimestreAtual, date:date, value:'P', count:(alunos.filter(a=>a.turma===filtroTurma).length||0)}); }catch(_){}
  __saveFrequencia(); renderFrequencia();
  try{ if(visaoAtual==='dash'){ renderizarDashboard(); } }catch(_){}
}
function freqMarcarTodosF(){
  const total = alunos.filter(a=>a.turma===filtroTurma).length;
  if(!confirm(`Marcar todos os ${total} alunos como AUSENTES?\n\nEssa ação pode ser desfeita individualmente.`)) return;
  const date = document.getElementById('freqDate')?.value || __freqTodayStr();
  const key = `${filtroTurma}|${bimestreAtual}|${date}`;
  if(!window.__sgpFrequencia[key]) window.__sgpFrequencia[key]={};
  alunos.filter(a=>a.turma===filtroTurma).forEach(a=>{ window.__sgpFrequencia[key][a.id]='F'; });
    try{ __freqLogEvent({type:'bulk', turma:filtroTurma, bim:bimestreAtual, date:date, value:'F', count:(alunos.filter(a=>a.turma===filtroTurma).length||0)}); }catch(_){}
  __saveFrequencia(); renderFrequencia();
  try{ if(visaoAtual==='dash'){ renderizarDashboard(); } }catch(_){}
}

// ================================================================
// HISTÓRICO DE CHAMADAS / FREQUÊNCIA
// ================================================================
function abrirHistoricoChamadas(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma primeiro.", "error");
  
  const freq = window.__sgpFrequencia || {};
  const lista = alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  
  // Collect all records for this turma across all bimestres
  const records = [];
  Object.keys(freq).forEach(key => {
    const parts = key.split('|');
    if(parts[0] !== filtroTurma) return;
    const bim = parseInt(parts[1]) || 0;
    const date = parts[2];
    const reg = freq[key] || {};
    const meta = reg._meta || {};
    
    // Count P/F/J
    let countP=0, countF=0, countJ=0, total=0;
    lista.forEach(a => {
      const s = reg[a.id];
      if(s === 'P'){ countP++; total++; }
      else if(s === 'F'){ countF++; total++; }
      else if(s === 'J'){ countJ++; total++; }
    });
    
    if(total > 0){
      records.push({
        key, date, bim,
        disciplina: meta.disciplina || '',
        qtdAulas: meta.qtdAulas || '1',
        registroAula: meta.registroAula || '',
        countP, countF, countJ, total
      });
    }
  });
  
  // Sort by date descending
  records.sort((a,b) => b.date.localeCompare(a.date));
  
  // Filter by selected bimestre or show all
  let filterBim = bimestreAtual;
  
  let old = document.getElementById('modalHistChamadas');
  if(old) old.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'modalHistChamadas';
  overlay.className = 'modal-overlay';
  overlay.style.display = 'flex';
  overlay.onclick = function(e){ if(e.target===this) this.remove(); };
  
  window.__histStatusFilter = 'all';
  window.__histBimFilter = bimestreAtual;
  window.__histExpandedKeys = new Set();
  window.__histViewMode = window.__histViewMode || 'dia';
  window.__histDiscFilter = window.__histDiscFilter || 'all';
  window.__histWeekStart = window.__histWeekStart || __freqWeekStartISO(__freqTodayStr());

  function buildContent(filterBimVal, statusFilter){
    statusFilter = statusFilter || 'all';
    const viewMode = window.__histViewMode || 'dia';
    const discFilter = window.__histDiscFilter || 'all';
    let filtered = filterBimVal === 0 ? records : records.filter(r => r.bim === filterBimVal);
    const freq = window.__sgpFrequencia || {};

    // Lista de disciplinas (config + registros)
    let hasNoneDisc = false;
    const discSet = new Set();
    try{ ensureConfigSchema(); (config.disciplinas||[]).forEach(d=>{ const v = (d&& (d.nome||d.id)) ? String(d.nome||d.id) : ''; if(v) discSet.add(v); }); }catch(_){ }
    try{ records.forEach(r=>{ if(r && r.disciplina) discSet.add(String(r.disciplina)); else hasNoneDisc = true; }); }catch(_){ }
    const discList = Array.from(discSet).filter(Boolean).sort((a,b)=>a.localeCompare(b,'pt-BR'));

    // Aplica filtro de disciplina aos registros
    if(discFilter==='__none__') filtered = filtered.filter(r => !r.disciplina);
    else if(discFilter!=='all') filtered = filtered.filter(r => String(r.disciplina||'') === String(discFilter));

    // -- status filter button style helper --
    function sfBtn(val, label, icon, bgOn, colorOn){
      const isOn = statusFilter === val;
      const bg = isOn ? bgOn : 'transparent';
      const color = isOn ? colorOn : 'var(--text-muted)';
      const border = isOn ? bgOn : '#cbd5e1';
      const fw = isOn ? '700' : '500';
      return `<button onclick="window.__histSetStatus('${val}')" style="display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;border:2px solid ${border};background:${bg};color:${color};font-weight:${fw};font-size:.78rem;cursor:pointer;transition:all .2s;"><i class="fas ${icon}"></i> ${label}</button>`;
    }
    
    let html = `<div class="modal-box" style="max-width:950px;max-height:88vh;overflow-y:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <h2 style="margin:0;"><i class="fas fa-history" style="color:var(--primary);"></i> Histórico de Chamadas — ${escHTML(filtroTurma)}</h2>
        <button onclick="document.getElementById('modalHistChamadas').remove();" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">&times;</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
        <span style="font-size:.82rem;font-weight:600;color:var(--text-muted);">Bimestre:</span>
        <button class="freq-btn ${filterBimVal===0?'P':'none'}" onclick="window.__histChamadasRebuild(0)" style="width:auto;padding:4px 10px;">Todos</button>`;
    for(let i=1;i<=4;i++){
      html += `<button class="freq-btn ${filterBimVal===i?'P':'none'}" onclick="window.__histChamadasRebuild(${i})" style="width:auto;padding:4px 10px;">${i}ºB</button>`;
    }
    html += `</div>`;

    // Status filter bar
// Visualização + disciplina
const __viewBtn = (mode, label, icon)=>`<button class="freq-btn ${viewMode===mode?'P':'none'}" onclick="window.__histSetView('${mode}')" style="width:auto;padding:4px 10px;"><i class="fas ${icon}"></i> ${label}</button>`;
let discOptions = `<option value="all"${discFilter==='all'?' selected':''}>Todas</option>`;
if(hasNoneDisc) discOptions += `<option value="__none__"${discFilter==='__none__'?' selected':''}>Sem disciplina</option>`;
discList.forEach(d=>{ discOptions += `<option value="${escHTML(d)}"${discFilter===d?' selected':''}>${escHTML(d)}</option>`; });

html += `<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
  <span style="font-size:.82rem;font-weight:600;color:var(--text-muted);">Visualização:</span>
  ${__viewBtn('dia','Por dia','fa-calendar-day')}
  ${__viewBtn('semana','Por semana','fa-calendar-week')}
  <span style="font-size:.82rem;font-weight:600;color:var(--text-muted);margin-left:4px;">Disciplina:</span>
  <select onchange="window.__histSetDisc(this.value)" style="padding:6px 10px;border-radius:10px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);font-size:.82rem;">
    ${discOptions}
  </select>
</div>`;

// Se estiver em modo semanal, renderiza relatório semanal e encerra
if(viewMode==='semana'){
  const weekMap = {};
  filtered.forEach(r=>{
    const ws = __freqWeekStartISO(r.date);
    (weekMap[ws]||(weekMap[ws]=[])).push(r);
  });
  const weeks = Object.keys(weekMap).sort().reverse();
  let selected = window.__histWeekStart || __freqWeekStartISO(__freqTodayStr());
  if(!weekMap[selected]){
    const cur = __freqWeekStartISO(__freqTodayStr());
    selected = weekMap[cur] ? cur : (weeks[0] || cur);
    window.__histWeekStart = selected;
  }

  let weekRecs = weekMap[selected] || [];

  // Monta métricas por aluno
  const rows = lista.map(a=>{
    let total=0, faltas=0, marcadosDias=0, pendentesDias=0;
    weekRecs.forEach(r=>{
      const reg = freq[r.key] || {};
      const meta = (reg && reg._meta) ? reg._meta : {};
      const qtd = Math.max(1, parseInt(meta.qtdAulas || r.qtdAulas || 1, 10) || 1);
      const s = reg[a.id];
      if(s==='P' || s==='F' || s==='J'){
        marcadosDias++;
        total += qtd;
        if(s==='F') faltas += qtd;
      }else{
        pendentesDias++;
      }
    });
    const pctAus = total>0 ? (faltas/total*100) : 0;
    return {id:a.id, nome:a.nome||'Sem nome', total, faltas, pctAus, marcadosDias, pendentesDias};
  }).sort((x,y)=> (y.faltas-x.faltas) || (x.nome||'').localeCompare(y.nome||'', 'pt-BR'));

  const totalFaltas = rows.reduce((s,r)=>s+(r.faltas||0),0);
  const totalAulasMarcadas = rows.reduce((s,r)=>s+(r.total||0),0);
  const pctTurma = totalAulasMarcadas>0 ? Math.round((totalFaltas/totalAulasMarcadas)*100) : 0;
  const alunosPend = rows.filter(r=>r.pendentesDias>0).length;

  // Resumo por dia (na semana)
  const dayRows = weekRecs.slice().sort((a,b)=>a.date.localeCompare(b.date)).map(r=>{
    const reg = freq[r.key] || {};
    const meta = reg._meta || {};
    const qtd = Math.max(1, parseInt(meta.qtdAulas || r.qtdAulas || 1, 10) || 1);
    let cF=0, cM=0;
    lista.forEach(a=>{ const s=reg[a.id]; if(s==='F') cF++; if(s==='P'||s==='F'||s==='J') cM++; });
    const dObj = new Date(r.date+'T12:00:00');
    const dFmt = dObj.toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit', month:'2-digit'});
    const discLbl = (r.disciplina||'').trim() ? escHTML(r.disciplina) : 'Sem disciplina';
    return `<div style="display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid rgba(0,0,0,.06);">
      <div style="min-width:180px;"><b>${dFmt}</b> <span style="color:var(--text-muted);font-size:.75rem;">(${qtd} aula(s))</span> <span style="background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700;margin-left:6px;"><i class="fas fa-book"></i> ${discLbl}</span></div>
      <div style="white-space:nowrap;"><span style="color:#991b1b;font-weight:700;">${cF}</span> F &nbsp; <span style="color:var(--text-muted);font-size:.78rem;">(${cM}/${lista.length} marcados)</span></div>
    </div>`;
  }).join('') || `<div style="color:var(--text-muted);padding:6px 0;">Nenhum registro na semana.</div>`;

  html += `<div style="border:1px solid var(--border-color);border-radius:12px;padding:12px;margin-bottom:12px;background:rgba(14,165,233,.04);">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-weight:700;"><i class="fas fa-calendar-week"></i> Semana</span>
        <select onchange="window.__histSetWeek(this.value)" style="padding:6px 10px;border-radius:10px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color);font-size:.82rem;">
          ${weeks.map(ws=>`<option value="${ws}" ${ws===selected?'selected':''}>${ws} (${__freqWeekLabel(ws)})</option>`).join('')}
        </select>
      </div>
      <div style="font-size:.82rem;color:var(--text-muted);">
        Índice de ausências (turma): <b style="color:#991b1b;">${pctTurma}%</b> &nbsp;|&nbsp; Alunos com pendências: <b>${alunosPend}</b>
      </div>
    </div>
  </div>`;

  html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:12px;">
    <div style="border:1px solid var(--border-color);border-radius:12px;padding:12px;">
      <div style="font-weight:700;margin-bottom:6px;"><i class="fas fa-user-xmark" style="color:#991b1b;"></i> Ausências por aluno (semana)</div>
      <div style="max-height:340px;overflow:auto;">
        <table class="freq-table" style="margin-top:6px;">
          <thead><tr><th>#</th><th style="text-align:left;">Aluno</th><th>Faltas</th><th>% Aus.</th><th>Marc.</th></tr></thead>
          <tbody>
            ${rows.map((r,i)=>{
              const pct = (r.total>0) ? Math.round(r.pctAus) : 0;
              const pctColor = pct>=30 ? '#dc2626' : (pct>=15 ? '#f59e0b' : '#16a34a');
              return `<tr>
                <td>${i+1}</td>
                <td style="text-align:left;">${escHTML(r.nome)}</td>
                <td style="font-weight:700;color:#991b1b;">${r.faltas}</td>
                <td style="font-weight:700;color:${pctColor};">${pct}%</td>
                <td style="font-size:.78rem;color:var(--text-muted);">${r.marcadosDias}/${weekRecs.length}${r.pendentesDias?` <span title="Dias sem marcação" style="color:#b45309;font-weight:700;">(+${r.pendentesDias} pend.)</span>`:''}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
      <div style="margin-top:8px;font-size:.76rem;color:var(--text-muted);">
        Observação: o cálculo usa apenas dias em que o aluno foi marcado (P/F/J). Dias sem marcação aparecem como “pend.”.
      </div>
    </div>

    <div style="border:1px solid var(--border-color);border-radius:12px;padding:12px;">
      <div style="font-weight:700;margin-bottom:6px;"><i class="fas fa-list" style="color:var(--primary);"></i> Registros na semana</div>
      <div style="max-height:340px;overflow:auto;border-top:1px dashed rgba(148,163,184,.35);padding-top:6px;">
        ${dayRows}
      </div>
      <div style="margin-top:8px;font-size:.76rem;color:var(--text-muted);">
        Dica: para ver os <b>nomes</b> das faltas em um dia, troque para “Por dia”, clique na data e use o filtro “Faltas”.
      </div>
    </div>
  </div>`;

  html += `<div style="text-align:center;margin-top:14px;">
    <button onclick="document.getElementById('modalHistChamadas').remove();" style="padding:8px 20px;border:none;background:#475569;color:#fff;border-radius:8px;cursor:pointer;">Fechar</button>
  </div></div>`;

  return html;
}


    // Status filter bar
    html += `<div style="display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
      <span style="font-size:.82rem;font-weight:600;color:var(--text-muted);"><i class="fas fa-filter"></i> Filtro rápido:</span>
      ${sfBtn('all','Todos','fa-users','#e0f2fe','#0369a1')}
      ${sfBtn('F','Faltas','fa-times-circle','#fee2e2','#991b1b')}
      ${sfBtn('P','Presenças','fa-check-circle','#dcfce7','#166534')}
      ${sfBtn('J','Justificadas','fa-exclamation-circle','#fef9c3','#854d0e')}
    </div>`;
    
    if(filtered.length === 0){
      html += `<div style="text-align:center;padding:40px;color:var(--text-muted);"><i class="fas fa-inbox" style="font-size:2rem;opacity:.4;display:block;margin-bottom:10px;"></i>Nenhum registro de chamada encontrado.</div>`;
    } else {
      // Summary stats
      const totalDias = filtered.length;
      const totalP = filtered.reduce((s,r)=>s+r.countP, 0);
      const totalF = filtered.reduce((s,r)=>s+r.countF, 0);
      const totalJ = filtered.reduce((s,r)=>s+r.countJ, 0);
      const totalAulas = filtered.reduce((s,r)=>s+parseInt(r.qtdAulas||1), 0);
      
      html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
        <div style="background:rgba(14,165,233,.08);padding:8px 14px;border-radius:8px;font-size:.82rem;">
          <i class="fas fa-calendar-days"></i> <b>${totalDias}</b> dia(s) registrado(s)
        </div>
        <div style="background:rgba(14,165,233,.08);padding:8px 14px;border-radius:8px;font-size:.82rem;">
          <i class="fas fa-book"></i> <b>${totalAulas}</b> aula(s)
        </div>
        <div style="background:#dcfce7;padding:8px 14px;border-radius:8px;font-size:.82rem;color:#166534;">
          <b>${totalP}</b> presenças
        </div>
        <div style="background:#fee2e2;padding:8px 14px;border-radius:8px;font-size:.82rem;color:#991b1b;">
          <b>${totalF}</b> faltas
        </div>
        <div style="background:#fef9c3;padding:8px 14px;border-radius:8px;font-size:.82rem;color:#854d0e;">
          <b>${totalJ}</b> justificadas
        </div>
      </div>`;
      
      
// Resumo rápido: faltas por disciplina (no filtro atual)
try{
  const aggDisc = {};
  filtered.forEach(r=>{
    const d = (r.disciplina||'').trim() ? r.disciplina : 'Sem disciplina';
    const qtd = Math.max(1, parseInt(r.qtdAulas||1,10)||1);
    aggDisc[d] = (aggDisc[d]||0) + ((r.countF||0) * qtd);
  });
  const items = Object.keys(aggDisc).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR')).map(k=>{
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.02);font-size:.78rem;">
      <span style="font-weight:700;color:#991b1b;">${aggDisc[k]}</span>
      <span style="color:var(--text-muted);">F</span>
      <span style="font-weight:700;">${escHTML(k)}</span>
    </span>`;
  }).join('');
  if(items){
    html += `<div style="margin:-6px 0 14px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
      <span style="font-size:.82rem;font-weight:600;color:var(--text-muted);"><i class="fas fa-book"></i> Faltas por disciplina:</span>
      ${items}
    </div>`;
  }
}catch(_){}


      html += `<div style="display:flex;flex-direction:column;gap:8px;">`;
      filtered.forEach((r, rIdx) => {
        const dObj = new Date(r.date + 'T12:00:00');
        const dataFmt = dObj.toLocaleDateString('pt-BR', {weekday:'short', day:'2-digit', month:'short', year:'numeric'});
        const pctPresenca = r.total > 0 ? Math.round(((r.countP + r.countJ) / r.total) * 100) : 0;
        const pctColor = pctPresenca >= 75 ? '#16a34a' : (pctPresenca >= 50 ? '#f59e0b' : '#dc2626');

        const isExpanded = window.__histExpandedKeys.has(r.key);
        const chevron = isExpanded ? 'fa-chevron-up' : 'fa-chevron-down';
        
        html += `<div style="border:1px solid var(--border-color);border-radius:10px;overflow:hidden;">
          <div onclick="window.__histToggleCard('${r.key.replace(/'/g,"\\'")}')" style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(14,165,233,.04);flex-wrap:wrap;gap:6px;cursor:pointer;user-select:none;transition:background .15s;" onmouseover="this.style.background='rgba(14,165,233,.10)'" onmouseout="this.style.background='rgba(14,165,233,.04)'">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <i class="fas ${chevron}" style="font-size:.7rem;color:var(--text-muted);width:14px;text-align:center;transition:transform .2s;"></i>
              <span style="font-weight:700;font-size:.88rem;">${dataFmt}</span>
              <span style="font-size:.72rem;color:var(--text-muted);">${r.bim}ºB</span>
              ${r.disciplina ? `<span style="background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:6px;font-size:.72rem;font-weight:700;"><i class="fas fa-book"></i> ${escHTML(r.disciplina)}</span>` : ''}
              <span style="font-size:.72rem;color:var(--text-muted);">${r.qtdAulas} aula(s)</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <span style="font-size:.75rem;color:#166534;font-weight:600;">${r.countP}P</span>
              <span style="font-size:.75rem;color:#991b1b;font-weight:600;">${r.countF}F</span>
              <span style="font-size:.75rem;color:#854d0e;font-weight:600;">${r.countJ}J</span>
              <span style="font-size:.75rem;color:${pctColor};font-weight:700;">${pctPresenca}%</span>
            </div>
          </div>`;
        
        if(r.registroAula){
          html += `<div style="padding:8px 14px;font-size:.82rem;color:var(--text-main);border-top:1px solid var(--border-color);background:var(--card-bg);">
            <span style="font-weight:600;color:var(--text-muted);font-size:.72rem;text-transform:uppercase;"><i class="fas fa-pen"></i> Registro:</span>
            <span style="margin-left:6px;">${escHTML(r.registroAula)}</span>
          </div>`;
        }

        // Expandable student list
        if(isExpanded){
          const reg = freq[r.key] || {};
          const statusMap = {
            'P': {label:'Presente', icon:'fa-check-circle', bg:'#dcfce7', color:'#166534', border:'#bbf7d0'},
            'F': {label:'Falta',    icon:'fa-times-circle', bg:'#fee2e2', color:'#991b1b', border:'#fecaca'},
            'J': {label:'Justificada', icon:'fa-exclamation-circle', bg:'#fef9c3', color:'#854d0e', border:'#fde68a'}
          };

          let studentItems = [];
          lista.forEach(a => {
            const s = reg[a.id];
            if(!s || !statusMap[s]) return;
            if(statusFilter !== 'all' && s !== statusFilter) return;
            studentItems.push({nome: a.nome || 'Sem nome', status: s});
          });

          html += `<div style="border-top:1px solid var(--border-color);padding:10px 14px;background:var(--card-bg);">`;

          if(studentItems.length === 0){
            html += `<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:.82rem;"><i class="fas fa-filter"></i> Nenhum aluno com esse status nesta chamada.</div>`;
          } else {
            html += `<div style="display:flex;flex-wrap:wrap;gap:6px;">`;
            studentItems.forEach(item => {
              const sm = statusMap[item.status];
              html += `<div style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:8px;background:${sm.bg};border:1px solid ${sm.border};font-size:.78rem;color:${sm.color};font-weight:600;transition:transform .15s,box-shadow .15s;cursor:default;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,.1)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                <i class="fas ${sm.icon}" style="font-size:.72rem;"></i> ${escHTML(item.nome)}
              </div>`;
            });
            html += `</div>`;
          }
          html += `</div>`;
        }
        
        html += `</div>`;
      });
      html += `</div>`;
    }
    
    html += `<div style="text-align:center;margin-top:14px;">
      <button onclick="document.getElementById('modalHistChamadas').remove();" style="padding:8px 20px;border:none;background:#475569;color:#fff;border-radius:8px;cursor:pointer;">Fechar</button>
    </div></div>`;
    
    return html;
  }

  function __histRebuildCurrent(){
    const ov = document.getElementById('modalHistChamadas');
    if(!ov) return;
    ov.innerHTML = buildContent(window.__histBimFilter, window.__histStatusFilter);
    try{
      const sel = ov.querySelector('select[onchange*="__histSetDisc"]');
      if(sel) sel.value = (window.__histDiscFilter||'all');
    }catch(_){}
    if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
  }

  window.__histToggleCard = function(key){
    if(window.__histExpandedKeys.has(key)) window.__histExpandedKeys.delete(key);
    else window.__histExpandedKeys.add(key);
    __histRebuildCurrent();
  };

  window.__histSetStatus = function(val){
    window.__histStatusFilter = val;
    __histRebuildCurrent();
  };

window.__histSetView = function(mode){
  window.__histViewMode = mode || 'dia';
  __histRebuildCurrent();
};
window.__histSetDisc = function(val){
  window.__histDiscFilter = (typeof val==='string') ? val : 'all';
  __histRebuildCurrent();
};
window.__histSetWeek = function(weekStart){
  window.__histWeekStart = weekStart || __freqWeekStartISO(__freqTodayStr());
  __histRebuildCurrent();
};

  
  window.__histChamadasRebuild = function(bimVal){
    window.__histBimFilter = bimVal;
    const ov = document.getElementById('modalHistChamadas');
    if(!ov) return;
    ov.innerHTML = buildContent(bimVal, window.__histStatusFilter);
    try{
      const sel = ov.querySelector('select[onchange*="__histSetDisc"]');
      if(sel) sel.value = (window.__histDiscFilter||'all');
    }catch(_){}
    if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
  };
  
  overlay.innerHTML = buildContent(filterBim, 'all');
  document.body.appendChild(overlay);
  try{
    const sel = overlay.querySelector('select[onchange*="__histSetDisc"]');
    if(sel) sel.value = (window.__histDiscFilter||'all');
  }catch(_){ }
  if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
}
try{
  const __origSelTurmaFreq = selTurma;
  if(typeof __origSelTurmaFreq==='function'){
    selTurma = function(n){
      __origSelTurmaFreq(n);
      try{ __freqMaybeToastPendencia(); }catch(_){}
    };
  }
}catch(_){}

// ================================================================
// V17: ENHANCED FREQUENCY — 8 NEW FEATURES
// ================================================================

// === F1: COPIAR AUSENTES PARA WHATSAPP ===
function freqCopiarAusentesWA(){
  try{
    const date=document.getElementById('freqDate')?.value||__freqTodayStr();
    const key=`${filtroTurma}|${bimestreAtual}|${date}`;
    const reg=window.__sgpFrequencia[key]||{};
    const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
    const ausentes=lista.filter(a=>reg[a.id]==='F').map(a=>a.nome||'Sem nome');
    const justificados=lista.filter(a=>reg[a.id]==='J').map(a=>a.nome||'Sem nome');
    const dObj=new Date(date+'T12:00:00');
    const dataFmt=dObj.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});

    let txt=`📋 *Chamada — ${filtroTurma}*\n📅 ${dataFmt}\n\n`;
    if(ausentes.length){
      txt+=`❌ *Faltas (${ausentes.length}):*\n`;
      ausentes.forEach((n,i)=>{txt+=`  ${i+1}. ${n}\n`;});
    } else { txt+=`✅ *Nenhuma falta registrada!*\n`; }
    if(justificados.length){
      txt+=`\n⚠️ *Justificadas (${justificados.length}):*\n`;
      justificados.forEach((n,i)=>{txt+=`  ${i+1}. ${n}\n`;});
    }
    const total=lista.length;
    const presentes=lista.filter(a=>reg[a.id]==='P').length;
    txt+=`\n📊 *Resumo:* ${presentes}/${total} presentes (${total>0?Math.round(presentes/total*100):0}%)`;

    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(()=>showToast('Lista copiada para a área de transferência!','success'));
    }else{
      const ta=document.createElement('textarea');
      ta.value=txt;ta.style.cssText='position:fixed;opacity:0;';
      document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
      showToast('Lista copiada!','success');
    }
  }catch(e){showToast('Erro ao copiar: '+e.message,'error');}
}

// === F2: RELATÓRIO MENSAL EXPORTÁVEL (PDF/IMPRESSÃO) ===
function freqAbrirRelatorioMensal(){
  if(filtroTurma==='Todas') return showToast('Selecione uma turma.','error');
  const bim=bimestreAtual;
  const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  if(!lista.length) return showToast('Nenhum aluno na turma.','error');

  // Get all dates for this turma/bim
  const dates=__freqGetDatesTurmaBim(filtroTurma,bim).sort();
  if(!dates.length) return showToast('Nenhum registro de chamada neste bimestre.','error');
  const freq=window.__sgpFrequencia||{};

  // Group by month
  const months={};
  dates.forEach(d=>{
    const m=d.substring(0,7); // YYYY-MM
    if(!months[m]) months[m]=[];
    months[m].push(d);
  });

  let old=document.getElementById('freqRelatorioOverlay');if(old)old.remove();
  const overlay=document.createElement('div');
  overlay.id='freqRelatorioOverlay';
  overlay.className='freq-cal-overlay';
  overlay.onclick=function(e){if(e.target===this)this.remove();};

  let html=`<div class="freq-cal-box" style="max-width:95vw;width:auto;min-width:700px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 style="margin:0;font-size:1.1rem;"><i class="fas fa-calendar-check"></i> Relatório Mensal — ${escHTML(filtroTurma)} (${bim}ºB)</h2>
      <div style="display:flex;gap:6px;">
        <button onclick="window.print()" style="padding:6px 14px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;"><i class="fas fa-print"></i> Imprimir</button>
        <button onclick="this.closest('.freq-cal-overlay').remove()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:#64748b;">&times;</button>
      </div>
    </div>`;

  Object.keys(months).sort().forEach(monthKey=>{
    const monthDates=months[monthKey];
    const mObj=new Date(monthKey+'-15T12:00:00');
    const monthName=mObj.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

    html+=`<h3 style="margin:14px 0 6px;font-size:.88rem;text-transform:capitalize;">${monthName}</h3>
    <div style="overflow-x:auto;border:1px solid var(--border-color);border-radius:10px;margin-bottom:12px;">
    <table class="freq-monthly-table"><thead><tr><th style="text-align:left;min-width:120px;">Aluno</th>`;

    monthDates.forEach(d=>{
      const dayNum=parseInt(d.substring(8,10));
      const dObj=new Date(d+'T12:00:00');
      const wd=dObj.getDay();
      const wdNames=['D','S','T','Q','Q','S','S'];
      const isWE=wd===0||wd===6;
      html+=`<th title="${d}" style="${isWE?'color:#94a3b8;':''}">${dayNum}<br><span style="font-size:.55rem;font-weight:400;">${wdNames[wd]}</span></th>`;
    });
    html+=`<th style="min-width:30px;">P</th><th style="min-width:30px;">F</th><th style="min-width:30px;">J</th><th style="min-width:40px;">%</th></tr></thead><tbody>`;

    // Day totals
    const dayTotals=monthDates.map(()=>({P:0,F:0,J:0}));

    lista.forEach(a=>{
      let cP=0,cF=0,cJ=0;
      html+=`<tr><td class="name-col" title="${escHTML(a.nome)}">${escHTML(a.nome)}</td>`;
      monthDates.forEach((d,di)=>{
        const key=`${filtroTurma}|${bim}|${d}`;
        const reg=freq[key]||{};
        const s=reg[a.id]||'';
        const dObj=new Date(d+'T12:00:00');
        const isWE=dObj.getDay()===0||dObj.getDay()===6;
        const cls=s?(s==='P'?'P':(s==='F'?'F':'J')):'';
        if(s==='P'){cP++;dayTotals[di].P++;}
        if(s==='F'){cF++;dayTotals[di].F++;}
        if(s==='J'){cJ++;dayTotals[di].J++;}
        html+=`<td class="${cls}${isWE?' weekend':''}">${s||'—'}</td>`;
      });
      const total=cP+cF+cJ;
      const pct=total>0?Math.round(cP/total*100):0;
      const pctColor=pct>=75?'#16a34a':(pct>=50?'#f59e0b':'#dc2626');
      html+=`<td style="font-weight:700;color:#166534;">${cP}</td>
             <td style="font-weight:700;color:#991b1b;">${cF}</td>
             <td style="font-weight:700;color:#854d0e;">${cJ}</td>
             <td style="font-weight:800;color:${pctColor};">${pct}%</td></tr>`;
    });

    // Footer with day totals
    html+=`</tbody><tfoot><tr><td style="text-align:left;font-weight:700;">Total dia</td>`;
    monthDates.forEach((d,di)=>{
      const t=dayTotals[di];
      html+=`<td title="P:${t.P} F:${t.F} J:${t.J}" style="font-size:.6rem;">${t.F>0?`<span style="color:#991b1b;">${t.F}F</span>`:'✓'}</td>`;
    });
    html+=`<td></td><td></td><td></td><td></td></tr></tfoot></table></div>`;
  });

  html+=`</div>`;
  overlay.innerHTML=html;
  document.body.appendChild(overlay);
}

// === F3: CALENDÁRIO VISUAL DE PRESENÇA INDIVIDUAL ===
function freqAbrirCalendarioAluno(alunoId){
  const a=alunos.find(al=>al.id===alunoId);
  if(!a) return showToast('Aluno não encontrado.','error');
  const bim=bimestreAtual;
  const dates=__freqGetDatesTurmaBim(a.turma,bim).sort();
  const freq=window.__sgpFrequencia||{};
  const today=__freqTodayStr();

  // Collect all months involved
  const monthSet=new Set();
  dates.forEach(d=>monthSet.add(d.substring(0,7)));
  const monthsList=[...monthSet].sort();

  let old=document.getElementById('freqCalAluno');if(old)old.remove();
  const overlay=document.createElement('div');
  overlay.id='freqCalAluno';
  overlay.className='freq-cal-overlay';
  overlay.onclick=function(e){if(e.target===this)this.remove();};

  const fAluno=calcFreqAluno(alunoId,bim);

  // Day-of-week analysis
  const dowCount={0:0,1:0,2:0,3:0,4:0,5:0,6:0};
  const dowFaltas={0:0,1:0,2:0,3:0,4:0,5:0,6:0};
  dates.forEach(d=>{
    const key=`${a.turma}|${bim}|${d}`;
    const reg=freq[key]||{};
    const s=reg[alunoId]||'';
    const wd=new Date(d+'T12:00:00').getDay();
    if(s) dowCount[wd]++;
    if(s==='F') dowFaltas[wd]++;
  });
  const dowNames=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];

  // Pattern detection
  const patterns=[];
  [1,2,3,4,5].forEach(wd=>{
    if(dowCount[wd]>=2 && dowFaltas[wd]>=2){
      const pct=Math.round(dowFaltas[wd]/dowCount[wd]*100);
      if(pct>=50) patterns.push({type:'dow',wd,pct,label:`Falta ${pct}% das ${dowNames[wd]}s (${dowFaltas[wd]}/${dowCount[wd]})`});
    }
  });

  // Streak detection
  let maxStreak=0,curStreak=0;
  dates.forEach(d=>{
    const key=`${a.turma}|${bim}|${d}`;
    const s=(freq[key]||{})[alunoId]||'';
    if(s==='F'){curStreak++;maxStreak=Math.max(maxStreak,curStreak);}
    else curStreak=0;
  });
  if(maxStreak>=3) patterns.push({type:'streak',label:`Maior sequência de faltas: ${maxStreak} dias consecutivos`});

  // Trend (last 5 registros vs first 5)
  if(dates.length>=10){
    const first5=dates.slice(0,5);
    const last5=dates.slice(-5);
    const fFirst=first5.filter(d=>(freq[`${a.turma}|${bim}|${d}`]||{})[alunoId]==='F').length;
    const fLast=last5.filter(d=>(freq[`${a.turma}|${bim}|${d}`]||{})[alunoId]==='F').length;
    if(fLast>fFirst+1) patterns.push({type:'trend_down',label:`Tendência de piora: ${fFirst} faltas nos primeiros registros → ${fLast} nos últimos`});
    else if(fFirst>fLast+1) patterns.push({type:'trend_up',label:`Tendência de melhora: ${fFirst} faltas no início → ${fLast} no final`});
  }

  let html=`<div class="freq-cal-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h2 style="margin:0;font-size:1.05rem;"><i class="fas fa-calendar"></i> ${escHTML(a.nome)}</h2>
      <button onclick="this.closest('.freq-cal-overlay').remove()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:#64748b;">&times;</button>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
      <div style="padding:8px 14px;border-radius:8px;background:rgba(14,165,233,.08);font-size:.82rem;">
        <b>${fAluno.presentes}</b> presenças
      </div>
      <div style="padding:8px 14px;border-radius:8px;background:#fee2e2;font-size:.82rem;color:#991b1b;">
        <b>${fAluno.faltas}</b> faltas
      </div>
      <div style="padding:8px 14px;border-radius:8px;background:#fef9c3;font-size:.82rem;color:#854d0e;">
        <b>${fAluno.justificadas}</b> justificadas
      </div>
      <div style="padding:8px 14px;border-radius:8px;font-size:.82rem;font-weight:800;color:${fAluno.pct>=75?'#16a34a':(fAluno.pct>=50?'#f59e0b':'#dc2626')};">
        ${fAluno.pct.toFixed(0)}% frequência
      </div>
    </div>`;

  if(patterns.length){
    html+=`<div style="margin-bottom:12px;display:flex;gap:6px;flex-wrap:wrap;">`;
    patterns.forEach(p=>{
      const cls=p.type==='trend_up'?'info':(p.type==='dow'||p.type==='streak'?'danger':'warn');
      const icon=p.type==='dow'?'fa-calendar-day':(p.type==='streak'?'fa-fire':'fa-chart-line');
      html+=`<span class="freq-pattern-chip ${cls}"><i class="fas ${icon}"></i> ${escHTML(p.label)}</span>`;
    });
    html+=`</div>`;
  }

  // Render month calendars
  monthsList.forEach(mk=>{
    const mObj=new Date(mk+'-15T12:00:00');
    const monthName=mObj.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    const year=parseInt(mk.substring(0,4)),month=parseInt(mk.substring(5,7))-1;
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();

    html+=`<div style="margin-bottom:12px;">
      <div style="font-weight:700;font-size:.82rem;text-transform:capitalize;margin-bottom:4px;">${monthName}</div>
      <div class="freq-cal-grid">`;
    ['D','S','T','Q','Q','S','S'].forEach(d=>{html+=`<div class="freq-cal-cell hdr">${d}</div>`;});
    for(let i=0;i<firstDay;i++) html+=`<div class="freq-cal-cell empty"></div>`;
    for(let day=1;day<=daysInMonth;day++){
      const dStr=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const key=`${a.turma}|${bim}|${dStr}`;
      const reg=freq[key]||{};
      const s=reg[alunoId]||'';
      const cls=s?(s==='P'?'P':(s==='F'?'F':'J')):'none';
      const isToday=dStr===today?'today':'';
      const title=s?`${dStr}: ${s==='P'?'Presente':(s==='F'?'Falta':'Justificada')}`:(dates.includes(dStr)?`${dStr}: Sem marcação`:`${dStr}`);
      html+=`<div class="freq-cal-cell ${cls} ${isToday}" title="${title}">${day}</div>`;
    }
    html+=`</div></div>`;
  });

  // Day-of-week breakdown
  html+=`<div style="margin-top:8px;padding:10px;border-radius:10px;border:1px solid var(--border-color);">
    <div style="font-weight:700;font-size:.78rem;margin-bottom:6px;color:#64748b;">Faltas por dia da semana</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">`;
  [1,2,3,4,5].forEach(wd=>{
    const pct=dowCount[wd]>0?Math.round(dowFaltas[wd]/dowCount[wd]*100):0;
    const cor=pct>=50?'#dc2626':(pct>=25?'#f59e0b':'#16a34a');
    html+=`<div style="text-align:center;min-width:50px;">
      <div style="font-size:.65rem;color:#64748b;">${dowNames[wd]}</div>
      <div style="font-size:.85rem;font-weight:800;color:${cor};">${dowFaltas[wd]}/${dowCount[wd]}</div>
      <div style="font-size:.6rem;color:${cor};">${pct}%</div>
    </div>`;
  });
  html+=`</div></div></div>`;

  overlay.innerHTML=html;
  document.body.appendChild(overlay);
}

// === F4: RELATÓRIO MENSAL CONSOLIDADO (alias, used by F2) ===
// (Implemented in F2 — freqAbrirRelatorioMensal)

// === F5: GRÁFICO DE TENDÊNCIA DE FREQUÊNCIA DA TURMA ===
function freqRenderTrendChart(containerId){
  const container=document.getElementById(containerId);
  if(!container) return;
  const bim=bimestreAtual;
  const dates=__freqGetDatesTurmaBim(filtroTurma,bim).sort();
  if(dates.length<2){container.innerHTML='<div style="color:#94a3b8;font-size:.8rem;text-align:center;padding:12px;">Poucos registros para gerar tendência.</div>';return;}
  const freq=window.__sgpFrequencia||{};
  const lista=alunos.filter(a=>a.turma===filtroTurma);

  const dataPoints=dates.map(d=>{
    const key=`${filtroTurma}|${bim}|${d}`;
    const reg=freq[key]||{};
    let p=0,total=0;
    lista.forEach(a=>{
      const s=reg[a.id];
      if(s==='P'||s==='F'||s==='J'){total++;if(s==='P'||s==='J')p++;}
    });
    return {date:d,pct:total>0?p/total*100:0};
  });

  const canvasId='freqTrendCanvas_'+Date.now();
  container.innerHTML=`<canvas id="${canvasId}" class="freq-trend-canvas"></canvas>`;

  setTimeout(()=>{
    const canvas=document.getElementById(canvasId);
    if(!canvas) return;
    const W=canvas.width=canvas.offsetWidth*2,H=canvas.height=360;
    const c=canvas.getContext('2d');
    const pad={t:20,b:40,l:50,r:20};
    const pW=W-pad.l-pad.r,pH=H-pad.t-pad.b;
    c.clearRect(0,0,W,H);

    // Grid
    c.strokeStyle='rgba(148,163,184,.12)';c.lineWidth=1;
    [0,25,50,75,100].forEach(v=>{
      const y=pad.t+pH-(v/100)*pH;
      c.beginPath();c.moveTo(pad.l,y);c.lineTo(W-pad.r,y);c.stroke();
      c.fillStyle='#94a3b8';c.font='16px sans-serif';c.textAlign='right';
      c.fillText(v+'%',pad.l-6,y+5);
    });

    // 75% reference
    c.strokeStyle='rgba(22,163,74,.25)';c.lineWidth=2;c.setLineDash([6,4]);
    const y75=pad.t+pH-(75/100)*pH;
    c.beginPath();c.moveTo(pad.l,y75);c.lineTo(W-pad.r,y75);c.stroke();
    c.setLineDash([]);

    const step=dataPoints.length>1?pW/(dataPoints.length-1):pW;
    const points=dataPoints.map((d,i)=>({x:pad.l+i*step,y:pad.t+pH-(d.pct/100)*pH,pct:d.pct,date:d.date}));

    // Gradient fill
    const grad=c.createLinearGradient(0,pad.t,0,H-pad.b);
    grad.addColorStop(0,'rgba(14,165,233,.15)');grad.addColorStop(1,'rgba(14,165,233,0)');
    c.beginPath();c.moveTo(points[0].x,H-pad.b);
    points.forEach(p=>c.lineTo(p.x,p.y));
    c.lineTo(points[points.length-1].x,H-pad.b);c.closePath();
    c.fillStyle=grad;c.fill();

    // Line
    c.beginPath();c.strokeStyle='#0ea5e9';c.lineWidth=3;c.lineJoin='round';
    points.forEach((p,i)=>{if(i===0)c.moveTo(p.x,p.y);else c.lineTo(p.x,p.y);});
    c.stroke();

    // Dots
    points.forEach(p=>{
      const cor=p.pct>=75?'#16a34a':(p.pct>=50?'#f59e0b':'#dc2626');
      c.beginPath();c.arc(p.x,p.y,5,0,Math.PI*2);c.fillStyle=cor;c.fill();
    });

    // X labels (show some dates)
    const labelStep=Math.max(1,Math.floor(points.length/8));
    points.forEach((p,i)=>{
      if(i%labelStep===0||i===points.length-1){
        const dObj=new Date(p.date+'T12:00:00');
        const lbl=dObj.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
        c.fillStyle='#64748b';c.font='14px sans-serif';c.textAlign='center';
        c.save();c.translate(p.x,H-pad.b+14);c.rotate(-0.4);c.fillText(lbl,0,0);c.restore();
      }
    });

    // Average line
    const avg=dataPoints.reduce((s,d)=>s+d.pct,0)/dataPoints.length;
    const yAvg=pad.t+pH-(avg/100)*pH;
    c.strokeStyle='rgba(124,58,237,.4)';c.lineWidth=2;c.setLineDash([4,4]);
    c.beginPath();c.moveTo(pad.l,yAvg);c.lineTo(W-pad.r,yAvg);c.stroke();
    c.setLineDash([]);
    c.fillStyle='#7c3aed';c.font='bold 14px sans-serif';c.textAlign='left';
    c.fillText(`Média: ${avg.toFixed(0)}%`,pad.l+6,yAvg-6);
  },50);
}

// === F6: CONFIRMAÇÃO VISUAL AO SALVAR ===
const __origSetFreq=setFreq;
setFreq=function(alunoId,value){
  __origSetFreq(alunoId,value);
  // Animate the button
  try{
    const date=document.getElementById('freqDate')?.value||__freqTodayStr();
    const key=`${filtroTurma}|${bimestreAtual}|${date}`;
    const current=(window.__sgpFrequencia[key]||{})[alunoId]||'';
    const container=document.getElementById('freqTableContainer');
    if(!container) return;
    const btns=container.querySelectorAll('.freq-btn');
    btns.forEach(btn=>{
      if(btn.getAttribute('onclick')&&btn.getAttribute('onclick').includes(`'${alunoId}'`)){
        if((current===value&&btn.textContent.trim()===value)||(current&&btn.textContent.trim()===current)){
          btn.classList.add('saved');
          setTimeout(()=>btn.classList.remove('saved'),600);
        }
      }
    });
  }catch(_){}
};

// === F7: DESFAZER ÚLTIMA MARCAÇÃO (Ctrl+Z) ===
window.__freqUndoStack=[];

const __origSetFreq2=setFreq;
setFreq=function(alunoId,value){
  try{
    const date=document.getElementById('freqDate')?.value||__freqTodayStr();
    const key=`${filtroTurma}|${bimestreAtual}|${date}`;
    const prev=(window.__sgpFrequencia[key]||{})[alunoId]||'';
    window.__freqUndoStack.push({key,alunoId,prev,turma:filtroTurma,bim:bimestreAtual,date});
    if(window.__freqUndoStack.length>50) window.__freqUndoStack.shift();
  }catch(_){}
  __origSetFreq2(alunoId,value);
  __freqShowUndoToast();
};

function __freqShowUndoToast(){
  let toast=document.getElementById('freqUndoToast');
  if(toast) toast.remove();
  if(!window.__freqUndoStack.length) return;
  const last=window.__freqUndoStack[window.__freqUndoStack.length-1];
  const nome=alunos.find(a=>a.id===last.alunoId)?.nome||'Aluno';
  toast=document.createElement('div');
  toast.id='freqUndoToast';
  toast.className='freq-undo-toast';
  toast.innerHTML=`<span>✓ Marcação salva — ${escHTML(nome)}</span><button onclick="freqUndo()"><i class="fas fa-undo"></i> Desfazer</button>`;
  document.body.appendChild(toast);
  clearTimeout(window.__freqUndoTimer);
  window.__freqUndoTimer=setTimeout(()=>{const t=document.getElementById('freqUndoToast');if(t)t.remove();},4000);
}

function freqUndo(){
  if(!window.__freqUndoStack.length) return;
  const last=window.__freqUndoStack.pop();
  if(last.prev){
    if(!window.__sgpFrequencia[last.key]) window.__sgpFrequencia[last.key]={};
    window.__sgpFrequencia[last.key][last.alunoId]=last.prev;
  }else{
    if(window.__sgpFrequencia[last.key]) delete window.__sgpFrequencia[last.key][last.alunoId];
  }
  __saveFrequencia();
  renderFrequencia();
  const t=document.getElementById('freqUndoToast');if(t)t.remove();
  showToast('Marcação desfeita!','success');
}

// Ctrl+Z handler
document.addEventListener('keydown',function(e){
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){
    const modal=document.getElementById('modalFrequencia');
    if(modal&&modal.style.display!=='none'&&window.__freqUndoStack.length){
      e.preventDefault();
      freqUndo();
    }
  }
});

// === F8: ALERTA INTELIGENTE DE PADRÃO ===
function __freqDetectarPadroes(turma,bim){
  const dates=__freqGetDatesTurmaBim(turma,bim).sort();
  if(dates.length<5) return [];
  const freq=window.__sgpFrequencia||{};
  const lista=alunos.filter(a=>a.turma===turma);
  const dowNames=['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
  const insights=[];

  // Per-student patterns
  lista.forEach(a=>{
    const dowCount={},dowFaltas={};
    for(let w=0;w<7;w++){dowCount[w]=0;dowFaltas[w]=0;}
    let totalF=0,totalRegs=0;
    dates.forEach(d=>{
      const key=`${turma}|${bim}|${d}`;
      const s=(freq[key]||{})[a.id]||'';
      if(!s) return;
      const wd=new Date(d+'T12:00:00').getDay();
      dowCount[wd]++;totalRegs++;
      if(s==='F'){dowFaltas[wd]++;totalF++;}
    });

    // Day-of-week pattern
    [1,2,3,4,5].forEach(wd=>{
      if(dowCount[wd]>=3 && dowFaltas[wd]>=2){
        const pct=Math.round(dowFaltas[wd]/dowCount[wd]*100);
        if(pct>=60) insights.push({
          severity:'danger',
          icon:'fa-calendar-day',
          text:`${escHTML(a.nome||'Aluno')} falta ${pct}% das ${dowNames[wd]}s (${dowFaltas[wd]}/${dowCount[wd]})`,
          alunoId:a.id
        });
      }
    });

    // Increasing trend
    if(dates.length>=8){
      const half=Math.floor(dates.length/2);
      const first=dates.slice(0,half);
      const second=dates.slice(half);
      const fFirst=first.filter(d=>(freq[`${turma}|${bim}|${d}`]||{})[a.id]==='F').length;
      const fSecond=second.filter(d=>(freq[`${turma}|${bim}|${d}`]||{})[a.id]==='F').length;
      if(fSecond>=fFirst+2 && fSecond>=3) insights.push({
        severity:'warn',
        icon:'fa-chart-line',
        text:`${escHTML(a.nome||'Aluno')}: faltas aumentando (${fFirst} → ${fSecond} na segunda metade)`,
        alunoId:a.id
      });
    }

    // Long streak
    let streak=0,maxS=0;
    dates.forEach(d=>{
      const s=(freq[`${turma}|${bim}|${d}`]||{})[a.id]||'';
      if(s==='F'){streak++;maxS=Math.max(maxS,streak);}else streak=0;
    });
    if(maxS>=5) insights.push({
      severity:'danger',
      icon:'fa-fire',
      text:`${escHTML(a.nome||'Aluno')}: sequência de ${maxS} faltas consecutivas`,
      alunoId:a.id
    });
  });

  // Turma-level: days with many absences
  dates.forEach(d=>{
    const key=`${turma}|${bim}|${d}`;
    const reg=freq[key]||{};
    let fCount=0,total=0;
    lista.forEach(a=>{const s=reg[a.id];if(s){total++;if(s==='F')fCount++;}});
    if(total>=5 && fCount/total>=0.3){
      const dObj=new Date(d+'T12:00:00');
      const dFmt=dObj.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'});
      insights.push({
        severity:'info',
        icon:'fa-users',
        text:`${dFmt}: ${Math.round(fCount/total*100)}% de faltas na turma (${fCount}/${total})`,
        date:d
      });
    }
  });

  // Limit insights
  insights.sort((a,b)=>{const s={danger:0,warn:1,info:2};return (s[a.severity]||9)-(s[b.severity]||9);});
  return insights.slice(0,12);
}

function renderFreqPatternsHTML(turma,bim){
  const patterns=__freqDetectarPadroes(turma,bim);
  if(!patterns.length) return '';
  let html=`<div class="dash-card wide v17-freq-patterns" style="border:1px solid rgba(245,158,11,.2);">
    <h3 style="margin:0 0 8px;"><i class="fas fa-lightbulb" style="color:#f59e0b;"></i> Insights de Frequência — ${escHTML(turma)} (${bim}ºB)</h3>
    <div style="display:flex;flex-direction:column;gap:4px;">`;
  patterns.forEach(p=>{
    const clickAttr=p.alunoId?` style="cursor:pointer;" onclick="freqAbrirCalendarioAluno('${p.alunoId}')" title="Ver calendário do aluno"`:'';
    html+=`<div class="freq-pattern-chip ${p.severity}"${clickAttr}><i class="fas ${p.icon}"></i> ${p.text}</div>`;
  });
  html+=`</div></div>`;
  return html;
}

// === INJECT BUTTONS INTO CHAMADA MODAL ===
try{
  const __origRenderFreq=renderFrequencia;
  renderFrequencia=function(){
    // Bug fix: always remove orphaned freqExtraButtons before rebuild
    try{ const old=document.getElementById('freqExtraButtons'); if(old) old.remove(); }catch(_){}
    __origRenderFreq();
    // Inject extra buttons inside container
    try{
      const container=document.getElementById('freqTableContainer');
      if(container){
        const btnsDiv=document.createElement('div');
        btnsDiv.id='freqExtraButtons';
        btnsDiv.style.cssText='display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color);';
        btnsDiv.innerHTML=`
          <button onclick="freqCopiarAusentesWA()" style="padding:6px 14px;background:#25D366;color:#fff;border:none;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;"><i class="fab fa-whatsapp"></i> Copiar Ausentes</button>
          <button onclick="freqAbrirRelatorioMensal()" style="padding:6px 14px;background:#7c3aed;color:#fff;border:none;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;"><i class="fas fa-file-pdf"></i> Relatório Mensal</button>
          <button onclick="__freqAbrirTendencia()" style="padding:6px 14px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;"><i class="fas fa-chart-line"></i> Tendência</button>
        `;
        container.appendChild(btnsDiv);
      }
    }catch(_){}

    // Make student names clickable for calendar
    try{
      const container=document.getElementById('freqTableContainer');
      if(!container) return;
      const rows=container.querySelectorAll('tbody tr');
      const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
      rows.forEach((tr,i)=>{
        const td=tr.querySelector('td:nth-child(2)');
        if(!td) return;
        // Match by name text to handle search filtering
        const nomeText=(td.textContent||'').trim();
        const alunoMatch=lista.find(a=>(a.nome||'').trim()===nomeText);
        if(!alunoMatch) return;
        td.style.cssText='text-align:left;cursor:pointer;color:var(--primary);text-decoration:underline;text-decoration-style:dotted;';
        td.title='Clique para ver calendário de presença';
        td.onclick=function(){freqAbrirCalendarioAluno(alunoMatch.id);};
      });
    }catch(_){}
  };
}catch(_){}

// Tendência popup
function __freqAbrirTendencia(){
  let old=document.getElementById('freqTrendOverlay');if(old)old.remove();
  const overlay=document.createElement('div');
  overlay.id='freqTrendOverlay';
  overlay.className='freq-cal-overlay';
  overlay.onclick=function(e){if(e.target===this)this.remove();};
  overlay.innerHTML=`<div class="freq-cal-box" style="max-width:700px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h2 style="margin:0;font-size:1.05rem;"><i class="fas fa-chart-line"></i> Tendência de Frequência — ${escHTML(filtroTurma)}</h2>
      <button onclick="this.closest('.freq-cal-overlay').remove()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;color:#64748b;">&times;</button>
    </div>
    <div id="freqTrendContainer"></div>
  </div>`;
  document.body.appendChild(overlay);
  setTimeout(()=>freqRenderTrendChart('freqTrendContainer'),50);
}

// === INJECT PATTERNS INTO DASHBOARD ===
try{
  const __origRenderDash3=renderizarDashboard;
  renderizarDashboard=function(){
    __origRenderDash3();
    try{
      const dashEl=document.getElementById('viewDashboard');
      if(!dashEl) return;
      dashEl.querySelectorAll('.v17-freq-patterns').forEach(el=>el.remove());
      if(filtroTurma&&filtroTurma!=='Todas'){
        const pHtml=renderFreqPatternsHTML(filtroTurma,bimestreAtual);
        if(pHtml){
          const div=document.createElement('div');
          div.className='v17-freq-patterns';div.style.gridColumn='1/-1';
          div.innerHTML=pHtml;
          dashEl.appendChild(div);
        }
      }
    }catch(_){}
  };
}catch(_){}


// ===============================================
// V13 FEATURE 5: BOLETIM INDIVIDUAL
// ===============================================
function abrirBoletim(alunoId){
  const a = alunos.find(al=>al.id===alunoId);
  if(!a) return showToast("Aluno não encontrado.", "error");
  
  const d1 = getDiscById(config.slot1);
  const d2 = getDiscById(config.slot2);
  const nm1 = d1?.nome || config.materia1 || 'Matéria 1';
  const nm2 = d2?.nome || config.materia2 || 'Matéria 2';
  const avs1 = (d1?.avaliacoes||[]);
  const avs2 = (d2?.avaliacoes||[]);
  
  let html = `<div class="boletim-overlay" id="boletimOverlay" onclick="if(event.target===this)this.remove();">
    <div class="boletim-container">
      <button class="boletim-close" onclick="document.getElementById('boletimOverlay').remove();">&times;</button>
      <div class="boletim-header">
        <h2>BOLETIM ESCOLAR</h2>
        <p><b>Aluno(a):</b> ${escHTML(a.nome)} &nbsp;|&nbsp; <b>Turma:</b> ${escHTML(a.turma)}</p>
      </div>`;
  
  // Notas por bimestre
  html += `<div class="boletim-section"><h3>${escHTML(nm1)}</h3>
    <table class="boletim-table"><thead><tr><th>Bim</th>`;
  avs1.forEach(av=>{ html+=`<th>${escHTML(av.label||av.id)}</th>`; });
  html+=`<th style="background:#e0f2fe;"><b>Média</b></th></tr></thead><tbody>`;
  [1,2,3,4].forEach(bim=>{
    const b = a.bimestres[bim]; if(!b) return;
    _syncBimestreRefs(b);
    html+=`<tr><td><b>${bim}º</b></td>`;
    avs1.forEach(av=>{ html+=`<td>${b.notas_lp?.[av.id]||0}</td>`; });
    html+=`<td style="background:#e0f2fe;"><b>${b.media_lp||'0.0'}</b></td></tr>`;
  });
  html+=`</tbody></table></div>`;
  
  html += `<div class="boletim-section"><h3>${escHTML(nm2)}</h3>
    <table class="boletim-table"><thead><tr><th>Bim</th>`;
  avs2.forEach(av=>{ html+=`<th>${escHTML(av.label||av.id)}</th>`; });
  html+=`<th style="background:#fce7f3;"><b>Média</b></th></tr></thead><tbody>`;
  [1,2,3,4].forEach(bim=>{
    const b = a.bimestres[bim]; if(!b) return;
    _syncBimestreRefs(b);
    html+=`<tr><td><b>${bim}º</b></td>`;
    avs2.forEach(av=>{ html+=`<td>${b.notas_red?.[av.id]||0}</td>`; });
    html+=`<td style="background:#fce7f3;"><b>${b.media_red||'0.0'}</b></td></tr>`;
  });
  html+=`</tbody></table></div>`;
  
  // Frequência
  html+=`<div class="boletim-section"><h3>Frequência</h3>
    <table class="boletim-table"><thead><tr><th>Bim</th><th>Frequência</th></tr></thead><tbody>`;
  [1,2,3,4].forEach(bim=>{
    const b = a.bimestres[bim]; if(!b) return;
    const freq = calcFreqAluno(a.id, bim);
    html+=`<tr><td>${bim}º</td><td>${freq.pct.toFixed(0)}% (${freq.faltas} falta(s))</td></tr>`;
  });
  html+=`</tbody></table></div>`;
  
  // Ocorrências
  let hasOcc = false;
  [1,2,3,4].forEach(bim=>{
    const b = a.bimestres[bim];
    if(b && b.ocorrencias && b.ocorrencias.length>0) hasOcc=true;
  });
  if(hasOcc){
    html+=`<div class="boletim-section"><h3>Ocorrências</h3><ul style="font-size:0.85rem;">`;
    [1,2,3,4].forEach(bim=>{
      const b = a.bimestres[bim]; if(!b) return;
      (b.ocorrencias||[]).forEach(o=>{
        html+=`<li><b>${bim}ºBim</b> (${escHTML(o.data||'-')}): <i>${escHTML(o.tipo||'')}</i> — ${escHTML(o.texto||'')}</li>`;
      });
    });
    html+=`</ul></div>`;
  }
  
  // Parecer
  [1,2,3,4].forEach(bim=>{
    const b = a.bimestres[bim];
    if(b && b.parecer){
      html+=`<div class="boletim-section"><h3>Parecer — ${bim}º Bimestre</h3><p style="font-size:0.85rem;">${escHTML(b.parecer)}</p></div>`;
    }
  });
  
  html+=`<div class="boletim-actions">
      <button class="boletim-btn-print" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
    </div>
    </div></div>`;
  
  // Remove previous if exists
  const old = document.getElementById('boletimOverlay');
  if(old) old.remove();
  document.body.insertAdjacentHTML('beforeend', html);
}

function gerarBoletimTurma(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma primeiro.", "error");
  const lista = getAlunosFiltrados();
  if(lista.length===0) return showToast("Nenhum aluno na turma.", "error");
  // Open boletim for first student — user can navigate
  const idx = 0;
  abrirBoletimNavegavel(lista, idx);
}

function abrirBoletimNavegavel(lista, idx){
  if(idx<0||idx>=lista.length) return;
  abrirBoletim(lista[idx].id);
  // Add navigation
  const container = document.querySelector('.boletim-actions');
  if(container && lista.length>1){
    container.insertAdjacentHTML('beforeend',
      `<button onclick="document.getElementById('boletimOverlay').remove();abrirBoletimNavegavel(getAlunosFiltrados(),${idx-1})" ${idx===0?'disabled':''} style="padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;cursor:pointer;background:#fff;">← Anterior</button>
       <span style="font-size:0.85rem;color:#64748b;">${idx+1}/${lista.length}</span>
       <button onclick="document.getElementById('boletimOverlay').remove();abrirBoletimNavegavel(getAlunosFiltrados(),${idx+1})" ${idx===lista.length-1?'disabled':''} style="padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;cursor:pointer;background:#fff;">Próximo →</button>`
    );
  }
}

// ===============================================
// V13 FEATURE 6: PLANNER BADGE
// ===============================================
function updatePlannerBadge(){
  try{
    const badge = document.getElementById('plannerBadge');
    if(!badge) return;
    const today = _plannerStartOfDayISO ? _plannerStartOfDayISO() : new Date().toISOString().slice(0,10);
    const overdue = (plannerTasks||[]).filter(t=>t.status!=='done' && t.date && t.date < today).length;
    if(overdue > 0){
      badge.textContent = overdue > 99 ? '99+' : overdue;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }catch(_){}
}

// Hook into plannerPersist and plannerRender to update badge
const __origPlannerRender = (typeof plannerRender === 'function') ? plannerRender : null;
if(__origPlannerRender){
  plannerRender = function(){
    __origPlannerRender();
    try{ updatePlannerBadge(); }catch(_){}
  };
}
// Also hook into plannerPersist
try{
  const __origPlannerPersist = (typeof plannerPersist === 'function') ? plannerPersist : null;
  if(__origPlannerPersist){
    plannerPersist = function(){
      __origPlannerPersist();
      try{ updatePlannerBadge(); }catch(_){}
    };
  }
}catch(_){}

// ===============================================
// V13 FEATURE 7: RICHER DASHBOARD CHARTS
// ===============================================
let __dashPie1=null, __dashPie2=null, __dashHist1=null, __dashHist2=null;

const __origRenderDash = renderizarDashboard;
renderizarDashboard = function(){
  __origRenderDash();
  renderDashPieCharts();
  renderDashHistograms();
};

function renderDashPieCharts(){
  if(typeof Chart === 'undefined') return;
  const lista = getAlunosFiltrados();
  const cat = (m)=> (m>=7 ? 'verde' : (m>=5 ? 'amarelo' : 'vermelho'));
  const c1={verde:0,amarelo:0,vermelho:0}, c2={verde:0,amarelo:0,vermelho:0};
  
  lista.forEach(a=>{
    const b = a?.bimestres?.[bimestreAtual]; if(!b) return;
    _syncBimestreRefs(b);
    c1[cat(clampNota(calcularMediaDisc(config.slot1, b.notas_lp)))]++;
    c2[cat(clampNota(calcularMediaDisc(config.slot2, b.notas_red)))]++;
  });
  
  const colors = ['#16a34a','#f59e0b','#dc2626'];
  const labels = ['Verde (≥7)','Amarelo (5-6.9)','Vermelho (<5)'];
  const pieOpts = {responsive:true, maintainAspectRatio:true, plugins:{legend:{position:'bottom',labels:{font:{size:11}}}}};
  
  // Pie 1
  const cv1 = document.getElementById('dashPieMat1');
  if(cv1){
    if(__dashPie1) __dashPie1.destroy();
    __dashPie1 = new Chart(cv1.getContext('2d'),{
      type:'doughnut',
      data:{labels, datasets:[{data:[c1.verde,c1.amarelo,c1.vermelho], backgroundColor:colors, borderWidth:2, borderColor:'#fff'}]},
      options:pieOpts
    });
  }
  // Pie 2
  const cv2 = document.getElementById('dashPieMat2');
  if(cv2){
    if(__dashPie2) __dashPie2.destroy();
    __dashPie2 = new Chart(cv2.getContext('2d'),{
      type:'doughnut',
      data:{labels, datasets:[{data:[c2.verde,c2.amarelo,c2.vermelho], backgroundColor:colors, borderWidth:2, borderColor:'#fff'}]},
      options:pieOpts
    });
  }
}

function renderDashHistograms(){
  if(typeof Chart === 'undefined') return;
  const lista = getAlunosFiltrados();
  
  function buildHist(slotId, notasKey){
    const bins = Array(11).fill(0); // 0,1,2,...,10
    lista.forEach(a=>{
      const b = a?.bimestres?.[bimestreAtual]; if(!b) return;
      _syncBimestreRefs(b);
      const m = clampNota(calcularMediaDisc(slotId, b[notasKey]));
      bins[Math.min(Math.floor(m),10)]++;
    });
    return bins;
  }
  
  const bins1 = buildHist(config.slot1, 'notas_lp');
  const bins2 = buildHist(config.slot2, 'notas_red');
  
  const histLabels = ['0','1','2','3','4','5','6','7','8','9','10'];
  const histColors = histLabels.map((_,i)=> i<5?'#fca5a5':(i<7?'#fde68a':'#86efac'));
  
  const histOpts = {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{y:{beginAtZero:true, ticks:{stepSize:1}}, x:{title:{display:true,text:'Nota'}}}
  };
  
  const ch1 = document.getElementById('dashHistMat1');
  if(ch1){
    if(__dashHist1) __dashHist1.destroy();
    __dashHist1 = new Chart(ch1.getContext('2d'),{
      type:'bar',
      data:{labels:histLabels, datasets:[{label:'Alunos', data:bins1, backgroundColor:histColors, borderRadius:4}]},
      options:histOpts
    });
  }
  const ch2 = document.getElementById('dashHistMat2');
  if(ch2){
    if(__dashHist2) __dashHist2.destroy();
    __dashHist2 = new Chart(ch2.getContext('2d'),{
      type:'bar',
      data:{labels:histLabels, datasets:[{label:'Alunos', data:bins2, backgroundColor:histColors, borderRadius:4}]},
      options:histOpts
    });
  }
}

// ===============================================
// V13 FEATURE 8: BACKUP REMINDER
// ===============================================
function initBackupReminder(){
  // Check every 30 minutes
  setInterval(checkBackupReminder, 30*60*1000);
  // Also check on load after 10s
  setTimeout(checkBackupReminder, 10000);
}

function checkBackupReminder(){
  try{
    if(alunos.length===0) return; // No data, no need
    const lastBackup = parseInt(localStorage.getItem('sgp_last_backup')||'0',10);
    const now = Date.now();
    const THREE_DAYS = 3*24*60*60*1000;
    
    if(!lastBackup || (now - lastBackup > THREE_DAYS)){
      // Don't show if already showing
      if(document.getElementById('backupReminderBar')) return;
      const days = lastBackup ? Math.floor((now-lastBackup)/(24*60*60*1000)) : '?';
      const bar = document.createElement('div');
      bar.id='backupReminderBar';
      bar.className='backup-reminder-bar';
      bar.innerHTML=`<span><i class="fas fa-triangle-exclamation"></i> Você não faz backup há <b>${days}</b> dia(s). Proteja seus dados!</span>
        <span>
          <button class="btn-reminder-yes" onclick="baixarBackup();document.getElementById('backupReminderBar').remove();">Baixar Backup Agora</button>
          <button class="btn-reminder-no" onclick="document.getElementById('backupReminderBar').remove();">Depois</button>
        </span>`;
      document.body.appendChild(bar);
    }
  }catch(_){}
}

// ===============================================
// V13 FEATURE 9: ADVANCED SEARCH FILTERS
// ===============================================
let __searchFilters = {media5:false, media7:false, ocorrencia:false, comportamento:false, freqBaixa:false};

function toggleSearchFilter(filterName){
  __searchFilters[filterName] = !__searchFilters[filterName];
  // Update UI
  const btn = document.getElementById('sf' + filterName.charAt(0).toUpperCase()+filterName.slice(1));
  if(btn){
    if(__searchFilters[filterName]) btn.classList.add('active-red');
    else btn.classList.remove('active-red');
  }
  scheduleRenderVisaoContent();
}

// Override getAlunosFiltrados to include advanced filters
const __origGetAlunosFiltrados = getAlunosFiltrados;
getAlunosFiltrados = function(){
  let l = __origGetAlunosFiltrados();
  
  if(__searchFilters.media5){
    l = l.filter(a=>{
      const b=a.bimestres[bimestreAtual]; if(!b) return false;
      return parseFloat(b.media_lp)<5 || parseFloat(b.media_red)<5;
    });
  }
  if(__searchFilters.media7){
    l = l.filter(a=>{
      const b=a.bimestres[bimestreAtual]; if(!b) return false;
      return parseFloat(b.media_lp)<7 || parseFloat(b.media_red)<7;
    });
  }
  if(__searchFilters.ocorrencia){
    l = l.filter(a=>{
      const b=a.bimestres[bimestreAtual];
      return b && b.ocorrencias && b.ocorrencias.length>0;
    });
  }
  if(__searchFilters.comportamento){
    l = l.filter(a=>{
      const b=a.bimestres[bimestreAtual];
      return b && (b.comportamento||10)<7;
    });
  }
  if(__searchFilters.freqBaixa){
    l = l.filter(a=>{
      const freq = calcFreqAluno(a.id, bimestreAtual);
      return freq.total>0 && freq.pct<75;
    });
  }
  
  return l;
};

// ===============================================
// V13: Add "Boletim" link to student card context
// ===============================================
// [CONSOLIDATED] Boletim button is now rendered natively inside renderizarGrid.
// This monkey-patch is no longer needed.

// ===============================================
// V13: Include frequencia in __loadExtras / __collectBackupFiles
// ===============================================
const __origLoadExtras = (typeof __loadExtras === 'function') ? __loadExtras : null;
__loadExtras = function(){
  if(__origLoadExtras) __origLoadExtras();
  try{ __loadFrequencia(); }catch(_){}
};

// Include frequencia in backup files — now handled directly in __collectBackupFiles

// ================================================================
// V14 FEATURES — ALL NEW FUNCTIONALITY
// ================================================================

// ================================================================
// F2: ATA / RELATÓRIO CONSOLIDADO DA TURMA
// ================================================================
function gerarAtaTurma(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma primeiro.","error");
  const lista = getAlunosFiltrados().sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  if(!lista.length) return showToast("Nenhum aluno na turma.","error");

  const d1=getDiscById(config.slot1), d2=getDiscById(config.slot2);
  const nm1=d1?.nome||config.materia1||'Mat1', nm2=d2?.nome||config.materia2||'Mat2';

  let html=`<div class="ata-overlay" id="ataOverlay" onclick="if(event.target===this)this.remove();">
  <div class="ata-container">
    <button class="ata-close" onclick="document.getElementById('ataOverlay').remove();">&times;</button>
    <div style="text-align:center;border-bottom:2px solid #1e293b;padding-bottom:10px;margin-bottom:12px;">
      <h2 style="margin:0;">ATA DE RESULTADOS</h2>
      <p style="margin:4px 0;font-size:.9rem;color:#475569;">Turma: <b>${escHTML(filtroTurma)}</b> &mdash; Gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
    </div>
    <table class="ata-table"><thead><tr>
      <th rowspan="2">#</th><th rowspan="2" style="text-align:left;">Nome</th>
      <th colspan="4">${escHTML(nm1)}</th><th colspan="4">${escHTML(nm2)}</th>
      <th rowspan="2">Freq.</th><th rowspan="2">Situação</th>
    </tr><tr>
      <th>1ºB</th><th>2ºB</th><th>3ºB</th><th>4ºB</th>
      <th>1ºB</th><th>2ºB</th><th>3ºB</th><th>4ºB</th>
    </tr></thead><tbody>`;

  lista.forEach((a,i)=>{
    let somLp=0, somRed=0, nBim=0;
    let rowLp='', rowRed='';
    [1,2,3,4].forEach(bim=>{
      const b=a.bimestres[bim]; if(!b) { rowLp+='<td>-</td>'; rowRed+='<td>-</td>'; return; }
      _syncBimestreRefs(b);
      const m1=parseFloat(b.media_lp)||0, m2=parseFloat(b.media_red)||0;
      rowLp+=`<td>${m1.toFixed(1)}</td>`;
      rowRed+=`<td>${m2.toFixed(1)}</td>`;
      somLp+=m1; somRed+=m2; nBim++;
    });
    const avgLp=nBim?somLp/nBim:0, avgRed=nBim?somRed/nBim:0;
    const avg=(avgLp+avgRed)/2;
    const freq=calcFreqAluno(a.id,bimestreAtual);
    const sit=avg>=5?(avg>=7?'Aprovado':'Recuperação'):'Reprovado';
    const sitCls=sit==='Aprovado'?'sit-ap':(sit==='Recuperação'?'sit-rec':'sit-rep');
    html+=`<tr><td>${i+1}</td><td style="text-align:left;">${escHTML(a.nome)}</td>${rowLp}${rowRed}<td>${freq.pct.toFixed(0)}%</td><td class="${sitCls}">${sit}</td></tr>`;
  });
  html+=`</tbody></table>
    <div class="ata-actions">
      <button style="background:#0ea5e9;color:#fff;" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
      <button style="background:#475569;color:#fff;" onclick="document.getElementById('ataOverlay').remove();">Fechar</button>
    </div>
  </div></div>`;
  const old=document.getElementById('ataOverlay'); if(old)old.remove();
  document.body.insertAdjacentHTML('beforeend',html);
}

// ================================================================
// F3: REGISTRO DE AULA INTEGRADO AO CRONOGRAMA
// ================================================================
function getRegistrosAulaPorData(turma, bimestre){
  const result={};
  Object.keys(window.__sgpFrequencia||{}).forEach(key=>{
    const parts=key.split('|');
    if(parts[0]===turma && parseInt(parts[1])===bimestre){
      const meta=(window.__sgpFrequencia[key]||{})._meta;
      if(meta && meta.registroAula){
        result[parts[2]]={registro:meta.registroAula, qtdAulas:meta.qtdAulas||'1', disciplina:meta.disciplina||''};
      }
    }
  });
  return result;
}

// Hook into renderizarAulas to show linked registro
try{
  const __origRenderAulas=renderizarAulas;
  renderizarAulas=function(){
    __origRenderAulas();
    if(filtroTurma==='Todas') return;
    const registros=getRegistrosAulaPorData(filtroTurma, bimestreAtual);
    // Append registro info to aula items that match dates
    document.querySelectorAll('.aula-item, .aula-row').forEach(el=>{
      const dataEl=el.querySelector('.aula-data, [data-date]');
      const date=dataEl?(dataEl.value||dataEl.dataset.date||dataEl.textContent.trim()):'';
      if(!date) return;
      // Try matching ISO format
      const isoDate=date.length===10?date:null;
      if(isoDate && registros[isoDate] && !el.querySelector('.registro-linked')){
        const tag=document.createElement('div');
        tag.className='registro-linked';
        tag.style.cssText='font-size:.78rem;color:#0369a1;background:#e0f2fe;padding:3px 8px;border-radius:4px;margin-top:4px;';
        tag.innerHTML=`<i class="fas fa-book"></i> ${escHTML(registros[isoDate].registro.substring(0,80))}${registros[isoDate].registro.length>80?'...':''}`;
        el.appendChild(tag);
      }
    });
  };
}catch(_){}

// V13 calendar hook removed — registro indicators now integrated into renderizarCalendario

// ================================================================
// F4: CONTROLE DE ENTREGAS DE ATIVIDADES
// ================================================================
// Data: window.__sgpEntregas = { "turma|bimestre": { atividades: [{id,nome}], entregas: {alunoId: {atividadeId: true/false}} } }
window.__sgpEntregas = {};
function __loadEntregas(){ try{ const r=localStorage.getItem('sgp_entregas'); if(r) window.__sgpEntregas=JSON.parse(r)||{}; }catch(_){} }
function __saveEntregas(){ try{ __safeLSSet('sgp_entregas',JSON.stringify(window.__sgpEntregas)); try{__idbSaveState();}catch(_){} }catch(_){} }
try{__loadEntregas();}catch(_){}

function abrirControleEntregas(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma.","error");
  let overlay=document.getElementById('modalEntregas');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='modalEntregas';
    overlay.className='modal-overlay';
    overlay.innerHTML=`<div class="modal-box" style="max-width:950px;max-height:85vh;overflow-y:auto;">
      <h2><i class="fas fa-list-check"></i> Controle de Entregas — <span id="entTurmaLabel"></span></h2>
      <div class="ativ-add-row">
        <input type="text" id="entNomeAtiv" placeholder="Nome da atividade (ex: Trabalho Cap.3)">
        <button class="btn-primary" onclick="entAdicionarAtividade()"><i class="fas fa-plus"></i> Adicionar</button>
      </div>
      <div id="entTableContainer" class="ativ-manager"></div>
      <div style="text-align:right;margin-top:12px;">
        <button data-onclick="fecharModais()" style="padding:8px 15px;border:none;background:transparent;cursor:pointer;">Fechar</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
  }
  document.getElementById('entTurmaLabel').textContent=`${filtroTurma} — ${bimestreAtual}º Bim`;
  overlay.style.display='flex';
  renderEntregas();
}

function _entKey(){ return `${filtroTurma}|${bimestreAtual}`; }
function _entData(){ const k=_entKey(); if(!window.__sgpEntregas[k]) window.__sgpEntregas[k]={atividades:[],entregas:{}}; return window.__sgpEntregas[k]; }

function entAdicionarAtividade(){
  const inp=document.getElementById('entNomeAtiv');
  const nome=(inp.value||'').trim();
  if(!nome) return showToast("Digite o nome da atividade.","error");
  const d=_entData();
  d.atividades.push({id:'at_'+Date.now(), nome});
  inp.value='';
  __saveEntregas(); renderEntregas();
  __auditLog(`Atividade "${nome}" adicionada em ${filtroTurma}, ${bimestreAtual}ºBim`);
}

function entRemoverAtividade(atId){
  if(!confirm("Remover esta atividade e todos os registros de entrega?")) return;
  const d=_entData();
  d.atividades=d.atividades.filter(a=>a.id!==atId);
  Object.keys(d.entregas).forEach(alId=>{ delete d.entregas[alId][atId]; });
  __saveEntregas(); renderEntregas();
}

function entToggle(alunoId, atId){
  const d=_entData();
  if(!d.entregas[alunoId]) d.entregas[alunoId]={};
  d.entregas[alunoId][atId]=!d.entregas[alunoId][atId];
  __saveEntregas(); renderEntregas();
}

function renderEntregas(){
  const d=_entData();
  const ativs=d.atividades||[];
  const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  if(!ativs.length){ document.getElementById('entTableContainer').innerHTML='<p style="color:#64748b;text-align:center;">Nenhuma atividade cadastrada. Use o campo acima para adicionar.</p>'; return; }

  let html=`<table class="ativ-check-table"><thead><tr><th style="text-align:left;">Aluno</th>`;
  ativs.forEach(at=>{ html+=`<th>${escHTML(at.nome)} <button class="ativ-del" onclick="entRemoverAtividade('${at.id}')" title="Remover">&times;</button></th>`; });
  html+=`<th>%</th></tr></thead><tbody>`;
  lista.forEach(a=>{
    const ent=d.entregas[a.id]||{};
    let done=0;
    html+=`<tr><td>${escHTML(a.nome)}</td>`;
    ativs.forEach(at=>{
      const checked=!!ent[at.id];
      if(checked) done++;
      html+=`<td><input type="checkbox" class="ativ-chk" ${checked?'checked':''} onchange="entToggle('${a.id}','${at.id}')"></td>`;
    });
    const pct=ativs.length?(done/ativs.length*100):0;
    const cls=pct>=75?'good':(pct>=50?'warn':'danger');
    html+=`<td><span class="ativ-pct freq-pct ${cls}">${pct.toFixed(0)}%</span></td></tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById('entTableContainer').innerHTML=html;
}

// ================================================================
// F5: MINI CHART.JS OFFLINE — EXPAND TO BAR/DOUGHNUT
// ================================================================
(function(){
  if(typeof window.__SGP_Chart !== 'function') return;
  const OrigChart = window.__SGP_Chart;
  // Extend the mini chart to handle bar and doughnut when real Chart.js is absent
  const _miniBarDoughnut = function(ctx, cfg){
    const canvas = ctx.canvas || ctx;
    const c = canvas.getContext ? canvas.getContext('2d') : ctx;
    // garante tamanho (similar ao miniChart de linha)
    const w = canvas.clientWidth || canvas.width || 600;
    const h = canvas.clientHeight || canvas.height || 240;
    if(canvas.width !== w) canvas.width = w;
    if(canvas.height !== h) canvas.height = h;
    const W = canvas.width, H = canvas.height;
    const type = cfg.type || 'line';
    const ds = cfg.data?.datasets?.[0];
    if(!ds) return;
    const data = ds.data || [];
    const colors = ds.backgroundColor || [];

    if(type === 'bar'){
      const max = Math.max(...data, 1);
      const barW = Math.floor(W / (data.length * 1.5 + 0.5));
      const gap = Math.floor(barW * 0.5);
      c.clearRect(0,0,W,H);
      data.forEach((v,i)=>{
        const bh = (v/max) * (H - 20);
        const x = gap + i * (barW + gap);
        c.fillStyle = Array.isArray(colors) ? (colors[i]||((getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#2563eb').trim())) : colors;
        c.fillRect(x, H - bh - 10, barW, bh);
        c.fillStyle = '#64748b'; c.font = '9px sans-serif'; c.textAlign = 'center';
        c.fillText(v, x + barW/2, H - bh - 14);
      });
    } else if(type === 'doughnut' || type === 'pie'){
      const total = data.reduce((s,v)=>s+v,0);
      if(!total) return;
      const cx=W/2, cy=H/2, r=Math.min(W,H)/2 - 10;
      const inner = type==='doughnut' ? r*0.55 : 0;
      let startAngle = -Math.PI/2;
      c.clearRect(0,0,W,H);
      data.forEach((v,i)=>{
        const slice = (v/total)*Math.PI*2;
        c.beginPath();
        c.moveTo(cx + inner*Math.cos(startAngle), cy + inner*Math.sin(startAngle));
        c.arc(cx,cy,r,startAngle,startAngle+slice);
        c.arc(cx,cy,inner,startAngle+slice,startAngle,true);
        c.closePath();
        c.fillStyle = Array.isArray(colors)?(colors[i]||((getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#2563eb').trim())):colors;
        c.fill();
        startAngle+=slice;
      });
    } else {
      // fallback to original line chart
      return null; // signal to use original
    }
    return {destroy:function(){}};
  };

  // Only patch if real Chart.js didn't load
  if(typeof Chart === 'undefined' || Chart === OrigChart){
    window.Chart = function(ctx, cfg){
      const t=cfg.type||'line';
      if(t==='bar'||t==='doughnut'||t==='pie'){
        return _miniBarDoughnut(ctx, cfg);
      }
      return new OrigChart(ctx, cfg);
    };
    window.Chart.prototype = OrigChart.prototype;
  }
})();

// ================================================================
// F6: ACCESSIBILITY (a11y)
// ================================================================
(function(){
  // Add role=dialog to all modals
  document.querySelectorAll('.modal-overlay').forEach(m=>{ m.setAttribute('role','dialog'); m.setAttribute('aria-modal','true'); });
  // Add aria-labels to icon-only buttons
  document.querySelectorAll('.btn-tool, .btn-view, .btn-blitz, .freq-btn').forEach(btn=>{
    if(!btn.getAttribute('aria-label')){
      const title=btn.getAttribute('title')||btn.textContent.trim();
      if(title) btn.setAttribute('aria-label', title);
    }
  });
  // Make cards focusable — [CONSOLIDATED] now done natively in renderizarGrid template
  // Kept here only for cards that might be created by other code paths
  document.querySelectorAll('.card-aluno:not([tabindex])').forEach(card=>{
    card.setAttribute('tabindex','0');
  });
  // Observe DOM for new modals/buttons
  const obs=new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(n=>{
        if(n.nodeType!==1) return;
        if(n.classList?.contains('modal-overlay')){ n.setAttribute('role','dialog'); n.setAttribute('aria-modal','true'); }
        n.querySelectorAll?.('.btn-tool,.btn-view').forEach(btn=>{
          if(!btn.getAttribute('aria-label')){
            const t=btn.getAttribute('title')||btn.textContent.trim();
            if(t) btn.setAttribute('aria-label',t);
          }
        });
      });
    });
  });
  obs.observe(document.body, {childList:true, subtree:true});
})();

// ================================================================
// F7: THEME PERSISTENCE & CUSTOMIZATION
// ================================================================
(function(){
  // Persist dark mode
  try{
    const saved=localStorage.getItem('sgp_darkmode');
    if(saved==='1') document.body.classList.add('dark-mode');
  }catch(_){}

  // Persist accent color
  try{
    const accent=localStorage.getItem('sgp_accent');
    if(accent) document.documentElement.style.setProperty('--primary', accent);
  }catch(_){}

  // Persist font size
  try{
    const fs=localStorage.getItem('sgp_fontsize');
    if(fs) document.documentElement.style.fontSize=fs+'px';
  }catch(_){}

  // Override toggleDarkMode to persist
  const __origToggleDark=toggleDarkMode;
  toggleDarkMode=function(){
    __origToggleDark();
    try{ __safeLSSet('sgp_darkmode', document.body.classList.contains('dark-mode')?'1':'0'); }catch(_){}
  };
})();

function setAccentColor(color){
  document.documentElement.style.setProperty('--primary', color);
  try{ __safeLSSet('sgp_accent', color); }catch(_){}
  showToast("Cor alterada!");
}

function adjustFontSize(delta){
  const current=parseFloat(getComputedStyle(document.documentElement).fontSize)||16;
  const newSize=Math.max(12, Math.min(22, current+delta));
  document.documentElement.style.fontSize=newSize+'px';
  try{ __safeLSSet('sgp_fontsize', newSize); }catch(_){}
}

// ================================================================
// F8: UNIVERSAL SEARCH
// ================================================================
(function(){
  const searchInput=document.getElementById('searchGlobal');
  if(!searchInput) return;

  let panel=document.getElementById('searchResultsPanel');
  if(!panel){
    panel=document.createElement('div');
    panel.id='searchResultsPanel';
    panel.className='search-results-panel';
    searchInput.parentElement.appendChild(panel);
  }

  searchInput.addEventListener('input', function(){
    clearTimeout(window.__uniSearchTimer);
    window.__uniSearchTimer=setTimeout(()=> universalSearch(searchInput.value), 250);
  });

  searchInput.addEventListener('focus', function(){
    if(panel.innerHTML.trim() && searchInput.value.trim().length>=2) panel.classList.add('open');
  });

  document.addEventListener('click', function(e){
    if(!searchInput.contains(e.target) && !panel.contains(e.target)) panel.classList.remove('open');
  });
})();

function universalSearch(query){
  const panel=document.getElementById('searchResultsPanel');
  if(!panel) return;
  const q=(query||'').toLowerCase().trim();
  if(q.length<2){ panel.classList.remove('open'); panel.innerHTML=''; return; }

  const results=[];

  // Search alunos
  alunos.forEach(a=>{
    if((a.nome||'').toLowerCase().includes(q)){
      results.push({type:'aluno', label:a.nome, sub:`Turma: ${a.turma}`, action:`selTurma('${a.turma}')`});
    }
  });

  // Search aulas
  (aulas||[]).forEach(a=>{
    if((a.tema||'').toLowerCase().includes(q) || (a.bncc||'').toLowerCase().includes(q)){
      results.push({type:'aula', label:a.tema||'Aula', sub:`${a.turma} — ${a.bimestre||'?'}ºBim`, action:`mudarVisao('aulas')`});
    }
  });

  // Search planner
  (plannerTasks||[]).forEach(t=>{
    if((t.title||'').toLowerCase().includes(q) || (t.notes||'').toLowerCase().includes(q)){
      results.push({type:'planner', label:t.title||'Tarefa', sub:t.date||'Sem data', action:`abrirPlanner()`});
    }
  });

  // Search registros de chamada
  Object.keys(window.__sgpFrequencia||{}).forEach(key=>{
    const meta=(window.__sgpFrequencia[key]||{})._meta;
    if(meta && meta.registroAula && meta.registroAula.toLowerCase().includes(q)){
      const parts=key.split('|');
      const discTag = meta.disciplina ? `[${meta.disciplina}] ` : '';
      results.push({type:'chamada', label:discTag+meta.registroAula.substring(0,60), sub:`${parts[0]} — ${parts[2]}`, action:`abrirFrequencia()`});
    }
  });

  if(!results.length){
    panel.innerHTML='<div style="padding:12px;color:#64748b;text-align:center;font-size:.85rem;">Nenhum resultado encontrado.</div>';
    panel.classList.add('open');
    return;
  }

  // Group by type
  const grouped={aluno:[],aula:[],planner:[],chamada:[]};
  results.slice(0,30).forEach(r=>{ if(grouped[r.type]) grouped[r.type].push(r); });
  const typeNames={aluno:'Alunos',aula:'Aulas/Cronograma',planner:'Planner',chamada:'Registros de Chamada'};

  let html='';
  Object.keys(grouped).forEach(type=>{
    const items=grouped[type];
    if(!items.length) return;
    html+=`<div class="sr-group-title">${typeNames[type]} (${items.length})</div>`;
    items.forEach(r=>{
      html+=`<div class="sr-item" onclick="${r.action};document.getElementById('searchResultsPanel').classList.remove('open');">
        <span class="sr-type t-${r.type}">${typeNames[type].split('/')[0]}</span>
        <span style="flex:1;">${escHTML(r.label)}</span>
        <span style="font-size:.72rem;color:#94a3b8;">${escHTML(r.sub)}</span>
      </div>`;
    });
  });
  panel.innerHTML=html;
  panel.classList.add('open');
}

// ================================================================
// F9: SPARKLINE PER STUDENT
// ================================================================
function drawSparkline(canvas, values, w, h){
  if(!canvas) return;
  canvas.width=w||80; canvas.height=h||28;
  const c=canvas.getContext('2d');
  const max=10, min=0;
  const padding=2;
  const pW=canvas.width-padding*2, pH=canvas.height-padding*2;

  c.clearRect(0,0,canvas.width,canvas.height);
  // background guide line at 5
  c.strokeStyle='rgba(148,163,184,.3)'; c.lineWidth=1; c.setLineDash([2,2]);
  const y5=padding + pH - ((5-min)/(max-min))*pH;
  c.beginPath(); c.moveTo(padding,y5); c.lineTo(padding+pW,y5); c.stroke();
  c.setLineDash([]);

  if(values.length<2) return;
  const step=pW/(values.length-1);
  // Gradient
  const grad=c.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0,'rgba(14,165,233,.15)'); grad.addColorStop(1,'rgba(14,165,233,0)');

  // Fill
  c.beginPath();
  c.moveTo(padding, padding+pH);
  values.forEach((v,i)=>{
    const x=padding+i*step;
    const y=padding+pH-((Math.min(10,Math.max(0,v))-min)/(max-min))*pH;
    c.lineTo(x,y);
  });
  c.lineTo(padding+(values.length-1)*step, padding+pH);
  c.closePath(); c.fillStyle=grad; c.fill();

  // Line
  c.beginPath();
  c.strokeStyle='#0ea5e9'; c.lineWidth=2; c.lineJoin='round';
  values.forEach((v,i)=>{
    const x=padding+i*step;
    const y=padding+pH-((Math.min(10,Math.max(0,v))-min)/(max-min))*pH;
    if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
  });
  c.stroke();

  // Dots
  values.forEach((v,i)=>{
    const x=padding+i*step;
    const y=padding+pH-((Math.min(10,Math.max(0,v))-min)/(max-min))*pH;
    c.beginPath(); c.arc(x,y,2.5,0,Math.PI*2);
    c.fillStyle=v>=7?'#16a34a':(v>=5?'#f59e0b':'#dc2626'); c.fill();
  });
}

// [CONSOLIDATED] Sparklines are now rendered natively inside renderizarGrid.
// The drawSparkline function is still used but called directly from the main render loop.

// ================================================================
// F10: UNDO/REDO GLOBAL
// ================================================================
const __UNDO_STACK=[];
const __REDO_STACK=[];
const __UNDO_MAX=30;

function __undoPushState(label){
  try{
    const snap=JSON.stringify(__buildAtomicCoreState());
    __UNDO_STACK.push({label:label||'alteração', state:snap, ts:Date.now()});
    if(__UNDO_STACK.length>__UNDO_MAX) __UNDO_STACK.shift();
    __REDO_STACK.length=0; // clear redo on new action
  }catch(_){}
}

let __undoRestoring=false;
function __undoRestore(snap){
  try{
    __undoRestoring=true;
    const core=JSON.parse(snap);
    if(!core){ __undoRestoring=false; return false; }
    turmas=core.turmas||[];
    alunos=core.alunos||[];
    aulas=core.aulas||[];
    planosSemana=core.planosSemana||{};
    if(core.config) config=core.config;
    if(core.layouts) layouts=core.layouts;
    if(core.correcaoProvas && typeof core.correcaoProvas === 'object' && !Array.isArray(core.correcaoProvas)){
      correcaoProvas = core.correcaoProvas;
      try{ corSave(); }catch(_){}
    }
    salvarDadosLocal();
    garantirEstruturaNova();
    renderizarMenu(); renderizarVisao();
    __undoRestoring=false;
    return true;
  }catch(_){ __undoRestoring=false; return false; }
}

function undo(){
  if(!__UNDO_STACK.length) return showToast("Nada para desfazer.","warning");
  const current=JSON.stringify(__buildAtomicCoreState());
  __REDO_STACK.push({label:'redo', state:current, ts:Date.now()});
  const entry=__UNDO_STACK.pop();
  if(__undoRestore(entry.state)){
    showToast(`Desfeito: ${entry.label}`);
  }
}

function redo(){
  if(!__REDO_STACK.length) return showToast("Nada para refazer.","warning");
  const current=JSON.stringify(__buildAtomicCoreState());
  __UNDO_STACK.push({label:'redo', state:current, ts:Date.now()});
  const entry=__REDO_STACK.pop();
  if(__undoRestore(entry.state)){
    showToast("Refeito!");
  }
}

// Hook into salvarDadosLocal to push undo states
const __origSave2=salvarDadosLocal;
let __undoSaveDebounce=0;
salvarDadosLocal=function(){
  // Debounce undo snapshots (max 1 per 3 seconds), skip during restore
  const now=Date.now();
  if(!__undoRestoring && now - __undoSaveDebounce > 3000){
    __undoPushState('alteração');
    __undoSaveDebounce=now;
  }
  __origSave2();
};

// Keyboard shortcuts Ctrl+Z / Ctrl+Y
document.addEventListener('keydown', function(e){
  if((e.ctrlKey||e.metaKey) && e.key==='z' && !e.shiftKey){
    const tag=(document.activeElement?.tagName||'').toUpperCase();
    if(tag==='INPUT'||tag==='TEXTAREA') return; // let native undo work
    e.preventDefault(); undo();
  }
  if((e.ctrlKey||e.metaKey) && (e.key==='y' || (e.key==='z' && e.shiftKey))){
    const tag=(document.activeElement?.tagName||'').toUpperCase();
    if(tag==='INPUT'||tag==='TEXTAREA') return;
    e.preventDefault(); redo();
  }
});

// ================================================================
// F11: XLSX EXPORT (SheetJS-like pure JS)
// ================================================================
function exportarXLSX(){
  // Generate a real .xlsx-compatible file using XML spreadsheet format
  const lista=getAlunosFiltrados();
  if(!lista.length) return showToast("Sem dados para exportar.","error");

  const d1=getDiscById(config.slot1), d2=getDiscById(config.slot2);
  const nm1=d1?.nome||'Mat1', nm2=d2?.nome||'Mat2';
  const avs1=(d1?.avaliacoes||[]), avs2=(d2?.avaliacoes||[]);

  // Build XML Spreadsheet (Excel 2003 XML format — universally supported)
  let xml=`<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<Styles>
  <Style ss:ID="hdr"><Font ss:Bold="1" ss:Color="#FFFFFF" ss:Size="10"/><Interior ss:Color="#0EA5E9" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center"/></Style>
  <Style ss:ID="green"><Interior ss:Color="#DCFCE7" ss:Pattern="Solid"/><Font ss:Bold="1"/></Style>
  <Style ss:ID="yellow"><Interior ss:Color="#FEF9C3" ss:Pattern="Solid"/><Font ss:Bold="1"/></Style>
  <Style ss:ID="red"><Interior ss:Color="#FEE2E2" ss:Pattern="Solid"/><Font ss:Bold="1"/></Style>
  <Style ss:ID="num"><NumberFormat ss:Format="0.0"/></Style>
</Styles>
<Worksheet ss:Name="${escHTML(filtroTurma||'Dados')}">
<Table>`;

  // Header row
  xml+=`<Row>`;
  const cols=['#','Nome','Turma'];
  [1,2,3,4].forEach(b=>{ cols.push(`${nm1} ${b}ºB`); });
  [1,2,3,4].forEach(b=>{ cols.push(`${nm2} ${b}ºB`); });
  cols.push('Freq%','Situação');
  cols.forEach(c=>{ xml+=`<Cell ss:StyleID="hdr"><Data ss:Type="String">${escHTML(c)}</Data></Cell>`; });
  xml+=`</Row>`;

  // Data rows
  lista.forEach((a,i)=>{
    xml+=`<Row>`;
    xml+=`<Cell><Data ss:Type="Number">${i+1}</Data></Cell>`;
    xml+=`<Cell><Data ss:Type="String">${escHTML(a.nome)}</Data></Cell>`;
    xml+=`<Cell><Data ss:Type="String">${escHTML(a.turma)}</Data></Cell>`;

    let somLp=0, somRed=0, nBim=0;
    [1,2,3,4].forEach(bim=>{
      const b=a.bimestres[bim];
      if(!b){ xml+=`<Cell><Data ss:Type="Number">0</Data></Cell>`; return; }
      _syncBimestreRefs(b);
      const m=parseFloat(b.media_lp)||0;
      const sty=m>=7?'green':(m>=5?'yellow':'red');
      xml+=`<Cell ss:StyleID="${sty}"><Data ss:Type="Number">${m.toFixed(1)}</Data></Cell>`;
      somLp+=m; nBim++;
    });
    [1,2,3,4].forEach(bim=>{
      const b=a.bimestres[bim];
      if(!b){ xml+=`<Cell><Data ss:Type="Number">0</Data></Cell>`; return; }
      _syncBimestreRefs(b);
      const m=parseFloat(b.media_red)||0;
      const sty=m>=7?'green':(m>=5?'yellow':'red');
      xml+=`<Cell ss:StyleID="${sty}"><Data ss:Type="Number">${m.toFixed(1)}</Data></Cell>`;
      somRed+=m;
    });

    const freq=calcFreqAluno(a.id,bimestreAtual);
    xml+=`<Cell><Data ss:Type="Number">${freq.pct.toFixed(1)}</Data></Cell>`;
    const avg=nBim?(somLp+somRed)/(nBim*2):0;
    const sit=avg>=5?(avg>=7?'Aprovado':'Recuperação'):'Reprovado';
    const sitStyle=sit==='Aprovado'?'green':(sit==='Recuperação'?'yellow':'red');
    xml+=`<Cell ss:StyleID="${sitStyle}"><Data ss:Type="String">${sit}</Data></Cell>`;
    xml+=`</Row>`;
  });

  xml+=`</Table></Worksheet></Workbook>`;

  const blob=new Blob([xml],{type:'application/vnd.ms-excel'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');
  link.href=url;
  link.download=`SGP_${filtroTurma||'Todos'}_Bim${bimestreAtual}.xls`;
  link.click();
  URL.revokeObjectURL(url);
  showToast("Planilha Excel exportada!");
}

// Replace the export button to offer both CSV and XLSX
try{
  const __origExportCSV=exportarCSV;
  exportarCSV=function(){
    // Show choice
    const choice=confirm("Exportar como XLSX (Excel formatado)?\n\nOK = Excel (.xls)\nCancelar = CSV simples (.csv)");
    if(choice) exportarXLSX();
    else __origExportCSV();
  };
}catch(_){}

// ================================================================
// F12: SIDEBAR BADGES
// ================================================================
function updateSidebarBadges(){
  try{
    document.querySelectorAll('.turma-item').forEach(item=>{
      const raw=item.getAttribute('data-turma')||'';
      const nome=decodeURIComponent(raw);
      if(!nome || nome==='Todas') return;
      // Remove old badge
      const old=item.querySelector('.turma-badge');
      if(old) old.remove();

      const count=alunos.filter(a=>a.turma===nome).length;
      const risco=alunos.filter(a=>{
        if(a.turma!==nome) return false;
        const b=a.bimestres[bimestreAtual]; if(!b) return false;
        return parseFloat(b.media_lp)<5 || parseFloat(b.media_red)<5;
      }).length;

      const badge=document.createElement('span');
      badge.className=`turma-badge ${risco>0?'risco':'normal'}`;
      badge.textContent=risco>0?`${count} (${risco}⚠)`:count;
      badge.title=risco>0?`${count} alunos, ${risco} em risco`:`${count} alunos`;
      item.appendChild(badge);
    });
  }catch(_){}
}

// Hook into renderizarMenu
try{
  const __origRenderMenu=renderizarMenu;
  renderizarMenu=function(){
    __origRenderMenu();
    setTimeout(updateSidebarBadges, 50);
  };
}catch(_){}

// Also update on bimestre change
try{
  const __origMudarBimestre=mudarBimestre;
  mudarBimestre=function(n){
    __origMudarBimestre(n);
    setTimeout(updateSidebarBadges, 100);
  };
}catch(_){}

// Initial run
setTimeout(updateSidebarBadges, 500);

// ================================================================
// F13: NOTE INPUT VALIDATION
// ================================================================
document.addEventListener('input', function(e){
  const el=e.target;
  if(!el || el.tagName!=='INPUT' || el.type!=='number') return;
  // Check if it's a nota field
  const name=(el.name||'').toLowerCase();
  const cls=(el.className||'').toLowerCase();
  const isNota=name.includes('nota')||name.includes('a1')||name.includes('a2')||name.includes('a3')||name.includes('a4')||name.includes('a5')||name.includes('rec')||cls.includes('nota')||el.dataset.nota;

  if(!isNota && !el.closest('.massa-row, .edit-nota, [data-nota-field]')) return;

  const val=parseFloat(el.value);
  if(el.value!=='' && (isNaN(val) || val<0 || val>10)){
    el.classList.add('nota-invalid');
    // Show tooltip
    let tip=el.parentElement?.querySelector('.nota-tooltip');
    if(!tip){
      tip=document.createElement('div');
      tip.className='nota-tooltip';
      tip.textContent='Nota deve ser entre 0 e 10';
      el.parentElement.style.position='relative';
      el.parentElement.appendChild(tip);
    }
    setTimeout(()=>{ el.classList.remove('nota-invalid'); tip?.remove(); }, 2000);
  } else {
    el.classList.remove('nota-invalid');
    const tip=el.parentElement?.querySelector('.nota-tooltip');
    if(tip) tip.remove();
  }
}, true);

// ================================================================
// F14: AUDIT TRAIL
// ================================================================
window.__sgpAuditLog = [];

function __loadAuditLog(){
  try{ const r=localStorage.getItem('sgp_audit_log'); if(r) window.__sgpAuditLog=JSON.parse(r)||[]; }catch(_){ window.__sgpAuditLog=[]; }
}
function __saveAuditLog(){
  try{
    if(window.__sgpAuditLog.length>500) window.__sgpAuditLog=window.__sgpAuditLog.slice(-500);
    __safeLSSet('sgp_audit_log', JSON.stringify(window.__sgpAuditLog));
  }catch(_){}
}
try{__loadAuditLog();}catch(_){}

function __auditLog(msg){
  try{
    window.__sgpAuditLog.push({ts:Date.now(), msg:String(msg)});
    __saveAuditLog();
  }catch(_){}
}

function abrirAuditTrail(){
  let overlay=document.getElementById('modalAudit');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='modalAudit';
    overlay.className='modal-overlay';
    overlay.innerHTML=`<div class="modal-box" style="max-width:700px;max-height:80vh;overflow-y:auto;">
      <h2><i class="fas fa-clock"></i> Histórico de Alterações</h2>
      <div id="auditContent" class="audit-panel"></div>
      <div style="text-align:right;margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button onclick="window.__sgpAuditLog=[];__saveAuditLog();renderAuditTrail();showToast('Histórico limpo.');" style="padding:6px 12px;border:1px solid #dc2626;color:#dc2626;background:none;border-radius:6px;cursor:pointer;font-size:.82rem;">Limpar</button>
        <button data-onclick="fecharModais()" style="padding:8px 15px;border:none;background:transparent;cursor:pointer;">Fechar</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers();
  }
  overlay.style.display='flex';
  renderAuditTrail();
}

function renderAuditTrail(){
  const el=document.getElementById('auditContent');
  if(!el) return;
  const logs=(window.__sgpAuditLog||[]).slice().reverse();
  if(!logs.length){ el.innerHTML='<p style="text-align:center;color:#64748b;">Nenhum registro ainda.</p>'; return; }
  el.innerHTML=logs.map(l=>{
    const d=new Date(l.ts);
    const ts=d.toLocaleDateString('pt-BR')+' '+d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    return `<div class="audit-entry"><span class="audit-ts">${ts}</span><span class="audit-msg">${escHTML(l.msg)}</span></div>`;
  }).join('');
}

// Hook nota changes into audit
document.addEventListener('change', function(e){
  const el=e.target;
  if(!el || el.tagName!=='INPUT' || el.type!=='number') return;
  if(!el.closest('.massa-row, .edit-nota, [data-nota-field]')) return;
  // Try to get student name context
  const row=el.closest('tr, .massa-row, .edit-nota');
  const nameEl=row?.querySelector('.aluno-nome, td:first-child, [data-nome]');
  const nome=nameEl?nameEl.textContent.trim():'(aluno)';
  const field=el.name||el.dataset.field||'nota';
  __auditLog(`${nome}: ${field} → ${el.value}`);
}, true);

// Log key events
try{
  const __origSalvarAlunos=salvarAlunos;
  salvarAlunos=function(){ __auditLog(`Cadastro de novos alunos em ${filtroTurma}`); __origSalvarAlunos(); };
}catch(_){}

// Include entregas, audit, ranking in backup — now handled directly in __collectBackupFiles

// Include entregas in __loadExtras
try{
  const __origLoadExtras2=__loadExtras;
  __loadExtras=function(){
    __origLoadExtras2();
    try{__loadEntregas();}catch(_){}
    try{__loadAuditLog();}catch(_){}
  };
}catch(_){}

// ================================================================
// V14 INIT: Run on load
// ================================================================
window.addEventListener('load', function(){
  setTimeout(()=>{
    try{ updateSidebarBadges(); }catch(_){}
    try{ updatePlannerBadge(); }catch(_){}
    try{ initSidebarMobile(); }catch(_){}
  }, 600);
});

// ================================================================
// V15 FEATURES
// ================================================================

// ================================================================
// F11: SIDEBAR TOGGLE
// ================================================================
function toggleSidebar(){
  const isMobile = window.innerWidth <= 980;
  if(isMobile){
    // Mobile: toggle drawer open/close
    document.body.classList.toggle('sidebar-open');
  } else {
    // Desktop: toggle sidebar hidden/visible
    document.body.classList.toggle('sidebar-hidden');
    try{ __safeLSSet('sgp_sidebar_hidden', document.body.classList.contains('sidebar-hidden')?'1':'0'); }catch(_){}
  }
}

function initSidebarMobile(){
  // Restore desktop sidebar state
  try{
    const saved=localStorage.getItem('sgp_sidebar_hidden');
    if(saved==='1' && window.innerWidth > 980) document.body.classList.add('sidebar-hidden');
  }catch(_){}
  // Mobile starts with drawer closed
  if(window.innerWidth <= 980){
    document.body.classList.remove('sidebar-open');
  }
  // Close drawer when clicking a turma on mobile
  document.querySelector('#listaTurmas')?.addEventListener('click', function(){
    if(window.innerWidth <= 980) setTimeout(()=>document.body.classList.remove('sidebar-open'), 150);
  });
}

// ================================================================
// F4: DIÁRIO DE CLASSE UNIFICADO
// ================================================================
function abrirDiarioClasse(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma.","error");

  const freq=window.__sgpFrequencia||{};
  // Collect all dates with data for this turma+bimestre
  const dates=[];
  Object.keys(freq).forEach(key=>{
    const p=key.split('|');
    if(p[0]===filtroTurma && parseInt(p[1])===bimestreAtual) dates.push(p[2]);
  });
  dates.sort().reverse();

  // Also collect aulas for this turma+bimestre
  const aulasMap={};
  (aulas||[]).filter(a=>a.turma===filtroTurma && a.bimestre===bimestreAtual).forEach(a=>{
    if(a.data) aulasMap[a.data]=a;
  });

  // Merge dates from aulas too
  Object.keys(aulasMap).forEach(d=>{ if(!dates.includes(d)) dates.push(d); });
  dates.sort().reverse();

  const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));

  let html=`<div class="diario-overlay" id="diarioOverlay" onclick="if(event.target===this)this.remove();">
  <div class="diario-container">
    <button style="position:absolute;top:10px;right:12px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;" onclick="document.getElementById('diarioOverlay').remove();">&times;</button>
    <div style="text-align:center;border-bottom:2px solid #1e293b;padding-bottom:8px;margin-bottom:10px;">
      <h2 style="margin:0;"><i class="fas fa-book-open"></i> Diário de Classe</h2>
      <p style="margin:2px 0;font-size:.88rem;color:#475569;">${escHTML(filtroTurma)} — ${bimestreAtual}º Bimestre</p>
    </div>`;

  if(!dates.length){
    html+=`<p style="text-align:center;color:#64748b;padding:30px;">Nenhum registro encontrado. Faça chamadas e cadastre aulas para ver o diário.</p>`;
  }

  dates.forEach(date=>{
    const key=`${filtroTurma}|${bimestreAtual}|${date}`;
    const registro=freq[key]||{};
    const meta=registro._meta||{};
    const aula=aulasMap[date]||{};
    const dObj=new Date(date+'T12:00:00');
    const dataFmt=dObj.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});

    // Count P/F/J
    let countP=0,countF=0,countJ=0;
    lista.forEach(a=>{
      const s=registro[a.id]; if(s==='P')countP++; else if(s==='F')countF++; else if(s==='J')countJ++;
    });

    html+=`<div class="diario-entry">
      <div class="diario-entry-header">
        <span>${dataFmt}${meta.disciplina ? ' — <span style="background:#e0f2fe;color:#0369a1;padding:1px 8px;border-radius:6px;font-size:.75rem;font-weight:700;"><i class="fas fa-book"></i> '+escHTML(meta.disciplina)+'</span>' : ''}</span>
        <span style="font-size:.78rem;color:#64748b;">${meta.qtdAulas||1} aula(s) | ${countP}P ${countF}F ${countJ}J</span>
      </div>
      <div class="diario-entry-body">
        <div class="diario-field">
          <label><i class="fas fa-book"></i> Conteúdo / Tema</label>
          <div>${aula.tema?escHTML(aula.tema):'<span style="color:#94a3b8;">—</span>'}</div>
          ${aula.bncc?`<div style="margin-top:3px;"><span style="background:#ede9fe;color:#7c3aed;padding:1px 6px;border-radius:4px;font-size:.72rem;">BNCC: ${escHTML(aula.bncc)}</span></div>`:''}
        </div>
        <div class="diario-field">
          <label><i class="fas fa-pen"></i> Registro de Aula</label>
          <div>${meta.registroAula?escHTML(meta.registroAula):'<span style="color:#94a3b8;">—</span>'}</div>
        </div>
        <div class="diario-field" style="grid-column:1/-1;">
          <label><i class="fas fa-users"></i> Chamada</label>
          <div class="diario-chamada-mini">`;
    lista.forEach(a=>{
      const s=registro[a.id]||'';
      if(s) html+=`<span class="${s}" title="${escHTML(a.nome)}">${s}</span>`;
    });
    html+=`</div></div></div></div>`;
  });

  html+=`<div style="text-align:center;margin-top:14px;display:flex;gap:8px;justify-content:center;">
      <button style="background:#7c3aed;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
      <button style="background:#475569;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;" onclick="document.getElementById('diarioOverlay').remove();">Fechar</button>
    </div>
  </div></div>`;

  const old=document.getElementById('diarioOverlay'); if(old)old.remove();
  document.body.insertAdjacentHTML('beforeend',html);
}

// ================================================================
// F10: DIÁRIO MENSAL IMPRIMÍVEL
// ================================================================
function abrirDiarioMensal(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma.","error");

  // Show month picker first
  const now=new Date();
  const meses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  let pickerHtml=`<div class="diario-overlay" id="mensalPicker" onclick="if(event.target===this)this.remove();">
  <div class="diario-container" style="max-width:400px;text-align:center;">
    <h3 style="margin:0 0 14px;"><i class="fas fa-calendar-check"></i> Diário Mensal — Escolha o período</h3>
    <div style="display:flex;gap:10px;justify-content:center;margin:12px 0;">
      <select id="mensalMes" style="padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:.95rem;flex:1;">`;
  meses.forEach((n,i)=>{ pickerHtml+=`<option value="${i}" ${i===now.getMonth()?'selected':''}>${n}</option>`; });
  pickerHtml+=`</select>
      <input type="number" id="mensalAno" value="${now.getFullYear()}" min="2020" max="2030" style="padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:.95rem;width:100px;">
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px;">
      <button onclick="gerarDiarioMensal()" style="background:#0d9488;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;"><i class="fas fa-check"></i> Gerar</button>
      <button onclick="document.getElementById('mensalPicker').remove();" style="background:#64748b;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;">Cancelar</button>
    </div>
  </div></div>`;
  const old=document.getElementById('mensalPicker'); if(old)old.remove();
  document.body.insertAdjacentHTML('beforeend', pickerHtml);
}

function gerarDiarioMensal(){
  const mSel=document.getElementById('mensalMes');
  const aSel=document.getElementById('mensalAno');
  if(!mSel||!aSel) return;
  const m=parseInt(mSel.value), y=parseInt(aSel.value);
  document.getElementById('mensalPicker')?.remove();
  if(isNaN(m)||isNaN(y)) return showToast("Dados inválidos.","error");

  const diasNoMes=new Date(y, m+1, 0).getDate();
  const lista=alunos.filter(a=>a.turma===filtroTurma).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
  const freq=window.__sgpFrequencia||{};
  const nomeMes=new Date(y,m,15).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  // Build lookup: date string -> registro
  const regMap={};
  Object.keys(freq).forEach(key=>{
    const p=key.split('|');
    if(p[0]===filtroTurma) regMap[p[2]]=freq[key];
  });

  // Find which days have data
  const diasComDados=[];
  for(let d=1;d<=diasNoMes;d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(regMap[ds]) diasComDados.push(d);
  }

  let html=`<div class="diario-overlay mensal-overlay-wrap" id="mensalOverlay" onclick="if(event.target===this)this.remove();">
  <div class="diario-container mensal-container-wrap" style="max-width:1200px;">
    <button style="position:absolute;top:10px;right:12px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;" onclick="document.getElementById('mensalOverlay').remove();">&times;</button>
    <div style="text-align:center;border-bottom:2px solid #1e293b;padding-bottom:8px;margin-bottom:10px;">
      <h2 style="margin:0;"><i class="fas fa-calendar-check"></i> Diário de Classe Mensal</h2>
      <p style="margin:2px 0;font-size:.88rem;color:#475569;">${escHTML(filtroTurma)} — ${nomeMes}</p>
    </div>
    <div style="overflow-x:auto;">
    <table class="mensal-table"><thead><tr>
      <th style="text-align:left;min-width:120px;">#</th>
      <th style="text-align:left;min-width:150px;">Nome</th>`;

  for(let d=1;d<=diasNoMes;d++){
    const dow=new Date(y,m,d).getDay();
    const isWeekend=dow===0||dow===6;
    html+=`<th style="${isWeekend?'background:#fef3c7;':''}font-size:.6rem;">${d}</th>`;
  }
  html+=`<th class="total">P</th><th class="total">F</th><th class="total">J</th><th class="total">%</th></tr></thead><tbody>`;

  // Day totals
  const dayTotals={}; for(let d=1;d<=diasNoMes;d++) dayTotals[d]={P:0,F:0,J:0};

  lista.forEach((a,i)=>{
    let tP=0,tF=0,tJ=0;
    html+=`<tr><td>${i+1}</td><td style="text-align:left;white-space:nowrap;">${escHTML(a.nome)}</td>`;
    for(let d=1;d<=diasNoMes;d++){
      const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const reg=regMap[ds];
      const s=reg?reg[a.id]:'';
      const dow=new Date(y,m,d).getDay();
      const isWeekend=dow===0||dow===6;
      if(s==='P'){tP++;dayTotals[d].P++;} else if(s==='F'){tF++;dayTotals[d].F++;} else if(s==='J'){tJ++;dayTotals[d].J++;}
      html+=`<td class="${s||''}" style="${isWeekend&&!s?'background:#fef3c7;':''}">${s||''}</td>`;
    }
    const total=tP+tF+tJ;
    const pct=total?(((tP+tJ)/total)*100):0;
    html+=`<td class="total">${tP}</td><td class="total">${tF}</td><td class="total">${tJ}</td>`;
    html+=`<td class="total" style="color:${pct>=75?'#16a34a':(pct>=50?'#f59e0b':'#dc2626')};">${pct.toFixed(0)}%</td></tr>`;
  });

  // Totals row
  html+=`<tr style="font-weight:700;background:#f1f5f9;"><td colspan="2">Totais do dia</td>`;
  for(let d=1;d<=diasNoMes;d++){
    const t=dayTotals[d];
    html+=`<td style="font-size:.55rem;">${t.P+t.F+t.J>0?(t.P+'P'):'—'}</td>`;
  }
  html+=`<td colspan="4"></td></tr>`;

  html+=`</tbody></table></div>
    <div style="text-align:center;margin-top:14px;display:flex;gap:8px;justify-content:center;">
      <button style="background:#0d9488;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
      <button style="background:#475569;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;" onclick="document.getElementById('mensalOverlay').remove();">Fechar</button>
    </div>
  </div></div>`;

  const old=document.getElementById('mensalOverlay'); if(old)old.remove();
  document.body.insertAdjacentHTML('beforeend',html);
}

// ================================================================
// F8: COMPARATIVO ENTRE TURMAS
// ================================================================
function renderComparativoTurmas(){
  if(filtroTurma!=='Todas' || !turmas.length) return '';

  const d1=getDiscById(config.slot1), d2=getDiscById(config.slot2);
  const nm1=d1?.nome||config.materia1||'Mat1', nm2=d2?.nome||config.materia2||'Mat2';

  let rows=[];
  turmas.forEach(t=>{
    const als=alunos.filter(a=>a.turma===t);
    if(!als.length) return;
    let somLp=0, somRed=0, n=0, risco=0, occTotal=0;
    als.forEach(a=>{
      const b=a.bimestres[bimestreAtual]; if(!b) return;
      _syncBimestreRefs(b);
      const m1=parseFloat(b.media_lp)||0, m2=parseFloat(b.media_red)||0;
      somLp+=m1; somRed+=m2; n++;
      if(m1<5||m2<5) risco++;
      occTotal+=(b.ocorrencias||[]).length;
    });
    const avgLp=n?somLp/n:0, avgRed=n?somRed/n:0;
    const avgGeral=(avgLp+avgRed)/2;
    // Frequency
    let freqSum=0;
    als.forEach(a=>{ freqSum+=calcFreqAluno(a.id,bimestreAtual).pct; });
    const avgFreq=n?freqSum/n:100;

    rows.push({turma:t, qtd:als.length, avgLp, avgRed, avgGeral, avgFreq, risco, pctRisco:n?(risco/n*100):0, occs:occTotal});
  });

  if(!rows.length) return '';

  // Sort by media geral desc
  rows.sort((a,b)=>b.avgGeral-a.avgGeral);

  let html=`<div style="margin-top:16px;"><h3 style="margin:0 0 8px;font-size:.95rem;"><i class="fas fa-chart-bar"></i> Comparativo entre Turmas — ${bimestreAtual}º Bimestre</h3>
  <div style="overflow-x:auto;">
  <table class="comp-turmas-table"><thead><tr>
    <th>Turma</th><th>Alunos</th><th>${escHTML(nm1)}</th><th>${escHTML(nm2)}</th><th>Geral</th>
    <th>Freq.</th><th>Em Risco</th><th>Ocorr.</th><th>Desempenho</th>
  </tr></thead><tbody>`;

  const maxGeral=Math.max(...rows.map(r=>r.avgGeral),1);
  rows.forEach(r=>{
    const cor=r.avgGeral>=7?'#16a34a':(r.avgGeral>=5?'#f59e0b':'#dc2626');
    const pctBar=(r.avgGeral/10*100).toFixed(0);
    html+=`<tr>
      <td>${escHTML(r.turma)}</td>
      <td>${r.qtd}</td>
      <td style="color:${r.avgLp>=5?'#16a34a':'#dc2626'};">${r.avgLp.toFixed(1)}</td>
      <td style="color:${r.avgRed>=5?'#16a34a':'#dc2626'};">${r.avgRed.toFixed(1)}</td>
      <td style="font-weight:700;color:${cor};">${r.avgGeral.toFixed(1)}</td>
      <td style="color:${r.avgFreq>=75?'#16a34a':'#dc2626'};">${r.avgFreq.toFixed(0)}%</td>
      <td style="color:${r.risco>0?'#dc2626':'#16a34a'};">${r.risco} (${r.pctRisco.toFixed(0)}%)</td>
      <td>${r.occs}</td>
      <td><div class="comp-turmas-bar"><div class="comp-turmas-bar-fill" style="width:${pctBar}%;background:${cor};"></div></div></td>
    </tr>`;
  });
  html+=`</tbody></table></div></div>`;
  return html;
}

// ================================================================
// F9: EVOLUÇÃO TEMPORAL DA TURMA
// ================================================================
function renderEvolucaoTurma(){
  if(filtroTurma==='Todas') return '';

  const als=alunos.filter(a=>a.turma===filtroTurma);
  if(!als.length) return '';

  const d1=getDiscById(config.slot1), d2=getDiscById(config.slot2);
  const nm1=d1?.nome||'Mat1', nm2=d2?.nome||'Mat2';

  const data1=[], data2=[], dataGeral=[];
  [1,2,3,4].forEach(bim=>{
    let s1=0,s2=0,n=0;
    als.forEach(a=>{
      const b=a.bimestres[bim]; if(!b) return;
      _syncBimestreRefs(b);
      s1+=parseFloat(b.media_lp)||0;
      s2+=parseFloat(b.media_red)||0;
      n++;
    });
    data1.push(n?s1/n:0);
    data2.push(n?s2/n:0);
    dataGeral.push(n?(s1+s2)/(n*2):0);
  });

  // Only show if at least 2 bimestres have data
  const hasData=dataGeral.filter(v=>v>0).length;
  if(hasData<2) return '';

  const trend=dataGeral[dataGeral.length-1]-dataGeral[0];
  const trendLabel=trend>0.3?'📈 Tendência positiva':(trend<-0.3?'📉 Tendência negativa':'➡️ Estável');
  const trendColor=trend>0.3?'#16a34a':(trend<-0.3?'#dc2626':'#64748b');

  let html=`<div class="dash-evo-chart">
    <h3 style="margin:0 0 6px;font-size:.92rem;display:flex;justify-content:space-between;align-items:center;">
      <span><i class="fas fa-chart-line"></i> Evolução da Turma — ${escHTML(filtroTurma)}</span>
      <span style="font-size:.78rem;color:${trendColor};font-weight:600;">${trendLabel}</span>
    </h3>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0;">`;

  [1,2,3,4].forEach((bim,i)=>{
    const g=dataGeral[i];
    const cor=g>=7?'#16a34a':(g>=5?'#f59e0b':'#dc2626');
    const bg=g>=7?'rgba(22,163,74,.08)':(g>=5?'rgba(245,158,11,.08)':'rgba(220,38,38,.08)');
    html+=`<div style="text-align:center;padding:10px;border-radius:8px;background:${bg};border:1px solid ${cor}22;">
      <div style="font-size:.72rem;color:#64748b;">${bim}º Bimestre</div>
      <div style="font-size:1.5rem;font-weight:800;color:${cor};">${g>0?g.toFixed(1):'—'}</div>
      <div style="font-size:.68rem;color:#94a3b8;">${escHTML(nm1)}: ${data1[i]>0?data1[i].toFixed(1):'—'} | ${escHTML(nm2)}: ${data2[i]>0?data2[i].toFixed(1):'—'}</div>
    </div>`;
  });

  html+=`</div>
    <canvas id="evoTurmaCanvas" width="500" height="120" style="width:100%;max-height:120px;"></canvas>
  </div>`;
  return html;
}

function drawEvoTurmaChart(){
  const canvas=document.getElementById('evoTurmaCanvas');
  if(!canvas) return;
  const als=alunos.filter(a=>a.turma===filtroTurma);
  if(!als.length) return;

  const vals=[];
  [1,2,3,4].forEach(bim=>{
    let s=0,n=0;
    als.forEach(a=>{
      const b=a.bimestres[bim]; if(!b) return;
      _syncBimestreRefs(b);
      s+=(parseFloat(b.media_lp)||0)+(parseFloat(b.media_red)||0);
      n++;
    });
    vals.push(n?s/(n*2):0);
  });

  const W=canvas.width=canvas.offsetWidth*2, H=canvas.height=240;
  const c=canvas.getContext('2d');
  const pad={t:20,b:30,l:40,r:20};
  const pW=W-pad.l-pad.r, pH=H-pad.t-pad.b;

  c.clearRect(0,0,W,H);

  // Grid lines
  c.strokeStyle='rgba(148,163,184,.15)'; c.lineWidth=1;
  [0,2,4,5,6,7,8,10].forEach(v=>{
    const y=pad.t+pH-(v/10)*pH;
    c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
    c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='right';
    c.fillText(v,pad.l-6,y+5);
  });

  // Danger zone (below 5)
  const y5=pad.t+pH-(5/10)*pH;
  c.fillStyle='rgba(220,38,38,.04)';
  c.fillRect(pad.l, y5, pW, pH-(5/10)*pH+pad.t);

  // Line
  const step=pW/3;
  const points=vals.map((v,i)=>({x:pad.l+i*step, y:pad.t+pH-(Math.max(0,Math.min(10,v))/10)*pH}));

  // Gradient fill
  const grad=c.createLinearGradient(0,pad.t,0,H-pad.b);
  grad.addColorStop(0,'rgba(14,165,233,.15)'); grad.addColorStop(1,'rgba(14,165,233,0)');
  c.beginPath(); c.moveTo(points[0].x, H-pad.b);
  points.forEach(p=>c.lineTo(p.x,p.y));
  c.lineTo(points[points.length-1].x, H-pad.b); c.closePath();
  c.fillStyle=grad; c.fill();

  // Line
  c.beginPath(); c.strokeStyle='#0ea5e9'; c.lineWidth=4; c.lineJoin='round';
  points.forEach((p,i)=>{ if(i===0) c.moveTo(p.x,p.y); else c.lineTo(p.x,p.y); });
  c.stroke();

  // Dots + labels
  points.forEach((p,i)=>{
    const v=vals[i];
    c.beginPath(); c.arc(p.x,p.y,8,0,Math.PI*2);
    c.fillStyle=v>=7?'#16a34a':(v>=5?'#f59e0b':'#dc2626'); c.fill();
    c.fillStyle='#fff'; c.font='bold 16px sans-serif'; c.textAlign='center';
    c.fillText(v>0?v.toFixed(1):'—',p.x,p.y+5);
    // Bimestre label
    c.fillStyle='#64748b'; c.font='18px sans-serif';
    c.fillText(`${i+1}ºB`,p.x,H-8);
  });
}

// ================================================================
// V16: ENHANCED DASHBOARD STATISTICS
// ================================================================

function __v16CalcStats(lista, slotId, notasKey, bim){
  const vals=[];
  lista.forEach(a=>{
    const b=a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    vals.push(clampNota(calcularMediaDisc(slotId, b[notasKey])));
  });
  if(!vals.length) return null;
  const sorted=[...vals].sort((a,b)=>a-b);
  const n=sorted.length;
  const sum=sorted.reduce((a,b)=>a+b,0);
  const mean=sum/n;
  const variance=sorted.reduce((a,v)=>a+Math.pow(v-mean,2),0)/n;
  const stdDev=Math.sqrt(variance);
  const median=n%2===0?(sorted[n/2-1]+sorted[n/2])/2:sorted[Math.floor(n/2)];
  const min=sorted[0], max=sorted[n-1];
  const cv=mean>0?(stdDev/mean*100):0;
  const abaixo5=sorted.filter(v=>v<5).length;
  const acima7=sorted.filter(v=>v>=7).length;
  const acima9=sorted.filter(v=>v>=9).length;
  return {vals,sorted,n,sum,mean,stdDev,median,min,max,cv,abaixo5,acima7,acima9,variance};
}

function __v16DeltaHTML(current, previous, suffix, invert){
  if(previous===null||previous===undefined||current===null||current===undefined) return '';
  const diff=current-previous;
  const absDiff=Math.abs(diff);
  if(absDiff<0.05) return `<span class="dash-kpi-delta neutral">= ${suffix||''}</span>`;
  const isGood=invert?(diff<0):(diff>0);
  const cls=isGood?'up':'down';
  const arrow=isGood?'▲':'▼';
  return `<span class="dash-kpi-delta ${cls}">${arrow} ${absDiff.toFixed(1)}${suffix||''}</span>`;
}

function renderV16EnhancedDashboard(){
  const dashEl=document.getElementById('viewDashboard');
  if(!dashEl) return;

  // Remove previous v16 elements
  dashEl.querySelectorAll('.v16-enhanced').forEach(el=>el.remove());

  const lista=getAlunosFiltrados();
  if(!lista.length) return;

  const bim=bimestreAtual;
  const prevBim=bim>1?bim-1:null;

  // Calculate stats for both subjects
  const s1=__v16CalcStats(lista, config.slot1, 'notas_lp', bim);
  const s2=__v16CalcStats(lista, config.slot2, 'notas_red', bim);
  const ps1=prevBim?__v16CalcStats(lista, config.slot1, 'notas_lp', prevBim):null;
  const ps2=prevBim?__v16CalcStats(lista, config.slot2, 'notas_red', prevBim):null;

  if(!s1 && !s2) return;

  const mediaGeral=((s1?s1.mean:0)+(s2?s2.mean:0))/((s1?1:0)+(s2?1:0));
  const prevMediaGeral=ps1||ps2?((ps1?ps1.mean:0)+(ps2?ps2.mean:0))/((ps1?1:0)+(ps2?1:0)):null;

  // Frequência média
  let freqSum=0, freqN=0;
  lista.forEach(a=>{
    const f=calcFreqAluno(a.id,bim);
    if(f.total>0){ freqSum+=f.pct; freqN++; }
  });
  const avgFreq=freqN>0?freqSum/freqN:null;
  let prevFreqSum=0, prevFreqN=0;
  if(prevBim){
    lista.forEach(a=>{
      const f=calcFreqAluno(a.id,prevBim);
      if(f.total>0){ prevFreqSum+=f.pct; prevFreqN++; }
    });
  }
  const prevAvgFreq=prevFreqN>0?prevFreqSum/prevFreqN:null;

  // Em risco (média < 5 em qualquer matéria)
  let emRisco=0;
  lista.forEach(a=>{
    const b=a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    if(m1<5||m2<5) emRisco++;
  });
  const pctRisco=lista.length?(emRisco/lista.length*100):0;
  let prevRisco=0;
  if(prevBim){
    lista.forEach(a=>{
      const b=a?.bimestres?.[prevBim]; if(!b) return;
      _syncBimestreRefs(b);
      const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
      const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
      if(m1<5||m2<5) prevRisco++;
    });
  }
  const prevPctRisco=prevBim&&lista.length?(prevRisco/lista.length*100):null;

  // Comportamento médio
  let compSum=0, compN=0;
  lista.forEach(a=>{
    const b=a?.bimestres?.[bim]; if(!b) return;
    const c=parseFloat(b.comportamento)||0;
    if(c>0||b.comportamento==='0'||b.comportamento===0){ compSum+=c; compN++; }
  });
  const avgComp=compN>0?compSum/compN:null;
  let prevCompSum=0, prevCompN=0;
  if(prevBim){
    lista.forEach(a=>{
      const b=a?.bimestres?.[prevBim]; if(!b) return;
      const c=parseFloat(b.comportamento)||0;
      if(c>0||b.comportamento==='0'||b.comportamento===0){ prevCompSum+=c; prevCompN++; }
    });
  }
  const prevAvgComp=prevCompN>0?prevCompSum/prevCompN:null;

  // ===== 1. KPI SUMMARY ROW =====
  const mediaColor=mediaGeral>=7?'#16a34a':(mediaGeral>=5?'#f59e0b':'#dc2626');
  const freqColor=avgFreq!==null?(avgFreq>=75?'#16a34a':(avgFreq>=50?'#f59e0b':'#dc2626')):'#64748b';
  const riscoColor=pctRisco<=10?'#16a34a':(pctRisco<=30?'#f59e0b':'#dc2626');
  const compColor=avgComp!==null?(avgComp>=7?'#16a34a':(avgComp>=5?'#f59e0b':'#dc2626')):'#64748b';

  let kpiHtml=`<div class="dash-kpi-row v16-enhanced">
    <div class="dash-kpi">
      <div class="dash-kpi-icon" style="background:${mediaColor}15;color:${mediaColor};"><i class="fas fa-chart-line"></i></div>
      <div class="dash-kpi-label">Média Geral</div>
      <div class="dash-kpi-value" style="color:${mediaColor};">${mediaGeral.toFixed(1)}</div>
      <div class="dash-kpi-sub">${bim}º Bimestre ${__v16DeltaHTML(mediaGeral, prevMediaGeral, '')}</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon" style="background:${freqColor}15;color:${freqColor};"><i class="fas fa-clipboard-check"></i></div>
      <div class="dash-kpi-label">Frequência Média</div>
      <div class="dash-kpi-value" style="color:${freqColor};">${avgFreq!==null?avgFreq.toFixed(0)+'%':'—'}</div>
      <div class="dash-kpi-sub">${freqN} aluno(s) com registro ${__v16DeltaHTML(avgFreq, prevAvgFreq, '%')}</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon" style="background:${riscoColor}15;color:${riscoColor};"><i class="fas fa-triangle-exclamation"></i></div>
      <div class="dash-kpi-label">Em Risco (&lt;5)</div>
      <div class="dash-kpi-value" style="color:${riscoColor};">${emRisco} <span style="font-size:.9rem;font-weight:600;">(${pctRisco.toFixed(0)}%)</span></div>
      <div class="dash-kpi-sub">de ${lista.length} alunos ${__v16DeltaHTML(pctRisco, prevPctRisco, '%', true)}</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon" style="background:${compColor}15;color:${compColor};"><i class="fas fa-star"></i></div>
      <div class="dash-kpi-label">Comportamento Médio</div>
      <div class="dash-kpi-value" style="color:${compColor};">${avgComp!==null?avgComp.toFixed(1):'—'}</div>
      <div class="dash-kpi-sub">${compN} aluno(s) avaliado(s) ${__v16DeltaHTML(avgComp, prevAvgComp, '')}</div>
    </div>
  </div>`;

  // Inject KPI row as first child
  const kpiDiv=document.createElement('div');
  kpiDiv.className='v16-enhanced'; kpiDiv.style.gridColumn='1/-1'; kpiDiv.style.order='-10';
  kpiDiv.innerHTML=kpiHtml;
  dashEl.insertBefore(kpiDiv, dashEl.firstChild);

  // ===== 2. ADVANCED STATISTICS CARD =====
  const d1Name=getDiscById(config.slot1)?.nome||'Matéria 1';
  const d2Name=getDiscById(config.slot2)?.nome||'Matéria 2';

  let statsHtml=`<div class="dash-card wide v16-enhanced" style="order:5;">
    <h3><i class="fas fa-calculator"></i> Estatísticas Descritivas — ${bim}º Bimestre</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px;">`;

  [['s1',s1,d1Name,config.slot1],['s2',s2,d2Name,config.slot2]].forEach(([key,stats,name])=>{
    if(!stats) return;
    statsHtml+=`<div>
      <div style="font-weight:700;font-size:.82rem;margin-bottom:8px;color:var(--text-main);">${escHTML(name)}</div>
      <div class="dash-stats-grid">
        <div class="dash-stat-item"><div class="stat-val">${stats.median.toFixed(1)}</div><div class="stat-lbl">Mediana</div></div>
        <div class="dash-stat-item"><div class="stat-val">${stats.stdDev.toFixed(2)}</div><div class="stat-lbl">Desvio Padrão</div></div>
        <div class="dash-stat-item"><div class="stat-val">${stats.min.toFixed(1)}</div><div class="stat-lbl">Nota Mín</div></div>
        <div class="dash-stat-item"><div class="stat-val">${stats.max.toFixed(1)}</div><div class="stat-lbl">Nota Máx</div></div>
        <div class="dash-stat-item"><div class="stat-val">${stats.cv.toFixed(1)}%</div><div class="stat-lbl">Coef. Variação</div></div>
        <div class="dash-stat-item"><div class="stat-val">${stats.acima9}</div><div class="stat-lbl">Notas ≥ 9</div></div>
      </div>
    </div>`;
  });
  statsHtml+=`</div>
    <div style="font-size:.72rem;color:#94a3b8;margin-top:10px;">
      O Coeficiente de Variação (CV) indica a homogeneidade da turma: CV &lt; 15% = turma homogênea, CV &gt; 30% = turma muito heterogênea.
    </div>
  </div>`;

  const statsDiv=document.createElement('div');
  statsDiv.className='v16-enhanced'; statsDiv.style.gridColumn='1/-1';
  statsDiv.innerHTML=statsHtml;
  dashEl.appendChild(statsDiv);

  // ===== 3. TOP 5 / BOTTOM 5 RANKING =====
  const ranking=[];
  lista.forEach(a=>{
    const b=a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    const mg=(m1+m2)/2;
    ranking.push({nome:a.nome||'Sem nome', media:mg, m1, m2});
  });
  ranking.sort((a,b)=>b.media-a.media);

  if(ranking.length>=5){
    const top5=ranking.slice(0,5);
    const bot5=ranking.slice(-5).reverse();
    const posClass=['gold','silver','bronze','normal','normal'];

    let rankHtml=`<div class="dash-card v16-enhanced" style="order:6;">
      <h3><i class="fas fa-trophy"></i> Top 5 — Maiores Médias</h3>
      <ul class="dash-rank-list">`;
    top5.forEach((r,i)=>{
      const cor=r.media>=7?'#16a34a':(r.media>=5?'#f59e0b':'#dc2626');
      rankHtml+=`<li class="dash-rank-item">
        <div class="dash-rank-pos ${posClass[i]}">${i+1}</div>
        <span class="dash-rank-name" title="${escHTML(r.nome)}">${escHTML(r.nome)}</span>
        <div class="dash-rank-bar"><div style="width:${(r.media/10*100).toFixed(0)}%;background:${cor};"></div></div>
        <span class="dash-rank-score" style="color:${cor};">${r.media.toFixed(1)}</span>
      </li>`;
    });
    rankHtml+=`</ul></div>`;

    rankHtml+=`<div class="dash-card v16-enhanced" style="order:7;">
      <h3 style="color:#dc2626;"><i class="fas fa-circle-exclamation"></i> Alerta — 5 Menores Médias</h3>
      <ul class="dash-rank-list">`;
    bot5.forEach((r,i)=>{
      const cor=r.media>=7?'#16a34a':(r.media>=5?'#f59e0b':'#dc2626');
      rankHtml+=`<li class="dash-rank-item">
        <div class="dash-rank-pos danger">${ranking.length-4+i}</div>
        <span class="dash-rank-name" title="${escHTML(r.nome)}">${escHTML(r.nome)}</span>
        <div class="dash-rank-bar"><div style="width:${(r.media/10*100).toFixed(0)}%;background:${cor};"></div></div>
        <span class="dash-rank-score" style="color:${cor};">${r.media.toFixed(1)}</span>
      </li>`;
    });
    rankHtml+=`</ul></div>`;

    const rankDiv=document.createElement('div');
    rankDiv.className='v16-enhanced'; rankDiv.style.cssText='grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:20px;';
    rankDiv.innerHTML=rankHtml;
    dashEl.appendChild(rankDiv);
  }

  // ===== 4. DISTRIBUIÇÃO DE COMPORTAMENTO =====
  if(compN>0){
    const compBins=[0,0,0,0,0]; // 0-2, 2-4, 4-6, 6-8, 8-10
    const compLabels=['0–2','2–4','4–6','6–8','8–10'];
    const compColors=['#dc2626','#f97316','#f59e0b','#84cc16','#16a34a'];
    lista.forEach(a=>{
      const b=a?.bimestres?.[bim]; if(!b) return;
      const c=parseFloat(b.comportamento)||0;
      const idx=Math.min(Math.floor(c/2),4);
      compBins[idx]++;
    });
    const maxBin=Math.max(...compBins,1);

    let compHtml=`<div class="dash-card v16-enhanced" style="order:8;">
      <h3><i class="fas fa-star"></i> Distribuição de Comportamento</h3>
      <div style="display:flex;align-items:flex-end;justify-content:space-around;height:140px;padding:10px 0;gap:8px;">`;
    compBins.forEach((count,i)=>{
      const h=maxBin>0?(count/maxBin*100):0;
      compHtml+=`<div style="display:flex;flex-direction:column;align-items:center;flex:1;height:100%;justify-content:flex-end;">
        <div style="font-size:.72rem;font-weight:700;color:${compColors[i]};margin-bottom:4px;">${count}</div>
        <div style="width:100%;max-width:40px;height:${h}%;background:${compColors[i]};border-radius:4px 4px 0 0;min-height:2px;transition:height .4s;"></div>
        <div style="font-size:.65rem;color:#64748b;margin-top:4px;">${compLabels[i]}</div>
      </div>`;
    });
    compHtml+=`</div>
      <div style="font-size:.72rem;color:#94a3b8;margin-top:6px;text-align:center;">
        Média: <b style="color:${compColor};">${avgComp.toFixed(1)}</b> · ${compN} aluno(s) avaliado(s)
      </div>
    </div>`;

    // ===== 5. SCATTER PLOT: FREQUÊNCIA × DESEMPENHO =====
    let scatterHtml=`<div class="dash-card v16-enhanced" style="order:9;">
      <h3><i class="fas fa-braille"></i> Frequência × Desempenho</h3>
      <div class="dash-scatter-wrap"><canvas id="v16ScatterCanvas"></canvas></div>
      <div style="font-size:.72rem;color:#94a3b8;margin-top:6px;text-align:center;">
        Cada ponto = 1 aluno. Quanto mais à direita (mais frequente) e acima (mais nota), melhor.
      </div>
    </div>`;

    const scatterDiv=document.createElement('div');
    scatterDiv.className='v16-enhanced'; scatterDiv.style.cssText='grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:20px;';
    scatterDiv.innerHTML=compHtml+scatterHtml;
    dashEl.appendChild(scatterDiv);

    // Draw scatter after DOM update
    setTimeout(()=>__v16DrawScatter(lista, bim), 60);
  }
}

function __v16DrawScatter(lista, bim){
  const canvas=document.getElementById('v16ScatterCanvas');
  if(!canvas) return;

  const data=[];
  lista.forEach(a=>{
    const f=calcFreqAluno(a.id,bim);
    if(f.total===0) return;
    const b=a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    const mg=(m1+m2)/2;
    data.push({nome:a.nome, freq:f.pct, media:mg});
  });

  if(!data.length) return;

  const W=canvas.width=canvas.offsetWidth*2;
  const H=canvas.height=520;
  const c=canvas.getContext('2d');
  const pad={t:20,b:40,l:50,r:20};
  const pW=W-pad.l-pad.r, pH=H-pad.t-pad.b;

  c.clearRect(0,0,W,H);

  // Background zones
  // Red zone (freq<75 or media<5)
  c.fillStyle='rgba(220,38,38,.03)';
  c.fillRect(pad.l, pad.t+pH-(5/10)*pH, pW, (5/10)*pH);
  c.fillRect(pad.l, pad.t, (75/100)*pW, pH);

  // Green zone
  c.fillStyle='rgba(22,163,74,.03)';
  c.fillRect(pad.l+(75/100)*pW, pad.t, (25/100)*pW, (5/10)*pH);

  // Grid
  c.strokeStyle='rgba(148,163,184,.12)'; c.lineWidth=1;
  [0,25,50,75,100].forEach(v=>{
    const x=pad.l+(v/100)*pW;
    c.beginPath(); c.moveTo(x,pad.t); c.lineTo(x,H-pad.b); c.stroke();
    c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='center';
    c.fillText(v+'%',x,H-pad.b+20);
  });
  [0,2,4,5,6,7,8,10].forEach(v=>{
    const y=pad.t+pH-(v/10)*pH;
    c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
    c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='right';
    c.fillText(v,pad.l-8,y+5);
  });

  // Reference lines
  c.strokeStyle='rgba(220,38,38,.25)'; c.lineWidth=2; c.setLineDash([6,4]);
  const y5=pad.t+pH-(5/10)*pH;
  c.beginPath(); c.moveTo(pad.l,y5); c.lineTo(W-pad.r,y5); c.stroke();
  const x75=pad.l+(75/100)*pW;
  c.beginPath(); c.moveTo(x75,pad.t); c.lineTo(x75,H-pad.b); c.stroke();
  c.setLineDash([]);

  // Axis labels
  c.fillStyle='#64748b'; c.font='bold 20px sans-serif';
  c.textAlign='center'; c.fillText('Frequência (%)',pad.l+pW/2,H-5);
  c.save(); c.translate(14,pad.t+pH/2); c.rotate(-Math.PI/2);
  c.fillText('Média Geral',0,0); c.restore();

  // Data points
  data.forEach(d=>{
    const x=pad.l+(Math.min(100,Math.max(0,d.freq))/100)*pW;
    const y=pad.t+pH-(Math.min(10,Math.max(0,d.media))/10)*pH;
    const cor=d.media>=7?(d.freq>=75?'#16a34a':'#f59e0b'):(d.media>=5?'#f59e0b':'#dc2626');
    c.beginPath(); c.arc(x,y,8,0,Math.PI*2);
    c.fillStyle=cor+'cc'; c.fill();
    c.strokeStyle=cor; c.lineWidth=2; c.stroke();
  });

  // Legend
  c.font='16px sans-serif'; c.textAlign='left';
  const lx=pad.l+10, ly=pad.t+16;
  [['#16a34a','Bom (≥7, ≥75%)'],['#f59e0b','Atenção'],['#dc2626','Risco (<5)']].forEach(([col,lbl],i)=>{
    c.beginPath(); c.arc(lx+6,ly+i*22,5,0,Math.PI*2);
    c.fillStyle=col; c.fill();
    c.fillStyle='#64748b'; c.fillText(lbl,lx+18,ly+i*22+5);
  });
}

// ================================================================
// V16B FEATURE 1: TRAJETÓRIA INDIVIDUAL (Melhorou/Piorou)
// ================================================================
function __v16bRenderTrajetoria(lista, bim, dashEl){
  if(bim<=1) return; // Precisa de bimestre anterior
  const prevBim=bim-1;
  const trajs=[];
  lista.forEach(a=>{
    const bCurr=a?.bimestres?.[bim]; const bPrev=a?.bimestres?.[prevBim];
    if(!bCurr||!bPrev) return;
    _syncBimestreRefs(bCurr); _syncBimestreRefs(bPrev);
    const currM1=clampNota(calcularMediaDisc(config.slot1, bCurr.notas_lp));
    const currM2=clampNota(calcularMediaDisc(config.slot2, bCurr.notas_red));
    const prevM1=clampNota(calcularMediaDisc(config.slot1, bPrev.notas_lp));
    const prevM2=clampNota(calcularMediaDisc(config.slot2, bPrev.notas_red));
    const curr=(currM1+currM2)/2, prev=(prevM1+prevM2)/2;
    const delta=curr-prev;
    if(Math.abs(delta)<0.05) return; // Ignora estáveis
    trajs.push({nome:a.nome||'Sem nome', curr, prev, delta, m1:currM1, m2:currM2});
  });
  if(!trajs.length) return;

  // Separar melhoraram e pioraram
  const melhoraram=trajs.filter(t=>t.delta>0).sort((a,b)=>b.delta-a.delta);
  const pioraram=trajs.filter(t=>t.delta<0).sort((a,b)=>a.delta-b.delta);

  let html=`<div class="dash-card wide v16b-enhanced" style="order:10;">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
      <h3 style="margin:0;"><i class="fas fa-route"></i> Trajetória Individual — ${prevBim}ºB → ${bim}ºB</h3>
      <div style="font-size:.72rem;color:#64748b;">
        <span style="color:#16a34a;font-weight:700;">▲ ${melhoraram.length} melhoraram</span> · 
        <span style="color:#dc2626;font-weight:700;">▼ ${pioraram.length} pioraram</span> · 
        <span style="color:#64748b;">${lista.length - melhoraram.length - pioraram.length} estáveis</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">`;

  // Coluna: Melhoraram
  html+=`<div>
    <div style="font-size:.75rem;font-weight:700;color:#16a34a;margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px;">▲ Melhoraram</div>
    <ul class="dash-traj-list">`;
  (melhoraram.length?melhoraram:['—']).forEach(t=>{
    if(t==='—'){html+=`<li class="dash-traj-item" style="color:#94a3b8;">Nenhum aluno melhorou</li>`;return;}
    html+=`<li class="dash-traj-item">
      <div class="dash-traj-arrow up">▲</div>
      <span class="dash-traj-name" title="${escHTML(t.nome)}">${escHTML(t.nome)}</span>
      <div class="dash-traj-vals">
        <span class="dash-traj-old">${t.prev.toFixed(1)}</span>
        <span>→</span>
        <span class="dash-traj-new" style="color:#16a34a;">${t.curr.toFixed(1)}</span>
        <span class="dash-traj-delta pos">+${t.delta.toFixed(1)}</span>
      </div>
    </li>`;
  });
  html+=`</ul></div>`;

  // Coluna: Pioraram
  html+=`<div>
    <div style="font-size:.75rem;font-weight:700;color:#dc2626;margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px;">▼ Pioraram</div>
    <ul class="dash-traj-list">`;
  (pioraram.length?pioraram:['—']).forEach(t=>{
    if(t==='—'){html+=`<li class="dash-traj-item" style="color:#94a3b8;">Nenhum aluno piorou</li>`;return;}
    html+=`<li class="dash-traj-item">
      <div class="dash-traj-arrow down">▼</div>
      <span class="dash-traj-name" title="${escHTML(t.nome)}">${escHTML(t.nome)}</span>
      <div class="dash-traj-vals">
        <span class="dash-traj-old">${t.prev.toFixed(1)}</span>
        <span>→</span>
        <span class="dash-traj-new" style="color:#dc2626;">${t.curr.toFixed(1)}</span>
        <span class="dash-traj-delta neg">${t.delta.toFixed(1)}</span>
      </div>
    </li>`;
  });
  html+=`</ul></div></div></div>`;

  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='1/-1';
  div.innerHTML=html;
  dashEl.appendChild(div);
}

// ================================================================
// V16B FEATURE 2: HEATMAP POR AVALIAÇÃO
// ================================================================
function __v16bRenderHeatmap(lista, bim, dashEl){
  const d1=getDiscById(config.slot1), d2=getDiscById(config.slot2);
  if(!d1&&!d2) return;

  function heatColor(nota){
    if(nota===null||nota===undefined) return 'background:#f8fafc;color:#cbd5e1;';
    const n=clampNota(nota);
    if(n>=9) return 'background:#065f46;color:#fff;';
    if(n>=8) return 'background:#16a34a;color:#fff;';
    if(n>=7) return 'background:#4ade80;color:#064e3b;';
    if(n>=6) return 'background:#86efac;color:#064e3b;';
    if(n>=5) return 'background:#fde68a;color:#78350f;';
    if(n>=4) return 'background:#fbbf24;color:#78350f;';
    if(n>=3) return 'background:#f97316;color:#fff;';
    if(n>=2) return 'background:#ef4444;color:#fff;';
    return 'background:#991b1b;color:#fff;';
  }

  // Build columns: all assessments from both subjects
  const cols=[];
  if(d1)(d1.avaliacoes||[]).forEach(av=>cols.push({discId:d1.id,discNome:d1.nome,avId:av.id,avNome:av.nome||av.id,notasKey:'notas_lp'}));
  cols.push({separator:true,label:''});
  if(d2)(d2.avaliacoes||[]).forEach(av=>cols.push({discId:d2.id,discNome:d2.nome,avId:av.id,avNome:av.nome||av.id,notasKey:'notas_red'}));

  let html=`<div class="dash-card wide v16b-enhanced" style="order:11;">
    <h3><i class="fas fa-fire"></i> Heatmap de Notas por Avaliação — ${bim}º Bimestre</h3>
    <div class="dash-heatmap-wrap"><table class="dash-heatmap"><thead><tr><th>Aluno</th>`;
  cols.forEach(c=>{
    if(c.separator){html+=`<th style="width:3px;padding:0;background:var(--border-color);"></th>`;return;}
    html+=`<th title="${escHTML(c.discNome)} — ${escHTML(c.avNome)}">${escHTML(c.avNome)}</th>`;
  });
  html+=`<th>Média</th></tr></thead><tbody>`;

  // Column averages
  const colSums=cols.map(()=>({s:0,n:0}));
  const mediaCol={s:0,n:0};

  lista.forEach(a=>{
    const b=a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    const mg=(m1+m2)/2;
    mediaCol.s+=mg; mediaCol.n++;

    html+=`<tr><td title="${escHTML(a.nome||'')}">${escHTML(a.nome||'Sem nome')}</td>`;
    cols.forEach((c,ci)=>{
      if(c.separator){html+=`<td style="width:3px;padding:0;background:var(--border-color);"></td>`;return;}
      const notas=b[c.notasKey];
      const raw=notas?.[c.avId];
      const hasVal=raw!==null&&raw!==undefined&&raw!=='';
      const val=hasVal?clampNota(raw):null;
      if(hasVal){colSums[ci].s+=val;colSums[ci].n++;}
      html+=`<td style="${heatColor(val)};border-left:1px solid rgba(0,0,0,.04);">${hasVal?val.toFixed(1):'—'}</td>`;
    });
    html+=`<td style="${heatColor(mg)};font-weight:800;border-left:2px solid var(--border-color);">${mg.toFixed(1)}</td></tr>`;
  });

  // Average row
  html+=`<tr style="border-top:2px solid var(--border-color);font-weight:800;"><td style="font-style:italic;">Média da turma</td>`;
  cols.forEach((c,ci)=>{
    if(c.separator){html+=`<td style="width:3px;padding:0;background:var(--border-color);"></td>`;return;}
    const avg=colSums[ci].n>0?colSums[ci].s/colSums[ci].n:null;
    html+=`<td style="${heatColor(avg)};border-left:1px solid rgba(0,0,0,.04);">${avg!==null?avg.toFixed(1):'—'}</td>`;
  });
  const totalAvg=mediaCol.n>0?mediaCol.s/mediaCol.n:null;
  html+=`<td style="${heatColor(totalAvg)};font-weight:900;border-left:2px solid var(--border-color);">${totalAvg!==null?totalAvg.toFixed(1):'—'}</td></tr>`;

  html+=`</tbody></table></div>
    <div style="display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap;font-size:.68rem;">
      <span style="font-weight:600;color:#64748b;">Legenda:</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#991b1b;"></span><span style="color:#64748b;">0–2</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#ef4444;"></span><span style="color:#64748b;">2–3</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#f97316;"></span><span style="color:#64748b;">3–4</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#fbbf24;"></span><span style="color:#64748b;">4–5</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#fde68a;"></span><span style="color:#64748b;">5–6</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#86efac;"></span><span style="color:#64748b;">6–7</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#4ade80;"></span><span style="color:#64748b;">7–8</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#16a34a;"></span><span style="color:#64748b;">8–9</span>
      <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:#065f46;"></span><span style="color:#64748b;">9–10</span>
    </div>
  </div>`;

  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='1/-1';
  div.innerHTML=html;
  dashEl.appendChild(div);
}

// ================================================================
// V16B FEATURE 3: SCATTER COMPORTAMENTO × NOTA
// ================================================================
function __v16bRenderCompScatter(lista, bim, dashEl){
  let hasComp=false;
  lista.forEach(a=>{
    const b=a?.bimestres?.[bim];
    if(b&&(parseFloat(b.comportamento)>0)) hasComp=true;
  });
  if(!hasComp) return;

  const html=`<div class="dash-card v16b-enhanced" style="order:12;">
    <h3><i class="fas fa-star"></i> Comportamento × Nota</h3>
    <div class="dash-scatter-wrap"><canvas id="v16bCompScatter"></canvas></div>
    <div style="font-size:.72rem;color:#94a3b8;margin-top:6px;text-align:center;">
      Cada ponto = 1 aluno. Eixo X = comportamento, Eixo Y = média geral.
    </div>
  </div>`;

  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='span 1';
  div.innerHTML=html;
  dashEl.appendChild(div);

  setTimeout(()=>{
    const canvas=document.getElementById('v16bCompScatter');
    if(!canvas) return;
    const data=[];
    lista.forEach(a=>{
      const b=a?.bimestres?.[bim]; if(!b) return;
      _syncBimestreRefs(b);
      const comp=parseFloat(b.comportamento)||0;
      if(comp<=0&&b.comportamento!==0&&b.comportamento!=='0') return;
      const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
      const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
      data.push({nome:a.nome, comp, media:(m1+m2)/2});
    });
    if(!data.length) return;

    const W=canvas.width=canvas.offsetWidth*2, H=canvas.height=520;
    const c=canvas.getContext('2d');
    const pad={t:20,b:40,l:50,r:20};
    const pW=W-pad.l-pad.r, pH=H-pad.t-pad.b;
    c.clearRect(0,0,W,H);

    // Grid
    c.strokeStyle='rgba(148,163,184,.12)'; c.lineWidth=1;
    [0,2,4,6,8,10].forEach(v=>{
      const x=pad.l+(v/10)*pW;
      c.beginPath(); c.moveTo(x,pad.t); c.lineTo(x,H-pad.b); c.stroke();
      c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='center';
      c.fillText(v,x,H-pad.b+20);
    });
    [0,2,4,5,6,7,8,10].forEach(v=>{
      const y=pad.t+pH-(v/10)*pH;
      c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
      c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='right';
      c.fillText(v,pad.l-8,y+5);
    });

    // Reference lines at 5
    c.strokeStyle='rgba(220,38,38,.2)'; c.lineWidth=2; c.setLineDash([6,4]);
    const y5=pad.t+pH-(5/10)*pH;
    c.beginPath(); c.moveTo(pad.l,y5); c.lineTo(W-pad.r,y5); c.stroke();
    const x5=pad.l+(5/10)*pW;
    c.beginPath(); c.moveTo(x5,pad.t); c.lineTo(x5,H-pad.b); c.stroke();
    c.setLineDash([]);

    // Axis labels
    c.fillStyle='#64748b'; c.font='bold 20px sans-serif'; c.textAlign='center';
    c.fillText('Comportamento',pad.l+pW/2,H-5);
    c.save(); c.translate(14,pad.t+pH/2); c.rotate(-Math.PI/2);
    c.fillText('Média Geral',0,0); c.restore();

    // Points
    data.forEach(d=>{
      const x=pad.l+(Math.min(10,Math.max(0,d.comp))/10)*pW;
      const y=pad.t+pH-(Math.min(10,Math.max(0,d.media))/10)*pH;
      const cor=d.media>=7?(d.comp>=7?'#16a34a':'#f59e0b'):(d.media>=5?'#f59e0b':'#dc2626');
      c.beginPath(); c.arc(x,y,8,0,Math.PI*2);
      c.fillStyle=cor+'cc'; c.fill();
      c.strokeStyle=cor; c.lineWidth=2; c.stroke();
    });

    // Trend line (simple linear regression)
    if(data.length>=3){
      let sx=0,sy=0,sxy=0,sx2=0;
      data.forEach(d=>{sx+=d.comp;sy+=d.media;sxy+=d.comp*d.media;sx2+=d.comp*d.comp;});
      const n=data.length;
      const denom=n*sx2-sx*sx;
      if(Math.abs(denom)>0.001){
        const slope=(n*sxy-sx*sy)/denom;
        const intercept=(sy-slope*sx)/n;
        const x0=0, x1=10, y0=intercept, y1=slope*10+intercept;
        c.beginPath();
        c.strokeStyle='rgba(124,58,237,.35)'; c.lineWidth=3; c.setLineDash([8,6]);
        c.moveTo(pad.l+(x0/10)*pW, pad.t+pH-(Math.max(0,Math.min(10,y0))/10)*pH);
        c.lineTo(pad.l+(x1/10)*pW, pad.t+pH-(Math.max(0,Math.min(10,y1))/10)*pH);
        c.stroke(); c.setLineDash([]);
        // R label
        const r=Math.abs(denom)>0.001?(n*sxy-sx*sy)/Math.sqrt((n*sx2-sx*sx)*(n*data.reduce((a,d)=>a+d.media*d.media,0)-sy*sy)):0;
        c.fillStyle='#7c3aed'; c.font='bold 18px sans-serif'; c.textAlign='right';
        c.fillText(`r = ${r.toFixed(2)}`,W-pad.r-10,pad.t+16);
      }
    }
  }, 80);
}

// ================================================================
// V16B FEATURE 4: BOX PLOT VISUAL POR MATÉRIA
// ================================================================
function __v16bRenderBoxPlot(lista, bim, dashEl){
  const s1=__v16CalcStats(lista, config.slot1, 'notas_lp', bim);
  const s2=__v16CalcStats(lista, config.slot2, 'notas_red', bim);
  if(!s1&&!s2) return;

  const d1Name=getDiscById(config.slot1)?.nome||'Matéria 1';
  const d2Name=getDiscById(config.slot2)?.nome||'Matéria 2';

  const html=`<div class="dash-card v16b-enhanced" style="order:13;">
    <h3><i class="fas fa-chart-bar"></i> Box Plot — Dispersão de Notas</h3>
    <div class="dash-boxplot-wrap"><canvas id="v16bBoxPlotCanvas"></canvas></div>
    <div style="font-size:.72rem;color:#94a3b8;margin-top:6px;text-align:center;">
      Caixa = Q1 a Q3 (50% central) · Linha interna = Mediana · Bigodes = Min/Max · Pontos = Outliers
    </div>
  </div>`;

  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='span 1';
  div.innerHTML=html;
  dashEl.appendChild(div);

  setTimeout(()=>{
    const canvas=document.getElementById('v16bBoxPlotCanvas');
    if(!canvas) return;

    function percentile(sorted,p){
      const n=sorted.length; if(!n)return 0; if(n===1)return sorted[0];
      const idx=(n-1)*p; const lo=Math.floor(idx),hi=Math.ceil(idx);
      return lo===hi?sorted[lo]:sorted[lo]*(1-(idx-lo))+sorted[hi]*(idx-lo);
    }

    const datasets=[];
    if(s1) datasets.push({name:d1Name, sorted:s1.sorted, col:'#2563eb'});
    if(s2) datasets.push({name:d2Name, sorted:s2.sorted, col:'#ec4899'});

    const W=canvas.width=canvas.offsetWidth*2, H=canvas.height=440;
    const c=canvas.getContext('2d');
    const pad={t:30,b:50,l:50,r:30};
    const pW=W-pad.l-pad.r, pH=H-pad.t-pad.b;
    c.clearRect(0,0,W,H);

    // Y axis grid (0..10)
    c.strokeStyle='rgba(148,163,184,.12)'; c.lineWidth=1;
    for(let v=0;v<=10;v++){
      const y=pad.t+pH-(v/10)*pH;
      c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
      c.fillStyle='#94a3b8'; c.font='18px sans-serif'; c.textAlign='right';
      c.fillText(v,pad.l-8,y+5);
    }
    // Reference at 5 and 7
    [5,7].forEach(v=>{
      const y=pad.t+pH-(v/10)*pH;
      c.strokeStyle=v===5?'rgba(220,38,38,.2)':'rgba(22,163,74,.2)';
      c.lineWidth=2; c.setLineDash([6,4]);
      c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
      c.setLineDash([]);
    });

    const boxW=Math.min(120,pW/(datasets.length*2+1));
    const spacing=pW/(datasets.length+1);

    datasets.forEach((ds,i)=>{
      const cx=pad.l+spacing*(i+1);
      const sorted=ds.sorted;
      const q1=percentile(sorted,.25), med=percentile(sorted,.5), q3=percentile(sorted,.75);
      const iqr=q3-q1;
      const wLo=Math.max(sorted[0], q1-1.5*iqr);
      const wHi=Math.min(sorted[sorted.length-1], q3+1.5*iqr);
      // Find actual whisker values (closest data points within range)
      const actualLo=sorted.find(v=>v>=wLo)||sorted[0];
      const actualHi=[...sorted].reverse().find(v=>v<=wHi)||sorted[sorted.length-1];

      const toY=v=>pad.t+pH-(Math.max(0,Math.min(10,v))/10)*pH;

      // Whisker lines
      c.strokeStyle=ds.col; c.lineWidth=3;
      c.beginPath(); c.moveTo(cx,toY(actualLo)); c.lineTo(cx,toY(actualHi)); c.stroke();
      // Whisker caps
      c.beginPath(); c.moveTo(cx-boxW*0.3,toY(actualLo)); c.lineTo(cx+boxW*0.3,toY(actualLo)); c.stroke();
      c.beginPath(); c.moveTo(cx-boxW*0.3,toY(actualHi)); c.lineTo(cx+boxW*0.3,toY(actualHi)); c.stroke();

      // Box (Q1 to Q3)
      const bx=cx-boxW/2, by=toY(q3), bh=toY(q1)-toY(q3);
      c.fillStyle=ds.col+'22'; c.fillRect(bx,by,boxW,bh);
      c.strokeStyle=ds.col; c.lineWidth=3; c.strokeRect(bx,by,boxW,bh);

      // Median line
      c.strokeStyle='#fff'; c.lineWidth=4;
      c.beginPath(); c.moveTo(bx+2,toY(med)); c.lineTo(bx+boxW-2,toY(med)); c.stroke();
      c.strokeStyle=ds.col; c.lineWidth=3;
      c.beginPath(); c.moveTo(bx+2,toY(med)); c.lineTo(bx+boxW-2,toY(med)); c.stroke();

      // Outliers
      sorted.forEach(v=>{
        if(v<actualLo||v>actualHi){
          c.beginPath(); c.arc(cx,toY(v),5,0,Math.PI*2);
          c.fillStyle=ds.col+'88'; c.fill();
          c.strokeStyle=ds.col; c.lineWidth=1.5; c.stroke();
        }
      });

      // Label + stats
      c.fillStyle=ds.col; c.font='bold 22px sans-serif'; c.textAlign='center';
      c.fillText(ds.name,cx,H-pad.b+22);
      c.font='16px sans-serif'; c.fillStyle='#64748b';
      c.fillText(`Med: ${med.toFixed(1)} · Q1: ${q1.toFixed(1)} · Q3: ${q3.toFixed(1)}`,cx,H-pad.b+40);
    });
  }, 80);
}

// ================================================================
// V16B FEATURE 5: ALUNOS MAIS VOLÁTEIS
// ================================================================
function __v16bRenderVolateis(lista, dashEl){
  const volateis=[];
  lista.forEach(a=>{
    const medias=[];
    [1,2,3,4].forEach(bim=>{
      const b=a?.bimestres?.[bim]; if(!b) return;
      _syncBimestreRefs(b);
      const m1=clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
      const m2=clampNota(calcularMediaDisc(config.slot2, b.notas_red));
      const mg=(m1+m2)/2;
      if(mg>0) medias.push({bim,val:mg});
    });
    if(medias.length<2) return;
    const vals=medias.map(m=>m.val);
    const mean=vals.reduce((a,b)=>a+b,0)/vals.length;
    const variance=vals.reduce((a,v)=>a+Math.pow(v-mean,2),0)/vals.length;
    const stdDev=Math.sqrt(variance);
    const min=Math.min(...vals), max=Math.max(...vals);
    const amplitude=max-min;
    volateis.push({nome:a.nome||'Sem nome', stdDev, amplitude, mean, medias, min, max});
  });
  if(volateis.length<3) return;

  volateis.sort((a,b)=>b.stdDev-a.stdDev);
  const top=volateis.slice(0,Math.min(10,volateis.length));
  const maxStd=Math.max(...top.map(v=>v.stdDev),0.1);

  let html=`<div class="dash-card wide v16b-enhanced" style="order:14;">
    <h3><i class="fas fa-bolt"></i> Alunos Mais Voláteis (Instabilidade entre Bimestres)</h3>
    <div style="font-size:.72rem;color:#94a3b8;margin-bottom:10px;">
      Alunos cujas médias gerais oscilam mais entre bimestres. Alto desvio padrão = precisa de acompanhamento.
    </div>
    <div style="display:grid;grid-template-columns:1fr;gap:2px;">`;

  top.forEach((v,i)=>{
    const barPct=Math.min(100,(v.stdDev/maxStd*100)).toFixed(0);
    const cor=v.stdDev>=2?'#dc2626':(v.stdDev>=1?'#f59e0b':'#16a34a');
    const sparkline=v.medias.map(m=>`${m.bim}ºB: ${m.val.toFixed(1)}`).join(' → ');
    html+=`<div class="dash-volatil-item">
      <div style="width:22px;font-size:.72rem;font-weight:800;color:#64748b;text-align:center;">${i+1}</div>
      <span class="dash-rank-name" title="${escHTML(v.nome)}" style="flex:1;">${escHTML(v.nome)}</span>
      <div class="dash-volatil-bar"><div style="width:${barPct}%;background:${cor};"></div></div>
      <span style="min-width:50px;text-align:right;font-weight:800;font-size:.8rem;color:${cor};">σ ${v.stdDev.toFixed(2)}</span>
      <span style="min-width:70px;text-align:right;font-size:.7rem;color:#94a3b8;" title="${sparkline}">Δ ${v.amplitude.toFixed(1)} (${v.min.toFixed(1)}–${v.max.toFixed(1)})</span>
    </div>`;
  });

  html+=`</div>
    <div style="font-size:.7rem;color:#94a3b8;margin-top:8px;">
      σ = desvio padrão das médias gerais · Δ = amplitude (maior – menor nota) · Apenas alunos com ≥ 2 bimestres.
    </div>
  </div>`;

  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='1/-1';
  div.innerHTML=html;
  dashEl.appendChild(div);
}

// ================================================================
// V16B FEATURE 6: RESUMO EXPORTÁVEL (PDF)
// ================================================================
function __v16bRenderPDFButton(dashEl){
  const html=`<div class="v16b-enhanced" style="grid-column:1/-1;text-align:right;order:100;margin-top:8px;">
    <button class="dash-pdf-btn" onclick="__v16bExportDashPDF()" title="Gerar relatório PDF do dashboard">
      <i class="fas fa-file-pdf"></i> Exportar Relatório PDF
    </button>
  </div>`;
  const div=document.createElement('div');
  div.className='v16b-enhanced'; div.style.gridColumn='1/-1';
  div.innerHTML=html;
  dashEl.appendChild(div);
}

function __v16bExportDashPDF(){
  try{
    const dashEl=document.getElementById('viewDashboard');
    if(!dashEl) return showToast('Dashboard não encontrado.','error');

    const turma=filtroTurma||'Todas';
    const bim=bimestreAtual||1;
    const dataStr=new Date().toLocaleDateString('pt-BR');

    // Create a printable container
    const overlay=document.createElement('div');
    overlay.id='v16bPrintOverlay';
    overlay.style.cssText='position:fixed;inset:0;z-index:99999;background:#fff;overflow:auto;padding:20px 30px;';

    // Header
    let headerHtml=`<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #0ea5e9;padding-bottom:12px;margin-bottom:20px;">
      <div>
        <h1 style="margin:0;font-size:1.5rem;color:#0f172a;">SGP — Relatório do Dashboard</h1>
        <p style="margin:4px 0 0;font-size:.85rem;color:#64748b;">Turma: <b>${escHTML(turma)}</b> · ${bim}º Bimestre · Gerado em ${dataStr}</p>
      </div>
      <div style="display:flex;gap:8px;" class="no-print">
        <button onclick="window.print()" style="padding:8px 16px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;font-size:.85rem;font-weight:700;cursor:pointer;">
          <i class="fas fa-print"></i> Imprimir / Salvar PDF
        </button>
        <button onclick="document.getElementById('v16bPrintOverlay').remove()" style="padding:8px 16px;background:#64748b;color:#fff;border:none;border-radius:8px;font-size:.85rem;font-weight:700;cursor:pointer;">
          <i class="fas fa-xmark"></i> Fechar
        </button>
      </div>
    </div>`;

    // Clone dashboard content
    const cloned=dashEl.cloneNode(true);
    cloned.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:16px;';
    // Remove buttons and interactive elements from clone
    cloned.querySelectorAll('button,select,.dash-pdf-btn,.no-print').forEach(el=>el.remove());
    // Make all canvas visible (they won't clone, so add placeholder text)
    cloned.querySelectorAll('canvas').forEach(cv=>{
      const p=document.createElement('div');
      p.style.cssText='padding:20px;text-align:center;color:#94a3b8;font-style:italic;border:1px dashed #e2e8f0;border-radius:8px;';
      p.textContent='[Gráfico — visível na versão impressa via navegador]';
      cv.replaceWith(p);
    });

    overlay.innerHTML=headerHtml;
    overlay.appendChild(cloned);

    // Print style
    const style=document.createElement('style');
    style.textContent=`@media print{#v16bPrintOverlay{position:static!important;padding:10px!important;}#v16bPrintOverlay .no-print{display:none!important;}body>*:not(#v16bPrintOverlay){display:none!important;}}`;
    overlay.appendChild(style);

    document.body.appendChild(overlay);

    showToast('Relatório preparado! Clique em "Imprimir / Salvar PDF" para gerar o arquivo.','success');
  }catch(e){
    try{showToast('Erro ao gerar relatório: '+e.message,'error');}catch(_){}
  }
}

// ================================================================
// V16B: MASTER RENDER (hooks all 6 features)
// ================================================================
function renderV16bFeatures(){
  const dashEl=document.getElementById('viewDashboard');
  if(!dashEl) return;
  dashEl.querySelectorAll('.v16b-enhanced').forEach(el=>el.remove());

  const lista=getAlunosFiltrados();
  if(!lista.length) return;
  const bim=bimestreAtual;

  try{ __v16bRenderTrajetoria(lista, bim, dashEl); }catch(e){ try{__diagCapture(e,'v16b.trajetoria');}catch(_){} }
  try{ __v16bRenderHeatmap(lista, bim, dashEl); }catch(e){ try{__diagCapture(e,'v16b.heatmap');}catch(_){} }
  
  // Box plot + Comportamento scatter (side by side)
  const pairDiv=document.createElement('div');
  pairDiv.className='v16b-enhanced'; pairDiv.style.cssText='grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:20px;';
  pairDiv.id='v16bPairContainer';
  dashEl.appendChild(pairDiv);
  try{ __v16bRenderBoxPlot(lista, bim, pairDiv); }catch(e){ try{__diagCapture(e,'v16b.boxplot');}catch(_){} }
  try{ __v16bRenderCompScatter(lista, bim, pairDiv); }catch(e){ try{__diagCapture(e,'v16b.compscatter');}catch(_){} }
  // If pair container is empty, remove it
  if(pairDiv.children.length===0) pairDiv.remove();

  try{ __v16bRenderVolateis(lista, dashEl); }catch(e){ try{__diagCapture(e,'v16b.volateis');}catch(_){} }
  try{ __v16bRenderPDFButton(dashEl); }catch(e){ try{__diagCapture(e,'v16b.pdf');}catch(_){} }
}
try{
  const __origRenderDash2=renderizarDashboard;
  renderizarDashboard=function(){
    __origRenderDash2();
    try{
      const dashEl=document.getElementById('viewDashboard');
      if(!dashEl) return;

      // Remove old V15 elements
      dashEl.querySelectorAll('.v15-comp,.v15-evo,.v15-freqalerts').forEach(el=>el.remove());

      // V16: Enhanced stats (always render)
      try{ renderV16EnhancedDashboard(); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'v16.enhanced'); }catch(_){} }

      // V16B: 6 new features (trajetória, heatmap, boxplot, comp×nota, voláteis, PDF)
      try{ renderV16bFeatures(); }catch(e){ try{ if(typeof __diagCapture==='function') __diagCapture(e,'v16b.features'); }catch(_){} }

      if(filtroTurma==='Todas'){
        // F8: Show comparativo
        const compHtml=renderComparativoTurmas();
        if(compHtml){
          const div=document.createElement('div');
          div.className='v15-comp'; div.style.gridColumn='1/-1';
          div.innerHTML=compHtml;
          dashEl.appendChild(div);
        }
      } else {
        // F9: Show evolução da turma
        const evoHtml=renderEvolucaoTurma();
        if(evoHtml){
          const div=document.createElement('div');
          div.className='v15-evo'; div.style.gridColumn='1/-1';
          div.innerHTML=evoHtml;
          dashEl.appendChild(div);
          setTimeout(drawEvoTurmaChart, 50);
        }

      }

// Frequência: alertas e pendências
const freqHtml = renderFreqAlertsDashboard();
if(freqHtml){
  const div=document.createElement('div');
  div.className='v15-freqalerts'; div.style.gridColumn='1/-1';
  div.innerHTML=freqHtml;
  dashEl.appendChild(div);
}
    }catch(_){}
  };
}catch(_){}

// ================================================================
// V18: DASHBOARD ENHANCEMENTS
// ================================================================

// --- V18 Chart instance tracking for memory leak prevention ---
window.__v18ChartInstances = window.__v18ChartInstances || {};
function __v18DestroyChart(id){
  try{ if(window.__v18ChartInstances[id]){ window.__v18ChartInstances[id].destroy(); delete window.__v18ChartInstances[id]; } }catch(_){}
}
function __v18TrackChart(id, instance){
  __v18DestroyChart(id);
  window.__v18ChartInstances[id] = instance;
}

// --- V18 Feature: Quick Actions Card ---
function __v18RenderQuickActions(dashEl){
  const turma = filtroTurma;
  const isTurma = turma && turma !== 'Todas';
  
  let pend = null;
  try{ if(isTurma && typeof __freqPendenciaHojeTurma==='function') pend = __freqPendenciaHojeTurma(turma, bimestreAtual); }catch(_){}
  const chamadaPending = pend && !pend.skip && (pend.missing || pend.incomplete>0);
  
  let html = '<div class="dash-quick-actions v18-enhanced">';
  if(isTurma && chamadaPending){
    html += '<button class="dash-quick-btn primary" onclick="abrirFrequencia()"><i class="fas fa-clipboard-check"></i> Fazer chamada de hoje</button>';
  } else if(isTurma){
    html += '<button class="dash-quick-btn" onclick="abrirFrequencia()"><i class="fas fa-clipboard-check"></i> Chamada</button>';
  }
  if(isTurma){
    html += '<button class="dash-quick-btn" onclick="mudarVisao(\'alunos\')"><i class="fas fa-pen"></i> Lançar notas</button>';
    html += '<button class="dash-quick-btn" onclick="mudarVisao(\'fechamento\')"><i class="fas fa-table"></i> Fechamento</button>';
  }
  html += '<button class="dash-quick-btn" onclick="mudarVisao(\'calendar\')"><i class="fas fa-calendar"></i> Calendário</button>';
  
  // Bimestre quick filter
  html += '<div class="dash-bim-filter">';
  for(let b=1; b<=4; b++){
    html += '<button class="dash-bim-pill'+(bimestreAtual===b?' active':'')+'" onclick="bimestreAtual='+b+';try{document.querySelectorAll(\'.dash-bim-pill\').forEach(el=>el.classList.remove(\'active\'));this.classList.add(\'active\');}catch(_){}renderizarDashboard();try{atualizarUI();}catch(_){}" title="'+b+'º Bimestre">'+b+'ºB</button>';
  }
  html += '</div></div>';
  
  const div = document.createElement('div');
  div.className = 'v18-enhanced'; div.style.cssText = 'grid-column:1/-1;order:-20;';
  div.innerHTML = html;
  dashEl.insertBefore(div, dashEl.firstChild);
}

// --- V18 Feature: Context-aware Total card ---
function __v18EnhanceTotalCard(dashEl){
  const el = document.getElementById('dashTotal');
  if(!el) return;
  const card = el.closest('.dash-card');
  if(!card) return;
  
  const turma = filtroTurma || 'Todas';
  const h3 = card.querySelector('h3');
  if(h3) h3.innerHTML = '<i class="fas fa-users" style="color:var(--primary);margin-right:4px;"></i> Total de Alunos';
  
  let sub = card.querySelector('.v18-total-sub');
  if(!sub){
    sub = document.createElement('div');
    sub.className = 'v18-total-sub';
    sub.style.cssText = 'font-size:.75rem;color:#64748b;margin-top:4px;';
    card.appendChild(sub);
  }
  sub.innerHTML = '<b>' + escHTML(turma) + '</b> · ' + bimestreAtual + 'º Bimestre';
}

// --- V18 Feature: Progress Indicator ---
function __v18RenderProgress(dashEl){
  const lista = getAlunosFiltrados();
  if(!lista.length) return;
  const bim = bimestreAtual;
  
  let comNota1=0, comNota2=0, comFreq=0;
  const d1 = getDiscById(config.slot1);
  const d2 = getDiscById(config.slot2);
  
  lista.forEach(a => {
    const b = a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const n1 = b.notas_lp; const n2 = b.notas_red;
    try{ if(n1 && !__cmpIsDiscEmpty(n1, d1)) comNota1++; }catch(_){}
    try{ if(n2 && !__cmpIsDiscEmpty(n2, d2)) comNota2++; }catch(_){}
    const f = calcFreqAluno(a.id, bim);
    if(f.total > 0) comFreq++;
  });
  
  const total = lista.length;
  const pctNotas = total > 0 ? Math.round(((comNota1 + comNota2) / (total * 2)) * 100) : 0;
  const pctFreq = total > 0 ? Math.round((comFreq / total) * 100) : 0;
  const pctGeral = Math.round((pctNotas + pctFreq) / 2);
  
  const barColor = pctGeral >= 80 ? '#16a34a' : (pctGeral >= 50 ? '#f59e0b' : '#dc2626');
  const nm1 = d1?.nome || 'Matéria 1';
  const nm2 = d2?.nome || 'Matéria 2';
  
  const html = '<div class="dash-card dash-progress-card v18-enhanced">' +
    '<h3 style="margin:0 0 4px;"><i class="fas fa-tasks" style="color:var(--primary);"></i> Progresso de Lançamento — ' + bim + 'º Bimestre</h3>' +
    '<div class="dash-progress-bar-wrap"><div class="dash-progress-bar-fill" style="width:' + pctGeral + '%;background:' + barColor + ';"></div></div>' +
    '<div style="font-size:.8rem;font-weight:800;color:' + barColor + ';">' + pctGeral + '% concluído</div>' +
    '<div class="dash-progress-row">' +
      '<div class="dash-progress-stat"><i class="fas fa-book" style="color:#2563eb;"></i> ' + escHTML(nm1) + ': <b>' + comNota1 + '/' + total + '</b></div>' +
      '<div class="dash-progress-stat"><i class="fas fa-book" style="color:#ec4899;"></i> ' + escHTML(nm2) + ': <b>' + comNota2 + '/' + total + '</b></div>' +
      '<div class="dash-progress-stat"><i class="fas fa-clipboard-check" style="color:#0d9488;"></i> Frequência: <b>' + comFreq + '/' + total + '</b></div>' +
    '</div></div>';
  
  const div = document.createElement('div');
  div.className = 'v18-enhanced'; div.style.cssText = 'grid-column:1/-1;order:-5;';
  div.innerHTML = html;
  dashEl.appendChild(div);
}

// --- V18 Feature: Highlights / Destaques Card ---
function __v18RenderHighlights(dashEl){
  const lista = getAlunosFiltrados();
  if(lista.length < 3) return;
  const bim = bimestreAtual;
  const items = [];
  
  const alunoData = lista.map(a => {
    const b = a?.bimestres?.[bim]; if(!b) return null;
    _syncBimestreRefs(b);
    const m1 = clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2 = clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    const mg = (m1 + m2) / 2;
    const f = calcFreqAluno(a.id, bim);
    return { id:a.id, nome:a.nome, m1, m2, mg, freq:f.pct, freqTotal:f.total };
  }).filter(Boolean);
  
  // Best average
  const sorted = alunoData.filter(a=>a.mg>0).sort((a,b) => b.mg - a.mg);
  if(sorted.length){
    items.push({ icon:'fa-trophy', color:'#f59e0b', bg:'rgba(245,158,11,.1)', name:sorted[0].nome, desc:'Maior média: ' + sorted[0].mg.toFixed(1) });
  }
  
  // Most improved
  if(bim > 1){
    let bestDelta = -Infinity, bestName = '';
    alunoData.forEach(a => {
      const bPrev = lista.find(al=>al.id===a.id)?.bimestres?.[bim-1];
      if(!bPrev) return;
      _syncBimestreRefs(bPrev);
      const prevMg = (clampNota(calcularMediaDisc(config.slot1, bPrev.notas_lp)) + clampNota(calcularMediaDisc(config.slot2, bPrev.notas_red))) / 2;
      if(prevMg > 0){ const delta = a.mg - prevMg; if(delta > bestDelta){ bestDelta = delta; bestName = a.nome; } }
    });
    if(bestDelta > 0.1){
      items.push({ icon:'fa-arrow-trend-up', color:'#16a34a', bg:'rgba(22,163,74,.1)', name:bestName, desc:'Mais melhorou: +' + bestDelta.toFixed(1) + ' pts' });
    }
  }
  
  // Best frequency
  const freqSorted = alunoData.filter(a=>a.freqTotal>0).sort((a,b) => b.freq - a.freq);
  if(freqSorted.length && freqSorted[0].freq >= 90){
    const perfect = freqSorted.filter(a=>a.freq >= 100).length;
    items.push(perfect > 0
      ? { icon:'fa-medal', color:'#0d9488', bg:'rgba(13,148,136,.1)', name:perfect + ' aluno(s)', desc:'100% de frequência' }
      : { icon:'fa-medal', color:'#0d9488', bg:'rgba(13,148,136,.1)', name:freqSorted[0].nome, desc:'Melhor frequência: ' + freqSorted[0].freq.toFixed(0) + '%' }
    );
  }
  
  // Green students
  const verdes = alunoData.filter(a => a.mg >= 7).length;
  if(verdes > 0) items.push({ icon:'fa-check-circle', color:'#16a34a', bg:'rgba(22,163,74,.1)', name:verdes + ' aluno(s)', desc:'Média ≥ 7 (farol verde)' });
  
  // Near-perfect scores
  const nota10 = alunoData.filter(a => a.m1 >= 9.5 || a.m2 >= 9.5);
  if(nota10.length) items.push({ icon:'fa-star', color:'#7c3aed', bg:'rgba(124,58,237,.1)', name:nota10.length + ' aluno(s)', desc:'Nota ≥ 9.5 em alguma matéria' });
  
  if(!items.length) return;
  
  let html = '<div class="dash-card dash-highlights v18-enhanced"><h3 style="margin:0;"><i class="fas fa-award" style="color:#f59e0b;"></i> Destaques do Bimestre</h3><div class="dash-highlight-grid">';
  items.forEach(it => {
    html += '<div class="dash-highlight-item"><div class="dash-highlight-icon" style="background:' + it.bg + ';color:' + it.color + ';"><i class="fas ' + it.icon + '"></i></div>' +
      '<div class="dash-highlight-info"><div class="dash-highlight-name">' + escHTML(it.name) + '</div><div class="dash-highlight-desc">' + escHTML(it.desc) + '</div></div></div>';
  });
  html += '</div></div>';
  
  const div = document.createElement('div');
  div.className = 'v18-enhanced'; div.style.cssText = 'grid-column:1/-1;order:-4;';
  div.innerHTML = html;
  dashEl.appendChild(div);
}

// --- V18 Feature: Week Agenda Card ---
function __v18RenderAgenda(dashEl){
  const turma = filtroTurma;
  if(!turma || turma === 'Todas') return;
  
  const today = typeof __freqTodayStr==='function' ? __freqTodayStr() : new Date().toISOString().slice(0,10);
  const todayD = new Date(today + 'T12:00:00');
  const dow = todayD.getDay();
  const monday = new Date(todayD);
  monday.setDate(todayD.getDate() - (dow === 0 ? 6 : dow - 1));
  
  const days = [];
  const dowNames = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  const freq = window.__sgpFrequencia || {};
  
  for(let i = 0; i < 5; i++){
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    const ds = typeof __localISODate==='function' ? __localISODate(d) : d.toISOString().slice(0,10);
    const key = turma + '|' + bimestreAtual + '|' + ds;
    const reg = freq[key] || null;
    const isToday = ds === today;
    
    let status = 'none', statusText = '—';
    if(reg){
      const alunosTurma = alunos.filter(a=>a.turma===turma);
      let filled = 0;
      alunosTurma.forEach(a=>{ if(reg[a.id]) filled++; });
      if(filled >= alunosTurma.length){ status = 'done'; statusText = '✓ Completa'; }
      else if(filled > 0){ status = 'pending'; statusText = filled + '/' + alunosTurma.length; }
      else { status = 'pending'; statusText = 'Pendente'; }
    } else if(ds <= today){
      status = ds === today ? 'pending' : 'none';
      statusText = ds === today ? 'Pendente' : 'Sem registro';
    }
    
    let events = [];
    try{
      const planner = window.__sgpPlanner || {};
      Object.keys(planner).forEach(pk => {
        const p = planner[pk];
        if(p && p.data === ds && (!p.turma || p.turma === turma || p.turma === 'Todas')) events.push(p.titulo || p.tipo || 'Evento');
      });
    }catch(_){}
    
    days.push({ ds, dow:dowNames[d.getDay()], dayNum:d.getDate(), isToday, status, statusText, events });
  }
  
  let html = '<div class="dash-card dash-agenda-card v18-enhanced"><h3 style="margin:0 0 4px;"><i class="fas fa-calendar-week" style="color:var(--primary);"></i> Semana — ' + escHTML(turma) + '</h3><div class="dash-agenda-grid">';
  days.forEach(day => {
    html += '<div class="dash-agenda-day' + (day.isToday ? ' today' : '') + '"' + (day.isToday ? ' onclick="abrirFrequencia()" style="cursor:pointer;" title="Clique para abrir chamada"' : '') + '>' +
      '<div class="day-label">' + day.dow + '</div><div class="day-date">' + day.dayNum + '</div>' +
      '<div class="day-status ' + day.status + '">' + day.statusText + '</div>';
    day.events.forEach(ev => { html += '<div style="font-size:.6rem;color:#7c3aed;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + escHTML(ev) + '">📌 ' + escHTML(ev) + '</div>'; });
    html += '</div>';
  });
  html += '</div></div>';
  
  const div = document.createElement('div');
  div.className = 'v18-enhanced'; div.style.cssText = 'grid-column:1/-1;order:-3;';
  div.innerHTML = html;
  dashEl.appendChild(div);
}

// --- V18 Feature: Clickable KPIs ---
function __v18MakeKPIsClickable(dashEl){
  const kpis = dashEl.querySelectorAll('.dash-kpi');
  kpis.forEach(kpi => {
    const label = (kpi.querySelector('.dash-kpi-label')?.textContent || '').toLowerCase();
    kpi.classList.add('clickable');
    if(label.includes('risco')) kpi.onclick = function(){ __v18ShowKPIDetail('risco'); };
    else if(label.includes('frequência') || label.includes('frequencia')) kpi.onclick = function(){ try{ abrirFrequencia(); }catch(_){} };
    else if(label.includes('média') || label.includes('media')) kpi.onclick = function(){ __v18ShowKPIDetail('media'); };
    else if(label.includes('comportamento')) kpi.onclick = function(){ __v18ShowKPIDetail('comportamento'); };
  });
}

function __v18ShowKPIDetail(type){
  const lista = getAlunosFiltrados();
  if(!lista.length) return;
  const bim = bimestreAtual;
  let title = '', rows = [];
  const d1Name = getDiscById(config.slot1)?.nome || 'Mat 1';
  const d2Name = getDiscById(config.slot2)?.nome || 'Mat 2';
  
  lista.forEach(a => {
    const b = a?.bimestres?.[bim]; if(!b) return;
    _syncBimestreRefs(b);
    const m1 = clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
    const m2 = clampNota(calcularMediaDisc(config.slot2, b.notas_red));
    const c = parseFloat(b.comportamento) || 0;
    if(type === 'risco' && (m1 < 5 || m2 < 5)) rows.push({ nome:a.nome, id:a.id, vals:[m1.toFixed(1), m2.toFixed(1), ((m1+m2)/2).toFixed(1)] });
    else if(type === 'media') rows.push({ nome:a.nome, id:a.id, vals:[m1.toFixed(1), m2.toFixed(1), ((m1+m2)/2).toFixed(1)] });
    else if(type === 'comportamento') rows.push({ nome:a.nome, id:a.id, vals:[c.toFixed(1)] });
  });
  
  if(type === 'risco'){ title = 'Alunos em Risco (média < 5)'; rows.sort((a,b) => parseFloat(a.vals[2]) - parseFloat(b.vals[2])); }
  else if(type === 'media'){ title = 'Ranking por Média Geral'; rows.sort((a,b) => parseFloat(b.vals[2]) - parseFloat(a.vals[2])); }
  else if(type === 'comportamento'){ title = 'Comportamento dos Alunos'; rows.sort((a,b) => parseFloat(a.vals[0]) - parseFloat(b.vals[0])); }
  
  let old = document.getElementById('v18KPIDetailOverlay'); if(old) old.remove();
  const overlay = document.createElement('div');
  overlay.id = 'v18KPIDetailOverlay';
  overlay.className = 'modal-overlay';
  overlay.style.display = 'flex';
  overlay.onclick = function(e){ if(e.target === this) this.remove(); };
  
  let tbl = '<table style="width:100%;border-collapse:collapse;font-size:.82rem;"><thead><tr><th style="text-align:left;padding:8px;border-bottom:2px solid var(--border-color);">#</th><th style="text-align:left;padding:8px;border-bottom:2px solid var(--border-color);">Nome</th>';
  if(type === 'comportamento') tbl += '<th style="padding:8px;border-bottom:2px solid var(--border-color);">Nota</th>';
  else tbl += '<th style="padding:8px;border-bottom:2px solid var(--border-color);">' + escHTML(d1Name) + '</th><th style="padding:8px;border-bottom:2px solid var(--border-color);">' + escHTML(d2Name) + '</th><th style="padding:8px;border-bottom:2px solid var(--border-color);">Geral</th>';
  tbl += '</tr></thead><tbody>';
  rows.forEach((r, i) => {
    tbl += '<tr style="' + (i%2 ? 'background:rgba(0,0,0,.02);' : '') + '"><td style="padding:6px 8px;border-bottom:1px solid var(--border-color);">' + (i+1) + '</td>';
    tbl += '<td style="padding:6px 8px;border-bottom:1px solid var(--border-color);text-align:left;cursor:pointer;color:var(--primary);" onclick="try{document.getElementById(\'v18KPIDetailOverlay\').remove();}catch(_){}try{abrirDetalhes(\'' + r.id + '\');}catch(_){}">' + escHTML(r.nome) + '</td>';
    r.vals.forEach(v => {
      const n = parseFloat(v); const col = n >= 7 ? '#16a34a' : (n >= 5 ? '#f59e0b' : '#dc2626');
      tbl += '<td style="padding:6px 8px;border-bottom:1px solid var(--border-color);text-align:center;font-weight:700;color:' + col + ';">' + v + '</td>';
    });
    tbl += '</tr>';
  });
  tbl += '</tbody></table>';
  
  overlay.innerHTML = '<div class="modal-box" style="max-width:700px;max-height:80vh;overflow-y:auto;">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><h2 style="margin:0;"><i class="fas fa-list"></i> ' + escHTML(title) + '</h2>' +
    '<button onclick="this.closest(\'.modal-overlay\').remove()" style="border:none;background:transparent;font-size:1.3rem;cursor:pointer;">&times;</button></div>' +
    '<div style="font-size:.78rem;color:#64748b;margin-bottom:10px;">' + rows.length + ' aluno(s) · ' + bim + 'º Bimestre · Clique no nome para ver detalhes</div>' +
    tbl + '</div>';
  document.body.appendChild(overlay);
  try{ if(typeof __SGP_setupDataHandlers==='function') __SGP_setupDataHandlers(); }catch(_){}
}

// --- V18 Feature: Rich "Todas as turmas" view ---
function __v18RenderTurmaRanking(dashEl){
  const turmasList = (turmas || []).filter(t => t && t !== 'Todas');
  if(turmasList.length < 2) return;
  const bim = bimestreAtual;
  const rankData = [];
  
  turmasList.forEach(t => {
    const lista = alunos.filter(a => a.turma === t);
    if(!lista.length) return;
    let sumMedia=0, nMedia=0, sumFreq=0, nFreq=0, emRisco=0;
    lista.forEach(a => {
      const b = a?.bimestres?.[bim]; if(!b) return;
      _syncBimestreRefs(b);
      const m1 = clampNota(calcularMediaDisc(config.slot1, b.notas_lp));
      const m2 = clampNota(calcularMediaDisc(config.slot2, b.notas_red));
      const mg = (m1 + m2) / 2;
      if(mg > 0){ sumMedia += mg; nMedia++; }
      if(m1 < 5 || m2 < 5) emRisco++;
      const f = calcFreqAluno(a.id, bim);
      if(f.total > 0){ sumFreq += f.pct; nFreq++; }
    });
    rankData.push({ turma:t, total:lista.length, avg:nMedia>0?sumMedia/nMedia:0, avgFreq:nFreq>0?sumFreq/nFreq:0, emRisco, pctRisco:lista.length>0?(emRisco/lista.length*100):0 });
  });
  
  rankData.sort((a,b) => b.avg - a.avg);
  
  let html = '<div class="dash-card dash-turma-rank v18-enhanced"><h3 style="margin:0;"><i class="fas fa-ranking-star" style="color:var(--primary);"></i> Ranking de Turmas — ' + bim + 'º Bimestre</h3><div class="dash-turma-rank-grid">';
  rankData.forEach((td, i) => {
    const medal = i===0?'🥇':(i===1?'🥈':(i===2?'🥉':(i+1)+'º'));
    const mc = td.avg>=7?'#16a34a':(td.avg>=5?'#f59e0b':'#dc2626');
    const fc = td.avgFreq>=75?'#16a34a':(td.avgFreq>=50?'#f59e0b':'#dc2626');
    html += '<div class="dash-turma-rank-item" onclick="selTurma('+__j(td.turma)+');mudarVisao(\'dash\');">' +
      '<div class="trk-name">' + medal + ' ' + escHTML(td.turma) + ' <small style="color:#94a3b8;font-weight:400;">(' + td.total + ' alunos)</small></div>' +
      '<div class="trk-stats">' +
        '<div class="trk-stat">Média<span class="trk-stat-val" style="color:'+mc+';">' + td.avg.toFixed(1) + '</span></div>' +
        '<div class="trk-stat">Frequência<span class="trk-stat-val" style="color:'+fc+';">' + (td.avgFreq>0?td.avgFreq.toFixed(0)+'%':'—') + '</span></div>' +
        '<div class="trk-stat">Em risco<span class="trk-stat-val" style="color:'+(td.pctRisco<=10?'#16a34a':'#dc2626')+';">' + td.emRisco + '</span></div>' +
        '<div class="trk-stat">Verdes<span class="trk-stat-val" style="color:#16a34a;">' + Math.max(0,td.total-td.emRisco) + '</span></div>' +
      '</div><div class="dash-turma-minibar"><div style="width:'+Math.round(td.avg/10*100)+'%;background:'+mc+';"></div></div></div>';
  });
  html += '</div></div>';
  
  const div = document.createElement('div');
  div.className = 'v18-enhanced'; div.style.cssText = 'grid-column:1/-1;order:1;';
  div.innerHTML = html;
  dashEl.appendChild(div);
}

// --- V18 Feature: Collapsible Sections ---
function __v18AddCollapsibleSections(dashEl){
  const hists = dashEl.querySelectorAll('.dash-card.wide');
  let histCards = [];
  hists.forEach(h => {
    const title = h.querySelector('h3');
    if(title && (title.textContent||'').includes('Histograma')) histCards.push(h);
  });
  if(histCards.length >= 2){
    const wrapper = document.createElement('div');
    wrapper.className = 'dash-section v18-section';
    const sectionId = 'v18sec_hist';
    const collapsed = sessionStorage.getItem(sectionId) === '1';
    wrapper.innerHTML = '<div class="dash-section-header" onclick="__v18ToggleSection(\'' + sectionId + '\')"><i class="fas fa-chart-bar" style="color:#64748b;"></i><h4>Histogramas de Notas</h4><span class="dash-section-toggle' + (collapsed?' collapsed':'') + '" id="' + sectionId + '_icon"><i class="fas fa-chevron-down"></i></span></div>';
    const body = document.createElement('div');
    body.className = 'dash-section-body' + (collapsed?' collapsed':'');
    body.id = sectionId + '_body';
    body.style.cssText = 'display:' + (collapsed?'none':'grid') + ';grid-template-columns:1fr;gap:20px;';
    histCards.forEach(c => body.appendChild(c));
    wrapper.appendChild(body);
    dashEl.appendChild(wrapper);
  }
}

function __v18ToggleSection(sectionId){
  const body = document.getElementById(sectionId + '_body');
  const icon = document.getElementById(sectionId + '_icon');
  if(!body) return;
  const isCollapsed = body.style.display === 'none';
  body.style.display = isCollapsed ? 'grid' : 'none';
  if(icon) icon.classList.toggle('collapsed', !isCollapsed);
  try{ sessionStorage.setItem(sectionId, isCollapsed ? '0' : '1'); }catch(_){}
}

// --- V18 Feature: Responsive Heatmap enhancement ---
function __v18EnhanceHeatmap(dashEl){
  if(window.innerWidth < 700){
    dashEl.querySelectorAll('.dash-heatmap-wrap').forEach(w => {
      if(!w.parentElement?.querySelector('.v18-swipe-hint')){
        const h = document.createElement('div');
        h.className = 'v18-swipe-hint';
        h.style.cssText = 'font-size:.65rem;color:#94a3b8;text-align:center;margin-top:4px;';
        h.textContent = '← Deslize para ver mais colunas →';
        w.parentElement?.appendChild(h);
      }
    });
  }
}



// --- V18 Helper: restore original dashboard cards moved into collapsible sections ---
function __v18RestoreMovedDashCards(dashEl){
  try{
    if(!dashEl) return;
    const sections = Array.from(dashEl.querySelectorAll('.v18-section'));
    if(!sections.length) return;
    sections.forEach(sec=>{
      // Move any original dash-card elements back to the main dashboard container
      const body = sec.querySelector('.dash-section-body') || sec;
      const moved = Array.from(body.children).filter(ch => ch && ch.classList && ch.classList.contains('dash-card'));
      moved.forEach(card => dashEl.appendChild(card));
      try{ sec.remove(); }catch(_){ if(sec.parentElement) sec.parentElement.removeChild(sec); }
    });
  }catch(_){}
}
// --- V18 Master Orchestrator ---
function __v18RenderAllEnhancements(){
  const dashEl = document.getElementById('viewDashboard');
  if(!dashEl) return;
  
  // Clean previous v18 elements
  // Restore cards that were moved into collapsible sections (avoid losing original DOM)
  try{ __v18RestoreMovedDashCards(dashEl); }catch(_){ }
  dashEl.querySelectorAll('.v18-enhanced').forEach(el => el.remove());
  dashEl.querySelectorAll('.v18-swipe-hint').forEach(el => el.remove());
  try{ __v18RenderQuickActions(dashEl); }catch(_){}
  try{ __v18EnhanceTotalCard(dashEl); }catch(_){}
  
  if(filtroTurma && filtroTurma !== 'Todas'){
    try{ __v18RenderProgress(dashEl); }catch(_){}
    try{ __v18RenderHighlights(dashEl); }catch(_){}
    try{ __v18RenderAgenda(dashEl); }catch(_){}
  } else {
    try{ __v18RenderTurmaRanking(dashEl); }catch(_){}
  }
  
  try{ __v18MakeKPIsClickable(dashEl); }catch(_){}
  try{ __v18AddCollapsibleSections(dashEl); }catch(_){}
  try{ __v18EnhanceHeatmap(dashEl); }catch(_){}
}

// Hook into render chain
try{
  const __origRenderDashV18 = renderizarDashboard;
  renderizarDashboard = function(){
    __origRenderDashV18();
    try{ __v18RenderAllEnhancements(); }catch(_){}
  };
}catch(_){}

// ================================================================
// PLANNER → CALENDAR SYNC
// ================================================================
try{
  const __origPlannerPersist=plannerPersist;
  plannerPersist=function(){
    __origPlannerPersist();
    // Refresh calendar if visible
    if(visaoAtual==='calendar'){
      try{ renderizarCalendario(); }catch(_){}
    }
  };
}catch(_){}

// ================================================================
// F12: MOBILE PWA IMPROVEMENTS
// ================================================================
(function(){
  // Prevent double-tap zoom on interactive elements
  let lastTap=0;
  document.addEventListener('touchend', function(e){
    const now=Date.now();
    if(now-lastTap<300){
      const btn=e.target.closest('button,.btn-tool,.btn-view,.btn-bim,.btn-primary,.btn-blitz,.search-filter-chip,.turma-item,.mobile-nav button');
      if(btn) e.preventDefault();
    }
    lastTap=now;
  },{passive:false});

  // Swipe right to open sidebar on mobile
  let touchStartX=0, touchStartY=0;
  document.addEventListener('touchstart',function(e){
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
  },{passive:true});
  document.addEventListener('touchend',function(e){
    if(window.innerWidth>980) return;
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=Math.abs(e.changedTouches[0].clientY-touchStartY);
    // Swipe right from left edge to open
    if(touchStartX<30 && dx>80 && dy<60 && !document.body.classList.contains('sidebar-open')){
      document.body.classList.add('sidebar-open');
    }
    // Swipe left to close
    if(dx<-80 && dy<60 && document.body.classList.contains('sidebar-open')){
      document.body.classList.remove('sidebar-open');
    }
  },{passive:true});

  // Close sidebar when pressing back (for PWA)
  window.addEventListener('popstate', function(){
    if(document.body.classList.contains('sidebar-open')){
      document.body.classList.remove('sidebar-open');
    }
  });

  // Add safe-area-inset support for notched phones
  const style=document.createElement('style');
  style.textContent=`
    @supports(padding:env(safe-area-inset-top)){
      .sidebar-toggle{top:calc(12px + env(safe-area-inset-top))!important;}
      @media(max-width:980px){
        main{padding-top:calc(56px + env(safe-area-inset-top))!important;}
      }
      .mobile-nav{padding-bottom:calc(4px + env(safe-area-inset-bottom))!important;}
      @media(max-width:768px){
        main{padding-bottom:calc(70px + env(safe-area-inset-bottom))!important;}
      }
    }
  `;
  document.head.appendChild(style);

  // Fix iOS 100vh bug
  function setVH(){
    const vh=window.innerHeight*0.01;
    document.documentElement.style.setProperty('--vh',`${vh}px`);
  }
  setVH();
  window.addEventListener('resize',setVH);
  window.addEventListener('orientationchange',function(){ setTimeout(setVH,200); });

  // Auto-fullscreen frequency modal on mobile
  if(window.innerWidth<=768){
    const origAbrirFreq=window.abrirFrequencia;
    if(origAbrirFreq){
      window.abrirFrequencia=function(){
        origAbrirFreq.apply(this,arguments);
        setTimeout(()=>{
          try{
            const overlay=document.getElementById('modalFrequencia');
            if(overlay && !overlay.classList.contains('freq-fullscreen')){
              freqToggleFullscreen();
            }
          }catch(_){}
        },100);
      };
    }
  }
})();


// ================================================================
// MOBILE BOTTOM NAVIGATION BAR (Mobile-first)
// ================================================================
(function(){
  // Create mobile nav bar
  const nav=document.createElement('div');
  nav.className='mobile-nav';
  nav.id='mobileNav';
  nav.innerHTML=`
    <button onclick="mobileNavGo('cards')" id="mnHome" class="active"><i class="fas fa-th"></i>Início</button>
    <button onclick="toggleSidebar()" id="mnTurmas"><i class="fas fa-bars"></i>Turmas</button>
    <button onclick="mobileNavGo('lista')" id="mnAlunos"><i class="fas fa-list"></i>Alunos</button>
    <button onclick="mobileNavGo('dash')" id="mnDash"><i class="fas fa-chart-pie"></i>Dashboard</button>
    <button onclick="mobileNavGo('mapa')" id="mnMapa"><i class="fas fa-border-all"></i>Mapa</button>
  `;
  document.body.appendChild(nav);

  window.mobileNavGo=function(view){
    mudarVisao(view);
    updateMobileNav(view);
    // Close drawer when navigating
    try{ if(window.innerWidth<=980) document.body.classList.remove('sidebar-open'); }catch(_){}
  };

  window.updateMobileNav=function(view){
    document.querySelectorAll('.mobile-nav button').forEach(b=>b.classList.remove('active'));
    const map={
      cards:'mnHome',
      lista:'mnAlunos',
      massa:'mnAlunos',
      entregas:'mnAlunos',
      anual:'mnAlunos',
      dash:'mnDash',
      mapa:'mnMapa',
      calendar:'mnHome',
      aulas:'mnHome'
    };
    const btn=document.getElementById(map[view]||'');
    if(btn) btn.classList.add('active');
  };

  // Hook into mudarVisao to update nav
  try{
    const __origMudarVisao=mudarVisao;
    mudarVisao=function(v){
      __origMudarVisao(v);
      updateMobileNav(v);
    };
  }catch(_){}
})();





// ================================================================
// V15 GAME ENGINE — Score, Timer, Feedback, TV Mode, 3 New Games
// ================================================================

// === GLOBAL SCORE TRACKER ===
const actScore = { correct:0, wrong:0, total:0, startTime:0 };
function actScoreReset(){ actScore.correct=0; actScore.wrong=0; actScore.total=0; actScore.startTime=Date.now(); actUpdateGlobalScore(); }
function actScoreHit(isCorrect){ if(isCorrect) actScore.correct++; else actScore.wrong++; actScore.total++; actUpdateGlobalScore(); actFeedback(isCorrect); }
function actUpdateGlobalScore(){
  const el=document.getElementById('actGlobalScore');
  if(el) el.innerHTML=`Placar: <span style="color:#16a34a;">✓${actScore.correct}</span> <span style="color:#dc2626;">✗${actScore.wrong}</span> de ${actScore.total}`;
}
function actGetScoreSummary(){
  const elapsed=Math.round((Date.now()-actScore.startTime)/1000);
  const pct=actScore.total?Math.round(actScore.correct/actScore.total*100):0;
  return {correct:actScore.correct, wrong:actScore.wrong, total:actScore.total, pct, elapsed};
}
function actShowSummary(container){
  const s=actGetScoreSummary();
  const el=document.getElementById(container);
  if(!el) return;
  const emoji=s.pct>=80?'🏆':(s.pct>=60?'👍':(s.pct>=40?'📚':'💪'));
  el.innerHTML=`<div class="act-summary"><h3>${emoji} Sessão Concluída!</h3><div class="big" style="color:${s.pct>=60?'#16a34a':'#dc2626'};">${s.pct}%</div><div class="detail">Acertos: ${s.correct} | Erros: ${s.wrong} | Total: ${s.total}</div><div class="detail">Tempo: ${Math.floor(s.elapsed/60)}min ${s.elapsed%60}s</div></div>`;
}

// === FEEDBACK ANIMATIONS ===
function actFeedback(isCorrect){
  const panel=document.querySelector('#modalAtividades .act-view:not([style*="none"]) .act-panel:last-child .act-panel-body');
  if(!panel) return;
  panel.classList.remove('act-feedback-correct','act-feedback-wrong');
  void panel.offsetWidth; // trigger reflow
  panel.classList.add(isCorrect?'act-feedback-correct':'act-feedback-wrong');
  setTimeout(()=>panel.classList.remove('act-feedback-correct','act-feedback-wrong'),600);
  if(isCorrect) actSpawnConfetti(panel);
}
function actSpawnConfetti(container){
  const colors=['#16a34a','#0ea5e9','#f59e0b','#ec4899','#7c3aed'];
  for(let i=0;i<8;i++){
    const p=document.createElement('div');
    p.className='act-confetti-particle';
    p.style.left=Math.random()*80+10+'%';
    p.style.top='50%';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDelay=Math.random()*0.3+'s';
    container.appendChild(p);
    setTimeout(()=>p.remove(),1000);
  }
}

// === GLOBAL TIMER ===
let actTimerSec=0, actTimerInterval=null, actTimerRemaining=0;
function actSetTimerCfg(){ actTimerSec=parseInt(document.getElementById('actTimerCfg')?.value||'0')||0; }
function actTimerStart(onExpire){
  actTimerStop();
  if(!actTimerSec) return;
  actTimerRemaining=actTimerSec;
  actTimerInterval=setInterval(()=>{
    actTimerRemaining--;
    actUpdateTimerDisplay();
    if(actTimerRemaining<=0){ actTimerStop(); if(onExpire) onExpire(); }
  },1000);
  actUpdateTimerDisplay();
}
function actTimerStop(){ if(actTimerInterval){clearInterval(actTimerInterval);actTimerInterval=null;} }
function actUpdateTimerDisplay(){
  document.querySelectorAll('.sc-timer').forEach(el=>{
    if(!actTimerSec){el.textContent='';return;}
    el.textContent=actTimerRemaining+'s';
    el.className='sc-timer'+(actTimerRemaining<=5?' danger':(actTimerRemaining<=10?' warning':''));
  });
}
function actRenderScorebar(containerId){
  const el=document.getElementById(containerId);
  if(!el) return;
  const s=actScore;
  el.innerHTML=`<div class="act-scorebar"><span class="sc-item sc-correct">✓ ${s.correct}</span><span class="sc-item sc-wrong">✗ ${s.wrong}</span><span class="sc-item sc-total">📊 ${s.total}</span>${actTimerSec?'<span class="sc-timer"></span>':''}</div>`;
}

// === TV MODE ===
let actTVMode=false;
function actToggleTVMode(){
  actTVMode=!actTVMode;
  const modal=document.getElementById('modalAtividades');
  if(modal) modal.classList.toggle('act-tv',actTVMode);
  const btn=document.getElementById('actBtnTV');
  if(btn) btn.innerHTML=actTVMode?'<i class="fas fa-compress"></i> Normal':'<i class="fas fa-desktop"></i> TV';
}

// === PROGRESS BAR HELPER ===
function actProgressHTML(current,total){
  const pct=total?Math.round(current/total*100):0;
  return `<div style="display:flex;align-items:center;gap:8px;"><span>${current}/${total}</span><div class="act-progress" style="flex:1;"><div class="act-progress-fill" style="width:${pct}%;"></div></div></div>`;
}

// ================================================================
// FORCA IMPROVEMENTS (5: progress, 6: dynamic difficulty)
// ================================================================
try{
  const __origForcaStartWord=_forcaStartWord;
  _forcaStartWord=function(w,h,t){
    // F6: Dynamic difficulty — longer words get more attempts
    const len=(w||'').replace(/\s/g,'').length;
    forcaState.maxErr = len>=10 ? 9 : (len>=7 ? 7 : 6);
    __origForcaStartWord(w,h,t);
    // Start timer
    actTimerStart(()=>{
      if(forcaState.active){ forcaState.active=false; forcaState.finished=true; forcaState.lastResult='timeout'; actScoreHit(false); forcaUpdateUI('⏰ Tempo esgotado!'); }
    });
  };
  
  const __origForcaUpdateUI=forcaUpdateUI;
  forcaUpdateUI=function(msg){
    __origForcaUpdateUI(msg);
    // F5: Progress bar in session
    if(forcaSession.started && forcaSession.order.length>0){
      const prog=document.querySelector('#actViewForca .act-mini');
      if(prog){
        const idx=forcaSession.idx+1, total=forcaSession.order.length;
        prog.innerHTML=actProgressHTML(idx,total);
      }
    }
    // Score tracking on finish
    if(forcaState.finished && forcaState.lastResult && !forcaState._scored){
      forcaState._scored=true;
      actScoreHit(forcaState.lastResult==='win');
    }
  };

  const __origForcaIniciarSessao=forcaIniciarSessao;
  forcaIniciarSessao=function(){ actScoreReset(); __origForcaIniciarSessao(); };
  
  // Reset scored flag on new word
  const __origForcaReiniciar=forcaReiniciar;
  forcaReiniciar=function(){ forcaState._scored=false; __origForcaReiniciar(); };
}catch(_){}

// ================================================================
// V/F IMPROVEMENTS (7: explanation, 8: categories)
// ================================================================
try{
  const __origVfUpdateSessionUI=vfUpdateSessionUI;
  vfUpdateSessionUI=function(){
    __origVfUpdateSessionUI();
    // F7: Show explanation prominently after answering
    if(vfState.started && vfState.answered){
      const idx=vfState.order[vfState.idx];
      const item=vfBank[idx];
      if(item){
        const tw=document.getElementById('vfTheoryWrap');
        const tt=document.getElementById('vfTheoryText');
        const correct=item.a===vfState.choice;
        if(tw && tt){
          const expText=item.e||'';
          tw.style.display='block';
          tt.innerHTML=`<div style="font-weight:700;margin-bottom:6px;color:${correct?'#16a34a':'#dc2626'};">${correct?'✓ Correto!':'✗ Incorreto!'} Resposta: ${item.a==='V'?'Verdadeiro':'Falso'}</div>${expText?'<div>'+_escHTML(expText)+'</div>':''}`;
        }
        // Score
        if(!vfState._scoredIdx || vfState._scoredIdx!==vfState.idx){
          vfState._scoredIdx=vfState.idx;
          actScoreHit(correct);
        }
      }
    } else {
      const tw=document.getElementById('vfTheoryWrap');
      if(tw) tw.style.display='none';
    }
    // Progress bar
    if(vfState.started){
      const prog=document.getElementById('vfProgress');
      if(prog) prog.innerHTML=actProgressHTML(vfState.idx+1, vfState.order.length);
    }
    actRenderScorebar('vfScorebar_wrap');
  };

  const __origVfIniciarSessao=vfIniciarSessao;
  vfIniciarSessao=function(){ actScoreReset(); vfState._scoredIdx=-1; __origVfIniciarSessao(); };

  // F7: Timer for VF
  const __origVfResponder=vfResponder;
  // Hook into session start for timer
  const __origVfNext=vfProxima;
  vfProxima=function(){
    __origVfNext();
    if(vfState.started) actTimerStart(()=>{
      if(vfState.started && !vfState.answered){ vfResponder('X'); } // auto-fail on timeout
    });
  };
}catch(_){}

// Add VF scorebar container if missing
try{
  const vfPanel=document.querySelector('#actViewVF .act-panel:last-child .act-panel-body');
  if(vfPanel && !document.getElementById('vfScorebar_wrap')){
    const d=document.createElement('div'); d.id='vfScorebar_wrap';
    vfPanel.insertBefore(d, vfPanel.firstChild);
  }
}catch(_){}

// ================================================================
// MEMORY IMPROVEMENTS (9: timer+record, 10: grid sizes, 11: emoji)
// ================================================================
let memRecord=Infinity, memTimer=null, memTimeElapsed=0;
try{
  // F10: Add more grid size buttons
  const memPanel=document.querySelector('#actViewMem .act-panel:last-child .act-panel-body');
  if(memPanel){
    const actionsDiv=memPanel.querySelector('.actions');
    if(actionsDiv){
      actionsDiv.innerHTML=`
        <button class="btn-planner" data-onclick="memIniciar(4)"><i class="fas fa-play"></i> 4 pares</button>
        <button class="btn-planner" data-onclick="memIniciar(6)"><i class="fas fa-play"></i> 6 pares</button>
        <button class="btn-planner" data-onclick="memIniciar(8)"><i class="fas fa-play"></i> 8 pares</button>
        <button class="btn-planner" data-onclick="memIniciar(12)"><i class="fas fa-play"></i> 12 pares</button>
        <button class="btn-planner" data-onclick="memReiniciar()"><i class="fas fa-rotate"></i> Reiniciar</button>
      `;
      try{['memIniciar','memReiniciar'].forEach(n=>{if(typeof window[n]==='function')__wrapSafeGlobal(n)});}catch(_){}
    }
  }

  // F9: Timer and record tracking
  const __origMemIniciar=memIniciar;
  memIniciar=function(n){
    memTimeElapsed=0;
    if(memTimer) clearInterval(memTimer);
    memTimer=setInterval(()=>{memTimeElapsed++;},1000);
    actScoreReset();
    __origMemIniciar(n);
  };

  // Hook into memory completion
  const __origMemMsg=memMsg;
  memMsg=function(msg){
    if(msg && msg.includes('todos os pares')){
      if(memTimer){clearInterval(memTimer);memTimer=null;}
      if(memState.moves<memRecord) memRecord=memState.moves;
      const recTxt=memRecord<Infinity?` — Recorde: ${memRecord} movimentos`:'';
      __origMemMsg(`🎉 Parabéns! ${memState.moves} movimentos em ${memTimeElapsed}s${recTxt}`);
      actScoreHit(true);
      return;
    }
    __origMemMsg(msg);
  };

  // F11: Emoji/image support in memory cards — handled in memRenderGrid
  const __origMemRenderGrid=memRenderGrid;
  memRenderGrid=function(){
    __origMemRenderGrid();
    // Post-process cards to render emoji/images
    document.querySelectorAll('#memGrid .mem-card').forEach(card=>{
      const text=card.textContent.trim();
      // If content looks like URL, render as image
      if(text.match(/^https?:\/\/.+\.(png|jpg|gif|svg|webp)/i)){
        card.innerHTML=`<img src="${_escHTML(text)}" style="max-width:80px;max-height:60px;object-fit:contain;" onerror="this.parentNode.textContent='❌'">`;
      }
    });
  };
}catch(_){}

// ================================================================
// FLASHCARDS IMPROVEMENTS (12: Leitner, 13: swipe)
// ================================================================
try{
  // F12: Add Leitner buttons after flip
  const fcPanel=document.querySelector('#actViewFC .act-panel:last-child .act-panel-body');
  if(fcPanel && !document.getElementById('fcLeitner')){
    const d=document.createElement('div');
    d.id='fcLeitner';
    d.className='fc-leitner';
    d.style.display='none';
    d.innerHTML=`
      <button class="fc-l-wrong" data-onclick="fcLeitnerMark('wrong')">❌ Não sei</button>
      <button class="fc-l-ok" data-onclick="fcLeitnerMark('ok')">🤔 Quase</button>
      <button class="fc-l-know" data-onclick="fcLeitnerMark('know')">✅ Sei</button>
    `;
    const actions=fcPanel.querySelector('.actions');
    if(actions) fcPanel.insertBefore(d,actions);
    try{__wrapSafeGlobal('fcLeitnerMark');}catch(_){}
  }

  let fcLeitnerBoxes={wrong:[],ok:[],know:[]};
  
  window.fcLeitnerMark=function(box){
    const it=_fcCurrent();
    if(!it) return;
    const idx=fcState.order[fcState.idx];
    // Remove from other boxes
    ['wrong','ok','know'].forEach(b=>{ fcLeitnerBoxes[b]=fcLeitnerBoxes[b].filter(i=>i!==idx); });
    fcLeitnerBoxes[box].push(idx);
    // Auto advance
    fcProximo();
  };

  // Show Leitner buttons when card is flipped
  const __origFcRenderSessao=fcRenderSessao;
  fcRenderSessao=function(){
    __origFcRenderSessao();
    const leitner=document.getElementById('fcLeitner');
    if(leitner) leitner.style.display=(fcState.started && fcState.flipped)?'flex':'none';
  };

  // At end of session, re-queue wrong items first
  const __origFcIniciarSessao=fcIniciarSessao;
  fcIniciarSessao=function(shuffle){
    // If there are "wrong" items from previous session, prioritize them
    if(fcLeitnerBoxes.wrong.length>0 && fcBank.length>0){
      const wrongFirst=[...fcLeitnerBoxes.wrong];
      const rest=fcBank.map((_,i)=>i).filter(i=>!wrongFirst.includes(i));
      fcState.started=true;
      fcState.order=[...wrongFirst,...rest];
      fcState.idx=0;
      fcState.flipped=false;
      fcLeitnerBoxes={wrong:[],ok:[],know:[]};
      atividadesSetLocked(true);
      fcRenderSessao();
      _actToast('Revisando itens que errou primeiro!');
      return;
    }
    fcLeitnerBoxes={wrong:[],ok:[],know:[]};
    __origFcIniciarSessao(shuffle);
  };

  // F13: Swipe support for flashcards
  const fcCardEl=document.getElementById('fcCard');
  if(fcCardEl){
    let fcTouchX=0;
    fcCardEl.addEventListener('touchstart',e=>{fcTouchX=e.touches[0].clientX;},{passive:true});
    fcCardEl.addEventListener('touchend',e=>{
      const dx=e.changedTouches[0].clientX-fcTouchX;
      if(Math.abs(dx)>50){
        if(dx>0) try{fcAnterior();}catch(_){} // swipe right = previous
        else try{fcProximo();}catch(_){} // swipe left = next
      }
    },{passive:true});
  }
}catch(_){}

// ================================================================
// NEW GAME: QUIZ MÚLTIPLA ESCOLHA (14)
// ================================================================
let quizBank=[], quizState={started:false, idx:0, order:[], answered:false};
const QUIZ_STORAGE='sgp_atividades_quiz_bank';
function quizLoad(){ try{quizBank=JSON.parse(localStorage.getItem(QUIZ_STORAGE))||[];}catch(_){quizBank=[];} }
function quizSave(){ try{__safeLSSet(QUIZ_STORAGE,JSON.stringify(quizBank));}catch(_){} }

function quizAdicionar(){
  const q=document.getElementById('quizPerg')?.value?.trim();
  const alts=[document.getElementById('quizA')?.value?.trim(),document.getElementById('quizB')?.value?.trim(),document.getElementById('quizC')?.value?.trim(),document.getElementById('quizD')?.value?.trim()];
  const corr=parseInt(document.getElementById('quizCorreta')?.value||'0');
  const exp=document.getElementById('quizExp')?.value?.trim()||'';
  if(!q||alts.some(a=>!a)) return _actToast('Preencha pergunta e 4 alternativas.','error');
  quizBank.push({q,alts,corr,exp}); quizSave(); quizRenderBank();
  ['quizPerg','quizA','quizB','quizC','quizD','quizExp'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  _actToast('Pergunta adicionada!');
}
function quizRenderBank(){
  const el=document.getElementById('quizList'), cnt=document.getElementById('quizCount');
  if(cnt) cnt.textContent=quizBank.length;
  if(!el) return;
  el.innerHTML=quizBank.map((it,i)=>`<div class="act-list-item"><span>${_escHTML(it.q.substring(0,50))}... <small style="color:#64748b;">[${['A','B','C','D'][it.corr]}]</small></span><button class="btn-planner danger" style="padding:2px 6px;" data-onclick="quizRemover(${i})"><i class="fas fa-trash"></i></button></div>`).join('');
}
function quizRemover(i){ quizBank.splice(i,1); quizSave(); quizRenderBank(); }
function quizLimparBanco(){ if(confirm('Limpar banco do Quiz?')){quizBank=[];quizSave();quizRenderBank();} }

function quizIniciarSessao(){
  if(!quizBank.length) return _actToast('Adicione perguntas.','error');
  atividadesSetLocked(true); actScoreReset();
  quizState.started=true; quizState.idx=0; quizState.answered=false;
  quizState.order=quizBank.map((_,i)=>i).sort(()=>Math.random()-.5);
  quizRenderSessao();
}
function quizRenderSessao(){
  const show=document.getElementById('quizShow'), opts=document.getElementById('quizOptions'), prog=document.getElementById('quizProgress');
  const tw=document.getElementById('quizTheoryWrap'), tt=document.getElementById('quizTheoryText');
  if(!quizState.started){show.textContent='Adicione perguntas para começar.';opts.innerHTML='';return;}
  const it=quizBank[quizState.order[quizState.idx]];
  if(!it){quizState.started=false;actShowSummary('quizMsg');return;}
  if(prog) prog.innerHTML=actProgressHTML(quizState.idx+1,quizState.order.length);
  actRenderScorebar('quizScorebar');
  show.textContent=it.q;
  if(tw) tw.style.display='none';
  const letters=['A','B','C','D'];
  opts.innerHTML=it.alts.map((a,i)=>`<button class="quiz-option" data-onclick="quizResponder(${i})">${letters[i]}) ${_escHTML(a)}</button>`).join('');
  quizState.answered=false;
  actTimerStart(()=>{ if(quizState.started&&!quizState.answered) quizResponder(-1); });
}
function quizResponder(choice){
  if(!quizState.started||quizState.answered) return;
  quizState.answered=true;
  actTimerStop();
  const it=quizBank[quizState.order[quizState.idx]];
  const correct=choice===it.corr;
  actScoreHit(correct);
  // Highlight options
  document.querySelectorAll('.quiz-option').forEach((btn,i)=>{
    if(i===it.corr) btn.classList.add('correct');
    else if(i===choice) btn.classList.add('wrong');
    else btn.classList.add('dimmed');
    btn.style.pointerEvents='none';
  });
  // Show explanation
  const tw=document.getElementById('quizTheoryWrap'),tt=document.getElementById('quizTheoryText');
  if(tw&&it.exp){tw.style.display='block';tt.textContent=it.exp;}
  actRenderScorebar('quizScorebar');
}
function quizProxima(){
  if(!quizState.started) return;
  if(!quizState.answered) return _actToast('Responda antes de avançar.','error');
  quizState.idx++;
  if(quizState.idx>=quizState.order.length){quizState.started=false;actShowSummary('quizMsg');actRenderScorebar('quizScorebar');return;}
  quizRenderSessao();
}

// ================================================================
// NEW GAME: COMPLETAR FRASE (15)
// ================================================================
let compBank=[], compState={started:false, idx:0, order:[], answered:false};
const COMP_STORAGE='sgp_atividades_comp_bank';
function compLoad(){ try{compBank=JSON.parse(localStorage.getItem(COMP_STORAGE))||[];}catch(_){compBank=[];} }
function compSave(){ try{__safeLSSet(COMP_STORAGE,JSON.stringify(compBank));}catch(_){} }

function compAdicionar(){
  const f=document.getElementById('compFrase')?.value?.trim();
  const r=document.getElementById('compResp')?.value?.trim();
  const e=document.getElementById('compExp')?.value?.trim()||'';
  if(!f||!r) return _actToast('Preencha frase e resposta.','error');
  if(!f.includes('___')) return _actToast('Use ___ na frase para marcar a lacuna.','error');
  compBank.push({f,r,e}); compSave(); compRenderBank();
  ['compFrase','compResp','compExp'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  _actToast('Frase adicionada!');
}
function compRenderBank(){
  const el=document.getElementById('compList'),cnt=document.getElementById('compCount');
  if(cnt) cnt.textContent=compBank.length;
  if(!el) return;
  el.innerHTML=compBank.map((it,i)=>`<div class="act-list-item"><span>${_escHTML(it.f.substring(0,50))}... <small style="color:#16a34a;">[${_escHTML(it.r)}]</small></span><button class="btn-planner danger" style="padding:2px 6px;" data-onclick="compRemover(${i})"><i class="fas fa-trash"></i></button></div>`).join('');
}
function compRemover(i){ compBank.splice(i,1); compSave(); compRenderBank(); }
function compLimparBanco(){ if(confirm('Limpar banco?')){compBank=[];compSave();compRenderBank();} }

function compIniciarSessao(){
  if(!compBank.length) return _actToast('Adicione frases.','error');
  atividadesSetLocked(true); actScoreReset();
  compState.started=true; compState.idx=0; compState.answered=false;
  compState.order=compBank.map((_,i)=>i).sort(()=>Math.random()-.5);
  compRenderSessao();
}
function compRenderSessao(){
  const show=document.getElementById('compShow'),inp=document.getElementById('compInputArea'),prog=document.getElementById('compProgress');
  const tw=document.getElementById('compTheoryWrap');
  if(!compState.started){show.textContent='Adicione frases para começar.';inp.style.display='none';return;}
  const it=compBank[compState.order[compState.idx]];
  if(!it){compState.started=false;actShowSummary('compMsg');return;}
  if(prog) prog.innerHTML=actProgressHTML(compState.idx+1,compState.order.length);
  actRenderScorebar('compScorebar');
  // Replace ___ with visual blank
  show.innerHTML=_escHTML(it.f).replace(/___/g,'<span class="comp-blank">&nbsp;</span>');
  inp.style.display='block';
  const answer=document.getElementById('compAnswer');
  if(answer){answer.value='';answer.classList.remove('correct','wrong');answer.focus();}
  if(tw) tw.style.display='none';
  compState.answered=false;
  actTimerStart(()=>{ if(compState.started&&!compState.answered) compVerificar(); });
}
function _compNormalize(s){ return (s||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function compVerificar(){
  if(!compState.started||compState.answered) return;
  compState.answered=true;
  actTimerStop();
  const it=compBank[compState.order[compState.idx]];
  const answer=document.getElementById('compAnswer');
  const userAnswer=answer?.value||'';
  const correct=_compNormalize(userAnswer)===_compNormalize(it.r);
  actScoreHit(correct);
  if(answer) answer.classList.add(correct?'correct':'wrong');
  // Show correct answer and explanation
  const show=document.getElementById('compShow');
  show.innerHTML=_escHTML(it.f).replace(/___/g,`<span class="comp-blank" style="color:${correct?'#16a34a':'#dc2626'};font-weight:700;">${_escHTML(it.r)}</span>`);
  if(!correct && answer) answer.value=answer.value+' → '+it.r;
  const tw=document.getElementById('compTheoryWrap'),tt=document.getElementById('compTheoryText');
  if(tw&&it.e){tw.style.display='block';tt.textContent=it.e;}
  actRenderScorebar('compScorebar');
}
function compProxima(){
  if(!compState.started) return;
  if(!compState.answered) return _actToast('Verifique antes de avançar.','error');
  compState.idx++;
  if(compState.idx>=compState.order.length){compState.started=false;actShowSummary('compMsg');actRenderScorebar('compScorebar');return;}
  compRenderSessao();
}

// ================================================================
// NEW GAME: ORDENAR PALAVRAS (16)
// ================================================================
let ordBank=[], ordState={started:false, idx:0, order:[], answered:false, placed:[]};
const ORD_STORAGE='sgp_atividades_ord_bank';
function ordLoad(){ try{ordBank=JSON.parse(localStorage.getItem(ORD_STORAGE))||[];}catch(_){ordBank=[];} }
function ordSave(){ try{__safeLSSet(ORD_STORAGE,JSON.stringify(ordBank));}catch(_){} }

function ordAdicionar(){
  const f=document.getElementById('ordFrase')?.value?.trim();
  const d=document.getElementById('ordDica')?.value?.trim()||'';
  if(!f||f.split(/\s+/).length<3) return _actToast('Frase deve ter pelo menos 3 palavras.','error');
  ordBank.push({f,d}); ordSave(); ordRenderBank();
  ['ordFrase','ordDica'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  _actToast('Frase adicionada!');
}
function ordRenderBank(){
  const el=document.getElementById('ordList'),cnt=document.getElementById('ordCount');
  if(cnt) cnt.textContent=ordBank.length;
  if(!el) return;
  el.innerHTML=ordBank.map((it,i)=>`<div class="act-list-item"><span>${_escHTML(it.f.substring(0,50))}</span><button class="btn-planner danger" style="padding:2px 6px;" data-onclick="ordRemover(${i})"><i class="fas fa-trash"></i></button></div>`).join('');
}
function ordRemover(i){ ordBank.splice(i,1); ordSave(); ordRenderBank(); }
function ordLimparBanco(){ if(confirm('Limpar banco?')){ordBank=[];ordSave();ordRenderBank();} }

function ordIniciarSessao(){
  if(!ordBank.length) return _actToast('Adicione frases.','error');
  atividadesSetLocked(true); actScoreReset();
  ordState.started=true; ordState.idx=0; ordState.answered=false; ordState.placed=[];
  ordState.order=ordBank.map((_,i)=>i).sort(()=>Math.random()-.5);
  ordRenderSessao();
}
function ordRenderSessao(){
  const words=document.getElementById('ordWords'),answer=document.getElementById('ordAnswer'),prog=document.getElementById('ordProgress'),hint=document.getElementById('ordHint');
  if(!ordState.started){words.innerHTML='';answer.innerHTML='';return;}
  const it=ordBank[ordState.order[ordState.idx]];
  if(!it){ordState.started=false;actShowSummary('ordMsg');return;}
  if(prog) prog.innerHTML=actProgressHTML(ordState.idx+1,ordState.order.length);
  actRenderScorebar('ordScorebar');
  if(hint&&it.d){hint.style.display='block';hint.innerHTML='💡 '+_escHTML(it.d);}else if(hint) hint.style.display='none';
  // Shuffle words
  const wordArr=it.f.split(/\s+/);
  const shuffled=[...wordArr].sort(()=>Math.random()-.5);
  ordState.placed=[];
  ordState.answered=false;
  ordState._words=wordArr;
  ordState._shuffled=shuffled;
  words.innerHTML=shuffled.map((w,i)=>`<button class="ord-word" data-onclick="ordSelectWord(${i})">${_escHTML(w)}</button>`).join('');
  answer.innerHTML='';
  actTimerStart(()=>{ if(ordState.started&&!ordState.answered) ordVerificar(); });
}
window.ordSelectWord=function(i){
  if(ordState.answered) return;
  const words=document.getElementById('ordWords'),answer=document.getElementById('ordAnswer');
  const btns=words.querySelectorAll('.ord-word');
  if(btns[i]&&!btns[i].classList.contains('placed')){
    btns[i].classList.add('placed');
    ordState.placed.push(ordState._shuffled[i]);
    const wb=document.createElement('button');
    wb.className='ord-word';
    wb.textContent=ordState._shuffled[i];
    wb.setAttribute('data-onclick',`ordRemoveWord(${ordState.placed.length-1})`);
    answer.appendChild(wb);
  }
};
window.ordRemoveWord=function(i){
  if(ordState.answered) return;
  ordState.placed.splice(i,1);
  // Rebuild answer and source
  const answer=document.getElementById('ordAnswer'),words=document.getElementById('ordWords');
  answer.innerHTML=ordState.placed.map((w,j)=>`<button class="ord-word" data-onclick="ordRemoveWord(${j})">${_escHTML(w)}</button>`).join('');
  // Reset source highlights
  const btns=words.querySelectorAll('.ord-word');
  btns.forEach(b=>b.classList.remove('placed'));
  const usedCounts={};
  ordState.placed.forEach(w=>{usedCounts[w]=(usedCounts[w]||0)+1;});
  btns.forEach((b,idx)=>{
    const w=ordState._shuffled[idx];
    if(usedCounts[w]>0){b.classList.add('placed');usedCounts[w]--;}
  });
};
function ordLimpar(){
  ordState.placed=[];
  const answer=document.getElementById('ordAnswer'),words=document.getElementById('ordWords');
  if(answer) answer.innerHTML='';
  if(words) words.querySelectorAll('.ord-word').forEach(b=>b.classList.remove('placed'));
}
function ordVerificar(){
  if(!ordState.started||ordState.answered) return;
  if(ordState.placed.length===0) return _actToast('Ordene as palavras primeiro.','error');
  ordState.answered=true;
  actTimerStop();
  const correct=ordState.placed.join(' ')===ordState._words.join(' ');
  actScoreHit(correct);
  // Color answer words
  const answerEl=document.getElementById('ordAnswer');
  answerEl.querySelectorAll('.ord-word').forEach((b,i)=>{
    if(ordState._words[i]&&b.textContent===ordState._words[i]) b.classList.add('correct');
    else b.classList.add('wrong');
  });
  if(!correct){
    const msg=document.getElementById('ordMsg');
    if(msg) msg.innerHTML='Ordem correta: <b>'+_escHTML(ordState._words.join(' '))+'</b>';
  }
  actRenderScorebar('ordScorebar');
}
function ordProxima(){
  if(!ordState.started) return;
  if(!ordState.answered) return _actToast('Verifique antes de avançar.','error');
  document.getElementById('ordMsg').innerHTML='';
  ordState.idx++;
  if(ordState.idx>=ordState.order.length){ordState.started=false;actShowSummary('ordMsg');actRenderScorebar('ordScorebar');return;}
  ordRenderSessao();
}

// ================================================================
// EXPORT/IMPORT ENHANCEMENTS (19)
// ================================================================
try{
  const __origExportAll=atividadesExportAll;
  atividadesExportAll=function(){
    const payload={
      version:'sgp_atividades_v2',
      exportedAt:new Date().toISOString(),
      forcaBank, vfBank, memBank, fcBank,
      quizBank: quizBank||[],
      compBank: compBank||[],
      ordBank: ordBank||[]
    };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='SGP_Atividades_Backup.json';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
  };

  // Enhance import to include new games
  const __origImportFile=atividadesImportFile;
  atividadesImportFile=function(input){
    const file=input?.files?.[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        const data=JSON.parse(e.target.result);
        // Use original import for base games
        __origImportFile.call(null,{files:[file]});
        // Also import new games
        setTimeout(()=>{
          if(Array.isArray(data.quizBank)){ quizBank=data.quizBank; quizSave(); quizRenderBank(); }
          if(Array.isArray(data.compBank)){ compBank=data.compBank; compSave(); compRenderBank(); }
          if(Array.isArray(data.ordBank)){ ordBank=data.ordBank; ordSave(); ordRenderBank(); }
        },500);
      }catch(_){ _actToast('Erro ao importar.','error'); }
    };
    reader.readAsText(file);
  };
}catch(_){}

// ================================================================
// INIT NEW GAMES
// ================================================================
try{
  quizLoad(); compLoad(); ordLoad();
  quizRenderBank(); compRenderBank(); ordRenderBank();
}catch(_){}

// Whitelist new functions
try{
  ['quizAdicionar','quizRemover','quizLimparBanco','quizIniciarSessao','quizResponder','quizProxima',
   'compAdicionar','compRemover','compLimparBanco','compIniciarSessao','compVerificar','compProxima',
   'ordAdicionar','ordRemover','ordLimparBanco','ordIniciarSessao','ordVerificar','ordProxima','ordLimpar',
   'ordSelectWord','ordRemoveWord','actToggleTVMode','actSetTimerCfg','fcLeitnerMark','memIniciar'
  ].forEach(n=>{ if(typeof __wrapSafeGlobal==='function' && typeof window[n]==='function') __wrapSafeGlobal(n); });
}catch(_){}

// ================================================================
// FEATURE 17: VINCULAR ATIVIDADES A AULAS DO CRONOGRAMA
// ================================================================
// Add "Jogar" button to each aula in the cronograma view
try{
  const __origRenderAulas = renderizarAulas;
  renderizarAulas = function(){
    __origRenderAulas();
    // After rendering, add game buttons to each aula row
    document.querySelectorAll('.aula-item, .aula-row, [data-aula-id]').forEach(el => {
      if(el.querySelector('.aula-game-btn')) return;
      const btn = document.createElement('button');
      btn.className = 'btn-planner aula-game-btn';
      btn.style.cssText = 'padding:3px 8px;font-size:.72rem;margin-left:4px;';
      btn.innerHTML = '<i class="fas fa-gamepad"></i>';
      btn.title = 'Abrir atividades';
      btn.setAttribute('data-onclick', 'abrirAtividadesFromAula()');
      const actionsArea = el.querySelector('.aula-actions, .actions') || el;
      actionsArea.appendChild(btn);
    });
  };
}catch(_){}

function abrirAtividadesFromAula(){
  try{ abrirModal('modalAtividades'); }catch(_){}
}

// ================================================================
// FEATURE 18: GROUP SCORING (Groups mode for TV)
// ================================================================
let actGroups = [];
function actGroupSetup(){
  const n = prompt('Quantos grupos? (2-8):', '4');
  const num = parseInt(n);
  if(!num || num < 2 || num > 8) return _actToast('Número inválido.', 'error');
  const colors = ['#dc2626','#2563eb','#16a34a','#f59e0b','#7c3aed','#ec4899','#0d9488','#ea580c'];
  const names = ['Vermelho','Azul','Verde','Amarelo','Roxo','Rosa','Turquesa','Laranja'];
  actGroups = [];
  for(let i = 0; i < num; i++){
    actGroups.push({ name: names[i] || 'Grupo '+(i+1), color: colors[i] || '#64748b', score: 0 });
  }
  actRenderGroupScore();
  _actToast(`${num} grupos criados!`);
}

function actGroupPoint(idx, pts){
  if(!actGroups[idx]) return;
  actGroups[idx].score += pts;
  actRenderGroupScore();
}

function actRenderGroupScore(){
  const el = document.getElementById('actGlobalScore');
  if(!el || !actGroups.length) return;
  let html = '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">';
  actGroups.forEach((g,i) => {
    html += `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;background:${g.color}22;border:2px solid ${g.color};font-weight:700;font-size:.85rem;cursor:pointer;" onclick="actGroupPoint(${i},1)" title="Clique para +1 ponto">
      <span style="color:${g.color};">${_escHTML(g.name)}</span>
      <span style="font-size:1.1rem;">${g.score}</span>
    </span>`;
  });
  html += '<button style="padding:2px 6px;border:1px solid #cbd5e1;border-radius:4px;background:transparent;cursor:pointer;font-size:.65rem;" onclick="actGroupSetup()">⚙️</button>';
  html += '</div>';
  el.innerHTML = html;
}

// Add groups button to global score area
try{
  const scoreEl = document.getElementById('actGlobalScore');
  if(scoreEl && !scoreEl.dataset.groupInit){
    scoreEl.dataset.groupInit = '1';
    const origHTML = scoreEl.innerHTML;
    scoreEl.innerHTML = origHTML + ' <button style="padding:2px 8px;border:1px solid #cbd5e1;border-radius:6px;background:transparent;cursor:pointer;font-size:.72rem;" onclick="actGroupSetup()"><i class="fas fa-users"></i> Grupos</button>';
  }
}catch(_){}

// Whitelist group functions
try{
  ['actGroupSetup','actGroupPoint','abrirAtividadesFromAula'].forEach(n=>{
    if(typeof __wrapSafeGlobal==='function' && typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){}

// ================================================================
// SOUND EFFECTS (Web Audio API)
// ================================================================
let actSoundEnabled = true;
let _actAudioCtx = null;
function _actGetAudioCtx(){ if(!_actAudioCtx) try{ _actAudioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(_){} return _actAudioCtx; }

function actPlaySound(type){
  if(!actSoundEnabled) return;
  var ctx = _actGetAudioCtx(); if(!ctx) return;
  try{
    var osc = ctx.createOscillator();
    var gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.22, ctx.currentTime);
    if(type==='hit'){
      osc.type='sine';
      osc.frequency.setValueAtTime(523,ctx.currentTime);
      osc.frequency.setValueAtTime(659,ctx.currentTime+0.08);
      osc.frequency.setValueAtTime(784,ctx.currentTime+0.16);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.35);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+0.35);
    } else if(type==='miss'){
      osc.type='sawtooth';
      osc.frequency.setValueAtTime(280,ctx.currentTime);
      osc.frequency.setValueAtTime(180,ctx.currentTime+0.2);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.35);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+0.35);
    } else if(type==='tick'){
      osc.type='sine'; osc.frequency.setValueAtTime(1200,ctx.currentTime);
      gain.gain.setValueAtTime(0.08,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.03);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+0.04);
    } else if(type==='win'){
      osc.type='sine';
      osc.frequency.setValueAtTime(523,ctx.currentTime);
      osc.frequency.setValueAtTime(659,ctx.currentTime+0.12);
      osc.frequency.setValueAtTime(784,ctx.currentTime+0.24);
      osc.frequency.setValueAtTime(1047,ctx.currentTime+0.36);
      gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.55);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+0.55);
    }
  }catch(_){}
}

// Patch actScoreHit to add sounds
(function(){
  var _origHit = actScoreHit;
  actScoreHit = function(isCorrect){
    _origHit(isCorrect);
    try{ actPlaySound(isCorrect ? 'hit' : 'miss'); }catch(_){}
  };
})();

// ================================================================
// RANKING DE ALUNOS
// ================================================================
let actRankingData = {};
function actRankingOpen(){
  if(typeof filtroTurma==='undefined'||filtroTurma==='Todas'){
    try{_actToast('Selecione uma turma primeiro.','error');}catch(_){try{showToast('Selecione uma turma primeiro.','error');}catch(_){}}
    return;
  }
  var lista=(typeof alunos!=='undefined'?alunos:[]).filter(function(a){return a.turma===filtroTurma;}).sort(function(a,b){return(a.nome||'').localeCompare(b.nome||'');});
  if(!lista.length) return _actToast('Nenhum aluno nesta turma.','error');
  // Init scores
  lista.forEach(function(a){ if(!actRankingData[a.id]) actRankingData[a.id]=0; });
  _actRankingRender(lista);
}
function _actRankingRender(lista){
  if(!lista){
    lista=(typeof alunos!=='undefined'?alunos:[]).filter(function(a){return a.turma===filtroTurma;}).sort(function(a,b){return(a.nome||'').localeCompare(b.nome||'');});
  }
  var sorted=lista.slice().sort(function(a,b){ return (actRankingData[b.id]||0)-(actRankingData[a.id]||0); });
  var old=document.getElementById('actRankingOverlay');
  if(old) old.remove();
  var ov=document.createElement('div');
  ov.id='actRankingOverlay'; ov.className='ranking-overlay';
  ov.onclick=function(e){if(e.target===ov)ov.remove();};
  var medals=['🥇','🥈','🥉'];
  var h='<div class="ranking-box"><div style="display:flex;justify-content:space-between;align-items:center;"><h2 style="margin:0;"><i class="fas fa-trophy" style="color:#f59e0b;"></i> Ranking — '+_escHTML(filtroTurma)+'</h2><button onclick="this.closest(\'.ranking-overlay\').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;">&times;</button></div>';
  h+='<div class="ranking-list">';
  sorted.forEach(function(a,i){
    var pts=actRankingData[a.id]||0;
    var medal=i<3?medals[i]:(i+1);
    h+='<div class="ranking-row"><span class="ranking-pos">'+medal+'</span><span class="ranking-name">'+_escHTML(a.nome)+'</span><span class="ranking-btns"><button class="rk-minus" onclick="actRankingPt(\''+a.id+'\',-1)">−</button></span><span class="ranking-score">'+pts+'</span><span class="ranking-btns"><button class="rk-plus" onclick="actRankingPt(\''+a.id+'\',1)">+</button></span></div>';
  });
  h+='</div>';
  h+='<div style="display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap;"><button class="btn-planner" onclick="actRankingReset()"><i class="fas fa-rotate"></i> Zerar</button><button class="btn-planner" onclick="actRankingCopy()"><i class="fas fa-copy"></i> Copiar</button></div></div>';
  ov.innerHTML=h;
  document.body.appendChild(ov);
}
function actRankingPt(id,pts){ actRankingData[id]=(actRankingData[id]||0)+pts; _actRankingRender(); }
function actRankingReset(){ actRankingData={}; _actRankingRender(); _actToast('Ranking zerado.'); }
function actRankingCopy(){
  var lista=(typeof alunos!=='undefined'?alunos:[]).filter(function(a){return a.turma===filtroTurma;});
  var sorted=lista.slice().sort(function(a,b){return(actRankingData[b.id]||0)-(actRankingData[a.id]||0);});
  var t='🏆 Ranking — '+filtroTurma+'\n';
  sorted.forEach(function(a,i){ t+=(i+1)+'º '+a.nome+': '+(actRankingData[a.id]||0)+' pts\n'; });
  navigator.clipboard.writeText(t).then(function(){_actToast('Copiado!');}).catch(function(){_actToast('Erro ao copiar','error');});
}

// ================================================================
// QR CODE (loads library from CDN, fallback to text)
// ================================================================
function actQROpen(){
  var old=document.getElementById('actQROverlay');
  if(old) old.remove();
  var ov=document.createElement('div');
  ov.id='actQROverlay'; ov.className='ranking-overlay';
  ov.onclick=function(e){if(e.target===ov)ov.remove();};
  var h='<div class="ranking-box" style="width:600px;text-align:center;">';
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><h2 style="margin:0;"><i class="fas fa-qrcode" style="color:#7c3aed;"></i> QR Code</h2><button onclick="this.closest(\'.ranking-overlay\').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;">&times;</button></div>';
  h+='<div style="margin-bottom:12px;"><label style="font-size:.82rem;font-weight:600;">Texto/URL para QR</label><textarea id="actQRText" class="inp" rows="3" style="width:100%;" placeholder="Cole aqui o texto ou URL para gerar o QR Code...">'+window.location.href+'</textarea></div>';
  h+='<button class="btn-primary" onclick="actQRGenerate()" style="margin-bottom:16px;"><i class="fas fa-qrcode"></i> Gerar QR</button>';
  h+='<div id="actQRDisplay" style="display:flex;justify-content:center;padding:20px;background:#fff;border-radius:12px;min-height:100px;"></div>';
  h+='<div style="font-size:.72rem;color:#64748b;margin-top:10px;">Projete na TV para os alunos escanearem.</div>';
  h+='</div>';
  ov.innerHTML=h;
  document.body.appendChild(ov);
  setTimeout(function(){ actQRGenerate(); },100);
}

function actQRGenerate(){
  var text=(document.getElementById('actQRText')||{}).value||'';
  if(!text.trim()) return;
  var container=document.getElementById('actQRDisplay');
  if(!container) return;
  container.innerHTML='<div style="color:#64748b;">Gerando...</div>';
  // Try QRCode library
  if(window.QRCode){
    container.innerHTML='';
    new QRCode(container,{text:text,width:280,height:280,colorDark:'#1e293b',colorLight:'#ffffff'});
    return;
  }
  // Load from CDN
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
  s.onload=function(){
    container.innerHTML='';
    new QRCode(container,{text:text,width:280,height:280,colorDark:'#1e293b',colorLight:'#ffffff'});
  };
  s.onerror=function(){
    container.innerHTML='<div style="padding:16px;"><div style="font-size:.9rem;color:#dc2626;margin-bottom:8px;">QR offline indisponível.</div><div style="padding:10px;background:#f1f5f9;border-radius:8px;word-break:break-all;font-size:.78rem;">'+_escHTML(text)+'</div><div style="margin-top:8px;font-size:.72rem;color:#64748b;">Copie o link acima e compartilhe com os alunos.</div></div>';
  };
  document.head.appendChild(s);
}

// ================================================================
// RELACIONAR COLUNAS
// ================================================================
var relState={started:false,pairs:[],matched:0,selectedLeft:null};

function relRenderBank(){
  var el=document.getElementById('relCount'); if(el) el.textContent=relBank.length;
  var list=document.getElementById('relList'); if(!list) return;
  if(!relBank.length){list.innerHTML='<div class="act-mini">Nenhum par cadastrado.</div>';return;}
  list.innerHTML=relBank.map(function(p,i){
    return '<div class="act-list-item" style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;"><span>'+_escHTML(p.a)+' → '+_escHTML(p.b)+'</span><button class="btn-planner danger" style="padding:2px 8px;font-size:.7rem;" onclick="relBank.splice('+i+',1);_actSaveAll();relRenderBank();">✕</button></div>';
  }).join('');
}
function relAdicionar(){
  var a=(document.getElementById('relA')||{}).value||'';
  var b=(document.getElementById('relB')||{}).value||'';
  if(!a.trim()||!b.trim()) return _actToast('Preencha ambos os campos.','error');
  relBank.push({a:a.trim(),b:b.trim()}); _actSaveAll(); relRenderBank();
  document.getElementById('relA').value=''; document.getElementById('relB').value='';
  _actToast('Par adicionado!');
}
function relLimparBanco(){ if(!confirm('Limpar banco?')) return; relBank=[]; _actSaveAll(); relRenderBank(); _actToast('Banco limpo.'); }
function relIniciar(){
  if(relBank.length<2) return _actToast('Adicione pelo menos 2 pares.','error');
  actScoreReset();
  var pairs=relBank.slice();
  // Shuffle right side
  var left=pairs.map(function(p,i){return{text:p.a,idx:i};});
  var right=pairs.map(function(p,i){return{text:p.b,idx:i};});
  // Shuffle both
  for(var i=left.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=left[i];left[i]=left[j];left[j]=t;}
  for(var i=right.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=right[i];right[i]=right[j];right[j]=t;}
  relState={started:true,pairs:pairs,left:left,right:right,matched:0,selectedLeft:null,matchedSet:{}};
  _relRender();
}
function _relRender(){
  var board=document.getElementById('relBoard');
  if(!board) return;
  var s=relState;
  var colors=['#7c3aed','#0ea5e9','#16a34a','#f59e0b','#ec4899','#dc2626','#0d9488','#6366f1','#ea580c','#84cc16'];
  var h='<div class="rel-col">';
  s.left.forEach(function(item,i){
    var matched=s.matchedSet['L'+i];
    var sel=s.selectedLeft===i&&!matched;
    var cls='rel-item'+(sel?' selected':'')+(matched?' matched':'');
    var style=matched?'border-color:'+colors[item.idx%colors.length]+';background:'+colors[item.idx%colors.length]+'22;':'';
    h+='<div class="'+cls+'" style="'+style+'" onclick="relClickLeft('+i+')">'+_escHTML(item.text)+'</div>';
  });
  h+='</div><div class="rel-col">';
  s.right.forEach(function(item,i){
    var matched=s.matchedSet['R'+i];
    var cls='rel-item'+(matched?' matched':'');
    var style=matched?'border-color:'+colors[item.idx%colors.length]+';background:'+colors[item.idx%colors.length]+'22;':'';
    h+='<div class="'+cls+'" style="'+style+'" onclick="relClickRight('+i+')">'+_escHTML(item.text)+'</div>';
  });
  h+='</div>';
  board.innerHTML=h;
  actRenderScorebar('relScorebar');
  if(s.matched>=s.pairs.length){
    actPlaySound('win');
    actShowSummary('relMsg');
  }
}
function relClickLeft(i){
  if(relState.matchedSet['L'+i]) return;
  relState.selectedLeft=i;
  _relRender();
}
function relClickRight(i){
  if(relState.selectedLeft===null||relState.matchedSet['R'+i]) return;
  var li=relState.selectedLeft;
  var correct=relState.left[li].idx===relState.right[i].idx;
  actScoreHit(correct);
  if(correct){
    relState.matchedSet['L'+li]=true;
    relState.matchedSet['R'+i]=true;
    relState.matched++;
  } else {
    // Flash wrong
    var board=document.getElementById('relBoard');
    var rights=board.querySelectorAll('.rel-col:last-child .rel-item');
    if(rights[i]) rights[i].classList.add('wrong');
    setTimeout(function(){if(rights[i])rights[i].classList.remove('wrong');},400);
  }
  relState.selectedLeft=null;
  _relRender();
}

// ================================================================
// ROLETA
// ================================================================
var roletaSpinning=false;
function roletaRenderList(){
  var el=document.getElementById('roletaCount'); if(el) el.textContent=roletaBank.length;
  var list=document.getElementById('roletaList'); if(!list) return;
  if(!roletaBank.length){list.innerHTML='<div class="act-mini">Nenhum item.</div>';return;}
  list.innerHTML=roletaBank.map(function(t,i){
    return '<div style="display:flex;justify-content:space-between;padding:3px 6px;font-size:.82rem;"><span>'+_escHTML(t)+'</span><button class="btn-planner danger" style="padding:1px 6px;font-size:.65rem;" onclick="roletaBank.splice('+i+',1);_actSaveAll();roletaRenderList();roletaDraw();">✕</button></div>';
  }).join('');
  roletaDraw();
}
function roletaAdd(){
  var v=(document.getElementById('roletaItem')||{}).value||'';
  if(!v.trim()) return;
  roletaBank.push(v.trim()); _actSaveAll(); roletaRenderList();
  document.getElementById('roletaItem').value='';
}
function roletaFromBank(type){
  var items=[];
  if(type==='forca') items=forcaBank.map(function(x){return x.w;});
  else if(type==='vf') items=vfBank.map(function(x){return x.t.substring(0,60);});
  else if(type==='fc') items=fcBank.map(function(x){return x.f;});
  if(!items.length) return _actToast('Banco vazio.','error');
  roletaBank=items.slice(); _actSaveAll(); roletaRenderList();
  _actToast(items.length+' itens importados!');
}
function roletaFromAlunos(){
  if(typeof filtroTurma==='undefined'||filtroTurma==='Todas') return _actToast('Selecione uma turma.','error');
  var lista=(typeof alunos!=='undefined'?alunos:[]).filter(function(a){return a.turma===filtroTurma;});
  if(!lista.length) return _actToast('Nenhum aluno.','error');
  roletaBank=lista.map(function(a){return a.nome;}); _actSaveAll(); roletaRenderList();
  _actToast(lista.length+' alunos importados!');
}
function roletaLimpar(){ roletaBank=[]; _actSaveAll(); roletaRenderList(); }

function roletaDraw(highlight){
  var canvas=document.getElementById('roletaCanvas');
  if(!canvas||!roletaBank.length) return;
  var ctx=canvas.getContext('2d');
  var W=640,H=640,cx=W/2,cy=H/2,r=280;
  ctx.clearRect(0,0,W,H);
  var n=roletaBank.length;
  var colors=['#7c3aed','#0ea5e9','#16a34a','#f59e0b','#ec4899','#dc2626','#0d9488','#6366f1','#ea580c','#84cc16','#475569','#a855f7'];
  var arc=2*Math.PI/n;
  for(var i=0;i<n;i++){
    var a0=arc*i-Math.PI/2;
    var a1=a0+arc;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]; ctx.fill();
    ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
    // Text
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a0+arc/2);
    ctx.textAlign='right'; ctx.fillStyle='#fff'; ctx.font='bold '+(n>12?'14':'18')+'px Arial';
    var txt=roletaBank[i].length>18?roletaBank[i].substring(0,16)+'…':roletaBank[i];
    ctx.fillText(txt,r-16,5);
    ctx.restore();
  }
  // Center circle
  ctx.beginPath(); ctx.arc(cx,cy,30,0,2*Math.PI); ctx.fillStyle='#fff'; ctx.fill();
  ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=3; ctx.stroke();
}

var _roletaAngle=0;
function roletaSpin(){
  if(roletaSpinning||roletaBank.length<2) return _actToast('Adicione pelo menos 2 itens.','error');
  roletaSpinning=true;
  var n=roletaBank.length;
  var totalSpin=2*Math.PI*(5+Math.random()*5); // 5-10 full rotations
  var duration=3000+Math.random()*2000;
  var start=performance.now();
  var startAngle=_roletaAngle;
  var canvas=document.getElementById('roletaCanvas');
  var resultEl=document.getElementById('roletaResult');
  if(resultEl) resultEl.className='roleta-result';

  function easeOut(t){return 1-Math.pow(1-t,3);}
  var lastTick=0;

  function animate(now){
    var elapsed=now-start;
    var t=Math.min(elapsed/duration,1);
    var ease=easeOut(t);
    _roletaAngle=startAngle+totalSpin*ease;
    // Rotate canvas
    if(canvas){
      canvas.style.transform='rotate('+_roletaAngle+'rad)';
    }
    // Tick sound at sector boundaries
    var sectorIdx=Math.floor((_roletaAngle%(2*Math.PI))/(2*Math.PI)*n);
    if(sectorIdx!==lastTick&&t<0.85){lastTick=sectorIdx;actPlaySound('tick');}

    if(t<1){requestAnimationFrame(animate);}
    else{
      roletaSpinning=false;
      // Determine winner
      var finalAngle=((_roletaAngle%(2*Math.PI))+(2*Math.PI))%(2*Math.PI);
      var winIdx=Math.floor(((2*Math.PI-finalAngle+Math.PI/2)%(2*Math.PI))/(2*Math.PI)*n)%n;
      if(winIdx<0) winIdx=0;
      if(resultEl){
        resultEl.textContent='🎯 '+roletaBank[winIdx];
        resultEl.className='roleta-result show';
      }
      actPlaySound('win');
    }
  }
  requestAnimationFrame(animate);
}

// ================================================================
// CAÇA-PALAVRAS
// ================================================================
var wsState={grid:[],words:[],placed:[],found:[],size:15};

function wsFromForca(){
  if(!forcaBank.length) return _actToast('Banco da Forca vazio.','error');
  var words=forcaBank.map(function(x){return x.w;}).join('\n');
  var el=document.getElementById('wsWords'); if(el) el.value=words;
  _actToast(forcaBank.length+' palavras importadas!');
}

function wsGerar(){
  var raw=(document.getElementById('wsWords')||{}).value||'';
  var words=raw.split('\n').map(function(w){return w.trim().toUpperCase().replace(/[^A-ZÁÉÍÓÚÂÊÔÃÕÇ]/g,'');}).filter(function(w){return w.length>=2;});
  if(!words.length) return _actToast('Adicione palavras.','error');
  var size=parseInt((document.getElementById('wsSize')||{}).value)||15;
  // Limit words that fit
  words=words.filter(function(w){return w.length<=size;}).slice(0,20);
  if(!words.length) return _actToast('Palavras muito longas para a grade.','error');

  // Generate grid
  var grid=[];
  for(var r=0;r<size;r++){grid[r]=[];for(var c=0;c<size;c++) grid[r][c]='';}

  var dirs=[[0,1],[1,0],[1,1],[0,-1],[-1,0],[-1,-1],[1,-1],[-1,1]]; // H,V,D...
  var placed=[];

  words.sort(function(a,b){return b.length-a.length;}); // longest first
  words.forEach(function(word){
    var attempts=0,ok=false;
    while(attempts<100&&!ok){
      var d=dirs[Math.floor(Math.random()*dirs.length)];
      var dr=d[0],dc=d[1];
      var maxR=dr>0?size-word.length:(dr<0?word.length-1:size-1);
      var minR=dr>0?0:(dr<0?word.length-1:0);
      var maxC=dc>0?size-word.length:(dc<0?word.length-1:size-1);
      var minC=dc>0?0:(dc<0?word.length-1:0);
      if(minR>maxR||minC>maxC){attempts++;continue;}
      var sr=minR+Math.floor(Math.random()*(maxR-minR+1));
      var sc=minC+Math.floor(Math.random()*(maxC-minC+1));
      var canPlace=true;
      for(var k=0;k<word.length;k++){
        var nr=sr+dr*k,nc=sc+dc*k;
        if(nr<0||nr>=size||nc<0||nc>=size){canPlace=false;break;}
        if(grid[nr][nc]!==''&&grid[nr][nc]!==word[k]){canPlace=false;break;}
      }
      if(canPlace){
        var cells=[];
        for(var k=0;k<word.length;k++){
          var nr=sr+dr*k,nc=sc+dc*k;
          grid[nr][nc]=word[k];
          cells.push([nr,nc]);
        }
        placed.push({word:word,cells:cells});
        ok=true;
      }
      attempts++;
    }
  });

  // Fill empty cells
  var alpha='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for(var r=0;r<size;r++) for(var c=0;c<size;c++) if(!grid[r][c]) grid[r][c]=alpha[Math.floor(Math.random()*26)];

  wsState={grid:grid,words:placed.map(function(p){return p.word;}),placed:placed,found:[],size:size,selStart:null,selCells:[]};
  _wsRender();
  _actToast(placed.length+' de '+words.length+' palavras colocadas.');
}

function _wsRender(){
  var s=wsState;
  var el=document.getElementById('wsGrid');
  if(!el) return;
  el.style.gridTemplateColumns='repeat('+s.size+',34px)';
  el.classList.add('ws-grid');
  var foundCells={};
  s.found.forEach(function(fi){
    var p=s.placed[fi]; if(!p) return;
    p.cells.forEach(function(c){foundCells[c[0]+','+c[1]]=true;});
  });
  var selCells={};
  (s.selCells||[]).forEach(function(c){selCells[c[0]+','+c[1]]=true;});
  var h='';
  for(var r=0;r<s.size;r++) for(var c=0;c<s.size;c++){
    var cls='ws-cell';
    if(foundCells[r+','+c]) cls+=' found';
    else if(selCells[r+','+c]) cls+=' selecting';
    h+='<div class="'+cls+'" data-r="'+r+'" data-c="'+c+'" onmousedown="wsStartSel('+r+','+c+')" onmouseenter="wsMoveSel('+r+','+c+')" onmouseup="wsEndSel()" ontouchstart="wsStartSel('+r+','+c+')" ontouchend="wsEndSel()">'+s.grid[r][c]+'</div>';
  }
  el.innerHTML=h;
  // Word list
  var wl=document.getElementById('wsWordList');
  if(wl) wl.innerHTML=s.words.map(function(w,i){return '<span class="'+(s.found.indexOf(i)>=0?'found':'')+'">'+w+'</span>';}).join('');
  if(s.found.length>=s.placed.length&&s.placed.length>0){
    var msg=document.getElementById('wsMsg');
    if(msg) msg.innerHTML='<b style="color:#16a34a;">🎉 Todas as palavras encontradas!</b>';
    actPlaySound('win');
  }
}

function wsStartSel(r,c){wsState.selStart=[r,c];wsState.selCells=[[r,c]];_wsRender();}
function wsMoveSel(r,c){
  if(!wsState.selStart) return;
  var sr=wsState.selStart[0],sc=wsState.selStart[1];
  var dr=r-sr,dc=c-sc;
  var len=Math.max(Math.abs(dr),Math.abs(dc));
  if(len===0){wsState.selCells=[[sr,sc]];_wsRender();return;}
  var stepR=dr===0?0:(dr>0?1:-1);
  var stepC=dc===0?0:(dc>0?1:-1);
  // Must be straight line
  if(Math.abs(dr)!==0&&Math.abs(dc)!==0&&Math.abs(dr)!==Math.abs(dc)) return;
  var cells=[];
  for(var i=0;i<=len;i++) cells.push([sr+stepR*i,sc+stepC*i]);
  wsState.selCells=cells;
  _wsRender();
}
function wsEndSel(){
  if(!wsState.selStart||!wsState.selCells.length){wsState.selStart=null;return;}
  var selected=wsState.selCells.map(function(c){return wsState.grid[c[0]][c[1]];}).join('');
  var selectedRev=selected.split('').reverse().join('');
  // Check against placed words
  var foundIdx=-1;
  wsState.placed.forEach(function(p,i){
    if(wsState.found.indexOf(i)>=0) return;
    if(p.word===selected||p.word===selectedRev) foundIdx=i;
  });
  if(foundIdx>=0){
    wsState.found.push(foundIdx);
    actPlaySound('hit');
  }
  wsState.selStart=null;wsState.selCells=[];
  _wsRender();
}
function wsRevelar(){
  wsState.found=wsState.placed.map(function(_,i){return i;});
  _wsRender();
  _actToast('Todas as palavras reveladas.');
}

// ================================================================
// CRUZADINHA (Crossword)
// ================================================================
var cwState={grid:[],words:[],clues:[],size:0};

function cwFromForca(){
  if(!forcaBank.length) return _actToast('Banco da Forca vazio.','error');
  var lines=forcaBank.map(function(x){return x.w+'|'+(x.h||'Descubra a palavra');}).join('\n');
  var el=document.getElementById('cwInput'); if(el) el.value=lines;
  _actToast(forcaBank.length+' palavras importadas!');
}

function cwGerar(){
  var raw=(document.getElementById('cwInput')||{}).value||'';
  var entries=raw.split('\n').map(function(l){
    var parts=l.split('|').map(function(s){return s.trim();});
    return{word:parts[0].toUpperCase().replace(/[^A-ZÁÉÍÓÚÂÊÔÃÕÇ]/g,''),clue:parts[1]||'?'};
  }).filter(function(e){return e.word.length>=2;}).slice(0,15);
  if(entries.length<2) return _actToast('Adicione pelo menos 2 palavras.','error');

  // Sort by length desc
  entries.sort(function(a,b){return b.word.length-a.word.length;});

  // Simple crossword generator
  var gridSize=Math.max(20,...entries.map(function(e){return e.word.length+4;}));
  var grid=[];
  for(var r=0;r<gridSize;r++){grid[r]=[];for(var c=0;c<gridSize;c++) grid[r][c]=null;}

  var placed=[];
  // Place first word horizontally in center
  var first=entries[0];
  var sr=Math.floor(gridSize/2);
  var sc=Math.floor((gridSize-first.word.length)/2);
  for(var k=0;k<first.word.length;k++) grid[sr][sc+k]=first.word[k];
  placed.push({word:first.word,clue:first.clue,r:sr,c:sc,dir:'H'});

  // Try to place remaining words
  for(var ei=1;ei<entries.length;ei++){
    var entry=entries[ei];
    var bestScore=-1,bestPos=null;
    // Try to intersect with placed words
    for(var pi=0;pi<placed.length;pi++){
      var pw=placed[pi];
      for(var ki=0;ki<pw.word.length;ki++){
        for(var kj=0;kj<entry.word.length;kj++){
          if(pw.word[ki]!==entry.word[kj]) continue;
          var newDir=pw.dir==='H'?'V':'H';
          var nr,nc;
          if(newDir==='H'){nr=pw.dir==='H'?pw.r:pw.r+ki;nc=pw.dir==='H'?pw.c+ki-kj:pw.c-kj;}
          else{nr=pw.dir==='H'?pw.r-kj:pw.r+ki-kj;nc=pw.dir==='H'?pw.c+ki:pw.c;}
          // Check if word fits
          var canPlace=true;
          for(var k=0;k<entry.word.length;k++){
            var cr=newDir==='V'?nr+k:nr;
            var cc=newDir==='H'?nc+k:nc;
            if(cr<0||cr>=gridSize||cc<0||cc>=gridSize){canPlace=false;break;}
            var existing=grid[cr][cc];
            if(existing!==null&&existing!==entry.word[k]){canPlace=false;break;}
            // Check adjacent cells (avoid parallel words touching)
            if(existing===null){
              if(newDir==='H'){
                if((grid[cr-1]&&grid[cr-1][cc]!==null&&grid[cr-1][cc]!==undefined)||(grid[cr+1]&&grid[cr+1][cc]!==null&&grid[cr+1][cc]!==undefined)){
                  // Check if this adjacency is from a crossing word
                  var isFromCross=false;
                  placed.forEach(function(p2){
                    if(p2.dir==='V'){
                      for(var m=0;m<p2.word.length;m++){
                        if(p2.r+m===cr-1&&p2.c===cc) isFromCross=true;
                        if(p2.r+m===cr+1&&p2.c===cc) isFromCross=true;
                      }
                    }
                  });
                  if(!isFromCross){canPlace=false;break;}
                }
              } else {
                if(grid[cr]&&(grid[cr][cc-1]!==null&&grid[cr][cc-1]!==undefined)||(grid[cr][cc+1]!==null&&grid[cr][cc+1]!==undefined)){
                  var isFromCross2=false;
                  placed.forEach(function(p2){
                    if(p2.dir==='H'){
                      for(var m=0;m<p2.word.length;m++){
                        if(p2.r===cr&&p2.c+m===cc-1) isFromCross2=true;
                        if(p2.r===cr&&p2.c+m===cc+1) isFromCross2=true;
                      }
                    }
                  });
                  if(!isFromCross2){canPlace=false;break;}
                }
              }
            }
          }
          // Check cells before and after word are empty
          if(canPlace){
            var br=newDir==='V'?nr-1:nr;
            var bc=newDir==='H'?nc-1:nc;
            var ar=newDir==='V'?nr+entry.word.length:nr;
            var ac=newDir==='H'?nc+entry.word.length:nc;
            if(br>=0&&br<gridSize&&bc>=0&&bc<gridSize&&grid[br][bc]!==null) canPlace=false;
            if(ar>=0&&ar<gridSize&&ac>=0&&ac<gridSize&&grid[ar][ac]!==null) canPlace=false;
          }
          if(canPlace){
            var score=1; // base score for intersection
            if(score>bestScore){bestScore=score;bestPos={r:nr,c:nc,dir:newDir,kj:kj};}
          }
        }
      }
    }
    if(bestPos){
      for(var k=0;k<entry.word.length;k++){
        var cr=bestPos.dir==='V'?bestPos.r+k:bestPos.r;
        var cc=bestPos.dir==='H'?bestPos.c+k:bestPos.c;
        grid[cr][cc]=entry.word[k];
      }
      placed.push({word:entry.word,clue:entry.clue,r:bestPos.r,c:bestPos.c,dir:bestPos.dir});
    }
  }

  // Trim grid to content
  var minR=gridSize,maxR=0,minC=gridSize,maxC=0;
  for(var r=0;r<gridSize;r++) for(var c=0;c<gridSize;c++){
    if(grid[r][c]!==null){minR=Math.min(minR,r);maxR=Math.max(maxR,r);minC=Math.min(minC,c);maxC=Math.max(maxC,c);}
  }
  var trimmed=[];
  for(var r=minR;r<=maxR;r++){trimmed.push(grid[r].slice(minC,maxC+1));}
  var newPlaced=placed.map(function(p){return{word:p.word,clue:p.clue,r:p.r-minR,c:p.c-minC,dir:p.dir};});

  cwState={grid:trimmed,words:newPlaced,size:trimmed.length,cols:trimmed[0]?trimmed[0].length:0};

  // Assign numbers
  var numGrid={};
  var num=1;
  newPlaced.forEach(function(p){
    var key=p.r+','+p.c;
    if(!numGrid[key]) numGrid[key]=num++;
    p.num=numGrid[key];
  });

  _cwRender();
  _actToast(placed.length+' de '+entries.length+' palavras na cruzadinha.');
}

function _cwRender(){
  var s=cwState;
  var el=document.getElementById('cwGrid'); if(!el) return;
  if(!s.grid.length){el.innerHTML='';return;}

  // Build number map
  var numMap={};
  s.words.forEach(function(w){numMap[w.r+','+w.c]=w.num;});

  el.style.display='inline-grid';
  el.style.gridTemplateColumns='repeat('+s.cols+',36px)';
  el.classList.add('cw-grid');

  var h='';
  for(var r=0;r<s.grid.length;r++){
    for(var c=0;c<(s.grid[r]||[]).length;c++){
      var val=s.grid[r][c];
      if(val===null){
        h+='<div class="cw-cell black"></div>';
      } else {
        var numLabel=numMap[r+','+c]?'<span class="cw-num">'+numMap[r+','+c]+'</span>':'';
        h+='<div class="cw-cell">'+numLabel+'<input maxlength="1" data-r="'+r+'" data-c="'+c+'" data-answer="'+val+'" onkeyup="cwNav(event,'+r+','+c+')"></div>';
      }
    }
  }
  el.innerHTML=h;

  // Clues
  var cluesEl=document.getElementById('cwClues');
  if(cluesEl){
    var horiz=s.words.filter(function(w){return w.dir==='H';});
    var vert=s.words.filter(function(w){return w.dir==='V';});
    var ch='<div><h4>→ Horizontal</h4>';
    horiz.forEach(function(w){ch+='<div><span class="cw-clue-num">'+w.num+'.</span>'+_escHTML(w.clue)+' ('+w.word.length+' letras)</div>';});
    ch+='</div><div><h4>↓ Vertical</h4>';
    vert.forEach(function(w){ch+='<div><span class="cw-clue-num">'+w.num+'.</span>'+_escHTML(w.clue)+' ('+w.word.length+' letras)</div>';});
    ch+='</div>';
    cluesEl.innerHTML=ch;
  }
}

function cwNav(e,r,c){
  if(e.key.length===1&&/[a-zA-ZÀ-ÿ]/.test(e.key)){
    // Move to next cell
    var next=document.querySelector('#cwGrid input[data-r="'+r+'"][data-c="'+(c+1)+'"]');
    if(!next) next=document.querySelector('#cwGrid input[data-r="'+(r+1)+'"][data-c="'+c+'"]');
    if(next) next.focus();
  } else if(e.key==='Backspace'){
    var prev=document.querySelector('#cwGrid input[data-r="'+r+'"][data-c="'+(c-1)+'"]');
    if(!prev) prev=document.querySelector('#cwGrid input[data-r="'+(r-1)+'"][data-c="'+c+'"]');
    if(prev) prev.focus();
  }
}
function cwVerificar(){
  var inputs=document.querySelectorAll('#cwGrid input');
  var correct=0,total=0;
  inputs.forEach(function(inp){
    var answer=inp.dataset.answer;
    var val=(inp.value||'').toUpperCase();
    inp.classList.remove('correct','wrong');
    total++;
    if(val===answer){inp.classList.add('correct');correct++;}
    else if(val) inp.classList.add('wrong');
  });
  if(correct===total){actPlaySound('win');_actToast('🎉 Cruzadinha completa!','success');}
  else _actToast(correct+' de '+total+' corretas.');
}
function cwRevelar(){
  document.querySelectorAll('#cwGrid input').forEach(function(inp){
    inp.value=inp.dataset.answer;
    inp.classList.add('correct');
  });
  _actToast('Respostas reveladas.');
}

// ================================================================
// BULK IMPORT — Add configs for new games
// ================================================================
try{
  if(typeof _actBulkConfigs!=='undefined'){
    _actBulkConfigs.rel={
      title:'Relacionar — Colar Pares em Lote',
      hint:'<b>Formato:</b> Um par por linha: <code>Item A | Item B</code><br><br><b>Exemplos:</b><br><code>Brasil | Brasília</code><br><code>Átomo | Menor partícula</code>',
      placeholder:'Brasil | Brasília\nArgentina | Buenos Aires\nChile | Santiago\nPeru | Lima\nColômbia | Bogotá',
      parse:function(text){
        return text.split('\n').map(function(l){
          var sep=l.includes('|')?'|':';';
          var p=l.split(sep).map(function(s){return s.trim();});
          return(p[0]&&p[1])?{a:p[0],b:p[1]}:null;
        }).filter(Boolean);
      },
      apply:function(items){
        var added=0;
        items.forEach(function(it){
          if(it.a&&it.b&&!relBank.some(function(b){return b.a===it.a&&b.b===it.b;})){
            relBank.push(it);added++;
          }
        });
        _actSaveAll();relRenderBank();
        return added;
      }
    };
  }
}catch(_){}

// Whitelist new functions
try{
  ['relAdicionar','relLimparBanco','relIniciar','relClickLeft','relClickRight',
   'roletaAdd','roletaFromBank','roletaFromAlunos','roletaLimpar','roletaSpin',
   'wsGerar','wsFromForca','wsRevelar','wsStartSel','wsMoveSel','wsEndSel',
   'cwGerar','cwFromForca','cwVerificar','cwRevelar','cwNav',
   'actRankingOpen','actRankingPt','actRankingReset','actRankingCopy',
   'actQROpen','actQRGenerate'
  ].forEach(function(n){
    if(typeof __wrapSafeGlobal==='function'&&typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){}





// ================================================================
// BULK IMPORT SYSTEM — "Colar em Lote" for all 7 games
// ================================================================

const BULK_FORMATS = {
  forca: {
    title: 'Forca — Colar Palavras em Lote',
    hint: `<b>Formato:</b> Uma palavra por linha. Opcionalmente adicione dica e teoria separadas por <code>;</code> ou <code>|</code><br><br>
<b>Exemplos:</b><br>
<code>Paralelepípedo</code><br>
<code>Onomatopeia ; Figura de linguagem que imita sons</code><br>
<code>Metáfora | Comparação implícita | Figura de linguagem</code><br><br>
<b>Ordem:</b> <code>palavra ; dica ; teoria</code>`,
    placeholder: 'Paralelepípedo\nOnomatopeia ; Figura de linguagem que imita sons\nMetáfora | Comparação implícita | Figura de linguagem\nHipérbole ; Exagero intencional\nAnáfora\nProsopopeia ; Personificação',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      const items = [];
      lines.forEach(line => {
        const sep = line.includes('|') ? '|' : ';';
        const parts = line.split(sep).map(s=>s.trim());
        if(parts[0]) items.push({ w: parts[0], h: parts[1]||'', t: parts[2]||'' });
      });
      return items;
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.w && !forcaBank.some(b=>b.w.toLowerCase()===it.w.toLowerCase())){
          forcaBank.push(it); added++;
        }
      });
      _actSaveAll(); forcaRenderBank();
      return added;
    }
  },

  vf: {
    title: 'Verdadeiro/Falso — Colar em Lote',
    hint: `<b>Formato:</b> Uma pergunta por linha, separada da resposta por <code>|</code> ou <code>;</code><br><br>
<b>Exemplos:</b><br>
<code>O Sol é uma estrela | V | É uma estrela de tipo G</code><br>
<code>O Brasil tem __(26)__ estados ; F ; São 26 estados + DF = 27 UFs</code><br>
<code>A Terra é plana | F</code><br><br>
<b>Ordem:</b> <code>pergunta | V ou F | explicação (opcional) | tag (opcional)</code>`,
    placeholder: 'O Sol é uma estrela | V | É uma estrela anã amarela de tipo G\nA Lua é um planeta | F | A Lua é um satélite natural da Terra\nO DNA tem formato de dupla hélice | V\nA água ferve a 50°C | F | A água ferve a 100°C ao nível do mar\nO verbo é uma classe de palavras invariável | F | Verbos se conjugam | Gramática',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      return lines.map(line => {
        const sep = line.includes('|') ? '|' : ';';
        const parts = line.split(sep).map(s=>s.trim());
        if(!parts[0]) return null;
        const answer = (parts[1]||'V').toUpperCase().startsWith('F') ? 'F' : 'V';
        return { t: parts[0], a: answer, e: parts[2]||'', tag: parts[3]||'' };
      }).filter(Boolean);
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.t && !vfBank.some(b=>b.t===it.t)){
          vfBank.push(it); added++;
        }
      });
      _actSaveAll(); vfRenderBank();
      return added;
    }
  },

  mem: {
    title: 'Memória — Colar Pares em Lote',
    hint: `<b>Formato:</b> Um par por linha, separado por <code>|</code> ou <code>;</code><br><br>
<b>Exemplos:</b><br>
<code>🍎 | Maçã</code><br>
<code>Anáfora | Repetição de palavras</code><br>
<code>H₂O ; Água</code><br><br>
<b>Dica:</b> Use emojis no lado A e a palavra no lado B para jogo visual!`,
    placeholder: '🍎 | Maçã\n🐱 | Gato\n🌍 | Terra\n📚 | Livro\nAnáfora | Repetição\nMetáfora | Comparação implícita\nHipérbole | Exagero\nIronia | Sentido oposto',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      return lines.map(line => {
        const sep = line.includes('|') ? '|' : ';';
        const parts = line.split(sep).map(s=>s.trim());
        if(parts[0] && parts[1]) return { a: parts[0], b: parts[1] };
        return null;
      }).filter(Boolean);
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.a && it.b && !memBank.some(b=>b.a===it.a && b.b===it.b)){
          memBank.push(it); added++;
        }
      });
      _actSaveAll(); memRenderBank();
      return added;
    }
  },

  fc: {
    title: 'Flashcards — Colar em Lote',
    hint: `<b>Formato:</b> Um cartão por linha: <code>frente | verso | tag(opcional)</code><br><br>
<b>Exemplos:</b><br>
<code>O que é anáfora? | Repetição de palavras no início de versos/frases | Figuras de linguagem</code><br>
<code>Sujeito | Termo que pratica a ação verbal | Sintaxe</code><br>
<code>H₂O | Fórmula da água</code>`,
    placeholder: 'O que é anáfora? | Repetição de palavras no início de versos | Figuras\nO que é metáfora? | Comparação implícita sem "como" | Figuras\nSujeito | Pratica ou sofre a ação do verbo | Sintaxe\nPredicado | Tudo que se declara sobre o sujeito | Sintaxe',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      return lines.map(line => {
        const sep = line.includes('|') ? '|' : ';';
        const parts = line.split(sep).map(s=>s.trim());
        if(parts[0] && parts[1]) return { f: parts[0], b: parts[1], g: parts[2]||'' };
        return null;
      }).filter(Boolean);
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.f && it.b && !fcBank.some(b=>b.f===it.f)){
          fcBank.push(it); added++;
        }
      });
      _actSaveAll(); fcRenderBank();
      return added;
    }
  },

  quiz: {
    title: 'Quiz — Colar Perguntas em Lote',
    hint: `<b>Formato:</b> Cada pergunta separada por linha em branco. Use A), B), C), D) para alternativas. Marque a correta com * ou escreva <code>Correta: X</code><br><br>
<b>Exemplo:</b><br>
<code>Qual figura de linguagem usa exagero?</code><br>
<code>A) Metáfora</code><br>
<code>B) *Hipérbole</code><br>
<code>C) Ironia</code><br>
<code>D) Anáfora</code><br>
<code>Explicação: Hipérbole é o uso de exagero intencional</code><br><br>
<b>Dica:</b> Marque a correta com <code>*</code> antes do texto OU use <code>Correta: B</code>`,
    placeholder: `Qual figura de linguagem usa exagero?\nA) Metáfora\nB) *Hipérbole\nC) Ironia\nD) Anáfora\nExplicação: Hipérbole é o exagero intencional para dar ênfase\n\nQual classe gramatical varia em número e gênero?\nA) Advérbio\nB) Conjunção\nC) *Substantivo\nD) Preposição`,
    parse: function(text){
      // Split by double newline or by numbered questions
      const blocks = text.split(/\n\s*\n/).filter(b=>b.trim());
      const items = [];
      blocks.forEach(block => {
        const lines = block.split('\n').map(l=>l.trim()).filter(Boolean);
        if(lines.length < 3) return;
        
        let question = '';
        const alts = ['','','',''];
        let corr = -1;
        let exp = '';
        
        lines.forEach(line => {
          const altMatch = line.match(/^([A-Da-d])\)\s*(\*?)(.+)/);
          const corrMatch = line.match(/^[Cc]orreta:\s*([A-Da-d])/);
          const expMatch = line.match(/^[Ee]xplica[çc][ãa]o:\s*(.+)/);
          
          if(altMatch){
            const idx = 'abcd'.indexOf(altMatch[1].toLowerCase());
            if(idx>=0){
              alts[idx] = altMatch[3].trim();
              if(altMatch[2]==='*') corr = idx;
            }
          } else if(corrMatch){
            corr = 'abcd'.indexOf(corrMatch[1].toLowerCase());
          } else if(expMatch){
            exp = expMatch[1].trim();
          } else if(!question){
            question = line;
          } else if(!line.match(/^[A-Da-d]\)/)){
            // Could be continuation of question
            question += ' ' + line;
          }
        });
        
        // If no alt marked with *, try "Correta:" line
        if(corr < 0) corr = 0; // default to A if not specified
        
        if(question && alts.filter(Boolean).length >= 2){
          // Fill empty alts
          for(let i=0;i<4;i++) if(!alts[i]) alts[i]='—';
          items.push({ q: question, alts, corr, exp });
        }
      });
      return items;
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.q && !quizBank.some(b=>b.q===it.q)){
          quizBank.push(it); added++;
        }
      });
      quizSave(); quizRenderBank();
      return added;
    }
  },

  comp: {
    title: 'Completar Frase — Colar em Lote',
    hint: `<b>Formato:</b> Uma frase por linha com <code>___</code> na lacuna, seguida de <code>|</code> e a resposta correta<br><br>
<b>Exemplos:</b><br>
<code>O sujeito da oração é quem ___ a ação | pratica</code><br>
<code>A ___ é a classe de palavras que modifica o verbo | advérbio | Gramática: classes de palavras</code><br><br>
<b>Ordem:</b> <code>frase com ___ | resposta | explicação (opcional)</code>`,
    placeholder: 'O sujeito da oração é quem ___ a ação | pratica\nA ___ é a classe de palavras que modifica o verbo | advérbio\nO predicado ___ tudo que se declara sobre o sujeito | contém | Análise sintática\nA água ferve a ___ graus Celsius | 100',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      return lines.map(line => {
        const sep = line.includes('|') ? '|' : ';';
        const parts = line.split(sep).map(s=>s.trim());
        if(parts[0] && parts[1] && parts[0].includes('___')) return { f: parts[0], r: parts[1], e: parts[2]||'' };
        // Try auto-detecting: if no ___, but has separator, assume first part is question with missing word
        if(parts[0] && parts[1] && !parts[0].includes('___')){
          return { f: parts[0].replace(new RegExp(parts[1].replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i'), '___'), r: parts[1], e: parts[2]||'' };
        }
        return null;
      }).filter(Boolean);
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.f && it.r && !compBank.some(b=>b.f===it.f)){
          compBank.push(it); added++;
        }
      });
      compSave(); compRenderBank();
      return added;
    }
  },

  ord: {
    title: 'Ordenar Palavras — Colar em Lote',
    hint: `<b>Formato:</b> Uma frase correta por linha. Opcionalmente adicione dica após <code>|</code><br><br>
<b>Exemplos:</b><br>
<code>O gato bebeu o leite da tigela</code><br>
<code>A menina leu o livro na biblioteca | Sujeito + Verbo + Objeto + Adjunto</code><br><br>
<b>O sistema embaralha automaticamente!</b>`,
    placeholder: 'O gato bebeu o leite da tigela\nA menina leu o livro na biblioteca | Sujeito + Verbo + Objeto\nOs alunos estudaram para a prova de história\nO professor explicou a matéria com clareza | Ordem direta',
    parse: function(text){
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      return lines.map(line => {
        const sep = line.includes('|') ? '|' : (line.includes(';') ? ';' : null);
        let f, d='';
        if(sep){
          const parts = line.split(sep).map(s=>s.trim());
          f = parts[0]; d = parts[1]||'';
        } else {
          f = line;
        }
        if(f && f.split(/\s+/).length >= 3) return { f, d };
        return null;
      }).filter(Boolean);
    },
    apply: function(items){
      let added=0;
      items.forEach(it=>{
        if(it.f && !ordBank.some(b=>b.f===it.f)){
          ordBank.push(it); added++;
        }
      });
      ordSave(); ordRenderBank();
      return added;
    }
  }
};

function actBulkOpen(game){
  const cfg = BULK_FORMATS[game];
  if(!cfg) return;
  
  const old = document.getElementById('bulkOverlay');
  if(old) old.remove();
  
  const html = `<div class="bulk-overlay" id="bulkOverlay" onclick="if(event.target===this)this.remove();">
    <div class="bulk-container">
      <button style="position:absolute;top:10px;right:12px;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#64748b;" onclick="document.getElementById('bulkOverlay').remove();">&times;</button>
      <h3><i class="fas fa-paste"></i> ${cfg.title}</h3>
      <div class="bulk-hint">${cfg.hint}</div>
      <textarea id="bulkTextarea" class="bulk-textarea" placeholder="${_escHTML(cfg.placeholder)}" rows="10"></textarea>
      <div id="bulkPreview" class="bulk-preview" style="display:none;"></div>
      <div class="bulk-actions">
        <button class="btn-planner" onclick="actBulkPreview('${game}')"><i class="fas fa-eye"></i> Pré-visualizar</button>
        <button class="btn-primary" onclick="actBulkImport('${game}')"><i class="fas fa-check"></i> Importar</button>
        <button class="btn-planner" onclick="document.getElementById('bulkOverlay').remove();">Cancelar</button>
      </div>
    </div>
  </div>`;
  
  document.body.insertAdjacentHTML('beforeend', html);
  
  // Focus textarea
  setTimeout(()=>document.getElementById('bulkTextarea')?.focus(), 100);
}

function actBulkPreview(game){
  const cfg = BULK_FORMATS[game];
  if(!cfg) return;
  const text = document.getElementById('bulkTextarea')?.value||'';
  if(!text.trim()) return _actToast('Cole o conteúdo primeiro.','error');
  
  const items = cfg.parse(text);
  const el = document.getElementById('bulkPreview');
  if(!el) return;
  
  if(items.length === 0){
    el.style.display = 'block';
    el.innerHTML = '<span class="bp-err">❌ Nenhum item reconhecido. Verifique o formato.</span>';
    return;
  }
  
  let preview = `<span class="bp-ok">✅ ${items.length} item(s) reconhecido(s):</span><br>`;
  items.slice(0, 10).forEach((it, i) => {
    let desc = '';
    if(game==='forca') desc = `<b>${_escHTML(it.w)}</b>${it.h?' — '+_escHTML(it.h):''}`;
    else if(game==='vf') desc = `[${it.a}] ${_escHTML(it.t.substring(0,60))}${it.tag?' <span style="color:#7c3aed;">#'+_escHTML(it.tag)+'</span>':''}`;
    else if(game==='mem') desc = `${_escHTML(it.a)} ↔ ${_escHTML(it.b)}`;
    else if(game==='fc') desc = `${_escHTML(it.f.substring(0,30))} ⇄ ${_escHTML(it.b.substring(0,30))}${it.g?' <span style="color:#7c3aed;">#'+_escHTML(it.g)+'</span>':''}`;
    else if(game==='quiz') desc = `${_escHTML(it.q.substring(0,50))}... [${['A','B','C','D'][it.corr]}]`;
    else if(game==='comp') desc = `${_escHTML(it.f.substring(0,50))} → <b>${_escHTML(it.r)}</b>`;
    else if(game==='ord') desc = `${_escHTML(it.f.substring(0,60))}`;
    preview += `${i+1}. ${desc}<br>`;
  });
  if(items.length > 10) preview += `<span style="color:#64748b;">... e mais ${items.length-10} item(s)</span>`;
  
  el.style.display = 'block';
  el.innerHTML = preview;
}

function actBulkImport(game){
  const cfg = BULK_FORMATS[game];
  if(!cfg) return;
  const text = document.getElementById('bulkTextarea')?.value||'';
  if(!text.trim()) return _actToast('Cole o conteúdo primeiro.','error');
  
  const items = cfg.parse(text);
  if(items.length === 0) return _actToast('Nenhum item reconhecido. Verifique o formato.','error');
  
  const added = cfg.apply(items);
  document.getElementById('bulkOverlay')?.remove();
  _actToast(`✅ ${added} item(s) adicionado(s) ao banco!${added<items.length?' ('+(items.length-added)+' duplicado(s) ignorado(s))':''}`);
}

// Whitelist bulk functions
try{
  ['actBulkOpen','actBulkPreview','actBulkImport'].forEach(n=>{
    if(typeof __wrapSafeGlobal==='function' && typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){}




// ================================================================
// V15.1 — 22 MELHORIAS: SORTEADOR, MAPA DE SALA, GERADOR DE GRUPOS
// ================================================================

// ================================================================
// SORTEADOR (Features 1-6)
// ================================================================
let sortHistorico = [];
let sortAnimId = null;

function sortearAluno(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma.", "error");
  let lista = getAlunosFiltrados();
  if(lista.length===0) return showToast("Sem alunos.", "error");

  // F3: Exclude absent
  if(document.getElementById('sortExcludeAbsent')?.checked){
    lista = _sortExcluirAusentes(lista);
    if(lista.length===0) return showToast("Todos ausentes!", "error");
  }

  // Remove already sorted (avoid repeat)
  const disponiveis = lista.filter(a => !sortHistorico.includes(a.id));
  const pool = disponiveis.length > 0 ? disponiveis : lista;

  // F4: Get mode
  const mode = document.querySelector('input[name="sortMode"]:checked')?.value || '1';
  let qty = mode === 'n' ? parseInt(document.getElementById('sortN')?.value||'1') : parseInt(mode);
  qty = Math.min(qty, pool.length);
  if(qty < 1) qty = 1;

  // Open modal if not open
  const modal = document.getElementById('modalSorteio');
  if(modal && (modal.style.display === 'none' || (window.getComputedStyle && getComputedStyle(modal).display === 'none'))) abrirModal('modalSorteio');

  // F1: Slot machine animation
  const reel = document.getElementById('sortReel');
  const result = document.getElementById('sortResult');
  if(!reel) return;
  result.innerHTML = '';

  // Build reel names
  const allNames = pool.map(a => a.nome);
  let reelHTML = '';
  for(let r = 0; r < 40; r++){
    reelHTML += `<div class="sort-name">${_escHTML(allNames[Math.floor(Math.random()*allNames.length)])}</div>`;
  }
  const shuffled = [...pool].sort(() => Math.random() - 0.5);
  const winners = shuffled.slice(0, qty);
  reelHTML += `<div class="sort-name">${_escHTML(winners[0].nome)}</div>`;
  reel.innerHTML = reelHTML;

  // Animate
  let pos = 0;
  const targetPos = 40 * 80; // 40 items × 80px
  const duration = 2500;
  const startTime = Date.now();
  if(sortAnimId) cancelAnimationFrame(sortAnimId);

  function animate(){
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    reel.style.transform = `translateY(-${eased * targetPos}px)`;
    if(progress < 1) sortAnimId = requestAnimationFrame(animate);
    else { sortAnimId = null; _sortShowWinners(winners); }
  }
  sortAnimId = requestAnimationFrame(animate);
}

function _sortShowWinners(winners){
  const result = document.getElementById('sortResult');
  if(!result) return;
  result.style.position = 'relative';
  let html = '';
  winners.forEach(w => {
    html += `<div class="sort-winner" style="font-size:${winners.length>1?'1.2rem':'1.8rem'};font-weight:800;color:var(--primary);margin:4px 0;">🎉 ${_escHTML(w.nome)}</div>`;
    if(!sortHistorico.includes(w.id)) sortHistorico.push(w.id);
  });
  result.innerHTML = html;
  // Confetti
  const colors = ['#dc2626','#2563eb','#16a34a','#f59e0b','#7c3aed','#ec4899'];
  for(let i=0;i<12;i++){
    const p=document.createElement('div');
    p.className='act-confetti-particle';
    p.style.cssText=`left:${Math.random()*90+5}%;top:20%;background:${colors[i%colors.length]};animation-delay:${Math.random()*0.3}s;width:${6+Math.random()*5}px;height:${6+Math.random()*5}px;`;
    result.appendChild(p);
    setTimeout(()=>p.remove(),1200);
  }
  _sortRenderHistorico();
}

function _sortRenderHistorico(){
  const el=document.getElementById('sortHistory');
  if(!el) return;
  if(!sortHistorico.length){el.innerHTML='';return;}
  const nomes=sortHistorico.map(id=>{const a=alunos.find(x=>x.id===id);return a?a.nome.split(' ')[0]:'?';});
  el.innerHTML=`<b>Já sorteados (${nomes.length}):</b> ${nomes.join(', ')}`;
}

function sortLimparHistorico(){sortHistorico=[];_sortRenderHistorico();showToast("Histórico limpo!");}

function _sortExcluirAusentes(lista){
  const freq=window.__sgpFrequencia||{};
  const hoje=new Date().toISOString().split('T')[0];
  const key=`${filtroTurma}|${bimestreAtual}|${hoje}`;
  const chamada=freq[key];
  if(!chamada) return lista;
  return lista.filter(a=>{const s=chamada[a.id];return !s||s==='P'||s==='J';});
}

// ================================================================
// MAPA DE SALA (Features 7-13)
// ================================================================
let mapaGridCols=6, mapaGridRows=6;
let mapaDisabledDesks=new Set();
let mapaSwapMode=false, mapaSwapFirst=null, mapaDisableMode=false;

// F7: Configurable grid
function mapaChangeGrid(){
  const val=document.getElementById('mapaGridSize')?.value||'6x6';
  const [c,r]=val.split('x').map(Number);
  mapaGridCols=c||6; mapaGridRows=r||6;
  try{localStorage.setItem('sgp_mapa_grid',val);}catch(_){}
  mapaDisabledDesks.clear();
  gerarMesas();
  renderizarMapa();
}

// Override gerarMesas
try{
  const __origGerarMesas=gerarMesas;
  gerarMesas=function(){
    const g=document.getElementById('salaGrid');
    if(!g) return;
    g.innerHTML='';
    g.style.gridTemplateColumns=`repeat(${mapaGridCols}, 1fr)`;
    const total=mapaGridCols*mapaGridRows;

    // sgp_mapa_dedupe: garante 1 aluno por mesa (evita duplicidade)
    try{
      const seen=new Set();
      let changed=false;
      ls.forEach(a=>{
        if(a && a.mesa!==null && a.mesa!==undefined){
          const m=parseInt(a.mesa,10);
          if(!Number.isFinite(m) || m<0 || m>=total || (mapaDisabledDesks && mapaDisabledDesks.has(m))){
            a.mesa=null; changed=true; return;
          }
          if(seen.has(m)){ a.mesa=null; changed=true; return; }
          seen.add(m);
        }
      });
      if(changed) salvarDadosLocal();
    }catch(_){}
    for(let i=0;i<total;i++){
      g.innerHTML+=`<div id="mesa_${i}" class="mesa${mapaDisabledDesks.has(i)?' disabled':''}" ondrop="drop(event,${i})" ondragover="allowDrop(event)" data-onclick="mapaMesaClick(${i})"></div>`;
    }
  };
}catch(_){}

// Restore saved grid
try{
  const saved=localStorage.getItem('sgp_mapa_grid');
  if(saved){
    const sel=document.getElementById('mapaGridSize');
    if(sel){sel.value=saved;const [c,r]=saved.split('x').map(Number);mapaGridCols=c||6;mapaGridRows=r||6;}
  }
}catch(_){}

// F8: Toggle disable mode
function mapaToggleDisable(){
  mapaDisableMode=!mapaDisableMode;
  mapaSwapMode=false;
  const msg=document.getElementById('mapaSwapMsg');
  if(msg) msg.style.display='none';
  showToast(mapaDisableMode?"Clique nas mesas vazias para desabilitar. Clique ⊟ de novo para sair.":"Modo desabilitar: OFF");
}

// F11: Swap mode
function mapaToggleSwap(){
  mapaSwapMode=!mapaSwapMode;
  mapaSwapFirst=null;
  mapaDisableMode=false;
  const msg=document.getElementById('mapaSwapMsg');
  if(msg) msg.style.display=mapaSwapMode?'block':'none';
  const btn=document.getElementById('btnMapaSwap');
  if(btn) btn.style.color=mapaSwapMode?'#f59e0b':'';
  if(!mapaSwapMode) renderizarMapa();
}

// Unified mesa click handler
window.mapaMesaClick=function(index){
  if(mapaDisableMode){
    if(mapaDisabledDesks.has(index)){mapaDisabledDesks.delete(index);}
    else{
      const ls=getAlunosFiltrados();
      if(ls.some(a=>a.mesa===index)) return showToast("Remova o aluno primeiro.","error");
      mapaDisabledDesks.add(index);
    }
    gerarMesas(); renderizarMapa(); return;
  }
  if(mapaSwapMode){
    const ls=getAlunosFiltrados();
    const alunoNaMesa=ls.find(a=>a.mesa===index);
    if(!alunoNaMesa) return;
    if(mapaSwapFirst===null){
      mapaSwapFirst=index; renderizarMapa();
      showToast(`${_mapaNomeCurto(alunoNaMesa.nome)} selecionado. Clique no segundo.`);
    } else {
      const a1=ls.find(a=>a.mesa===mapaSwapFirst);
      if(a1&&alunoNaMesa&&a1.id!==alunoNaMesa.id){
        const tmp=a1.mesa; a1.mesa=alunoNaMesa.mesa; alunoNaMesa.mesa=tmp;
        salvarDadosLocal();
        showToast(`${_mapaNomeCurto(a1.nome)} ↔ ${_mapaNomeCurto(alunoNaMesa.nome)}`);
      }
      mapaSwapFirst=null; renderizarMapa();
    }
    return;
  }
  touchSelectMesa(index);
};

// F9/F10: Enhanced renderizarMapa with tooltips and indicators
try{
  const __origRenderMapa=renderizarMapa;
  renderizarMapa=function(){
    if(filtroTurma==='Todas') return;
    const ls=getAlunosFiltrados();
    const lv=document.getElementById('listaAlunosLivres');
    if(lv) lv.innerHTML='';

    const total=mapaGridCols*mapaGridRows;
    document.querySelectorAll('.mesa').forEach(m=>{
      const idx=parseInt(m.id.replace('mesa_',''));
      m.innerHTML='';
      m.style.borderStyle='dashed';
      m.classList.remove('mobile-target','swap-target');
      if(mapaDisabledDesks.has(idx)){m.classList.add('disabled');}
      else{m.classList.remove('disabled');}
    });

    ls.forEach(a=>{
      const b=a.bimestres[bimestreAtual];
      const c=getCorFarol(b.media_lp);
      const mlp=parseFloat(b.media_lp)||0;
      const mred=parseFloat(b.media_red)||0;
      const comp=b.comportamento||10;
      const isPAEE=a.elegivel;
      const isRisk=mlp<5||mred<5;
      const isBehLow=comp<7;

      // F10: Badges
      let badges='<div class="mesa-badges">';
      if(isPAEE) badges+='<span class="mb-paee" title="PAEE">♿</span>';
      if(isRisk) badges+='<span class="mb-risk" title="Risco">⚠</span>';
      if(isBehLow) badges+='<span class="mb-beh" title="Comportamento baixo">⛔</span>';
      badges+='</div>';

      // F9: Tooltip
      const tip=`<div class="mesa-tooltip">${_escHTML(a.nome)}<br>LP: ${mlp.toFixed(1)} | RED: ${mred.toFixed(1)} | Comp: ${comp}${isPAEE?' | PAEE':''}</div>`;

      const selected=alunoSelecionadoParaMover===a.id;
      const swapSel=mapaSwapMode&&mapaSwapFirst!==null&&a.mesa===mapaSwapFirst;
      const h=`<div id="drag_${__u(a.id)}" class="aluno-drag ${selected?'mobile-selected':''}" draggable="true" ondragstart="drag(event)" data-onclick="${mapaSwapMode?'mapaMesaClick('+a.mesa+')':'touchSelectAluno('+__u(a.id)+')'}" style="border-left-color:${c};${swapSel?'box-shadow:0 0 10px #f59e0b;border-color:#f59e0b;':''}">${_escHTML(_mapaNomeCurto(a.nome))}${badges}${tip}</div>`;

      if(a.mesa!==null&&a.mesa<total&&!mapaDisabledDesks.has(a.mesa)){
        const m=document.getElementById('mesa_'+a.mesa);
        if(m){m.innerHTML=h;m.style.borderStyle='solid';}
      } else {
        if(a.mesa!==null&&mapaDisabledDesks.has(a.mesa)){a.mesa=null;}
        if(lv) lv.innerHTML+=h;
      }
    });

    if(alunoSelecionadoParaMover!==null){
      document.querySelectorAll('.mesa').forEach(m=>{
        if(m.innerHTML===''&&!m.classList.contains('disabled')) m.classList.add('mobile-target');
      });
    }
  };
}catch(_){}


// F11.5: Mobile gestures for map (pinch-to-zoom + pan with 2 fingers)
(function(){
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function dist(t1,t2){ const dx=t2.clientX-t1.clientX, dy=t2.clientY-t1.clientY; return Math.hypot(dx,dy); }
  function mid(t1,t2){ return {x:(t1.clientX+t2.clientX)/2, y:(t1.clientY+t2.clientY)/2}; }

  window.__sgpMapaTransform = window.__sgpMapaTransform || {x:0,y:0,scale:1};

  function apply(){
    const g=document.getElementById('salaGrid');
    if(!g) return;
    const st=window.__sgpMapaTransform;
    g.style.transform = `translate(${st.x}px,${st.y}px) scale(${st.scale})`;
  }

  window.mapaResetZoom = function(){
    window.__sgpMapaTransform = {x:0,y:0,scale:1};
    apply();
    try{ showToast("Zoom resetado."); }catch(_){}
  };

  window.__sgpMapaTouchInit = function(){
    const wrap=document.querySelector('#viewMapa .sala-grid-wrap');
    if(!wrap) return;
    if(wrap.dataset.touchZoom==='1'){ apply(); return; }
    wrap.dataset.touchZoom='1';

    let pinching=false, startDist=0, startMid=null, startScale=1, startX=0, startY=0;

    wrap.addEventListener('touchstart', function(e){
      if(window.innerWidth>768) return;
      if(e.touches && e.touches.length===2){
        pinching=true;
        startDist=dist(e.touches[0], e.touches[1]) || 1;
        startMid=mid(e.touches[0], e.touches[1]);
        const st=window.__sgpMapaTransform;
        startScale=st.scale||1;
        startX=st.x||0;
        startY=st.y||0;
      }
    }, {passive:false});

    wrap.addEventListener('touchmove', function(e){
      if(!pinching || window.innerWidth>768) return;
      if(e.touches && e.touches.length===2){
        e.preventDefault();
        const nd=dist(e.touches[0], e.touches[1]) || startDist;
        const nm=mid(e.touches[0], e.touches[1]);
        const st=window.__sgpMapaTransform;
        st.scale = clamp(startScale * (nd / startDist), 0.6, 2.6);
        st.x = startX + (nm.x - startMid.x);
        st.y = startY + (nm.y - startMid.y);
        apply();
      }
    }, {passive:false});

    wrap.addEventListener('touchend', function(e){
      if(!e.touches || e.touches.length<2) pinching=false;
    }, {passive:true});

    apply();
  };

  // Ensure gestures are initialized after map render (and only on mobile)
  try{
    if(!window.__sgpMapaTouchWrapped && typeof window.renderizarMapa==='function'){
      window.__sgpMapaTouchWrapped = true;
      const __orig = window.renderizarMapa;
      window.renderizarMapa = function(){
        __orig.apply(this, arguments);
        if(window.innerWidth<=768) setTimeout(()=>window.__sgpMapaTouchInit(), 0);
      };
    }
  }catch(_){}
})();


// F12: Print map
function mapaImprimir(){
  const grid=document.getElementById('salaGrid');
  if(!grid) return;
  const w=window.open('','_blank','width=900,height=700');
  w.document.write(`<html><head><title>Mapa de Sala - ${_escHTML(filtroTurma)}</title>
  <style>
    body{font-family:sans-serif;padding:20px;}
    h2{text-align:center;color:#334155;}
    .lousa{text-align:center;background:#475569;color:#fff;padding:6px;border-radius:4px;margin-bottom:12px;font-weight:bold;}
    .grid{display:grid;grid-template-columns:repeat(${mapaGridCols},1fr);gap:8px;max-width:800px;margin:0 auto;}
    .mesa{border:2px solid #cbd5e1;border-radius:6px;height:55px;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:bold;text-align:center;}
    .mesa.occupied{background:#eff6ff;border-style:solid;}
    .mesa.disabled{background:#f1f5f9;opacity:.3;}
    .mesa.empty{border-style:dashed;}
  
    .profdesk{max-width:800px;margin:12px auto 0;display:flex;justify-content:flex-end;}
    .profdesk .mesa-prof{border:2px solid #cbd5e1;border-radius:10px;background:#f8fafc;padding:10px 14px;font-weight:bold;color:#334155;}
</style></head><body>
  <h2>Mapa de Sala — ${_escHTML(filtroTurma)}</h2>
<div class="grid">`);

  const total=mapaGridCols*mapaGridRows;
  const ls=getAlunosFiltrados();
  for(let i=0;i<total;i++){
    if(mapaDisabledDesks.has(i)){
      w.document.write('<div class="mesa disabled">✕</div>');
    } else {
      const a=ls.find(x=>x.mesa===i);
      w.document.write(a?`<div class="mesa occupied">${_escHTML(_mapaNomeCurto(a.nome))}</div>`:'<div class="mesa empty"></div>');
    }
  }
  w.document.write('</div><div class="profdesk"><div class="mesa-prof">MESA DO PROFESSOR</div></div></body></html>');
  w.document.close();
  setTimeout(()=>{w.print();},300);
}

// F13: Auto-distribute
function mapaAutoDistribuir(){
  if(filtroTurma==='Todas') return showToast("Selecione uma turma.","error");
  const ls=getAlunosFiltrados();
  const livres=ls.filter(a=>a.mesa===null||a.mesa===undefined);
  if(livres.length===0) return showToast("Todos já estão sentados.","error");
  const total=mapaGridCols*mapaGridRows;
  const ocupadas=new Set(ls.filter(a=>a.mesa!==null&&a.mesa!==undefined).map(a=>a.mesa));
  const vagasDisponiveis=[];
  for(let i=0;i<total;i++){
    if(!ocupadas.has(i)&&!mapaDisabledDesks.has(i)) vagasDisponiveis.push(i);
  }
  if(vagasDisponiveis.length<livres.length) return showToast(`Só ${vagasDisponiveis.length} vagas para ${livres.length} alunos.`,"error");
  // Shuffle available seats
  vagasDisponiveis.sort(()=>Math.random()-0.5);
  livres.forEach((a,i)=>{a.mesa=vagasDisponiveis[i];});
  salvarDadosLocal();
  renderizarMapa();
  showToast(`${livres.length} alunos distribuídos!`);
}

// ================================================================
// GERADOR DE GRUPOS (Features 14-22)
// ================================================================
const GRP_COLORS=['#dc2626','#2563eb','#16a34a','#f59e0b','#7c3aed','#ec4899','#0d9488','#ea580c','#6366f1','#14b8a6','#d946ef','#78716c'];
const GRP_NAMES=['Vermelho','Azul','Verde','Amarelo','Roxo','Rosa','Turquesa','Laranja','Índigo','Menta','Magenta','Cinza'];
let grpHistorico=[];
let grpUltimoResultado=[];

// F16: Mode switch
function grupoModoChanged(){
  const modo=document.getElementById('selectModoGrupo')?.value;
  const lbl=document.getElementById('lblQtdGrupo');
  const inp=document.getElementById('inputQtdGrupos');
  if(modo==='qtdAlunos'){
    if(lbl) lbl.textContent='Alunos por grupo';
    if(inp) inp.value='4';
  } else {
    if(lbl) lbl.textContent='Quantidade de Grupos';
    if(inp) inp.value='4';
  }
}

function gerarGrupos(){
  const modo=document.getElementById('selectModoGrupo')?.value||'qtdGrupos';
  const inputVal=parseInt(document.getElementById('inputQtdGrupos')?.value)||4;
  const tipo=document.getElementById('selectTipoGrupo')?.value||'aleatorio';
  let lista=getAlunosFiltrados();
  if(lista.length===0) return showToast("Turma vazia!","error");

  // F17: Exclude absent
  if(document.getElementById('grpExcludeAbsent')?.checked){
    lista=_sortExcluirAusentes(lista);
    if(lista.length===0) return showToast("Todos ausentes!","error");
  }

  // F16: Calculate N groups
  let n;
  if(modo==='qtdAlunos'){
    n=Math.ceil(lista.length/inputVal);
    if(n<2) n=2;
  } else {
    n=inputVal;
  }
  if(!n||n<2) return showToast("Mínimo 2 grupos","error");

  // F15: Parse "não juntar" pairs
  const sepPairs=_grpParsePairs(document.getElementById('grpSeparar')?.value||'');

  // F21: Parse "fixar" assignments
  const fixados=_grpParseFixed(document.getElementById('grpFixar')?.value||'', lista, n);

  // Shuffle
  lista=[...lista].sort(()=>Math.random()-0.5);

  // F14: Sort by criteria
  if(tipo==='equilibrado'){
    lista.sort((a,b)=>{
      const mA=(parseFloat(a.bimestres[bimestreAtual].media_lp)+parseFloat(a.bimestres[bimestreAtual].media_red))/2;
      const mB=(parseFloat(b.bimestres[bimestreAtual].media_lp)+parseFloat(b.bimestres[bimestreAtual].media_red))/2;
      return mB-mA;
    });
  } else if(tipo==='comportamento'){
    lista.sort((a,b)=>(b.bimestres[bimestreAtual].comportamento||10)-(a.bimestres[bimestreAtual].comportamento||10));
  } else if(tipo==='misto'){
    lista.sort((a,b)=>{
      const mA=(parseFloat(a.bimestres[bimestreAtual].media_lp)+parseFloat(a.bimestres[bimestreAtual].media_red))/2+((a.bimestres[bimestreAtual].comportamento||10)/2);
      const mB=(parseFloat(b.bimestres[bimestreAtual].media_lp)+parseFloat(b.bimestres[bimestreAtual].media_red))/2+((b.bimestres[bimestreAtual].comportamento||10)/2);
      return mB-mA;
    });
  }

  // Build groups
  const grupos=Array.from({length:n},()=>[]);

  // F21: Place fixed students first
  const fixedIds=new Set();
  fixados.forEach(({id,group})=>{
    if(group>=0&&group<n){
      const a=lista.find(x=>x.id===id);
      if(a){grupos[group].push(a);fixedIds.add(id);}
    }
  });

  // Remaining students
  const remaining=lista.filter(a=>!fixedIds.has(a.id));

  // Snake distribution with separation constraint
  if(tipo==='equilibrado'||tipo==='comportamento'||tipo==='misto'){
    let g=0,dir=1;
    remaining.forEach(aluno=>{
      // F15: Try to respect separation
      let placed=false;
      for(let attempt=0;attempt<n;attempt++){
        const testG=(g+attempt)%n;
        if(!_grpViolatesSeparation(aluno,grupos[testG],sepPairs)){
          grupos[testG].push(aluno);placed=true;
          g=testG+dir;
          if(g>=n){g=n-1;dir=-1;} if(g<0){g=0;dir=1;}
          break;
        }
      }
      if(!placed){grupos[g].push(aluno);g+=dir;if(g>=n){g=n-1;dir=-1;}if(g<0){g=0;dir=1;}}
    });
  } else {
    let g=0;
    remaining.forEach(aluno=>{
      let placed=false;
      for(let attempt=0;attempt<n;attempt++){
        const testG=(g+attempt)%n;
        if(!_grpViolatesSeparation(aluno,grupos[testG],sepPairs)){
          grupos[testG].push(aluno);placed=true;g=(testG+1)%n;break;
        }
      }
      if(!placed){grupos[g].push(aluno);g=(g+1)%n;}
    });
  }

  // F22: Save to history
  grpUltimoResultado=grupos.map(g=>g.map(a=>({id:a.id,nome:a.nome})));
  grpHistorico.push({date:new Date().toISOString(),grupos:grpUltimoResultado});
  if(grpHistorico.length>10) grpHistorico.shift();
  const histInfo=document.getElementById('grpHistoricoInfo');
  if(histInfo) histInfo.textContent=`Histórico: ${grpHistorico.length} geração(ões)`;

  // F18: Render with colors and names
  const res=document.getElementById('resultadoGrupos');
  if(!res) return;
  res.innerHTML='';
  grupos.forEach((g,i)=>{
    const color=GRP_COLORS[i%GRP_COLORS.length];
    const nome=GRP_NAMES[i%GRP_NAMES.length];
    let html=`<div class="group-card grp-color-${i%8}">`;
    html+=`<div class="group-title"><span style="color:${color};">${nome} (${g.length})</span></div>`;
    g.forEach(a=>{
      const isFixed=fixedIds.has(a.id);
      html+=`<div class="group-member">${_escHTML(a.nome)}${isFixed?'<span class="gm-badge gm-fixed">fixo</span>':''}</div>`;
    });
    html+='</div>';
    res.innerHTML+=html;
  });
}

function _grpParsePairs(text){
  if(!text.trim()) return [];
  return text.split('\n').map(l=>l.trim()).filter(Boolean).map(l=>{
    const parts=l.split(/[;|]/).map(s=>s.trim().toLowerCase());
    return parts.length>=2?[parts[0],parts[1]]:null;
  }).filter(Boolean);
}

function _grpParseFixed(text,lista,maxGroups){
  if(!text.trim()) return [];
  return text.split('\n').map(l=>l.trim()).filter(Boolean).map(l=>{
    const parts=l.split(/[;|]/).map(s=>s.trim());
    if(parts.length<2) return null;
    const nome=parts[0].toLowerCase();
    const group=parseInt(parts[1])-1; // 1-based to 0-based
    const aluno=lista.find(a=>(a.nome||'').toLowerCase().includes(nome));
    if(aluno&&group>=0&&group<maxGroups) return {id:aluno.id,group};
    return null;
  }).filter(Boolean);
}

function _grpViolatesSeparation(aluno,grupo,pairs){
  if(!pairs.length) return false;
  const nomeA=(aluno.nome||'').toLowerCase();
  return grupo.some(mem=>{
    const nomeB=(mem.nome||'').toLowerCase();
    return pairs.some(([p1,p2])=>(nomeA.includes(p1)&&nomeB.includes(p2))||(nomeA.includes(p2)&&nomeB.includes(p1)));
  });
}

// F19: Copy as text
function grpCopiarTexto(){
  if(!grpUltimoResultado.length) return showToast("Gere grupos primeiro.","error");
  let txt=`GRUPOS — ${filtroTurma} — ${new Date().toLocaleDateString('pt-BR')}\n\n`;
  grpUltimoResultado.forEach((g,i)=>{
    txt+=`${GRP_NAMES[i%GRP_NAMES.length]} (${g.length}):\n`;
    g.forEach(a=>txt+=`  • ${a.nome}\n`);
    txt+='\n';
  });
  navigator.clipboard.writeText(txt).then(()=>showToast("Copiado!")).catch(()=>{
    // Fallback
    const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast("Copiado!");
  });
}

// F20: Print groups
function grpImprimir(){
  if(!grpUltimoResultado.length) return showToast("Gere grupos primeiro.","error");
  const w=window.open('','_blank','width=700,height=600');
  w.document.write(`<html><head><title>Grupos — ${_escHTML(filtroTurma)}</title>
  <style>body{font-family:sans-serif;padding:20px;}h2{text-align:center;}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
  .card{border:1px solid #ccc;border-radius:6px;padding:8px;border-left:4px solid var(--c);}
  .title{font-weight:bold;border-bottom:1px solid #eee;padding-bottom:3px;margin-bottom:4px;}
  .member{font-size:.9rem;margin:2px 0;}</style></head><body>
  <h2>Grupos — ${_escHTML(filtroTurma)} — ${new Date().toLocaleDateString('pt-BR')}</h2><div class="grid">`);
  grpUltimoResultado.forEach((g,i)=>{
    const color=GRP_COLORS[i%GRP_COLORS.length];
    w.document.write(`<div class="card" style="--c:${color};border-left-color:${color};"><div class="title" style="color:${color};">${GRP_NAMES[i%GRP_NAMES.length]} (${g.length})</div>`);
    g.forEach(a=>w.document.write(`<div class="member">${_escHTML(a.nome)}</div>`));
    w.document.write('</div>');
  });
  w.document.write('</div></body></html>');
  w.document.close();
  setTimeout(()=>w.print(),300);
}

// ================================================================
// RANKING SYSTEM — Gamificação por Sala
// ================================================================
(function(){

// --- Persistência ---
const RANK_KEY = 'sgp_ranking_v1';
function _rankLoad(){
    try{ return JSON.parse(localStorage.getItem(RANK_KEY)) || {}; }catch(_){ return {}; }
}
function _rankSave(data){
    try{ __safeLSSet(RANK_KEY, JSON.stringify(data)); }catch(_){}
    try{ __idbSaveState(); }catch(_){}
}

// Estrutura: { [turma]: { [bimestre]: { [alunoId]: { notas:N, comportamento:N, participacao:N, bonus:N, historico:[...] } } } }
function _rankGetTurma(){
    const data = _rankLoad();
    const turma = filtroTurma || 'Todas';
    const bim = bimestreAtual || 1;
    if(!data[turma]) data[turma] = {};
    if(!data[turma][bim]) data[turma][bim] = {};
    return { data, turma, bim, pontos: data[turma][bim] };
}

function _rankGetPontos(alunoId){
    const { pontos } = _rankGetTurma();
    const p = pontos[alunoId];
    if(!p) return { notas:0, comportamento:0, participacao:0, bonus:0, historico:[] };
    return { notas:p.notas||0, comportamento:p.comportamento||0, participacao:p.participacao||0, bonus:p.bonus||0, historico:p.historico||[] };
}

function _rankTotal(p){ return (p.notas||0) + (p.comportamento||0) + (p.participacao||0) + (p.bonus||0); }

// --- Auto-sync: Calculate auto-points from frequency and grades ---
// Performance cache to avoid recalculating on every render
let __rankAutoSyncCache = { version: -1, freqVersion: -1, turma: '', bim: 0 };

function _rankCalcAutoFreq(alunoId, turma, bim){
    // Count all P marks for this student in this turma/bimestre
    const freq = window.__sgpFrequencia || {};
    let count = 0;
    Object.keys(freq).forEach(key => {
        const parts = key.split('|');
        if(parts[0] === turma && parseInt(parts[1]) === bim){
            const reg = freq[key] || {};
            if(reg[alunoId] === 'P') count++;
        }
    });
    return count;
}

function _rankCalcAutoGrades(alunoId, turma, bim){
    // Sum all grades from all disciplines for this student
    try{
        const aluno = alunos.find(a => String(a.id) === String(alunoId) && a.turma === turma);
        if(!aluno || !aluno.bimestres || !aluno.bimestres[bim]) return 0;
        const b = aluno.bimestres[bim];
        _syncBimestreRefs(b);
        
        let totalPts = 0;
        const discs = config.disciplinas || [];
        discs.forEach(disc => {
            const notas = (b.notas_disc && b.notas_disc[disc.id]) ? b.notas_disc[disc.id] : {};
            (disc.avaliacoes || []).forEach(av => {
                const nota = parseFloat(notas[av.id]);
                if(nota > 0 && !isNaN(nota)){
                    totalPts += Math.round(nota);
                }
            });
        });
        return totalPts;
    }catch(_){ return 0; }
}

// --- Sync auto-points into ranking data ---
function _rankSyncAuto(){
    try{
        const turma = filtroTurma || 'Todas';
        if(turma === 'Todas') return;
        const bim = bimestreAtual || 1;
        
        // Skip if nothing changed since last sync
        const freqV = window.__sgpFreqVersion || 0;
        const coreV = parseInt(localStorage.getItem('sgp_last_core_save')||'0') || 0;
        if(__rankAutoSyncCache.turma === turma && __rankAutoSyncCache.bim === bim
           && __rankAutoSyncCache.freqVersion === freqV && __rankAutoSyncCache.version === coreV){
            return; // Cache hit — skip expensive recalculation
        }
        
        const { data } = _rankGetTurma();
        if(!data[turma]) data[turma] = {};
        if(!data[turma][bim]) data[turma][bim] = {};
        const pontos = data[turma][bim];
        
        const lista = alunos.filter(a => a.turma === turma);
        lista.forEach(a => {
            const id = String(a.id);
            if(!pontos[id]) pontos[id] = { notas:0, comportamento:0, participacao:0, bonus:0, historico:[] };
            
            // Calculate auto points
            const autoFreq = _rankCalcAutoFreq(id, turma, bim);
            const autoGrades = _rankCalcAutoGrades(id, turma, bim);
            
            // Store auto-tracked values
            pontos[id]._autoParticipacao = autoFreq;
            pontos[id]._autoNotas = autoGrades;
        });
        
        _rankSave(data);
        
        // Update cache
        __rankAutoSyncCache = { version: coreV, freqVersion: freqV, turma, bim };
    }catch(_){}
}

// Override _rankGetPontos to include auto-points
const __origRankGetPontos = _rankGetPontos;
function _rankGetPontosWithAuto(alunoId){
    const { pontos } = _rankGetTurma();
    const p = pontos[String(alunoId)];
    if(!p) return { notas:0, comportamento:0, participacao:0, bonus:0, historico:[], _autoParticipacao:0, _autoNotas:0 };
    return {
        notas: (p.notas||0) + (p._autoNotas||0),
        comportamento: p.comportamento||0,
        participacao: (p.participacao||0) + (p._autoParticipacao||0),
        bonus: p.bonus||0,
        historico: p.historico||[],
        _autoParticipacao: p._autoParticipacao||0,
        _autoNotas: p._autoNotas||0,
        _manualNotas: p.notas||0,
        _manualParticipacao: p.participacao||0
    };
}

function _rankAddPontos(alunoId, categoria, valor, motivo){
    const { data, turma, bim, pontos } = _rankGetTurma();
    if(!pontos[alunoId]) pontos[alunoId] = { notas:0, comportamento:0, participacao:0, bonus:0, historico:[] };
    pontos[alunoId][categoria] = (pontos[alunoId][categoria]||0) + valor;
    pontos[alunoId].historico.push({
        cat: categoria,
        val: valor,
        motivo: motivo || '',
        data: new Date().toLocaleDateString('pt-BR'),
        ts: Date.now()
    });
    // Keep last 100 entries per student
    if(pontos[alunoId].historico.length > 100) pontos[alunoId].historico = pontos[alunoId].historico.slice(-100);
    _rankSave(data);
}

// --- Cores consistentes por aluno ---
const RANK_AVATAR_COLORS = ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316','#6366f1','#14b8a6','#e11d48','#84cc16','#0ea5e9','#d946ef','#22c55e','#eab308'];
function _rankAvatarColor(idx){ return RANK_AVATAR_COLORS[idx % RANK_AVATAR_COLORS.length]; }
function _rankInitials(nome){ 
    const parts = (nome||'').trim().split(/\s+/);
    if(parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
    return (nome||'?')[0].toUpperCase();
}

// --- Ranking calculado ---
function _rankBuild(categoria){
    // Sync auto-points from frequency and grades before building
    try{ _rankSyncAuto(); }catch(_){}
    
    const lista = getAlunosFiltrados();
    const cat = categoria || 'total';
    
    const ranked = lista.map((a, idx) => {
        const p = _rankGetPontosWithAuto(a.id);
        const total = cat === 'total' ? _rankTotal(p) : (p[cat]||0);
        return { aluno: a, pontos: p, total, idx };
    });
    
    ranked.sort((a,b) => b.total - a.total || a.aluno.nome.localeCompare(b.aluno.nome));
    return ranked;
}

// --- Confetti ---
function _rankConfetti(){
    const container = document.createElement('div');
    container.className = 'confetti-burst';
    document.body.appendChild(container);
    const colors = ['#f59e0b','#ef4444','#3b82f6','#10b981','#8b5cf6','#ec4899','#06b6d4','#22c55e'];
    for(let i=0; i<60; i++){
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random()*100 + '%';
        piece.style.top = '-10px';
        piece.style.background = colors[Math.floor(Math.random()*colors.length)];
        piece.style.borderRadius = Math.random()>0.5 ? '50%' : '2px';
        piece.style.width = (6 + Math.random()*8) + 'px';
        piece.style.height = (6 + Math.random()*8) + 'px';
        piece.style.animationDelay = (Math.random()*0.5) + 's';
        piece.style.animationDuration = (1 + Math.random()*1.5) + 's';
        container.appendChild(piece);
    }
    setTimeout(()=>container.remove(), 3000);
}

// --- Renderizar Podium ---
function _renderPodium(ranked){
    const podium = document.getElementById('rankPodium');
    if(!podium) return;
    
    const slots = [
        ranked[1] || null, // 2nd place (left)
        ranked[0] || null, // 1st place (center)
        ranked[2] || null  // 3rd place (right)
    ];
    const positions = [2, 1, 3];
    
    let html = '';
    slots.forEach((item, i) => {
        const pos = positions[i];
        if(!item || item.total <= 0){
            html += `<div class="podium-slot podium-empty" data-pos="${pos}">
                <div class="podium-avatar" style="background:#cbd5e1;">?</div>
                <div class="podium-base">
                    <div class="podium-name">—</div>
                    <div class="podium-points">0 pts</div>
                </div>
            </div>`;
            return;
        }
        const a = item.aluno;
        const color = _rankAvatarColor(item.idx);
        const initials = _rankInitials(a.nome);
        const crown = pos === 1 ? '<div class="podium-crown">👑</div>' : '';
        const medalLabel = pos === 1 ? '🥇' : (pos === 2 ? '🥈' : '🥉');
        
        html += `<div class="podium-slot" data-pos="${pos}">
            ${crown}
            <div class="podium-avatar" style="background:${color};">
                ${initials}
                <div class="podium-medal">${medalLabel}</div>
            </div>
            <div class="podium-base">
                <div class="podium-name" title="${_escHTML(a.nome)}">${_escHTML(_mapaNomeCurto(a.nome))}</div>
                <div class="podium-points">${item.total} pts</div>
            </div>
        </div>`;
    });
    
    podium.innerHTML = html;
}

// --- Renderizar Lista ---
function _renderList(ranked){
    const list = document.getElementById('rankList');
    if(!list) return;
    
    if(ranked.length === 0){
        list.innerHTML = `<div class="ranking-empty"><i class="fas fa-trophy"></i><p><b>Nenhum aluno encontrado</b></p><p>Selecione uma turma e comece a adicionar pontos!</p></div>`;
        return;
    }
    
    const maxPts = ranked[0] ? ranked[0].total : 1;
    
    let html = `<div class="ranking-list-header">
        <span>#</span><span>Aluno</span><span>Progresso</span><span>Detalhes</span><span>Pts</span>
    </div>`;
    
    // Show ALL students in the list (including top 3 from podium)
    ranked.forEach((item, i) => {
        const pos = i + 1;
        const a = item.aluno;
        const p = item.pontos;
        const color = _rankAvatarColor(item.idx);
        const initials = _rankInitials(a.nome);
        const pct = maxPts > 0 ? Math.round((item.total / maxPts)*100) : 0;
        const streak = _rankGetStreak(p);
        const streakHtml = streak >= 3 ? `<span class="rank-streak"><i class="fas fa-fire"></i> ${streak}x</span>` : '';
        
        // Medal badge for top 3
        let posHtml;
        if(pos === 1) posHtml = `<span class="rank-pos-badge gold">1</span>`;
        else if(pos === 2) posHtml = `<span class="rank-pos-badge silver">2</span>`;
        else if(pos === 3) posHtml = `<span class="rank-pos-badge bronze">3</span>`;
        else posHtml = `${pos}º`;
        
        html += `<div class="rank-row${pos <= 3 ? ' rank-row-top3' : ''}">
            <div class="rank-pos">${posHtml}</div>
            <div class="rank-student">
                <div class="rank-student-avatar" style="background:${color};">${initials}</div>
                <div class="rank-student-info">
                    <div class="rank-student-name" title="${_escHTML(a.nome)}">${_escHTML(a.nome)}</div>
                    <div class="rank-student-turma">${_escHTML(a.turma)} ${streakHtml}</div>
                </div>
            </div>
            <div class="rank-bar-wrap">
                <div class="rank-bar" style="width:${pct}%;background:${color};opacity:0.7;"></div>
                <div class="rank-bar-label">${pct}%</div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:0.68rem;color:var(--text-muted);" title="Notas${p._autoNotas ? ' ('+p._manualNotas+' manual + '+p._autoNotas+' auto)' : ''}">📝${p.notas||0}</span>
                <span style="font-size:0.68rem;color:var(--text-muted);" title="Comportamento">⭐${p.comportamento||0}</span>
                <span style="font-size:0.68rem;color:var(--text-muted);" title="Participação${p._autoParticipacao ? ' ('+p._manualParticipacao+' manual + '+p._autoParticipacao+' presenças)' : ''}">🙋${p.participacao||0}</span>
                <span style="font-size:0.68rem;color:var(--text-muted);" title="Bônus">🎁${p.bonus||0}</span>
            
                <button data-onclick="rankAbrirHistoricoAluno(${JSON.stringify(a.id)})" title="Histórico de pontos" style="border:none;background:transparent;cursor:pointer;font-size:0.78rem;line-height:1;padding:2px 6px;border-radius:8px;color:var(--text-muted);">📜</button>
                <button class="rank-mini-btn minus" data-onclick="rankAjusteRapido(${JSON.stringify(a.id)}, -1)" title="-1 ponto" aria-label="Tirar ponto"><i class="fas fa-minus"></i></button>
                <button class="rank-mini-btn plus" data-onclick="rankAjusteRapido(${JSON.stringify(a.id)}, 1)" title="+1 ponto" aria-label="Adicionar ponto"><i class="fas fa-plus"></i></button>
            </div>
            <div class="rank-total">${item.total}</div>
        </div>`;
    });
    
    list.innerHTML = html;
}

// --- Streak calculation ---
function _rankGetStreak(p){
    if(!p.historico || p.historico.length < 2) return 0;
    const sorted = [...p.historico].sort((a,b)=>(b.ts||0)-(a.ts||0));
    let streak = 0;
    const seen = new Set();
    for(const h of sorted){
        if(h.val > 0 && !seen.has(h.data)){
            streak++;
            seen.add(h.data);
        } else if(h.val <= 0) break;
    }
    return streak;
}

// --- Badges summary ---
function _renderBadges(ranked){
    const row = document.getElementById('rankBadgesRow');
    if(!row) return;
    const lista = getAlunosFiltrados();
    const total = ranked.reduce((s,r)=>s+r.total, 0);
    const avg = lista.length > 0 ? Math.round(total/lista.length) : 0;
    const withPts = ranked.filter(r=>r.total>0).length;
    
    row.innerHTML = `
        <span class="ranking-badge"><i class="fas fa-users"></i> ${lista.length} alunos</span>
        <span class="ranking-badge"><i class="fas fa-star"></i> ${total} pts total</span>
        <span class="ranking-badge"><i class="fas fa-chart-line"></i> Média: ${avg} pts</span>
        <span class="ranking-badge"><i class="fas fa-medal"></i> ${withPts} com pontos</span>
    `;
}

// --- Main render ---
window.renderizarRanking = function(){
    const cat = document.getElementById('rankCategoria')?.value || 'total';
    const ranked = _rankBuild(cat);
    _renderPodium(ranked);
    _renderList(ranked);
    _renderBadges(ranked);
    _setupScrollHint();
};

// --- Scroll hint: hide when user scrolls past podium ---
function _setupScrollHint(){
    const body = document.getElementById('rankScrollBody');
    const hint = document.getElementById('rankScrollHint');
    if(!body || !hint) return;
    // Se estiver usando a rolagem da tela principal (não fullscreen), o hint não faz sentido
    if(document.body && document.body.classList && document.body.classList.contains('ranking-view') && !document.body.classList.contains('ranking-is-fullscreen') && !document.fullscreenElement){
        hint.classList.add('hidden');
        body.onscroll = null;
        return;
    }

    // Show hint only if content overflows
    if(body.scrollHeight <= body.clientHeight + 20){
        hint.classList.add('hidden');
    } else {
        hint.classList.remove('hidden');
    }
    // Hide on scroll
    body.onscroll = function(){
        if(body.scrollTop > 40) hint.classList.add('hidden');
        else hint.classList.remove('hidden');
    };
}

// --- Modal: Adicionar Pontos ---
window.rankAddPontosModal = function(){
    const modal = document.getElementById('modalRankPontos');
    const select = document.getElementById('rankPontosAluno');
    if(!modal || !select) return;
    
    const lista = getAlunosFiltrados().sort((a,b)=>a.nome.localeCompare(b.nome));
    select.innerHTML = lista.map(a => `<option value="${a.id}">${_escHTML(a.nome)}</option>`).join('');
    
    document.getElementById('rankPontosValor').value = 1;
    document.getElementById('rankPontosMotivo').value = '';
    document.getElementById('rankPontosCategoria').value = 'participacao';
    
    // Clear quick btn active states
    document.querySelectorAll('.rank-quick-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.rank-quick-btn')?.classList.add('active');
    
    modal.style.display = 'flex';
};

window.fecharModalRankPontos = function(){
    const modal = document.getElementById('modalRankPontos');
    if(modal) modal.style.display = 'none';
};

window.rankSetPontos = function(val){
    document.getElementById('rankPontosValor').value = val;
    document.querySelectorAll('.rank-quick-btn').forEach(b=>{
        b.classList.toggle('active', b.textContent.trim() === '+'+val);
    });
};

window.rankConfirmarPontos = function(){
    const select = document.getElementById('rankPontosAluno');
    const cat = document.getElementById('rankPontosCategoria').value;
    const val = parseFloat(document.getElementById('rankPontosValor').value) || 0;
    const motivo = document.getElementById('rankPontosMotivo').value.trim();
    
    if(val === 0){ showToast('Valor não pode ser zero', 'error'); return; }
    
    const selectedIds = Array.from(select.selectedOptions).map(o => parseFloat(o.value) || o.value);
    if(selectedIds.length === 0){ showToast('Selecione ao menos um aluno', 'error'); return; }
    
    // Check previous #1 to detect change
    const oldRanked = _rankBuild('total');
    const oldFirst = oldRanked[0]?.aluno?.id;
    
    selectedIds.forEach(id => _rankAddPontos(id, cat, val, motivo));
    
    const catNames = { notas:'Notas', comportamento:'Comportamento', participacao:'Participação', bonus:'Bônus' };
    const sign = val > 0 ? '+' : '';
    showToast(`${sign}${val} pts (${catNames[cat]}) → ${selectedIds.length} aluno(s)`);
    
    // Check if #1 changed
    const newRanked = _rankBuild('total');
    const newFirst = newRanked[0]?.aluno?.id;
    if(newFirst && newFirst !== oldFirst && newRanked[0]?.total > 0){
        setTimeout(_rankConfetti, 300);
    }
    
    fecharModalRankPontos();
    renderizarRanking();
};


// --- Ajuste rápido (+/-) por aluno ---
window.rankAjusteRapido = function(alunoId, delta){
    try{
        const sel = document.getElementById('rankCategoria');
        const selected = sel ? sel.value : 'participacao';
        const catNames = { notas:'Notas', comportamento:'Comportamento', participacao:'Participação', bonus:'Bônus' };
        const cat = (selected === 'total') ? 'bonus' : selected;
        const val = (typeof delta === 'number') ? delta : (parseFloat(delta)||0);
        if(!val){ return; }

        const oldRanked = _rankBuild('total');
        const oldFirst = oldRanked[0]?.aluno?.id;

        _rankAddPontos(alunoId, cat, val, 'Ajuste rápido');

        const sign = val > 0 ? '+' : '';
        showToast(`${sign}${val} pt (${catNames[cat]||cat})`);

        const newRanked = _rankBuild('total');
        const newFirst = newRanked[0]?.aluno?.id;
        if(newFirst && newFirst !== oldFirst && newRanked[0]?.total > 0){
            setTimeout(_rankConfetti, 200);
        }

        renderizarRanking();
    }catch(err){
        console.error('rankAjusteRapido', err);
        try{ showToast('Falha ao ajustar pontos', 'error'); }catch(_){}
    }
};


// --- Histórico de Pontos (Aluno) ---
window.rankAbrirHistoricoAluno = function(alunoId){
    try{
        window.__rankAlunoHistCtx = { alunoId: alunoId };
        const aluno = (Array.isArray(alunos) ? alunos : []).find(a=>String(a.id)===String(alunoId))
                   || (typeof getAlunosFiltrados==='function' ? getAlunosFiltrados().find(a=>String(a.id)===String(alunoId)) : null);
        const nome = aluno ? aluno.nome : ('Aluno ' + alunoId);
        const title = document.getElementById('rankAlunoHistTitle');
        if(title) title.innerHTML = `<i class="fas fa-clipboard-list" style="color:#0ea5e9;"></i> Histórico de Pontos — ${_escHTML(nome)}`;

        const inp = document.getElementById('rankAlunoHistBusca');
        if(inp) inp.value = '';
        const sel = document.getElementById('rankAlunoHistCat');
        if(sel) sel.value = '';

        const modal = document.getElementById('modalRankAlunoHist');
        if(modal) modal.style.display = 'flex';
        rankAlunoHistRender();
    }catch(e){
        console.error(e);
        showToast('Erro ao abrir histórico de pontos', 'error');
    }
};

window.rankAlunoHistFechar = function(){
    const modal = document.getElementById('modalRankAlunoHist');
    if(modal) modal.style.display = 'none';
};

window.rankAlunoHistRender = function(){
    const ctx = window.__rankAlunoHistCtx || {};
    const alunoId = ctx.alunoId;
    const body = document.getElementById('rankAlunoHistBody');
    if(!body || alunoId === null || typeof alunoId === 'undefined') return;

    const q = (document.getElementById('rankAlunoHistBusca')?.value || '').trim().toLowerCase();
    const catFilter = document.getElementById('rankAlunoHistCat')?.value || '';

    const { pontos } = _rankGetTurma();
    const p = pontos[String(alunoId)] || pontos[alunoId] || null;
    const hist = (p && Array.isArray(p.historico)) ? p.historico.slice() : [];
    hist.sort((a,b)=>(b.ts||0)-(a.ts||0));

    const catNames = { notas:'Notas', comportamento:'Comportamento', participacao:'Participação', bonus:'Bônus' };
    const catIcons = { notas:'📝', comportamento:'⭐', participacao:'🙋', bonus:'🎁' };

    let rows = hist.filter(h=>{
        if(catFilter && String(h.cat||'') !== String(catFilter)) return false;
        if(q){
            const m = (h.motivo||'').toLowerCase();
            if(!m.includes(q) && !String(h.val||'').includes(q) && !String(h.data||'').includes(q)) return false;
        }
        return true;
    });

    // Resumo de pontos automáticos (derivados de chamada/notas)
    let autoInfo = '';
    try{
        if(typeof _rankGetPontosWithAuto === 'function'){
            const pa = _rankGetPontosWithAuto(alunoId);
            const autoNotas = pa? (pa._autoNotas||0) : 0;
            const autoPart  = pa? (pa._autoParticipacao||0) : 0;
            if(autoNotas || autoPart){
                const signN = autoNotas>0?'+':'';
                const signP = autoPart>0?'+':'';
                autoInfo = `<div style="padding:10px;border:1px dashed var(--border-color);border-radius:12px;margin-bottom:10px;background:var(--card-bg);">
                    <div style="font-weight:800;margin-bottom:4px;">Pontos automáticos (derivados de registros)</div>
                    <div style="color:var(--text-muted);font-size:0.9rem;">📝 ${signN}${autoNotas} (Notas) &nbsp;&nbsp; 🙋 ${signP}${autoPart} (Presenças)</div>
                </div>`;
            }
        }
    }catch(_){}

    if(rows.length === 0){
        body.innerHTML = autoInfo + `<div style="padding:14px;color:var(--text-muted);"><b>Nenhum registro manual encontrado.</b><div style="margin-top:6px;font-size:0.9em;">Adicione pontos e preencha <b>Motivo / Atividade</b> para registrar o nome da atividade.</div></div>`;
        return;
    }

    let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
    rows.forEach(h=>{
        const dt = h.ts ? new Date(h.ts).toLocaleString('pt-BR') : (h.data||'');
        const val = (typeof h.val === 'number') ? h.val : (parseFloat(h.val)||0);
        const sign = val > 0 ? '+' : '';
        const motivo = (h.motivo||'').trim();
        const motivoHtml = motivo ? _escHTML(motivo) : `<span style="color:var(--text-muted);">(sem motivo/atividade)</span>`;
        const c = h.cat || '';
        html += `<div style="display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--border-color);border-radius:12px;background:var(--card-bg);">
            <div style="min-width:170px;font-size:0.8rem;color:var(--text-muted);">${_escHTML(dt)}</div>
            <div style="flex:1;">
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <span style="font-weight:800;">${catIcons[c]||'🏷️'} ${_escHTML(catNames[c]||c||'')}</span>
                    <span style="font-weight:900;color:var(--primary);">${sign}${val} pts</span>
                </div>
                <div style="margin-top:4px;">${motivoHtml}</div>
            </div>
        </div>`;
    });
    html += `</div>`;
    body.innerHTML = autoInfo + html;
};

// --- Exportar ranking ---
window.rankExportarPDF = function(){
    const cat = document.getElementById('rankCategoria')?.value || 'total';
    const ranked = _rankBuild(cat);
    if(ranked.length===0){ showToast('Nenhum dado','error'); return; }
    
    const w = window.open('','_blank');
    const turma = filtroTurma || 'Todas';
    w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Ranking - ${_escHTML(turma)}</title>
    <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
    body{padding:30px;color:#1e293b;}
    h1{text-align:center;margin-bottom:8px;font-size:1.8rem;}
    .sub{text-align:center;color:#64748b;margin-bottom:24px;font-size:.9rem;}
    .podium{display:flex;justify-content:center;align-items:flex-end;gap:0;margin:24px 0;}
    .pod{text-align:center;padding:16px 24px 12px;border-radius:12px 12px 0 0;}
    .pod.g{background:#fef3c7;border:2px solid #f59e0b;height:160px;width:150px;}
    .pod.s{background:#f1f5f9;border:2px solid #94a3b8;height:120px;width:130px;}
    .pod.b{background:#fed7aa;border:2px solid #d97706;height:90px;width:130px;}
    .pod .medal{font-size:2rem;}
    .pod .name{font-weight:800;font-size:1rem;margin-top:6px;}
    .pod .pts{font-weight:900;font-size:1.2rem;color:#2563eb;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th{background:#f1f5f9;padding:10px;text-align:left;font-size:.8rem;text-transform:uppercase;border-bottom:2px solid #e2e8f0;}
    td{padding:10px;border-bottom:1px solid #f1f5f9;}
    tr:nth-child(even){background:#f8fafc;}
    .pos{font-weight:900;text-align:center;width:40px;}
    .total{font-weight:900;color:#2563eb;text-align:center;}
    @media print{body{padding:15px;} .pod{height:auto!important;padding:12px!important;}}
    </style></head><body>`);
    
    w.document.write(`<h1>🏆 Ranking da Sala</h1><div class="sub">${_escHTML(turma)} — Bimestre ${bimestreAtual} — ${new Date().toLocaleDateString('pt-BR')}</div>`);
    
    // Podium
    const top3 = ranked.slice(0,3);
    if(top3.length >= 1){
        const slots = [top3[1]||null, top3[0], top3[2]||null];
        const medals = ['🥈','🥇','🥉'];
        const cls = ['s','g','b'];
        w.document.write('<div class="podium">');
        slots.forEach((s,i) => {
            if(!s || s.total<=0){ w.document.write(`<div class="pod ${cls[i]}" style="opacity:0.3"><div class="medal">${medals[i]}</div><div class="name">—</div><div class="pts">0</div></div>`); return; }
            w.document.write(`<div class="pod ${cls[i]}"><div class="medal">${medals[i]}</div><div class="name">${_escHTML(s.aluno.nome.split(' ')[0])}</div><div class="pts">${s.total} pts</div></div>`);
        });
        w.document.write('</div>');
    }
    
    // Table
    w.document.write('<table><thead><tr><th class="pos">#</th><th>Aluno</th><th>Notas</th><th>Comp.</th><th>Part.</th><th>Bônus</th><th class="total">Total</th></tr></thead><tbody>');
    ranked.forEach((item,i)=>{
        const p = item.pontos;
        w.document.write(`<tr><td class="pos">${i+1}º</td><td>${_escHTML(item.aluno.nome)}</td><td>${p.notas||0}</td><td>${p.comportamento||0}</td><td>${p.participacao||0}</td><td>${p.bonus||0}</td><td class="total">${item.total}</td></tr>`);
    });
    w.document.write('</tbody></table></body></html>');
    w.document.close();
    setTimeout(()=>w.print(),400);
};

// --- Resetar pontos ---
window.rankResetar = function(){
    if(!confirm('Tem certeza que deseja resetar todos os pontos desta turma neste bimestre?\n\nEsta ação não pode ser desfeita.')) return;
    const { data, turma, bim } = _rankGetTurma();
    data[turma][bim] = {};
    _rankSave(data);
    showToast('Pontos resetados');
    renderizarRanking();
};

// --- Quick add from cards (bonus integration) ---
window.rankQuickAdd = function(alunoId, val, cat){
    _rankAddPontos(alunoId, cat||'participacao', val||1, 'Ponto rápido');
    if(visaoAtual === 'ranking') renderizarRanking();
};

// ======================================================
// HISTÓRICO SEMANAL DO RANKING
// ======================================================
const RANK_HIST_CFG_KEY = 'sgp_rank_hist_cfg';
let __rankHistView = 'semanal';

const DIAS_SEMANA = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];

function _rankHistLoadCfg(){
    try{ return JSON.parse(localStorage.getItem(RANK_HIST_CFG_KEY)) || {}; }catch(_){ return {}; }
}
function _rankHistSaveCfg(cfg){
    try{ __safeLSSet(RANK_HIST_CFG_KEY, JSON.stringify(cfg)); }catch(_){}
}

function _rankHistGetDiaFim(diaInicio){
    // End day is always start - 1 (wrapping around)
    return (parseInt(diaInicio) + 6) % 7;
}

function _rankHistUpdateDiaFim(){
    const sel = document.getElementById('rankHistDiaInicio');
    const lbl = document.getElementById('rankHistDiaFim');
    if(!sel || !lbl) return;
    const diaFim = _rankHistGetDiaFim(sel.value);
    lbl.textContent = DIAS_SEMANA[diaFim];
}

// Get the start of the week containing a given date
function _rankHistWeekStart(date, diaInicio){
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const diff = (d.getDay() - diaInicio + 7) % 7;
    d.setDate(d.getDate() - diff);
    return d;
}

// Get week end (6 days after start)
function _rankHistWeekEnd(weekStart){
    const d = new Date(weekStart);
    d.setDate(d.getDate() + 6);
    d.setHours(23,59,59,999);
    return d;
}

// Format date as dd/mm/yyyy
function _rankHistFmtDate(d){
    return d.toLocaleDateString('pt-BR');
}

// Format date as dd/mm
function _rankHistFmtShort(d){
    return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0');
}

// Build all weeks from historico data
function _rankHistBuildWeeks(){
    const diaInicio = parseInt(document.getElementById('rankHistDiaInicio')?.value ?? 5);
    const dataInicioStr = document.getElementById('rankHistDataInicio')?.value;
    const dataFimStr = document.getElementById('rankHistDataFim')?.value;
    const dataInicioFilter = dataInicioStr ? new Date(dataInicioStr + 'T00:00:00') : null;
    const dataFimFilter = dataFimStr ? new Date(dataFimStr + 'T23:59:59') : null;

    // CRITICAL: sync auto-points before reading (same as _rankBuild does)
    try{ _rankSyncAuto(); }catch(_){}

    const { pontos } = _rankGetTurma();
    const lista = getAlunosFiltrados();
    const CATS = ['notas','comportamento','participacao','bonus'];

    // Pre-compute the FULL ranking totals (with auto) for each student
    // This uses the SAME logic as the main ranking (_rankBuild → _rankGetPontosWithAuto)
    const rankingTotals = {};
    lista.forEach(a => {
        const id = String(a.id);
        const p = _rankGetPontosWithAuto(a.id);
        rankingTotals[id] = {
            total: _rankTotal(p),
            notas: p.notas||0,
            comportamento: p.comportamento||0,
            participacao: p.participacao||0,
            bonus: p.bonus||0,
            _autoNotas: p._autoNotas||0,
            _autoParticipacao: p._autoParticipacao||0,
            _manualNotas: p._manualNotas||0,
            _manualParticipacao: p._manualParticipacao||0
        };
    });

    // Also compute the stored manual running totals (pontos[id].cat)
    // These are the TRUE manual totals (historico may be truncated at 100 entries)
    const manualTotals = {};
    lista.forEach(a => {
        const id = String(a.id);
        const p = pontos[id];
        if(!p) { manualTotals[id] = { notas:0, comportamento:0, participacao:0, bonus:0, total:0 }; return; }
        const mt = { notas: p.notas||0, comportamento: p.comportamento||0, participacao: p.participacao||0, bonus: p.bonus||0 };
        mt.total = mt.notas + mt.comportamento + mt.participacao + mt.bonus;
        manualTotals[id] = mt;
    });

    // Collect all historico entries with their timestamps
    let allEntries = [];
    let minTs = Infinity, maxTs = 0;
    
    lista.forEach(a => {
        const id = String(a.id);
        const p = pontos[id];
        if(!p || !p.historico) return;
        p.historico.forEach(h => {
            if(!h.ts) return;
            const ts = h.ts;
            if(dataInicioFilter && ts < dataInicioFilter.getTime()) return;
            if(dataFimFilter && ts > dataFimFilter.getTime()) return;
            allEntries.push({ ...h, alunoId: id, alunoNome: a.nome });
            if(ts < minTs) minTs = ts;
            if(ts > maxTs) maxTs = ts;
        });
    });

    if(allEntries.length === 0) return { weeks: [], rankingTotals, manualTotals };

    // Generate week ranges
    const firstWeekStart = _rankHistWeekStart(new Date(minTs), diaInicio);
    const lastWeekStart = _rankHistWeekStart(new Date(maxTs), diaInicio);
    
    const weeks = [];
    let ws = new Date(firstWeekStart);
    while(ws <= lastWeekStart){
        const we = _rankHistWeekEnd(ws);
        weeks.push({ start: new Date(ws), end: new Date(we), entries: [] });
        ws.setDate(ws.getDate() + 7);
    }

    // Assign entries to weeks
    allEntries.forEach(e => {
        const entryDate = new Date(e.ts);
        for(const week of weeks){
            if(entryDate >= week.start && entryDate <= week.end){
                week.entries.push(e);
                break;
            }
        }
    });

    // Build per-student stats for each week
    weeks.forEach((week, wi) => {
        const studentMap = {};
        week.entries.forEach(e => {
            if(!studentMap[e.alunoId]){
                studentMap[e.alunoId] = { id: e.alunoId, nome: e.alunoNome, notas:0, comportamento:0, participacao:0, bonus:0, total:0 };
            }
            const s = studentMap[e.alunoId];
            const cat = e.cat;
            const val = e.val||0;
            if(cat && CATS.includes(cat)){
                s[cat] += val;
            }
            // total = sum of category values only (not unknown cats)
            s.total = s.notas + s.comportamento + s.participacao + s.bonus;
        });
        
        // Sort by total points earned in the week
        week.students = Object.values(studentMap).sort((a,b) => b.total - a.total || a.nome.localeCompare(b.nome));
        week.totalPts = week.students.reduce((s,st) => s + st.total, 0);
        week.idx = wi;
    });

    // Reverse so newest week is first
    weeks.reverse();
    return { weeks, rankingTotals, manualTotals };
}

// Compute cumulative totals up to each week (for evolution view)
function _rankHistBuildEvolution(){
    const result = _rankHistBuildWeeks();
    const weeks = (result.weeks || []).slice().reverse(); // oldest first
    const rankingTotals = result.rankingTotals || {};
    const manualTotals = result.manualTotals || {};
    
    if(weeks.length === 0) return { weeks:[], students:[], rankingTotals, manualTotals };

    const lista = getAlunosFiltrados();

    // Track cumulative manual totals per student per week
    const studentsEvol = [];
    lista.forEach(a => {
        const id = String(a.id);
        const rt = rankingTotals[id] || { total:0 };
        const mt = manualTotals[id] || { total:0 };
        let cumulative = 0;
        const weeklyData = weeks.map(w => {
            const found = w.students?.find(s => s.id === id);
            const weekPts = found ? found.total : 0;
            cumulative += weekPts;
            return { weekPts, cumulative };
        });
        studentsEvol.push({ id, nome: a.nome, weeklyData, finalTotal: cumulative, rankTotal: rt.total, manualTotal: mt.total });
    });

    // Sort by ranking total (the real total)
    studentsEvol.sort((a,b) => b.rankTotal - a.rankTotal || a.nome.localeCompare(b.nome));
    
    return { weeks, students: studentsEvol, rankingTotals, manualTotals };
}

// Render weekly view
function _rankHistRenderSemanal(){
    const body = document.getElementById('rankHistBody');
    if(!body) return;

    const result = _rankHistBuildWeeks();
    const weeks = result.weeks || [];
    const rankingTotals = result.rankingTotals || {};
    const manualTotals = result.manualTotals || {};
    
    if(weeks.length === 0){
        // Even with no manual entries, show auto points if they exist
        const lista = getAlunosFiltrados();
        let hasAutoPoints = false;
        lista.forEach(a => {
            const rt = rankingTotals[String(a.id)];
            if(rt && rt.total > 0) hasAutoPoints = true;
        });
        if(hasAutoPoints){
            let html = `<div style="padding:16px;">
                <div style="text-align:center;padding:16px;color:var(--text-muted);margin-bottom:16px;">
                    <i class="fas fa-robot" style="font-size:2rem;opacity:0.3;display:block;margin-bottom:8px;"></i>
                    <p><b>Sem registros manuais</b></p>
                    <p style="font-size:0.85rem;">Nenhum ponto foi adicionado manualmente, mas existem pontos automáticos (notas e presenças).</p>
                </div>
                <table class="rank-hist-table"><thead><tr>
                    <th style="text-align:center;">#</th><th>Aluno</th>
                    <th style="text-align:center;" title="Total no ranking (inclui automáticos)">Total Ranking</th>
                    <th>Auto</th>
                </tr></thead><tbody>`;
            const sorted = lista.map(a => ({ id: String(a.id), nome: a.nome, rt: rankingTotals[String(a.id)] || {total:0} }))
                .filter(s => s.rt.total > 0)
                .sort((a,b) => b.rt.total - a.rt.total);
            sorted.forEach((s, i) => {
                const autoN = s.rt._autoNotas||0;
                const autoP = s.rt._autoParticipacao||0;
                html += `<tr>
                    <td class="hist-pos">${i+1}º</td>
                    <td class="hist-name">${_escHTML(s.nome)}</td>
                    <td class="hist-pts positive" style="text-align:center;">${s.rt.total}</td>
                    <td class="hist-detail">
                        ${autoN ? '<span title="Notas automáticas (avaliações)">📝auto:'+autoN+'</span>' : ''}
                        ${autoP ? '<span title="Participação automática (presenças)">🙋auto:'+autoP+'</span>' : ''}
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            body.innerHTML = html;
        } else {
            body.innerHTML = `<div class="rank-hist-empty"><i class="fas fa-calendar-xmark"></i><p><b>Nenhum registro encontrado</b></p><p>Adicione pontos aos alunos para ver o histórico semanal.</p></div>`;
        }
        return;
    }

    // Compute global ranking total (with auto) for summary
    const lista = getAlunosFiltrados();
    let rankTotalGeral = 0;
    let autoTotal = 0;
    let manualTotalGeral = 0;
    lista.forEach(a => {
        const id = String(a.id);
        const rt = rankingTotals[id];
        const mt = manualTotals[id];
        if(rt){
            rankTotalGeral += rt.total;
            autoTotal += (rt._autoNotas||0) + (rt._autoParticipacao||0);
        }
        if(mt) manualTotalGeral += mt.total;
    });

    // Summary
    const totalWeeks = weeks.length;
    const totalEntries = weeks.reduce((s,w) => s + w.entries.length, 0);

    let html = `<div class="rank-hist-summary">
        <div class="rank-hist-summary-card"><div class="val">${totalWeeks}</div><div class="lbl">Semanas</div></div>
        <div class="rank-hist-summary-card"><div class="val">${rankTotalGeral}</div><div class="lbl">Total Ranking</div></div>
        <div class="rank-hist-summary-card"><div class="val">${manualTotalGeral}</div><div class="lbl">Pts Manuais</div></div>
        <div class="rank-hist-summary-card"><div class="val">${autoTotal}</div><div class="lbl">Pts Automáticos</div></div>
        <div class="rank-hist-summary-card"><div class="val">${totalEntries}</div><div class="lbl">Registros</div></div>
    </div>`;

    if(autoTotal > 0){
        html += `<div style="padding:4px 16px 8px;font-size:0.75rem;color:var(--text-muted);"><i class="fas fa-info-circle"></i> Pts Automáticos = notas das avaliações + presenças. Aparecem no Total Ranking mas não se distribuem por semana.</div>`;
    }

    weeks.forEach((week, wi) => {
        const isFirst = wi === 0;
        const dateLabel = _rankHistFmtShort(week.start) + ' a ' + _rankHistFmtShort(week.end);
        const yearLabel = week.start.getFullYear();
        const entriesCount = week.entries.length;
        const studentsWithPts = week.students.filter(s => s.total !== 0).length;

        // Check if this is the current week
        const now = new Date();
        const isCurrent = now >= week.start && now <= week.end;
        const weekLabel = isCurrent ? 'Semana Atual' : `Semana ${_rankHistFmtShort(week.start)}`;
        
        html += `<div class="rank-hist-week-card">
            <div class="rank-hist-week-header${isFirst ? ' open' : ''}" data-onclick="rankHistToggleWeek(this)">
                <div class="rank-hist-week-title">
                    <i class="fas fa-chevron-right"></i>
                    ${isCurrent ? '<span style="color:#16a34a;">●</span>' : ''}
                    ${weekLabel} <span style="font-weight:400;color:var(--text-muted);font-size:0.82rem;">(${dateLabel}/${yearLabel})</span>
                </div>
                <div class="rank-hist-week-meta">
                    <span><i class="fas fa-star"></i> ${week.totalPts} pts</span>
                    <span><i class="fas fa-users"></i> ${studentsWithPts} alunos</span>
                    <span><i class="fas fa-list"></i> ${entriesCount} reg.</span>
                </div>
            </div>
            <div class="rank-hist-week-body${isFirst ? ' open' : ''}">`;

        if(week.students.length === 0){
            html += `<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:0.85rem;">Sem registros manuais nesta semana</div>`;
        } else {
            html += `<table class="rank-hist-table"><thead><tr>
                <th style="text-align:center;">#</th><th>Aluno</th><th style="text-align:center;">Pts Semana</th>
                <th>Detalhes</th><th style="text-align:center;" title="Total geral no ranking (inclui automáticos)">Total Ranking</th><th style="text-align:center;">Posição</th>
            </tr></thead><tbody>`;

            // Get previous week for trend comparison
            const prevWeek = wi < weeks.length - 1 ? weeks[wi+1] : null;

            week.students.forEach((s, si) => {
                const pos = si + 1;
                const ptsClass = s.total > 0 ? 'positive' : (s.total < 0 ? 'negative' : 'zero');
                const sign = s.total > 0 ? '+' : '';
                
                // Get ranking total for this student
                const rt = rankingTotals[s.id] || { total: 0 };

                // Trend: compare position with previous week
                let trendHtml = '';
                if(prevWeek){
                    const prevIdx = prevWeek.students.findIndex(ps => ps.id === s.id);
                    if(prevIdx === -1){
                        trendHtml = `<span class="rank-hist-trend up" title="Novo"><i class="fas fa-star"></i> Novo</span>`;
                    } else {
                        const prevPos = prevIdx + 1;
                        const diff = prevPos - pos;
                        if(diff > 0) trendHtml = `<span class="rank-hist-trend up" title="Subiu ${diff}"><i class="fas fa-arrow-up"></i> +${diff}</span>`;
                        else if(diff < 0) trendHtml = `<span class="rank-hist-trend down" title="Desceu ${Math.abs(diff)}"><i class="fas fa-arrow-down"></i> ${diff}</span>`;
                        else trendHtml = `<span class="rank-hist-trend same" title="Manteve">● =</span>`;
                    }
                }

                html += `<tr>
                    <td class="hist-pos">${pos}º</td>
                    <td class="hist-name">${_escHTML(s.nome)}</td>
                    <td class="hist-pts ${ptsClass}">${sign}${s.total}</td>
                    <td class="hist-detail">
                        <span title="Notas">📝${s.notas||0}</span>
                        <span title="Comportamento">⭐${s.comportamento||0}</span>
                        <span title="Participação">🙋${s.participacao||0}</span>
                        <span title="Bônus">🎁${s.bonus||0}</span>
                    </td>
                    <td class="hist-pts" style="text-align:center;color:var(--primary);font-weight:800;" title="Total geral no ranking">${rt.total}</td>
                    <td style="text-align:center;">${trendHtml}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
        }

        html += `</div></div>`;
    });

    body.innerHTML = html;
}

// Render evolution view (table with weeks as columns)
function _rankHistRenderEvolucao(){
    const body = document.getElementById('rankHistBody');
    if(!body) return;

    const { weeks, students, rankingTotals } = _rankHistBuildEvolution();
    
    if(weeks.length === 0 || students.length === 0){
        body.innerHTML = `<div class="rank-hist-empty"><i class="fas fa-chart-line"></i><p><b>Nenhum registro encontrado</b></p><p>Adicione pontos aos alunos para ver a evolução.</p></div>`;
        return;
    }

    // Show students with any ranking total (including auto)
    const activeStudents = students.filter(s => s.rankTotal !== 0);
    if(activeStudents.length === 0){
        body.innerHTML = `<div class="rank-hist-empty"><i class="fas fa-chart-line"></i><p><b>Nenhum aluno com pontos no período</b></p></div>`;
        return;
    }

    let html = `<div style="overflow-x:auto;">
    <table class="rank-hist-table">
    <thead><tr>
        <th style="position:sticky;left:0;z-index:2;background:var(--bg-body);">#</th>
        <th style="position:sticky;left:40px;z-index:2;background:var(--bg-body);min-width:120px;">Aluno</th>`;
    
    weeks.forEach(w => {
        const isCurrent = new Date() >= w.start && new Date() <= w.end;
        const label = _rankHistFmtShort(w.start);
        html += `<th style="text-align:center;min-width:80px;${isCurrent ? 'color:#16a34a;font-weight:900;' : ''}" title="${_rankHistFmtDate(w.start)} a ${_rankHistFmtDate(w.end)}">${label}${isCurrent ? ' ●' : ''}</th>`;
    });
    
    html += `<th style="text-align:center;font-weight:900;min-width:70px;" title="Soma pontos manuais">Manual</th>`;
    html += `<th style="text-align:center;font-weight:900;min-width:70px;" title="Total real no ranking (manual + automático)">Ranking</th></tr></thead><tbody>`;

    activeStudents.forEach((s, si) => {
        const rt = (rankingTotals || {})[s.id] || { total:0, _autoNotas:0, _autoParticipacao:0 };
        const autoTot = (rt._autoNotas||0) + (rt._autoParticipacao||0);

        html += `<tr>
            <td class="hist-pos" style="position:sticky;left:0;z-index:1;background:var(--card-bg);">${si+1}º</td>
            <td class="hist-name" style="position:sticky;left:40px;z-index:1;background:var(--card-bg);">${_escHTML(s.nome)}</td>`;
        
        s.weeklyData.forEach((wd, wi) => {
            const pts = wd.weekPts;
            const cls = pts > 0 ? 'positive' : (pts < 0 ? 'negative' : 'zero');
            const sign = pts > 0 ? '+' : '';
            const cumTip = `Acumulado manual: ${wd.cumulative} pts`;
            html += `<td class="hist-pts ${cls}" style="text-align:center;" title="${cumTip}">${pts !== 0 ? sign+pts : '—'}</td>`;
        });
        
        html += `<td class="hist-pts" style="text-align:center;font-weight:800;color:var(--text-muted);" title="Total manual armazenado">${s.manualTotal}</td>`;
        html += `<td class="hist-pts" style="text-align:center;font-weight:900;color:var(--primary);" title="Manual: ${s.manualTotal} + Auto: ${autoTot}">${s.rankTotal}</td></tr>`;
    });

    html += `</tbody></table></div>`;

    // Add a visual bar chart summary for top 10 using RANKING totals
    const top10 = activeStudents.slice(0, 10);
    const maxTotal = top10[0]?.rankTotal || 1;
    
    html += `<div style="padding:16px;">
        <h4 style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;font-weight:700;">Total Ranking — Top ${Math.min(10, top10.length)}</h4>`;
    
    top10.forEach(s => {
        const rt = (rankingTotals || {})[s.id] || { total:0, _autoNotas:0, _autoParticipacao:0 };
        const autoTot = (rt._autoNotas||0) + (rt._autoParticipacao||0);
        const manualVal = s.manualTotal || s.finalTotal;
        const manualPct = maxTotal > 0 ? Math.round((manualVal / maxTotal) * 100) : 0;
        const autoPct = maxTotal > 0 ? Math.round((autoTot / maxTotal) * 100) : 0;
        const color = _rankAvatarColor(parseInt(s.id) || 0);
        html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <span style="width:100px;font-size:0.78rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_escHTML(s.nome)}">${_escHTML(s.nome.split(' ')[0])}</span>
            <div style="flex:1;height:20px;background:var(--bg-body);border-radius:6px;overflow:hidden;display:flex;">
                <div style="height:100%;width:${manualPct}%;background:${color};opacity:0.8;transition:width 0.3s;" title="Manual: ${manualVal}"></div>
                <div style="height:100%;width:${autoPct}%;background:${color};opacity:0.35;transition:width 0.3s;" title="Auto: ${autoTot}"></div>
            </div>
            <span style="font-size:0.78rem;font-weight:900;min-width:40px;text-align:right;">${s.rankTotal}</span>
        </div>`;
    });
    
    if(top10.some(s => { const rt = (rankingTotals||{})[s.id]||{}; return (rt._autoNotas||0)+(rt._autoParticipacao||0) > 0; })){
        html += `<div style="display:flex;gap:12px;margin-top:8px;font-size:0.7rem;color:var(--text-muted);">
            <span>■ Manual</span> <span style="opacity:0.5;">■ Automático (notas + presenças)</span>
        </div>`;
    }
    
    html += `</div>`;

    body.innerHTML = html;
}

// Toggle week accordion
window.rankHistToggleWeek = function(header){
    header.classList.toggle('open');
    const body = header.nextElementSibling;
    if(body) body.classList.toggle('open');
};

// Switch views
window.rankHistSetView = function(view){
    __rankHistView = view;
    document.querySelectorAll('.rank-hist-tab').forEach(t => {
        t.classList.toggle('active', (view === 'semanal' && t.textContent.includes('Semana')) || (view === 'evolucao' && t.textContent.includes('Evolução')));
    });
    rankHistoricoRenderizar();
};

// Main render
window.rankHistoricoRenderizar = function(){
    _rankHistUpdateDiaFim();
    
    // Save config
    const cfg = {
        diaInicio: document.getElementById('rankHistDiaInicio')?.value || '5',
        dataInicio: document.getElementById('rankHistDataInicio')?.value || '',
        dataFim: document.getElementById('rankHistDataFim')?.value || ''
    };
    _rankHistSaveCfg(cfg);

    if(__rankHistView === 'evolucao'){
        _rankHistRenderEvolucao();
    } else {
        _rankHistRenderSemanal();
    }
};

// Open modal
window.rankHistoricoSemanalAbrir = function(){
    const modal = document.getElementById('modalRankHistorico');
    if(!modal) return;

    if(filtroTurma === 'Todas' || !filtroTurma){
        showToast('Selecione uma turma primeiro.', 'error');
        return;
    }

    // Load saved config
    const cfg = _rankHistLoadCfg();
    const selDia = document.getElementById('rankHistDiaInicio');
    const inpDataIni = document.getElementById('rankHistDataInicio');
    const inpDataFim = document.getElementById('rankHistDataFim');
    
    if(selDia && cfg.diaInicio !== undefined) selDia.value = cfg.diaInicio;
    if(inpDataIni && cfg.dataInicio) inpDataIni.value = cfg.dataInicio;
    if(inpDataFim && cfg.dataFim) inpDataFim.value = cfg.dataFim;

    _rankHistUpdateDiaFim();
    
    // Reset view
    __rankHistView = 'semanal';
    document.querySelectorAll('.rank-hist-tab').forEach(t => {
        t.classList.toggle('active', t.textContent.includes('Semana'));
    });

    modal.style.display = 'flex';
    
    // Sync auto points and render
    try{ _rankSyncAuto(); }catch(_){}
    rankHistoricoRenderizar();
};

// Close modal
window.rankHistoricoSemanalFechar = function(){
    const modal = document.getElementById('modalRankHistorico');
    if(modal) modal.style.display = 'none';
};

// --- Whitelist functions ---
try{
  ['renderizarRanking','rankAddPontosModal','fecharModalRankPontos','rankSetPontos',
   'rankConfirmarPontos','rankExportarPDF','rankResetar','rankQuickAdd',
   'rankHistoricoSemanalAbrir','rankHistoricoSemanalFechar','rankHistoricoRenderizar',
   'rankHistSetView','rankHistToggleWeek'].forEach(n=>{
    if(typeof __wrapSafeGlobal==='function'&&typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){}

})();



// ================================================================
// RANKING — FULLSCREEN + UI
// ================================================================
function rankUpdateFullscreenUI(){
  const btn = document.getElementById('btnRankFullscreen');
  if(!btn) return;
  const fsEl = document.fullscreenElement;
  const isNativeFs = !!(fsEl && (fsEl.id === 'viewRanking' || (fsEl.closest && fsEl.closest('#viewRanking'))));
  const isFallbackFs = document.body.classList.contains('ranking-is-fullscreen');
  const isFs = isNativeFs || (!fsEl && isFallbackFs);
  btn.innerHTML = isFs ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
  btn.title = isFs ? 'Sair da tela cheia' : 'Tela cheia';
  document.body.classList.toggle('ranking-is-fullscreen', isFs);
}

function rankToggleFullscreen(){
  const box = document.getElementById('viewRanking');
  if(!box) return;
  try{
    if(document.fullscreenElement){
      const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
      if(exit) exit.call(document);
      return;
    }
    const req = box.requestFullscreen || box.webkitRequestFullscreen || box.mozRequestFullScreen || box.msRequestFullscreen;
    if(req){
      try{ req.call(box, {navigationUI:'hide'}); }catch(_){ req.call(box); }
    }else{
      document.body.classList.toggle('ranking-is-fullscreen');
      rankUpdateFullscreenUI();
    }
  }catch(e){
    document.body.classList.toggle('ranking-is-fullscreen');
    rankUpdateFullscreenUI();
  }
}

// Mantém o ícone sincronizado quando o usuário sai com ESC
document.addEventListener('fullscreenchange', rankUpdateFullscreenUI);
document.addEventListener('webkitfullscreenchange', rankUpdateFullscreenUI);
document.addEventListener('mozfullscreenchange', rankUpdateFullscreenUI);
document.addEventListener('MSFullscreenChange', rankUpdateFullscreenUI);

// Exporta para o HTML (data-onclick)
window.rankToggleFullscreen = rankToggleFullscreen;
window.rankUpdateFullscreenUI = rankUpdateFullscreenUI;

try{
  ['rankToggleFullscreen','rankUpdateFullscreenUI','rankAbrirHistoricoAluno','rankAlunoHistFechar','rankAlunoHistRender','rankAjusteRapido'].forEach(n=>{
    if(typeof __wrapSafeGlobal==='function' && typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){ }

// ================================================================

// ================================================================
// AUTO TESTE (Dashboard + Backup)
// ================================================================
function __autoTestEscape(s){
    try{
        return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }catch(e){ return String(s); }
}
function abrirModalAutoTeste(){
    const m = document.getElementById('modalAutoTeste');
    const b = document.getElementById('autoTesteBody');
    if(b) b.innerHTML = '<div style="padding:10px;color:var(--text-muted);">Executando autoteste...</div>';
    if(m) m.style.display = 'flex';
}
function fecharModalAutoTeste(){
    const m = document.getElementById('modalAutoTeste');
    if(m) m.style.display = 'none';
}
function autoTesteCopiar(){
    try{
        const txt = window.__autoTesteUltimoRelatorio || '';
        if(!txt){ showToast('Nada para copiar.', 'error'); return; }
        if(navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(txt).then(()=>showToast('Relatório copiado!')).catch(()=>{});
        }else{
            const ta=document.createElement('textarea');
            ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
            showToast('Relatório copiado!');
        }
    }catch(e){ showToast('Não foi possível copiar.', 'error'); }
}
function __autoTestSleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function __autoTestIsVisible(el){
    if(!el) return false;
    const style = window.getComputedStyle(el);
    if(style && (style.display==='none' || style.visibility==='hidden' || style.opacity==='0')) return false;
    if(el.offsetParent === null && style.position !== 'fixed') return false;
    return true;
}
async function executarAutoTeste(){
    if(window.__autoTestRunning){ showToast('AutoTeste já está em execução.'); return; }
    window.__autoTestRunning = true;
    abrirModalAutoTeste();

    const results=[];
    const add=(name, ok, detail='')=>{
        results.push({name, ok: !!ok, detail: detail||''});
    };

    const prevVisao = (typeof visaoAtual !== 'undefined') ? visaoAtual : null;
    const prevBim   = (typeof bimestreAtual !== 'undefined') ? bimestreAtual : null;

    try{
        // 1) LocalStorage
        try{
            const k='__sgp_autotest_ls';
            const v=String(Date.now());
            localStorage.setItem(k, v);
            const got=localStorage.getItem(k);
            localStorage.removeItem(k);
            add('LocalStorage: leitura/escrita', got===v, got===v ? '' : 'Falha ao escrever/ler no localStorage (modo anônimo, bloqueio ou quota).');
        }catch(e){
            add('LocalStorage: leitura/escrita', false, 'Exceção ao acessar localStorage: '+(e && e.message ? e.message : e));
        }

        // 2) Dashboard + bimestre
        if(typeof mudarVisao === 'function'){
            try{ mudarVisao('dash'); }catch(e){}
        }
        await __autoTestSleep(80);

        const dash = document.getElementById('viewDashboard');
        if(!dash){
            add('Dashboard: container', false, 'Elemento #viewDashboard não encontrado.');
        }else{
            add('Dashboard: container', true);
            const canvasIds = Array.from(dash.querySelectorAll('canvas')).map(c=>c.id).filter(Boolean);
            if(canvasIds.length===0){
                add('Dashboard: canvases', false, 'Nenhum canvas encontrado dentro do dashboard.');
            }else{
                add('Dashboard: canvases', true, canvasIds.join(', '));
            }

            const bims=[1,2,3,4].filter(n=>document.getElementById('btnBim'+n));
            for(const n of bims){
                try{
                    if(typeof mudarBimestre==='function') mudarBimestre(n);
                    await __autoTestSleep(140);

                    let missing=[];
                    let hidden=[];
                    canvasIds.forEach(id=>{
                        const el=document.getElementById(id);
                        if(!el || !dash.contains(el)) { missing.push(id); return; }
                        if(!__autoTestIsVisible(el)) { hidden.push(id); }
                    });

                    add('Bimestre '+n+': gráficos presentes', missing.length===0, missing.length?('Sumiram: '+missing.join(', ')):'');
                    add('Bimestre '+n+': gráficos visíveis', hidden.length===0, hidden.length?('Ocultos: '+hidden.join(', ')):'');

                    // Chart instances (Chart.js v2/v3/v4). Não depende de variáveis globais em window.
                    const expectedCharts = [
                        { id:'dashChartBimestres', ref:()=> (typeof __dashChartBim!=='undefined' ? __dashChartBim : null) },
                        { id:'dashPieMat1',        ref:()=> (typeof __dashPie1!=='undefined' ? __dashPie1 : null) },
                        { id:'dashPieMat2',        ref:()=> (typeof __dashPie2!=='undefined' ? __dashPie2 : null) },
                        { id:'dashHistMat1',       ref:()=> (typeof __dashHist1!=='undefined' ? __dashHist1 : null) },
                        { id:'dashHistMat2',       ref:()=> (typeof __dashHist2!=='undefined' ? __dashHist2 : null) }
                    ];

                    const missingCharts = [];
                    const details = [];
                    expectedCharts.forEach(ec=>{
                        let ok = false;
                        try{
                            const inst = ec.ref();
                            ok = !!(inst && (typeof inst.update === 'function' || typeof inst.destroy === 'function' || typeof inst.render === 'function'));
                        }catch(_){ ok = false; }

                        // fallback: tenta capturar a instância pelo canvas
                        if(!ok && typeof Chart !== 'undefined'){
                            try{
                                const cv = document.getElementById(ec.id);
                                if(cv){
                                    if(typeof Chart.getChart === 'function'){
                                        const c = Chart.getChart(cv);
                                        if(c && (typeof c.update === 'function' || typeof c.destroy === 'function' || typeof c.render === 'function')) ok = true;
                                    }else if(Chart.instances){
                                        const insts = Array.isArray(Chart.instances) ? Chart.instances : Object.values(Chart.instances);
                                        const c = (insts||[]).find(ch=>ch && ch.canvas===cv);
                                        if(c && (typeof c.update === 'function' || typeof c.destroy === 'function' || typeof c.render === 'function')) ok = true;
                                    }
                                }
                            }catch(_){}
                        }

                        if(!ok) missingCharts.push(ec.id);
                        details.push(ec.id+':'+(ok?'ok':'x'));
                    });

                    add('Bimestre '+n+': instâncias Chart', missingCharts.length===0, missingCharts.length ? ('Não inicializados: '+missingCharts.join(', ')) : details.join(' | '));
                }catch(e){
                    add('Bimestre '+n+': troca/atualização', false, 'Erro: '+(e && e.message ? e.message : e));
                }
            }
        }

        // 3) Backup ZIP (geração + leitura)
        try{
            const has = (typeof __collectBackupFiles==='function' && typeof __zipStore==='function' && typeof __zipReadStore==='function');
            add('Backup: funções ZIP disponíveis', has, has?'':'Faltam __collectBackupFiles/__zipStore/__zipReadStore.');
            if(has){
                const tuples = __collectBackupFiles();
                const blob = __zipStore(tuples);
                const blobOk = blob && typeof blob.size === 'number' && blob.size > 50;
                add('Backup: ZIP gerado', blobOk, blobOk ? ('Tamanho: '+blob.size+' bytes') : 'Blob ZIP inválido.');

                let filesMap = null;
                if(blobOk){
                    try{
                        const ab = await blob.arrayBuffer();
                        filesMap = __zipReadStore(ab);
                    }catch(_){
                        filesMap = null;
                    }
                }

                // Core válido: valida o que realmente está dentro do ZIP
                let coreOk=false, coreDetail='';
                if(filesMap && typeof filesMap === 'object' && filesMap['sgp_core.json']){
                    try{
                        const core = JSON.parse(filesMap['sgp_core.json']);
                        const okTurmas = Array.isArray(core.turmas);
                        const okAlunos = Array.isArray(core.alunos);
                        const okAulas  = Array.isArray(core.aulas);
                        coreOk = okTurmas && okAlunos && okAulas;
                        coreDetail = 'turmas:'+ (okTurmas?'ok':'x') +' alunos:'+ (okAlunos?'ok':'x') +' aulas:'+ (okAulas?'ok':'x');
                    }catch(e){
                        coreOk=false; coreDetail='sgp_core.json inválido (JSON).';
                    }
                }else{
                    // fallback: verifica se ao menos está na lista de arquivos antes de zipar
                    const hasCoreTuple = tuples && Array.isArray(tuples) && tuples.some(f=>f && f[0]==='sgp_core.json');
                    coreOk=false;
                    coreDetail = hasCoreTuple ? 'sgp_core.json está na lista, mas não foi encontrado no ZIP (leitura).' : 'sgp_core.json ausente no backup.';
                }
                add('Backup: core válido', coreOk, coreDetail);

                const zipReadable = !!(filesMap && typeof filesMap === 'object' && filesMap['sgp_core.json']);
                add('Backup: ZIP legível', zipReadable, zipReadable ? '' : 'Falha ao reabrir ZIP gerado.');
            }
        }catch(e){
            add('Backup: geração/leitura', false, 'Erro: '+(e && e.message ? e.message : e));
        }

    }catch(e){
        add('AutoTeste: execução', false, 'Erro inesperado: '+(e && e.message ? e.message : e));
    }finally{
        try{ if(prevBim && typeof mudarBimestre==='function') mudarBimestre(prevBim); }catch(_){}
        try{ if(prevVisao && typeof mudarVisao==='function') mudarVisao(prevVisao); }catch(_){}
        window.__autoTestRunning = false;
    }

    // render relatório
    try{
        const okCount = results.filter(r=>r.ok).length;
        const failCount = results.length - okCount;
        const lines = [,'executarAutoTeste','abrirModalAutoTeste','fecharModalAutoTeste','autoTesteCopiar'];
        lines.push('AutoTeste SGP');
        lines.push('Data: '+(new Date()).toLocaleString());
        lines.push('Resultado: '+okCount+'/'+results.length+' OK; '+failCount+' falhas');
        lines.push('');
        results.forEach(r=>{
            lines.push((r.ok?'OK':'FALHA')+' - '+r.name+(r.detail?(' | '+r.detail):''));
        });
        window.__autoTesteUltimoRelatorio = lines.join('\n');

        const body = document.getElementById('autoTesteBody');
        if(body){
            const badge = failCount===0
              ? '<span style="display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(16,185,129,.15);color:var(--success);font-weight:800;">OK</span>'
              : '<span style="display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(239,68,68,.15);color:var(--danger);font-weight:800;">FALHAS</span>';

            const items = results.map(r=>{
                const icon = r.ok ? '✅' : '❌';
                const det = r.detail ? `<div style="color:var(--text-muted);font-size:.92rem;margin-top:2px;">${__autoTestEscape(r.detail)}</div>` : '';
                return `<li style="padding:8px 0;border-bottom:1px solid var(--border-color);"><div style="display:flex;gap:10px;align-items:flex-start;"><div style="width:22px;">${icon}</div><div style="flex:1;"><div style="font-weight:800;color:var(--text-main);">${__autoTestEscape(r.name)}</div>${det}</div></div></li>`;
            }).join('');

            body.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;padding:8px 0 12px 0;">
                    <div style="font-weight:900;color:var(--text-main);font-size:1.05rem;">Resultado do AutoTeste</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        ${badge}
                        <div style="color:var(--text-muted);font-weight:800;">${okCount}/${results.length} OK</div>
                    </div>
                </div>
                <ul style="list-style:none;padding:0;margin:0;">${items}</ul>
                <div style="margin-top:10px;color:var(--text-muted);font-size:.9rem;">
                    Dica: se alguma falha aparecer ao trocar o bimestre, normalmente é cache antigo. Atualize com Ctrl+F5 e tente novamente.
                </div>
            `;
        }
    }catch(e){}
}


// WHITELIST ALL NEW FUNCTIONS
// ================================================================
try{
  ['sortearAluno','sortLimparHistorico','mapaChangeGrid','mapaToggleDisable','mapaToggleSwap',
   'mapaAutoDistribuir','mapaImprimir','mapaMesaClick','gerarGrupos','grupoModoChanged',
   'grpCopiarTexto','grpImprimir','abrirHistoricoChamadas'].forEach(n=>{
    if(typeof __wrapSafeGlobal==='function'&&typeof window[n]==='function') __wrapSafeGlobal(n);
  });
}catch(_){}


</script>
</body>
</html>
